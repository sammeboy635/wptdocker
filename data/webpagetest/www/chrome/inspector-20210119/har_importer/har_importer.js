import{ResourceType as e}from"../common/common.js";import{NetworkRequest as t,NetworkLog as s}from"../sdk/sdk.js";class o{constructor(e){if(!e||"object"!=typeof e)throw"First parameter is expected to be an object";this._custom=new Map}static _safeDate(e){const t=new Date(e);if(!Number.isNaN(t.getTime()))return t;throw"Invalid date format"}static _safeNumber(e){const t=Number(e);if(!Number.isNaN(t))return t;throw"Casting to number results in NaN"}static _optionalNumber(e){return void 0!==e?o._safeNumber(e):void 0}static _optionalString(e){return void 0!==e?String(e):void 0}customAsString(e){const t=this._custom.get(e);if(t)return String(t)}customAsNumber(e){const t=this._custom.get(e);if(!t)return;const s=Number(t);return Number.isNaN(s)?void 0:s}customAsArray(e){const t=this._custom.get(e);if(t)return Array.isArray(t)?t:void 0}customInitiator(){return this._custom.get("initiator")}}class r extends o{constructor(e){if(super(e),this.version=String(e.version),this.creator=new i(e.creator),this.browser=e.browser?new i(e.browser):void 0,this.pages=Array.isArray(e.pages)?e.pages.map((e=>new n(e))):[],!Array.isArray(e.entries))throw"log.entries is expected to be an array";this.entries=e.entries.map((e=>new c(e))),this.comment=o._optionalString(e.comment)}}class i extends o{constructor(e){super(e),this.name=String(e.name),this.version=String(e.version),this.comment=o._optionalString(e.comment)}}class n extends o{constructor(e){super(e),this.startedDateTime=o._safeDate(e.startedDateTime),this.id=String(e.id),this.title=String(e.title),this.pageTimings=new a(e.pageTimings),this.comment=o._optionalString(e.comment)}}class a extends o{constructor(e){super(e),this.onContentLoad=o._optionalNumber(e.onContentLoad),this.onLoad=o._optionalNumber(e.onLoad),this.comment=o._optionalString(e.comment)}}class c extends o{constructor(e){super(e),this.pageref=o._optionalString(e.pageref),this.startedDateTime=o._safeDate(e.startedDateTime),this.time=o._safeNumber(e.time),this.request=new m(e.request),this.response=new u(e.response),this.cache={},this.timings=new S(e.timings),this.serverIPAddress=o._optionalString(e.serverIPAddress),this.connection=o._optionalString(e.connection),this.comment=o._optionalString(e.comment),this._custom.set("fromCache",o._optionalString(e._fromCache)),this._custom.set("initiator",this._importInitiator(e._initiator)),this._custom.set("priority",o._optionalString(e._priority)),this._custom.set("resourceType",o._optionalString(e._resourceType)),this._custom.set("webSocketMessages",this._importWebSocketMessages(e._webSocketMessages))}_importInitiator(e){if("object"==typeof e)return new y(e)}_importWebSocketMessages(e){if(!Array.isArray(e))return;const t=[];for(const s of e){if("object"!=typeof s)return;t.push(new b(s))}return t}}class m extends o{constructor(e){super(e),this.method=String(e.method),this.url=String(e.url),this.httpVersion=String(e.httpVersion),this.cookies=Array.isArray(e.cookies)?e.cookies.map((e=>new p(e))):[],this.headers=Array.isArray(e.headers)?e.headers.map((e=>new d(e))):[],this.queryString=Array.isArray(e.queryString)?e.queryString.map((e=>new h(e))):[],this.postData=e.postData?new l(e.postData):void 0,this.headersSize=o._safeNumber(e.headersSize),this.bodySize=o._safeNumber(e.bodySize),this.comment=o._optionalString(e.comment)}}class u extends o{constructor(e){super(e),this.status=o._safeNumber(e.status),this.statusText=String(e.statusText),this.httpVersion=String(e.httpVersion),this.cookies=Array.isArray(e.cookies)?e.cookies.map((e=>new p(e))):[],this.headers=Array.isArray(e.headers)?e.headers.map((e=>new d(e))):[],this.content=new _(e.content),this.redirectURL=String(e.redirectURL),this.headersSize=o._safeNumber(e.headersSize),this.bodySize=o._safeNumber(e.bodySize),this.comment=o._optionalString(e.comment),this._custom.set("transferSize",o._optionalNumber(e._transferSize)),this._custom.set("error",o._optionalString(e._error))}}class p extends o{constructor(e){super(e),this.name=String(e.name),this.value=String(e.value),this.path=o._optionalString(e.path),this.domain=o._optionalString(e.domain),this.expires=e.expires?o._safeDate(e.expires):void 0,this.httpOnly=void 0!==e.httpOnly?Boolean(e.httpOnly):void 0,this.secure=void 0!==e.secure?Boolean(e.secure):void 0,this.comment=o._optionalString(e.comment)}}class d extends o{constructor(e){super(e),this.name=String(e.name),this.value=String(e.value),this.comment=o._optionalString(e.comment)}}class h extends o{constructor(e){super(e),this.name=String(e.name),this.value=String(e.value),this.comment=o._optionalString(e.comment)}}class l extends o{constructor(e){super(e),this.mimeType=String(e.mimeType),this.params=Array.isArray(e.params)?e.params.map((e=>new g(e))):[],this.text=String(e.text),this.comment=o._optionalString(e.comment)}}class g extends o{constructor(e){super(e),this.name=String(e.name),this.value=o._optionalString(e.value),this.fileName=o._optionalString(e.fileName),this.contentType=o._optionalString(e.contentType),this.comment=o._optionalString(e.comment)}}class _ extends o{constructor(e){super(e),this.size=o._safeNumber(e.size),this.compression=o._optionalNumber(e.compression),this.mimeType=String(e.mimeType),this.text=o._optionalString(e.text),this.encoding=o._optionalString(e.encoding),this.comment=o._optionalString(e.comment)}}class S extends o{constructor(e){super(e),this.blocked=o._optionalNumber(e.blocked),this.dns=o._optionalNumber(e.dns),this.connect=o._optionalNumber(e.connect),this.send=o._safeNumber(e.send),this.wait=o._safeNumber(e.wait),this.receive=o._safeNumber(e.receive),this.ssl=o._optionalNumber(e.ssl),this.comment=o._optionalString(e.comment),this._custom.set("blocked_queueing",o._optionalNumber(e._blocked_queueing)),this._custom.set("blocked_proxy",o._optionalNumber(e._blocked_proxy))}}class y extends o{constructor(e){super(e),this.type=o._optionalString(e.type),this.url=o._optionalString(e.url),this.lineNumber=o._optionalNumber(e.lineNumber)}}class b extends o{constructor(e){super(e),this.time=o._optionalNumber(e.time),this.opcode=o._optionalNumber(e.opcode),this.data=o._optionalString(e.data),this.type=o._optionalString(e.type)}}var f=Object.freeze({__proto__:null,HARRoot:class extends o{constructor(e){super(e),this.log=new r(e.log)}},HARLog:r,HARPage:n,HAREntry:c,HARParam:g,HARTimings:S,HARInitiator:y});class N{static requestsFromHARLog(e){const s=new Map;for(const t of e.pages)s.set(t.id,t);e.entries.sort(((e,t)=>e.startedDateTime.valueOf()-t.startedDateTime.valueOf()));const o=new Map,r=[];for(const i of e.entries){const e=i.pageref;let n=e?o.get(e):void 0;const a=n?n.mainRequest.url():i.request.url;let c=null;const m=i.customInitiator();m&&(c={type:m.type,url:m.url,lineNumber:m.lineNumber});const u=new t.NetworkRequest("har-"+r.length,i.request.url,a,"","",c),p=e?s.get(e):void 0;!n&&e&&p&&(n=N._buildPageLoad(p,u),o.set(e,n)),N._fillRequestFromHAREntry(u,i,n),n&&n.bindRequest(u),r.push(u)}return r}static _buildPageLoad(e,t){const o=new s.PageLoad(t);return o.startTime=e.startedDateTime.valueOf(),o.contentLoadTime=1e3*Number(e.pageTimings.onContentLoad),o.loadTime=1e3*Number(e.pageTimings.onLoad),o}static _fillRequestFromHAREntry(e,s,o){s.request.postData?e.setRequestFormData(!0,s.request.postData.text):e.setRequestFormData(!1,null),e.connectionId=s.connection||"",e.requestMethod=s.request.method,e.setRequestHeaders(s.request.headers),s.response.content.mimeType&&"x-unknown"!==s.response.content.mimeType&&(e.mimeType=s.response.content.mimeType),e.responseHeaders=s.response.headers,e.statusCode=s.response.status,e.statusText=s.response.statusText;let r=s.response.httpVersion.toLowerCase();"http/2.0"===r&&(r="h2"),e.protocol=r.replace(/^http\/2\.0?\+quic/,"http/2+quic");const i=s.startedDateTime.getTime()/1e3;e.setIssueTime(i,i);const n=s.response.content.size>0?s.response.content.size:0,a=s.response.headersSize>0?s.response.headersSize:0,c=s.response.bodySize>0?s.response.bodySize:0;e.resourceSize=n||a+c;let m=s.response.customAsNumber("transferSize");void 0===m&&(m=s.response.headersSize+s.response.bodySize),e.setTransferSize(m>=0?m:0);const u=s.customAsString("fromCache");"memory"===u?e.setFromMemoryCache():"disk"===u&&e.setFromDiskCache();const p=s.response.content.text,d={error:null,content:p||null,encoded:"base64"===s.response.content.encoding};e.setContentDataProvider((async()=>d)),N._setupTiming(e,i,s.time,s.timings),e.setRemoteAddress(s.serverIPAddress||"",80),e.setResourceType(N._getResourceType(e,s,o));const h=s.customAsString("priority");h&&Protocol.Network.ResourcePriority.hasOwnProperty(h)&&e.setPriority(h);const l=s.customAsArray("webSocketMessages");if(l)for(const s of l){if(void 0===s.time)continue;if(!Object.values(t.WebSocketFrameType).includes(s.type))continue;if(void 0===s.opcode)continue;if(void 0===s.data)continue;const o=s.type===t.WebSocketFrameType.Send;e.addFrame({time:s.time,text:s.data,opCode:s.opcode,mask:o,type:s.type})}e.finished=!0}static _getResourceType(t,s,o){const r=s.customAsString("resourceType");if(r){const t=e.ResourceType.fromName(r);if(t)return t}if(o&&o.mainRequest===t)return e.resourceTypes.Document;const i=e.ResourceType.fromMimeType(s.response.content.mimeType);if(i!==e.resourceTypes.Other)return i;const n=e.ResourceType.fromURL(s.request.url);return n||e.resourceTypes.Other}static _setupTiming(e,t,s,o){function r(e){return void 0===e||e<0?-1:(i+=e,i)}let i=o.blocked&&o.blocked>=0?o.blocked:0;const n=o.customAsNumber("blocked_proxy")||-1,a=o.customAsNumber("blocked_queueing")||-1,c=o.ssl&&o.ssl>=0?o.ssl:0;o.connect&&o.connect>0&&(o.connect-=c);const m={proxyStart:n>0?i-n:-1,proxyEnd:n>0?i:-1,requestTime:t+(a>0?a:0)/1e3,dnsStart:o.dns&&o.dns>=0?i:-1,dnsEnd:r(o.dns),connectStart:o.connect&&o.connect>=0?i:-1,connectEnd:r(o.connect)+c,sslStart:o.ssl&&o.ssl>=0?i:-1,sslEnd:r(o.ssl),workerStart:-1,workerReady:-1,workerFetchStart:-1,workerRespondWithSettled:-1,sendStart:o.send>=0?i:-1,sendEnd:r(o.send),pushStart:0,pushEnd:0,receiveHeadersEnd:r(o.wait)};r(o.receive),e.timing=m,e.endTime=t+Math.max(s,i)/1e3}}var T=Object.freeze({__proto__:null,Importer:N});export{f as HARFormat,T as HARImporter};
