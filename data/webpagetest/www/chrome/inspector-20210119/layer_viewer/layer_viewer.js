import{i18n as e}from"../i18n/i18n.js";import{NumberUtilities as t,StringUtilities as s}from"../platform/platform.js";import{OverlayModel as i,LayerTreeBase as r}from"../sdk/sdk.js";import{Widget as n,EmptyWidget as o,UIUtils as a,ARIAUtils as l,TreeOutline as h,ContextMenu as c,Toolbar as d,ShortcutRegistry as _,Geometry as p,XLink as u,ThrottledWidget as m}from"../ui/ui.js";import{Settings as g,ObjectWrapper as y,Throttler as f}from"../common/common.js";import{PieChart as w,OverviewGrid as v}from"../perf_ui/perf_ui.js";const C={showInternalLayers:"Show internal layers"},T=e.registerUIStrings("layer_viewer/LayerViewHost.js",C),S=e.getLocalizedString.bind(void 0,T);class b{constructor(e,t){this._type=e,this._layer=t}static isEqual(e,t){return e&&t?e._isEqual(t):e===t}type(){return this._type}layer(){return this._layer}_isEqual(e){return!1}}const P={Layer:Symbol("Layer"),ScrollRect:Symbol("ScrollRect"),Snapshot:Symbol("Snapshot")};class L extends b{constructor(e){console.assert(Boolean(e),"LayerSelection with empty layer"),super(P.Layer,e)}_isEqual(e){return e._type===P.Layer&&e.layer().id()===this.layer().id()}}class x extends b{constructor(e,t){super(P.ScrollRect,e),this.scrollRectIndex=t}_isEqual(e){return e._type===P.ScrollRect&&this.layer().id()===e.layer().id()&&this.scrollRectIndex===e.scrollRectIndex}}class E extends b{constructor(e,t){super(P.Snapshot,e),this._snapshot=t}_isEqual(e){return e._type===P.Snapshot&&this.layer().id()===e.layer().id()&&this._snapshot===e._snapshot}snapshot(){return this._snapshot}}var R=Object.freeze({__proto__:null,UIStrings:C,LayerView:class{hoverObject(e){}selectObject(e){}setLayerTree(e){}},Selection:b,Type:P,LayerSelection:L,ScrollRectSelection:x,SnapshotSelection:E,LayerViewHost:class{constructor(){this._views=[],this._selectedObject=null,this._hoveredObject=null,this._showInternalLayersSetting=g.Settings.instance().createSetting("layersShowInternalLayers",!1),this._snapshotLayers=new Map}registerView(e){this._views.push(e)}setLayerSnapshotMap(e){this._snapshotLayers=e}getLayerSnapshotMap(){return this._snapshotLayers}setLayerTree(e){if(!e)return;this._target=e.target();const t=this._selectedObject&&this._selectedObject.layer();!t||e&&e.layerById(t.id())||this.selectObject(null);const s=this._hoveredObject&&this._hoveredObject.layer();!s||e&&e.layerById(s.id())||this.hoverObject(null);for(const t of this._views)t.setLayerTree(e)}hoverObject(e){if(b.isEqual(this._hoveredObject,e))return;this._hoveredObject=e;const t=e&&e.layer();this._toggleNodeHighlight(t?t.nodeForSelfOrAncestor():null);for(const t of this._views)t.hoverObject(e)}selectObject(e){if(!b.isEqual(this._selectedObject,e)){this._selectedObject=e;for(const t of this._views)t.selectObject(e)}}selection(){return this._selectedObject}showContextMenu(e,t){e.defaultSection().appendCheckboxItem(S(C.showInternalLayers),this._toggleShowInternalLayers.bind(this),this._showInternalLayersSetting.get());const s=t&&t.layer()&&t.layer().nodeForSelfOrAncestor();s&&e.appendApplicableItems(s),e.show()}showInternalLayersSetting(){return this._showInternalLayersSetting}_toggleShowInternalLayers(){this._showInternalLayersSetting.set(!this._showInternalLayersSetting.get())}_toggleNodeHighlight(e){e?e.highlightForTwoSeconds():i.OverlayModel.hideDOMNodeHighlight()}}});const A={selectALayerToSeeItsDetails:"Select a layer to see its details",scrollRectangleDimensions:"{PH1} {PH2} × {PH3} (at {PH4}, {PH5})",unnamed:"<unnamed>",stickyAncenstorLayersS:"{PH1}: {PH2} ({PH3})",stickyBoxRectangleDimensions:"Sticky Box {PH1} × {PH2} (at {PH3}, {PH4})",containingBlocRectangleDimensions:"Containing Block {PH1} × {PH2} (at {PH3}, {PH4})",nearestLayerShiftingStickyBox:"Nearest Layer Shifting Sticky Box",nearestLayerShiftingContaining:"Nearest Layer Shifting Containing Block",updateRectangleDimensions:"{PH1} × {PH2} (at {PH3},{PH4})",size:"Size",compositingReasons:"Compositing Reasons",memoryEstimate:"Memory estimate",paintCount:"Paint count",slowScrollRegions:"Slow scroll regions",stickyPositionConstraint:"Sticky position constraint",paintProfiler:"Paint Profiler",hasADTransform:"Has a 3d transform.",isAnAcceleratedVideo:"Is an accelerated video.",isAnAcceleratedCanvasOrIsA:"Is an accelerated canvas, or is a display list backed canvas that was promoted to a layer based on a performance heuristic.",isAnAcceleratedPlugin:"Is an accelerated plugin.",isAnAcceleratedIframe:"Is an accelerated iFrame.",hasBackfacevisibilityHidden:"Has backface-visibility: hidden.",hasAnActiveAcceleratedTransform:"Has an active accelerated transform animation or transition.",hasAnActiveAcceleratedOpacity:"Has an active accelerated opacity animation or transition.",hasAnActiveAcceleratedFilter:"Has an active accelerated filter animation or transition.",hasAnActiveAcceleratedBackdrop:"Has an active accelerated backdrop filter animation or transition.",isDomOverlayForWebxrImmersivear:"Is DOM overlay for WebXR immersive-ar mode.",isFixedOrStickyPosition:"Is fixed or sticky position.",isAScrollableOverflowElement:"Is a scrollable overflow element.",scrollParentIsNotAnAncestor:"Scroll parent is not an ancestor.",hasClippingAncestor:"Has clipping ancestor.",isOverlayControlsForVideo:"Is overlay controls for video.",hasAWillchangeTransform:"Has a will-change: transform compositing hint.",hasAWillchangeOpacityCompositing:"Has a will-change: opacity compositing hint.",hasAWillchangeCompositingHint:"Has a will-change compositing hint other than transform and opacity.",hasABackdropFilter:"Has a backdrop filter.",isTheDocumentrootscroller:"Is the document.rootScroller.",mightOverlapOtherComposited:"Might overlap other composited content.",overlapsOtherCompositedContent:"Overlaps other composited content.",parentWithCompositedNegative:"Parent with composited negative z-index content.",layerWasSeparatelyComposited:"Layer was separately composited because it could not be squashed.",hasOpacityThatNeedsToBeAppliedBy:"Has opacity that needs to be applied by compositor because of composited descendants.",hasAMaskThatNeedsToBeKnownBy:"Has a mask that needs to be known by compositor because of composited descendants.",hasAReflectionThatNeedsToBeKnown:"Has a reflection that needs to be known by compositor because of composited descendants.",hasAFilterEffectThatNeedsToBe:"Has a filter effect that needs to be known by compositor because of composited descendants.",hasABlendingEffectThatNeedsToBe:"Has a blending effect that needs to be known by compositor because of composited descendants.",hasAClipThatNeedsToBeKnownBy:"Has a clip that needs to be known by compositor because of composited descendants.",hasAPerspectiveTransformThat:"Has a perspective transform that needs to be known by compositor because of 3d descendants.",hasAPreservesdPropertyThatNeeds:"Has a preserves-3d property that needs to be known by compositor because of 3d descendants.",shouldIsolateDescendantsToApplyA:"Should isolate descendants to apply a blend effect.",isAPositionfixedElementWith:"Is a position:fixed element with composited descendants.",isTheRootLayer:"Is the root layer.",secondaryLayerTheHorizontal:"Secondary layer, the horizontal scrollbar layer.",secondaryLayerTheVertical:"Secondary layer, the vertical scrollbar layer.",secondaryLayerTheOverflow:"Secondary layer, the overflow controls host layer.",secondaryLayerTheScrollCorner:"Secondary layer, the scroll corner layer.",secondaryLayerToHouseContents:"Secondary layer, to house contents that can be scrolled.",secondaryLayerUsedToPositionThe:"Secondary layer, used to position the scrolling contents while scrolling.",secondaryLayerHomeForAGroupOf:"Secondary layer, home for a group of squashable content.",secondaryLayerNoopLayerToPlace:"Secondary layer, no-op layer to place the squashing layer correctly in the composited layer tree.",secondaryLayerToContainAnyNormal:"Secondary layer, to contain any normal flow and positive z-index contents on top of a negative z-index layer.",secondaryLayerToContainTheMask:"Secondary layer, to contain the mask contents.",layerPaintedOnTopOfOtherLayersAs:"Layer painted on top of other layers as decoration.",layerForLinkHighlightFrame:"Layer for link highlight, frame overlay, etc.",nonFastScrollable:"Non fast scrollable",touchEventHandler:"Touch event handler",wheelEventHandler:"Wheel event handler",repaintsOnScroll:"Repaints on scroll",mainThreadScrollingReason:"Main thread scrolling reason"},O=e.registerUIStrings("layer_viewer/LayerDetailsView.js",A),I=e.getLocalizedString.bind(void 0,O);class H extends n.Widget{constructor(e){super(!0),this.registerRequiredCSS("layer_viewer/layerDetailsView.css",{enableLegacyPatching:!0}),this._layerViewHost=e,this._layerViewHost.registerView(this),this._emptyWidget=new o.EmptyWidget(I(A.selectALayerToSeeItsDetails)),this._layerSnapshotMap=this._layerViewHost.getLayerSnapshotMap(),this._tableElement,this._tbodyElement,this._sizeCell,this._compositingReasonsCell,this._memoryEstimateCell,this._paintCountCell,this._scrollRectsCell,this._stickyPositionConstraintCell,this._paintProfilerLink,this._buildContent(),this._selection=null}hoverObject(e){}selectObject(e){this._selection=e,this.isShowing()&&this.update()}setLayerTree(e){}wasShown(){super.wasShown(),this.update()}_onScrollRectClicked(e,t){1===t.which&&this._selection&&this._layerViewHost.selectObject(new x(this._selection.layer(),e))}_invokeProfilerLink(){if(!this._selection)return;const e=this._selection.type()===P.Snapshot?this._selection:this._layerSnapshotMap.get(this._selection.layer());e&&this.dispatchEventToListeners(D.PaintProfilerRequested,e)}_createScrollRectElement(e,t){t&&a.createTextChild(this._scrollRectsCell,", ");const s=this._scrollRectsCell.createChild("span","scroll-rect");this._selection&&this._selection.scrollRectIndex===t&&s.classList.add("active"),s.textContent=I(A.scrollRectangleDimensions,{PH1:M.get(e.type),PH2:e.rect.width,PH3:e.rect.height,PH4:e.rect.x,PH5:e.rect.y}),s.addEventListener("click",this._onScrollRectClicked.bind(this,t),!1)}_formatStickyAncestorLayer(e,t){if(!t)return"";const s=t.nodeForSelfOrAncestor(),i=s?s.simpleSelector():I(A.unnamed);return I(A.stickyAncenstorLayersS,{PH1:e,PH2:i,PH3:t.id()})}_createStickyAncestorChild(e,t){if(!t)return;a.createTextChild(this._stickyPositionConstraintCell,", ");this._stickyPositionConstraintCell.createChild("span").textContent=this._formatStickyAncestorLayer(e,t)}_populateStickyPositionConstraintCell(e){if(this._stickyPositionConstraintCell.removeChildren(),!e)return;const t=e.stickyBoxRect();this._stickyPositionConstraintCell.createChild("span").textContent=I(A.stickyBoxRectangleDimensions,{PH1:t.width,PH2:t.height,PH3:t.x,PH4:t.y}),a.createTextChild(this._stickyPositionConstraintCell,", ");const s=e.containingBlockRect();this._stickyPositionConstraintCell.createChild("span").textContent=I(A.containingBlocRectangleDimensions,{PH1:s.width,PH2:s.height,PH3:s.x,PH4:s.y}),this._createStickyAncestorChild(I(A.nearestLayerShiftingStickyBox),e.nearestLayerShiftingStickyBox()),this._createStickyAncestorChild(I(A.nearestLayerShiftingContaining),e.nearestLayerShiftingContainingBlock())}update(){const e=this._selection&&this._selection.layer();if(!e)return this._tableElement.remove(),this._paintProfilerLink.remove(),void this._emptyWidget.show(this.contentElement);this._emptyWidget.detach(),this.contentElement.appendChild(this._tableElement),this.contentElement.appendChild(this._paintProfilerLink),this._sizeCell.textContent=I(A.updateRectangleDimensions,{PH1:e.width(),PH2:e.height(),PH3:e.offsetX(),PH4:e.offsetY()}),this._paintCountCell.parentElement&&this._paintCountCell.parentElement.classList.toggle("hidden",!e.paintCount()),this._paintCountCell.textContent=String(e.paintCount()),this._memoryEstimateCell.textContent=t.bytesToString(e.gpuMemoryUsage()),e.requestCompositingReasonIds().then(this._updateCompositingReasons.bind(this)),this._scrollRectsCell.removeChildren(),e.scrollRects().forEach(this._createScrollRectElement.bind(this)),this._populateStickyPositionConstraintCell(e.stickyPositionConstraint());const s=this._selection&&this._selection.type()===P.Snapshot?this._selection.snapshot():null;this._paintProfilerLink.classList.toggle("hidden",!(this._layerSnapshotMap.has(e)||s))}_buildContent(){this._tableElement=this.contentElement.createChild("table"),this._tbodyElement=this._tableElement.createChild("tbody"),this._sizeCell=this._createRow(I(A.size)),this._compositingReasonsCell=this._createRow(I(A.compositingReasons)),this._memoryEstimateCell=this._createRow(I(A.memoryEstimate)),this._paintCountCell=this._createRow(I(A.paintCount)),this._scrollRectsCell=this._createRow(I(A.slowScrollRegions)),this._stickyPositionConstraintCell=this._createRow(I(A.stickyPositionConstraint)),this._paintProfilerLink=this.contentElement.createChild("span","hidden devtools-link link-margin"),l.markAsLink(this._paintProfilerLink),this._paintProfilerLink.textContent=I(A.paintProfiler),this._paintProfilerLink.tabIndex=0,this._paintProfilerLink.addEventListener("click",(e=>{e.consume(!0),this._invokeProfilerLink()})),this._paintProfilerLink.addEventListener("keydown",(e=>{"Enter"===e.key&&(e.consume(),this._invokeProfilerLink())}))}_createRow(e){const t=this._tbodyElement.createChild("tr");return t.createChild("td").textContent=e,t.createChild("td")}_updateCompositingReasons(e){if(!e||!e.length)return void(this._compositingReasonsCell.textContent="n/a");this._compositingReasonsCell.removeChildren();const t=this._compositingReasonsCell.createChild("ul"),s=H.getCompositingReasons(e);for(const e of s)t.createChild("li").textContent=e}static getCompositingReasons(e){const t=[];for(const s of e){const e=B.get(s);e?t.push(e):console.error(`Compositing reason id '${s}' is not recognized.`)}return t}}const B=new Map([["transform3D",I(A.hasADTransform)],["video",I(A.isAnAcceleratedVideo)],["canvas",I(A.isAnAcceleratedCanvasOrIsA)],["plugin",I(A.isAnAcceleratedPlugin)],["iFrame",I(A.isAnAcceleratedIframe)],["backfaceVisibilityHidden",I(A.hasBackfacevisibilityHidden)],["activeTransformAnimation",I(A.hasAnActiveAcceleratedTransform)],["activeOpacityAnimation",I(A.hasAnActiveAcceleratedOpacity)],["activeFilterAnimation",I(A.hasAnActiveAcceleratedFilter)],["activeBackdropFilterAnimation",I(A.hasAnActiveAcceleratedBackdrop)],["immersiveArOverlay",I(A.isDomOverlayForWebxrImmersivear)],["scrollDependentPosition",I(A.isFixedOrStickyPosition)],["overflowScrolling",I(A.isAScrollableOverflowElement)],["overflowScrollingParent",I(A.scrollParentIsNotAnAncestor)],["outOfFlowClipping",I(A.hasClippingAncestor)],["videoOverlay",I(A.isOverlayControlsForVideo)],["willChangeTransform",I(A.hasAWillchangeTransform)],["willChangeOpacity",I(A.hasAWillchangeOpacityCompositing)],["willChangeOther",I(A.hasAWillchangeCompositingHint)],["backdropFilter",I(A.hasABackdropFilter)],["rootScroller",I(A.isTheDocumentrootscroller)],["assumedOverlap",I(A.mightOverlapOtherComposited)],["overlap",I(A.overlapsOtherCompositedContent)],["negativeZIndexChildren",I(A.parentWithCompositedNegative)],["squashingDisallowed",I(A.layerWasSeparatelyComposited)],["opacityWithCompositedDescendants",I(A.hasOpacityThatNeedsToBeAppliedBy)],["maskWithCompositedDescendants",I(A.hasAMaskThatNeedsToBeKnownBy)],["reflectionWithCompositedDescendants",I(A.hasAReflectionThatNeedsToBeKnown)],["filterWithCompositedDescendants",I(A.hasAFilterEffectThatNeedsToBe)],["blendingWithCompositedDescendants",I(A.hasABlendingEffectThatNeedsToBe)],["clipsCompositingDescendants",I(A.hasAClipThatNeedsToBeKnownBy)],["perspectiveWith3DDescendants",I(A.hasAPerspectiveTransformThat)],["preserve3DWith3DDescendants",I(A.hasAPreservesdPropertyThatNeeds)],["isolateCompositedDescendants",I(A.shouldIsolateDescendantsToApplyA)],["positionFixedWithCompositedDescendants",I(A.isAPositionfixedElementWith)],["root",I(A.isTheRootLayer)],["layerForHorizontalScrollbar",I(A.secondaryLayerTheHorizontal)],["layerForVerticalScrollbar",I(A.secondaryLayerTheVertical)],["layerForOverflowControlsHost",I(A.secondaryLayerTheOverflow)],["layerForScrollCorner",I(A.secondaryLayerTheScrollCorner)],["layerForScrollingContents",I(A.secondaryLayerToHouseContents)],["layerForScrollingContainer",I(A.secondaryLayerUsedToPositionThe)],["layerForSquashingContents",I(A.secondaryLayerHomeForAGroupOf)],["layerForSquashingContainer",I(A.secondaryLayerNoopLayerToPlace)],["layerForForeground",I(A.secondaryLayerToContainAnyNormal)],["layerForMask",I(A.secondaryLayerToContainTheMask)],["layerForDecoration",I(A.layerPaintedOnTopOfOtherLayersAs)],["layerForOther",I(A.layerForLinkHighlightFrame)]]),D={PaintProfilerRequested:Symbol("PaintProfilerRequested")},M=new Map([[r.Layer.ScrollRectType.NonFastScrollable,I(A.nonFastScrollable)],[r.Layer.ScrollRectType.TouchEventHandler,I(A.touchEventHandler)],[r.Layer.ScrollRectType.WheelEventHandler,I(A.wheelEventHandler)],[r.Layer.ScrollRectType.RepaintsOnScroll,I(A.repaintsOnScroll)],[r.Layer.ScrollRectType.MainThreadScrollingReason,I(A.mainThreadScrollingReason)]]);var k=Object.freeze({__proto__:null,UIStrings:A,LayerDetailsView:H,Events:D,slowScrollRectNames:M});const F={layersTreePane:"Layers Tree Pane",showPaintProfiler:"Show Paint Profiler",updateChildDimension:" ({PH1} × {PH2})"},W=e.registerUIStrings("layer_viewer/LayerTreeOutline.js",F),V=e.getLocalizedString.bind(void 0,W);class N extends y.ObjectWrapper{constructor(e){super(),this._layerViewHost=e,this._layerViewHost.registerView(this),this._treeOutline=new h.TreeOutlineInShadow,this._treeOutline.element.classList.add("layer-tree","overflow-auto"),this._treeOutline.element.addEventListener("mousemove",this._onMouseMove.bind(this),!1),this._treeOutline.element.addEventListener("mouseout",this._onMouseMove.bind(this),!1),this._treeOutline.element.addEventListener("contextmenu",this._onContextMenu.bind(this),!0),l.setAccessibleName(this._treeOutline.contentElement,V(F.layersTreePane)),this._lastHoveredNode=null,this.element=this._treeOutline.element,this._layerViewHost.showInternalLayersSetting().addChangeListener(this._update,this)}focus(){this._treeOutline.focus()}selectObject(e){this.hoverObject(null);const t=e&&e.layer(),s=t&&U.get(t);s?s.revealAndSelect(!0):this._treeOutline.selectedTreeElement&&this._treeOutline.selectedTreeElement.deselect()}hoverObject(e){const t=e&&e.layer(),s=t&&U.get(t);s!==this._lastHoveredNode&&(this._lastHoveredNode&&this._lastHoveredNode.setHovered(!1),s&&s.setHovered(!0),this._lastHoveredNode=s)}setLayerTree(e){this._layerTree=e,this._update()}_update(){const e=this._layerViewHost.showInternalLayersSetting().get(),t=new Map;let s=null;this._layerTree&&(e||(s=this._layerTree.contentRoot()),s||(s=this._layerTree.root())),s&&this._layerTree&&this._layerTree.forEachLayer(function(i){if(!i.drawsContent()&&!e)return;t.get(i)&&console.assert(!1,"Duplicate layer: "+i.id()),t.set(i,!0);let r=U.get(i)||null,n=i.parent();for(;n&&n!==s&&!n.drawsContent()&&!e;)n=n.parent();const o=i===s?this._treeOutline.rootElement():n&&U.get(n);if(o)if(r){if(r.parent!==o){const e=this._treeOutline.selectedTreeElement;r.parent&&r.parent.removeChild(r),o.appendChild(r),e&&e!==this._treeOutline.selectedTreeElement&&e.select()}r._update()}else r=new X(this,i),o.appendChild(r),i.drawsContent()||r.expand();else console.assert(!1,"Parent is not in the tree")}.bind(this),s);for(let e=this._treeOutline.rootElement().firstChild();e instanceof X&&!e.root;)if(t.get(e._layer))e=e.traverseNextTreeElement(!1);else{const t=e.nextSibling||e.parent;e.parent&&e.parent.removeChild(e),e===this._lastHoveredNode&&(this._lastHoveredNode=null),e=t}if(!this._treeOutline.selectedTreeElement&&this._layerTree){const e=this._layerTree.contentRoot()||this._layerTree.root();if(e){const t=U.get(e);t&&t.revealAndSelect(!0)}}}_onMouseMove(e){const t=this._treeOutline.treeElementFromEvent(e);t!==this._lastHoveredNode&&this._layerViewHost.hoverObject(this._selectionForNode(t))}_selectedNodeChanged(e){this._layerViewHost.selectObject(this._selectionForNode(e))}_onContextMenu(e){const t=this._selectionForNode(this._treeOutline.treeElementFromEvent(e)),s=new c.ContextMenu(e),i=t&&t.layer();i&&(this._layerSnapshotMap=this._layerViewHost.getLayerSnapshotMap(),this._layerSnapshotMap.has(i)&&s.defaultSection().appendItem(V(F.showPaintProfiler),this.dispatchEventToListeners.bind(this,j.PaintProfilerRequested,t),!1)),this._layerViewHost.showContextMenu(s,t)}_selectionForNode(e){return e&&e._layer?new L(e._layer):null}}const j={PaintProfilerRequested:Symbol("PaintProfilerRequested")};class X extends h.TreeElement{constructor(e,t){super(),this._treeOutline=e,this._layer=t,U.set(t,this),this._update()}_update(){const e=this._layer.nodeForSelfOrAncestor(),t=document.createDocumentFragment();a.createTextChild(t,e?e.simpleSelector():"#"+this._layer.id());t.createChild("span","dimmed").textContent=V(F.updateChildDimension,{PH1:this._layer.width(),PH2:this._layer.height()}),this.title=t}onselect(){return this._treeOutline._selectedNodeChanged(this),!1}setHovered(e){this.listItemElement.classList.toggle("hovered",e)}}const U=new WeakMap;var Y=Object.freeze({__proto__:null,UIStrings:F,LayerTreeOutline:N,Events:j,LayerTreeElement:X,layerToTreeElement:U});const q={panModeX:"Pan mode (X)",rotateModeV:"Rotate mode (V)",resetTransform:"Reset transform (0)"},z=e.registerUIStrings("layer_viewer/TransformController.js",q),G=e.getLocalizedString.bind(void 0,z);class K extends y.ObjectWrapper{constructor(e,t){if(super(),this._mode,this._scale=1,this._offsetX=0,this._offsetY=0,this._rotateX=0,this._rotateY=0,this._oldRotateX=0,this._oldRotateY=0,this._originX=0,this._originY=0,this.element=e,this._registerShortcuts(),a.installDragHandle(e,this._onDragStart.bind(this),this._onDrag.bind(this),this._onDragEnd.bind(this),"move",null),e.addEventListener("wheel",this._onMouseWheel.bind(this),!1),this._minScale=0,this._maxScale=1/0,this._controlPanelToolbar=new d.Toolbar("transform-control-panel"),this._modeButtons={},!t){const e=new d.ToolbarToggle(G(q.panModeX),"largeicon-pan");e.addEventListener(d.ToolbarButton.Events.Click,this._setMode.bind(this,Z.Pan)),this._modeButtons[Z.Pan]=e,this._controlPanelToolbar.appendToolbarItem(e);const t=new d.ToolbarToggle(G(q.rotateModeV),"largeicon-rotate");t.addEventListener(d.ToolbarButton.Events.Click,this._setMode.bind(this,Z.Rotate)),this._modeButtons[Z.Rotate]=t,this._controlPanelToolbar.appendToolbarItem(t)}this._setMode(Z.Pan);const s=new d.ToolbarButton(G(q.resetTransform),"largeicon-center");s.addEventListener(d.ToolbarButton.Events.Click,this.resetAndNotify.bind(this,void 0)),this._controlPanelToolbar.appendToolbarItem(s),this._reset()}toolbar(){return this._controlPanelToolbar}_registerShortcuts(){_.ShortcutRegistry.instance().addShortcutListener(this.element,{"layers.reset-view":async()=>(this.resetAndNotify(),!0),"layers.pan-mode":async()=>(this._setMode(Z.Pan),!0),"layers.rotate-mode":async()=>(this._setMode(Z.Rotate),!0),"layers.zoom-in":this._onKeyboardZoom.bind(this,1.1),"layers.zoom-out":this._onKeyboardZoom.bind(this,1/1.1),"layers.up":this._onKeyboardPanOrRotate.bind(this,0,-1),"layers.down":this._onKeyboardPanOrRotate.bind(this,0,1),"layers.left":this._onKeyboardPanOrRotate.bind(this,-1,0),"layers.right":this._onKeyboardPanOrRotate.bind(this,1,0)})}_postChangeEvent(){this.dispatchEventToListeners(Q.TransformChanged)}_reset(){this._scale=1,this._offsetX=0,this._offsetY=0,this._rotateX=0,this._rotateY=0}_setMode(e){this._mode!==e&&(this._mode=e,this._updateModeButtons())}_updateModeButtons(){for(const e in this._modeButtons)this._modeButtons[e].setToggled(e===this._mode)}resetAndNotify(e){this._reset(),this._postChangeEvent(),e&&e.preventDefault(),this.element.focus()}setScaleConstraints(e,s){this._minScale=e,this._maxScale=s,this._scale=t.clamp(this._scale,e,s)}clampOffsets(e,s,i,r){this._offsetX=t.clamp(this._offsetX,e,s),this._offsetY=t.clamp(this._offsetY,i,r)}scale(){return this._scale}offsetX(){return this._offsetX}offsetY(){return this._offsetY}rotateX(){return this._rotateX}rotateY(){return this._rotateY}_onScale(e,s,i){e=t.clamp(this._scale*e,this._minScale,this._maxScale)/this._scale,this._scale*=e,this._offsetX-=(s-this._offsetX)*(e-1),this._offsetY-=(i-this._offsetY)*(e-1),this._postChangeEvent()}_onPan(e,t){this._offsetX+=e,this._offsetY+=t,this._postChangeEvent()}_onRotate(e,t){this._rotateX=e,this._rotateY=t,this._postChangeEvent()}async _onKeyboardZoom(e){return this._onScale(e,this.element.clientWidth/2,this.element.clientHeight/2),!0}async _onKeyboardPanOrRotate(e,t){return this._mode===Z.Rotate?this._onRotate(this._rotateX+5*t,this._rotateY+5*e):this._onPan(6*e,6*t),!0}_onMouseWheel(e){const t=e,s=Math.pow(1.1,-t.deltaY*(1/53));this._onScale(s,t.clientX-this.element.totalOffsetLeft(),t.clientY-this.element.totalOffsetTop())}_onDrag(e){const{clientX:t,clientY:s}=e;this._mode===Z.Rotate?this._onRotate(this._oldRotateX+(this._originY-s)/this.element.clientHeight*180,this._oldRotateY-(this._originX-t)/this.element.clientWidth*180):(this._onPan(t-this._originX,s-this._originY),this._originX=t,this._originY=s)}_onDragStart(e){return this.element.focus(),this._originX=e.clientX,this._originY=e.clientY,this._oldRotateX=this._rotateX,this._oldRotateY=this._rotateY,!0}_onDragEnd(){this._originX=0,this._originY=0,this._oldRotateX=0,this._oldRotateY=0}}const Q={TransformChanged:Symbol("TransformChanged")},Z={Pan:"Pan",Rotate:"Rotate"};var J=Object.freeze({__proto__:null,UIStrings:q,TransformController:K,Events:Q,Modes:Z});const $={layerInformationIsNotYet:"Layer information is not yet available.",dLayersView:"3D Layers View",cantDisplayLayers:"Can't display layers,",webglSupportIsDisabledInYour:"WebGL support is disabled in your browser.",checkSForPossibleReasons:"Check {PH1} for possible reasons.",slowScrollRects:"Slow scroll rects",paints:"Paints",resetView:"Reset View",showPaintProfiler:"Show Paint Profiler",repaintsOnScroll:"repaints on scroll",touchEventListener:"touch event listener",mousewheelEventListener:"mousewheel event listener"},ee=e.registerUIStrings("layer_viewer/Layers3DView.js",$),te=e.getLocalizedString.bind(void 0,ee),se=new Map,ie=new Map,re=new Map,ne=new Map,oe=new Map,ae=new Map;class le extends n.VBox{constructor(e){super(!0),this.registerRequiredCSS("layer_viewer/layers3DView.css",{enableLegacyPatching:!0}),this.contentElement.classList.add("layers-3d-view"),this._failBanner=new n.VBox,this._failBanner.element.classList.add("full-widget-dimmed-banner"),a.createTextChild(this._failBanner.element,te($.layerInformationIsNotYet)),this._layerViewHost=e,this._layerViewHost.registerView(this),this._transformController=new K(this.contentElement),this._transformController.addEventListener(Q.TransformChanged,this._update,this),this._initToolbar(),this._canvasElement=this.contentElement.createChild("canvas"),this._canvasElement.tabIndex=0,this._canvasElement.addEventListener("dblclick",this._onDoubleClick.bind(this),!1),this._canvasElement.addEventListener("mousedown",this._onMouseDown.bind(this),!1),this._canvasElement.addEventListener("mouseup",this._onMouseUp.bind(this),!1),this._canvasElement.addEventListener("mouseleave",this._onMouseMove.bind(this),!1),this._canvasElement.addEventListener("mousemove",this._onMouseMove.bind(this),!1),this._canvasElement.addEventListener("contextmenu",this._onContextMenu.bind(this),!1),l.setAccessibleName(this._canvasElement,te($.dLayersView)),this._lastSelection={},this._layerTree=null,this._textureManager=new Le(this._update.bind(this)),this._chromeTextures=[],this._rects=[],this._snapshotLayers=new Map,this._layerViewHost.setLayerSnapshotMap(this._snapshotLayers),this._layerViewHost.showInternalLayersSetting().addChangeListener(this._update,this),this._shaderProgram,this._oldTextureScale,this._depthByLayerId,this._visibleLayers,this._maxDepth,this._scale}setLayerTree(e){this._layerTree=e,this._layerTexture=null,delete this._oldTextureScale,this._showPaints()&&this._textureManager.setLayerTree(e),this._update()}showImageForLayer(e,t){if(!t)return this._layerTexture=null,void this._update();a.loadImage(t).then((t=>{const s=t&&Le._createTextureForImage(this._gl||null,t);this._layerTexture=s?{layer:e,texture:s}:null,this._update()}))}onResize(){this._resizeCanvas(),this._update()}willHide(){this._textureManager.suspend()}wasShown(){this._textureManager.resume(),this._needsUpdate&&(this._resizeCanvas(),this._update())}updateLayerSnapshot(e){this._textureManager.layerNeedsUpdate(e)}_setOutline(e,t){this._lastSelection[e]=t,this._update()}hoverObject(e){this._setOutline(he.Hovered,e)}selectObject(e){this._setOutline(he.Hovered,null),this._setOutline(he.Selected,e)}snapshotForSelection(e){if(e.type()===P.Snapshot){const t=e.snapshot();return t.snapshot.addReference(),Promise.resolve(t)}if(e.layer()){const t=e.layer().snapshots()[0];if(t)return t}return Promise.resolve(null)}_initGL(e){const t=e.getContext("webgl");return t?(t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.enable(t.BLEND),t.clearColor(0,0,0,0),t.enable(t.DEPTH_TEST),t):null}_createShader(e,t){if(!this._gl)return;const s=this._gl.createShader(e);s&&this._shaderProgram&&(this._gl.shaderSource(s,t),this._gl.compileShader(s),this._gl.attachShader(this._shaderProgram,s))}_initShaders(){if(!this._gl)return;if(this._shaderProgram=this._gl.createProgram(),!this._shaderProgram)return;this._createShader(this._gl.FRAGMENT_SHADER,pe),this._createShader(this._gl.VERTEX_SHADER,ue),this._gl.linkProgram(this._shaderProgram),this._gl.useProgram(this._shaderProgram);const e=this._gl.getAttribLocation(this._shaderProgram,"aVertexPosition");this._gl.enableVertexAttribArray(e),se.set(this._shaderProgram,e);const t=this._gl.getAttribLocation(this._shaderProgram,"aVertexColor");this._gl.enableVertexAttribArray(t),ie.set(this._shaderProgram,t);const s=this._gl.getAttribLocation(this._shaderProgram,"aTextureCoord");this._gl.enableVertexAttribArray(s),re.set(this._shaderProgram,s);const i=this._gl.getUniformLocation(this._shaderProgram,"uPMatrix");ne.set(this._shaderProgram,i);const r=this._gl.getUniformLocation(this._shaderProgram,"uSampler");oe.set(this._shaderProgram,r)}_resizeCanvas(){this._canvasElement.width=this._canvasElement.offsetWidth*window.devicePixelRatio,this._canvasElement.height=this._canvasElement.offsetHeight*window.devicePixelRatio}_updateTransformAndConstraints(){const e=this._dimensionsForAutoscale||{width:0,height:0},s=this._layerTree?this._layerTree.viewportSize():null,i=s?s.width:e.width,r=s?s.height:e.height,n=this._canvasElement.width,o=this._canvasElement.height,a=.1*n,l=.1*o,h=(n-2*a)/i,c=(o-2*l)/r,d=Math.min(h,c),_=Math.min(i/e.width,r/e.width)/2;this._transformController.setScaleConstraints(_,10/d);const u=this._transformController.scale(),m=this._transformController.rotateX(),g=this._transformController.rotateY();this._scale=u*d;const y=t.clamp(this._scale,.1,1);y!==this._oldTextureScale&&(this._oldTextureScale=y,this._textureManager.setScale(y),this.dispatchEventToListeners(ce.ScaleChanged,y));const f=(new WebKitCSSMatrix).scale(u,u,u).translate(n/2,o/2,0).rotate(m,g,0).scale(d,d,d).translate(-i/2,-r/2,0);let w;for(let e=0;e<this._rects.length;++e)w=p.boundsForTransformedPoints(f,this._rects[e].vertices,w);w&&this._transformController.clampOffsets((a-w.maxX)/window.devicePixelRatio,(n-a-w.minX)/window.devicePixelRatio,(l-w.maxY)/window.devicePixelRatio,(o-l-w.minY)/window.devicePixelRatio);const v=this._transformController.offsetX()*window.devicePixelRatio,C=this._transformController.offsetY()*window.devicePixelRatio;this._projectionMatrix=(new WebKitCSSMatrix).translate(v,C,0).multiply(f);const T=(new WebKitCSSMatrix).scale(1,-1,-1).translate(-1,-1,0).scale(2/this._canvasElement.width,2/this._canvasElement.height,1e-6).multiply(this._projectionMatrix);if(this._shaderProgram){const e=ne.get(this._shaderProgram);this._gl&&e&&this._gl.uniformMatrix4fv(e,!1,this._arrayFromMatrix(T))}}_arrayFromMatrix(e){return new Float32Array([e.m11,e.m12,e.m13,e.m14,e.m21,e.m22,e.m23,e.m24,e.m31,e.m32,e.m33,e.m34,e.m41,e.m42,e.m43,e.m44])}_initWhiteTexture(){if(!this._gl)return;this._whiteTexture=this._gl.createTexture(),this._gl.bindTexture(this._gl.TEXTURE_2D,this._whiteTexture);const e=new Uint8Array([255,255,255,255]);this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,1,1,0,this._gl.RGBA,this._gl.UNSIGNED_BYTE,e)}_initChromeTextures(){function e(e,t){a.loadImage(t).then((t=>{this._chromeTextures[e]=t&&Le._createTextureForImage(this._gl||null,t)||void 0}))}e.call(this,de.Left,"Images/chromeLeft.avif"),e.call(this,de.Middle,"Images/chromeMiddle.avif"),e.call(this,de.Right,"Images/chromeRight.avif")}_initGLIfNecessary(){return this._gl?this._gl:(this._gl=this._initGL(this._canvasElement),this._gl?(this._initShaders(),this._initWhiteTexture(),this._initChromeTextures(),this._textureManager.setContext(this._gl),this._gl):null)}_calculateDepthsAndVisibility(){this._depthByLayerId=new Map;let e=0;const t=this._layerViewHost.showInternalLayersSetting().get();if(!this._layerTree)return;const s=t?this._layerTree.root():this._layerTree.contentRoot()||this._layerTree.root();if(!s)return;const i=[s];for(this._depthByLayerId.set(s.id(),0),this._visibleLayers=new Set;i.length>0;){const s=i.shift();if(!s)break;(t||s.drawsContent())&&this._visibleLayers.add(s);const r=s.children();for(let t=0;t<r.length;++t)this._depthByLayerId.set(r[t].id(),++e),i.push(r[t])}this._maxDepth=e}_depthForLayer(e){return(this._depthByLayerId.get(e.id())||0)*be}_calculateScrollRectDepth(e,t){return this._depthForLayer(e)+t*Pe+1}_updateDimensionsForAutoscale(e){this._dimensionsForAutoscale||(this._dimensionsForAutoscale={width:0,height:0}),this._dimensionsForAutoscale.width=Math.max(e.width(),this._dimensionsForAutoscale.width),this._dimensionsForAutoscale.height=Math.max(e.height(),this._dimensionsForAutoscale.height)}_calculateLayerRect(e){if(!this._visibleLayers.has(e))return;const t=new L(e),s=new xe(t);s.setVertices(e.quad(),this._depthForLayer(e)),this._appendRect(s),this._updateDimensionsForAutoscale(e)}_appendRect(e){const t=e.relatedObject,s=b.isEqual(this._lastSelection[he.Selected],t),i=b.isEqual(this._lastSelection[he.Hovered],t);if(s)e.borderColor=ge;else if(i){e.borderColor=me;const t=e.fillColor||[255,255,255,1],s=ve;e.fillColor=[t[0]*s[0]/255,t[1]*s[1]/255,t[2]*s[2]/255,t[3]*s[3]]}else e.borderColor=ye;e.lineWidth=s?Te:Ce,this._rects.push(e)}_calculateLayerScrollRects(e){const t=e.scrollRects();for(let s=0;s<t.length;++s){const i=new x(e,s),r=new xe(i);r.calculateVerticesFromRect(e,t[s].rect,this._calculateScrollRectDepth(e,s)),r.fillColor=we,this._appendRect(r)}}_calculateLayerTileRects(e){const t=this._textureManager.tilesForLayer(e);for(let s=0;s<t.length;++s){const i=t[s];if(!i.texture)continue;const r=new E(e,{rect:i.rect,snapshot:i.snapshot}),n=new xe(r);this._snapshotLayers.has(e)||this._snapshotLayers.set(e,r),n.calculateVerticesFromRect(e,i.rect,this._depthForLayer(e)+1),n.texture=i.texture,this._appendRect(n)}}_calculateRects(){if(this._rects=[],this._snapshotLayers.clear(),this._dimensionsForAutoscale={width:0,height:0},this._layerTree&&this._layerTree.forEachLayer(this._calculateLayerRect.bind(this)),this._showSlowScrollRectsSetting&&this._showSlowScrollRectsSetting.get()&&this._layerTree&&this._layerTree.forEachLayer(this._calculateLayerScrollRects.bind(this)),this._layerTexture&&this._visibleLayers.has(this._layerTexture.layer)){const e=this._layerTexture.layer,t=new L(e),s=new xe(t);s.setVertices(e.quad(),this._depthForLayer(e)),s.texture=this._layerTexture.texture,this._appendRect(s)}else this._showPaints()&&this._layerTree&&this._layerTree.forEachLayer(this._calculateLayerTileRects.bind(this))}_makeColorsArray(e){let t=[];const s=[e[0]/255,e[1]/255,e[2]/255,e[3]];for(let e=0;e<4;e++)t=t.concat(s);return t}_setVertexAttribute(e,t,s){const i=this._gl;if(!i)return;const r=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,r),i.bufferData(i.ARRAY_BUFFER,new Float32Array(t),i.STATIC_DRAW),i.vertexAttribPointer(e,s,i.FLOAT,!1,0,0)}_drawRectangle(e,t,s,i){const r=this._gl;if(s=s||[255,255,255,1],!this._shaderProgram)return;const n=se.get(this._shaderProgram),o=re.get(this._shaderProgram),a=ie.get(this._shaderProgram);if(void 0!==n&&this._setVertexAttribute(n,e,3),void 0!==o&&this._setVertexAttribute(o,[0,1,1,1,1,0,0,0],2),void 0!==a&&this._setVertexAttribute(a,this._makeColorsArray(s),s.length),!r)return;const l=oe.get(this._shaderProgram);i?l&&(r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,i),r.uniform1i(l,0)):this._whiteTexture&&r.bindTexture(r.TEXTURE_2D,this._whiteTexture);const h=e.length/3;r.drawArrays(t,0,h)}_drawTexture(e,t,s){this._gl&&this._drawRectangle(e,this._gl.TRIANGLE_FAN,s,t)}_drawViewportAndChrome(){if(!this._layerTree)return;const e=this._layerTree.viewportSize();if(!e)return;const t=!g.Settings.instance().moduleSetting("frameViewerHideChromeWindow").get()&&this._chromeTextures.length>=3&&this._chromeTextures.indexOf(void 0)<0,s=(this._maxDepth+1)*be,i=Math.ceil(Se*this._scale);let r=[e.width,0,s,e.width,e.height,s,0,e.height,s,0,0,s];if(!this._gl)return;if(this._gl.lineWidth(i),this._drawRectangle(r,t?this._gl.LINE_STRIP:this._gl.LINE_LOOP,fe),!t)return;const n=this._layerTree.viewportSize();if(!n)return;const o=Se/2,a=n.width+2*o;if(this._chromeTextures[0]&&this._chromeTextures[2]){const e=ae.get(this._chromeTextures[0])||{naturalHeight:0,naturalWidth:0},t=e.naturalHeight,i=ae.get(this._chromeTextures[2])||{naturalHeight:0,naturalWidth:0},n=a-e.naturalWidth-i.naturalWidth;let l=-o;const h=-t;for(let e=0;e<this._chromeTextures.length;++e){const i=this._chromeTextures[e];if(!i)continue;const o=ae.get(i);if(!o)continue;const c=e===de.Middle?n:o.naturalWidth;if(c<0||l+c>a)break;r=[l,h,s,l+c,h,s,l+c,h+t,s,l,h+t,s],this._drawTexture(r,this._chromeTextures[e]),l+=c}}}_drawViewRect(e){if(!this._gl)return;const t=e.vertices;e.texture?this._drawTexture(t,e.texture,e.fillColor||void 0):e.fillColor&&this._drawRectangle(t,this._gl.TRIANGLE_FAN,e.fillColor),this._gl.lineWidth(e.lineWidth),e.borderColor&&this._drawRectangle(t,this._gl.LINE_LOOP,e.borderColor)}_update(){if(!this.isShowing())return void(this._needsUpdate=!0);if(!this._layerTree||!this._layerTree.root())return void this._failBanner.show(this.contentElement);const e=this._initGLIfNecessary();if(!e)return this._failBanner.element.removeChildren(),this._failBanner.element.appendChild(this._webglDisabledBanner()),void this._failBanner.show(this.contentElement);this._failBanner.detach();const t=this._canvasElement.width,s=this._canvasElement.height;this._calculateDepthsAndVisibility(),this._calculateRects(),this._updateTransformAndConstraints(),e.viewport(0,0,t,s),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),this._rects.forEach(this._drawViewRect.bind(this)),this._drawViewportAndChrome()}_webglDisabledBanner(){const t=this.contentElement.ownerDocument.createDocumentFragment();return t.createChild("div").textContent=te($.cantDisplayLayers),t.createChild("div").textContent=te($.webglSupportIsDisabledInYour),t.appendChild(e.getFormatLocalizedString(ee,$.checkSForPossibleReasons,{PH1:u.XLink.create("about:gpu")})),t}_selectionFromEventPoint(e){const t=e;if(!this._layerTree)return null;let s=1/0,i=null;const r=(new WebKitCSSMatrix).scale(1,-1,-1).translate(-1,-1,0).multiply(this._projectionMatrix),n=(t.clientX-this._canvasElement.totalOffsetLeft())*window.devicePixelRatio,o=-(t.clientY-this._canvasElement.totalOffsetTop())*window.devicePixelRatio;return this._rects.forEach((function(e){if(!e.relatedObject)return;const t=e.intersectWithLine(r,n,o);t&&t<s&&(s=t,i=e.relatedObject)})),i}_createVisibilitySetting(e,t,s,i){const r=g.Settings.instance().createSetting(t,s);return r.setTitle(te(e)),r.addChangeListener(this._update,this),i.appendToolbarItem(new d.ToolbarSettingCheckbox(r)),r}_initToolbar(){this._panelToolbar=this._transformController.toolbar(),this.contentElement.appendChild(this._panelToolbar.element),this._showSlowScrollRectsSetting=this._createVisibilitySetting(te($.slowScrollRects),"frameViewerShowSlowScrollRects",!0,this._panelToolbar),this._showPaintsSetting=this._createVisibilitySetting(te($.paints),"frameViewerShowPaints",!0,this._panelToolbar),this._showPaintsSetting.addChangeListener(this._updatePaints,this),g.Settings.instance().moduleSetting("frameViewerHideChromeWindow").addChangeListener(this._update,this)}_onContextMenu(e){const t=new c.ContextMenu(e);t.defaultSection().appendItem(te($.resetView),(()=>this._transformController.resetAndNotify()),!1);const s=this._selectionFromEventPoint(e);s&&s.type()===P.Snapshot&&t.defaultSection().appendItem(te($.showPaintProfiler),this.dispatchEventToListeners.bind(this,ce.PaintProfilerRequested,s),!1),this._layerViewHost.showContextMenu(t,s)}_onMouseMove(e){e.which||this._layerViewHost.hoverObject(this._selectionFromEventPoint(e))}_onMouseDown(e){const t=e;this._mouseDownX=t.clientX,this._mouseDownY=t.clientY}_onMouseUp(e){const t=e;this._mouseDownX&&Math.abs(t.clientX-this._mouseDownX)<6&&Math.abs(t.clientY-(this._mouseDownY||0))<6&&this._layerViewHost.selectObject(this._selectionFromEventPoint(e)),delete this._mouseDownX,delete this._mouseDownY}_onDoubleClick(e){const t=this._selectionFromEventPoint(e);t&&(t.type()===P.Snapshot||t.layer())&&this.dispatchEventToListeners(ce.PaintProfilerRequested,t),e.stopPropagation()}_updatePaints(){this._showPaints()?(this._textureManager.setLayerTree(this._layerTree),this._textureManager.forceUpdate()):this._textureManager.reset(),this._update()}_showPaints(){return!!this._showPaintsSetting&&this._showPaintsSetting.get()}}const he={Hovered:"hovered",Selected:"selected"},ce={PaintProfilerRequested:Symbol("PaintProfilerRequested"),ScaleChanged:Symbol("ScaleChanged")},de={Left:0,Middle:1,Right:2},_e={RepaintsOnScroll:te($.repaintsOnScroll),TouchEventHandler:te($.touchEventListener),WheelEventHandler:te($.mousewheelEventListener)},pe="precision mediump float;\nvarying vec4 vColor;\nvarying vec2 vTextureCoord;\nuniform sampler2D uSampler;\nvoid main(void)\n{\n    gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t)) * vColor;\n}",ue="attribute vec3 aVertexPosition;\nattribute vec2 aTextureCoord;\nattribute vec4 aVertexColor;\nuniform mat4 uPMatrix;\nvarying vec2 vTextureCoord;\nvarying vec4 vColor;\nvoid main(void)\n{\ngl_Position = uPMatrix * vec4(aVertexPosition, 1.0);\nvColor = aVertexColor;\nvTextureCoord = aTextureCoord;\n}",me=[0,0,255,1],ge=[0,255,0,1],ye=[0,0,0,1],fe=[160,160,160,1],we=[178,100,100,.6],ve=[200,200,255,1],Ce=1,Te=2,Se=3,be=20,Pe=4;class Le{constructor(e){this._textureUpdatedCallback=e,this._throttler=new f.Throttler(0),this._scale=0,this._active=!1,this.reset(),this._queue,this._tilesByLayer}static _createTextureForImage(e,t){if(!e)throw new Error("WebGLRenderingContext not provided");const s=e.createTexture();if(!s)throw new Error("Unable to create texture");return ae.set(s,t),e.bindTexture(e.TEXTURE_2D,s),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,1),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),s}reset(){this._tilesByLayer&&this.setLayerTree(null),this._tilesByLayer=new Map,this._queue=[]}setContext(e){this._gl=e,this._scale&&this._updateTextures()}suspend(){this._active=!1}resume(){this._active=!0,this._queue.length&&this._update()}setLayerTree(e){const t=new Set,s=Array.from(this._tilesByLayer.keys());e&&e.forEachLayer((e=>{e.drawsContent()&&(t.add(e),this._tilesByLayer.has(e)||(this._tilesByLayer.set(e,[]),this.layerNeedsUpdate(e)))})),s.length||this.forceUpdate();for(const e of s){if(t.has(e))continue;const s=this._tilesByLayer.get(e);s&&s.forEach((e=>e.dispose())),this._tilesByLayer.delete(e)}}_setSnapshotsForLayer(e,t){const s=new Map((this._tilesByLayer.get(e)||[]).map((e=>[e.snapshot,e]))),i=[],r=[];for(const e of t){const t=s.get(e.snapshot);t?(r.push(t),s.delete(e.snapshot)):i.push(new Ee(e))}this._tilesByLayer.set(e,r.concat(i));for(const e of s.values())e.dispose();const n=this._gl;return n&&this._scale?Promise.all(i.map((e=>e.update(n,this._scale)))).then(this._textureUpdatedCallback):Promise.resolve()}setScale(e){this._scale&&this._scale>=e||(this._scale=e,this._updateTextures())}tilesForLayer(e){return this._tilesByLayer.get(e)||[]}layerNeedsUpdate(e){this._queue.indexOf(e)<0&&this._queue.push(e),this._active&&this._throttler.schedule(this._update.bind(this))}forceUpdate(){this._queue.forEach((e=>this._updateLayer(e))),this._queue=[],this._update()}_update(){const e=this._queue.shift();return e?(this._queue.length&&this._throttler.schedule(this._update.bind(this)),this._updateLayer(e)):Promise.resolve()}_updateLayer(e){return Promise.all(e.snapshots()).then((t=>this._setSnapshotsForLayer(e,t.filter((e=>null!==e)))))}_updateTextures(){if(this._gl&&this._scale)for(const e of this._tilesByLayer.values())for(const t of e){const e=t.updateScale(this._gl,this._scale);e&&e.then(this._textureUpdatedCallback)}}}class xe{constructor(e){this.relatedObject=e,this.lineWidth=1,this.borderColor=null,this.fillColor=null,this.texture=null,this.vertices}setVertices(e,t){this.vertices=[e[0],e[1],t,e[2],e[3],t,e[4],e[5],t,e[6],e[7],t]}_calculatePointOnQuad(e,t,s){const i=e[0],r=e[1],n=e[2],o=e[3],a=e[4],l=e[5],h=e[6],c=e[7],d=i+t*(n-i),_=r+t*(o-r);return[d+s*(h+t*(a-h)-d),_+s*(c+t*(l-c)-_)]}calculateVerticesFromRect(e,t,s){const i=e.quad(),r=t.x/e.width(),n=(t.x+t.width)/e.width(),o=t.y/e.height(),a=(t.y+t.height)/e.height(),l=this._calculatePointOnQuad(i,r,o).concat(this._calculatePointOnQuad(i,n,o)).concat(this._calculatePointOnQuad(i,n,a)).concat(this._calculatePointOnQuad(i,r,a));this.setVertices(l,s)}intersectWithLine(e,t,s){let i;const r=[];for(i=0;i<4;++i)r[i]=p.multiplyVectorByMatrixAndNormalize(new p.Vector(this.vertices[3*i],this.vertices[3*i+1],this.vertices[3*i+2]),e);const n=p.crossProduct(p.subtract(r[1],r[0]),p.subtract(r[2],r[1])),o=n.x,a=n.y,l=n.z,h=-(-(o*r[0].x+a*r[0].y+l*r[0].z)+o*t+a*s)/l,c=new p.Vector(t,s,h),d=r.map(p.subtract.bind(null,c));for(i=0;i<d.length;++i){if(p.scalarProduct(n,p.crossProduct(d[i],d[(i+1)%d.length]))<0)return}return h}}class Ee{constructor(e){this.snapshot=e.snapshot,this.rect=e.rect,this.scale=0,this.texture=null,this._gl}dispose(){this.snapshot.release(),this.texture&&(this._gl.deleteTexture(this.texture),this.texture=null)}updateScale(e,t){return this.texture&&this.scale>=t?null:this.update(e,t)}async update(e,t){this._gl=e,this.scale=t;const s=await this.snapshot.replay(t),i=s?await a.loadImage(s):null;this.texture=i?Le._createTextureForImage(e,i):null}}var Re=Object.freeze({__proto__:null,UIStrings:$,Layers3DView:le,OutlineType:he,Events:ce,ChromeTexture:de,ScrollRectTitles:_e,FragmentShader:pe,VertexShader:ue,HoveredBorderColor:me,SelectedBorderColor:ge,BorderColor:ye,ViewportBorderColor:fe,ScrollRectBackgroundColor:we,HoveredImageMaskColor:ve,BorderWidth:Ce,SelectedBorderWidth:Te,ViewportBorderWidth:Se,LayerSpacing:be,ScrollRectSpacing:Pe,LayerTextureManager:Le,Rectangle:xe,Tile:Ee});const Ae={profiling:"Profiling…",shapes:"Shapes",bitmap:"Bitmap",text:"Text",misc:"Misc",profilingResults:"Profiling results",commandLog:"Command Log"},Oe=e.registerUIStrings("layer_viewer/PaintProfilerView.js",Ae),Ie=e.getLocalizedString.bind(void 0,Oe);let He=null,Be=null;class De extends n.HBox{constructor(e){super(!0),this.registerRequiredCSS("layer_viewer/paintProfiler.css",{enableLegacyPatching:!0}),this.contentElement.classList.add("paint-profiler-overview"),this._canvasContainer=this.contentElement.createChild("div","paint-profiler-canvas-container"),this._progressBanner=this.contentElement.createChild("div","full-widget-dimmed-banner hidden"),this._progressBanner.textContent=Ie(Ae.profiling),this._pieChart=new w.PieChart,this._populatePieChart(0,[]),this._pieChart.classList.add("paint-profiler-pie-chart"),this.contentElement.appendChild(this._pieChart),this._showImageCallback=e,this._canvas=this._canvasContainer.createChild("canvas","fill"),this._context=this._canvas.getContext("2d"),this._selectionWindow=new v.Window(this._canvasContainer),this._selectionWindow.addEventListener(v.Events.WindowChanged,this._onWindowChanged,this),this._innerBarWidth=4*window.devicePixelRatio,this._minBarHeight=window.devicePixelRatio,this._barPaddingWidth=2*window.devicePixelRatio,this._outerBarWidth=this._innerBarWidth+this._barPaddingWidth,this._pendingScale=1,this._scale=this._pendingScale,this._samplesPerBar=0,this._log=[],this._reset()}static categories(){return He||(He={shapes:new Ve("shapes",Ie(Ae.shapes),"rgb(255, 161, 129)"),bitmap:new Ve("bitmap",Ie(Ae.bitmap),"rgb(136, 196, 255)"),text:new Ve("text",Ie(Ae.text),"rgb(180, 255, 137)"),misc:new Ve("misc",Ie(Ae.misc),"rgb(206, 160, 255)")}),He}static _initLogItemCategories(){if(!Be){const e=De.categories(),t={};t.Clear=e.misc,t.DrawPaint=e.misc,t.DrawData=e.misc,t.SetMatrix=e.misc,t.PushCull=e.misc,t.PopCull=e.misc,t.Translate=e.misc,t.Scale=e.misc,t.Concat=e.misc,t.Restore=e.misc,t.SaveLayer=e.misc,t.Save=e.misc,t.BeginCommentGroup=e.misc,t.AddComment=e.misc,t.EndCommentGroup=e.misc,t.ClipRect=e.misc,t.ClipRRect=e.misc,t.ClipPath=e.misc,t.ClipRegion=e.misc,t.DrawPoints=e.shapes,t.DrawRect=e.shapes,t.DrawOval=e.shapes,t.DrawRRect=e.shapes,t.DrawPath=e.shapes,t.DrawVertices=e.shapes,t.DrawDRRect=e.shapes,t.DrawBitmap=e.bitmap,t.DrawBitmapRectToRect=e.bitmap,t.DrawBitmapMatrix=e.bitmap,t.DrawBitmapNine=e.bitmap,t.DrawSprite=e.bitmap,t.DrawPicture=e.bitmap,t.DrawText=e.text,t.DrawPosText=e.text,t.DrawPosTextH=e.text,t.DrawTextOnPath=e.text,Be=t}return Be}static _categoryForLogItem(e){const t=s.toTitleCase(e.method),i=De._initLogItemCategories();let r=i[t];return r||(r=De.categories().misc,i[t]=r),r}onResize(){this._update()}async setSnapshotAndLog(e,t,s){if(this._reset(),this._snapshot=e,this._snapshot&&this._snapshot.addReference(),this._log=t,this._logCategories=this._log.map(De._categoryForLogItem),!e)return this._update(),this._populatePieChart(0,[]),void this._selectionWindow.setEnabled(!1);this._selectionWindow.setEnabled(!0),this._progressBanner.classList.remove("hidden"),this._updateImage();const i=await e.profile(s);this._progressBanner.classList.add("hidden"),this._profiles=i,this._update(),this._updatePieChart()}setScale(e){const t=e>this._scale;this._pendingScale=Math.min(1,2*e),t&&this._snapshot&&this._updateImage()}_update(){if(this._canvas.width=this._canvasContainer.clientWidth*window.devicePixelRatio,this._canvas.height=this._canvasContainer.clientHeight*window.devicePixelRatio,this._samplesPerBar=0,!this._profiles||!this._profiles.length||!this._logCategories)return;const e=Math.floor((this._canvas.width-2*this._barPaddingWidth)/this._outerBarWidth),t=this._log.length;this._samplesPerBar=Math.ceil(t/e);let s=0;const i=[],r=[];let n={};for(let e=0,o=0,a=0;e<t;){let l=this._logCategories[e]&&this._logCategories[e].name||"misc";const h=this._log[e].commandIndex;for(let e=0;e<this._profiles.length;e++){const t=this._profiles[e][h];a+=t,n[l]=(n[l]||0)+t}if(++e,e-o===this._samplesPerBar||e===t){const t=this._profiles.length*(e-o);for(l in a/=t,n)n[l]/=t;i.push(a),r.push(n),a>s&&(s=a),a=0,n={},o=e}}const o=4*window.devicePixelRatio,a=(this._canvas.height-o-this._minBarHeight)/s;for(let e=0;e<i.length;++e){for(const t in r[e])r[e][t]*=(i[e]*a+this._minBarHeight)/i[e];this._renderBar(e,r[e])}}_renderBar(e,t){const s=De.categories();let i=0;const r=this._barPaddingWidth+e*this._outerBarWidth;for(const e in s){if(!t[e])continue;i+=t[e];const n=this._canvas.height-i;this._context.fillStyle=s[e].color,this._context.fillRect(r,n,this._innerBarWidth,t[e])}}_onWindowChanged(){this.dispatchEventToListeners(Me.WindowChanged),this._updatePieChart(),this._updateImageTimer||(this._updateImageTimer=setTimeout(this._updateImage.bind(this),100))}_updatePieChart(){const{total:e,slices:t}=this._calculatePieChart();this._populatePieChart(e,t)}_calculatePieChart(){const e=this.selectionWindow();if(!this._profiles||!this._profiles.length||!e)return{total:0,slices:[]};let t=0;const s={};for(let i=e.left;i<e.right;++i){const e=this._log[i],r=De._categoryForLogItem(e);s[r.color]=s[r.color]||0;for(let i=0;i<this._profiles.length;++i){const n=this._profiles[i][e.commandIndex];t+=n,s[r.color]+=n}}const i=[];for(const e in s)i.push({value:s[e]/this._profiles.length,color:e,title:""});return{total:t/this._profiles.length,slices:i}}_populatePieChart(e,t){this._pieChart.data={chartName:Ie(Ae.profilingResults),size:55,formatter:this._formatPieChartTime.bind(this),showLegend:!1,total:e,slices:t}}_formatPieChartTime(e){return Number.millisToString(1e3*e,!0)}selectionWindow(){if(!this._log)return null;const e=(this._selectionWindow.windowLeft||0)*this._canvas.width,s=(this._selectionWindow.windowRight||0)*this._canvas.width,i=Math.floor(e/this._outerBarWidth),r=Math.floor((s+this._innerBarWidth-this._barPaddingWidth/2)/this._outerBarWidth);return{left:t.clamp(i*this._samplesPerBar,0,this._log.length-1),right:t.clamp(r*this._samplesPerBar,0,this._log.length)}}_updateImage(){let e,t;delete this._updateImageTimer;const s=this.selectionWindow();this._profiles&&this._profiles.length&&s&&(e=this._log[s.left].commandIndex,t=this._log[s.right-1].commandIndex);const i=this._pendingScale;this._snapshot&&this._snapshot.replay(i,e,t).then((e=>{e&&(this._scale=i,this._showImageCallback(e))}))}_reset(){this._snapshot&&this._snapshot.release(),this._snapshot=null,this._profiles=null,this._selectionWindow.reset(),this._selectionWindow.setEnabled(!1)}}const Me={WindowChanged:Symbol("WindowChanged")};class ke extends m.ThrottledWidget{constructor(){super(),this.setMinimumSize(100,25),this.element.classList.add("overflow-auto"),this._treeOutline=new h.TreeOutlineInShadow,l.setAccessibleName(this._treeOutline.contentElement,Ie(Ae.commandLog)),this.element.appendChild(this._treeOutline.element),this.setDefaultFocusedElement(this._treeOutline.contentElement),this._log=[],this._treeItemCache=new Map}setCommandLog(e){this._log=e,this.updateWindow({left:0,right:this._log.length})}_appendLogItem(e){let t=this._treeItemCache.get(e);if(t){if(t.parent)return}else t=new Fe(this,e),this._treeItemCache.set(e,t);this._treeOutline.appendChild(t)}updateWindow(e){this._selectionWindow=e,this.update()}doUpdate(){if(!this._selectionWindow||!this._log.length)return this._treeOutline.removeChildren(),Promise.resolve();const e=this._treeOutline.rootElement();for(;;){const t=e.firstChild();if(!t||t._logItem.commandIndex>=this._selectionWindow.left)break;e.removeChildAtIndex(0)}for(;;){const t=e.lastChild();if(!t||t._logItem.commandIndex<this._selectionWindow.right)break;e.removeChildAtIndex(e.children().length-1)}for(let e=this._selectionWindow.left,t=this._selectionWindow.right;e<t;++e)this._appendLogItem(this._log[e]);return Promise.resolve()}}class Fe extends h.TreeElement{constructor(e,t){super("",Boolean(t.params)),this._logItem=t,this._ownerView=e,this._filled=!1}onattach(){this._update()}async onpopulate(){for(const e in this._logItem.params)We._appendLogPropertyItem(this,e,this._logItem.params[e])}_paramToString(e,t){if("object"!=typeof e)return"string"==typeof e&&e.length>100?t:JSON.stringify(e);let s="",i=0;for(const r in e){if(++i>4||"object"==typeof e[r]||"string"==typeof e[r]&&e[r].length>100)return t;s&&(s+=", "),s+=e[r]}return s}_paramsToString(e){let t="";for(const s in e)t&&(t+=", "),t+=this._paramToString(e[s],s);return t}_update(){const e=document.createDocumentFragment();a.createTextChild(e,this._logItem.method+"("+this._paramsToString(this._logItem.params)+")"),this.title=e}}class We extends h.TreeElement{constructor(e){super(),this._property=e}static _appendLogPropertyItem(e,t,s){const i=new We({name:t,value:s});if(e.appendChild(i),s&&"object"==typeof s)for(const e in s)We._appendLogPropertyItem(i,e,s[e])}onattach(){const e=document.createDocumentFragment();e.createChild("span","name").textContent=this._property.name;if(e.createChild("span","separator").textContent=": ",null===this._property.value||"object"!=typeof this._property.value){const t=e.createChild("span","value");t.textContent=JSON.stringify(this._property.value),t.classList.add("cm-js-"+(null===this._property.value?"null":typeof this._property.value))}this.title=e}}class Ve{constructor(e,t,s){this.name=e,this.title=t,this.color=s}}var Ne=Object.freeze({__proto__:null,UIStrings:Ae,PaintProfilerView:De,Events:Me,PaintProfilerCommandLogView:ke,LogTreeElement:Fe,LogPropertyTreeElement:We,PaintProfilerCategory:Ve});export{k as LayerDetailsView,Y as LayerTreeOutline,R as LayerViewHost,Re as Layers3DView,Ne as PaintProfilerView,J as TransformController};
