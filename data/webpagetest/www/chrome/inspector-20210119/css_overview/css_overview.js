import{ObjectWrapper as e,Color as t,ColorUtils as s,Linkifier as i}from"../common/common.js";import{SDKModel as n,CSSModel as o,DOMModel as a}from"../sdk/sdk.js";import{ls as r,NumberUtilities as l}from"../platform/platform.js";import{ContrastInfo as d}from"../color_picker/color_picker.js";import{Runtime as c}from"../root/root.js";import{Widget as h,UIUtils as u,Fragment as m,Toolbar as v,Panel as p,SplitWidget as _,TabbedPane as g,Icon as b,Tooltip as f}from"../ui/ui.js";import{Linkifier as C}from"../components/components.js";import{SortableDataGrid as w,DataGrid as S}from"../data_grid/data_grid.js";import{TextRange as y}from"../text_utils/text_utils.js";import{userMetrics as $,UserMetrics as I}from"../host/host.js";class k extends e.ObjectWrapper{constructor(){super(),this.currentUrl=n.TargetManager.instance().inspectedURL(),n.TargetManager.instance().addEventListener(n.Events.InspectedURLChanged,this._checkUrlAndResetIfChanged,this)}_checkUrlAndResetIfChanged(){this.currentUrl!==n.TargetManager.instance().inspectedURL()&&(this.currentUrl=n.TargetManager.instance().inspectedURL(),this.dispatchEventToListeners(E.Reset))}}const E={RequestOverviewStart:Symbol("RequestOverviewStart"),RequestNodeHighlight:Symbol("RequestNodeHighlight"),PopulateNodes:Symbol("PopulateNodes"),RequestOverviewCancel:Symbol("RequestOverviewCancel"),OverviewCompleted:Symbol("OverviewCompleted"),Reset:Symbol("Reset")};var x=Object.freeze({__proto__:null,OverviewController:k,Events:E});class T{static _add(e,t,s){const i=e.get(t)||[];i.push(s),e.set(t,i)}static checkForUnusedPositionValues(e,t,s,i,n,o,a,l){if("static"===s[i]){if("auto"!==s[n]){const i=r`Top applied to a statically positioned element`;this._add(e,i,{declaration:"top: "+s[n],nodeId:t})}if("auto"!==s[o]){const i=r`Left applied to a statically positioned element`;this._add(e,i,{declaration:"left: "+s[o],nodeId:t})}if("auto"!==s[a]){const i=r`Right applied to a statically positioned element`;this._add(e,i,{declaration:"right: "+s[a],nodeId:t})}if("auto"!==s[l]){const i=r`Bottom applied to a statically positioned element`;this._add(e,i,{declaration:"bottom: "+s[l],nodeId:t})}}}static checkForUnusedWidthAndHeightValues(e,t,s,i,n,o){if("inline"===s[i]){if("auto"!==s[n]){const i=r`Width applied to an inline element`;this._add(e,i,{declaration:"width: "+s[n],nodeId:t})}if("auto"!==s[o]){const i=r`Height applied to an inline element`;this._add(e,i,{declaration:"height: "+s[o],nodeId:t})}}}static checkForInvalidVerticalAlignment(e,t,s,i,n){if(s[i]&&"inline"!==s[i]&&!s[i].startsWith("table")&&"baseline"!==s[n]){const i=r`Vertical alignment applied to element which is neither inline nor table-cell`;this._add(e,i,{declaration:"vertical-align: "+s[n],nodeId:t})}}}var M=Object.freeze({__proto__:null,UnusedDeclaration:undefined,CSSOverviewUnusedDeclarations:T});class A extends n.SDKModel{constructor(e){super(e),this._runtimeAgent=e.runtimeAgent(),this._cssAgent=e.cssAgent(),this._domAgent=e.domAgent(),this._domSnapshotAgent=e.domsnapshotAgent(),this._overlayAgent=e.overlayAgent()}highlightNode(e){const s={contentColor:t.PageHighlight.Content.toProtocolRGBA(),showInfo:!0,contrastAlgorithm:c.experiments.isEnabled("APCA")?Protocol.Overlay.ContrastAlgorithm.Apca:Protocol.Overlay.ContrastAlgorithm.Aa};this._overlayAgent.invoke_hideHighlight(),this._overlayAgent.invoke_highlightNode({backendNodeId:e,highlightConfig:s})}async getNodeStyleStats(){const e=new Map,s=new Map,i=new Map,n=new Map,o=new Map,a=new Map,r=new Map,l=e=>e.hasAlpha()?e.asString(t.Format.HEXA):e.asString(t.Format.HEX),h=(e,s,i)=>{if(-1===e)return;const n=g[e];if(!n)return;const o=t.Color.parse(n);if(!o||0===o.rgba()[3])return;const a=l(o);if(!a)return;const r=i.get(a)||new Set;return r.add(s),i.set(a,r),o},u=e=>new Set(["altglyph","circle","ellipse","path","polygon","polyline","rect","svg","text","textpath","tref","tspan"]).has(e.toLowerCase()),m=e=>new Set(["iframe","video","embed","img"]).has(e.toLowerCase()),v=(e,t)=>new Set(["tr","td","thead","tbody"]).has(e.toLowerCase())&&t.startsWith("table");let p=0;const{documents:_,strings:g}=await this._domSnapshotAgent.invoke_captureSnapshot({computedStyles:["background-color","color","fill","border-top-width","border-top-color","border-bottom-width","border-bottom-color","border-left-width","border-left-color","border-right-width","border-right-color","font-family","font-size","font-weight","line-height","position","top","right","bottom","left","display","width","height","vertical-align"]});for(const{nodes:b,layout:f}of _){p+=f.nodeIndex.length;for(let p=0;p<f.styles.length;p++){const _=f.styles[p],C=f.nodeIndex[p];if(!b.backendNodeId||!b.nodeName)continue;const w=b.backendNodeId[C],S=b.nodeName[C],[y,$,I,k,E,x,M,A,L,O,F,R,V,N,P,D,W,q,B,z,G,U,H,j]=_,Q=h(y,w,e),X=h($,w,s);if(u(g[S])&&h(I,w,n),"0px"!==g[k]&&h(E,w,o),"0px"!==g[x]&&h(M,w,o),"0px"!==g[A]&&h(L,w,o),"0px"!==g[O]&&h(F,w,o),R&&-1!==R){const e=g[R],t=a.get(e)||new Map,s="font-size",i="font-weight",n="line-height",o=t.get(s)||new Map,r=t.get(i)||new Map,l=t.get(n)||new Map;if(-1!==V){const e=g[V],t=o.get(e)||[];t.push(w),o.set(e,t)}if(-1!==N){const e=g[N],t=r.get(e)||[];t.push(w),r.set(e,t)}if(-1!==P){const e=g[P],t=l.get(e)||[];t.push(w),l.set(e,t)}t.set(s,o),t.set(i,r),t.set(n,l),a.set(e,t)}if(Q&&X&&"#text"===g[S]){const e=new d.ContrastInfo({backgroundColors:[Q.asString(t.Format.HEXA)],computedFontSize:-1!==V?g[V]:"",computedFontWeight:-1!==N?g[N]:""});e.setColor(X);const s=`${l(X)}_${l(Q)}`;if(c.experiments.isEnabled("APCA")){const t=e.contrastRatioAPCA(),n=e.contrastRatioAPCAThreshold();if(!(!(!t||!n)&&Math.abs(t)>=n)){const e={nodeId:w,contrastRatio:t,textColor:X,backgroundColor:Q,thresholdsViolated:{aa:!1,aaa:!1,apca:!0}};i.has(s)?i.get(s).push(e):i.set(s,[e])}}else{const t=e.contrastRatioThreshold("aa")||0,n=e.contrastRatioThreshold("aaa")||0,o=e.contrastRatio()||0;if(t>o||n>o){const e={nodeId:w,contrastRatio:o,textColor:X,backgroundColor:Q,thresholdsViolated:{aa:t>o,aaa:n>o,apca:!1}};i.has(s)?i.get(s).push(e):i.set(s,[e])}}}T.checkForUnusedPositionValues(r,w,g,D,W,z,q,B),u(g[S])||m(g[S])||T.checkForUnusedWidthAndHeightValues(r,w,g,G,U,H),-1===j||v(g[S],g[G])||T.checkForInvalidVerticalAlignment(r,w,g,G,j)}}return{backgroundColors:e,textColors:s,textColorContrastIssues:i,fillColors:n,borderColors:o,fontInfo:a,unusedDeclarations:r,elementCount:p}}getComputedStyleForNode(e){return this._cssAgent.invoke_getComputedStyleForNode({nodeId:e})}async getMediaQueries(){const e=await this._cssAgent.invoke_getMediaQueries(),t=new Map;if(!e)return t;for(const s of e.medias){if("linkedSheet"===s.source)continue;const e=t.get(s.text)||[];e.push(s),t.set(s.text,e)}return t}async getGlobalStylesheetStats(){const{result:e}=await this._runtimeAgent.invoke_evaluate({expression:"(function() {\n      let styleRules = 0;\n      let inlineStyles = 0;\n      let externalSheets = 0;\n      const stats = {\n        // Simple.\n        type: new Set(),\n        class: new Set(),\n        id: new Set(),\n        universal: new Set(),\n        attribute: new Set(),\n\n        // Non-simple.\n        nonSimple: new Set()\n      };\n\n      for (const styleSheet of document.styleSheets) {\n        if (styleSheet.href) {\n          externalSheets++;\n        } else {\n          inlineStyles++;\n        }\n\n        // Attempting to grab rules can trigger a DOMException.\n        // Try it and if it fails skip to the next stylesheet.\n        let rules;\n        try {\n          rules = styleSheet.rules;\n        } catch (err) {\n          continue;\n        }\n\n        for (const rule of rules) {\n          if ('selectorText' in rule) {\n            styleRules++;\n\n            // Each group that was used.\n            for (const selectorGroup of rule.selectorText.split(',')) {\n              // Each selector in the group.\n              for (const selector of selectorGroup.split(/[\\t\\n\\f\\r ]+/g)) {\n                if (selector.startsWith('.')) {\n                  // Class.\n                  stats.class.add(selector);\n                } else if (selector.startsWith('#')) {\n                  // Id.\n                  stats.id.add(selector);\n                } else if (selector.startsWith('*')) {\n                  // Universal.\n                  stats.universal.add(selector);\n                } else if (selector.startsWith('[')) {\n                  // Attribute.\n                  stats.attribute.add(selector);\n                } else {\n                  // Type or non-simple selector.\n                  const specialChars = /[#.:\\[\\]|\\+>~]/;\n                  if (specialChars.test(selector)) {\n                    stats.nonSimple.add(selector);\n                  } else {\n                    stats.type.add(selector);\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n\n      return {\n        styleRules,\n        inlineStyles,\n        externalSheets,\n        stats: {\n          // Simple.\n          type: stats.type.size,\n          class: stats.class.size,\n          id: stats.id.size,\n          universal: stats.universal.size,\n          attribute: stats.attribute.size,\n\n          // Non-simple.\n          nonSimple: stats.nonSimple.size\n        }\n      }\n    })()",returnByValue:!0});if("object"===e.type)return e.value}}n.SDKModel.register(A,n.Capability.DOM,!1);var L=Object.freeze({__proto__:null,CSSOverviewModel:A});class O extends h.Widget{constructor(e){super(),this.registerRequiredCSS("css_overview/cssOverviewStartView.css",{enableLegacyPatching:!1}),this._controller=e,this._render()}_render(){const e=u.createTextButton(r`Capture overview`,(()=>this._controller.dispatchEventToListeners(E.RequestOverviewStart)),"",!0);this.setDefaultFocusedElement(e);const t=m.Fragment.build`
      <div class="vbox overview-start-view">
        <h1>${r`CSS Overview`}</h1>
        <div>${e}</div>
      </div>
    `;this.contentElement.appendChild(t.element()),this.contentElement.style.overflow="auto"}}var F=Object.freeze({__proto__:null,CSSOverviewStartView:O});class R extends h.Widget{constructor(e){super(),this.registerRequiredCSS("css_overview/cssOverviewProcessingView.css",{enableLegacyPatching:!1}),this._formatter=new Intl.NumberFormat("en-US"),this._controller=e,this._render()}_render(){const e=u.createTextButton(r`Cancel`,(()=>this._controller.dispatchEventToListeners(E.RequestOverviewCancel)),"",!0);this.setDefaultFocusedElement(e),this.fragment=m.Fragment.build`
      <div class="vbox overview-processing-view">
        <h1>Processing page</h1>
        <div>${e}</div>
      </div>
    `,this.contentElement.appendChild(this.fragment.element()),this.contentElement.style.overflow="auto"}}var V=Object.freeze({__proto__:null,CSSOverviewProcessingView:R});class N extends h.VBox{static get ITEM_CLASS_NAME(){return"overview-sidebar-panel-item"}static get SELECTED(){return"selected"}constructor(){super(!0),this.registerRequiredCSS("css_overview/cssOverviewSidebarPanel.css",{enableLegacyPatching:!1}),this.contentElement.classList.add("overview-sidebar-panel"),this.contentElement.addEventListener("click",this._onItemClick.bind(this));const e=new v.ToolbarButton(r`Clear overview`,"largeicon-clear");e.addEventListener(v.ToolbarButton.Events.Click,this._reset,this);const t=this.contentElement.createChild("div","overview-toolbar");new v.Toolbar("",t).appendToolbarItem(e)}addItem(e,t){const s=this.contentElement.createChild("div",N.ITEM_CLASS_NAME);s.textContent=e,s.dataset.id=t}_reset(){this.dispatchEventToListeners(P.Reset)}_deselectAllItems(){this.contentElement.querySelectorAll("."+N.ITEM_CLASS_NAME).forEach((e=>{e.classList.remove(N.SELECTED)}))}_onItemClick(e){const t=e.composedPath()[0];if(!t.classList.contains(N.ITEM_CLASS_NAME))return;const{id:s}=t.dataset;s&&(this.select(s),this.dispatchEventToListeners(P.ItemSelected,s))}select(e){const t=this.contentElement.querySelector(`[data-id=${CSS.escape(e)}]`);t&&(t.classList.contains(N.SELECTED)||(this._deselectAllItems(),t.classList.add(N.SELECTED)))}}const P={ItemSelected:Symbol("ItemSelected"),Reset:Symbol("Reset")};var D=Object.freeze({__proto__:null,CSSOverviewSidebarPanel:N,SidebarEvents:P});function W(e){let[t,s,i]=e.hsla();return t=Math.round(360*t),s=Math.round(100*s),i=Math.round(100*i),i=Math.max(0,i-15),`1px solid hsl(${t}deg ${s}% ${i}%)`}class q extends p.PanelWithSidebar{constructor(e,t){super("css_overview_completed_view"),this.registerRequiredCSS("css_overview/cssOverviewCompletedView.css",{enableLegacyPatching:!1}),this._controller=e,this._formatter=new Intl.NumberFormat("en-US"),this._mainContainer=new _.SplitWidget(!0,!0),this._resultsContainer=new h.VBox,this._elementContainer=new B,this._elementContainer.addEventListener(g.Events.TabClosed,(e=>{0===e.data&&this._mainContainer.setSidebarMinimized(!0)})),this._mainContainer.registerRequiredCSS("css_overview/cssOverviewCompletedView.css",{enableLegacyPatching:!0}),this._mainContainer.setMainWidget(this._resultsContainer),this._mainContainer.setSidebarWidget(this._elementContainer),this._mainContainer.setVertical(!1),this._mainContainer.setSecondIsSidebar(!0),this._mainContainer.setSidebarMinimized(!0),this._sideBar=new N,this.splitWidget().setSidebarWidget(this._sideBar),this.splitWidget().setMainWidget(this._mainContainer);const s=t.model(o.CSSModel),i=t.model(a.DOMModel);if(!s||!i)throw new Error("Target must provide CSS and DOM models");this._cssModel=s,this._domModel=i,this._domAgent=t.domAgent(),this._linkifier=new C.Linkifier(20,!0),this._viewMap=new Map,this._sideBar.addItem(r`Overview summary`,"summary"),this._sideBar.addItem(r`Colors`,"colors"),this._sideBar.addItem(r`Font info`,"font-info"),this._sideBar.addItem(r`Unused declarations`,"unused-declarations"),this._sideBar.addItem(r`Media queries`,"media-queries"),this._sideBar.select("summary"),this._sideBar.addEventListener(P.ItemSelected,this._sideBarItemSelected,this),this._sideBar.addEventListener(P.Reset,this._sideBarReset,this),this._controller.addEventListener(E.Reset,this._reset,this),this._controller.addEventListener(E.PopulateNodes,this._createElementsView,this),this._resultsContainer.element.addEventListener("click",this._onClick.bind(this)),this._data=null}wasShown(){super.wasShown()}_sideBarItemSelected(e){const t=e.data,s=this._fragment.$(t);s&&s.scrollIntoView()}_sideBarReset(){this._controller.dispatchEventToListeners(E.Reset)}_reset(){this._resultsContainer.element.removeChildren(),this._mainContainer.setSidebarMinimized(!0),this._elementContainer.closeTabs(),this._viewMap=new Map,q.pushedNodes.clear(),this._sideBar.select("summary")}_onClick(e){if(!e.target)return;const t=e.target.dataset,s=t.type;if(!s||!this._data)return;let i;switch(s){case"contrast":{const e=t.section,n=t.key;if(!n)return;i={type:s,key:n,nodes:this._data.textColorContrastIssues.get(n)||[],section:e};break}case"color":{const e=t.color,n=t.section;if(!e)return;let o;switch(n){case"text":o=this._data.textColors.get(e);break;case"background":o=this._data.backgroundColors.get(e);break;case"fill":o=this._data.fillColors.get(e);break;case"border":o=this._data.borderColors.get(e)}if(!o)return;o=Array.from(o).map((e=>({nodeId:e}))),i={type:s,color:e,nodes:o,section:n};break}case"unused-declarations":{const e=t.declaration;if(!e)return;const n=this._data.unusedDeclarations.get(e);if(!n)return;i={type:s,declaration:e,nodes:n};break}case"media-queries":{const e=t.text;if(!e)return;const n=this._data.mediaQueries.get(e);if(!n)return;i={type:s,text:e,nodes:n};break}case"font-info":{const e=t.value;if(!t.path)return;const[n,o]=t.path.split("/");if(!e)return;const a=this._data.fontInfo.get(n);if(!a)return;const r=a.get(o);if(!r)return;const l=r.get(e);if(!l)return;i={type:s,name:`${e} (${n}, ${o})`,nodes:l.map((e=>({nodeId:e})))};break}default:return}e.consume(),this._controller.dispatchEventToListeners(E.PopulateNodes,i),this._mainContainer.setSidebarMinimized(!1)}_onMouseOver(e){const t=e.composedPath().find((e=>e.dataset&&e.dataset.backendNodeId));if(!t)return;const s=Number(t.dataset.backendNodeId);this._controller.dispatchEventToListeners(E.RequestNodeHighlight,s)}async _render(e){if(!e||!("backgroundColors"in e)||!("textColors"in e))return;this._data=e;const{elementCount:t,backgroundColors:s,textColors:i,textColorContrastIssues:n,fillColors:o,borderColors:a,globalStyleStats:l,mediaQueries:d,unusedDeclarations:c,fontInfo:h}=this._data,u=this._sortColorsByLuminance(s),v=this._sortColorsByLuminance(i),p=this._sortColorsByLuminance(o),_=this._sortColorsByLuminance(a);this._fragment=m.Fragment.build`
    <div class="vbox overview-completed-view">
      <div $="summary" class="results-section horizontally-padded summary">
        <h1>${r`Overview summary`}</h1>

        <ul>
          <li>
            <div class="label">${r`Elements`}</div>
            <div class="value">${this._formatter.format(t)}</div>
          </li>
          <li>
            <div class="label">${r`External stylesheets`}</div>
            <div class="value">${this._formatter.format(l.externalSheets)}</div>
          </li>
          <li>
            <div class="label">${r`Inline style elements`}</div>
            <div class="value">${this._formatter.format(l.inlineStyles)}</div>
          </li>
          <li>
            <div class="label">${r`Style rules`}</div>
            <div class="value">${this._formatter.format(l.styleRules)}</div>
          </li>
          <li>
            <div class="label">${r`Media queries`}</div>
            <div class="value">${this._formatter.format(d.size)}</div>
          </li>
          <li>
            <div class="label">${r`Type selectors`}</div>
            <div class="value">${this._formatter.format(l.stats.type)}</div>
          </li>
          <li>
            <div class="label">${r`ID selectors`}</div>
            <div class="value">${this._formatter.format(l.stats.id)}</div>
          </li>
          <li>
            <div class="label">${r`Class selectors`}</div>
            <div class="value">${this._formatter.format(l.stats.class)}</div>
          </li>
          <li>
            <div class="label">${r`Universal selectors`}</div>
            <div class="value">${this._formatter.format(l.stats.universal)}</div>
          </li>
          <li>
            <div class="label">${r`Attribute selectors`}</div>
            <div class="value">${this._formatter.format(l.stats.attribute)}</div>
          </li>
          <li>
            <div class="label">${r`Non-simple selectors`}</div>
            <div class="value">${this._formatter.format(l.stats.nonSimple)}</div>
          </li>
        </ul>
      </div>

      <div $="colors" class="results-section horizontally-padded colors">
        <h1>${r`Colors`}</h1>
        <h2>${r`Background colors: ${u.length}`}</h2>
        <ul>
          ${u.map(this._colorsToFragment.bind(this,"background"))}
        </ul>

        <h2>${r`Text colors: ${v.length}`}</h2>
        <ul>
          ${v.map(this._colorsToFragment.bind(this,"text"))}
        </ul>

        ${n.size>0?this._contrastIssuesToFragment(n):""}

        <h2>${r`Fill colors: ${p.length}`}</h2>
        <ul>
          ${p.map(this._colorsToFragment.bind(this,"fill"))}
        </ul>

        <h2>${r`Border colors: ${_.length}`}</h2>
        <ul>
          ${_.map(this._colorsToFragment.bind(this,"border"))}
        </ul>
      </div>

      <div $="font-info" class="results-section font-info">
        <h1>${r`Font info`}</h1>
        ${h.size>0?this._fontInfoToFragment(h):m.Fragment.build`<div>${r`There are no fonts.`}</div>`}
      </div>

      <div $="unused-declarations" class="results-section unused-declarations">
        <h1>${r`Unused declarations`}</h1>
        ${c.size>0?this._groupToFragment(c,"unused-declarations","declaration"):m.Fragment.build`<div class="horizontally-padded">${r`There are no unused declarations.`}</div>`}
      </div>

      <div $="media-queries" class="results-section media-queries">
        <h1>${r`Media queries`}</h1>
        ${d.size>0?this._groupToFragment(d,"media-queries","text"):m.Fragment.build`<div class="horizontally-padded">${r`There are no media queries.`}</div>`}
      </div>
    </div>`,this._resultsContainer.element.appendChild(this._fragment.element())}_createElementsView(e){const{type:t,nodes:s}=e.data;let i="",n="";switch(t){case"contrast":{const{section:t,key:s}=e.data;i=`${t}-${s}`,n=r`Contrast issues`;break}case"color":{const{section:t,color:s}=e.data;i=`${t}-${s}`,n=`${s.toUpperCase()} (${t})`;break}case"unused-declarations":{const{declaration:t}=e.data;i=""+t,n=""+t;break}case"media-queries":{const{text:t}=e.data;i=""+t,n=""+t;break}case"font-info":{const{name:t}=e.data;i=""+t,n=""+t;break}}let o=this._viewMap.get(i);o||(o=new z(this._controller,this._domModel,this._cssModel,this._linkifier),o.populateNodes(s),this._viewMap.set(i,o)),this._elementContainer.appendTab(i,n,o,!0)}_fontInfoToFragment(e){const t=Array.from(e.entries());return m.Fragment.build`
      ${t.map((([e,t])=>m.Fragment.build`<section class="font-family"><h2>${e}</h2> ${this._fontMetricsToFragment(e,t)}</section>`))}
    `}_fontMetricsToFragment(e,t){const s=Array.from(t.entries());return m.Fragment.build`
      <div class="font-metric">
      ${s.map((([t,s])=>{const i=`${e}/${t}`;return m.Fragment.build`
          <div>
            <h3>${t}</h3>
            ${this._groupToFragment(s,"font-info","value",i)}
          </div>`}))}
      </div>`}_groupToFragment(e,t,s,i=""){const n=Array.from(e.entries()).sort(((e,t)=>{const s=e[1];return t[1].length-s.length})),o=n.reduce(((e,t)=>e+t[1].length),0);return m.Fragment.build`<ul>
    ${n.map((([e,n])=>{const a=100*n.length/o,l=1===n.length?r`occurrence`:r`occurrences`;return m.Fragment.build`<li>
        <div class="title">${e}</div>
        <button data-type="${t}" data-path="${i}" data-${s}="${e}">
          <div class="details">${r`${n.length} ${l}`}</div>
          <div class="bar-container">
            <div class="bar" style="width: ${a}%"></div>
          </div>
        </button>
      </li>`}))}
    </ul>`}_contrastIssuesToFragment(e){return m.Fragment.build`
      <h2>${r`Contrast issues: ${e.size}`}</h2>
      <ul>
        ${[...e.entries()].map((([e,t])=>this._contrastIssueToFragment(e,t)))}
      </ul>
    `}_contrastIssueToFragment(e,s){console.assert(s.length>0);let i=s[0];for(const e of s)Math.abs(e.contrastRatio)<Math.abs(i.contrastRatio)&&(i=e);const n=i.textColor.asString(t.Format.HEXA),o=i.backgroundColor.asString(t.Format.HEXA),a=c.experiments.isEnabled("APCA"),l=m.Fragment.build`<li>
      <button
        title="${r`Text color ${n} over ${o} background results in low contrast for ${s.length} elements`}"
        data-type="contrast" data-key="${e}" data-section="contrast" class="block" $="color">
        Text
      </button>
      <div class="block-title">
        <div class="contrast-warning hidden" $="aa"><span class="threshold-label">${r`AA`}</span></div>
        <div class="contrast-warning hidden" $="aaa"><span class="threshold-label">${r`AAA`}</span></div>
        <div class="contrast-warning hidden" $="apca"><span class="threshold-label">${r`APCA`}</span></div>
      </div>
    </li>`;if(a){const e=l.$("apca");i.thresholdsViolated.apca?e.appendChild(b.Icon.create("smallicon-no")):e.appendChild(b.Icon.create("smallicon-checkmark-square")),e.classList.remove("hidden")}else{const e=l.$("aa");i.thresholdsViolated.aa?e.appendChild(b.Icon.create("smallicon-no")):e.appendChild(b.Icon.create("smallicon-checkmark-square"));const t=l.$("aaa");i.thresholdsViolated.aaa?t.appendChild(b.Icon.create("smallicon-no")):t.appendChild(b.Icon.create("smallicon-checkmark-square")),e.classList.remove("hidden"),t.classList.remove("hidden")}const d=l.$("color");return d.style.backgroundColor=o,d.style.color=n,d.style.border=W(i.backgroundColor),l}_colorsToFragment(e,s){const i=m.Fragment.build`<li>
      <button data-type="color" data-color="${s}" data-section="${e}" class="block" $="color"></button>
      <div class="block-title">${s}</div>
    </li>`,n=i.$("color");n.style.backgroundColor=s;const o=t.Color.parse(s);if(o)return n.style.border=W(o),i}_sortColorsByLuminance(e){return Array.from(e.keys()).sort(((e,i)=>{const n=t.Color.parse(e),o=t.Color.parse(i);return n&&o?s.luminance(o.rgba())-s.luminance(n.rgba()):0}))}setOverviewData(e){this._render(e)}}q.pushedNodes=new Set;class B extends h.VBox{constructor(){super(),this._tabbedPane=new g.TabbedPane,this._tabbedPane.show(this.element),this._tabbedPane.addEventListener(g.Events.TabClosed,(()=>{this.dispatchEventToListeners(g.Events.TabClosed,this._tabbedPane.tabIds().length)}))}appendTab(e,t,s,i){this._tabbedPane.hasTab(e)||this._tabbedPane.appendTab(e,t,s,void 0,void 0,i),this._tabbedPane.selectTab(e)}closeTabs(){this._tabbedPane.closeTabs(this._tabbedPane.tabIds())}}class z extends h.Widget{constructor(e,t,s,i){super(),this._controller=e,this._domModel=t,this._cssModel=s,this._linkifier=i,this._elementGridColumns=[{id:"nodeId",title:r`Element`,sortable:!0,weight:50,titleDOMFragment:void 0,sort:void 0,align:void 0,width:void 0,fixedWidth:void 0,editable:void 0,nonSelectable:void 0,longText:void 0,disclosure:void 0,allowInSortByEvenWhenHidden:void 0,dataType:void 0,defaultWeight:void 0},{id:"declaration",title:r`Declaration`,sortable:!0,weight:50,titleDOMFragment:void 0,sort:void 0,align:void 0,width:void 0,fixedWidth:void 0,editable:void 0,nonSelectable:void 0,longText:void 0,disclosure:void 0,allowInSortByEvenWhenHidden:void 0,dataType:void 0,defaultWeight:void 0},{id:"sourceURL",title:r`Source`,sortable:!1,weight:100,titleDOMFragment:void 0,sort:void 0,align:void 0,width:void 0,fixedWidth:void 0,editable:void 0,nonSelectable:void 0,longText:void 0,disclosure:void 0,allowInSortByEvenWhenHidden:void 0,dataType:void 0,defaultWeight:void 0},{id:"contrastRatio",title:r`Contrast ratio`,sortable:!0,weight:25,titleDOMFragment:void 0,sort:void 0,align:void 0,width:"150px",fixedWidth:!0,editable:void 0,nonSelectable:void 0,longText:void 0,disclosure:void 0,allowInSortByEvenWhenHidden:void 0,dataType:void 0,defaultWeight:void 0}],this._elementGrid=new w.SortableDataGrid({displayName:r`CSS Overview Elements`,columns:this._elementGridColumns,editCallback:void 0,deleteCallback:void 0,refreshCallback:void 0}),this._elementGrid.element.classList.add("element-grid"),this._elementGrid.element.addEventListener("mouseover",this._onMouseOver.bind(this)),this._elementGrid.setStriped(!0),this._elementGrid.addEventListener(S.Events.SortingChanged,this._sortMediaQueryDataGrid.bind(this)),this.element.appendChild(this._elementGrid.element)}_sortMediaQueryDataGrid(){const e=this._elementGrid.sortColumnId();if(!e)return;const t=w.SortableDataGrid.StringComparator.bind(null,e);this._elementGrid.sortNodes(t,!this._elementGrid.isSortOrderAscending())}_onMouseOver(e){const t=e.composedPath().find((e=>e.dataset&&e.dataset.backendNodeId));if(!t)return;const s=Number(t.dataset.backendNodeId);this._controller.dispatchEventToListeners(E.RequestNodeHighlight,s)}async populateNodes(e){if(this._elementGrid.rootNode().removeChildren(),!e.length)return;const[t]=e,s=new Set;let i;if(t.nodeId&&s.add("nodeId"),t.declaration&&s.add("declaration"),t.sourceURL&&s.add("sourceURL"),t.contrastRatio&&s.add("contrastRatio"),s.has("nodeId")){const t=e.reduce(((e,t)=>q.pushedNodes.has(t.nodeId)?e:(q.pushedNodes.add(t.nodeId),e.add(t.nodeId))),new Set);i=await this._domModel.pushNodesByBackendIdsToFrontend(t)}for(const t of e){if(s.has("nodeId")){if(!i)continue;const e=i.get(t.nodeId);if(!e)continue;t.node=e}const e=new G(this._elementGrid,t,this._linkifier,this._cssModel);e.selectable=!1,this._elementGrid.insertChild(e)}this._elementGrid.setColumnsVisiblity(s),this._elementGrid.renderInline(),this._elementGrid.wasShown()}}class G extends w.SortableDataGridNode{constructor(e,t,s,i){super(e,t.hasChildren),this.data=t,this._linkifier=s,this._cssModel=i}createCell(e){if("nodeId"===e){const t=this.createTD(e);return t.textContent="...",i.Linkifier.linkify(this.data.node).then((e=>{t.textContent="",e.dataset.backendNodeId=this.data.node.backendNodeId(),t.appendChild(e);const s=document.createElement("button");s.classList.add("show-element"),f.Tooltip.install(s,r`Show element`),s.tabIndex=0,s.onclick=()=>this.data.node.scrollIntoView(),t.appendChild(s)})),t}if("sourceURL"===e){const t=this.createTD(e);if(this.data.range){const e=this._linkifyRuleLocation(this._cssModel,this._linkifier,this.data.styleSheetId,y.TextRange.fromObject(this.data.range));e&&""!==e.textContent?t.appendChild(e):t.textContent="(unable to link)"}else t.textContent="(unable to link to inlined styles)";return t}if("contrastRatio"===e){const t=this.createTD(e),s=c.experiments.isEnabled("APCA"),i=l.floor(this.data.contrastRatio,2),n=s?i+"%":i,o=m.Fragment.build`
        <div class="contrast-container-in-grid" $="container">
          <span class="contrast-preview" style="border: ${W(this.data.backgroundColor)}; color: ${this.data.textColor.asString()}; background-color: ${this.data.backgroundColor.asString()};">Aa</span>
          <span>${n}</span>
        </div>
      `,a=o.$("container");return s?(a.append(m.Fragment.build`<span>${r`APCA`}</span>`.element()),this.data.thresholdsViolated.apca?a.appendChild(b.Icon.create("smallicon-no")):a.appendChild(b.Icon.create("smallicon-checkmark-square"))):(a.append(m.Fragment.build`<span>${r`AA`}</span>`.element()),this.data.thresholdsViolated.aa?a.appendChild(b.Icon.create("smallicon-no")):a.appendChild(b.Icon.create("smallicon-checkmark-square")),a.append(m.Fragment.build`<span>${r`AAA`}</span>`.element()),this.data.thresholdsViolated.aaa?a.appendChild(b.Icon.create("smallicon-no")):a.appendChild(b.Icon.create("smallicon-checkmark-square"))),t.appendChild(o.element()),t}return super.createCell(e)}_linkifyRuleLocation(e,t,s,i){const n=e.styleSheetHeaderForId(s);if(!n)return;const a=n.lineNumberInSource(i.startLine),r=n.columnNumberInSource(i.startLine,i.startColumn),l=new o.CSSLocation(n,a,r);return t.linkifyCSSLocation(l)}}var U=Object.freeze({__proto__:null,NodeStyleStats:undefined,ContrastIssue:undefined,OverviewData:undefined,FontInfo:undefined,CSSOverviewCompletedView:q,DetailsView:B,ElementDetailsView:z,ElementNode:G});let H;class j extends p.Panel{constructor(){super("css_overview"),this.registerRequiredCSS("css_overview/cssOverview.css",{enableLegacyPatching:!1}),this.element.classList.add("css-overview-panel");const[e]=n.TargetManager.instance().models(A);this._model=e,this._controller=new k,this._startView=new O(this._controller),this._processingView=new R(this._controller),this._completedView=new q(this._controller,e.target()),this._controller.addEventListener(E.RequestOverviewStart,(e=>{$.actionTaken(I.Action.CaptureCssOverviewClicked),this._startOverview()}),this),this._controller.addEventListener(E.RequestOverviewCancel,this._cancelOverview,this),this._controller.addEventListener(E.OverviewCompleted,this._overviewCompleted,this),this._controller.addEventListener(E.Reset,this._reset,this),this._controller.addEventListener(E.RequestNodeHighlight,this._requestNodeHighlight,this),this._reset()}static instance(){return H||(H=new j),H}_reset(){this._backgroundColors=new Map,this._textColors=new Map,this._fillColors=new Map,this._borderColors=new Map,this._fontInfo=new Map,this._mediaQueries=new Map,this._unusedDeclarations=new Map,this._elementCount=0,this._cancelled=!1,this._globalStyleStats={styleRules:0,inlineStyles:0,externalSheets:0,stats:{type:0,class:0,id:0,universal:0,attribute:0,nonSimple:0}},this._renderInitialView()}_requestNodeHighlight(e){this._model.highlightNode(e.data)}_renderInitialView(){this._processingView.hideWidget(),this._completedView.hideWidget(),this._startView.show(this.contentElement)}_renderOverviewStartedView(){this._startView.hideWidget(),this._completedView.hideWidget(),this._processingView.show(this.contentElement)}_renderOverviewCompletedView(){this._startView.hideWidget(),this._processingView.hideWidget(),this._completedView.show(this.contentElement),this._completedView.setOverviewData({backgroundColors:this._backgroundColors,textColors:this._textColors,textColorContrastIssues:this._textColorContrastIssues,fillColors:this._fillColors,borderColors:this._borderColors,globalStyleStats:this._globalStyleStats,fontInfo:this._fontInfo,elementCount:this._elementCount,mediaQueries:this._mediaQueries,unusedDeclarations:this._unusedDeclarations})}async _startOverview(){this._renderOverviewStartedView();const[e,{elementCount:t,backgroundColors:s,textColors:i,textColorContrastIssues:n,fillColors:o,borderColors:a,fontInfo:r,unusedDeclarations:l},d]=await Promise.all([this._model.getGlobalStylesheetStats(),this._model.getNodeStyleStats(),this._model.getMediaQueries()]);t&&(this._elementCount=t),e&&(this._globalStyleStats=e),d&&(this._mediaQueries=d),s&&(this._backgroundColors=s),i&&(this._textColors=i),n&&(this._textColorContrastIssues=n),o&&(this._fillColors=o),a&&(this._borderColors=a),r&&(this._fontInfo=r),l&&(this._unusedDeclarations=l),this._controller.dispatchEventToListeners(E.OverviewCompleted)}_getStyleValue(e,t){const s=e.filter((e=>e.name===t));if(s.length)return s[0].value}_cancelOverview(){this._cancelled=!0}_overviewCompleted(){this._renderOverviewCompletedView()}}var Q=Object.freeze({__proto__:null,CSSOverviewPanel:j});export{U as CSSOverviewCompletedView,x as CSSOverviewController,L as CSSOverviewModel,Q as CSSOverviewPanel,V as CSSOverviewProcessingView,D as CSSOverviewSidebarPanel,F as CSSOverviewStartView,M as CSSOverviewUnusedDeclarations};
