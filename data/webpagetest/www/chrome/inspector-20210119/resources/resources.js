import{UIString as e,Settings as t,Throttler as i,ParsedURL as s,ResourceType as a,EventTarget as r,Color as n,ObjectWrapper as o,Revealer as d,Console as l}from"../common/common.js";import{DataGrid as c,SortableDataGrid as h}from"../data_grid/data_grid.js";import{ls as _,NumberUtilities as u,StringUtilities as m,DateUtilities as p,ArrayUtilities as g}from"../platform/platform.js";import{View as v,Toolbar as b,EmptyWidget as w,TreeOutline as S,ARIAUtils as f,SplitWidget as y,Widget as C,Tooltip as k,TabbedPane as I,Icon as E,ContextMenu as T,ReportView as L,UIUtils as x,XLink as R,ActionRegistry as D,ShortcutRegistry as M,ThrottledWidget as O,SettingsUI as F,Fragment as B,TextPrompt as V,ViewManager as P,InspectorView as U,Utils as N,Context as A,Panel as W}from"../ui/ui.js";import{SDKModel as q,ResourceTreeModel as j,ServiceWorkerCacheModel as G,NetworkRequest as z,ServiceWorkerManager as K,SecurityOriginManager as $,RuntimeModel as H,CookieModel as Q,NetworkManager as X,FrameManager as J,OverlayModel as Y,NetworkLog as Z,ChildTargetManager as ee,Cookie as te,Resource as ie}from"../sdk/sdk.js";import{userMetrics as se,UserMetrics as ae,InspectorFrontendHost as re}from"../host/host.js";import{Runtime as ne}from"../root/root.js";import{PreviewFactory as oe,ResourceSourceFrame as de,ImageView as le,FontView as ce}from"../source_frame/source_frame.js";import{RequestHeadersView as he,RequestPreviewView as _e,NetworkPanel as ue,NetworkItemView as me,NetworkLogView as pe}from"../network/network.js";import{Linkifier as ge}from"../components/components.js";import{ColorSwatch as ve}from"../inline_editor/inline_editor.js";import{FileUtils as be,NetworkProject as we}from"../bindings/bindings.js";import{i18n as Se}from"../i18n/i18n.js";import{PieChart as fe}from"../perf_ui/perf_ui.js";import{Workspace as ye}from"../workspace/workspace.js";import{ObjectPropertiesSection as Ce}from"../object_ui/object_ui.js";import{ThrottlingManager as ke}from"../mobile_throttling/mobile_throttling.js";import{RelatedIssue as Ie}from"../browser_sdk/browser_sdk.js";import{CookiesTable as Ee}from"../cookie_table/cookie_table.js";import{StaticContentProvider as Te}from"../text_utils/text_utils.js";class Le extends q.SDKModel{constructor(e){super(e),e.registerApplicationCacheDispatcher(new Re(this)),this._agent=e.applicationCacheAgent(),this._agent.invoke_enable();const t=e.model(j.ResourceTreeModel);if(!t)throw new Error("Target must provide an ResourceTreeModel");t.addEventListener(j.Events.FrameNavigated,this._frameNavigatedCallback,this),t.addEventListener(j.Events.FrameDetached,this._frameDetached,this),this._statuses=new Map,this._manifestURLsByFrame=new Map,this._mainFrameNavigated(),this._onLine=!0}_frameNavigatedCallback(e){this._frameNavigated(e)}async _frameNavigated(e){const t=e.data;if(t.isMainFrame())return void this._mainFrameNavigated();const i=t.id,s=await this._agent.invoke_getManifestForFrame({frameId:i});null===s||s||this._frameManifestRemoved(i)}_frameDetached(e){const t=e.data;this._frameManifestRemoved(t.id)}reset(){this._statuses.clear(),this._manifestURLsByFrame.clear(),this.dispatchEventToListeners(xe.FrameManifestsReset)}async _mainFrameNavigated(){const e=await this._agent.invoke_getFramesWithManifests();if(!e.getError())for(const t of e.frameIds)this._frameManifestUpdated(t.frameId,t.manifestURL,t.status)}_frameManifestUpdated(e,t,i){if(i===De)return void this._frameManifestRemoved(e);if(!t)return;const s=this._manifestURLsByFrame.get(e);s&&t!==s&&this._frameManifestRemoved(e);const a=this._statuses.get(e)!==i;this._statuses.set(e,i),this._manifestURLsByFrame.has(e)||(this._manifestURLsByFrame.set(e,t),this.dispatchEventToListeners(xe.FrameManifestAdded,e)),a&&this.dispatchEventToListeners(xe.FrameManifestStatusUpdated,e)}_frameManifestRemoved(e){const t=this._manifestURLsByFrame.delete(e);this._statuses.delete(e),t&&this.dispatchEventToListeners(xe.FrameManifestRemoved,e)}frameManifestURL(e){return this._manifestURLsByFrame.get(e)||""}frameManifestStatus(e){return this._statuses.get(e)||De}get onLine(){return this._onLine}_statusUpdated(e,t,i){this._frameManifestUpdated(e,t,i)}async requestApplicationCache(e){const t=await this._agent.invoke_getApplicationCacheForFrame({frameId:e});return t.getError()?null:t.applicationCache}_networkStateUpdated(e){this._onLine=e,this.dispatchEventToListeners(xe.NetworkStateChanged,e)}}q.SDKModel.register(Le,q.Capability.DOM,!1);const xe={FrameManifestStatusUpdated:Symbol("FrameManifestStatusUpdated"),FrameManifestAdded:Symbol("FrameManifestAdded"),FrameManifestRemoved:Symbol("FrameManifestRemoved"),FrameManifestsReset:Symbol("FrameManifestsReset"),NetworkStateChanged:Symbol("NetworkStateChanged")};class Re{constructor(e){this._applicationCacheModel=e}applicationCacheStatusUpdated({frameId:e,manifestURL:t,status:i}){this._applicationCacheModel._statusUpdated(e,t,i)}networkStateUpdated({isNowOnline:e}){this._applicationCacheModel._networkStateUpdated(e)}}const De=0;var Me=Object.freeze({__proto__:null,ApplicationCacheModel:Le,Events:xe,ApplicationCacheDispatcher:Re,UNCACHED:De,IDLE:1,CHECKING:2,DOWNLOADING:3,UPDATEREADY:4,OBSOLETE:5});class Oe extends v.SimpleView{constructor(t,i){super(e.UIString("AppCache")),this._model=t,this.element.classList.add("storage-view","table"),this._deleteButton=new b.ToolbarButton(e.UIString("Delete"),"largeicon-delete"),this._deleteButton.setVisible(!1),this._deleteButton.addEventListener(b.ToolbarButton.Events.Click,this._deleteButtonClicked,this),this._connectivityIcon=document.createElement("span",{is:"dt-icon-label"}),this._connectivityIcon.style.margin="0 2px 0 5px",this._statusIcon=document.createElement("span",{is:"dt-icon-label"}),this._statusIcon.style.margin="0 2px 0 5px",this._frameId=i,this._emptyWidget=new w.EmptyWidget(e.UIString("No Application Cache information available.")),this._emptyWidget.show(this.element),this._markDirty();const s=this._model.frameManifestStatus(i);this.updateStatus(s),this.updateNetworkState(this._model.onLine),this._deleteButton.element.style.display="none",this._nodeResources=new WeakMap}async toolbarItems(){return[this._deleteButton,new b.ToolbarItem(this._connectivityIcon),new b.ToolbarSeparator,new b.ToolbarItem(this._statusIcon)]}wasShown(){this._maybeUpdate()}willHide(){this._deleteButton.setVisible(!1)}_maybeUpdate(){this.isShowing()&&this._viewDirty&&(this._update(),this._viewDirty=!1)}_markDirty(){this._viewDirty=!0}updateStatus(e){const t=this._status;this._status=e;const i=new Map([[De,{type:"smallicon-red-ball",text:"UNCACHED"}],[1,{type:"smallicon-green-ball",text:"IDLE"}],[2,{type:"smallicon-orange-ball",text:"CHECKING"}],[3,{type:"smallicon-orange-ball",text:"DOWNLOADING"}],[4,{type:"smallicon-green-ball",text:"UPDATEREADY"}],[5,{type:"smallicon-red-ball",text:"OBSOLETE"}]]),s=i.get(e)||i.get(De);s&&(this._statusIcon.type=s.type,this._statusIcon.textContent=s.text),!this.isShowing()||1!==this._status||4!==t&&this._resources||this._markDirty(),this._maybeUpdate()}updateNetworkState(t){t?(this._connectivityIcon.type="smallicon-green-ball",this._connectivityIcon.textContent=e.UIString("Online")):(this._connectivityIcon.type="smallicon-red-ball",this._connectivityIcon.textContent=e.UIString("Offline"))}async _update(){const e=await this._model.requestApplicationCache(this._frameId);if(!e||!e.manifestURL)return delete this._manifest,delete this._creationTime,delete this._updateTime,delete this._size,delete this._resources,this._emptyWidget.show(this.element),this._deleteButton.setVisible(!1),void(this._dataGrid&&this._dataGrid.element.classList.add("hidden"));this._manifest=e.manifestURL,this._creationTime=e.creationTime,this._updateTime=e.updateTime,this._size=e.size,this._resources=e.resources,this._dataGrid||this._createDataGrid(),this._populateDataGrid(),this._dataGrid&&(this._dataGrid.autoSizeColumns(20,80),this._dataGrid.element.classList.remove("hidden")),this._emptyWidget.detach(),this._deleteButton.setVisible(!0)}_createDataGrid(){const t=[{id:"resource",title:e.UIString("Resource"),sort:c.Order.Ascending,sortable:!0},{id:"type",title:e.UIString("Type"),sortable:!0},{id:"size",title:e.UIString("Size"),align:c.Align.Right,sortable:!0}],i={displayName:_`Application Cache`,columns:t,editCallback:void 0,deleteCallback:void 0,refreshCallback:void 0};this._dataGrid=new c.DataGridImpl(i),this._dataGrid.setStriped(!0),this._dataGrid.asWidget().show(this.element),this._dataGrid.addEventListener(c.Events.SortingChanged,this._populateDataGrid,this)}_populateDataGrid(){if(!this._dataGrid)return;const e=(this._dataGrid.selectedNode?this._nodeResources.get(this._dataGrid.selectedNode):null)||null,t=this._dataGrid.isSortOrderAscending()?1:-1;function i(e,i,s){return t*String(i[e]).localeCompare(String(s[e]))}let s,a;switch(this._dataGrid.sortColumnId()){case"resource":s=i.bind(null,"url");break;case"type":s=i.bind(null,"type");break;case"size":s=function(e,i,s){return t*(i[e]-s[e])}.bind(null,"size");break;default:i.bind(null,"resource")}if(this._dataGrid.rootNode().removeChildren(),this._resources){this._resources.sort(s);for(let t=0;t<this._resources.length;++t){const i={},s=this._resources[t];i.resource=s.url,i.type=s.type,i.size=u.bytesToString(s.size);const r=new c.DataGridNode(i);this._nodeResources.set(r,s),r.selectable=!0,this._dataGrid.rootNode().appendChild(r),s===e&&(a=r,a.selected=!0)}!a&&this._dataGrid.rootNode().children.length&&(this._dataGrid.rootNode().children[0].selected=!0)}}_deleteButtonClicked(e){this._dataGrid&&this._dataGrid.selectedNode&&this._deleteCallback(this._dataGrid.selectedNode)}_deleteCallback(e){}}var Fe=Object.freeze({__proto__:null,ApplicationCacheItemsView:Oe});class Be extends S.TreeElement{constructor(e,t,i){super(t,i),this.resourcesPanel=e,f.setAccessibleName(this.listItemElement,t)}get itemURL(){throw new Error("Unimplemented Method")}onselect(e){if(!e)return!1;const t=[];for(let e=this;e;e=e.parent){const i=e instanceof Be&&e.itemURL;if(!i)break;t.push(i)}return this.resourcesPanel.setLastSelectedItemPath(t),!1}showView(e){this.resourcesPanel.showView(e)}}class Ve extends Be{constructor(e,i,s,a=!1){super(e,i,!1),this.expandedSetting=t.Settings.instance().createSetting("resources"+s+"Expanded",a),this.categoryName=i,this.categoryLink=null}get itemURL(){return"category://"+this.categoryName}setLink(e){this.categoryLink=e}onselect(e){return super.onselect(e),this.resourcesPanel.showCategoryView(this.categoryName,this.categoryLink),!1}onattach(){super.onattach(),this.expandedSetting.get()&&this.expand()}onexpand(){this.expandedSetting.set(!0)}oncollapse(){this.expandedSetting.set(!1)}}class Pe extends v.SimpleView{constructor(t,s){super(e.UIString("Cache")),this.registerRequiredCSS("resources/serviceWorkerCacheViews.css",{enableLegacyPatching:!0}),this._model=t,this._entriesForTest=null,this.element.classList.add("service-worker-cache-data-view"),this.element.classList.add("storage-view");const a=new b.Toolbar("data-view-toolbar",this.element);this._splitWidget=new y.SplitWidget(!1,!1),this._splitWidget.show(this.element),this._previewPanel=new C.VBox;const r=this._previewPanel.element.createChild("div","cache-preview-panel-resizer");this._splitWidget.setMainWidget(this._previewPanel),this._splitWidget.installResizer(r),this._preview=null,this._cache=s,this._dataGrid=null,this._refreshThrottler=new i.Throttler(300),this._refreshButton=new b.ToolbarButton(e.UIString("Refresh"),"largeicon-refresh"),this._refreshButton.addEventListener(b.ToolbarButton.Events.Click,this._refreshButtonClicked,this),a.appendToolbarItem(this._refreshButton),this._deleteSelectedButton=new b.ToolbarButton(e.UIString("Delete Selected"),"largeicon-delete"),this._deleteSelectedButton.addEventListener(b.ToolbarButton.Events.Click,(e=>{this._deleteButtonClicked(null)})),a.appendToolbarItem(this._deleteSelectedButton);const n=new b.ToolbarInput(_`Filter by Path`,"",1);a.appendToolbarItem(n);const o=new i.Throttler(300);this._entryPathFilter="",n.addEventListener(b.ToolbarInput.Event.TextChanged,(()=>{o.schedule((()=>(this._entryPathFilter=n.value(),this._updateData(!0))))})),this._returnCount=null,this._summaryBarElement=null,this._loadingPromise=null,this.update(s)}_resetDataGrid(){this._dataGrid&&this._dataGrid.asWidget().detach(),this._dataGrid=this._createDataGrid();const e=this._dataGrid.asWidget();this._splitWidget.setSidebarWidget(e),e.setMinimumSize(0,250)}wasShown(){this._model.addEventListener(G.Events.CacheStorageContentUpdated,this._cacheContentUpdated,this),this._updateData(!0)}willHide(){this._model.removeEventListener(G.Events.CacheStorageContentUpdated,this._cacheContentUpdated,this)}_showPreview(t){t&&this._preview===t||(this._preview&&this._preview.detach(),t||(t=new w.EmptyWidget(e.UIString("Select a cache entry above to preview"))),this._preview=t,this._preview.show(this._previewPanel.element))}_createDataGrid(){const t=[{id:"number",title:"#",sortable:!1,width:"3px"},{id:"name",title:e.UIString("Name"),weight:4,sortable:!0},{id:"responseType",title:_`Response-Type`,weight:1,align:c.Align.Right,sortable:!0},{id:"contentType",title:e.UIString("Content-Type"),weight:1,sortable:!0},{id:"contentLength",title:e.UIString("Content-Length"),weight:1,align:c.Align.Right,sortable:!0},{id:"responseTime",title:e.UIString("Time Cached"),width:"12em",weight:1,align:c.Align.Right,sortable:!0}],i=new c.DataGridImpl({displayName:_`Service Worker Cache`,columns:t,deleteCallback:this._deleteButtonClicked.bind(this),refreshCallback:this._updateData.bind(this,!0),editCallback:void 0});return i.addEventListener(c.Events.SortingChanged,this._sortingChanged,this),i.addEventListener(c.Events.SelectedNode,(e=>{this._previewCachedResponse(e.data.data)}),this),i.setStriped(!0),i}_sortingChanged(){if(!this._dataGrid)return;const e=this._dataGrid,t=e.isSortOrderAscending(),i=e.sortColumnId();let s;"name"===i?s=(e,t)=>e._name.localeCompare(t._name):"contentType"===i?s=(e,t)=>e.data.mimeType.localeCompare(t.data.mimeType):"contentLength"===i?s=(e,t)=>e.data.resourceSize-t.data.resourceSize:"responseTime"===i?s=(e,t)=>e.data.endTime-t.data.endTime:"responseType"===i&&(s=(e,t)=>e._responseType.localeCompare(t._responseType));const a=e.rootNode().children.slice();e.rootNode().removeChildren(),a.sort(((e,i)=>{const a=s(e,i);return t?a:-a})),a.forEach((t=>e.rootNode().appendChild(t)))}async _deleteButtonClicked(e){(e||(e=this._dataGrid&&this._dataGrid.selectedNode))&&(await this._model.deleteCacheEntry(this._cache,e.data.url()),e.remove())}update(e){this._cache=e,this._resetDataGrid(),this._updateData(!0)}_updateSummaryBar(){this._summaryBarElement||(this._summaryBarElement=this.element.createChild("div","cache-storage-summary-bar")),this._summaryBarElement.removeChildren();const e=this._summaryBarElement.createChild("span");this._entryPathFilter?e.textContent=_`Matching entries: ${this._returnCount}`:e.textContent=_`Total entries: ${this._returnCount}`}_updateDataCallback(e,t,i){if(!this._dataGrid)return;const s=this._dataGrid.selectedNode&&this._dataGrid.selectedNode.data.url();this._refreshButton.setEnabled(!0),this._entriesForTest=t,this._returnCount=i,this._updateSummaryBar();const a=new Map,r=this._dataGrid.rootNode();for(const e of r.children)a.set(e.data.url,e);r.removeChildren();let n=null;for(let e=0;e<t.length;++e){const i=t[e];let o=a.get(i.requestURL);o&&o.data.responseTime===i.responseTime?o.data.number=e:(o=new Ne(e,this._createRequest(i),i.responseType),o.selectable=!0),r.appendChild(o),i.requestURL===s&&(n=o)}n?n.revealAndSelect():this._showPreview(null),this._updatedForTest()}async _updateData(e){if(!e&&this._loadingPromise)return this._loadingPromise;if(this._refreshButton.setEnabled(!1),this._loadingPromise)return this._loadingPromise;this._loadingPromise=new Promise((e=>{this._model.loadAllCacheData(this._cache,this._entryPathFilter,((t,i)=>{e({entries:t,returnCount:i})}))}));const{entries:t,returnCount:i}=await this._loadingPromise;this._updateDataCallback(0,t,i),this._loadingPromise=null}_refreshButtonClicked(e){this._updateData(!0)}_cacheContentUpdated(e){const t=e.data;this._cache.securityOrigin===t.origin&&this._cache.cacheName===t.cacheName&&this._refreshThrottler.schedule((()=>Promise.resolve(this._updateData(!0))),!0)}async _previewCachedResponse(e){let t=Ue.get(e);t||(t=new Ae(e),Ue.set(e,t)),this._dataGrid&&this._dataGrid.selectedNode&&e===this._dataGrid.selectedNode.data&&this._showPreview(t)}_createRequest(e){const t=new z.NetworkRequest("cache-storage-"+e.requestURL,e.requestURL,"","","",null);t.requestMethod=e.requestMethod,t.setRequestHeaders(e.requestHeaders),t.statusCode=e.responseStatus,t.statusText=e.responseStatusText,t.protocol=new s.ParsedURL(e.requestURL).scheme,t.responseHeaders=e.responseHeaders,t.setRequestHeadersText(""),t.endTime=e.responseTime;let i=e.responseHeaders.find((e=>"content-type"===e.name.toLowerCase()));const r=i?i.value:z.MIME_TYPE.PLAIN;t.mimeType=r,i=e.responseHeaders.find((e=>"content-length"===e.name.toLowerCase())),t.resourceSize=i&&Number(i.value)||0;let n=a.ResourceType.fromMimeType(r);return n||(n=a.ResourceType.fromURL(e.requestURL)||a.resourceTypes.Other),t.setResourceType(n),t.setContentDataProvider(this._requestContent.bind(this,t)),t}async _requestContent(e){const t=e.resourceType().isTextType(),i={error:null,content:null,encoded:!t},s=await this._cache.requestCachedResponse(e.url(),e.requestHeaders());return s&&(i.content=t?window.atob(s.body):s.body),i}_updatedForTest(){}}const Ue=new WeakMap;Pe._previewSymbol=Symbol("preview");class Ne extends c.DataGridNode{constructor(e,t,i){super(t),this._number=e;const a=new s.ParsedURL(t.url());a.isValid?this._name=m.trimURL(t.url(),a.domain()):this._name=t.url(),this._request=t,this._responseType=i}createCell(e){const t=this.createTD(e);let i;return"number"===e?i=String(this._number):"name"===e?i=this._name:"responseType"===e?i="opaqueResponse"===this._responseType?"opaque":"opaqueRedirect"===this._responseType?"opaqueredirect":this._responseType:"contentType"===e?i=this._request.mimeType:"contentLength"===e?i=(0|this._request.resourceSize).toLocaleString("en-US"):"responseTime"===e&&(i=new Date(1e3*this._request.endTime).toLocaleString()),c.DataGridImpl.setElementText(t,i||"",!0),k.Tooltip.install(t,this._request.url()),t}}class Ae extends C.VBox{constructor(i){super(),this._tabbedPane=new I.TabbedPane,this._tabbedPane.addEventListener(I.Events.TabSelected,this._tabSelected,this),this._resourceViewTabSetting=t.Settings.instance().createSetting("cacheStorageViewTab","preview"),this._tabbedPane.appendTab("headers",e.UIString("Headers"),new he.RequestHeadersView(i)),this._tabbedPane.appendTab("preview",e.UIString("Preview"),new _e.RequestPreviewView(i)),this._tabbedPane.show(this.element)}wasShown(){super.wasShown(),this._selectTab()}_selectTab(e){e||(e=this._resourceViewTabSetting.get()),e&&!this._tabbedPane.selectTab(e)&&this._tabbedPane.selectTab("headers")}_tabSelected(e){e.data.isUserGesture&&this._resourceViewTabSetting.set(e.data.tabId)}}var We=Object.freeze({__proto__:null,ServiceWorkerCacheView:Pe,DataGridNode:Ne,RequestView:Ae});class qe extends Be{constructor(e,t){super(e,new s.ParsedURL(t).displayName,!1),this.tooltip=t,this.manifestURL=t}get itemURL(){return"appcache://"+this.manifestURL}onselect(e){return super.onselect(e),this.resourcesPanel.showCategoryView(this.manifestURL,null),!1}}class je extends Ve{constructor(e){super(e,_`Cache Storage`,"CacheStorage");const t=E.Icon.create("mediumicon-database","resource-tree-item");this.setLink("https://developers.google.com/web/tools/chrome-devtools/storage/cache?utm_source=devtools"),this.setLeadingIcons([t]),this.swCacheModel=null,this.swCacheTreeElements=new Set}initialize(e){if(this.swCacheTreeElements.clear(),this.swCacheModel=e,e)for(const t of e.caches())this.addCache(e,t);q.TargetManager.instance().addModelListener(G.ServiceWorkerCacheModel,G.Events.CacheAdded,this.cacheAdded,this),q.TargetManager.instance().addModelListener(G.ServiceWorkerCacheModel,G.Events.CacheRemoved,this.cacheRemoved,this)}onattach(){super.onattach(),this.listItemElement.addEventListener("contextmenu",this.handleContextMenuEvent.bind(this),!0)}handleContextMenuEvent(e){const t=new T.ContextMenu(e);t.defaultSection().appendItem(_`Refresh Caches`,this.refreshCaches.bind(this)),t.show()}refreshCaches(){this.swCacheModel&&this.swCacheModel.refreshCacheNames()}cacheAdded(e){const t=e.data.cache,i=e.data.model;this.addCache(i,t)}addCache(e,t){const i=new Ge(this.resourcesPanel,e,t);this.swCacheTreeElements.add(i),this.appendChild(i)}cacheRemoved(e){const t=e.data.cache,i=e.data.model,s=this.cacheTreeElement(i,t);s&&(this.removeChild(s),this.swCacheTreeElements.delete(s),this.setExpandable(this.childCount()>0))}cacheTreeElement(e,t){for(const i of this.swCacheTreeElements)if(i.hasModelAndCache(e,t))return i;return null}}class Ge extends Be{constructor(e,t,i){super(e,i.cacheName+" - "+i.securityOrigin,!1),this.model=t,this.cache=i,this.view=null;const s=E.Icon.create("mediumicon-table","resource-tree-item");this.setLeadingIcons([s])}get itemURL(){return"cache://"+this.cache.cacheId}onattach(){super.onattach(),this.listItemElement.addEventListener("contextmenu",this.handleContextMenuEvent.bind(this),!0)}handleContextMenuEvent(e){const t=new T.ContextMenu(e);t.defaultSection().appendItem(_`Delete`,this.clearCache.bind(this)),t.show()}clearCache(){this.model.deleteCache(this.cache)}update(e){this.cache=e,this.view&&this.view.update(e)}onselect(e){return super.onselect(e),this.view||(this.view=new Pe(this.model,this.cache)),this.showView(this.view),!1}hasModelAndCache(e,t){return this.cache.equals(t)&&this.model===e}}class ze extends Be{constructor(e,t,i){super(e._panel,"",!1),this.sidebar=e,this.frameId=t.id,this.manifestURL=i,this.refreshTitles(t);const s=E.Icon.create("mediumicon-frame-top","navigator-folder-tree-item");this.setLeadingIcons([s])}get itemURL(){return"appcache://"+this.manifestURL+"/"+encodeURI(this.titleAsText())}refreshTitles(e){this.title=e.displayName()}frameNavigated(e){this.refreshTitles(e)}onselect(e){return super.onselect(e),this.sidebar._showApplicationCache(this.frameId),!1}}class Ke extends C.VBox{constructor(){super(!0),this.registerRequiredCSS("resources/appManifestView.css",{enableLegacyPatching:!1}),this.contentElement.classList.add("manifest-container"),t.Settings.instance().moduleSetting("colorFormat").addChangeListener(this._updateManifest.bind(this,!0)),this._emptyView=new w.EmptyWidget(e.UIString("No manifest detected")),this._emptyView.appendLink("https://developers.google.com/web/fundamentals/engage-and-retain/web-app-manifest/?utm_source=devtools"),this._emptyView.show(this.contentElement),this._emptyView.hideWidget(),this._reportView=new L.ReportView(e.UIString("App Manifest")),this._reportView.registerRequiredCSS("resources/appManifestView.css",{enableLegacyPatching:!1}),this._reportView.element.classList.add("manifest-view-header"),this._reportView.show(this.contentElement),this._reportView.hideWidget(),this._errorsSection=this._reportView.appendSection(e.UIString("Errors and warnings")),this._installabilitySection=this._reportView.appendSection(e.UIString("Installability")),this._identitySection=this._reportView.appendSection(e.UIString("Identity")),this._presentationSection=this._reportView.appendSection(e.UIString("Presentation")),this._iconsSection=this._reportView.appendSection(e.UIString("Icons"),"report-section-icons"),this._shortcutSections=[],this._nameField=this._identitySection.appendField(e.UIString("Name")),this._shortNameField=this._identitySection.appendField(e.UIString("Short name")),this._startURLField=this._presentationSection.appendField(e.UIString("Start URL"));const s=this._presentationSection.appendField(e.UIString("Theme color"));this._themeColorSwatch=new ve.ColorSwatch,s.appendChild(this._themeColorSwatch);const a=this._presentationSection.appendField(e.UIString("Background color"));this._backgroundColorSwatch=new ve.ColorSwatch,a.appendChild(this._backgroundColorSwatch),this._orientationField=this._presentationSection.appendField(e.UIString("Orientation")),this._displayField=this._presentationSection.appendField(e.UIString("Display")),this._throttler=new i.Throttler(1e3),q.TargetManager.instance().observeTargets(this),this._registeredListeners=[]}targetAdded(e){this._target||(this._target=e,this._resourceTreeModel=e.model(j.ResourceTreeModel),this._serviceWorkerManager=e.model(K.ServiceWorkerManager),this._resourceTreeModel&&this._serviceWorkerManager&&(this._updateManifest(!0),this._registeredListeners=[this._resourceTreeModel.addEventListener(j.Events.DOMContentLoaded,(e=>{this._updateManifest(!0)})),this._serviceWorkerManager.addEventListener(K.Events.RegistrationUpdated,(e=>{this._updateManifest(!1)}))]))}targetRemoved(e){this._target===e&&this._resourceTreeModel&&this._serviceWorkerManager&&(delete this._resourceTreeModel,delete this._serviceWorkerManager,r.EventTarget.removeEventListeners(this._registeredListeners))}async _updateManifest(e){if(!this._resourceTreeModel)return;const{url:t,data:i,errors:s}=await this._resourceTreeModel.fetchAppManifest(),a=await this._resourceTreeModel.getInstallabilityErrors(),r=await this._resourceTreeModel.getManifestIcons();this._throttler.schedule((()=>this._renderManifest(t,i,s,a,r)),e)}async _renderManifest(t,i,a,r,o){if(!i&&!a.length)return this._emptyView.showWidget(),void this._reportView.hideWidget();this._emptyView.hideWidget(),this._reportView.showWidget();const d=ge.Linkifier.linkifyURL(t);d.tabIndex=0,this._reportView.setURL(d),this._errorsSection.clearContent(),this._errorsSection.element.classList.toggle("hidden",!a.length);for(const e of a)this._errorsSection.appendRow().appendChild(x.createIconLabel(e.message,e.critical?"smallicon-error":"smallicon-warning"));if(!i)return;65279===i.charCodeAt(0)&&(i=i.slice(1));const l=JSON.parse(i);this._nameField.textContent=y("name"),this._shortNameField.textContent=y("short_name"),this._startURLField.removeChildren();const c=y("start_url");if(c){const e=s.ParsedURL.completeURL(t,c),i=ge.Linkifier.linkifyURL(e,{text:c});i.tabIndex=0,this._startURLField.appendChild(i)}this._themeColorSwatch.classList.toggle("hidden",!y("theme_color"));const h=n.Color.parse(y("theme_color")||"white")||n.Color.parse("white");h&&this._themeColorSwatch.renderColor(h,!0),this._backgroundColorSwatch.classList.toggle("hidden",!y("background_color"));const u=n.Color.parse(y("background_color")||"white")||n.Color.parse("white");u&&this._backgroundColorSwatch.renderColor(u,!0),this._orientationField.textContent=y("orientation");const m=y("display");this._displayField.textContent=m;const p=l.icons||[];this._iconsSection.clearContent();const g=l.shortcuts||[];for(const e of this._shortcutSections)e.detach(!0);const v=[],b=x.CheckboxLabel.create(e.UIString("Show only the minimum safe area for maskable icons"));b.classList.add("mask-checkbox"),b.addEventListener("click",(()=>{this._iconsSection.setIconMasked(b.checkboxElement.checked)})),this._iconsSection.appendRow().appendChild(b);const w=R.XLink.create("https://web.dev/maskable-icon/",_`documentation on maskable icons`);if(this._iconsSection.appendRow().appendChild(x.formatLocalized("Need help? Read our %s.",[w])),o&&o.primaryIcon){const e=document.createElement("div");e.classList.add("image-wrapper");const i=document.createElement("img");i.style.maxWidth="200px",i.style.maxHeight="200px",i.src="data:image/png;base64,"+o.primaryIcon,i.alt=_`Primary manifest icon from ${t}`;const s=_`Primary icon\nas used by Chrome`,a=this._iconsSection.appendFlexedField(s);e.appendChild(i),a.appendChild(e)}for(const e of p){const i=await this._appendIconResourceToSection(t,e,this._iconsSection);v.push(...i)}let S=1;for(const e of g){const i=this._reportView.appendSection(_`Shortcut #${S}`);this._shortcutSections.push(i),i.appendFlexedField("Name",e.name),e.short_name&&i.appendFlexedField("Short name",e.short_name),e.description&&i.appendFlexedField("Description",e.description);const a=i.appendFlexedField("URL"),r=s.ParsedURL.completeURL(t,e.url),n=ge.Linkifier.linkifyURL(r,{text:e.url});n.tabIndex=0,a.appendChild(n);const o=e.icons||[];let d=!1;for(const e of o){const s=await this._appendIconResourceToSection(t,e,i);if(s.length>0&&v.push(...s),!d&&e.sizes){const t=e.sizes.match(/^(\d+)x(\d+)$/);t&&t[1]>=96&&t[2]>=96&&(d=!0)}}d||v.push(_`Shortcut #${S} should include a 96x96 pixel icon`),S++}this._installabilitySection.clearContent(),this._installabilitySection.element.classList.toggle("hidden",!r.length);const f=this.getInstallabilityErrorMessages(r);for(const e of f)this._installabilitySection.appendRow().appendChild(x.createIconLabel(e,"smallicon-warning"));this._errorsSection.element.classList.toggle("hidden",!a.length&&!v.length);for(const e of v)this._errorsSection.appendRow().appendChild(x.createIconLabel(e,"smallicon-warning"));function y(e){const t=l[e];return"string"!=typeof t?"":t}}getInstallabilityErrorMessages(e){const t=[];for(const i of e){let e;switch(i.errorId){case"not-in-main-frame":e=_`Page is not loaded in the main frame`;break;case"not-from-secure-origin":e=_`Page is not served from a secure origin`;break;case"no-manifest":e=_`Page has no manifest <link> URL`;break;case"manifest-empty":e=_`Manifest could not be fetched, is empty, or could not be parsed`;break;case"start-url-not-valid":e=_`Manifest start URL is not valid`;break;case"manifest-missing-name-or-short-name":e=_`Manifest does not contain a 'name' or 'short_name' field`;break;case"manifest-display-not-supported":e=_`Manifest 'display' property must be one of 'standalone', 'fullscreen', or 'minimal-ui'`;break;case"manifest-missing-suitable-icon":if(1!==i.errorArguments.length||"minimum-icon-size-in-pixels"!==i.errorArguments[0].name){console.error("Installability error does not have the correct errorArguments");break}e=_`Manifest does not contain a suitable icon - PNG, SVG or WebP format of at least ${i.errorArguments[0].value}px is required, the sizes attribute must be set, and the purpose attribute, if set, must include "any" and should not include "maskable".`;break;case"no-matching-service-worker":e=_`No matching service worker detected. You may need to reload the page, or check that the scope of the service worker for the current page encloses the scope and start URL from the manifest.`;break;case"no-acceptable-icon":if(1!==i.errorArguments.length||"minimum-icon-size-in-pixels"!==i.errorArguments[0].name){console.error("Installability error does not have the correct errorArguments");break}e=_`No supplied icon is at least ${i.errorArguments[0].value}px square in PNG, SVG or WebP format, with the purpose attribute unset or set to "any".`;break;case"cannot-download-icon":e=_`Could not download a required icon from the manifest`;break;case"no-icon-available":e=_`Downloaded icon was empty or corrupted`;break;case"platform-not-supported-on-android":e=_`The specified application platform is not supported on Android`;break;case"no-id-specified":e=_`No Play store ID provided`;break;case"ids-do-not-match":e=_`The Play Store app URL and Play Store ID do not match`;break;case"already-installed":e=_`The app is already installed`;break;case"url-not-supported-for-webapk":e=_`A URL in the manifest contains a username, password, or port`;break;case"in-incognito":e=_`Page is loaded in an incognito window`;break;case"not-offline-capable":e=_`Page does not work offline`;break;case"no-url-for-service-worker":e=_`Could not check service worker without a 'start_url' field in the manifest`;break;case"prefer-related-applications":e=_`Manifest specifies prefer_related_applications: true`;break;case"prefer-related-applications-only-beta-stable":e=_`prefer_related_applications is only supported on Chrome Beta and Stable channels on Android.`;break;case"manifest-display-override-not-supported":e=_`Manifest contains 'display_override' field, and the first supported display mode must be one of 'standalone', 'fullscreen', or 'minimal-ui'`;break;case"warn-not-offline-capable":e=_`Page does not work offline. The page will not be regarded as installable after Chrome 93, stable release August 2021.`;break;default:console.error(`Installability error id '${i.errorId}' is not recognized`)}e&&t.push(e)}return t}async _loadImage(e){const t=document.createElement("div");t.classList.add("image-wrapper");const i=document.createElement("img"),s=new Promise(((e,t)=>{i.onload=e,i.onerror=t}));i.src=e,i.alt=_`Image from ${e}`,t.appendChild(i);try{return await s,{wrapper:t,image:i}}catch(e){}return null}async _appendIconResourceToSection(e,t,i){const a=[];if(!t.src)return a.push(_`Icon src is not set`),a;const r=s.ParsedURL.completeURL(e,t.src);if(!r)return a.push(_`Icon URL '${t.src}' failed to parse`),a;const n=await this._loadImage(r);if(!n)return a.push(_`Icon ${r} failed to load`),a;const{wrapper:o,image:d}=n,l=(t.sizes?t.sizes.replace("x","×")+"px":"")+"\n"+(t.type||""),c=i.appendFlexedField(l);if(t.sizes)if(/^\d+x\d+$/.test(t.sizes)){const[e,i]=t.sizes.split("x").map((e=>parseInt(e,10)));e!==i?a.push(_`Icon ${r} dimensions should be square`):d.naturalWidth!==e&&d.naturalHeight!==i?a.push(_`Actual size (${d.naturalWidth}×${d.naturalHeight})px of icon ${r} does not match specified size (${e}×${i}px)`):d.naturalWidth!==e?a.push(_`Actual width (${d.naturalWidth}px) of icon ${r} does not match specified width (${e}px)`):d.naturalHeight!==i&&a.push(_`Actual height (${d.naturalHeight}px) of icon ${r} does not match specified height (${i}px)`)}else a.push(_`Icon ${r} should specify its size as \`{width}x{height}\``);else a.push(_`Icon ${r} does not specify its size in the manifest`);return c.appendChild(o),a}}var $e=Object.freeze({__proto__:null,AppManifestView:Ke});class He extends q.SDKModel{constructor(e){super(e),this._backgroundServiceAgent=e.backgroundServiceAgent(),e.registerBackgroundServiceDispatcher(this),this._events=new Map}enable(e){this._events.set(e,[]),this._backgroundServiceAgent.invoke_startObserving({service:e})}setRecording(e,t){this._backgroundServiceAgent.invoke_setRecording({shouldRecord:e,service:t})}clearEvents(e){this._events.set(e,[]),this._backgroundServiceAgent.invoke_clearEvents({service:e})}getEvents(e){return this._events.get(e)||[]}recordingStateChanged({isRecording:e,service:t}){this.dispatchEventToListeners(Qe.RecordingStateChanged,{isRecording:e,serviceName:t})}backgroundServiceEventReceived({backgroundServiceEvent:e}){this._events.get(e.service).push(e),this.dispatchEventToListeners(Qe.BackgroundServiceEventReceived,e)}}q.SDKModel.register(He,q.Capability.Browser,!1);const Qe={RecordingStateChanged:Symbol("RecordingStateChanged"),BackgroundServiceEventReceived:Symbol("BackgroundServiceEventReceived")};var Xe=Object.freeze({__proto__:null,BackgroundServiceModel:He,Events:Qe});class Je extends C.VBox{static getUIString(e){switch(e){case Protocol.BackgroundService.ServiceName.BackgroundFetch:return _`Background Fetch`;case Protocol.BackgroundService.ServiceName.BackgroundSync:return _`Background Sync`;case Protocol.BackgroundService.ServiceName.PushMessaging:return _`Push Messaging`;case Protocol.BackgroundService.ServiceName.Notifications:return _`Notifications`;case Protocol.BackgroundService.ServiceName.PaymentHandler:return _`Payment Handler`;case Protocol.BackgroundService.ServiceName.PeriodicBackgroundSync:return _`Periodic Background Sync`;default:return""}}constructor(e,t){if(super(!0),this.registerRequiredCSS("resources/backgroundServiceView.css",{enableLegacyPatching:!0}),this.registerRequiredCSS("ui/emptyWidget.css",{enableLegacyPatching:!1}),this._serviceName=e,this._model=t,this._model.addEventListener(Qe.RecordingStateChanged,this._onRecordingStateChanged,this),this._model.addEventListener(Qe.BackgroundServiceEventReceived,this._onEventReceived,this),this._model.enable(this._serviceName),this._serviceWorkerManager=this._model.target().model(K.ServiceWorkerManager),this._securityOriginManager=this._model.target().model($.SecurityOriginManager),!this._securityOriginManager)throw new Error("SecurityOriginManager instance is missing");this._securityOriginManager.addEventListener($.Events.MainSecurityOriginChanged,(()=>this._onOriginChanged())),this._recordAction=D.ActionRegistry.instance().action("background-service.toggle-recording"),this._recordButton,this._originCheckbox,this._saveButton,this._toolbar=new b.Toolbar("background-service-toolbar",this.contentElement),this._setupToolbar(),this._splitWidget=new y.SplitWidget(!1,!0),this._splitWidget.show(this.contentElement),this._dataGrid=this._createDataGrid(),this._previewPanel=new C.VBox,this._selectedEventNode=null,this._preview=null,this._splitWidget.setMainWidget(this._dataGrid.asWidget()),this._splitWidget.setSidebarWidget(this._previewPanel),this._showPreview(null)}async _setupToolbar(){this._recordButton=b.Toolbar.createActionButton(this._recordAction),this._toolbar.appendToolbarItem(this._recordButton);const e=new b.ToolbarButton(_`Clear`,"largeicon-clear");e.addEventListener(b.ToolbarButton.Events.Click,(()=>this._clearEvents())),this._toolbar.appendToolbarItem(e),this._toolbar.appendSeparator(),this._saveButton=new b.ToolbarButton(_`Save events`,"largeicon-download"),this._saveButton.addEventListener(b.ToolbarButton.Events.Click,(e=>{this._saveToFile()})),this._saveButton.setEnabled(!1),this._toolbar.appendToolbarItem(this._saveButton),this._toolbar.appendSeparator(),this._originCheckbox=new b.ToolbarCheckbox(_`Show events from other domains`,_`Show events from other domains`,(()=>this._refreshView())),this._toolbar.appendToolbarItem(this._originCheckbox)}_refreshView(){this._clearView();const e=this._model.getEvents(this._serviceName).filter((e=>this._acceptEvent(e)));for(const t of e)this._addEvent(t)}_clearView(){this._selectedEventNode=null,this._dataGrid.rootNode().removeChildren(),this._saveButton.setEnabled(!1),this._showPreview(null)}_toggleRecording(){this._model.setRecording(!this._recordButton.toggled(),this._serviceName)}_clearEvents(){this._model.clearEvents(this._serviceName),this._clearView()}_onRecordingStateChanged(e){const t=e.data;t.serviceName===this._serviceName&&t.isRecording!==this._recordButton.toggled()&&(this._recordButton.setToggled(t.isRecording),this._updateRecordButtonTooltip(),this._showPreview(this._selectedEventNode))}_updateRecordButtonTooltip(){const e=this._recordButton.toggled()?_`Stop recording events`:_`Start recording events`;this._recordButton.setTitle(e,"background-service.toggle-recording")}_onEventReceived(e){const t=e.data;this._acceptEvent(t)&&this._addEvent(t)}_onOriginChanged(){this._originCheckbox.checked()||this._refreshView()}_addEvent(e){const t=this._createEventData(e),i=new Ye(t,e.eventMetadata);this._dataGrid.rootNode().appendChild(i),1===this._dataGrid.rootNode().children.length&&(this._saveButton.setEnabled(!0),this._showPreview(this._selectedEventNode))}_createDataGrid(){const e=[{id:"id",title:_`#`,weight:1},{id:"timestamp",title:_`Timestamp`,weight:8},{id:"eventName",title:_`Event`,weight:10},{id:"origin",title:_`Origin`,weight:10},{id:"swScope",title:_`SW Scope`,weight:2},{id:"instanceId",title:_`Instance ID`,weight:10}],t=new c.DataGridImpl({displayName:_`Background Services`,columns:e,editCallback:void 0,refreshCallback:void 0,deleteCallback:void 0});return t.setStriped(!0),t.addEventListener(c.Events.SelectedNode,(e=>this._showPreview(e.data))),t}_createEventData(e){let t="";const i=this._serviceWorkerManager?this._serviceWorkerManager.registrations().get(e.serviceWorkerRegistrationId):void 0;return i&&(t=i.scopeURL.substr(i.securityOrigin.length)),{id:this._dataGrid.rootNode().children.length+1,timestamp:x.formatTimestamp(1e3*e.timestamp,!0),origin:e.origin,swScope:t,eventName:e.eventName,instanceId:e.instanceId}}_acceptEvent(e){if(e.service!==this._serviceName)return!1;if(this._originCheckbox.checked())return!0;const t=e.origin.substr(0,e.origin.length-1);return this._securityOriginManager.securityOrigins().includes(t)}_createLearnMoreLink(){let e="https://developers.google.com/web/tools/chrome-devtools/javascript/background-services?utm_source=devtools";switch(this._serviceName){case Protocol.BackgroundService.ServiceName.BackgroundFetch:e+="#fetch";break;case Protocol.BackgroundService.ServiceName.BackgroundSync:e+="#sync";break;case Protocol.BackgroundService.ServiceName.PushMessaging:e+="#push";break;case Protocol.BackgroundService.ServiceName.Notifications:e+="#notifications"}return R.XLink.create(e,_`Learn more`)}_showPreview(e){if(this._selectedEventNode&&this._selectedEventNode===e)return;if(this._selectedEventNode=e,this._preview&&this._preview.detach(),this._selectedEventNode)return this._preview=this._selectedEventNode.createPreview(),void this._preview.show(this._previewPanel.contentElement);this._preview=new C.VBox,this._preview.contentElement.classList.add("background-service-preview","fill");const t=this._preview.contentElement.createChild("div");if(this._dataGrid.rootNode().children.length)t.createChild("p").textContent=_`Select an entry to view metadata`;else if(this._recordButton.toggled()){const e=Je.getUIString(this._serviceName);t.createChild("p").textContent=_`Recording ${e} activity...`,t.createChild("p").textContent=_`DevTools will record all ${e} activity for up to 3 days, even when closed.`}else{const e=b.Toolbar.createActionButton(this._recordAction),i=document.createElement("b");i.classList.add("background-service-shortcut"),i.textContent=M.ShortcutRegistry.instance().shortcutsForAction("background-service.toggle-recording")[0].title();const s=x.createInlineButton(e);s.classList.add("background-service-record-inline-button"),t.createChild("p").appendChild(x.formatLocalized("Click the record button %s or hit %s to start recording.",[s,i])),t.appendChild(this._createLearnMoreLink())}this._preview.show(this._previewPanel.contentElement)}async _saveToFile(){const e=`${this._serviceName}-${p.toISO8601Compact(new Date)}.json`,t=new be.FileOutputStream;if(!await t.open(e))return;const i=this._model.getEvents(this._serviceName).filter((e=>this._acceptEvent(e)));await t.write(JSON.stringify(i,void 0,2)),t.close()}}class Ye extends c.DataGridNode{constructor(e,t){super(e),this._eventMetadata=t.sort(((e,t)=>m.compare(e.key,t.key)))}createPreview(){const e=new C.VBox;e.element.classList.add("background-service-metadata");for(const t of this._eventMetadata){const i=document.createElement("div");i.classList.add("background-service-metadata-entry"),i.createChild("div","background-service-metadata-name").textContent=t.key+": ",t.value?i.createChild("div","background-service-metadata-value source-code").textContent=t.value:i.createChild("div","background-service-metadata-value background-service-empty-value").textContent=_`empty`,e.element.appendChild(i)}if(!e.element.children.length){const t=document.createElement("div");t.classList.add("background-service-metadata-entry"),t.createChild("div","background-service-metadata-name").textContent=_`No metadata for this event`,e.element.appendChild(t)}return e}}var Ze=Object.freeze({__proto__:null,BackgroundServiceView:Je,EventDataNode:Ye,ActionDelegate:class{handleAction(e,t){const i=e.flavor(Je);switch(t){case"background-service.toggle-recording":if(!i)throw new Error("BackgroundServiceView instance is missing");return i._toggleRecording(),!0}return!1}},RecordingState:undefined,EventData:undefined});class et{constructor(e,t,i,s,a){this._model=e,this._id=t,this._domain=i,this._name=s,this._version=a}get id(){return this._id}get name(){return this._name}set name(e){this._name=e}get version(){return this._version}set version(e){this._version=e}get domain(){return this._domain}set domain(e){this._domain=e}async tableNames(){const{tableNames:e}=await this._model._agent.invoke_getDatabaseTableNames({databaseId:this._id})||[];return e.sort()}async executeSql(t,i,s){const a=await this._model._agent.invoke_executeSQL({databaseId:this._id,query:t}),r=a.getError()||null;if(r)return void s(r);const n=a.sqlError;if(!n)return void i(a.columnNames||[],a.values||[]);let o;o=n.message?n.message:2===n.code?e.UIString("Database no longer has expected version."):e.UIString("An unexpected error %s occurred.",n.code),s(o)}}class tt extends q.SDKModel{constructor(e){super(e),this._databases=[],this._agent=e.databaseAgent(),this.target().registerDatabaseDispatcher(new st(this))}enable(){this._enabled||(this._agent.invoke_enable(),this._enabled=!0)}disable(){this._enabled&&(this._enabled=!1,this._databases=[],this._agent.invoke_disable(),this.dispatchEventToListeners(it.DatabasesRemoved))}databases(){const e=[];for(const t of this._databases)e.push(t);return e}_addDatabase(e){this._databases.push(e),this.dispatchEventToListeners(it.DatabaseAdded,e)}}q.SDKModel.register(tt,q.Capability.DOM,!1);const it={DatabaseAdded:Symbol("DatabaseAdded"),DatabasesRemoved:Symbol("DatabasesRemoved")};class st{constructor(e){this._model=e}addDatabase({database:e}){this._model._addDatabase(new et(this._model,e.id,e.domain,e.name,e.version))}}var at=Object.freeze({__proto__:null,Database:et,DatabaseModel:tt,Events:it,DatabaseDispatcher:st});class rt extends o.ObjectWrapper{constructor(e,t,i){super(),this._model=e,this._securityOrigin=t,this._isLocalStorage=i}static storageId(e,t){return{securityOrigin:e,isLocalStorage:t}}get id(){return rt.storageId(this._securityOrigin,this._isLocalStorage)}get securityOrigin(){return this._securityOrigin}get isLocalStorage(){return this._isLocalStorage}getItems(){return this._model._agent.invoke_getDOMStorageItems({storageId:this.id}).then((({entries:e})=>e))}setItem(e,t){this._model._agent.invoke_setDOMStorageItem({storageId:this.id,key:e,value:t})}removeItem(e){this._model._agent.invoke_removeDOMStorageItem({storageId:this.id,key:e})}clear(){this._model._agent.invoke_clear({storageId:this.id})}}rt.Events={DOMStorageItemsCleared:Symbol("DOMStorageItemsCleared"),DOMStorageItemRemoved:Symbol("DOMStorageItemRemoved"),DOMStorageItemAdded:Symbol("DOMStorageItemAdded"),DOMStorageItemUpdated:Symbol("DOMStorageItemUpdated")};class nt extends q.SDKModel{constructor(e){super(e),this._securityOriginManager=e.model($.SecurityOriginManager),this._storages={},this._agent=e.domstorageAgent()}enable(){if(!this._enabled){if(this.target().registerDOMStorageDispatcher(new dt(this)),this._securityOriginManager){this._securityOriginManager.addEventListener($.Events.SecurityOriginAdded,this._securityOriginAdded,this),this._securityOriginManager.addEventListener($.Events.SecurityOriginRemoved,this._securityOriginRemoved,this);for(const e of this._securityOriginManager.securityOrigins())this._addOrigin(e)}this._agent.invoke_enable(),this._enabled=!0}}clearForOrigin(e){if(this._enabled){for(const t of[!0,!1]){const i=this._storageKey(e,t),s=this._storages[i];if(!s)return;s.clear()}this._removeOrigin(e),this._addOrigin(e)}}_securityOriginAdded(e){this._addOrigin(e.data)}_addOrigin(e){const t=new s.ParsedURL(e);if(t.isValid&&"data"!==t.scheme&&"about"!==t.scheme&&"javascript"!==t.scheme)for(const t of[!0,!1]){const i=this._storageKey(e,t);console.assert(!this._storages[i]);const s=new rt(this,e,t);this._storages[i]=s,this.dispatchEventToListeners(ot.DOMStorageAdded,s)}}_securityOriginRemoved(e){this._removeOrigin(e.data)}_removeOrigin(e){for(const t of[!0,!1]){const i=this._storageKey(e,t),s=this._storages[i];s&&(delete this._storages[i],this.dispatchEventToListeners(ot.DOMStorageRemoved,s))}}_storageKey(e,t){return JSON.stringify(rt.storageId(e,t))}_domStorageItemsCleared(e){const t=this.storageForId(e);if(!t)return;t.dispatchEventToListeners(rt.Events.DOMStorageItemsCleared,{})}_domStorageItemRemoved(e,t){const i=this.storageForId(e);if(!i)return;const s={key:t};i.dispatchEventToListeners(rt.Events.DOMStorageItemRemoved,s)}_domStorageItemAdded(e,t,i){const s=this.storageForId(e);if(!s)return;const a={key:t,value:i};s.dispatchEventToListeners(rt.Events.DOMStorageItemAdded,a)}_domStorageItemUpdated(e,t,i,s){const a=this.storageForId(e);if(!a)return;const r={key:t,oldValue:i,value:s};a.dispatchEventToListeners(rt.Events.DOMStorageItemUpdated,r)}storageForId(e){return this._storages[JSON.stringify(e)]}storages(){const e=[];for(const t in this._storages)e.push(this._storages[t]);return e}}q.SDKModel.register(nt,q.Capability.DOM,!1);const ot={DOMStorageAdded:Symbol("DOMStorageAdded"),DOMStorageRemoved:Symbol("DOMStorageRemoved")};class dt{constructor(e){this._model=e}domStorageItemsCleared({storageId:e}){this._model._domStorageItemsCleared(e)}domStorageItemRemoved({storageId:e,key:t}){this._model._domStorageItemRemoved(e,t)}domStorageItemAdded({storageId:e,key:t,newValue:i}){this._model._domStorageItemAdded(e,t,i)}domStorageItemUpdated({storageId:e,key:t,oldValue:i,newValue:s}){this._model._domStorageItemUpdated(e,t,i,s)}}var lt=Object.freeze({__proto__:null,DOMStorage:rt,DOMStorageModel:nt,Events:ot,DOMStorageDispatcher:dt});class ct extends q.SDKModel{constructor(e){super(e),e.registerStorageDispatcher(this),this._securityOriginManager=e.model($.SecurityOriginManager),this._indexedDBAgent=e.indexedDBAgent(),this._storageAgent=e.storageAgent(),this._databases=new Map,this._databaseNamesBySecurityOrigin={},this._originsUpdated=new Set,this._throttler=new i.Throttler(1e3)}static keyFromIDBKey(e){if(null==e)return;let t;switch(typeof e){case"number":t={type:Protocol.IndexedDB.KeyType.Number,number:e};break;case"string":t={type:Protocol.IndexedDB.KeyType.String,string:e};break;case"object":if(e instanceof Date)t={type:Protocol.IndexedDB.KeyType.Date,date:e.getTime()};else{if(!Array.isArray(e))return;{const i=[];for(let t=0;t<e.length;++t){const s=ct.keyFromIDBKey(e[t]);s&&i.push(s)}t={type:Protocol.IndexedDB.KeyType.Array,array:i}}}break;default:return}return t}static _keyRangeFromIDBKeyRange(e){const t={};return t.lower=ct.keyFromIDBKey(e.lower),t.upper=ct.keyFromIDBKey(e.upper),t.lowerOpen=Boolean(e.lowerOpen),t.upperOpen=Boolean(e.upperOpen),t}static idbKeyPathFromKeyPath(e){let t;switch(e.type){case Protocol.IndexedDB.KeyPathType.Null:t=null;break;case Protocol.IndexedDB.KeyPathType.String:t=e.string;break;case Protocol.IndexedDB.KeyPathType.Array:t=e.array}return t}static keyPathStringFromIDBKeyPath(e){return"string"==typeof e?'"'+e+'"':e instanceof Array?'["'+e.join('", "')+'"]':null}enable(){if(!this._enabled){if(this._indexedDBAgent.invoke_enable(),this._securityOriginManager){this._securityOriginManager.addEventListener($.Events.SecurityOriginAdded,this._securityOriginAdded,this),this._securityOriginManager.addEventListener($.Events.SecurityOriginRemoved,this._securityOriginRemoved,this);for(const e of this._securityOriginManager.securityOrigins())this._addOrigin(e)}this._enabled=!0}}clearForOrigin(e){this._enabled&&this._databaseNamesBySecurityOrigin[e]&&(this._removeOrigin(e),this._addOrigin(e))}async deleteDatabase(e){this._enabled&&(await this._indexedDBAgent.invoke_deleteDatabase({securityOrigin:e.securityOrigin,databaseName:e.name}),this._loadDatabaseNames(e.securityOrigin))}async refreshDatabaseNames(){for(const e in this._databaseNamesBySecurityOrigin)await this._loadDatabaseNames(e);this.dispatchEventToListeners(ht.DatabaseNamesRefreshed)}refreshDatabase(e){this._loadDatabase(e,!0)}async clearObjectStore(e,t){await this._indexedDBAgent.invoke_clearObjectStore({securityOrigin:e.securityOrigin,databaseName:e.name,objectStoreName:t})}async deleteEntries(e,t,i){const s=ct._keyRangeFromIDBKeyRange(i);await this._indexedDBAgent.invoke_deleteObjectStoreEntries({securityOrigin:e.securityOrigin,databaseName:e.name,objectStoreName:t,keyRange:s})}_securityOriginAdded(e){const t=e.data;this._addOrigin(t)}_securityOriginRemoved(e){const t=e.data;this._removeOrigin(t)}_addOrigin(e){console.assert(!this._databaseNamesBySecurityOrigin[e]),this._databaseNamesBySecurityOrigin[e]=[],this._loadDatabaseNames(e),this._isValidSecurityOrigin(e)&&this._storageAgent.invoke_trackIndexedDBForOrigin({origin:e})}_removeOrigin(e){console.assert(Boolean(this._databaseNamesBySecurityOrigin[e]));for(let t=0;t<this._databaseNamesBySecurityOrigin[e].length;++t)this._databaseRemoved(e,this._databaseNamesBySecurityOrigin[e][t]);delete this._databaseNamesBySecurityOrigin[e],this._isValidSecurityOrigin(e)&&this._storageAgent.invoke_untrackIndexedDBForOrigin({origin:e})}_isValidSecurityOrigin(e){const t=s.ParsedURL.fromString(e);return null!==t&&t.scheme.startsWith("http")}_updateOriginDatabaseNames(e,t){const i=new Set(t),s=new Set(this._databaseNamesBySecurityOrigin[e]);this._databaseNamesBySecurityOrigin[e]=t;for(const t of s)i.has(t)||this._databaseRemoved(e,t);for(const t of i)s.has(t)||this._databaseAdded(e,t)}databases(){const e=[];for(const t in this._databaseNamesBySecurityOrigin){const i=this._databaseNamesBySecurityOrigin[t];for(let s=0;s<i.length;++s)e.push(new ut(t,i[s]))}return e}_databaseAdded(e,t){const i=new ut(e,t);this.dispatchEventToListeners(ht.DatabaseAdded,{model:this,databaseId:i})}_databaseRemoved(e,t){const i=new ut(e,t);this.dispatchEventToListeners(ht.DatabaseRemoved,{model:this,databaseId:i})}async _loadDatabaseNames(e){const{databaseNames:t}=await this._indexedDBAgent.invoke_requestDatabaseNames({securityOrigin:e});return t&&this._databaseNamesBySecurityOrigin[e]?(this._updateOriginDatabaseNames(e,t),t):[]}async _loadDatabase(e,t){const{databaseWithObjectStores:i}=await this._indexedDBAgent.invoke_requestDatabase({securityOrigin:e.securityOrigin,databaseName:e.name});if(!i)return;if(!this._databaseNamesBySecurityOrigin[e.securityOrigin])return;const s=new mt(e,i.version);this._databases.set(e,s);for(const e of i.objectStores){const t=ct.idbKeyPathFromKeyPath(e.keyPath),i=new pt(e.name,t,e.autoIncrement);for(let t=0;t<e.indexes.length;++t){const s=e.indexes[t],a=ct.idbKeyPathFromKeyPath(s.keyPath),r=new gt(s.name,a,s.unique,s.multiEntry);i.indexes.set(r.name,r)}s.objectStores.set(i.name,i)}this.dispatchEventToListeners(ht.DatabaseLoaded,{model:this,database:s,entriesUpdated:t})}loadObjectStoreData(e,t,i,s,a,r){this._requestData(e,e.name,t,"",i,s,a,r)}loadIndexData(e,t,i,s,a,r,n){this._requestData(e,e.name,t,i,s,a,r,n)}async _requestData(e,t,i,s,a,r,n,o){const d=a?ct._keyRangeFromIDBKeyRange(a):void 0,l=await this._indexedDBAgent.invoke_requestData({securityOrigin:e.securityOrigin,databaseName:t,objectStoreName:i,indexName:s,skipCount:r,pageSize:n,keyRange:d});if(l.getError())return void console.error("IndexedDBAgent error: "+l.getError());const c=this.target().model(H.RuntimeModel);if(!c||!this._databaseNamesBySecurityOrigin[e.securityOrigin])return;const h=l.objectStoreDataEntries,_=[];for(const e of h){const t=c.createRemoteObject(e.key),i=c.createRemoteObject(e.primaryKey),s=c.createRemoteObject(e.value);_.push(new _t(t,i,s))}o(_,l.hasMore)}async getMetadata(e,t){const i=e.securityOrigin,s=e.name,a=t.name,r=await this._indexedDBAgent.invoke_getMetadata({securityOrigin:i,databaseName:s,objectStoreName:a});return r.getError()?(console.error("IndexedDBAgent error: "+r.getError()),null):{entriesCount:r.entriesCount,keyGeneratorValue:r.keyGeneratorValue}}async _refreshDatabaseList(e){const t=await this._loadDatabaseNames(e);for(const i of t)this._loadDatabase(new ut(e,i),!1)}indexedDBListUpdated({origin:e}){this._originsUpdated.add(e),this._throttler.schedule((()=>{const e=Array.from(this._originsUpdated,(e=>{this._refreshDatabaseList(e)}));return this._originsUpdated.clear(),Promise.all(e)}))}indexedDBContentUpdated({origin:e,databaseName:t,objectStoreName:i}){const s=new ut(e,t);this.dispatchEventToListeners(ht.IndexedDBContentUpdated,{databaseId:s,objectStoreName:i,model:this})}cacheStorageListUpdated(e){}cacheStorageContentUpdated(e){}}q.SDKModel.register(ct,q.Capability.Storage,!1);const ht={DatabaseAdded:Symbol("DatabaseAdded"),DatabaseRemoved:Symbol("DatabaseRemoved"),DatabaseLoaded:Symbol("DatabaseLoaded"),DatabaseNamesRefreshed:Symbol("DatabaseNamesRefreshed"),IndexedDBContentUpdated:Symbol("IndexedDBContentUpdated")};class _t{constructor(e,t,i){this.key=e,this.primaryKey=t,this.value=i}}class ut{constructor(e,t){this.securityOrigin=e,this.name=t}equals(e){return this.name===e.name&&this.securityOrigin===e.securityOrigin}}class mt{constructor(e,t){this.databaseId=e,this.version=t,this.objectStores=new Map}}class pt{constructor(e,t,i){this.name=e,this.keyPath=t,this.autoIncrement=i,this.indexes=new Map}get keyPathString(){return ct.keyPathStringFromIDBKeyPath(this.keyPath)}}class gt{constructor(e,t,i,s){this.name=e,this.keyPath=t,this.unique=i,this.multiEntry=s}get keyPathString(){return ct.keyPathStringFromIDBKeyPath(this.keyPath)}}var vt=Object.freeze({__proto__:null,IndexedDBModel:ct,Events:ht,Entry:_t,DatabaseId:ut,Database:mt,ObjectStore:pt,Index:gt,ObjectStoreMetadata:undefined});const bt={storageQuotaUsed:"{PH1} used out of {PH2} storage quota",storageQuotaUsedWithBytes:"{PH1} bytes used out of {PH2} bytes storage quota",storageWithCustomMarker:"{PH1} (custom)"},wt=Se.registerUIStrings("resources/ClearStorageView.js",bt),St=Se.getLocalizedString.bind(void 0,wt);class ft extends O.ThrottledWidget{constructor(){super(!0,1e3),this.registerRequiredCSS("resources/clearStorageView.css",{enableLegacyPatching:!1}),this.contentElement.classList.add("clear-storage-container");const i=Protocol.Storage.StorageType;this._pieColors=new Map([[i.Appcache,"rgb(110, 161, 226)"],[i.Cache_storage,"rgb(229, 113, 113)"],[i.Cookies,"rgb(239, 196, 87)"],[i.Indexeddb,"rgb(155, 127, 230)"],[i.Local_storage,"rgb(116, 178, 102)"],[i.Service_workers,"rgb(255, 167, 36)"],[i.Websql,"rgb(203, 220, 56)"]]),this._reportView=new L.ReportView(e.UIString("Storage")),this._reportView.registerRequiredCSS("resources/clearStorageView.css",{enableLegacyPatching:!1}),this._reportView.element.classList.add("clear-storage-header"),this._reportView.show(this.contentElement),this._target=null,this._securityOrigin=null,this._settings=new Map;for(const e of yt)this._settings.set(e,t.Settings.instance().createSetting("clear-storage-"+e,!0));this._includeThirdPartyCookiesSetting=t.Settings.instance().createSetting("clear-storage-include-third-party-cookies",!1);const s=this._reportView.appendSection(e.UIString("Usage"));this._quotaRow=s.appendSelectableRow(),this._quotaRow.classList.add("quota-usage-row");const a=s.appendRow(),r=R.XLink.create("https://developers.google.com/web/tools/chrome-devtools/progressive-web-apps#opaque-responses",_`Learn more`);a.appendChild(r),this._quotaUsage=null,this._pieChart=new fe.PieChart,this._populatePieChart(0,[]);const n=s.appendRow();n.classList.add("usage-breakdown-row"),n.appendChild(this._pieChart),this._previousOverrideFieldValue="";const o=s.appendRow();this._quotaOverrideCheckbox=x.CheckboxLabel.create("Simulate custom storage quota",!1,""),o.appendChild(this._quotaOverrideCheckbox),this._quotaOverrideCheckbox.checkboxElement.addEventListener("click",this._onClickCheckbox.bind(this),!1),this._quotaOverrideControlRow=s.appendRow(),this._quotaOverrideEditor=this._quotaOverrideControlRow.createChild("input","quota-override-notification-editor"),this._quotaOverrideControlRow.appendChild(x.createLabel(e.UIString("MB"))),this._quotaOverrideControlRow.classList.add("hidden"),this._quotaOverrideEditor.addEventListener("keyup",(e=>{"Enter"===e.key&&(this._applyQuotaOverrideFromInputField(),e.consume(!0))})),this._quotaOverrideEditor.addEventListener("focusout",(e=>{this._applyQuotaOverrideFromInputField(),e.consume(!0)}));const d=s.appendRow();this._quotaOverrideErrorMessage=d.createChild("div","quota-override-error");const l=this._reportView.appendSection("","clear-storage-button").appendRow();this._clearButton=x.createTextButton(_`Clear site data`,this._clear.bind(this)),this._clearButton.id="storage-view-clear-button",l.appendChild(this._clearButton),this._includeThirdPartyCookiesCheckbox=F.createSettingCheckbox(_`including third-party cookies`,this._includeThirdPartyCookiesSetting,!0),this._includeThirdPartyCookiesCheckbox.classList.add("include-third-party-cookies"),l.appendChild(this._includeThirdPartyCookiesCheckbox);const c=this._reportView.appendSection(e.UIString("Application"));this._appendItem(c,e.UIString("Unregister service workers"),"service_workers"),c.markFieldListAsGroup();const h=this._reportView.appendSection(e.UIString("Storage"));this._appendItem(h,e.UIString("Local and session storage"),"local_storage"),this._appendItem(h,e.UIString("IndexedDB"),"indexeddb"),this._appendItem(h,e.UIString("Web SQL"),"websql"),this._appendItem(h,e.UIString("Cookies"),"cookies"),h.markFieldListAsGroup();const u=this._reportView.appendSection(e.UIString("Cache"));this._appendItem(u,e.UIString("Cache storage"),"cache_storage"),this._appendItem(u,e.UIString("Application cache"),"appcache"),u.markFieldListAsGroup(),q.TargetManager.instance().observeTargets(this)}_appendItem(e,t,i){e.appendRow().appendChild(F.createSettingCheckbox(t,this._settings.get(i),!0))}targetAdded(e){if(this._target)return;this._target=e;const t=e.model($.SecurityOriginManager);this._updateOrigin(t.mainSecurityOrigin(),t.unreachableMainSecurityOrigin()),t.addEventListener($.Events.MainSecurityOriginChanged,this._originChanged,this)}targetRemoved(e){if(this._target!==e)return;e.model($.SecurityOriginManager).removeEventListener($.Events.MainSecurityOriginChanged,this._originChanged,this)}_originChanged(e){const t=e.data.mainSecurityOrigin,i=e.data.unreachableMainSecurityOrigin;this._updateOrigin(t,i)}async _updateOrigin(e,t){const i=this._securityOrigin;t?(this._securityOrigin=t,this._reportView.setSubtitle(_`${t} (failed to load)`)):(this._securityOrigin=e,this._reportView.setSubtitle(e)),i!==this._securityOrigin&&(this._quotaOverrideControlRow.classList.add("hidden"),this._quotaOverrideCheckbox.checkboxElement.checked=!1,this._quotaOverrideErrorMessage.textContent=""),this.doUpdate()}async _applyQuotaOverrideFromInputField(){if(!this._target||!this._securityOrigin)return void(this._quotaOverrideErrorMessage.textContent=_`Internal error`);this._quotaOverrideErrorMessage.textContent="";const e=this._quotaOverrideEditor.value;if(""===e)return await this._clearQuotaForOrigin(this._target,this._securityOrigin),void(this._previousOverrideFieldValue="");const t=parseFloat(e);if(!Number.isFinite(t))return void(this._quotaOverrideErrorMessage.textContent=_`Please enter a number`);if(t<0)return void(this._quotaOverrideErrorMessage.textContent=_`Number must be non-negative`);const i=1e6,s=Math.round(t*i),a=""+s/i;this._quotaOverrideEditor.value=a,this._previousOverrideFieldValue=a,await this._target.storageAgent().invoke_overrideQuotaForOrigin({origin:this._securityOrigin,quotaSize:s})}async _clearQuotaForOrigin(e,t){await e.storageAgent().invoke_overrideQuotaForOrigin({origin:t})}async _onClickCheckbox(){this._quotaOverrideControlRow.classList.contains("hidden")?(this._quotaOverrideControlRow.classList.remove("hidden"),this._quotaOverrideCheckbox.checkboxElement.checked=!0,this._quotaOverrideEditor.value=this._previousOverrideFieldValue,this._quotaOverrideEditor.focus()):this._target&&this._securityOrigin&&(this._quotaOverrideControlRow.classList.add("hidden"),this._quotaOverrideCheckbox.checkboxElement.checked=!1,await this._clearQuotaForOrigin(this._target,this._securityOrigin),this._quotaOverrideErrorMessage.textContent="")}_clear(){if(!this._securityOrigin)return;const t=[];for(const e of this._settings.keys())this._settings.get(e).get()&&t.push(e);if(this._target){const e=this._includeThirdPartyCookiesSetting.get();ft.clear(this._target,this._securityOrigin,t,e)}this._clearButton.disabled=!0;const i=this._clearButton.textContent;this._clearButton.textContent=e.UIString("Clearing..."),setTimeout((()=>{this._clearButton.disabled=!1,this._clearButton.textContent=i,this._clearButton.focus()}),500)}static clear(e,t,i,s){e.storageAgent().invoke_clearDataForOrigin({origin:t,storageTypes:i.join(",")});const a=new Set(i),r=a.has(Protocol.Storage.StorageType.All);if(a.has(Protocol.Storage.StorageType.Cookies)||r){const i=e.model(Q.CookieModel);i&&i.clear(void 0,s?void 0:t)}if(a.has(Protocol.Storage.StorageType.Indexeddb)||r)for(const e of q.TargetManager.instance().targets()){const i=e.model(ct);i&&i.clearForOrigin(t)}if(a.has(Protocol.Storage.StorageType.Local_storage)||r){const i=e.model(nt);i&&i.clearForOrigin(t)}if(a.has(Protocol.Storage.StorageType.Websql)||r){const t=e.model(tt);t&&(t.disable(),t.enable())}if(a.has(Protocol.Storage.StorageType.Cache_storage)||r){const e=q.TargetManager.instance().mainTarget(),i=e&&e.model(G.ServiceWorkerCacheModel);i&&i.clearForOrigin(t)}if(a.has(Protocol.Storage.StorageType.Appcache)||r){const t=e.model(Le);t&&t.reset()}}async doUpdate(){if(!this._securityOrigin||!this._target)return this._quotaRow.textContent="",void this._populatePieChart(0,[]);const e=this._securityOrigin,t=await this._target.storageAgent().invoke_getUsageAndQuota({origin:e});if(this._quotaRow.textContent="",t.getError())return void this._populatePieChart(0,[]);const i=t.overrideActive,s=u.bytesToString(t.quota),a=u.bytesToString(t.usage),r=St(bt.storageWithCustomMarker,{PH1:s}),n=i?B.Fragment.build`<b>${r}</b>`.element():s,o=Se.getFormatLocalizedString(wt,bt.storageQuotaUsed,{PH1:a,PH2:n});if(this._quotaRow.appendChild(o),k.Tooltip.install(this._quotaRow,St(bt.storageQuotaUsedWithBytes,{PH1:t.usage.toLocaleString(),PH2:t.quota.toLocaleString()})),!t.overrideActive&&t.quota<125829120&&(k.Tooltip.install(this._quotaRow,_`Storage quota is limited in Incognito mode`),this._quotaRow.appendChild(E.Icon.create("smallicon-info"))),null===this._quotaUsage||this._quotaUsage!==t.usage){this._quotaUsage=t.usage;const e=[];for(const i of t.usageBreakdown.sort(((e,t)=>t.usage-e.usage))){const t=i.usage;if(!t)continue;const s=this._getStorageTypeName(i.storageType),a=this._pieColors.get(i.storageType)||"#ccc";e.push({value:t,color:a,title:s})}this._populatePieChart(t.usage,e)}this._usageUpdatedForTest(t.usage,t.quota,t.usageBreakdown),this.update()}_populatePieChart(e,t){this._pieChart.data={chartName:_`Storage usage`,size:110,formatter:u.bytesToString,showLegend:!0,total:e,slices:t}}_getStorageTypeName(t){switch(t){case Protocol.Storage.StorageType.File_systems:return e.UIString("File System");case Protocol.Storage.StorageType.Websql:return e.UIString("Web SQL");case Protocol.Storage.StorageType.Appcache:return e.UIString("Application Cache");case Protocol.Storage.StorageType.Indexeddb:return e.UIString("IndexedDB");case Protocol.Storage.StorageType.Cache_storage:return e.UIString("Cache Storage");case Protocol.Storage.StorageType.Service_workers:return e.UIString("Service Workers");default:return e.UIString("Other")}}_usageUpdatedForTest(e,t,i){}}const yt=[Protocol.Storage.StorageType.Appcache,Protocol.Storage.StorageType.Cache_storage,Protocol.Storage.StorageType.Cookies,Protocol.Storage.StorageType.Indexeddb,Protocol.Storage.StorageType.Local_storage,Protocol.Storage.StorageType.Service_workers,Protocol.Storage.StorageType.Websql];var Ct=Object.freeze({__proto__:null,UIStrings:bt,ClearStorageView:ft,AllStorageTypes:yt,ActionDelegate:class{handleAction(e,t){switch(t){case"resources.clear":return this._handleClear(!1);case"resources.clear-incl-third-party-cookies":return this._handleClear(!0)}return!1}_handleClear(e){const t=q.TargetManager.instance().mainTarget();if(!t)return!1;const i=t.model(j.ResourceTreeModel);if(!i)return!1;const s=i.getMainSecurityOrigin();return!!s&&(ft.clear(t,s,yt,e),!0)}}});class kt extends C.VBox{constructor(e){super(),this.database=e,this.element.classList.add("storage-view","query","monospace"),this.element.addEventListener("selectstart",this._selectStart.bind(this),!1),this._queryWrapper=this.element.createChild("div","database-query-group-messages"),this._queryWrapper.addEventListener("focusin",this._onFocusIn.bind(this)),this._queryWrapper.addEventListener("focusout",this._onFocusOut.bind(this)),this._queryWrapper.addEventListener("keydown",this._onKeyDown.bind(this)),this._queryWrapper.tabIndex=-1,this._promptContainer=this.element.createChild("div","database-query-prompt-container"),this._promptContainer.appendChild(E.Icon.create("smallicon-text-prompt","prompt-icon")),this._promptElement=this._promptContainer.createChild("div"),this._promptElement.className="database-query-prompt",this._promptElement.addEventListener("keydown",this._promptKeyDown.bind(this)),this._prompt=new V.TextPrompt,this._prompt.initialize(this.completions.bind(this)," "),this._proxyElement=this._prompt.attach(this._promptElement),this.element.addEventListener("click",this._messagesClicked.bind(this),!0),this._queryResults=[],this._virtualSelectedIndex=-1,this._lastSelectedElement,this._selectionTimeout=0}_messagesClicked(){this._prompt.focus(),this._prompt.isCaretInsidePrompt()||this.element.hasSelection()||this._prompt.moveCaretToEndOfPrompt()}_onKeyDown(e){if(!x.isEditing()&&this._queryResults.length&&!e.shiftKey){switch(e.key){case"ArrowUp":if(!(this._virtualSelectedIndex>0))return;this._virtualSelectedIndex--;break;case"ArrowDown":if(!(this._virtualSelectedIndex<this._queryResults.length-1))return;this._virtualSelectedIndex++;break;case"Home":this._virtualSelectedIndex=0;break;case"End":this._virtualSelectedIndex=this._queryResults.length-1;break;default:return}e.consume(!0),this._updateFocusedItem()}}_onFocusIn(e){-1===this._virtualSelectedIndex&&this._isOutsideViewport(e.relatedTarget)&&e.target===this._queryWrapper&&this._queryResults.length&&(this._virtualSelectedIndex=this._queryResults.length-1),this._updateFocusedItem()}_onFocusOut(e){this._isOutsideViewport(e.relatedTarget)&&(this._virtualSelectedIndex=-1),this._updateFocusedItem(),this._queryWrapper.scrollTop=1e7}_isOutsideViewport(e){return null!==e&&!e.isSelfOrDescendant(this._queryWrapper)}_updateFocusedItem(){let e=this._virtualSelectedIndex;this._queryResults.length&&this._virtualSelectedIndex<0&&(e=this._queryResults.length-1);const t=e>=0?this._queryResults[e]:null,i=this._lastSelectedElement!==t,s=this._queryWrapper===this.element.ownerDocument.deepActiveElement();t&&(i||s)&&this.element.hasFocus()&&(t.hasFocus()||t.focus()),this._queryResults.length&&!this._queryWrapper.hasFocus()?this._queryWrapper.tabIndex=0:this._queryWrapper.tabIndex=-1,this._lastSelectedElement=t}async completions(e,t,i){if(!t)return[];t=t.toLowerCase();return(await this.database.tableNames()).map((e=>e+" ")).concat(Et).filter((e=>e.toLowerCase().startsWith(t))).map((e=>({text:e})))}_selectStart(e){this._selectionTimeout&&clearTimeout(this._selectionTimeout),this._prompt.clearAutocomplete(),this._selectionTimeout=window.setTimeout(function(){this._selectionTimeout=0,this._prompt.isCaretInsidePrompt()||this.element.hasSelection()||this._prompt.moveCaretToEndOfPrompt(),this._prompt.autoCompleteSoon()}.bind(this),100)}_promptKeyDown(e){"Enter"!==e.key||this._enterKeyPressed(e)}async _enterKeyPressed(e){e.consume(!0);const t=this._prompt.textWithCurrentSuggestion();if(this._prompt.clearAutocomplete(),t.length){this._prompt.setEnabled(!1);try{const e=await new Promise(((e,i)=>{this.database.executeSql(t,((t,i)=>e({columnNames:t,values:i})),(e=>i(e)))}));this._queryFinished(t,e.columnNames,e.values)}catch(e){this._appendErrorQueryResult(t,e)}this._prompt.setEnabled(!0),this._prompt.setText(""),this._prompt.focus()}}_queryFinished(e,t,i){const s=h.SortableDataGrid.create(t,i,_`Database Query`),a=e.trim();let r=null;s&&(s.setStriped(!0),s.renderInline(),s.autoSizeColumns(5),r=s.asWidget(),s.setFocusable(!1)),this._appendViewQueryResult(a,r),(a.match(/^create /i)||a.match(/^drop table /i))&&this.dispatchEventToListeners(It.SchemaUpdated,this.database)}_appendViewQueryResult(e,t){const i=this._appendQueryResult(e);t?t.show(i):i.remove(),this._scrollResultIntoView()}_appendErrorQueryResult(e,t){const i=this._appendQueryResult(e);i.classList.add("error"),i.appendChild(E.Icon.create("smallicon-error","prompt-icon")),x.createTextChild(i,t),this._scrollResultIntoView()}_scrollResultIntoView(){this._queryResults[this._queryResults.length-1].scrollIntoView(!1),this._promptElement.scrollIntoView(!1)}_appendQueryResult(e){const t=document.createElement("div");t.className="database-user-query",t.tabIndex=-1,f.setAccessibleName(t,_`Query: ${e}`),this._queryResults.push(t),this._updateFocusedItem(),t.appendChild(E.Icon.create("smallicon-user-command","prompt-icon"));const i=document.createElement("span");i.className="database-query-text",i.textContent=e,t.appendChild(i);const s=document.createElement("div");return s.className="database-query-result",t.appendChild(s),this._queryWrapper.appendChild(t),s}}const It={SchemaUpdated:Symbol("SchemaUpdated")},Et=["SELECT ","FROM ","WHERE ","LIMIT ","DELETE FROM ","CREATE ","DROP ","TABLE ","INDEX ","UPDATE ","INSERT INTO ","VALUES ("];var Tt=Object.freeze({__proto__:null,DatabaseQueryView:kt,Events:It,SQL_BUILT_INS:Et});class Lt extends v.SimpleView{constructor(i,s){super(e.UIString("Database")),this.database=i,this.tableName=s,this._lastVisibleColumns="",this._columnsMap=new Map,this.element.classList.add("storage-view","table"),this._visibleColumnsSetting=t.Settings.instance().createSetting("databaseTableViewVisibleColumns",{}),this.refreshButton=new b.ToolbarButton(e.UIString("Refresh"),"largeicon-refresh"),this.refreshButton.addEventListener(b.ToolbarButton.Events.Click,this._refreshButtonClicked,this),this._visibleColumnsInput=new b.ToolbarInput(e.UIString("Visible columns"),"",1),this._visibleColumnsInput.addEventListener(b.ToolbarInput.Event.TextChanged,this._onVisibleColumnsChanged,this),this._dataGrid=null}wasShown(){this.update()}async toolbarItems(){return[this.refreshButton,this._visibleColumnsInput]}_escapeTableName(e){return e.replace(/\"/g,'""')}update(){this.database.executeSql('SELECT rowid, * FROM "'+this._escapeTableName(this.tableName)+'"',this._queryFinished.bind(this),this._queryError.bind(this))}_queryFinished(e,t){if(this.detachChildWidgets(),this.element.removeChildren(),this._dataGrid=h.SortableDataGrid.create(e,t,_`Database`),this._visibleColumnsInput.setVisible(Boolean(this._dataGrid)),!this._dataGrid)return this._emptyWidget=new w.EmptyWidget(_`The "${this.tableName}"\ntable is empty.`),void this._emptyWidget.show(this.element);this._dataGrid.setStriped(!0),this._dataGrid.asWidget().show(this.element),this._dataGrid.autoSizeColumns(5),this._columnsMap.clear();for(let t=1;t<e.length;++t)this._columnsMap.set(e[t],String(t));this._lastVisibleColumns="";const i=this._visibleColumnsSetting.get()[this.tableName]||"";this._visibleColumnsInput.setValue(i),this._onVisibleColumnsChanged()}_onVisibleColumnsChanged(){if(!this._dataGrid)return;const e=this._visibleColumnsInput.value(),t=e.split(/[\s,]+/),i=new Set,s=new Set;s.add("0");for(const e of t){const t=this._columnsMap.get(e);void 0!==t&&(i.add(e),s.add(t))}const a=[...i].sort().join(", ");if(0===a.length)for(const e of this._columnsMap.values())s.add(e);if(a===this._lastVisibleColumns)return;const r=this._visibleColumnsSetting.get();r[this.tableName]=e,this._visibleColumnsSetting.set(r),this._dataGrid.setColumnsVisiblity(s),this._lastVisibleColumns=a}_queryError(){this.detachChildWidgets(),this.element.removeChildren();const e=document.createElement("div");e.className="storage-table-error",e.textContent=_`An error occurred trying to\nread the "${this.tableName}" table.`,this.element.appendChild(e)}_refreshButtonClicked(e){this.update()}}var xt=Object.freeze({__proto__:null,DatabaseTableView:Lt});const Rt=e=>e?_`Yes`:_`No`;class Dt extends O.ThrottledWidget{constructor(e){super(),this._protocolMonitorExperimentEnabled=ne.experiments.isEnabled("protocolMonitor"),this.registerRequiredCSS("resources/frameDetailsReportView.css",{enableLegacyPatching:!1}),this._frame=e,this.contentElement.classList.add("frame-details-container"),this._reportView=new L.ReportView(e.displayName()),this._reportView.registerRequiredCSS("resources/frameDetailsReportView.css",{enableLegacyPatching:!1}),this._reportView.show(this.contentElement),this._reportView.element.classList.add("frame-details-report-container"),this._generalSection=this._reportView.appendSection(_`Document`),this._urlFieldValue=this._generalSection.appendField(_`URL`),this._urlStringElement=this._urlFieldValue.createChild("div","text-ellipsis"),this._unreachableURL=this._generalSection.appendField(_`Unreachable URL`);const t=this._generalSection.appendField(_`Origin`);this._originStringElement=t.createChild("div","text-ellipsis"),this._ownerFieldValue=this._generalSection.appendField(_`Owner Element`),this._adStatus=this._generalSection.appendField(_`Ad Status`),this._isolationSection=this._reportView.appendSection(_`Security & Isolation`),this._secureContext=this._isolationSection.appendField(_`Secure Context`),this._crossOriginIsolatedContext=this._isolationSection.appendField(_`Cross-Origin Isolated`),this._coepPolicy=this._isolationSection.appendField(_`Cross-Origin Embedder Policy`),this._coopPolicy=this._isolationSection.appendField(_`Cross-Origin Opener Policy`),this._apiAvailability=this._reportView.appendSection(_`API availablity`);const i=this._apiAvailability.appendRow(),s=_`Availability of certain APIs depends on the document being cross-origin isolated.`;if(i.appendChild(B.html`<div>${s} ${R.XLink.create("https://web.dev/why-coop-coep/",_`Learn more`)}</div>`),this._apiSharedArrayBuffer=this._apiAvailability.appendField(_`Shared Array Buffers`),this._apiMeasureMemory=this._apiAvailability.appendField(_`Measure Memory`),this._protocolMonitorExperimentEnabled){this._additionalInfo=this._reportView.appendSection(_`Additional Information`),this._additionalInfo.setTitle(_`Additional Information`,_`This additional (debugging) information is shown because the 'Protocol Monitor' experiment is enabled.`);this._additionalInfo.appendField(_`Frame ID`).textContent=e.id}this.update()}async doUpdate(){if(this._urlFieldValue.removeChildren(),this._urlStringElement.textContent=this._frame.url,k.Tooltip.install(this._urlStringElement,this._frame.url),this._urlFieldValue.appendChild(this._urlStringElement),!this._frame.unreachableUrl()){const e=this.uiSourceCodeForFrame(this._frame),t=Mt("mediumicon-sources-panel",_`Click to reveal in Sources panel`,(()=>d.reveal(e)));this._urlFieldValue.appendChild(t)}Dt.maybeAppendLinkToRequest(this._urlFieldValue,this._frame.resourceForURL(this._frame.url)),this._maybeAppendLinkForUnreachableUrl(),this._frame.securityOrigin&&"://"!==this._frame.securityOrigin?(this._originStringElement.textContent=this._frame.securityOrigin,k.Tooltip.install(this._originStringElement,this._frame.securityOrigin),this._generalSection.setFieldVisible(_`Origin`,!0)):this._generalSection.setFieldVisible(_`Origin`,!1),this._updateAdStatus(),this._ownerFieldValue.removeChildren();const e=await Ot(this._frame);e&&this._ownerFieldValue.appendChild(e),await this._updateCoopCoepStatus(),this._updateContextStatus(),this._updateApiAvailability()}uiSourceCodeForFrame(e){for(const t of ye.WorkspaceImpl.instance().projects()){const i=we.NetworkProject.getTargetForProject(t);if(i&&i===e.resourceTreeModel().target()){const i=t.uiSourceCodeForURL(e.url);if(i)return i}}return null}static fillCrossOriginPolicy(e,t,i){if(!i)return void(e.textContent="");const s=t(i.value);if(e.textContent=s?i.value:i.reportOnlyValue,!s&&t(i.reportOnlyValue)){const t=document.createElement("span");t.classList.add("inline-comment"),t.textContent="report-only",e.appendChild(t)}const a=s?i.reportingEndpoint:i.reportOnlyReportingEndpoint;if(a){e.createChild("span","inline-name").textContent=_`reporting to`;e.createChild("span").textContent=a}}async _updateCoopCoepStatus(){const e=this._frame.resourceTreeModel().target().model(X.NetworkManager),t=e&&await e.getSecurityIsolationStatus(this._frame.id);if(!t)return;Dt.fillCrossOriginPolicy(this._coepPolicy,(e=>e!==Protocol.Network.CrossOriginEmbedderPolicyValue.None),t.coep),this._isolationSection.setFieldVisible(_`Cross-Origin Embedder Policy`,Boolean(t.coep));Dt.fillCrossOriginPolicy(this._coopPolicy,(e=>e!==Protocol.Network.CrossOriginOpenerPolicyValue.UnsafeNone),t.coop),this._isolationSection.setFieldVisible(_`Cross-Origin Opener Policy`,Boolean(t.coop))}_explanationFromSecureContextType(e){switch(e){case Protocol.Page.SecureContextType.Secure:return null;case Protocol.Page.SecureContextType.SecureLocalhost:return _`Localhost is always a secure context`;case Protocol.Page.SecureContextType.InsecureAncestor:return _`A frame ancestor is an insecure context`;case Protocol.Page.SecureContextType.InsecureScheme:return _`The frame's scheme is insecure`}return null}_updateContextStatus(){if(this._frame.unreachableUrl())return this._isolationSection.setFieldVisible(_`Secure Context`,!1),void this._isolationSection.setFieldVisible(_`Cross-Origin Isolated`,!1);this._isolationSection.setFieldVisible(_`Secure Context`,!0),this._isolationSection.setFieldVisible(_`Cross-Origin Isolated`,!0),this._secureContext.textContent=Rt(this._frame.isSecureContext());const e=this._explanationFromSecureContextType(this._frame.getSecureContextType());if(e){this._secureContext.createChild("span","inline-comment").textContent=e}this._crossOriginIsolatedContext.textContent=Rt(this._frame.isCrossOriginIsolated())}_updateApiAvailability(){const e=this._frame.getGatedAPIFeatures();if(this._apiAvailability.setFieldVisible(_`Shared Array Buffers`,Boolean(e)),!e)return;if(e.includes(Protocol.Page.GatedAPIFeatures.SharedArrayBuffers)){const t=e.includes(Protocol.Page.GatedAPIFeatures.SharedArrayBuffersTransferAllowed);if(this._apiSharedArrayBuffer.textContent=t?_`available, transferable`:_`available, not transferable`,k.Tooltip.install(this._apiSharedArrayBuffer,t?_`SharedArrayBuffer constructor is available and SABs can be transferred via postMessage`:_`SharedArrayBuffer constructor is available but SABs cannot be transferred via postMessage`),!this._frame.isCrossOriginIsolated()){this._apiSharedArrayBuffer.createChild("span","inline-span").textContent=_`⚠️ will require cross-origin isolated context in the future`}}else if(this._apiSharedArrayBuffer.textContent=_`unavailable`,!this._frame.isCrossOriginIsolated()){this._apiSharedArrayBuffer.createChild("span","inline-comment").textContent=_`requires cross-origin isolated context`}const t=this._frame.isCrossOriginIsolated();k.Tooltip.install(this._apiMeasureMemory,t?_`The performance.measureMemory() API is available (but might require enabling experimental web platform features)`:_`The performance.measureMemory() API is not available`),this._apiMeasureMemory.textContent="";const i=t?_`available, but might require experimental web platform features`:_`unavailable`;this._apiMeasureMemory.appendChild(B.html`<div>${i} ${R.XLink.create("https://web.dev/monitor-total-page-memory-usage/",_`Learn more`)}</div>`)}static maybeAppendLinkToRequest(e,t){if(t&&t.request){const i=t.request,s=Mt("mediumicon-network-panel",_`Click to reveal in Network panel`,(()=>ue.NetworkPanel.selectAndShowRequest(i,me.Tabs.Headers)));e.appendChild(s)}}_maybeAppendLinkForUnreachableUrl(){if(!this._frame.unreachableUrl())return void this._generalSection.setFieldVisible(_`Unreachable URL`,!1);this._generalSection.setFieldVisible(_`Unreachable URL`,!0),this._unreachableURL.textContent=this._frame.unreachableUrl();const e=s.ParsedURL.fromString(this._frame.unreachableUrl());if(!e)return;const t=Mt("mediumicon-network-panel",_`Click to reveal in Network panel (might require page reload)`,(()=>{ue.NetworkPanel.revealAndFilter([{filterType:"domain",filterValue:e.domain()},{filterType:null,filterValue:e.path}])}));this._unreachableURL.appendChild(t)}_updateAdStatus(){switch(this._frame.adFrameType()){case Protocol.Page.AdFrameType.Root:this._generalSection.setFieldVisible(_`Ad Status`,!0),this._adStatus.textContent=_`root`,k.Tooltip.install(this._adStatus,_`This frame has been identified as the root frame of an ad`);break;case Protocol.Page.AdFrameType.Child:this._generalSection.setFieldVisible(_`Ad Status`,!0),this._adStatus.textContent=_`child`,k.Tooltip.install(this._adStatus,_`This frame has been identified as the a child frame of an ad`);break;default:this._generalSection.setFieldVisible(_`Ad Status`,!1)}}}function Mt(e,t,i){const s=E.Icon.create(e,"icon-link devtools-link"),a=document.createElement("span");return k.Tooltip.install(a,t),a.classList.add("devtools-link"),a.tabIndex=0,a.appendChild(s),a.addEventListener("click",(e=>{e.consume(!0),i()})),a.addEventListener("keydown",(e=>{"Enter"===e.key&&(e.consume(!0),i())})),a}async function Ot(e){let t=null;if(e instanceof j.ResourceTreeFrame?t=e:e&&(t=J.FrameManager.instance().getFrame(e)),!t)return null;const i=await t.getOwnerDOMNodeOrDocument();if(!i)return null;const s=Mt("mediumicon-elements-panel",_`Click to reveal in Elements panel`,(()=>d.reveal(i))),a=document.createElement("span");return a.textContent=`<${i.nodeName().toLocaleLowerCase()}>`,s.insertBefore(a,s.firstChild),s.addEventListener("mouseenter",(()=>{t&&t.highlight()})),s.addEventListener("mouseleave",(()=>{Y.OverlayModel.hideDOMNodeHighlight()})),s}class Ft extends O.ThrottledWidget{constructor(e,t){super(),this._targetInfo=e,this._isWindowClosed=t,this.registerRequiredCSS("resources/frameDetailsReportView.css",{enableLegacyPatching:!1}),this.contentElement.classList.add("frame-details-container"),this._reportView=new L.ReportView(this.buildTitle()),this._reportView.registerRequiredCSS("resources/frameDetailsReportView.css",{enableLegacyPatching:!1}),this._reportView.show(this.contentElement),this._reportView.element.classList.add("frame-details-report-container"),this._documentSection=this._reportView.appendSection(_`Document`),this._URLFieldValue=this._documentSection.appendField(_`URL`),this._securitySection=this._reportView.appendSection(_`Security`),this._openerElementField=this._securitySection.appendField(_`Opener Frame`),this._securitySection.setFieldVisible(_`Opener Frame`,!1),this._hasDOMAccessValue=this._securitySection.appendField(_`Access to opener`),k.Tooltip.install(this._hasDOMAccessValue,_`Shows whether the opened window is able to access its opener and vice versa`),this.update()}async doUpdate(){this._reportView.setTitle(this.buildTitle()),this._URLFieldValue.textContent=this._targetInfo.url,this._hasDOMAccessValue.textContent=Rt(this._targetInfo.canAccessOpener),this.maybeDisplayOpenerFrame()}async maybeDisplayOpenerFrame(){this._openerElementField.removeChildren();const e=await Ot(this._targetInfo.openerFrameId);if(e)return this._openerElementField.append(e),void this._securitySection.setFieldVisible(_`Opener Frame`,!0);this._securitySection.setFieldVisible(_`Opener Frame`,!1)}buildTitle(){let e=this._targetInfo.title||_`Window without title`;return this._isWindowClosed&&(e+=` (${_`closed`})`),e}setIsWindowClosed(e){this._isWindowClosed=e}setTargetInfo(e){this._targetInfo=e}}class Bt extends O.ThrottledWidget{constructor(e){super(),this._targetInfo=e,this.registerRequiredCSS("resources/frameDetailsReportView.css",{enableLegacyPatching:!1}),this.contentElement.classList.add("frame-details-container"),this._reportView=new L.ReportView(this._targetInfo.title||this._targetInfo.url||_`worker`),this._reportView.registerRequiredCSS("resources/frameDetailsReportView.css",{enableLegacyPatching:!1}),this._reportView.show(this.contentElement),this._reportView.element.classList.add("frame-details-report-container"),this._documentSection=this._reportView.appendSection(_`Document`),this._URLFieldValue=this._documentSection.appendField(_`URL`),this._URLFieldValue.textContent=this._targetInfo.url;this._documentSection.appendField(_`Type`).textContent=this.workerTypeToString(this._targetInfo.type),this._isolationSection=this._reportView.appendSection(_`Security & Isolation`),this._coepPolicy=this._isolationSection.appendField(_`Cross-Origin Embedder Policy`),this.update()}workerTypeToString(e){return"worker"===e?_`Web Worker`:"service_worker"===e?_`Service Worker`:_`Unknown`}async _updateCoopCoepStatus(){const e=q.TargetManager.instance().targetById(this._targetInfo.targetId);if(!e)return;const t=e.model(X.NetworkManager),i=t&&await t.getSecurityIsolationStatus("");if(!i)return;Dt.fillCrossOriginPolicy(this._coepPolicy,(e=>e!==Protocol.Network.CrossOriginEmbedderPolicyValue.None),i.coep)}async doUpdate(){await this._updateCoopCoepStatus()}}var Vt=Object.freeze({__proto__:null,FrameDetailsView:Dt,OpenedWindowDetailsView:Ft,WorkerDetailsView:Bt});class Pt extends C.VBox{constructor(e,t){super(),this._model=e;const i=t?t.databaseId.name:_`Loading…`;this._database,this.registerRequiredCSS("resources/indexedDBViews.css",{enableLegacyPatching:!1}),this.contentElement.classList.add("indexed-db-container"),this._reportView=new L.ReportView(i),this._reportView.show(this.contentElement),this._reportView.registerRequiredCSS("resources/indexedDBViews.css",{enableLegacyPatching:!1}),this._reportView.element.classList.add("indexed-db-header");const s=this._reportView.appendSection("");this._securityOriginElement=s.appendField(_`Security origin`),this._versionElement=s.appendField(_`Version`),this._objectStoreCountElement=s.appendField(_`Object stores`);const a=this._reportView.appendSection("").appendRow();this._clearButton=x.createTextButton(_`Delete database`,(()=>this._deleteDatabase()),_`Delete database`),a.appendChild(this._clearButton),this._refreshButton=x.createTextButton(_`Refresh database`,(()=>this._refreshDatabaseButtonClicked()),_`Refresh database`),a.appendChild(this._refreshButton),t&&this.update(t)}_refreshDatabase(){this._securityOriginElement.textContent=this._database.databaseId.securityOrigin,this._versionElement&&(this._versionElement.textContent=this._database.version.toString()),this._objectStoreCountElement.textContent=this._database.objectStores.size.toString()}_refreshDatabaseButtonClicked(){this._model.refreshDatabase(this._database.databaseId)}update(e){this._database=e,this._reportView.setTitle(this._database.databaseId.name),this._refreshDatabase(),this._updatedForTests()}_updatedForTests(){}async _deleteDatabase(){await x.ConfirmDialog.show(e.UIString('Please confirm delete of "%s" database.',this._database.databaseId.name),this.element)&&this._model.deleteDatabase(this._database.databaseId)}}class Ut extends v.SimpleView{constructor(t,i,s,a,r){super(e.UIString("IDB")),this.registerRequiredCSS("resources/indexedDBViews.css",{enableLegacyPatching:!1}),this._model=t,this._databaseId=i,this._isIndex=Boolean(a),this._refreshObjectStoreCallback=r,this.element.classList.add("indexed-db-data-view","storage-view"),this._refreshButton=new b.ToolbarButton(e.UIString("Refresh"),"largeicon-refresh"),this._refreshButton.addEventListener(b.ToolbarButton.Events.Click,this._refreshButtonClicked,this),this._deleteSelectedButton=new b.ToolbarButton(e.UIString("Delete selected"),"largeicon-delete"),this._deleteSelectedButton.addEventListener(b.ToolbarButton.Events.Click,(e=>{this._deleteButtonClicked(null)})),this._clearButton=new b.ToolbarButton(e.UIString("Clear object store"),"largeicon-clear"),this._clearButton.addEventListener(b.ToolbarButton.Events.Click,(e=>{this._clearButtonClicked(e)}),this),this._needsRefresh=new b.ToolbarItem(x.createIconLabel(e.UIString("Data may be stale"),"smallicon-warning")),this._needsRefresh.setVisible(!1),this._needsRefresh.setTitle(e.UIString("Some entries may have been modified")),this._clearingObjectStore=!1,this._createEditorToolbar(),this._pageSize=50,this._skipCount=0,this.update(s,a),this._entries=[],this._objectStore,this._index,this._keyInput,this._dataGrid,this._lastPageSize,this._lastSkipCount,this._pageBackButton,this._pageForwardButton}_createDataGrid(){const e=this._isIndex&&this._index?this._index.keyPath:this._objectStore.keyPath,t=[],i={title:void 0,titleDOMFragment:void 0,sortable:!1,sort:void 0,align:void 0,width:void 0,fixedWidth:void 0,editable:void 0,nonSelectable:void 0,longText:void 0,disclosure:void 0,weight:void 0,allowInSortByEvenWhenHidden:void 0,dataType:void 0,defaultWeight:void 0};t.push({...i,id:"number",title:_`#`,sortable:!1,width:"50px"}),t.push({...i,id:"key",titleDOMFragment:this._keyColumnHeaderFragment(_`Key`,e),sortable:!1}),this._isIndex&&t.push({...i,id:"primaryKey",titleDOMFragment:this._keyColumnHeaderFragment(_`Primary key`,this._objectStore.keyPath),sortable:!1});const s=_`Value`;t.push({...i,id:"value",title:s,sortable:!1});const a=new c.DataGridImpl({displayName:_`Indexed DB`,columns:t,deleteCallback:this._deleteButtonClicked.bind(this),refreshCallback:this._updateData.bind(this,!0),editCallback:void 0});return a.setStriped(!0),a.addEventListener(c.Events.SelectedNode,(e=>this._updateToolbarEnablement()),this),a}_keyColumnHeaderFragment(t,i){const s=document.createDocumentFragment();if(x.createTextChild(s,t),null===i)return s;if(x.createTextChild(s," ("+e.UIString("Key path: ")),Array.isArray(i)){x.createTextChild(s,"[");for(let e=0;e<i.length;++e)0!==e&&x.createTextChild(s,", "),s.appendChild(this._keyPathStringFragment(i[e]));x.createTextChild(s,"]")}else{const e=i;s.appendChild(this._keyPathStringFragment(e))}return x.createTextChild(s,")"),s}_keyPathStringFragment(e){const t=document.createDocumentFragment();x.createTextChild(t,'"');return t.createChild("span","source-code indexed-db-key-path").textContent=e,x.createTextChild(t,'"'),t}_createEditorToolbar(){const t=new b.Toolbar("data-view-toolbar",this.element);t.appendToolbarItem(this._refreshButton),t.appendToolbarItem(new b.ToolbarSeparator),this._pageBackButton=new b.ToolbarButton(e.UIString("Show previous page"),"largeicon-play-back"),this._pageBackButton.addEventListener(b.ToolbarButton.Events.Click,this._pageBackButtonClicked,this),t.appendToolbarItem(this._pageBackButton),this._pageForwardButton=new b.ToolbarButton(e.UIString("Show next page"),"largeicon-play"),this._pageForwardButton.setEnabled(!1),this._pageForwardButton.addEventListener(b.ToolbarButton.Events.Click,this._pageForwardButtonClicked,this),t.appendToolbarItem(this._pageForwardButton),this._keyInput=new b.ToolbarInput(_`Start from key`,"",.5),this._keyInput.addEventListener(b.ToolbarInput.Event.TextChanged,this._updateData.bind(this,!1)),t.appendToolbarItem(this._keyInput),t.appendToolbarItem(new b.ToolbarSeparator),t.appendToolbarItem(this._clearButton),t.appendToolbarItem(this._deleteSelectedButton),t.appendToolbarItem(this._needsRefresh)}_pageBackButtonClicked(e){this._skipCount=Math.max(0,this._skipCount-this._pageSize),this._updateData(!1)}_pageForwardButtonClicked(e){this._skipCount=this._skipCount+this._pageSize,this._updateData(!1)}_populateContextMenu(e,t){const i=t;i.valueObjectPresentation&&(e.revealSection().appendItem(_`Expand Recursively`,(()=>{i.valueObjectPresentation&&i.valueObjectPresentation.objectTreeElement().expandRecursively()})),e.revealSection().appendItem(_`Collapse`,(()=>{i.valueObjectPresentation&&i.valueObjectPresentation.objectTreeElement().collapse()})))}refreshData(){this._updateData(!0)}update(e,t){this._objectStore=e,this._index=t,this._dataGrid&&this._dataGrid.asWidget().detach(),this._dataGrid=this._createDataGrid(),this._dataGrid.setRowContextMenuCallback(this._populateContextMenu.bind(this)),this._dataGrid.asWidget().show(this.element),this._skipCount=0,this._updateData(!0)}_parseKey(e){let t;try{t=JSON.parse(e)}catch(i){t=e}return t}_updateData(e){const t=this._parseKey(this._keyInput.value()),i=this._pageSize;let s=this._skipCount,a=this._dataGrid.selectedNode?this._dataGrid.selectedNode.data.number:0;if(a=Math.max(a,this._skipCount),this._clearButton.setEnabled(!this._isIndex),!e&&this._lastKey===t&&this._lastPageSize===i&&this._lastSkipCount===s)return;function r(e,t){this.clear(),this._entries=e;let i=null;for(let t=0;t<e.length;++t){const r={};r.number=t+s,r.key=e[t].key,r.primaryKey=e[t].primaryKey,r.value=e[t].value;const n=new Nt(r);this._dataGrid.rootNode().appendChild(n),r.number<=a&&(i=n)}i&&i.select(),this._pageBackButton.setEnabled(Boolean(s)),this._pageForwardButton.setEnabled(t),this._needsRefresh.setVisible(!1),this._updateToolbarEnablement(),this._updatedDataForTests()}this._lastKey===t&&this._lastPageSize===i||(s=0,this._skipCount=0),this._lastKey=t,this._lastPageSize=i,this._lastSkipCount=s;const n=t?window.IDBKeyRange.lowerBound(t):null;this._isIndex&&this._index?this._model.loadIndexData(this._databaseId,this._objectStore.name,this._index.name,n,s,i,r.bind(this)):this._model.loadObjectStoreData(this._databaseId,this._objectStore.name,n,s,i,r.bind(this)),this._model.getMetadata(this._databaseId,this._objectStore).then(this._updateSummaryBar.bind(this))}_updateSummaryBar(e){if(this._summaryBarElement||(this._summaryBarElement=this.element.createChild("div","object-store-summary-bar")),this._summaryBarElement.removeChildren(),!e)return;const t=this._summaryBarElement.createChild("span");t.textContent=_`Total entries: ${String(e.entriesCount)}`,this._objectStore.autoIncrement&&(t.textContent+=" ❘ ",t.textContent+=_`Key generator value: ${String(e.keyGeneratorValue)}`)}_updatedDataForTests(){}_refreshButtonClicked(e){this._updateData(!0)}async _clearButtonClicked(e){this._clearButton.setEnabled(!1),this._clearingObjectStore=!0,await this._model.clearObjectStore(this._databaseId,this._objectStore.name),this._clearingObjectStore=!1,this._clearButton.setEnabled(!0),this._updateData(!0)}markNeedsRefresh(){this._clearingObjectStore||this._needsRefresh.setVisible(!0)}async _deleteButtonClicked(e){if(!e&&!(e=this._dataGrid.selectedNode))return;const t=(this._isIndex?e.data.primaryKey:e.data.key).value;await this._model.deleteEntries(this._databaseId,this._objectStore.name,window.IDBKeyRange.only(t)),this._refreshObjectStoreCallback()}clear(){this._dataGrid.rootNode().removeChildren(),this._entries=[]}_updateToolbarEnablement(){const e=!this._dataGrid||0===this._dataGrid.rootNode().children.length;this._deleteSelectedButton.setEnabled(!e&&null!==this._dataGrid.selectedNode)}}class Nt extends c.DataGridNode{constructor(e){super(e,!1),this.selectable=!0,this.valueObjectPresentation=null}createCell(e){const t=super.createCell(e),i=this.data[e];switch(e){case"value":{t.removeChildren();const e=Ce.ObjectPropertiesSection.defaultObjectPropertiesSection(i,void 0,!0,!0);t.appendChild(e.element),this.valueObjectPresentation=e;break}case"key":case"primaryKey":{t.removeChildren();const e=Ce.ObjectPropertiesSection.defaultObjectPresentation(i,void 0,!0,!0);t.appendChild(e);break}}return t}}var At=Object.freeze({__proto__:null,IDBDatabaseView:Pt,IDBDataView:Ut,IDBDataGridNode:Nt});let Wt=!1;class qt extends C.VBox{constructor(){super(!0),this.registerRequiredCSS("resources/serviceWorkersView.css",{enableLegacyPatching:!1}),this._currentWorkersView=new L.ReportView(e.UIString("Service Workers")),this._currentWorkersView.setBodyScrollable(!1),this.contentElement.classList.add("service-worker-list"),this._currentWorkersView.show(this.contentElement),this._currentWorkersView.element.classList.add("service-workers-this-origin"),this._toolbar=this._currentWorkersView.createToolbar(),this._toolbar.makeWrappable(!0),this._sections=new Map,this._manager=null,this._securityOriginManager=null,this._sectionToRegistration=new WeakMap;const i=this.contentElement.createChild("div","service-workers-other-origin"),s=new L.ReportView;s.setHeaderVisible(!1),s.show(i);const a=s.appendSection(e.UIString("Service workers from other origins")).appendRow(),r=B.html`<a class="devtools-link" role="link" tabindex="0" href="chrome://serviceworker-internals" target="_blank" style="display: inline; cursor: pointer;">See all registrations</a>`;self.onInvokeElement(r,(e=>{const t=q.TargetManager.instance().mainTarget();t&&t.targetAgent().invoke_createTarget({url:"chrome://serviceworker-internals?devtools"}),e.consume(!0)})),a.appendChild(r),this._toolbar.appendToolbarItem(ke.throttlingManager().createOfflineToolbarCheckbox());const n=t.Settings.instance().createSetting("serviceWorkerUpdateOnReload",!1);n.setTitle(e.UIString("Update on reload"));const o=new b.ToolbarSettingCheckbox(n,_`On page reload, force the service worker to update, and activate it`);this._toolbar.appendToolbarItem(o);const d=t.Settings.instance().createSetting("bypassServiceWorker",!1);d.setTitle(e.UIString("Bypass for network"));const l=new b.ToolbarSettingCheckbox(d,_`Bypass the service worker and load resources from the network`);this._toolbar.appendToolbarItem(l),this._eventListeners=new Map,q.TargetManager.instance().observeModels(K.ServiceWorkerManager,this),this._updateListVisibility();document.body.addEventListener(U.Events.DrawerChange,(e=>{const t=e.detail&&e.detail.isDrawerOpen;if(this._manager&&!t){const{serviceWorkerNetworkRequestsPanelStatus:{isOpen:e,openedAt:t}}=this._manager;if(e){const e=P.ViewManager.instance().locationNameForViewId("network");P.ViewManager.instance().showViewInLocation("network",e,!1),ue.NetworkPanel.revealAndFilter([]);Date.now()-t<2e3&&se.actionTaken(ae.Action.ServiceWorkerNetworkRequestClosedQuickly),this._manager.serviceWorkerNetworkRequestsPanelStatus={isOpen:!1,openedAt:0}}}}))}modelAdded(e){if(!this._manager){this._manager=e,this._securityOriginManager=e.target().model($.SecurityOriginManager);for(const e of this._manager.registrations().values())this._updateRegistration(e);this._eventListeners.set(e,[this._manager.addEventListener(K.Events.RegistrationUpdated,this._registrationUpdated,this),this._manager.addEventListener(K.Events.RegistrationDeleted,this._registrationDeleted,this),this._securityOriginManager.addEventListener($.Events.SecurityOriginAdded,this._updateSectionVisibility,this),this._securityOriginManager.addEventListener($.Events.SecurityOriginRemoved,this._updateSectionVisibility,this)])}}modelRemoved(e){this._manager&&this._manager===e&&(r.EventTarget.removeEventListeners(this._eventListeners.get(e)||[]),this._eventListeners.delete(e),this._manager=null,this._securityOriginManager=null)}_getTimeStamp(e){const t=e.versionsByMode();let i=0;const s=t.get(K.ServiceWorkerVersion.Modes.Active),a=t.get(K.ServiceWorkerVersion.Modes.Installing),r=t.get(K.ServiceWorkerVersion.Modes.Waiting),n=t.get(K.ServiceWorkerVersion.Modes.Redundant);return s?i=s.scriptResponseTime:r?i=r.scriptResponseTime:a?i=a.scriptResponseTime:n&&(i=n.scriptResponseTime),i||0}_updateSectionVisibility(){let e=!1;const t=[];for(const i of this._sections.values()){const s=this._getReportViewForOrigin(i._registration.securityOrigin);e=e||s===this._currentWorkersView,i._section.parentWidget()!==s&&t.push(i)}for(const e of t){const t=e._registration;this._removeRegistrationFromList(t),this._updateRegistration(t,!0)}this._currentWorkersView.sortSections(((e,t)=>{const i=this._sectionToRegistration.get(e),s=this._sectionToRegistration.get(t),a=i?this._getTimeStamp(i):0;return(s?this._getTimeStamp(s):0)-a}));for(const e of this._sections.values())e._section.parentWidget()===this._currentWorkersView||this._isRegistrationVisible(e._registration)?e._section.showWidget():e._section.hideWidget();this.contentElement.classList.toggle("service-worker-has-current",Boolean(e)),this._updateListVisibility()}_registrationUpdated(e){const t=e.data;this._updateRegistration(t),this._gcRegistrations()}_gcRegistrations(){if(!this._manager||!this._securityOriginManager)return;let e=!1;const t=new Set(this._securityOriginManager.securityOrigins());for(const i of this._manager.registrations().values())if((t.has(i.securityOrigin)||this._isRegistrationVisible(i))&&!i.canBeRemoved()){e=!0;break}if(e)for(const e of this._manager.registrations().values()){!(t.has(e.securityOrigin)||this._isRegistrationVisible(e))&&e.canBeRemoved()&&this._removeRegistrationFromList(e)}}_getReportViewForOrigin(e){return this._securityOriginManager&&(this._securityOriginManager.securityOrigins().includes(e)||this._securityOriginManager.unreachableMainSecurityOrigin()===e)?this._currentWorkersView:null}_updateRegistration(e,t){let i=this._sections.get(e);if(!i){const t=e.scopeURL,s=this._getReportViewForOrigin(e.securityOrigin);if(!s)return;const a=s.appendSection(t);a.setUiGroupTitle(_`Service worker for ${t}`),this._sectionToRegistration.set(a,e),i=new jt(this._manager,a,e),this._sections.set(e,i)}t||(this._updateSectionVisibility(),i._scheduleUpdate())}_registrationDeleted(e){const t=e.data;this._removeRegistrationFromList(t)}_removeRegistrationFromList(e){const t=this._sections.get(e);t&&t._section.detach(),this._sections.delete(e),this._updateSectionVisibility()}_isRegistrationVisible(e){return!e.scopeURL}_updateListVisibility(){this.contentElement.classList.toggle("service-worker-list-empty",0===this._sections.size)}}class jt{constructor(s,a,r){this._manager=s,this._section=a,this._registration=r,this._fingerprint=null,this._pushNotificationDataSetting=t.Settings.instance().createLocalSetting("pushData",e.UIString("Test push message from DevTools.")),this._syncTagNameSetting=t.Settings.instance().createLocalSetting("syncTagName","test-tag-from-devtools"),this._periodicSyncTagNameSetting=t.Settings.instance().createLocalSetting("periodicSyncTagName","test-tag-from-devtools"),this._toolbar=a.createToolbar(),this._toolbar.renderAsLinks(),this._networkRequests=new b.ToolbarButton(e.UIString("Network requests"),void 0,e.UIString("Network requests")),this._networkRequests.addEventListener(b.ToolbarButton.Events.Click,this._networkRequestsClicked,this),this._toolbar.appendToolbarItem(this._networkRequests),this._updateButton=new b.ToolbarButton(e.UIString("Update"),void 0,e.UIString("Update")),this._updateButton.addEventListener(b.ToolbarButton.Events.Click,this._updateButtonClicked,this),this._toolbar.appendToolbarItem(this._updateButton),this._deleteButton=new b.ToolbarButton(e.UIString("Unregister service worker"),void 0,e.UIString("Unregister")),this._deleteButton.addEventListener(b.ToolbarButton.Events.Click,this._unregisterButtonClicked,this),this._toolbar.appendToolbarItem(this._deleteButton),this._sourceField=this._wrapWidget(this._section.appendField(e.UIString("Source"))),this._statusField=this._wrapWidget(this._section.appendField(e.UIString("Status"))),this._clientsField=this._wrapWidget(this._section.appendField(e.UIString("Clients"))),this._createSyncNotificationField(e.UIString("Push"),this._pushNotificationDataSetting.get(),e.UIString("Push data"),this._push.bind(this)),this._createSyncNotificationField(e.UIString("Sync"),this._syncTagNameSetting.get(),e.UIString("Sync tag"),this._sync.bind(this)),this._createSyncNotificationField(_`Periodic Sync`,this._periodicSyncTagNameSetting.get(),_`Periodic Sync tag`,(e=>this._periodicSync(e))),this._linkifier=new ge.Linkifier,this._clientInfoCache=new Map,this._throttler=new i.Throttler(500)}_createSyncNotificationField(e,t,i,s){const a=this._wrapWidget(this._section.appendField(e)).createChild("form","service-worker-editor-with-button"),r=x.createInput("source-code service-worker-notification-editor");a.appendChild(r);const n=x.createTextButton(e);n.type="submit",a.appendChild(n),r.value=t,r.placeholder=i,f.setAccessibleName(r,e),a.addEventListener("submit",(e=>{s(r.value||""),e.consume(!0)}))}_scheduleUpdate(){Wt?this._update():this._throttler.schedule(this._update.bind(this))}_targetForVersionId(e){const t=this._manager.findVersion(e);return t&&t.targetId?q.TargetManager.instance().targetById(t.targetId):null}_addVersion(e,t,i){const s=e.createChild("div","service-worker-version");s.createChild("div",t);const a=s.createChild("span","service-worker-version-string");return a.textContent=i,f.markAsAlert(a),s}_updateClientsField(t){this._clientsField.removeChildren(),this._section.setFieldVisible(e.UIString("Clients"),Boolean(t.controlledClients.length));for(const e of t.controlledClients){const t=this._clientsField.createChild("div","service-worker-client");this._clientInfoCache.has(e)&&this._updateClientInfo(t,this._clientInfoCache.get(e)),this._manager.target().targetAgent().invoke_getTargetInfo({targetId:e}).then(this._onClientInfo.bind(this,t))}}_updateSourceField(t){this._sourceField.removeChildren();const i=s.ParsedURL.extractName(t.scriptURL),a=this._sourceField.createChild("div","report-field-value-filename"),r=ge.Linkifier.linkifyURL(t.scriptURL,{text:i});if(r.tabIndex=0,a.appendChild(r),this._registration.errors.length){const e=x.createIconLabel(String(this._registration.errors.length),"smallicon-error");e.classList.add("devtools-link","link"),e.tabIndex=0,f.setAccessibleName(e,_`${this._registration.errors.length} registration errors`),self.onInvokeElement(e,(()=>l.Console.instance().show())),a.appendChild(e)}void 0!==t.scriptResponseTime&&(this._sourceField.createChild("div","report-field-value-subtitle").textContent=e.UIString("Received %s",new Date(1e3*t.scriptResponseTime).toLocaleString()))}_update(){const t=this._registration.fingerprint();if(t===this._fingerprint)return Promise.resolve();this._fingerprint=t,this._toolbar.setEnabled(!this._registration.isDeleted);const i=this._registration.versionsByMode(),s=this._registration.scopeURL,a=this._registration.isDeleted?e.UIString("%s - deleted",s):s;this._section.setTitle(a);const r=i.get(K.ServiceWorkerVersion.Modes.Active),n=i.get(K.ServiceWorkerVersion.Modes.Waiting),o=i.get(K.ServiceWorkerVersion.Modes.Installing),d=i.get(K.ServiceWorkerVersion.Modes.Redundant);this._statusField.removeChildren();const l=this._statusField.createChild("div","service-worker-version-stack");if(l.createChild("div","service-worker-version-stack-bar"),r){this._updateSourceField(r);const t=K.ServiceWorkerVersion.RunningStatus[r.runningStatus],i=this._addVersion(l,"service-worker-active-circle",_`#${r.id} activated and is ${t}`);r.isRunning()||r.isStarting()?(this._createLink(i,e.UIString("stop"),this._stopButtonClicked.bind(this,r.id)),this._targetForVersionId(r.id)||this._createLink(i,e.UIString("inspect"),this._inspectButtonClicked.bind(this,r.id))):r.isStartable()&&this._createLink(i,e.UIString("start"),this._startButtonClicked.bind(this)),this._updateClientsField(r)}else d&&(this._updateSourceField(d),this._addVersion(l,"service-worker-redundant-circle",e.UIString("#%s is redundant",d.id)),this._updateClientsField(d));if(n){const t=this._addVersion(l,"service-worker-waiting-circle",e.UIString("#%s waiting to activate",n.id));this._createLink(t,e.UIString("skipWaiting"),this._skipButtonClicked.bind(this)),void 0!==n.scriptResponseTime&&(t.createChild("div","service-worker-subtitle").textContent=e.UIString("Received %s",new Date(1e3*n.scriptResponseTime).toLocaleString())),this._targetForVersionId(n.id)||!n.isRunning()&&!n.isStarting()||this._createLink(t,e.UIString("inspect"),this._inspectButtonClicked.bind(this,n.id))}if(o){const t=this._addVersion(l,"service-worker-installing-circle",e.UIString("#%s trying to install",o.id));void 0!==o.scriptResponseTime&&(t.createChild("div","service-worker-subtitle").textContent=e.UIString("Received %s",new Date(1e3*o.scriptResponseTime).toLocaleString())),this._targetForVersionId(o.id)||!o.isRunning()&&!o.isStarting()||this._createLink(t,e.UIString("inspect"),this._inspectButtonClicked.bind(this,o.id))}return Promise.resolve()}_createLink(e,t,i,s,a){const r=document.createElement("button");return s&&(r.className=s),r.classList.add("link","devtools-link"),r.textContent=t,r.tabIndex=0,r.addEventListener("click",i,a),e.appendChild(r),r}_unregisterButtonClicked(e){this._manager.deleteRegistration(this._registration.id)}_updateButtonClicked(e){this._manager.updateRegistration(this._registration.id)}_networkRequestsClicked(e){const t="drawer-view"===P.ViewManager.instance().locationNameForViewId("resources")?"panel":"drawer-view";P.ViewManager.instance().showViewInLocation("network",t),ue.NetworkPanel.revealAndFilter([{filterType:pe.FilterType.Is,filterValue:pe.IsFilterType.ServiceWorkerIntercepted}]);const i=Z.NetworkLog.instance().requests();let s=null;if(Array.isArray(i))for(const e of i)!s&&e.fetchedViaServiceWorker&&(s=e),e.fetchedViaServiceWorker&&s&&s.responseReceivedTime<e.responseReceivedTime&&(s=e);s&&ue.NetworkPanel.selectAndShowRequest(s,me.Tabs.Timing,{clearFilter:!1}),this._manager.serviceWorkerNetworkRequestsPanelStatus={isOpen:!0,openedAt:Date.now()},se.actionTaken(ae.Action.ServiceWorkerNetworkRequestClicked)}_push(e){this._pushNotificationDataSetting.set(e),this._manager.deliverPushMessage(this._registration.id,e)}_sync(e){this._syncTagNameSetting.set(e),this._manager.dispatchSyncEvent(this._registration.id,e,!0)}_periodicSync(e){this._periodicSyncTagNameSetting.set(e),this._manager.dispatchPeriodicSyncEvent(this._registration.id,e)}_onClientInfo(e,t){const i=t.targetInfo;i&&(this._clientInfoCache.set(i.targetId,i),this._updateClientInfo(e,i))}_updateClientInfo(e,t){if("page"!==t.type&&"iframe"===t.type){const i=e.createChild("span","service-worker-client-string");return void x.createTextChild(i,_`Worker: ${t.url}`)}e.removeChildren();const i=e.createChild("span","service-worker-client-string");x.createTextChild(i,t.url),this._createLink(e,_`focus`,this._activateTarget.bind(this,t.targetId),"service-worker-client-focus-link")}_activateTarget(e){this._manager.target().targetAgent().invoke_activateTarget({targetId:e})}_startButtonClicked(){this._manager.startWorker(this._registration.scopeURL)}_skipButtonClicked(){this._manager.skipWaiting(this._registration.scopeURL)}_stopButtonClicked(e){this._manager.stopWorker(e)}_inspectButtonClicked(e){this._manager.inspectWorker(e)}_wrapWidget(e){const t=N.createShadowRootWithCoreStyles(e,{cssFile:void 0,enableLegacyPatching:!0,delegatesFocus:void 0});N.appendStyle(t,"resources/serviceWorkersView.css",{enableLegacyPatching:!1});const i=document.createElement("div");return t.appendChild(i),i}}var Gt=Object.freeze({__proto__:null,setThrottleDisabledForDebugging:e=>{Wt=e},ServiceWorkersView:qt,Section:jt});class zt extends C.VBox{constructor(t){super(),this._panel=t,this._applicationCacheViews=new Map,this._applicationCacheFrameElements=new Map,this._applicationCacheManifestElements=new Map,this._sidebarTree=new S.TreeOutlineInShadow,this._sidebarTree.element.classList.add("resources-sidebar"),this._sidebarTree.registerRequiredCSS("resources/resourcesSidebar.css",{enableLegacyPatching:!0}),this._sidebarTree.element.classList.add("filter-all"),this._sidebarTree.addEventListener(S.Events.ElementAttached,this._treeElementAdded,this),this.contentElement.appendChild(this._sidebarTree.element);const i=_`Application`;this._applicationTreeElement=this._addSidebarSection(i);const s=new Xt(t);this._applicationTreeElement.appendChild(s),this.serviceWorkersTreeElement=new Qt(t),this._applicationTreeElement.appendChild(this.serviceWorkersTreeElement);const a=new Jt(t);this._applicationTreeElement.appendChild(a);const r=_`Storage`,n=this._addSidebarSection(r);this.localStorageListTreeElement=new Ve(t,e.UIString("Local Storage"),"LocalStorage"),this.localStorageListTreeElement.setLink("https://developers.google.com/web/tools/chrome-devtools/storage/localstorage?utm_source=devtools");const o=E.Icon.create("mediumicon-table","resource-tree-item");this.localStorageListTreeElement.setLeadingIcons([o]),n.appendChild(this.localStorageListTreeElement),this.sessionStorageListTreeElement=new Ve(t,e.UIString("Session Storage"),"SessionStorage"),this.sessionStorageListTreeElement.setLink("https://developers.google.com/web/tools/chrome-devtools/storage/sessionstorage?utm_source=devtools");const d=E.Icon.create("mediumicon-table","resource-tree-item");this.sessionStorageListTreeElement.setLeadingIcons([d]),n.appendChild(this.sessionStorageListTreeElement),this.indexedDBListTreeElement=new Yt(t),this.indexedDBListTreeElement.setLink("https://developers.google.com/web/tools/chrome-devtools/storage/indexeddb?utm_source=devtools"),n.appendChild(this.indexedDBListTreeElement),this.databasesListTreeElement=new Ve(t,e.UIString("Web SQL"),"Databases"),this.databasesListTreeElement.setLink("https://developers.google.com/web/tools/chrome-devtools/storage/websql?utm_source=devtools");const l=E.Icon.create("mediumicon-database","resource-tree-item");this.databasesListTreeElement.setLeadingIcons([l]),n.appendChild(this.databasesListTreeElement),this.cookieListTreeElement=new Ve(t,e.UIString("Cookies"),"Cookies"),this.cookieListTreeElement.setLink("https://developers.google.com/web/tools/chrome-devtools/storage/cookies?utm_source=devtools");const c=E.Icon.create("mediumicon-cookie","resource-tree-item");this.cookieListTreeElement.setLeadingIcons([c]),n.appendChild(this.cookieListTreeElement);const h=_`Cache`,u=this._addSidebarSection(h);this.cacheStorageListTreeElement=new je(t),u.appendChild(this.cacheStorageListTreeElement),this.applicationCacheListTreeElement=new Ve(t,e.UIString("Application Cache"),"ApplicationCache"),this.applicationCacheListTreeElement.setLink("https://developers.google.com/web/tools/chrome-devtools/storage/applicationcache?utm_source=devtools");const m=E.Icon.create("mediumicon-table","resource-tree-item");if(this.applicationCacheListTreeElement.setLeadingIcons([m]),u.appendChild(this.applicationCacheListTreeElement),ne.experiments.isEnabled("backgroundServices")){const e=_`Background Services`,i=this._addSidebarSection(e);this.backgroundFetchTreeElement=new Kt(t,Protocol.BackgroundService.ServiceName.BackgroundFetch),i.appendChild(this.backgroundFetchTreeElement),this.backgroundSyncTreeElement=new Kt(t,Protocol.BackgroundService.ServiceName.BackgroundSync),i.appendChild(this.backgroundSyncTreeElement),ne.experiments.isEnabled("backgroundServicesNotifications")&&(this.notificationsTreeElement=new Kt(t,Protocol.BackgroundService.ServiceName.Notifications),i.appendChild(this.notificationsTreeElement)),ne.experiments.isEnabled("backgroundServicesPaymentHandler")&&(this.paymentHandlerTreeElement=new Kt(t,Protocol.BackgroundService.ServiceName.PaymentHandler),i.appendChild(this.paymentHandlerTreeElement)),this.periodicBackgroundSyncTreeElement=new Kt(t,Protocol.BackgroundService.ServiceName.PeriodicBackgroundSync),i.appendChild(this.periodicBackgroundSyncTreeElement),ne.experiments.isEnabled("backgroundServicesPushMessaging")&&(this.pushMessagingTreeElement=new Kt(t,Protocol.BackgroundService.ServiceName.PushMessaging),i.appendChild(this.pushMessagingTreeElement))}const p=_`Frames`,g=this._addSidebarSection(p);this._resourcesSection=new ri(t,g),this._databaseTableViews=new Map,this._databaseQueryViews=new Map,this._databaseTreeElements=new Map,this._domStorageTreeElements=new Map,this._domains={},this._sidebarTree.contentElement.addEventListener("mousemove",this._onmousemove.bind(this),!1),this._sidebarTree.contentElement.addEventListener("mouseleave",this._onmouseleave.bind(this),!1),q.TargetManager.instance().observeTargets(this),q.TargetManager.instance().addModelListener(j.ResourceTreeModel,j.Events.FrameNavigated,this._frameNavigated,this);this._panel.lastSelectedItemPath().length||s.select()}_addSidebarSection(e){const t=new S.TreeElement(e,!0);return t.listItemElement.classList.add("storage-group-list-item"),t.setCollapsible(!1),t.selectable=!1,this._sidebarTree.appendChild(t),f.setAccessibleName(t.childrenListElement,e),t}targetAdded(e){if(this._target)return;this._target=e,this._databaseModel=e.model(tt),this._databaseModel&&(this._databaseModel.addEventListener(it.DatabaseAdded,this._databaseAdded,this),this._databaseModel.addEventListener(it.DatabasesRemoved,this._resetWebSQL,this));const t=e.model(j.ResourceTreeModel);t&&(t.cachedResourcesLoaded()&&this._initialize(),t.addEventListener(j.Events.CachedResourcesLoaded,this._initialize,this),t.addEventListener(j.Events.WillLoadCachedResources,this._resetWithFrames,this))}targetRemoved(e){if(e!==this._target)return;delete this._target;const t=e.model(j.ResourceTreeModel);t&&(t.removeEventListener(j.Events.CachedResourcesLoaded,this._initialize,this),t.removeEventListener(j.Events.WillLoadCachedResources,this._resetWithFrames,this)),this._databaseModel&&(this._databaseModel.removeEventListener(it.DatabaseAdded,this._databaseAdded,this),this._databaseModel.removeEventListener(it.DatabasesRemoved,this._resetWebSQL,this),this._databaseModel=null),this._resetWithFrames()}focus(){this._sidebarTree.focus()}_initialize(){for(const e of j.ResourceTreeModel.frames())this._addCookieDocument(e);this._databaseModel&&this._databaseModel.enable();const e=this._target&&this._target.model(G.ServiceWorkerCacheModel);e&&e.enable();const t=this._target&&this._target.model(j.ResourceTreeModel);t&&this._populateApplicationCacheTree(t),q.TargetManager.instance().observeModels(nt,{modelAdded:e=>this._domStorageModelAdded(e),modelRemoved:e=>this._domStorageModelRemoved(e)}),this.indexedDBListTreeElement._initialize(),q.TargetManager.instance().observeModels(ct,{modelAdded:e=>e.enable(),modelRemoved:e=>this.indexedDBListTreeElement.removeIndexedDBForModel(e)});const i=this._target&&this._target.model(G.ServiceWorkerCacheModel)||null;this.cacheStorageListTreeElement.initialize(i);const s=this._target&&this._target.model(He)||null;ne.experiments.isEnabled("backgroundServices")&&(this.backgroundFetchTreeElement&&this.backgroundFetchTreeElement._initialize(s),this.backgroundSyncTreeElement&&this.backgroundSyncTreeElement._initialize(s),ne.experiments.isEnabled("backgroundServicesNotifications")&&this.notificationsTreeElement&&this.notificationsTreeElement._initialize(s),ne.experiments.isEnabled("backgroundServicesPaymentHandler")&&this.paymentHandlerTreeElement&&this.paymentHandlerTreeElement._initialize(s),this.periodicBackgroundSyncTreeElement&&this.periodicBackgroundSyncTreeElement._initialize(s),ne.experiments.isEnabled("backgroundServicesPushMessaging")&&this.pushMessagingTreeElement&&this.pushMessagingTreeElement._initialize(s))}_domStorageModelAdded(e){e.enable(),e.storages().forEach(this._addDOMStorage.bind(this)),e.addEventListener(ot.DOMStorageAdded,this._domStorageAdded,this),e.addEventListener(ot.DOMStorageRemoved,this._domStorageRemoved,this)}_domStorageModelRemoved(e){e.storages().forEach(this._removeDOMStorage.bind(this)),e.removeEventListener(ot.DOMStorageAdded,this._domStorageAdded,this),e.removeEventListener(ot.DOMStorageRemoved,this._domStorageRemoved,this)}_resetWithFrames(){this._resourcesSection.reset(),this._reset()}_resetWebSQL(){for(const e of this._databaseQueryViews.values())e.removeEventListener(It.SchemaUpdated,(e=>{this._updateDatabaseTables(e)}),this);this._databaseTableViews.clear(),this._databaseQueryViews.clear(),this._databaseTreeElements.clear(),this.databasesListTreeElement.removeChildren(),this.databasesListTreeElement.setExpandable(!1)}_resetAppCache(){for(const e of this._applicationCacheFrameElements.keys())this._applicationCacheFrameManifestRemoved({data:e});this.applicationCacheListTreeElement.setExpandable(!1)}_treeElementAdded(e){const t=this._panel.lastSelectedItemPath();if(!t.length)return;const i=e.data,s=[i];for(let e=i.parent;e&&e.itemURL;e=e.parent)s.push(e);let a=t.length-1,r=s.length-1;for(;a>=0&&r>=0&&t[a]===s[r].itemURL;)s[r].expanded||(a>0&&s[r].expand(),s[r].selected||s[r].select()),a--,r--}_reset(){this._domains={},this._resetWebSQL(),this.cookieListTreeElement.removeChildren()}_frameNavigated(e){const t=e.data;t.isTopFrame()&&this._reset();const i=this._applicationCacheFrameElements.get(t.id);i&&i.frameNavigated(t),this._addCookieDocument(t)}_databaseAdded(e){const t=e.data,i=new $t(this,t);this._databaseTreeElements.set(t,i),this.databasesListTreeElement.appendChild(i)}_addCookieDocument(e){const t=e.unreachableUrl()||e.url,i=s.ParsedURL.fromString(t);if(!i||"http"!==i.scheme&&"https"!==i.scheme&&"file"!==i.scheme)return;const a=i.securityOrigin();if(!this._domains[a]){this._domains[a]=!0;const t=new si(this._panel,e,a);this.cookieListTreeElement.appendChild(t)}}_domStorageAdded(e){const t=e.data;this._addDOMStorage(t)}_addDOMStorage(e){console.assert(!this._domStorageTreeElements.get(e));const t=new ii(this._panel,e);this._domStorageTreeElements.set(e,t),e.isLocalStorage?this.localStorageListTreeElement.appendChild(t):this.sessionStorageListTreeElement.appendChild(t)}_domStorageRemoved(e){const t=e.data;this._removeDOMStorage(t)}_removeDOMStorage(e){const t=this._domStorageTreeElements.get(e);if(!t)return;const i=t.selected,s=t.parent;s&&(s.removeChild(t),i&&s.select()),this._domStorageTreeElements.delete(e)}selectDatabase(e){if(e){this._showDatabase(e);const t=this._databaseTreeElements.get(e);t&&t.select()}}async showResource(e,t,i){await this._resourcesSection.revealResource(e,t,i)}_showDatabase(e,t){if(!e)return;let i;if(t){let s=this._databaseTableViews.get(e);s||(s={},this._databaseTableViews.set(e,s)),i=s[t],i||(i=new Lt(e,t),s[t]=i)}else i=this._databaseQueryViews.get(e),i||(i=new kt(e),this._databaseQueryViews.set(e,i),i.addEventListener(It.SchemaUpdated,(e=>{this._updateDatabaseTables(e)}),this));this._innerShowView(i)}_showApplicationCache(e){if(!this._applicationCacheModel)return;let t=this._applicationCacheViews.get(e);t||(t=new Oe(this._applicationCacheModel,e),this._applicationCacheViews.set(e,t)),this._innerShowView(t)}showFileSystem(e){this._innerShowView(e)}_innerShowView(e){this._panel.showView(e)}async _updateDatabaseTables(e){const t=e.data;if(!t)return;const i=this._databaseTreeElements.get(t);if(!i)return;i.invalidateChildren();const s=this._databaseTableViews.get(t);if(!s)return;const a=new Set,r=this._panel,n=await t.tableNames();for(const e of n)a.add(e);for(const e in s)a.has(e)||(r.visibleView===s[e]&&r.showView(null),delete s[e]);await i.updateChildren()}_populateApplicationCacheTree(e){this._target&&(this._applicationCacheModel=this._target.model(Le),this._applicationCacheModel&&(this._applicationCacheModel.addEventListener(xe.FrameManifestAdded,this._applicationCacheFrameManifestAdded,this),this._applicationCacheModel.addEventListener(xe.FrameManifestRemoved,this._applicationCacheFrameManifestRemoved,this),this._applicationCacheModel.addEventListener(xe.FrameManifestsReset,this._resetAppCache,this),this._applicationCacheModel.addEventListener(xe.FrameManifestStatusUpdated,this._applicationCacheFrameManifestStatusChanged,this),this._applicationCacheModel.addEventListener(xe.NetworkStateChanged,this._applicationCacheNetworkStateChanged,this)))}_applicationCacheFrameManifestAdded(e){const t=e.data;if(!this._applicationCacheModel||!this._target||"string"!==t)return;const i=this._applicationCacheModel.frameManifestURL(t);let s=this._applicationCacheManifestElements.get(i);s||(s=new qe(this._panel,i),this.applicationCacheListTreeElement.appendChild(s),this._applicationCacheManifestElements.set(i,s));const a=this._target.model(j.ResourceTreeModel),r=a&&a.frameForId(t);if(a&&r){const e=new ze(this,r,i);s.appendChild(e),s.expand(),this._applicationCacheFrameElements.set(t,e)}}_applicationCacheFrameManifestRemoved(e){const t=e.data,i=this._applicationCacheFrameElements.get(t);if(!i)return;const s=i.manifestURL;this._applicationCacheFrameElements.delete(t),this._applicationCacheViews.delete(t),i.parent&&i.parent.removeChild(i);const a=this._applicationCacheManifestElements.get(s);a&&!a.childCount()&&(this._applicationCacheManifestElements.delete(s),a.parent&&a.parent.removeChild(a))}_applicationCacheFrameManifestStatusChanged(e){if(!this._applicationCacheModel)return;const t=e.data,i=this._applicationCacheModel.frameManifestStatus(t),s=this._applicationCacheViews.get(t);s&&s.updateStatus(i)}_applicationCacheNetworkStateChanged(e){const t=e.data;for(const e of this._applicationCacheViews.values())e.updateNetworkState(t)}_onmousemove(e){const t=e.target;if(!t)return;const i=x.enclosingNodeOrSelfWithNodeName(t,"li");if(!i)return;const s=S.TreeElement.getTreeElementBylistItemNode(i);this._previousHoveredElement!==s&&(this._previousHoveredElement&&(this._previousHoveredElement.hovered=!1,delete this._previousHoveredElement),s instanceof ni&&(this._previousHoveredElement=s,s.hovered=!0))}_onmouseleave(e){this._previousHoveredElement&&(this._previousHoveredElement.hovered=!1,delete this._previousHoveredElement)}}class Kt extends Be{constructor(e,t){super(e,Je.getUIString(t),!1),this._serviceName=t,this._selected=!1,this._view=null,this._model=null;const i=E.Icon.create(this._getIconType(),"resource-tree-item");this.setLeadingIcons([i])}_getIconType(){switch(this._serviceName){case Protocol.BackgroundService.ServiceName.BackgroundFetch:return"mediumicon-fetch";case Protocol.BackgroundService.ServiceName.BackgroundSync:return"mediumicon-sync";case Protocol.BackgroundService.ServiceName.PushMessaging:return"mediumicon-cloud";case Protocol.BackgroundService.ServiceName.Notifications:return"mediumicon-bell";case Protocol.BackgroundService.ServiceName.PaymentHandler:return"mediumicon-payment";case Protocol.BackgroundService.ServiceName.PeriodicBackgroundSync:return"mediumicon-schedule";default:return console.error(`Service ${this._serviceName} does not have a dedicated icon`),"mediumicon-table"}}_initialize(e){this._model=e,this._selected&&!this._view&&this.onselect(!1)}get itemURL(){return"background-service://"+this._serviceName}onselect(e){return super.onselect(e),this._selected=!0,!!this._model&&(this._view||(this._view=new Je(this._serviceName,this._model)),this.showView(this._view),A.Context.instance().setFlavor(Je,this._view),!1)}}class $t extends Be{constructor(e,t){super(e._panel,t.name,!0),this._sidebar=e,this._database=t;const i=E.Icon.create("mediumicon-database","resource-tree-item");this.setLeadingIcons([i])}get itemURL(){return"database://"+encodeURI(this._database.name)}onselect(e){return super.onselect(e),this._sidebar._showDatabase(this._database),!1}onexpand(){this.updateChildren()}async updateChildren(){this.removeChildren();const e=await this._database.tableNames();for(const t of e)this.appendChild(new Ht(this._sidebar,this._database,t))}}class Ht extends Be{constructor(e,t,i){super(e._panel,i,!1),this._sidebar=e,this._database=t,this._tableName=i;const s=E.Icon.create("mediumicon-table","resource-tree-item");this.setLeadingIcons([s])}get itemURL(){return"database://"+encodeURI(this._database.name)+"/"+encodeURI(this._tableName)}onselect(e){return super.onselect(e),this._sidebar._showDatabase(this._database,this._tableName),!1}}class Qt extends Be{constructor(t){super(t,e.UIString("Service Workers"),!1);const i=E.Icon.create("mediumicon-service-worker","resource-tree-item");this.setLeadingIcons([i])}get itemURL(){return"service-workers://"}onselect(e){return super.onselect(e),this._view||(this._view=new qt),this.showView(this._view),!1}}class Xt extends Be{constructor(t){super(t,e.UIString("Manifest"),!1);const i=E.Icon.create("mediumicon-manifest","resource-tree-item");this.setLeadingIcons([i])}get itemURL(){return"manifest://"}onselect(e){return super.onselect(e),this._view||(this._view=new Ke),this.showView(this._view),!1}}class Jt extends Be{constructor(t){super(t,e.UIString("Storage"),!1);const i=E.Icon.create("mediumicon-database","resource-tree-item");this.setLeadingIcons([i])}get itemURL(){return"clear-storage://"}onselect(e){return super.onselect(e),this._view||(this._view=new ft),this.showView(this._view),!1}}class Yt extends Ve{constructor(t){super(t,e.UIString("IndexedDB"),"IndexedDB");const i=E.Icon.create("mediumicon-database","resource-tree-item");this.setLeadingIcons([i]),this._idbDatabaseTreeElements=[]}_initialize(){q.TargetManager.instance().addModelListener(ct,ht.DatabaseAdded,this._indexedDBAdded,this),q.TargetManager.instance().addModelListener(ct,ht.DatabaseRemoved,this._indexedDBRemoved,this),q.TargetManager.instance().addModelListener(ct,ht.DatabaseLoaded,this._indexedDBLoaded,this),q.TargetManager.instance().addModelListener(ct,ht.IndexedDBContentUpdated,this._indexedDBContentUpdated,this),this._idbDatabaseTreeElements=[];for(const e of q.TargetManager.instance().models(ct)){const t=e.databases();for(let i=0;i<t.length;++i)this._addIndexedDB(e,t[i])}}removeIndexedDBForModel(e){const t=this._idbDatabaseTreeElements.filter((t=>t._model===e));for(const e of t)this._removeIDBDatabaseTreeElement(e)}onattach(){super.onattach(),this.listItemElement.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!0)}_handleContextMenuEvent(t){const i=new T.ContextMenu(t);i.defaultSection().appendItem(e.UIString("Refresh IndexedDB"),this.refreshIndexedDB.bind(this)),i.show()}refreshIndexedDB(){for(const e of q.TargetManager.instance().models(ct))e.refreshDatabaseNames()}_indexedDBAdded(e){const t=e.data.databaseId,i=e.data.model;this._addIndexedDB(i,t)}_addIndexedDB(e,t){const i=new Zt(this.resourcesPanel,e,t);this._idbDatabaseTreeElements.push(i),this.appendChild(i),e.refreshDatabase(t)}_indexedDBRemoved(e){const t=e.data.databaseId,i=e.data.model,s=this._idbDatabaseTreeElement(i,t);s&&this._removeIDBDatabaseTreeElement(s)}_removeIDBDatabaseTreeElement(e){e.clear(),this.removeChild(e),g.removeElement(this._idbDatabaseTreeElements,e),this.setExpandable(this.childCount()>0)}_indexedDBLoaded(e){const t=e.data.database,i=e.data.model,s=e.data.entriesUpdated,a=this._idbDatabaseTreeElement(i,t.databaseId);a&&(a.update(t,s),this._indexedDBLoadedForTest())}_indexedDBLoadedForTest(){}_indexedDBContentUpdated(e){const t=e.data.databaseId,i=e.data.objectStoreName,s=e.data.model,a=this._idbDatabaseTreeElement(s,t);a&&a.indexedDBContentUpdated(i)}_idbDatabaseTreeElement(e,t){return this._idbDatabaseTreeElements.find((i=>i._databaseId.equals(t)&&i._model===e))||null}}class Zt extends Be{constructor(e,t,i){super(e,i.name+" - "+i.securityOrigin,!1),this._model=t,this._databaseId=i,this._idbObjectStoreTreeElements=new Map;const s=E.Icon.create("mediumicon-database","resource-tree-item");this.setLeadingIcons([s]),this._model.addEventListener(ht.DatabaseNamesRefreshed,this._refreshIndexedDB,this)}get itemURL(){return"indexedDB://"+this._databaseId.securityOrigin+"/"+this._databaseId.name}onattach(){super.onattach(),this.listItemElement.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!0)}_handleContextMenuEvent(t){const i=new T.ContextMenu(t);i.defaultSection().appendItem(e.UIString("Refresh IndexedDB"),this._refreshIndexedDB.bind(this)),i.show()}_refreshIndexedDB(){this._model.refreshDatabase(this._databaseId)}indexedDBContentUpdated(e){const t=this._idbObjectStoreTreeElements.get(e);t&&t.markNeedsRefresh()}update(e,t){this._database=e;const i=new Set;for(const e of[...this._database.objectStores.keys()].sort()){const s=this._database.objectStores.get(e);if(!s)continue;i.add(s.name);let a=this._idbObjectStoreTreeElements.get(s.name);a||(a=new ei(this.resourcesPanel,this._model,this._databaseId,s),this._idbObjectStoreTreeElements.set(s.name,a),this.appendChild(a)),a.update(s,t)}for(const e of this._idbObjectStoreTreeElements.keys())i.has(e)||this._objectStoreRemoved(e);this._view&&this._view.update(e),this._updateTooltip()}_updateTooltip(){const e=this._database?this._database.version:"-";0===Object.keys(this._idbObjectStoreTreeElements).length?this.tooltip=_`Version: ${e} (empty)`:this.tooltip=_`Version: ${e}`}onselect(e){return super.onselect(e),!!this._database&&(this._view||(this._view=new Pt(this._model,this._database)),this.showView(this._view),!1)}_objectStoreRemoved(e){const t=this._idbObjectStoreTreeElements.get(e);t&&(t.clear(),this.removeChild(t)),this._idbObjectStoreTreeElements.delete(e),this._updateTooltip()}clear(){for(const e of this._idbObjectStoreTreeElements.keys())this._objectStoreRemoved(e)}}class ei extends Be{constructor(e,t,i,s){super(e,s.name,!1),this._model=t,this._databaseId=i,this._idbIndexTreeElements=new Map,this._objectStore=s,this._view=null;const a=E.Icon.create("mediumicon-table","resource-tree-item");this.setLeadingIcons([a])}get itemURL(){return"indexedDB://"+this._databaseId.securityOrigin+"/"+this._databaseId.name+"/"+this._objectStore.name}onattach(){super.onattach(),this.listItemElement.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!0)}markNeedsRefresh(){this._view&&this._view.markNeedsRefresh();for(const e of this._idbIndexTreeElements.values())e.markNeedsRefresh()}_handleContextMenuEvent(t){const i=new T.ContextMenu(t);i.defaultSection().appendItem(e.UIString("Clear"),this._clearObjectStore.bind(this)),i.show()}_refreshObjectStore(){this._view&&this._view.refreshData();for(const e of this._idbIndexTreeElements.values())e.refreshIndex()}async _clearObjectStore(){await this._model.clearObjectStore(this._databaseId,this._objectStore.name),this.update(this._objectStore,!0)}update(e,t){this._objectStore=e;const i=new Set;for(const e of this._objectStore.indexes.values()){i.add(e.name);let s=this._idbIndexTreeElements.get(e.name);s||(s=new ti(this.resourcesPanel,this._model,this._databaseId,this._objectStore,e,this._refreshObjectStore.bind(this)),this._idbIndexTreeElements.set(e.name,s),this.appendChild(s)),s.update(this._objectStore,e,t)}for(const e of this._idbIndexTreeElements.keys())i.has(e)||this._indexRemoved(e);for(const[e,t]of this._idbIndexTreeElements.entries())i.has(e)||(this.removeChild(t),this._idbIndexTreeElements.delete(e));this.childCount()&&this.expand(),this._view&&t&&this._view.update(this._objectStore,null),this._updateTooltip()}_updateTooltip(){const t=this._objectStore.keyPathString;let i=null!==t?_`Key path: ${t}`:"";this._objectStore.autoIncrement&&(i+="\n"+e.UIString("autoIncrement")),this.tooltip=i}onselect(e){return super.onselect(e),this._view||(this._view=new Ut(this._model,this._databaseId,this._objectStore,null,this._refreshObjectStore.bind(this))),this.showView(this._view),!1}_indexRemoved(e){const t=this._idbIndexTreeElements.get(e);t&&(t.clear(),this.removeChild(t)),this._idbIndexTreeElements.delete(e)}clear(){for(const e of this._idbIndexTreeElements.keys())this._indexRemoved(e);this._view&&this._view.clear()}}class ti extends Be{constructor(e,t,i,s,a,r){super(e,a.name,!1),this._model=t,this._databaseId=i,this._objectStore=s,this._index=a,this._refreshObjectStore=r}get itemURL(){return"indexedDB://"+this._databaseId.securityOrigin+"/"+this._databaseId.name+"/"+this._objectStore.name+"/"+this._index.name}markNeedsRefresh(){this._view&&this._view.markNeedsRefresh()}refreshIndex(){this._view&&this._view.refreshData()}update(e,t,i){this._objectStore=e,this._index=t,this._view&&i&&this._view.update(this._objectStore,this._index),this._updateTooltip()}_updateTooltip(){const t=[],i=this._index.keyPathString;t.push(_`Key path: ${i}`),this._index.unique&&t.push(e.UIString("unique")),this._index.multiEntry&&t.push(e.UIString("multiEntry")),this.tooltip=t.join("\n")}onselect(e){return super.onselect(e),this._view||(this._view=new Ut(this._model,this._databaseId,this._objectStore,this._index,this._refreshObjectStore)),this.showView(this._view),!1}clear(){this._view&&this._view.clear()}}class ii extends Be{constructor(t,i){super(t,i.securityOrigin?i.securityOrigin:e.UIString("Local Files"),!1),this._domStorage=i;const s=E.Icon.create("mediumicon-table","resource-tree-item");this.setLeadingIcons([s])}get itemURL(){return"storage://"+this._domStorage.securityOrigin+"/"+(this._domStorage.isLocalStorage?"local":"session")}onselect(e){return super.onselect(e),this.resourcesPanel.showDOMStorage(this._domStorage),!1}onattach(){super.onattach(),this.listItemElement.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!0)}_handleContextMenuEvent(t){const i=new T.ContextMenu(t);i.defaultSection().appendItem(e.UIString("Clear"),(()=>this._domStorage.clear())),i.show()}}class si extends Be{constructor(t,i,s){super(t,s||e.UIString("Local Files"),!1),this._target=i.resourceTreeModel().target(),this._cookieDomain=s,this.tooltip=_`Cookies used by frames from ${s}`;const a=E.Icon.create("mediumicon-cookie","resource-tree-item");this.setLeadingIcons([a])}get itemURL(){return"cookies://"+this._cookieDomain}cookieDomain(){return this._cookieDomain}onattach(){super.onattach(),this.listItemElement.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!0)}_handleContextMenuEvent(t){const i=new T.ContextMenu(t);i.defaultSection().appendItem(e.UIString("Clear"),(()=>this.resourcesPanel.clearCookies(this._target,this._cookieDomain))),i.show()}onselect(e){return super.onselect(e),this.resourcesPanel.showCookies(this._target,this._cookieDomain),!1}}class ai extends C.VBox{constructor(){super(),this.element.classList.add("storage-view"),this._emptyWidget=new w.EmptyWidget(""),this._linkElement=null,this._emptyWidget.show(this.element)}setText(e){this._emptyWidget.text=e}setLink(e){e&&!this._linkElement&&(this._linkElement=this._emptyWidget.appendLink(e)),!e&&this._linkElement&&this._linkElement.classList.add("hidden"),e&&this._linkElement&&(this._linkElement.setAttribute("href",e),this._linkElement.classList.remove("hidden"))}}class ri{constructor(e,t){this._panel=e,this._treeElement=t,this._treeElementForFrameId=new Map,this._treeElementForTargetId=new Map;const i=J.FrameManager.instance();i.addEventListener(J.Events.FrameAddedToTarget,(e=>this._frameAdded(e.data.frame)),this),i.addEventListener(J.Events.FrameRemoved,(e=>this._frameDetached(e.data.frameId)),this),i.addEventListener(J.Events.FrameNavigated,(e=>this._frameNavigated(e.data.frame)),this),i.addEventListener(J.Events.ResourceAdded,(e=>this._resourceAdded(e.data.resource)),this),q.TargetManager.instance().addModelListener(ee.ChildTargetManager,ee.Events.TargetCreated,this._windowOpened,this),q.TargetManager.instance().addModelListener(ee.ChildTargetManager,ee.Events.TargetInfoChanged,this._windowChanged,this),q.TargetManager.instance().addModelListener(ee.ChildTargetManager,ee.Events.TargetDestroyed,this._windowDestroyed,this),q.TargetManager.instance().observeTargets(this);for(const e of i.getAllFrames()){this._treeElementForFrameId.get(e.id)||this._addFrameAndParents(e);const t=e.resourceTreeModel().target().model(ee.ChildTargetManager);if(t)for(const e of t.targetInfos())this._windowOpened({data:{targetInfo:e}})}}targetAdded(e){e.type()!==q.Type.Worker&&e.type()!==q.Type.ServiceWorker||this._workerAdded(e)}async _workerAdded(e){const t=e.parentTarget();if(!t)return;const i=t.id(),s=this._treeElementForTargetId.get(i),{targetInfo:a}=await t.targetAgent().invoke_getTargetInfo({targetId:e.id()});s&&a&&s.workerCreated(a)}targetRemoved(e){}_addFrameAndParents(e){const t=e.parentFrame();t&&!this._treeElementForFrameId.get(t.id)&&this._addFrameAndParents(t),this._frameAdded(e)}_expandFrame(e){if(!e)return!1;let t=this._treeElementForFrameId.get(e.id);return!(!t&&!this._expandFrame(e.parentFrame()))&&(t=this._treeElementForFrameId.get(e.id),!!t&&(t.expand(),!0))}async revealResource(e,t,i){if(!this._expandFrame(e.frame()))return;const s=di.forResource(e);s&&await s.revealResource(t,i)}_frameAdded(e){const t=e.parentFrame(),i=t?this._treeElementForFrameId.get(t.id):this._treeElement;if(!i)return;const s=this._treeElementForFrameId.get(e.id);s&&(this._treeElementForFrameId.delete(e.id),s.parent&&s.parent.removeChild(s));const a=new ni(this,e);this._treeElementForFrameId.set(e.id,a);const r=e.resourceTreeModel().target().id();this._treeElementForTargetId.get(r)||this._treeElementForTargetId.set(r,a),i.appendChild(a);for(const t of e.resources())this._resourceAdded(t)}_frameDetached(e){const t=this._treeElementForFrameId.get(e);t&&(this._treeElementForFrameId.delete(e),t.parent&&t.parent.removeChild(t))}_frameNavigated(e){const t=this._treeElementForFrameId.get(e.id);t&&t.frameNavigated(e)}_resourceAdded(e){const t=this._treeElementForFrameId.get(e.frameId);t&&t.appendResource(e)}_windowOpened(e){const t=e.data;if(t.openerId&&"page"===t.type){const e=this._treeElementForFrameId.get(t.openerId);e&&(this._treeElementForTargetId.set(t.targetId,e),e.windowOpened(t))}}_windowDestroyed(e){const t=e.data,i=this._treeElementForTargetId.get(t);i&&(i.windowDestroyed(t),this._treeElementForTargetId.delete(t))}_windowChanged(e){const t=e.data;if(t.openerId&&"page"===t.type){const e=this._treeElementForFrameId.get(t.openerId);e&&e.windowChanged(t)}}reset(){this._treeElement.removeChildren(),this._treeElementForFrameId.clear(),this._treeElementForTargetId.clear()}}class ni extends Be{constructor(e,t){super(e._panel,"",!1),this._section=e,this._frame=t,this._frameId=t.id,this._categoryElements=new Map,this._treeElementForResource=new Map,this._treeElementForWindow=new Map,this._treeElementForWorker=new Map,this.setExpandable(!0),this.frameNavigated(t),this._view=null}getIconTypeForFrame(e){return e.isTopFrame()?e.unreachableUrl()?"mediumicon-frame-blocked":"mediumicon-frame":e.unreachableUrl()?"mediumicon-frame-embedded-blocked":"mediumicon-frame-embedded"}async frameNavigated(e){const t=E.Icon.create(this.getIconTypeForFrame(e));if(e.unreachableUrl()&&t.classList.add("red-icon"),this.setLeadingIcons([t]),this.invalidateChildren(),this._frameId=e.id,this.title!==e.displayName()&&(this.title=e.displayName(),f.setAccessibleName(this.listItemElement,this.title),this.parent)){const e=this.parent;e.removeChild(this),e.appendChild(this)}if(this._categoryElements.clear(),this._treeElementForResource.clear(),this._treeElementForWorker.clear(),this.selected?(this._view=new Dt(this._frame),this.showView(this._view)):this._view=null,e.isTopFrame()){const t=q.TargetManager.instance().targets();for(const i of t)if(i.type()===q.Type.ServiceWorker){const t=e.resourceTreeModel().target().targetAgent(),s=(await t.invoke_getTargetInfo({targetId:i.id()})).targetInfo;this.workerCreated(s)}}}get itemURL(){return this._frame.isTopFrame()?"frame://":"frame://"+encodeURI(this._frame.url)}onselect(e){return super.onselect(e),this._view?this._view.update():this._view=new Dt(this._frame),this.showView(this._view),this.listItemElement.classList.remove("hovered"),Y.OverlayModel.hideDOMNodeHighlight(),!1}set hovered(e){e?(this.listItemElement.classList.add("hovered"),this._frame.highlight()):(this.listItemElement.classList.remove("hovered"),Y.OverlayModel.hideDOMNodeHighlight())}appendResource(e){const t=e.statusCode();if(t>=301&&t<=303)return;const i=e.resourceType(),s=i.name();let r=i===a.resourceTypes.Document?this:this._categoryElements.get(s);r||(r=new Ve(this._section._panel,e.resourceType().category().title,s,"Frames"===s),this._categoryElements.set(i.name(),r),this.appendChild(r,ni._presentationOrderCompare));const n=new di(this._section._panel,e);r.appendChild(n,ni._presentationOrderCompare),this._treeElementForResource.set(e.url,n),this._view&&this._view.update()}windowOpened(e){const t="OpenedWindows";let i=this._categoryElements.get(t);if(i||(i=new Ve(this._section._panel,_`Opened Windows`,t),this._categoryElements.set(t,i),this.appendChild(i,ni._presentationOrderCompare)),!this._treeElementForWindow.get(e.targetId)){const t=new li(this._section._panel,e);i.appendChild(t),this._treeElementForWindow.set(e.targetId,t)}}workerCreated(e){const t="service_worker"===e.type?"Service Workers":"Web Workers",i="service_worker"===e.type?_`Service Workers`:_`Web Workers`;let s=this._categoryElements.get(t);if(s||(s=new Ve(this._section._panel,i,t),this._categoryElements.set(t,s),this.appendChild(s,ni._presentationOrderCompare)),!this._treeElementForWorker.get(e.targetId)){const t=new ci(this._section._panel,e);s.appendChild(t),this._treeElementForWorker.set(e.targetId,t)}}windowChanged(e){const t=this._treeElementForWindow.get(e.targetId);t&&(t.title!==e.title&&(t.title=e.title),t.update(e))}windowDestroyed(e){const t=this._treeElementForWindow.get(e);t&&t.windowClosed()}resourceByURL(e){const t=this._treeElementForResource.get(e);return t?t._resource:null}appendChild(e,t=ni._presentationOrderCompare){super.appendChild(e,t)}static _presentationOrderCompare(e,t){function i(e){return e instanceof Ve?2:e instanceof ni?1:3}return i(e)-i(t)||e.titleAsText().localeCompare(t.titleAsText())}}const oi=new WeakMap;class di extends Be{constructor(e,t){super(e,t.displayName,!1),this._panel=e,this._resource=t,this._previewPromise=null,this.tooltip=t.url,oi.set(this._resource,this);const i=E.Icon.create("mediumicon-manifest","navigator-file-tree-item");i.classList.add("navigator-"+t.resourceType().name()+"-tree-item"),this.setLeadingIcons([i])}static forResource(e){return oi.get(e)}get itemURL(){return this._resource.url}_preparePreview(){if(this._previewPromise)return this._previewPromise;const e=oe.PreviewFactory.createPreview(this._resource,this._resource.mimeType);return this._previewPromise=e.then((e=>e||new w.EmptyWidget(this._resource.url))),this._previewPromise}onselect(e){return super.onselect(e),this._panel.scheduleShowView(this._preparePreview()),!1}ondblclick(e){return re.InspectorFrontendHostInstance.openInNewTab(this._resource.url),!1}onattach(){super.onattach(),this.listItemElement.draggable=!0,this.listItemElement.addEventListener("dragstart",this._ondragstart.bind(this),!1),this.listItemElement.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!0)}_ondragstart(e){return!!e.dataTransfer&&(e.dataTransfer.setData("text/plain",this._resource.content||""),e.dataTransfer.effectAllowed="copy",!0)}_handleContextMenuEvent(e){const t=new T.ContextMenu(e);t.appendApplicableItems(this._resource),t.show()}async revealResource(e,t){this.revealAndSelect(!0);const i=await this._panel.scheduleShowView(this._preparePreview());i instanceof de.ResourceSourceFrame&&"number"==typeof e&&i.revealPosition(e,t,!0)}}class li extends Be{constructor(e,t){super(e,t.title||_`Window without title`,!1),this._targetInfo=t,this._isWindowClosed=!1,this._view=null,this.updateIcon(t.canAccessOpener)}updateIcon(e){const t=e?"mediumicon-frame-opened":"mediumicon-frame",i=E.Icon.create(t);this.setLeadingIcons([i])}update(e){e.canAccessOpener!==this._targetInfo.canAccessOpener&&this.updateIcon(e.canAccessOpener),this._targetInfo=e,this._view&&(this._view.setTargetInfo(e),this._view.update())}windowClosed(){this.listItemElement.classList.add("window-closed"),this._isWindowClosed=!0,this._view&&(this._view.setIsWindowClosed(!0),this._view.update())}onselect(e){return super.onselect(e),this._view?this._view.update():this._view=new Ft(this._targetInfo,this._isWindowClosed),this.showView(this._view),!1}}class ci extends Be{constructor(e,t){super(e,t.title||t.url||_`worker`,!1),this._targetInfo=t,this._view=null;const i=E.Icon.create("mediumicon-service-worker","navigator-file-tree-item");this.setLeadingIcons([i])}onselect(e){return super.onselect(e),this._view?this._view.update():this._view=new Bt(this._targetInfo),this.showView(this._view),!1}get itemURL(){return"dedicated-workers://"}}var hi=Object.freeze({__proto__:null,ApplicationPanelSidebar:zt,BackgroundServiceTreeElement:Kt,DatabaseTreeElement:$t,DatabaseTableTreeElement:Ht,ServiceWorkersTreeElement:Qt,AppManifestTreeElement:Xt,ClearStorageTreeElement:Jt,IndexedDBTreeElement:Yt,IDBDatabaseTreeElement:Zt,IDBObjectStoreTreeElement:ei,IDBIndexTreeElement:ti,DOMStorageTreeElement:ii,CookieTreeElement:si,StorageCategoryView:ai,ResourcesSection:ri,FrameTreeElement:ni,FrameResourceTreeElement:di});class _i extends C.VBox{constructor(t,i){super(!1),this._filterRegex=null,this._refreshButton=this._addButton(e.UIString("Refresh"),"largeicon-refresh",this.refreshItems),this._mainToolbar=new b.Toolbar("top-resources-toolbar",this.element),this._filterItem=new b.ToolbarInput(e.UIString("Filter"),"",.4),this._filterItem.addEventListener(b.ToolbarInput.Event.TextChanged,this._filterChanged,this);const s=new b.ToolbarSeparator;this._deleteAllButton=this._addButton(e.UIString("Clear All"),"largeicon-clear",this.deleteAllItems),this._deleteSelectedButton=this._addButton(e.UIString("Delete Selected"),"largeicon-delete",this.deleteSelectedItem),this._deleteAllButton.element.id="storage-items-delete-all";const a=[this._refreshButton,this._filterItem,s,this._deleteAllButton,this._deleteSelectedButton];for(const e of a)this._mainToolbar.appendToolbarItem(e)}setDeleteAllTitle(e){this._deleteAllButton.setTitle(e)}setDeleteAllGlyph(e){this._deleteAllButton.setGlyph(e)}appendToolbarItem(e){this._mainToolbar.appendToolbarItem(e)}_addButton(e,t,i){const s=new b.ToolbarButton(e,t);return s.addEventListener(b.ToolbarButton.Events.Click,i,this),s}_filterChanged(e){const t=e.data;this._filterRegex=t?new RegExp(t.escapeForRegExp(),"i"):null,this.refreshItems()}filter(e,t){if(this._filterRegex){const i=this._filterRegex;return e.filter((e=>i.test(t(e))))}return e}hasFilter(){return Boolean(this._filterRegex)}wasShown(){this.refreshItems()}setCanDeleteAll(e){this._deleteAllButton.setEnabled(e)}setCanDeleteSelected(e){this._deleteSelectedButton.setEnabled(e)}setCanRefresh(e){this._refreshButton.setEnabled(e)}setCanFilter(e){this._filterItem.setEnabled(e)}deleteAllItems(){}deleteSelectedItem(){}refreshItems(){}}var ui=Object.freeze({__proto__:null,StorageItemsView:_i});class mi extends C.VBox{constructor(){super(),this.setMinimumSize(230,45),this._cookie=null,this._showDecodedSetting=t.Settings.instance().createSetting("cookieViewShowDecoded",!1);const e=document.createElement("div");e.classList.add("cookie-preview-widget-header");const i=document.createElement("span");i.classList.add("cookie-preview-widget-header-label"),i.textContent="Cookie Value",e.appendChild(i),this.contentElement.appendChild(e);const s=x.CheckboxLabel.create(_`Show URL decoded`,this._showDecodedSetting.get());s.classList.add("cookie-preview-widget-toggle"),s.checkboxElement.addEventListener("click",(()=>this.showDecoded(!this._showDecodedSetting.get()))),e.appendChild(s),this._toggle=s;const a=document.createElement("div");a.classList.add("cookie-preview-widget-cookie-value"),a.textContent="",a.addEventListener("dblclick",this.handleDblClickOnCookieValue.bind(this)),this._value=a,this.contentElement.classList.add("cookie-preview-widget"),this.contentElement.appendChild(a)}showDecoded(e){this._cookie&&(this._showDecodedSetting.set(e),this._toggle.checkboxElement.checked=e,this._updatePreview())}_updatePreview(){this._cookie?this._value.textContent=this._showDecodedSetting.get()?decodeURIComponent(this._cookie.value()):this._cookie.value():this._value.textContent=""}setCookie(e){this._cookie=e,this._updatePreview()}handleDblClickOnCookieValue(e){e.preventDefault();const t=document.createRange();t.selectNode(this._value);const i=window.getSelection();i&&(i.removeAllRanges(),i.addRange(t))}}class pi extends _i{constructor(t,s){super(e.UIString("Cookies"),"cookiesPanel"),this.registerRequiredCSS("resources/cookieItemsView.css",{enableLegacyPatching:!1}),this.element.classList.add("storage-view"),this._model=t,this._cookieDomain=s,this._totalSize=0,this._cookiesTable=new Ee.CookiesTable(!1,this._saveCookie.bind(this),this.refreshItems.bind(this),this._handleCookieSelected.bind(this),this._deleteCookie.bind(this)),this._cookiesTable.setMinimumSize(0,50),this._splitWidget=new y.SplitWidget(!1,!0,"cookieItemsSplitViewState"),this._splitWidget.show(this.element),this._previewPanel=new C.VBox;const a=this._previewPanel.element.createChild("div","preview-panel-resizer");this._splitWidget.setMainWidget(this._cookiesTable),this._splitWidget.setSidebarWidget(this._previewPanel),this._splitWidget.installResizer(a),this._previewWidget=new mi,this._emptyWidget=new w.EmptyWidget(_`Select a cookie to preview its value`),this._emptyWidget.show(this._previewPanel.contentElement),this._onlyIssuesFilterUI=new b.ToolbarCheckbox(_`Only show cookies with an issue`,_`Only show cookies which have an associated issue`,(()=>{this._updateWithCookies(this._allCookies)})),this.appendToolbarItem(this._onlyIssuesFilterUI),this._refreshThrottler=new i.Throttler(300),this._eventDescriptors=[],this._allCookies=[],this._shownCookies=[],this._selectedCookie=null,this.setCookiesDomain(t,s)}setCookiesDomain(e,t){this._model=e,this._cookieDomain=t,this.refreshItems(),r.EventTarget.removeEventListeners(this._eventDescriptors);const i=e.target().model(X.NetworkManager);i&&(this._eventDescriptors=[i.addEventListener(X.Events.ResponseReceived,this._onResponseReceived,this),i.addEventListener(X.Events.LoadingFinished,this._onLoadingFinished,this)])}_showPreview(e){e!==this._selectedCookie&&(this._selectedCookie=e,e?(this._emptyWidget.detach(),this._previewWidget.setCookie(e),this._previewWidget.show(this._previewPanel.contentElement)):(this._previewWidget.detach(),this._emptyWidget.show(this._previewPanel.contentElement)))}_handleCookieSelected(){const e=this._cookiesTable.selectedCookie();this.setCanDeleteSelected(Boolean(e)),this._showPreview(e)}async _saveCookie(e,t){return t&&e.key()!==t.key()&&await this._model.deleteCookie(t),this._model.saveCookie(e)}_deleteCookie(e,t){this._model.deleteCookie(e).then(t)}_updateWithCookies(e){this._allCookies=e,this._totalSize=e.reduce(((e,t)=>e+t.size()),0);const t=s.ParsedURL.fromString(this._cookieDomain),i=t?t.host:"";this._cookiesTable.setCookieDomain(i),this._shownCookies=this.filter(e,(e=>`${e.name()} ${e.value()} ${e.domain()}`)),this.hasFilter()?(this.setDeleteAllTitle(_`Clear filtered cookies`),this.setDeleteAllGlyph("largeicon-delete-filter")):(this.setDeleteAllTitle(_`Clear all cookies`),this.setDeleteAllGlyph("largeicon-delete-list")),this._cookiesTable.setCookies(this._shownCookies,this._model.getCookieToBlockedReasonsMap()),f.alert(_`Number of cookies shown in table: ${this._shownCookies.length}`,this.element),this.setCanFilter(!0),this.setCanDeleteAll(this._shownCookies.length>0),this.setCanDeleteSelected(Boolean(this._cookiesTable.selectedCookie())),this._cookiesTable.selectedCookie()||this._showPreview(null)}filter(e,t){return super.filter(e,t).filter((e=>!this._onlyIssuesFilterUI.checked()||e instanceof te.Cookie&&Ie.hasIssues(e)))}deleteAllItems(){this._showPreview(null),this._model.deleteCookies(this._shownCookies).then((()=>this.refreshItems()))}deleteSelectedItem(){const e=this._cookiesTable.selectedCookie();e&&(this._showPreview(null),this._model.deleteCookie(e).then((()=>this.refreshItems())))}refreshItems(){this._model.getCookiesForDomain(this._cookieDomain).then(this._updateWithCookies.bind(this))}refreshItemsThrottled(){this._refreshThrottler.schedule((()=>Promise.resolve(this.refreshItems())))}_onResponseReceived(){this.refreshItemsThrottled()}_onLoadingFinished(){this.refreshItemsThrottled()}}var gi=Object.freeze({__proto__:null,CookieItemsView:pi});class vi extends _i{constructor(t){super(e.UIString("DOM Storage"),"domStoragePanel"),this._domStorage=t,this.element.classList.add("storage-view","table");const i=[{id:"key",title:e.UIString("Key"),sortable:!1,editable:!0,longText:!0,weight:50},{id:"value",title:e.UIString("Value"),sortable:!1,editable:!0,longText:!0,weight:50}];this._dataGrid=new c.DataGridImpl({displayName:_`DOM Storage Items`,columns:i,editCallback:this._editingCallback.bind(this),deleteCallback:this._deleteCallback.bind(this),refreshCallback:this.refreshItems.bind(this)}),this._dataGrid.addEventListener(c.Events.SelectedNode,(e=>{this._previewEntry(e.data)})),this._dataGrid.addEventListener(c.Events.DeselectedNode,(e=>{this._previewEntry(null)})),this._dataGrid.setStriped(!0),this._dataGrid.setName("DOMStorageItemsView"),this._splitWidget=new y.SplitWidget(!1,!0,"domStorageSplitViewState"),this._splitWidget.show(this.element),this._previewPanel=new C.VBox,this._previewPanel.setMinimumSize(0,50);const s=this._previewPanel.element.createChild("div","preview-panel-resizer"),a=this._dataGrid.asWidget();a.setMinimumSize(0,50),this._splitWidget.setMainWidget(a),this._splitWidget.setSidebarWidget(this._previewPanel),this._splitWidget.installResizer(s),this._preview=null,this._previewValue=null,this._showPreview(null,null),this._eventListeners=[],this.setStorage(t)}setStorage(e){r.EventTarget.removeEventListeners(this._eventListeners),this._domStorage=e,this._eventListeners=[this._domStorage.addEventListener(rt.Events.DOMStorageItemsCleared,this._domStorageItemsCleared,this),this._domStorage.addEventListener(rt.Events.DOMStorageItemRemoved,this._domStorageItemRemoved,this),this._domStorage.addEventListener(rt.Events.DOMStorageItemAdded,this._domStorageItemAdded,this),this._domStorage.addEventListener(rt.Events.DOMStorageItemUpdated,this._domStorageItemUpdated,this)],this.refreshItems()}_domStorageItemsCleared(){this.isShowing()&&this._dataGrid&&(this._dataGrid.rootNode().removeChildren(),this._dataGrid.addCreationNode(!1),this.setCanDeleteSelected(!1))}_domStorageItemRemoved(e){if(!this.isShowing()||!this._dataGrid)return;const t=e.data,i=this._dataGrid.rootNode(),s=i.children;for(let e=0;e<s.length;++e){const a=s[e];if(a.data.key===t.key)return i.removeChild(a),void this.setCanDeleteSelected(s.length>1)}}_domStorageItemAdded(e){if(!this.isShowing()||!this._dataGrid)return;const t=e.data,i=this._dataGrid.rootNode(),s=i.children;for(let e=0;e<s.length;++e)if(s[e].data.key===t.key)return;const a=new c.DataGridNode({key:t.key,value:t.value},!1);i.insertChild(a,s.length-1)}_domStorageItemUpdated(e){if(!this.isShowing()||!this._dataGrid)return;const t=e.data,i=this._dataGrid.rootNode().children.find((e=>e.data.key===t.key));i&&i.data.value!==t.value&&(i.data.value=t.value,i.refresh(),i.selected&&(this._previewEntry(i),this.setCanDeleteSelected(!0)))}_showDOMStorageItems(e){const t=this._dataGrid.rootNode();let i=null;for(const e of t.children)if(e.selected){i=e.data.key;break}t.removeChildren();let s=null;const a=e=>`${e[0]} ${e[1]}`;for(const r of this.filter(e,a)){const e=r[0],a=r[1],n=new c.DataGridNode({key:e,value:a},!1);n.selectable=!0,t.appendChild(n),s&&e!==i||(s=n)}s&&(s.selected=!0),this._dataGrid.addCreationNode(!1),this.setCanDeleteSelected(Boolean(s))}deleteSelectedItem(){this._dataGrid&&this._dataGrid.selectedNode&&this._deleteCallback(this._dataGrid.selectedNode)}refreshItems(){this._domStorage.getItems().then((e=>e&&this._showDOMStorageItems(e)))}deleteAllItems(){this._domStorage.clear(),this._domStorageItemsCleared()}_editingCallback(e,t,i,s){const a=this._domStorage;"key"===t?("string"==typeof i&&a.removeItem(i),a.setItem(s,e.data.value||""),this._removeDupes(e)):a.setItem(e.data.key||"",s)}_removeDupes(e){const t=this._dataGrid.rootNode(),i=t.children;for(let s=i.length-1;s>=0;--s){const a=i[s];a.data.key===e.data.key&&e!==a&&t.removeChild(a)}}_deleteCallback(e){e&&!e.isCreationNode&&this._domStorage&&this._domStorage.removeItem(e.data.key)}_showPreview(t,i){this._preview&&this._previewValue===i||(this._preview&&this._preview.detach(),t||(t=new w.EmptyWidget(e.UIString("Select a value to preview"))),this._previewValue=i,this._preview=t,t.show(this._previewPanel.contentElement))}async _previewEntry(e){const t=e&&e.data&&e.data.value;if(e&&e.data&&e.data.value){const i=`${this._domStorage.isLocalStorage?"localstorage":"sessionstorage"}://${e.key}`,s=Te.StaticContentProvider.fromString(i,a.resourceTypes.XHR,t),r=await oe.PreviewFactory.createPreview(s,"text/plain");e.selected&&this._showPreview(r,t)}else this._showPreview(null,t)}}var bi=Object.freeze({__proto__:null,DOMStorageItemsView:vi});let wi;class Si extends W.PanelWithSidebar{constructor(){super("resources"),this.registerRequiredCSS("resources/resourcesPanel.css",{enableLegacyPatching:!1}),this._resourcesLastSelectedItemSetting=t.Settings.instance().createSetting("resourcesLastSelectedElementPath",[]),this.visibleView=null,this._pendingViewPromise=null,this._categoryView=null;const e=new C.VBox;this.storageViews=e.element.createChild("div","vbox flex-auto"),this._storageViewToolbar=new b.Toolbar("resources-toolbar",e.element),this.splitWidget().setMainWidget(e),this._domStorageView=null,this._cookieView=null,this._emptyWidget=null,this._sidebar=new zt(this),this._sidebar.show(this.panelSidebarElement())}static instance(e={forceNew:null}){const{forceNew:t}=e;return wi&&!t||(wi=new Si),wi}static _instance(){return Si.instance()}static _shouldCloseOnReset(e){return[de.ResourceSourceFrame,le.ImageView,ce.FontView,_i,kt,Lt].some((t=>e instanceof t))}focus(){this._sidebar.focus()}lastSelectedItemPath(){return this._resourcesLastSelectedItemSetting.get()}setLastSelectedItemPath(e){this._resourcesLastSelectedItemSetting.set(e)}resetView(){this.visibleView&&Si._shouldCloseOnReset(this.visibleView)&&this.showView(null)}showView(e){this._pendingViewPromise=null,this.visibleView!==e&&(this.visibleView&&this.visibleView.detach(),e&&e.show(this.storageViews),this.visibleView=e,this._storageViewToolbar.removeToolbarItems(),e instanceof v.SimpleView&&e.toolbarItems().then((e=>{e.map((e=>this._storageViewToolbar.appendToolbarItem(e))),this._storageViewToolbar.element.classList.toggle("hidden",!e.length)})))}async scheduleShowView(e){this._pendingViewPromise=e;const t=await e;return this._pendingViewPromise!==e?null:(this.showView(t),t)}showCategoryView(e,t){this._categoryView||(this._categoryView=new ai),this._categoryView.setText(e),this._categoryView.setLink(t),this.showView(this._categoryView)}showDOMStorage(e){e&&(this._domStorageView?this._domStorageView.setStorage(e):this._domStorageView=new vi(e),this.showView(this._domStorageView))}showCookies(e,t){const i=e.model(Q.CookieModel);i&&(this._cookieView?this._cookieView.setCookiesDomain(i,t):this._cookieView=new pi(i,t),this.showView(this._cookieView))}clearCookies(e,t){const i=e.model(Q.CookieModel);i&&i.clear(t).then((()=>{this._cookieView&&this._cookieView.refreshItems()}))}}var fi=Object.freeze({__proto__:null,ResourcesPanel:Si,ResourceRevealer:class{async reveal(e){if(!(e instanceof ie.Resource))return Promise.reject(new Error("Internal error: not a resource"));const t=Si._instance()._sidebar;await P.ViewManager.instance().showView("resources"),await t.showResource(e)}},CookieReferenceRevealer:class{async reveal(e){if(!(e instanceof te.CookieReference))throw new Error("Internal error: not a cookie reference");const t=Si._instance()._sidebar;await P.ViewManager.instance().showView("resources"),await t.cookieListTreeElement.select();const i=e.contextUrl();i&&await this._revealByDomain(t,i)||this._revealByDomain(t,e.domain())}async _revealByDomain(e,t){const i=e.cookieListTreeElement.children().find((e=>e.cookieDomain().endsWith(t)));return!!i&&(await i.revealAndSelect(),!0)}}});export{$e as AppManifestView,Fe as ApplicationCacheItemsView,Me as ApplicationCacheModel,hi as ApplicationPanelSidebar,Xe as BackgroundServiceModel,Ze as BackgroundServiceView,Ct as ClearStorageView,gi as CookieItemsView,bi as DOMStorageItemsView,lt as DOMStorageModel,at as DatabaseModel,Tt as DatabaseQueryView,xt as DatabaseTableView,Vt as FrameDetailsView,vt as IndexedDBModel,At as IndexedDBViews,fi as ResourcesPanel,We as ServiceWorkerCacheViews,Gt as ServiceWorkersView,ui as StorageItemsView};
