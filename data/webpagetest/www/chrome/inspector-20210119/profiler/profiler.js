import{ls as e,ArrayUtilities as t,NumberUtilities as i,DateUtilities as s,StringUtilities as r}from"../platform/platform.js";import{UIString as o,Color as n,ObjectWrapper as a,Settings as l,Revealer as d,ParsedURL as h,Console as c,Worker as p,Throttler as u}from"../common/common.js";import{DataGrid as _,ShowMoreDataGridNode as m,SortableDataGrid as f}from"../data_grid/data_grid.js";import{UIUtils as g,Icon as v,Tooltip as w,Widget as S,TreeOutline as C,InplaceEditor as b,ARIAUtils as P,ContextMenu as T,View as y,SearchableView as x,Toolbar as I,Context as E,ListModel as N,ListControl as R,InspectorView as D,Fragment as F,SplitWidget as k,TabbedPane as L,PopoverHelper as M,SettingsUI as B,Panel as O,ActionRegistry as G,ViewManager as V}from"../ui/ui.js";import{Platform as H,userMetrics as z,UserMetrics as j}from"../host/host.js";import{FlameChart as U,OverviewGrid as W,LineLevelProfile as A,PieChart as $}from"../perf_ui/perf_ui.js";import{Linkifier as q}from"../components/components.js";import{SDKModel as J,CPUProfilerModel as Q,CPUProfileDataModel as K,IsolateManager as X,RuntimeModel as Y,HeapProfilerModel as Z,ProfileTreeModel as ee,ConsoleModel as te,RemoteObject as ie,ResourceTreeModel as se}from"../sdk/sdk.js";import{DebuggerWorkspaceBinding as re,FileUtils as oe,TempFile as ne}from"../bindings/bindings.js";import{Runtime as ae}from"../root/root.js";import{HeapSnapshotModel as le}from"../heap_snapshot_model/heap_snapshot_model.js";import{ObjectPopoverHelper as de}from"../object_ui/object_ui.js";import{Workspace as he}from"../workspace/workspace.js";class ce extends _.DataGridNode{constructor(e,t,i){super(null,i),this._searchMatchedSelfColumn=!1,this._searchMatchedTotalColumn=!1,this._searchMatchedFunctionColumn=!1,this.profileNode=e,this.tree=t,this.childrenByCallUID=new Map,this.lastComparator=null,this.callUID=e.callUID,this.self=e.self,this.total=e.total,this.functionName=g.beautifyFunctionName(e.functionName),this._deoptReason=e.deoptReason||"",this.url=e.url,this.linkElement=null,this._populated=!1}static sort(e,t,i){for(let s=0;s<e.length;++s){const r=e[s],o=r.length;for(let s=0;s<o;++s){const o=r[s];if(!(i||o.expanded&&o.lastComparator!==t)){o.children.length&&(o.shouldRefreshChildren=!0);continue}o.lastComparator=t;const n=o.children,a=n.length;if(a){n.sort(t);for(let e=0;e<a;++e)n[e].recalculateSiblings(e);e.push(n)}}}}static merge(e,t,i){e.self+=t.self,i||(e.total+=t.total);let s=e.children.slice();e.removeChildren();let r=s.length;for(let o=0;o<r;++o)i&&s[o]===t||e.appendChild(s[o]);s=t.children.slice(),r=s.length;for(let t=0;t<r;++t){const i=s[t],r=e.childrenByCallUID.get(i.callUID);r?r.merge(i,!1):e.appendChild(i)}}static populate(e){if(e._populated)return;e._populated=!0,e.populateChildren();const t=e.tree.lastComparator;t&&e.sort(t,!0)}createCell(e){switch(e){case"self":{const t=this._createValueCell(this.self,this.selfPercent,e);return t.classList.toggle("highlight",this._searchMatchedSelfColumn),t}case"total":{const t=this._createValueCell(this.total,this.totalPercent,e);return t.classList.toggle("highlight",this._searchMatchedTotalColumn),t}case"function":{const t=this.createTD(e);if(t.classList.toggle("highlight",this._searchMatchedFunctionColumn),this._deoptReason){t.classList.add("not-optimized");const e=v.Icon.create("smallicon-warning","profile-warn-marker");w.Tooltip.install(e,o.UIString("Not optimized: %s",this._deoptReason)),t.appendChild(e)}if(g.createTextChild(t,this.functionName),"0"===this.profileNode.scriptId)return t;const i=this.tree._formatter.linkifyNode(this);return i?(i.style.maxWidth="75%",t.appendChild(i),this.linkElement=i,t):t}}return super.createCell(e)}_createValueCell(t,i,s){const r=document.createElement("td");r.classList.add("numeric-column");const o=r.createChild("div","profile-multiple-values"),n=o.createChild("span"),a=this.tree._formatter.formatValue(t,this);n.textContent=a;const l=o.createChild("span","percent-column"),d=this.tree._formatter.formatPercent(i,this);l.textContent=d;const h=this.tree._formatter.formatValueAccessibleText(t,this);return this.setCellAccessibleName(e`${h}, ${d}`,r,s),r}sort(e,t){const i=e;return ce.sort([[this]],i,t)}insertChild(e,t){const i=e;super.insertChild(i,t),this.childrenByCallUID.set(i.callUID,i)}removeChild(e){super.removeChild(e),this.childrenByCallUID.delete(e.callUID)}removeChildren(){super.removeChildren(),this.childrenByCallUID.clear()}findChild(e){return e&&this.childrenByCallUID.get(e.callUID)||null}get selfPercent(){return this.self/this.tree.total*100}get totalPercent(){return this.total/this.tree.total*100}populate(){ce.populate(this)}populateChildren(){}save(){this._savedChildren||(this._savedSelf=this.self,this._savedTotal=this.total,this._savedChildren=this.children.slice())}restore(){if(!this._savedChildren)return;this._savedSelf&&this._savedTotal&&(this.self=this._savedSelf,this.total=this._savedTotal),this.removeChildren();const e=this._savedChildren,t=e.length;for(let i=0;i<t;++i)e[i].restore(),this.appendChild(e[i])}merge(e,t){ce.merge(this,e,t)}}class pe{constructor(e,t,i){this.tree=this,this.self=0,this.children=[],this._formatter=e,this._searchableView=t,this.total=i,this.lastComparator=null,this.childrenByCallUID=new Map,this.deepSearch=!0,this._populated=!1,this._searchResults}static propertyComparator(e,t){let i=pe.propertyComparators[t?1:0][e];return i||(i=t?function(t,i){return t[e]<i[e]?-1:t[e]>i[e]?1:0}:function(t,i){return t[e]>i[e]?-1:t[e]<i[e]?1:0},pe.propertyComparators[t?1:0][e]=i),i}get expanded(){return!0}appendChild(e){this.insertChild(e,this.children.length)}focus(e){}exclude(e){}insertChild(e,t){const i=e;this.children.splice(t,0,i),this.childrenByCallUID.set(i.callUID,e)}removeChildren(){this.children=[],this.childrenByCallUID.clear()}populateChildren(){}findChild(e){return e?this.childrenByCallUID.get(e.callUID):null}sort(e,t){return ce.sort([[this]],e,t)}save(){this._savedChildren||(this._savedTotal=this.total,this._savedChildren=this.children.slice())}restore(){if(!this._savedChildren)return;this.children=this._savedChildren,this._savedTotal&&(this.total=this._savedTotal);const e=this.children,t=e.length;for(let i=0;i<t;++i)e[i].restore();this._savedChildren=null}_matchFunction(e){const t=e.query.trim();if(!t.length)return null;const i=t.startsWith(">"),s=t.startsWith("<");let r=t.startsWith("=")||(i||s)&&1===t.indexOf("=");const o=t.endsWith("%"),n=t.length>2&&t.endsWith("ms"),a=!n&&t.endsWith("s");let l=parseFloat(t);(i||s||r)&&(l=r&&(i||s)?parseFloat(t.substring(2)):parseFloat(t.substring(1)));const d=a?1e3*l:l;isNaN(l)||i||s||(r=!0);const h=createPlainTextSearchRegex(t,"i");return function(e){return e._searchMatchedSelfColumn=!1,e._searchMatchedTotalColumn=!1,e._searchMatchedFunctionColumn=!1,o?(s?(e.selfPercent<l&&(e._searchMatchedSelfColumn=!0),e.totalPercent<l&&(e._searchMatchedTotalColumn=!0)):i&&(e.selfPercent>l&&(e._searchMatchedSelfColumn=!0),e.totalPercent>l&&(e._searchMatchedTotalColumn=!0)),r&&(e.selfPercent===l&&(e._searchMatchedSelfColumn=!0),e.totalPercent===l&&(e._searchMatchedTotalColumn=!0))):(n||a)&&(s?(e.self<d&&(e._searchMatchedSelfColumn=!0),e.total<d&&(e._searchMatchedTotalColumn=!0)):i&&(e.self>d&&(e._searchMatchedSelfColumn=!0),e.total>d&&(e._searchMatchedTotalColumn=!0)),r&&(e.self===d&&(e._searchMatchedSelfColumn=!0),e.total===d&&(e._searchMatchedTotalColumn=!0))),(e.functionName.match(h)||e.url&&e.url.match(h))&&(e._searchMatchedFunctionColumn=!0),!!(e._searchMatchedSelfColumn||e._searchMatchedTotalColumn||e._searchMatchedFunctionColumn)&&(e.refresh(),!0)}}performSearch(e,t,i){this.searchCanceled();const s=this._matchFunction(e);if(!s)return;this._searchResults=[];const r=this.deepSearch;let o;for(o=this.children[0];o;o=o.traverseNextNode(!r,null,!r)){const e=o;if(!e)break;s(e)&&this._searchResults.push({profileNode:e})}this._searchResultIndex=i?0:this._searchResults.length-1,this._searchableView.updateSearchMatchesCount(this._searchResults.length),this._searchableView.updateCurrentMatchIndex(this._searchResultIndex)}searchCanceled(){if(this._searchResults)for(let e=0;e<this._searchResults.length;++e){const t=this._searchResults[e].profileNode;t._searchMatchedSelfColumn=!1,t._searchMatchedTotalColumn=!1,t._searchMatchedFunctionColumn=!1,t.refresh()}this._searchResults=[],this._searchResultIndex=-1}jumpToNextSearchResult(){this._searchResults&&this._searchResults.length&&(this._searchResultIndex=(this._searchResultIndex+1)%this._searchResults.length,this._jumpToSearchResult(this._searchResultIndex))}jumpToPreviousSearchResult(){this._searchResults&&this._searchResults.length&&(this._searchResultIndex=(this._searchResultIndex-1+this._searchResults.length)%this._searchResults.length,this._jumpToSearchResult(this._searchResultIndex))}supportsCaseSensitiveSearch(){return!0}supportsRegexSearch(){return!1}_jumpToSearchResult(e){const t=this._searchResults[e];if(!t)return;t.profileNode.revealAndSelect(),this._searchableView.updateCurrentMatchIndex(e)}}pe.propertyComparators=[{},{}];var ue=Object.freeze({__proto__:null,ProfileDataGridNode:ce,ProfileDataGridTree:pe,Formatter:class{formatValue(e,t){throw new Error("Not implemented")}formatValueAccessibleText(e,t){throw new Error("Not implemented")}formatPercent(e,t){throw new Error("Not implemented")}linkifyNode(e){throw new Error("Not implemented")}}});class _e extends ce{constructor(e,t){super(e,t,null!==e.parent&&Boolean(e.parent.parent)),this._remainingNodeInfos=[]}static _sharedPopulate(e){if(void 0===e._remainingNodeInfos)return;const t=e._remainingNodeInfos,i=t.length;for(let s=0;s<i;++s){const i=t[s],r=i.ancestor,o=i.focusNode;let n=e.findChild(r);if(n){const e=i.totalAccountedFor;n.self+=o.self,e||(n.total+=o.total)}else n=new _e(r,e.tree),r!==o&&(n.self=o.self,n.total=o.total),e.appendChild(n);const a=r.parent;a&&a.parent&&(i.ancestor=a,n._remainingNodeInfos||(n._remainingNodeInfos=[]),n._remainingNodeInfos.push(i))}delete e._remainingNodeInfos}_takePropertiesFromProfileDataGridNode(e){this.save(),this.self=e.self,this.total=e.total}_keepOnlyChild(e){this.save(),this.removeChildren(),this.appendChild(e)}_exclude(e){this._remainingNodeInfos&&this.populate(),this.save();const t=this.children;let i=this.children.length;for(;i--;)t[i]._exclude(e);const s=this.childrenByCallUID.get(e);s&&this.merge(s,!0)}restore(){super.restore(),this.children.length||this.setHasChildren(this._willHaveChildren(this.profileNode))}merge(e,t){this.self-=e.self,super.merge(e,t)}populateChildren(){_e._sharedPopulate(this)}_willHaveChildren(e){return Boolean(e.parent&&e.parent.parent)}}class me extends pe{constructor(e,t,i,s){super(e,t,s),this.deepSearch=!1;let r=0;const o=[[],[i]],n=new Map;this._remainingNodeInfos=[];for(let e=0;e<o.length;++e){const t=o[e],i=o[++e],s=i.length,a=new WeakMap;for(let e=0;e<s;++e){const s=i[e];if(a.get(s)||a.set(s,++r),s.parent){let e=n.get(s.callUID),i=!1;if(e){const s=t.length;for(let r=0;r<s;++r){const s=a.get(t[r]);if(s&&e.has(s)){i=!0;break}}}else e=new Set,n.set(s.callUID,e);const r=a.get(s);r&&e.add(r),this._remainingNodeInfos.push({ancestor:s,focusNode:s,totalAccountedFor:i})}const l=s.children;l.length&&(o.push(t.concat([s])),o.push(l))}}return ce.populate(this),this}focus(e){if(!e)return;this.save();let t=e,i=e;for(;t.parent&&t instanceof _e;)t._takePropertiesFromProfileDataGridNode(e),i=t,t=t.parent,t instanceof _e&&t._keepOnlyChild(i);this.children=[i],this.total=e.total}exclude(e){if(!e)return;this.save();const i=e.callUID,s=this.childrenByCallUID.get(i);s&&t.removeElement(this.children,s);const r=this.children,o=r.length;for(let e=0;e<o;++e)r[e]._exclude(i);this.lastComparator&&this.sort(this.lastComparator,!0)}populateChildren(){_e._sharedPopulate(this)}}var fe=Object.freeze({__proto__:null,NodeInfo:undefined,BottomUpProfileDataGridNode:_e,BottomUpProfileDataGridTree:me});var ge=Object.freeze({__proto__:null,ChildrenProvider:class{dispose(){}nodePosition(e){throw new Error("Not implemented yet")}isEmpty(){throw new Error("Not implemented yet")}serializeItemsRange(e,t){throw new Error("Not implemented yet")}sortAndRewind(e){throw new Error("Not implemented yet")}}});let ve=null;class we{constructor(){this._colorGenerator=we.colorGenerator(),this._maxStackDepth=0,this.timelineData_=null,this.entryNodes=[]}static colorGenerator(){return ve||(ve=new n.Generator({min:30,max:330,count:void 0},{min:50,max:80,count:5},{min:80,max:90,count:3}),ve.setColorForID("(idle)","hsl(0, 0%, 94%)"),ve.setColorForID("(program)","hsl(0, 0%, 80%)"),ve.setColorForID("(garbage collector)","hsl(0, 0%, 80%)")),ve}minimumBoundary(){throw"Not implemented."}totalTime(){throw"Not implemented."}formatValue(e,t){return Number.preciseMillisToString(e,t)}maxStackDepth(){return this._maxStackDepth}timelineData(){return this.timelineData_||this._calculateTimelineData()}_calculateTimelineData(){throw"Not implemented."}prepareHighlightedEntryInfo(e){throw"Not implemented."}canJumpToEntry(e){return"0"!==this.entryNodes[e].scriptId}entryTitle(e){const t=this.entryNodes[e];return g.beautifyFunctionName(t.functionName)}entryFont(e){return this._font||(this._font="11px "+H.fontFamily(),this._boldFont="bold "+this._font),this.entryHasDeoptReason(e)?this._boldFont:this._font}entryHasDeoptReason(e){throw"Not implemented."}entryColor(e){const t=this.entryNodes[e];return this._colorGenerator.colorForID(t.url||("0"!==t.scriptId?t.scriptId:t.functionName))}decorateEntry(e,t,i,s,r,o,n){return!1}forceDecoration(e){return!1}textColor(e){return"#333"}navStartTimes(){return new Map}entryNodesLength(){return this.entryNodes.length}}class Se extends S.VBox{constructor(e,t){super(),this.element.id="cpu-flame-chart",this._searchableView=e,this._overviewPane=new be(t),this._overviewPane.show(this.element),this._mainPane=new U.FlameChart(t,this._overviewPane),this._mainPane.setBarHeight(15),this._mainPane.setTextBaseline(4),this._mainPane.setTextPadding(2),this._mainPane.show(this.element),this._mainPane.addEventListener(U.Events.EntrySelected,this._onEntrySelected,this),this._mainPane.addEventListener(U.Events.EntryInvoked,this._onEntryInvoked,this),this._entrySelected=!1,this._mainPane.addEventListener(U.Events.CanvasFocused,this._onEntrySelected,this),this._overviewPane.addEventListener(W.Events.WindowChanged,this._onWindowChanged,this),this._dataProvider=t,this._searchResults=[]}focus(){this._mainPane.focus()}_onWindowChanged(e){const t=e.data.windowTimeLeft,i=e.data.windowTimeRight;this._mainPane.setWindowTimes(t,i,!0)}selectRange(e,t){this._overviewPane._selectRange(e,t)}_onEntrySelected(e){if(e.data){const t=Number(e.data);this._mainPane.setSelectedEntry(t),this._entrySelected=-1!==t}else this._entrySelected||(this._mainPane.setSelectedEntry(0),this._entrySelected=!0)}_onEntryInvoked(e){this._onEntrySelected(e),this.dispatchEventToListeners(U.Events.EntryInvoked,e.data)}update(){this._overviewPane.update(),this._mainPane.update()}performSearch(e,t,i){const s=createPlainTextSearchRegex(e.query,e.caseSensitive?"":"i"),r=-1!==this._searchResultIndex?this._searchResults[this._searchResultIndex]:-1;this._searchResults=[];const o=this._dataProvider.entryNodesLength();for(let e=0;e<o;++e)this._dataProvider.entryTitle(e).match(s)&&this._searchResults.push(e);this._searchResults.length?(this._searchResultIndex=this._searchResults.indexOf(r),-1===this._searchResultIndex&&(this._searchResultIndex=i?this._searchResults.length-1:0),this._mainPane.setSelectedEntry(this._searchResults[this._searchResultIndex])):this.searchCanceled(),this._searchableView.updateSearchMatchesCount(this._searchResults.length),this._searchableView.updateCurrentMatchIndex(this._searchResultIndex)}searchCanceled(){this._mainPane.setSelectedEntry(-1),this._searchResults=[],this._searchResultIndex=-1}jumpToNextSearchResult(){this._searchResultIndex=(this._searchResultIndex+1)%this._searchResults.length,this._mainPane.setSelectedEntry(this._searchResults[this._searchResultIndex]),this._searchableView.updateCurrentMatchIndex(this._searchResultIndex)}jumpToPreviousSearchResult(){this._searchResultIndex=(this._searchResultIndex-1+this._searchResults.length)%this._searchResults.length,this._mainPane.setSelectedEntry(this._searchResults[this._searchResultIndex]),this._searchableView.updateCurrentMatchIndex(this._searchResultIndex)}supportsCaseSensitiveSearch(){return!0}supportsRegexSearch(){return!1}}class Ce{constructor(e){this._formatter=e,this._minimumBoundaries,this._maximumBoundaries,this._xScaleFactor}_updateBoundaries(e){this._minimumBoundaries=e._dataProvider.minimumBoundary();const t=e._dataProvider.totalTime();this._maximumBoundaries=this._minimumBoundaries+t,this._xScaleFactor=e._overviewContainer.clientWidth/t}computePosition(e){return(e-this._minimumBoundaries)*this._xScaleFactor}formatValue(e,t){return this._formatter(e-this._minimumBoundaries,t)}maximumBoundary(){return this._maximumBoundaries}minimumBoundary(){return this._minimumBoundaries}zeroTime(){return this._minimumBoundaries}boundarySpan(){return this._maximumBoundaries-this._minimumBoundaries}}class be extends S.VBox{constructor(e){super(),this.element.classList.add("cpu-profile-flame-chart-overview-pane"),this._overviewContainer=this.element.createChild("div","cpu-profile-flame-chart-overview-container"),this._overviewCalculator=new Ce(e.formatValue),this._overviewGrid=new W.OverviewGrid("cpu-profile-flame-chart",this._overviewCalculator),this._overviewGrid.element.classList.add("fill"),this._overviewCanvas=this._overviewContainer.createChild("canvas","cpu-profile-flame-chart-overview-canvas"),this._overviewContainer.appendChild(this._overviewGrid.element),this._dataProvider=e,this._overviewGrid.addEventListener(W.Events.WindowChanged,this._onWindowChanged,this)}windowChanged(e,t){this._selectRange(e,t)}updateRangeSelection(e,t){}updateSelectedGroup(e,t){}_selectRange(e,t){const i=this._dataProvider.minimumBoundary(),s=this._dataProvider.totalTime();this._overviewGrid.setWindow((e-i)/s,(t-i)/s)}_onWindowChanged(e){const t={windowTimeLeft:e.data.rawStartValue,windowTimeRight:e.data.rawEndValue};this._windowTimeLeft=t.windowTimeLeft,this._windowTimeRight=t.windowTimeRight,this.dispatchEventToListeners(W.Events.WindowChanged,t)}_timelineData(){return this._dataProvider.timelineData()}onResize(){this._scheduleUpdate()}_scheduleUpdate(){this._updateTimerId||(this._updateTimerId=this.element.window().requestAnimationFrame(this.update.bind(this)))}update(){this._updateTimerId=0;this._timelineData()&&(this._resetCanvas(this._overviewContainer.clientWidth,this._overviewContainer.clientHeight-U.HeaderHeight),this._overviewCalculator._updateBoundaries(this),this._overviewGrid.updateDividers(this._overviewCalculator),this._drawOverviewCanvas())}_drawOverviewCanvas(){const e=this._overviewCanvas.width,t=this._overviewCanvas.height,i=this._calculateDrawData(e),s=this._overviewCanvas.getContext("2d");if(!s)throw new Error("Failed to get canvas context");const r=window.devicePixelRatio,o=t/(1.1*this._dataProvider.maxStackDepth());s.lineWidth=1,s.translate(.5,.5),s.strokeStyle="rgba(20,0,0,0.4)",s.fillStyle="rgba(214,225,254,0.8)",s.moveTo(-1,t+1),s.lineTo(-1,Math.round(t-i[0]*o-r));let n=0;for(let a=0;a<e;++a)n=Math.round(t-i[a]*o-r),s.lineTo(a,n);s.lineTo(e+1,n),s.lineTo(e+1,t+1),s.fill(),s.stroke(),s.closePath()}_calculateDrawData(e){const t=this._dataProvider,i=this._timelineData(),s=i.entryStartTimes,r=i.entryTotalTimes,o=i.entryLevels,n=s.length,a=this._dataProvider.minimumBoundary(),l=new Uint8Array(e),d=e/t.totalTime();for(let e=0;e<n;++e){const t=Math.floor((s[e]-a)*d),i=Math.floor((s[e]-a+r[e])*d);for(let s=t;s<=i;++s)l[s]=Math.max(l[s],o[e]+1)}return l}_resetCanvas(e,t){const i=window.devicePixelRatio;this._overviewCanvas.width=e*i,this._overviewCanvas.height=t*i,this._overviewCanvas.style.width=e+"px",this._overviewCanvas.style.height=t+"px"}}var Pe=Object.freeze({__proto__:null,ProfileFlameChartDataProvider:we,CPUProfileFlameChart:Se,OverviewCalculator:Ce,OverviewPane:be});class Te extends a.ObjectWrapper{constructor(e,t){super(),this._profileType=e,this.title=t,this.uid=e.incrementProfileUid(),this._fromFile=!1,this.tempFile=null}setTitle(e){this.title=e,this.dispatchEventToListeners(xe.ProfileTitleChanged,this)}profileType(){return this._profileType}updateStatus(e,t){this.dispatchEventToListeners(xe.UpdateStatus,new ye(e,t))}createSidebarTreeElement(e){throw new Error("Not implemented.")}createView(e){throw new Error("Not implemented.")}removeTempFile(){this.tempFile&&this.tempFile.remove()}dispose(){}canSaveToFile(){return!1}saveToFile(){throw new Error("Not implemented")}loadFromFile(e){throw new Error("Not implemented")}fromFile(){return this._fromFile}setFromFile(){this._fromFile=!0}setProfile(e){}}class ye{constructor(e,t){this.subtitle=e,this.wait=t}}const xe={UpdateStatus:Symbol("UpdateStatus"),ProfileReceived:Symbol("ProfileReceived"),ProfileTitleChanged:Symbol("ProfileTitleChanged")};class Ie extends a.ObjectWrapper{constructor(e,t){super(),this._id=e,this._name=t,this._profiles=[],this._profileBeingRecorded=null,this._nextProfileUid=1,window.opener||window.addEventListener("unload",this._clearTempStorage.bind(this),!1)}typeName(){return""}nextProfileUid(){return this._nextProfileUid}incrementProfileUid(){return this._nextProfileUid++}hasTemporaryView(){return!1}fileExtension(){return null}get buttonTooltip(){return""}get id(){return this._id}get treeItemTitle(){return this._name}get name(){return this._name}buttonClicked(){return!1}get description(){return""}isInstantProfile(){return!1}isEnabled(){return!0}getProfiles(){return this._profiles.filter(function(e){return this._profileBeingRecorded!==e}.bind(this))}customContent(){return null}setCustomContentEnabled(e){}getProfile(e){for(let t=0;t<this._profiles.length;++t)if(this._profiles[t].uid===e)return this._profiles[t];return null}loadFromFile(e){let t=e.name;const i=this.fileExtension();i&&t.endsWith(i)&&(t=t.substr(0,t.length-i.length));const s=this.createProfileLoadedFromFile(t);return s.setFromFile(),this.setProfileBeingRecorded(s),this.addProfile(s),s.loadFromFile(e)}createProfileLoadedFromFile(e){throw new Error("Needs implemented.")}addProfile(e){this._profiles.push(e),this.dispatchEventToListeners(Ee.AddProfileHeader,e)}removeProfile(e){const t=this._profiles.indexOf(e);-1!==t&&(this._profiles.splice(t,1),this._disposeProfile(e))}_clearTempStorage(){for(let e=0;e<this._profiles.length;++e)this._profiles[e].removeTempFile()}profileBeingRecorded(){return this._profileBeingRecorded}setProfileBeingRecorded(e){this._profileBeingRecorded=e}profileBeingRecordedRemoved(){}reset(){for(const e of this._profiles.slice())this._disposeProfile(e);this._profiles=[],this._nextProfileUid=1}_disposeProfile(e){this.dispatchEventToListeners(Ee.RemoveProfileHeader,e),e.dispose(),this._profileBeingRecorded===e&&(this.profileBeingRecordedRemoved(),this.setProfileBeingRecorded(null))}}const Ee={AddProfileHeader:Symbol("add-profile-header"),ProfileComplete:Symbol("profile-complete"),RemoveProfileHeader:Symbol("remove-profile-header"),ViewUpdated:Symbol("view-updated")};var Ne=Object.freeze({__proto__:null,ProfileHeader:Te,StatusUpdate:ye,Events:xe,ProfileType:Ie,ProfileEvents:Ee,DataDisplayDelegate:class{showProfile(e){throw new Error("not implemented")}showObject(e,t){}async linkifyObject(e){throw new Error("not implemented")}}});let Re=null;function De(){return Re}function Fe(e){Re=e}class ke extends C.TreeElement{constructor(e,t,i){super("",!1),this._iconElement=document.createElement("div"),this._iconElement.classList.add("icon"),this._titlesElement=document.createElement("div"),this._titlesElement.classList.add("titles"),this._titlesElement.classList.add("no-subtitle"),this._titleContainer=this._titlesElement.createChild("span","title-container"),this.titleElement=this._titleContainer.createChild("span","title"),this._subtitleElement=this._titlesElement.createChild("span","subtitle"),this.titleElement.textContent=t.title,this._className=i,this._small=!1,this._dataDisplayDelegate=e,this.profile=t,t.addEventListener(xe.UpdateStatus,this._updateStatus,this),t.canSaveToFile()?this._createSaveLink():t.addEventListener(xe.ProfileReceived,this._onProfileReceived,this)}_createSaveLink(){this._saveLinkElement=this._titleContainer.createChild("span","save-link"),this._saveLinkElement.textContent=o.UIString("Save"),this._saveLinkElement.addEventListener("click",this._saveProfile.bind(this),!1)}_onProfileReceived(e){this._createSaveLink()}_updateStatus(e){const t=e.data;null!==t.subtitle&&(this._subtitleElement.textContent=t.subtitle||"",this._titlesElement.classList.toggle("no-subtitle",!t.subtitle)),"boolean"==typeof t.wait&&this.listItemElement&&(this._iconElement.classList.toggle("spinner",t.wait),this.listItemElement.classList.toggle("wait",t.wait))}ondblclick(e){return this._editing||this._startEditing(e.target),!1}_startEditing(e){const t=e.enclosingNodeOrSelfWithClass("title");if(!t)return;const i=new b.Config(this._editingCommitted.bind(this),this._editingCancelled.bind(this));this._editing=b.InplaceEditor.startEditing(t,i)}_editingCommitted(e,t){delete this._editing,this.profile.setTitle(t)}_editingCancelled(){delete this._editing}dispose(){this.profile.removeEventListener(xe.UpdateStatus,this._updateStatus,this),this.profile.removeEventListener(xe.ProfileReceived,this._onProfileReceived,this)}onselect(){return this._dataDisplayDelegate.showProfile(this.profile),!0}ondelete(){return this.profile.profileType().removeProfile(this.profile),!0}onattach(){this._className&&this.listItemElement.classList.add(this._className),this._small&&this.listItemElement.classList.add("small"),this.listItemElement.append(this._iconElement,this._titlesElement),this.listItemElement.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!0),P.setDescription(this.listItemElement,e`${this.profile.profileType().name}`)}_handleContextMenuEvent(e){const t=this.profile,i=new T.ContextMenu(e),s=De();if(!s)throw new Error("File selector element shared by ProfilePanel instances is missing");i.headerSection().appendItem(o.UIString("Load…"),s.click.bind(s)),t.canSaveToFile()&&i.saveSection().appendItem(o.UIString("Save…"),t.saveToFile.bind(t)),i.footerSection().appendItem(o.UIString("Delete"),this.ondelete.bind(this)),i.show()}_saveProfile(e){this.profile.saveToFile()}setSmall(e){this._small=e,this.listItemElement&&this.listItemElement.classList.toggle("small",this._small)}setMainTitle(e){this.titleElement.textContent=e}}var Le=Object.freeze({__proto__:null,setSharedFileSelectorElement:Fe,ProfileSidebarTreeElement:ke});class Me extends ce{constructor(e,t){super(e,t,Boolean(e.children&&e.children.length)),this._remainingChildren=e.children}static _sharedPopulate(e){const t=e._remainingChildren,i=t.length;for(let s=0;s<i;++s)e.appendChild(new Me(t[s],e.tree));e._remainingChildren=[]}static _excludeRecursively(e,t){e._remainingChildren.length>0&&e.populate(),e.save();const i=e.children;let s=e.children.length;for(;s--;)Me._excludeRecursively(i[s],t);const r=e.childrenByCallUID.get(t);r&&ce.merge(e,r,!0)}populateChildren(){Me._sharedPopulate(this)}}class Be extends pe{constructor(e,t,i,s){super(e,t,s),this._remainingChildren=i.children,ce.populate(this)}focus(e){e&&(this.save(),e.savePosition(),this.children=[e],this.total=e.total)}exclude(e){e&&(this.save(),Me._excludeRecursively(this,e.callUID),this.lastComparator&&this.sort(this.lastComparator,!0))}restore(){this._savedChildren&&(this.children[0].restorePosition(),super.restore())}populateChildren(){Me._sharedPopulate(this)}}var Oe=Object.freeze({__proto__:null,TopDownProfileDataGridNode:Me,TopDownProfileDataGridTree:Be});class Ge extends y.SimpleView{constructor(){super(o.UIString("Profile")),this._profile=null,this._searchableView=new x.SearchableView(this,null),this._searchableView.setPlaceholder(o.UIString("Find by cost (>50ms), name or file")),this._searchableView.show(this.element);const t=[];t.push({id:"self",title:this.columnHeader("self"),width:"120px",fixedWidth:!0,sortable:!0,sort:_.Order.Descending,titleDOMFragment:void 0,align:void 0,editable:void 0,nonSelectable:void 0,longText:void 0,disclosure:void 0,weight:void 0,allowInSortByEvenWhenHidden:void 0,dataType:void 0,defaultWeight:void 0}),t.push({id:"total",title:this.columnHeader("total"),width:"120px",fixedWidth:!0,sortable:!0,sort:void 0,titleDOMFragment:void 0,align:void 0,editable:void 0,nonSelectable:void 0,longText:void 0,disclosure:void 0,weight:void 0,allowInSortByEvenWhenHidden:void 0,dataType:void 0,defaultWeight:void 0}),t.push({id:"function",title:o.UIString("Function"),disclosure:!0,sortable:!0,sort:void 0,titleDOMFragment:void 0,align:void 0,editable:void 0,nonSelectable:void 0,longText:void 0,weight:void 0,allowInSortByEvenWhenHidden:void 0,dataType:void 0,defaultWeight:void 0,width:void 0,fixedWidth:void 0}),this.dataGrid=new _.DataGridImpl({displayName:e`Profiler`,columns:t,editCallback:void 0,deleteCallback:void 0,refreshCallback:void 0}),this.dataGrid.addEventListener(_.Events.SortingChanged,this._sortProfile,this),this.dataGrid.addEventListener(_.Events.SelectedNode,this._nodeSelected.bind(this,!0)),this.dataGrid.addEventListener(_.Events.DeselectedNode,this._nodeSelected.bind(this,!1)),this.dataGrid.setRowContextMenuCallback(this._populateContextMenu.bind(this)),this.viewSelectComboBox=new I.ToolbarComboBox(this._changeView.bind(this),e`Profile view mode`),this.focusButton=new I.ToolbarButton(o.UIString("Focus selected function"),"largeicon-visibility"),this.focusButton.setEnabled(!1),this.focusButton.addEventListener(I.ToolbarButton.Events.Click,this._focusClicked,this),this.excludeButton=new I.ToolbarButton(o.UIString("Exclude selected function"),"largeicon-delete"),this.excludeButton.setEnabled(!1),this.excludeButton.addEventListener(I.ToolbarButton.Events.Click,this._excludeClicked,this),this.resetButton=new I.ToolbarButton(o.UIString("Restore all functions"),"largeicon-refresh"),this.resetButton.setEnabled(!1),this.resetButton.addEventListener(I.ToolbarButton.Events.Click,this._resetClicked,this),this._linkifier=new q.Linkifier(Ve),this._nodeFormatter,this._viewType,this.adjustedTotal,this.profileHeader}static buildPopoverTable(e){const t=document.createElement("table");for(const i of e){const e=t.createChild("tr");e.createChild("td").textContent=i.title,e.createChild("td").textContent=i.value}return t}setProfile(e){this._profile=e,this._bottomUpProfileDataGridTree=null,this._topDownProfileDataGridTree=null,this._changeView(),this.refresh()}profile(){return this._profile}initialize(t){this._nodeFormatter=t,this._viewType=l.Settings.instance().createSetting("profileView",He.Heavy);const i=[He.Flame,He.Heavy,He.Tree],s=new Map([[He.Flame,e`Chart`],[He.Heavy,e`Heavy (Bottom Up)`],[He.Tree,e`Tree (Top Down)`]]),r=new Map(i.map((e=>[e,this.viewSelectComboBox.createOption(s.get(e),e)]))),o=this._viewType.get()||i[0],n=r.get(o)||r.get(i[0]);this.viewSelectComboBox.select(n),this._changeView(),this._flameChart&&this._flameChart.update()}focus(){this._flameChart?this._flameChart.focus():super.focus()}columnHeader(e){throw"Not implemented"}selectRange(e,t){this._flameChart&&this._flameChart.selectRange(e,t)}async toolbarItems(){return[this.viewSelectComboBox,this.focusButton,this.excludeButton,this.resetButton]}_getBottomUpProfileDataGridTree(){return this._bottomUpProfileDataGridTree||(this._bottomUpProfileDataGridTree=new me(this._nodeFormatter,this._searchableView,this._profile.root,this.adjustedTotal)),this._bottomUpProfileDataGridTree}_getTopDownProfileDataGridTree(){return this._topDownProfileDataGridTree||(this._topDownProfileDataGridTree=new Be(this._nodeFormatter,this._searchableView,this._profile.root,this.adjustedTotal)),this._topDownProfileDataGridTree}_populateContextMenu(e,t){const i=t;i.linkElement&&!e.containsTarget(i.linkElement)&&e.appendApplicableItems(i.linkElement)}willHide(){this._currentSearchResultIndex=-1}refresh(){if(!this.profileDataGridTree)return;const e=this.dataGrid.selectedNode?this.dataGrid.selectedNode.profileNode:null;this.dataGrid.rootNode().removeChildren();const t=this.profileDataGridTree.children,i=t.length;for(let e=0;e<i;++e)this.dataGrid.rootNode().appendChild(t[e]);e&&(e.selected=!0)}refreshVisibleData(){let e=this.dataGrid.rootNode().children[0];for(;e;)e.refresh(),e=e.traverseNextNode(!1,null,!0)}searchableView(){return this._searchableView}supportsCaseSensitiveSearch(){return!0}supportsRegexSearch(){return!1}searchCanceled(){this._searchableElement&&this._searchableElement.searchCanceled()}performSearch(e,t,i){this._searchableElement&&this._searchableElement.performSearch(e,t,i)}jumpToNextSearchResult(){this._searchableElement&&this._searchableElement.jumpToNextSearchResult()}jumpToPreviousSearchResult(){this._searchableElement&&this._searchableElement.jumpToPreviousSearchResult()}linkifier(){return this._linkifier}createFlameChartDataProvider(){throw"Not implemented"}_ensureFlameChartCreated(){this._flameChart||(this._dataProvider=this.createFlameChartDataProvider(),this._flameChart=new Se(this._searchableView,this._dataProvider),this._flameChart.addEventListener(U.Events.EntryInvoked,(e=>{this._onEntryInvoked(e)})))}async _onEntryInvoked(e){if(!this._dataProvider)return;const t=e.data,i=this._dataProvider._entryNodes[t],s=this.profileHeader._debuggerModel;if(!i||!i.scriptId||!s)return;const r=s.scriptForId(i.scriptId);if(!r)return;const o=s.createRawLocation(r,i.lineNumber,i.columnNumber),n=await re.DebuggerWorkspaceBinding.instance().rawLocationToUILocation(o);d.reveal(n)}_changeView(){if(!this._profile)return;switch(this._searchableView.closeSearch(),this._visibleView&&this._visibleView.detach(),this._viewType.set(this.viewSelectComboBox.selectedOption().value),this._viewType.get()){case He.Flame:this._ensureFlameChartCreated(),this._visibleView=this._flameChart,this._searchableElement=this._flameChart;break;case He.Tree:this.profileDataGridTree=this._getTopDownProfileDataGridTree(),this._sortProfile(),this._visibleView=this.dataGrid.asWidget(),this._searchableElement=this.profileDataGridTree;break;case He.Heavy:this.profileDataGridTree=this._getBottomUpProfileDataGridTree(),this._sortProfile(),this._visibleView=this.dataGrid.asWidget(),this._searchableElement=this.profileDataGridTree}const e=this._viewType.get()===He.Flame;this.focusButton.setVisible(!e),this.excludeButton.setVisible(!e),this.resetButton.setVisible(!e),this._visibleView&&this._visibleView.show(this._searchableView.element)}_nodeSelected(e){this.focusButton.setEnabled(e),this.excludeButton.setEnabled(e)}_focusClicked(e){this.dataGrid.selectedNode&&(this.resetButton.setEnabled(!0),this.resetButton.element.focus(),this.profileDataGridTree&&this.profileDataGridTree.focus(this.dataGrid.selectedNode),this.refresh(),this.refreshVisibleData(),z.actionTaken(j.Action.CpuProfileNodeFocused))}_excludeClicked(e){const t=this.dataGrid.selectedNode;t&&(this.resetButton.setEnabled(!0),this.resetButton.element.focus(),t.deselect(),this.profileDataGridTree&&this.profileDataGridTree.exclude(t),this.refresh(),this.refreshVisibleData(),z.actionTaken(j.Action.CpuProfileNodeExcluded))}_resetClicked(e){this.viewSelectComboBox.selectElement().focus(),this.resetButton.setEnabled(!1),this.profileDataGridTree&&this.profileDataGridTree.restore(),this._linkifier.reset(),this.refresh(),this.refreshVisibleData()}_sortProfile(){if(!this.profileDataGridTree)return;const e=this.dataGrid.isSortOrderAscending(),t=this.dataGrid.sortColumnId(),i="function"===t?"functionName":t||"";this.profileDataGridTree.sort(pe.propertyComparator(i,e),!1),this.refresh()}}const Ve=30,He={Flame:"Flame",Tree:"Tree",Heavy:"Heavy"};class ze extends Te{constructor(e,t,i){super(t,i||o.UIString("Profile %d",t.nextProfileUid())),this._debuggerModel=e}_onChunkTransferred(e){this._jsonifiedProfile&&this.updateStatus(o.UIString("Loading… %d%%",i.bytesToString(this._jsonifiedProfile.length)))}_onError(e){const t=e.error();t&&this.updateStatus(o.UIString("File '%s' read error: %s",e.fileName(),t.message))}async write(e){this._jsonifiedProfile+=e}async close(){}dispose(){this.removeTempFile()}createSidebarTreeElement(e){return new ke(e,this,"profile-sidebar-tree-item")}canSaveToFile(){return!this.fromFile()&&Boolean(this._protocolProfile)}async saveToFile(){const e=new oe.FileOutputStream;if(!this._fileName){const e=s.toISO8601Compact(new Date),t=this.profileType().fileExtension();this._fileName=`${this.profileType().typeName()}-${e}${t}`}if(!await e.open(this._fileName)||!this.tempFile)return;const t=await this.tempFile.read();t&&await e.write(t),e.close()}async loadFromFile(e){this.updateStatus(o.UIString("Loading…"),!0);const t=new oe.ChunkedFileReader(e,1e7,this._onChunkTransferred.bind(this));this._jsonifiedProfile="";if(!await t.read(this))return this._onError(t),new Error(o.UIString("Failed to read file"));this.updateStatus(o.UIString("Parsing…"),!0);let i=null;try{this._profile=JSON.parse(this._jsonifiedProfile),this.setProfile(this._profile),this.updateStatus(o.UIString("Loaded"),!1)}catch(e){i=e,this.profileType().removeProfile(this)}return this._jsonifiedProfile=null,this.profileType().profileBeingRecorded()===this&&this.profileType().setProfileBeingRecorded(null),i}setProtocolProfile(e){this.setProfile(e),this._protocolProfile=e,this.tempFile=new ne.TempFile,this.tempFile.write([JSON.stringify(e)]),this.canSaveToFile()&&this.dispatchEventToListeners(xe.ProfileReceived)}}var je=Object.freeze({__proto__:null,ProfileView:Ge,maxLinkLength:Ve,ViewTypes:He,WritableProfileHeader:ze});class Ue extends Ge{constructor(e){super(),this.profileHeader=e,this.initialize(new $e(this));const t=e.profileModel();this.adjustedTotal=t.profileHead.total,this.adjustedTotal-=t.idleNode?t.idleNode.total:0,this.setProfile(t)}wasShown(){super.wasShown(),A.Performance.instance().reset(),A.Performance.instance().appendCPUProfile(this.profileHeader.profileModel())}columnHeader(t){switch(t){case"self":return o.UIString("Self Time");case"total":return o.UIString("Total Time")}return e``}createFlameChartDataProvider(){return new qe(this.profileHeader.profileModel(),this.profileHeader._cpuProfilerModel)}}class We extends Ie{constructor(){super(We.TypeId,o.UIString("Record JavaScript CPU Profile")),this._recording=!1,J.TargetManager.instance().addModelListener(Q.CPUProfilerModel,Q.Events.ConsoleProfileFinished,this._consoleProfileFinished,this)}profileBeingRecorded(){return super.profileBeingRecorded()}typeName(){return"CPU"}fileExtension(){return".cpuprofile"}get buttonTooltip(){return this._recording?o.UIString("Stop CPU profiling"):o.UIString("Start CPU profiling")}buttonClicked(){return this._recording?(this._stopRecordingProfile(),!1):(this._startRecordingProfile(),!0)}get treeItemTitle(){return o.UIString("CPU PROFILES")}get description(){return o.UIString("CPU profiles show where the execution time is spent in your page's JavaScript functions.")}_consoleProfileFinished(e){const t=e.data,i=t.cpuProfile,s=new Ae(t.cpuProfilerModel,this,t.title);s.setProtocolProfile(i),this.addProfile(s)}_startRecordingProfile(){const e=E.Context.instance().flavor(Q.CPUProfilerModel);if(this.profileBeingRecorded()||!e)return;const t=new Ae(e,this);this.setProfileBeingRecorded(t),J.TargetManager.instance().suspendAllTargets(),this.addProfile(t),t.updateStatus(o.UIString("Recording…")),this._recording=!0,e.startRecording(),z.actionTaken(j.Action.ProfilesCPUProfileTaken)}async _stopRecordingProfile(){this._recording=!1;const e=this.profileBeingRecorded();if(!e||!e._cpuProfilerModel)return;const t=await e._cpuProfilerModel.stopRecording(),i=this.profileBeingRecorded();if(i){if(!t)throw new Error("Expected profile to be non-null");i.setProtocolProfile(t),i.updateStatus(""),this.setProfileBeingRecorded(null)}await J.TargetManager.instance().resumeAllTargets(),this.dispatchEventToListeners(Ee.ProfileComplete,i)}createProfileLoadedFromFile(e){return new Ae(null,this,e)}profileBeingRecordedRemoved(){this._stopRecordingProfile()}}We.TypeId="CPU";class Ae extends ze{constructor(e,t,i){super(e&&e.debuggerModel(),t,i),this._cpuProfilerModel=e}createView(){return new Ue(this)}protocolProfile(){if(!this._protocolProfile)throw new Error("Expected _protocolProfile to be available");return this._protocolProfile}profileModel(){if(!this._profileModel)throw new Error("Expected _profileModel to be available");return this._profileModel}setProfile(e){const t=this._cpuProfilerModel&&this._cpuProfilerModel.target()||null;this._profileModel=new K.CPUProfileDataModel(e,t)}}class $e{constructor(e){this._profileView=e}formatValue(e){return o.UIString("%.1f ms",e)}formatValueAccessibleText(e){return this.formatValue(e)}formatPercent(e,t){if(this._profileView){const i=this._profileView.profile();if(i&&t.profileNode!==i.idleNode)return o.UIString("%.2f %%",e)}return""}linkifyNode(e){const t=this._profileView.profileHeader._cpuProfilerModel,i=t?t.target():null,s={className:"profile-node-file",columnNumber:void 0,tabStop:void 0};return this._profileView.linkifier().maybeLinkifyConsoleCallFrame(i,e.profileNode.callFrame,s)}}class qe extends we{constructor(e,t){super(),this._cpuProfile=e,this._cpuProfilerModel=t}minimumBoundary(){return this._cpuProfile.profileStartTime}totalTime(){return this._cpuProfile.profileHead.total}entryHasDeoptReason(e){const t=this.entryNodes[e];return Boolean(t.deoptReason)}_calculateTimelineData(){const e=[],t=[];let i=5;this._cpuProfile.forEachFrame((function(){t.push(e.length),e.push(null)}),(function(s,r,o,n,a){const l=t.pop();e[l]=new qe.ChartEntry(s,n,o,a,r),i=Math.max(i,s)}));const s=new Array(e.length),r=new Uint16Array(e.length),o=new Float32Array(e.length),n=new Float32Array(e.length),a=new Float64Array(e.length);for(let t=0;t<e.length;++t){const i=e[t];i&&(s[t]=i.node,r[t]=i.depth,o[t]=i.duration,a[t]=i.startTime,n[t]=i.selfTime)}return this._maxStackDepth=i+1,this.entryNodes=s,this.timelineData_=new U.TimelineData(r,o,a,null),this._entrySelfTimes=n,this.timelineData_}prepareHighlightedEntryInfo(t){const i=this.timelineData_,s=this.entryNodes[t];if(!s)return null;const r=[];function n(e,t){r.push({title:e,value:t})}function a(e){return 0===e?"0":e<1e3?o.UIString("%.1f ms",e):Number.secondsToString(e/1e3,!0)}const l=g.beautifyFunctionName(s.functionName);n(e`Name`,l);const d=a(this._entrySelfTimes[t]),h=a(i.entryTotalTimes[t]);n(e`Self time`,d),n(e`Total time`,h);const c=new q.Linkifier,p=c.maybeLinkifyConsoleCallFrame(this._cpuProfilerModel&&this._cpuProfilerModel.target(),s.callFrame);p&&n(e`URL`,p.textContent||""),c.dispose(),n(e`Aggregated self time`,Number.secondsToString(s.self/1e3,!0)),n(e`Aggregated total time`,Number.secondsToString(s.total/1e3,!0));const u=s.deoptReason;return u&&n(e`Not optimized`,u),Ge.buildPopoverTable(r)}}qe.ChartEntry=class{constructor(e,t,i,s,r){this.depth=e,this.duration=t,this.startTime=i,this.selfTime=s,this.node=r}};var Je=Object.freeze({__proto__:null,CPUProfileView:Ue,CPUProfileType:We,CPUProfileHeader:Ae,NodeFormatter:$e,CPUFlameChartDataProvider:qe});class Qe extends S.VBox{constructor(){super(!1),this._items=new N.ListModel,this._list=new R.ListControl(this._items,this,R.ListMode.NonViewport),this._list.element.classList.add("javascript-vm-instances-list"),P.setAccessibleName(this._list.element,e`JavaScript VM instances`),this.contentElement.appendChild(this._list.element),this._itemByIsolate=new Map,this._totalElement=document.createElement("div"),this._totalElement.classList.add("profile-memory-usage-item"),this._totalElement.classList.add("hbox"),this._totalValueDiv=this._totalElement.createChild("div","profile-memory-usage-item-size"),this._totalTrendDiv=this._totalElement.createChild("div","profile-memory-usage-item-trend"),this._totalElement.createChild("div").textContent=e`Total JS heap size`;const t=Math.round(X.MemoryTrendWindowMs/6e4);w.Tooltip.install(this._totalTrendDiv,e`Total page JS heap size change trend over the last ${t} minutes.`),w.Tooltip.install(this._totalValueDiv,e`Total page JS heap size across all VM instances.`),X.IsolateManager.instance().observeIsolates(this),J.TargetManager.instance().addEventListener(J.Events.NameChanged,this._targetChanged,this),J.TargetManager.instance().addEventListener(J.Events.InspectedURLChanged,this._targetChanged,this)}wasShown(){X.IsolateManager.instance().addEventListener(X.Events.MemoryChanged,this._heapStatsChanged,this)}willHide(){X.IsolateManager.instance().removeEventListener(X.Events.MemoryChanged,this._heapStatsChanged,this)}isolateAdded(e){this._list.element.tabIndex=0;const t=new Ke(e),i=t.model().target()===J.TargetManager.instance().mainTarget()?0:this._items.length;this._items.insert(i,t),this._itemByIsolate.set(e,t),(1===this._items.length||e.isMainThread())&&this._list.selectItem(t),this._update()}isolateChanged(e){const t=this._itemByIsolate.get(e);t&&t.updateTitle(),this._update()}isolateRemoved(e){const t=this._itemByIsolate.get(e);t&&this._items.remove(this._items.indexOf(t)),this._itemByIsolate.delete(e),0===this._items.length&&(this._list.element.tabIndex=-1),this._update()}_targetChanged(e){const t=e.data.model(Y.RuntimeModel);if(!t)return;const i=X.IsolateManager.instance().isolateByModel(t),s=i&&this._itemByIsolate.get(i);s&&s.updateTitle()}_heapStatsChanged(e){const t=e.data,i=this._itemByIsolate.get(t);i&&i.updateStats(),this._updateTotal()}_updateTotal(){let e=0,t=0;for(const i of X.IsolateManager.instance().isolates())e+=i.usedHeapSize(),t+=i.usedHeapSizeGrowRate();this._totalValueDiv.textContent=i.bytesToString(e),Qe._formatTrendElement(t,this._totalTrendDiv)}static _formatTrendElement(t,s){const r=1e3*t;if(Math.abs(r)<1e3)return;const o=i.bytesToString(Math.abs(r));let n,a;r>0?(n=e`\u2B06${o}/s`,s.classList.toggle("increasing",!0),a=e`increasing by ${o} per second`):(n=e`\u2B07${o}/s`,s.classList.toggle("increasing",!1),a=e`decreasing by ${o} per second`),s.textContent=n,P.setAccessibleName(s,a)}totalMemoryElement(){return this._totalElement}createElementForItem(e){return e.element}heightForItem(e){return console.assert(!1,"should not be called"),0}updateSelectedItemARIA(e,t){return!1}isItemSelectable(e){return!0}selectedItemChanged(e,t,i,s){i&&i.classList.remove("selected"),s&&s.classList.add("selected");const r=t&&t.model();E.Context.instance().setFlavor(Z.HeapProfilerModel,r&&r.heapProfilerModel()),E.Context.instance().setFlavor(Q.CPUProfilerModel,r&&r.target().model(Q.CPUProfilerModel))}_update(){this._updateTotal(),this._list.invalidateRange(0,this._items.length)}}class Ke{constructor(t){this._isolate=t;const i=Math.round(X.MemoryTrendWindowMs/6e4);this.element=document.createElement("div"),this.element.classList.add("profile-memory-usage-item"),this.element.classList.add("hbox"),P.markAsOption(this.element),this._heapDiv=this.element.createChild("div","profile-memory-usage-item-size"),w.Tooltip.install(this._heapDiv,e`Heap size in use by live JS objects.`),this._trendDiv=this.element.createChild("div","profile-memory-usage-item-trend"),w.Tooltip.install(this._trendDiv,e`Heap size change trend over the last ${i} minutes.`),this._nameDiv=this.element.createChild("div","profile-memory-usage-item-name"),this.updateTitle()}model(){return this._isolate.runtimeModel()}updateStats(){this._heapDiv.textContent=i.bytesToString(this._isolate.usedHeapSize()),Qe._formatTrendElement(this._isolate.usedHeapSizeGrowRate(),this._trendDiv)}updateTitle(){const t=new Map;for(const i of this._isolate.models()){const s=i.target(),r=J.TargetManager.instance().mainTarget()!==s?s.name():"",o=new h.ParsedURL(s.inspectedURL()),n=o.isValid?o.domain():"",a=s.decorateLabel(n&&r?`${n}: ${r}`:r||n||e`(empty)`);t.set(a,(t.get(a)||0)+1)}this._nameDiv.removeChildren();const i=[];for(const[e,s]of t){const t=s>1?`${e} (${s})`:e;i.push(t);const r=this._nameDiv.createChild("div");r.textContent=t,w.Tooltip.install(r,String(t))}}}var Xe=Object.freeze({__proto__:null,IsolateSelector:Qe,ListItem:Ke});class Ye extends S.VBox{constructor(t){super(),this.registerRequiredCSS("profiler/profileLauncherView.css",{enableLegacyPatching:!0}),this._panel=t,this.element.classList.add("profile-launcher-view"),this._contentElement=this.element.createChild("div","profile-launcher-view-content vbox");const i=this._contentElement.createChild("div","vbox");this._selectedProfileTypeSetting=l.Settings.instance().createSetting("selectedProfileType","CPU"),this._profileTypeHeaderElement=i.createChild("h1"),this._profileTypeSelectorForm=i.createChild("form"),P.markAsRadioGroup(this._profileTypeSelectorForm);const s=this._contentElement.createChild("div","vbox profile-isolate-selector-block");s.createChild("h1").textContent=e`Select JavaScript VM instance`;const r=new Qe;r.show(s.createChild("div","vbox profile-launcher-target-list")),s.appendChild(r.totalMemoryElement());const o=this._contentElement.createChild("div","hbox profile-launcher-buttons");this._controlButton=g.createTextButton("",this._controlButtonClicked.bind(this),"",!0),this._loadButton=g.createTextButton(e`Load`,this._loadButtonClicked.bind(this),""),o.appendChild(this._controlButton),o.appendChild(this._loadButton),this._recordButtonEnabled=!0,this._typeIdToOptionElementAndProfileType=new Map}_loadButtonClicked(){this._panel.showLoadFromFileDialog()}_updateControls(){this._isEnabled&&this._recordButtonEnabled?this._controlButton.removeAttribute("disabled"):this._controlButton.setAttribute("disabled",""),w.Tooltip.install(this._controlButton,this._recordButtonEnabled?"":g.anotherProfilerActiveLabel()),this._isInstantProfile?(this._controlButton.classList.remove("running"),this._controlButton.classList.add("primary-button"),this._controlButton.textContent=o.UIString("Take snapshot")):this._isProfiling?(this._controlButton.classList.add("running"),this._controlButton.classList.remove("primary-button"),this._controlButton.textContent=o.UIString("Stop")):(this._controlButton.classList.remove("running"),this._controlButton.classList.add("primary-button"),this._controlButton.textContent=o.UIString("Start"));for(const{optionElement:e}of this._typeIdToOptionElementAndProfileType.values())e.disabled=Boolean(this._isProfiling)}profileStarted(){this._isProfiling=!0,this._updateControls()}profileFinished(){this._isProfiling=!1,this._updateControls()}updateProfileType(e,t){this._isInstantProfile=e.isInstantProfile(),this._recordButtonEnabled=t,this._isEnabled=e.isEnabled(),this._updateControls()}addProfileType(t){const i=g.createRadioLabel("profile-type",t.name);this._profileTypeSelectorForm.appendChild(i);const s=i.radioElement;this._typeIdToOptionElementAndProfileType.set(t.id,{optionElement:s,profileType:t}),s.addEventListener("change",this._profileTypeChanged.bind(this,t),!1);this._profileTypeSelectorForm.createChild("p").textContent=t.description,P.setDescription(s,t.description);const r=t.customContent();r&&(this._profileTypeSelectorForm.createChild("p").appendChild(r),t.setCustomContentEnabled(!1));const o=this._typeIdToOptionElementAndProfileType.size>1?e`Select profiling type`:t.name;this._profileTypeHeaderElement.textContent=o,P.setAccessibleName(this._profileTypeSelectorForm,o)}restoreSelectedProfileType(){let e=this._selectedProfileTypeSetting.get();this._typeIdToOptionElementAndProfileType.has(e)||(e=this._typeIdToOptionElementAndProfileType.keys().next().value,this._selectedProfileTypeSetting.set(e));const t=this._typeIdToOptionElementAndProfileType.get(e);t.optionElement.checked=!0;const i=t.profileType;for(const[t,{profileType:i}]of this._typeIdToOptionElementAndProfileType){const s=t===e;i.setCustomContentEnabled(s)}this.dispatchEventToListeners(Ze.ProfileTypeSelected,i)}_controlButtonClicked(){this._panel.toggleRecord()}_profileTypeChanged(e){const t=this._selectedProfileTypeSetting.get();this._typeIdToOptionElementAndProfileType.get(t).profileType.setCustomContentEnabled(!1),e.setCustomContentEnabled(!0),this.dispatchEventToListeners(Ze.ProfileTypeSelected,e),this._isInstantProfile=e.isInstantProfile(),this._isEnabled=e.isEnabled(),this._updateControls(),this._selectedProfileTypeSetting.set(e.id)}}const Ze={ProfileTypeSelected:Symbol("ProfileTypeSelected")};var et=Object.freeze({__proto__:null,ProfileLauncherView:Ye,Events:Ze});class tt extends S.VBox{constructor(){super(),this.element.id="heap-recording-view",this.element.classList.add("heap-tracking-overview"),this._overviewCalculator=new ot,this._overviewContainer=this.element.createChild("div","heap-overview-container"),this._overviewGrid=new W.OverviewGrid("heap-recording",this._overviewCalculator),this._overviewGrid.element.classList.add("fill"),this._overviewCanvas=this._overviewContainer.createChild("canvas","heap-recording-overview-canvas"),this._overviewContainer.appendChild(this._overviewGrid.element),this._overviewGrid.addEventListener(W.Events.WindowChanged,this._onWindowChanged,this),this._windowLeft=0,this._windowRight=1,this._overviewGrid.setWindow(this._windowLeft,this._windowRight),this._yScale=new st,this._xScale=new st,this._profileSamples=new rt}start(){this._running=!0;const e=()=>{this.update(),this._running&&this.element.window().requestAnimationFrame(e)};e()}stop(){this._running=!1}setSamples(e){this._profileSamples=e,this._running||this.update()}_drawOverviewCanvas(e,t){if(!this._profileSamples)return;const s=this._profileSamples,r=s.sizes,o=s.max,n=s.timestamps,a=n[0],l=this._xScale.nextScale(e/s.totalTime);let d=0;function h(e,t){let i=0,s=0;for(let r=1;r<n.length;++r){const o=Math.floor((n[r]-a)*l);o!==s&&(i&&t(s,i),i=0,s=o),i+=e[r]}t(s,i)}h(r,(function(e,t){d=Math.max(d,t)}));const c=this._yScale.nextScale(d?t/(1.1*d):0);this._overviewCanvas.width=e*window.devicePixelRatio,this._overviewCanvas.height=t*window.devicePixelRatio,this._overviewCanvas.style.width=e+"px",this._overviewCanvas.style.height=t+"px";const p=this._overviewCanvas.getContext("2d");if(!p)throw new Error("Failed to get canvas context");const u=p;if(u.scale(window.devicePixelRatio,window.devicePixelRatio),this._running){u.beginPath(),u.lineWidth=2,u.strokeStyle="rgba(192, 192, 192, 0.6)";const e=(Date.now()-a)*l;u.moveTo(e,t-1),u.lineTo(e,0),u.stroke(),u.closePath()}let _,m=0;if(c){const i=(t-14)/c;_=Math.pow(1024,Math.floor(Math.log(i)/Math.log(1024))),_*=Math.pow(10,Math.floor(Math.log(i/_)/Math.LN10)),5*_<=i&&(_*=5),m=Math.round(t-_*c-.5)+.5,u.beginPath(),u.lineWidth=1,u.strokeStyle="rgba(0, 0, 0, 0.2)",u.moveTo(0,m),u.lineTo(e,m),u.stroke(),u.closePath()}function f(e,i){u.moveTo(e,t-1),u.lineTo(e,Math.round(t-i*c-1))}if(u.beginPath(),u.lineWidth=2,u.strokeStyle="rgba(192, 192, 192, 0.6)",h(o,f),u.stroke(),u.closePath(),u.beginPath(),u.lineWidth=2,u.strokeStyle="rgba(0, 0, 192, 0.8)",h(r,f),u.stroke(),u.closePath(),_){const e=i.bytesToString(_),t=4,s=0,r=m-.5,o=2*t+u.measureText(e).width;u.beginPath(),u.textBaseline="bottom",u.font="10px "+window.getComputedStyle(this.element,null).getPropertyValue("font-family"),u.fillStyle="rgba(255, 255, 255, 0.75)",u.fillRect(s,r-14,o,14),u.fillStyle="rgb(64, 64, 64)",u.fillText(e,s+t,r),u.fill(),u.closePath()}}onResize(){this._updateOverviewCanvas=!0,this._scheduleUpdate()}_onWindowChanged(){this._updateGridTimerId||(this._updateGridTimerId=setTimeout(this.updateGrid.bind(this),10))}_scheduleUpdate(){this._updateTimerId||(this._updateTimerId=setTimeout(this.update.bind(this),10))}_updateBoundaries(){this._windowLeft=this._overviewGrid.windowLeft(),this._windowRight=this._overviewGrid.windowRight(),this._windowWidth=this._windowRight-this._windowLeft}update(){this._updateTimerId=null,this.isShowing()&&(this._updateBoundaries(),this._overviewCalculator._updateBoundaries(this),this._overviewGrid.updateDividers(this._overviewCalculator),this._drawOverviewCanvas(this._overviewContainer.clientWidth,this._overviewContainer.clientHeight-20))}updateGrid(){this._updateGridTimerId=0,this._updateBoundaries();const e=this._profileSamples.ids;if(!e.length)return;const t=this._profileSamples.timestamps,i=this._profileSamples.sizes,s=t[0],r=this._profileSamples.totalTime,o=s+r*this._windowLeft,n=s+r*this._windowRight,a=t.lowerBound(o),l=t.upperBound(n);let d=0;for(let e=a;e<=l;++e)d+=i[e];const h=a>0?e[a-1]:0,c=l<e.length?e[l]:1/0;this.dispatchEventToListeners(it,{minId:h,maxId:c,size:d})}}const it=Symbol("IdsRangeChanged");class st{constructor(){this._lastUpdate=0,this._currentScale=0}nextScale(e){if(e=e||this._currentScale,this._currentScale){const t=Date.now(),s=t-this._lastUpdate;this._lastUpdate=t;const r=20,o=Math.pow(r,s/1e3),n=e/this._currentScale;this._currentScale*=i.clamp(n,1/o,o)}else this._currentScale=e;return this._currentScale}}class rt{constructor(){this.sizes=[],this.ids=[],this.timestamps=[],this.max=[],this.totalTime=3e4}}class ot{constructor(){this._maximumBoundaries=0,this._minimumBoundaries=0,this._xScaleFactor=0}_updateBoundaries(e){this._minimumBoundaries=0,this._maximumBoundaries=e._profileSamples.totalTime,this._xScaleFactor=e._overviewContainer.clientWidth/this._maximumBoundaries}computePosition(e){return(e-this._minimumBoundaries)*this._xScaleFactor}formatValue(e,t){return Number.secondsToString(e/1e3,Boolean(t))}maximumBoundary(){return this._maximumBoundaries}minimumBoundary(){return this._minimumBoundaries}zeroTime(){return this._minimumBoundaries}boundarySpan(){return this._maximumBoundaries-this._minimumBoundaries}}var nt=Object.freeze({__proto__:null,HeapTimelineOverview:tt,IdsRangeChanged:it,SmoothScale:st,Samples:rt,OverviewCalculator:ot});function at(e){return e._profile||e.protocolProfile()}class lt extends Ge{constructor(e){super(),this.profileHeader=e,this._profileType=e.profileType(),this.initialize(new mt(this));const t=new _t(at(e));this.adjustedTotal=t.total,this.setProfile(t),this._selectedSizeText=new I.ToolbarText,this._timestamps=[],this._sizes=[],this._max=[],this._ordinals=[],this._totalTime=0,this._lastOrdinal=0,this._timelineOverview=new tt,ae.experiments.isEnabled("samplingHeapProfilerTimeline")&&(this._timelineOverview.addEventListener(it,this._onIdsRangeChanged.bind(this)),this._timelineOverview.show(this.element,this.element.firstChild),this._timelineOverview.start(),this._profileType.addEventListener(ct.Events.StatsUpdate,this._onStatsUpdate,this),this._profileType.once(Ee.ProfileComplete).then((()=>{this._profileType.removeEventListener(ct.Events.StatsUpdate,this._onStatsUpdate,this),this._timelineOverview.stop(),this._timelineOverview.updateGrid()})))}async toolbarItems(){return[...await super.toolbarItems(),this._selectedSizeText]}_onIdsRangeChanged(t){const s=t.data.minId,r=t.data.maxId;this._selectedSizeText.setText(e`Selected size: ${i.bytesToString(t.data.size)}`),this._setSelectionRange(s,r)}_setSelectionRange(e,t){const i=at(this.profileHeader),s=new _t(i,e,t);this.adjustedTotal=s.total,this.setProfile(s)}_onStatsUpdate(e){const t=e.data;this._totalTime||(this._timestamps=[],this._sizes=[],this._max=[],this._ordinals=[],this._totalTime=3e4,this._lastOrdinal=0),this._sizes.fill(0),this._sizes.push(0),this._timestamps.push(Date.now()),this._ordinals.push(this._lastOrdinal+1);for(const e of t.samples){this._lastOrdinal=Math.max(this._lastOrdinal,e.ordinal);const t=this._ordinals.upperBound(e.ordinal)-1;this._sizes[t]+=e.size}this._max.push(this._sizes[this._sizes.length-1]);this._timestamps[this._timestamps.length-1]-this._timestamps[0]>this._totalTime&&(this._totalTime*=2);const i={sizes:this._sizes,max:this._max,ids:this._ordinals,timestamps:this._timestamps,totalTime:this._totalTime};this._timelineOverview.setSamples(i)}columnHeader(t){switch(t){case"self":return o.UIString("Self Size (bytes)");case"total":return o.UIString("Total Size (bytes)")}return e``}createFlameChartDataProvider(){return new ft(this.profile(),this.profileHeader.heapProfilerModel())}}class dt extends Ie{constructor(e,t){super(e,t),this._recording=!1}profileBeingRecorded(){return super.profileBeingRecorded()}typeName(){return"Heap"}fileExtension(){return".heapprofile"}get buttonTooltip(){return this._recording?e`Stop heap profiling`:e`Start heap profiling`}buttonClicked(){return this._recording?this._stopRecordingProfile():this._startRecordingProfile(),this._recording}_startRecordingProfile(){const t=E.Context.instance().flavor(Z.HeapProfilerModel);if(this.profileBeingRecorded()||!t)return;const i=new pt(t,this);this.setProfileBeingRecorded(i),this.addProfile(i),i.updateStatus(e`Recording…`);const s=v.Icon.create("smallicon-warning");w.Tooltip.install(s,e`Heap profiler is recording`),D.InspectorView.instance().setPanelIcon("heap_profiler",s),this._recording=!0,this._startSampling()}async _stopRecordingProfile(){this._recording=!1;const t=this.profileBeingRecorded();if(!t||!t.heapProfilerModel())return;t.updateStatus(e`Stopping…`);const i=await this._stopSampling();t&&(console.assert(void 0!==i),t.setProtocolProfile(i),t.updateStatus(""),this.setProfileBeingRecorded(null)),D.InspectorView.instance().setPanelIcon("heap_profiler",null),this.dispatchEventToListeners(Ee.ProfileComplete,t)}createProfileLoadedFromFile(e){return new pt(null,this,e)}profileBeingRecordedRemoved(){this._stopRecordingProfile()}_startSampling(){throw"Not implemented"}_stopSampling(){throw"Not implemented"}}let ht;class ct extends dt{constructor(){super(ct.TypeId,e`Allocation sampling`),ht||(ht=this),this._updateTimer=0,this._updateIntervalMs=200}static get instance(){return ht}get treeItemTitle(){return e`SAMPLING PROFILES`}get description(){return e`Record memory allocations using sampling method.
              This profile type has minimal performance overhead and can be used for long running operations.
              It provides good approximation of allocations broken down by JavaScript execution stack.`}hasTemporaryView(){return ae.experiments.isEnabled("samplingHeapProfilerTimeline")}_startSampling(){const e=this._obtainRecordingProfile();e&&(e.startSampling(),ae.experiments.isEnabled("samplingHeapProfilerTimeline")&&(this._updateTimer=window.setTimeout((()=>{this._updateStats()}),this._updateIntervalMs)))}_obtainRecordingProfile(){const e=this.profileBeingRecorded();if(e){return e.heapProfilerModel()}return null}async _stopSampling(){window.clearTimeout(this._updateTimer),this._updateTimer=0,this.dispatchEventToListeners(ct.Events.RecordingStopped);const e=this._obtainRecordingProfile();if(!e)throw new Error("No heap profiler model");const t=await e.stopSampling();if(!t)throw new Error("No sampling profile found");return t}async _updateStats(){const e=this._obtainRecordingProfile();if(!e)return;const t=await e.getSamplingProfile();this._updateTimer&&(this.dispatchEventToListeners(ct.Events.StatsUpdate,t),this._updateTimer=window.setTimeout((()=>{this._updateStats()}),this._updateIntervalMs))}}ct.TypeId="SamplingHeap",ct.Events={RecordingStopped:Symbol("RecordingStopped"),StatsUpdate:Symbol("StatsUpdate")};class pt extends ze{constructor(e,t,i){super(e&&e.debuggerModel(),t,i||o.UIString("Profile %d",t.nextProfileUid())),this._heapProfilerModel=e,this._protocolProfile={head:{callFrame:{functionName:"",scriptId:"",url:"",lineNumber:0,columnNumber:0},children:[],selfSize:0,id:0},samples:[],startTime:0,endTime:0,nodes:[]}}createView(){return new lt(this)}protocolProfile(){return this._protocolProfile}heapProfilerModel(){return this._heapProfilerModel}}class ut extends ee.ProfileNode{constructor(e){super(e.callFrame||{functionName:e.functionName,scriptId:e.scriptId,url:e.url,lineNumber:e.lineNumber-1,columnNumber:e.columnNumber-1}),this.self=e.selfSize}}class _t extends ee.ProfileTreeModel{constructor(e,t,i){super(),this.modules=e.modules||[];let s=null;if(t||i){s=new Map,t=t||0,i=i||1/0;for(const r of e.samples){if(r.ordinal<t||r.ordinal>i)continue;const e=s.get(r.nodeId)||0;s.set(r.nodeId,e+r.size)}}function r(e){return e.children=e.children.filter(r),Boolean(e.children.length||e.self)}this.initialize(function(e){const t=new ut(e),i=[e],o=[t];for(;i.length;){const e=i.pop(),t=o.pop();t.children=e.children.map((e=>{const t=new ut(e);return s&&(t.self=s.get(e.id)||0),t})),i.push(...e.children),o.push(...t.children)}return r(t),t}(e.head))}}class mt{constructor(e){this._profileView=e}formatValue(e){return Number.withThousandsSeparator(e)}formatValueAccessibleText(t){return e`${t} bytes`}formatPercent(e,t){return o.UIString("%.2f %%",e)}linkifyNode(e){const t=this._profileView.profileHeader.heapProfilerModel(),i=t?t.target():null,s={className:"profile-node-file",columnNumber:void 0,tabStop:void 0};return this._profileView.linkifier().maybeLinkifyConsoleCallFrame(i,e.profileNode.callFrame,s)}}class ft extends we{constructor(e,t){super(),this._profile=e,this._heapProfilerModel=t,this._entryNodes=[]}minimumBoundary(){return 0}totalTime(){return this._profile.root.total}entryHasDeoptReason(e){return!1}formatValue(e,t){return o.UIString("%s kB",Number.withThousandsSeparator(e/1e3))}_calculateTimelineData(){const e=function e(t){return t.children.reduce(((t,i)=>t+e(i)),1)}(this._profile.root),t=new Array(e),i=new Uint16Array(e),s=new Float32Array(e),r=new Float64Array(e);let o=0,n=0,a=0,l=0;return function e(d){const h=a;t[l]=d,i[l]=o,s[l]=d.total,r[l]=a,++l,++o,d.children.forEach(e),--o,n=Math.max(n,o),a=h+d.total}(this._profile.root),this._maxStackDepth=n+1,this._entryNodes=t,this._timelineData=new U.TimelineData(i,s,r,null),this._timelineData}prepareHighlightedEntryInfo(t){const s=this._entryNodes[t];if(!s)return null;const r=[];function o(e,t){r.push({title:e,value:t})}o(e`Name`,g.beautifyFunctionName(s.functionName)),o(e`Self size`,i.bytesToString(s.self)),o(e`Total size`,i.bytesToString(s.total));const n=new q.Linkifier,a=n.maybeLinkifyConsoleCallFrame(this._heapProfilerModel?this._heapProfilerModel.target():null,s.callFrame);return a&&o(e`URL`,a.textContent),n.dispose(),Ge.buildPopoverTable(r)}}var gt=Object.freeze({__proto__:null,HeapProfileView:lt,SamplingHeapProfileTypeBase:dt,SamplingHeapProfileType:ct,SamplingHeapProfileHeader:pt,SamplingHeapProfileNode:ut,SamplingHeapProfileModel:_t,NodeFormatter:mt,HeapFlameChartDataProvider:ft});class vt extends _.DataGridNode{constructor(e,t){super(null,t),this._dataGrid=e,this._instanceCount=0,this._savedChildren=new Map,this._retrievedChildrenRanges=[],this._providerObject=null,this._reachableFromWindow=!1}get name(){}heapSnapshotDataGrid(){return this._dataGrid}createProvider(){throw new Error("Not implemented.")}comparator(){throw new Error("Not implemented.")}_getHash(){throw new Error("Not implemented.")}_createChildNode(e){throw new Error("Not implemented.")}retainersDataSource(){return null}_provider(){return this._providerObject||(this._providerObject=this.createProvider()),this._providerObject}createCell(e){return super.createCell(e)}collapse(){super.collapse(),this._dataGrid.updateVisibleNodes(!0)}expand(){super.expand(),this._dataGrid.updateVisibleNodes(!0)}dispose(){this._providerObject&&this._providerObject.dispose();for(let e=this.children[0];e;e=e.traverseNextNode(!0,this,!0))e.dispose()}queryObjectContent(e,t){throw new Error("Not implemented")}tryQueryObjectContent(e,t){throw new Error("Not implemented")}populateContextMenu(e,t,i){}_toPercentString(e){return e.toFixed(0)+" %"}_toUIDistance(e){const t=le.baseSystemDistance;return e>=0&&e<t?o.UIString("%d",e):o.UIString("−")}allChildren(){return this._dataGrid.allChildren(this)}removeChildByIndex(e){this._dataGrid.removeChildByIndex(this,e)}childForPosition(e){let t=0;for(let i=0;i<this._retrievedChildrenRanges.length;i++){const s=this._retrievedChildrenRanges[i];if(s.from<=e&&e<s.to){const i=t+e-s.from;return this.allChildren()[i]}t+=s.to-s.from+1}return null}_createValueCell(t){const i=F.html`<td class="numeric-column" />`,s=this.dataGrid;if(s.snapshot&&0!==s.snapshot.totalSize){const s=document.createElement("div"),r=F.html`<span>${this.data[t]}</span>`;s.appendChild(r);const o=t+"-percent";if(o in this.data){const n=F.html`<span class="percent-column">${this.data[o]}</span>`;s.appendChild(n),s.classList.add("profile-multiple-values"),P.markAsHidden(r),P.markAsHidden(n),this.setCellAccessibleName(e`${this.data[t]}, ${this.data[o]}`,i,t)}i.appendChild(s)}return i}populate(){this._populated||(this._populated=!0,this._provider().sortAndRewind(this.comparator()).then((()=>this._populateChildren())))}expandWithoutPopulate(){return this._populated=!0,this.expand(),this._provider().sortAndRewind(this.comparator())}_childHashForEntity(e){return"edgeIndex"in e?e.edgeIndex:e.id}_populateChildren(e,t){return new Promise((i=>{e=e||0,t=t||e+this._dataGrid.defaultPopulateCount();let s=e;function r(e){if(s>=e)return;const t=Math.min(s+this._dataGrid.defaultPopulateCount(),e);this._provider().serializeItemsRange(s,t).then((t=>a.call(this,t,e))),s=t}function o(e,t){if(this._savedChildren){const i=this._childHashForEntity(e),s=this._savedChildren.get(i);if(s)return void this._dataGrid.insertChild(this,s,t)}this._dataGrid.insertChild(this,this._createChildNode(e),t)}function n(e,t,i){const s=new m.ShowMoreDataGridNode(this._populateChildren.bind(this),e,t,this._dataGrid.defaultPopulateCount());this._dataGrid.insertChild(this,s,i)}function a(e,t){let a=0,l=e.startPosition;const d=e.items;let h=0;if(this._retrievedChildrenRanges.length){let t=0,i=!1,s={from:0,to:0};for(;t<this._retrievedChildrenRanges.length;){if(s=this._retrievedChildrenRanges[t],s.to>=l){i=!0;break}h+=s.to-s.from,s.to<e.totalLength&&(h+=1),++t}if(!i||e.startPosition<s.from){this.allChildren()[h-1].setEndPosition(e.startPosition),n.call(this,e.startPosition,i?s.from:e.totalLength,h),s={from:e.startPosition,to:e.startPosition},i||(t=this._retrievedChildrenRanges.length),this._retrievedChildrenRanges.splice(t,0,s)}else h+=l-s.from;for(;s.to<e.endPosition;){const i=s.to-l;h+=i,a+=i,l=s.to;const r=this._retrievedChildrenRanges[t+1];let n=r?r.from:e.totalLength;for(n>e.endPosition&&(n=e.endPosition);l<n;)o.call(this,d[a++],h++),++l;r&&n===r.from?(s.to=r.to,this.removeChildByIndex(h),this._retrievedChildrenRanges.splice(t+1,1)):(s.to=n,n===e.totalLength?this.removeChildByIndex(h):this.allChildren()[h].setStartPosition(e.endPosition))}}else{e.startPosition>0&&(this._retrievedChildrenRanges.push({from:0,to:0}),n.call(this,0,e.startPosition,h++)),this._retrievedChildrenRanges.push({from:e.startPosition,to:e.endPosition});for(let e=0,t=d.length;e<t;++e)o.call(this,d[e],h++);e.endPosition<e.totalLength&&n.call(this,e.endPosition,e.totalLength,h++)}this._instanceCount+=d.length,s<t?r.call(this,t):(this.expanded&&this._dataGrid.updateVisibleNodes(!0),i(),this.dispatchEventToListeners(vt.Events.PopulateComplete))}r.call(this,t)}))}_saveChildren(){this._savedChildren.clear();const e=this.allChildren();for(let t=0,i=e.length;t<i;++t){const i=e[t];i.expanded&&this._savedChildren.set(i._getHash(),i)}}async sort(){this._dataGrid.recursiveSortingEnter(),await this._provider().sortAndRewind(this.comparator()),this._saveChildren(),this._dataGrid.removeAllChildren(this),this._retrievedChildrenRanges=[];const e=this._instanceCount;this._instanceCount=0,await this._populateChildren(0,e);for(const e of this.allChildren())e.expanded&&e.sort();this._dataGrid.recursiveSortingLeave()}}vt.Events={PopulateComplete:Symbol("PopulateComplete")};class wt extends vt{constructor(e,t){if(super(e,!1),!t)return;this._referenceName=null,this._name=t.name,this._type=t.type,this._distance=t.distance,this._shallowSize=t.selfSize,this._retainedSize=t.retainedSize,this.snapshotNodeId=t.id,this.snapshotNodeIndex=t.nodeIndex,"string"===this._type?this._reachableFromWindow=!0:"object"===this._type&&this._name.startsWith("Window")?(this._name=this.shortenWindowURL(this._name,!1),this._reachableFromWindow=!0):t.canBeQueried&&(this._reachableFromWindow=!0),t.detachedDOMTreeNode&&(this.detachedDOMTreeNode=!0);const i=e.snapshot,s=this._shallowSize/i.totalSize*100,r=this._retainedSize/i.totalSize*100;this.data={distance:this._toUIDistance(this._distance),shallowSize:Number.withThousandsSeparator(this._shallowSize),retainedSize:Number.withThousandsSeparator(this._retainedSize),"shallowSize-percent":this._toPercentString(s),"retainedSize-percent":this._toPercentString(r)}}get name(){return this._name}retainersDataSource(){return void 0===this.snapshotNodeIndex?null:{snapshot:this._dataGrid.snapshot,snapshotNodeIndex:this.snapshotNodeIndex}}createCell(e){return"object"!==e?this._createValueCell(e):this._createObjectCell()}_createObjectCell(){let t=this._name,i="object";switch(this._type){case"concatenated string":case"string":t=`"${t}"`,i="string";break;case"regexp":t=`/${t}/`,i="string";break;case"closure":t+="()",i="function";break;case"bigint":i="bigint";break;case"number":i="number";break;case"hidden":i="null";break;case"array":t=t?t+"[]":e`(internal array)[]`}return this._createObjectCellWithValue(i,t||"")}_createObjectCellWithValue(t,i){const s=F.Fragment.build`
        <td class="object-column disclosure">
          <div class="source-code event-properties" style="overflow: visible" $="container">
            <span class="value object-value-${t}">${i}</span>
            <span class="object-value-id">@${this.snapshotNodeId}</span>
          </div>
        </td>`,r=s.$("container");this._prefixObjectCell(r),this._reachableFromWindow&&r.appendChild(F.html`<span class="heap-object-tag" title="${e`User object reachable from window`}">🗖</span>`),this.detachedDOMTreeNode&&r.appendChild(F.html`<span class="heap-object-tag" title="${e`Detached from DOM tree`}">✀</span>`),this._appendSourceLocation(r);const o=s.element();return this.depth&&o.style.setProperty("padding-left",this.depth*this.dataGrid.indentWidth+"px"),o}_prefixObjectCell(e){}async _appendSourceLocation(e){const t=F.html`<span class="heap-object-source-link" />`;e.appendChild(t);const i=await this._dataGrid.dataDisplayDelegate().linkifyObject(this.snapshotNodeIndex);i?(t.appendChild(i),this.linkElement=i):t.remove()}async queryObjectContent(t,i){return await this.tryQueryObjectContent(t,i)||t.runtimeModel().createRemoteObjectFromPrimitiveValue(e`Preview is not available`)}async tryQueryObjectContent(e,t){return"string"===this._type?e.runtimeModel().createRemoteObjectFromPrimitiveValue(this._name):await e.objectForSnapshotObjectId(String(this.snapshotNodeId),t)}async updateHasChildren(){const e=await this._provider().isEmpty();this.setHasChildren(!e)}shortenWindowURL(e,t){const i=e.indexOf("/"),s=t?e.indexOf("@"):e.length;if(-1===i||-1===s)return e;const o=e.substring(i+1,s).trimLeft();let n=r.trimURL(o);return n.length>40&&(n=n.trimMiddle(40)),e.substr(0,i+2)+n+e.substr(s)}populateContextMenu(t,i,s){if(t.revealSection().appendItem(e`Reveal in Summary view`,(()=>{i.showObject(String(this.snapshotNodeId),e`Summary`)})),this._referenceName)for(const s of this._referenceName.matchAll(/\((?<objectName>[^@)]*) @(?<snapshotNodeId>\d+)\)/g)){const{objectName:r,snapshotNodeId:o}=s.groups;t.revealSection().appendItem(e`Reveal object '${r}' with id @${o} in Summary view`,(()=>{i.showObject(o,e`Summary`)}))}s&&t.revealSection().appendItem(e`Store as global variable`,(async()=>{const t=await this.tryQueryObjectContent(s,"");t?await te.ConsoleModel.instance().saveToTempVariable(E.Context.instance().flavor(Y.ExecutionContext),t):c.Console.instance().error(e`Preview is not available`)}))}}class St extends wt{constructor(e,t,i,s){super(e,i.node),this._referenceName=i.name,this._referenceType=i.type,this._edgeIndex=i.edgeIndex,this._snapshot=t,this._parentObjectNode=s,this._cycledWithAncestorGridNode=this._findAncestorWithSameSnapshotNodeId(),this._cycledWithAncestorGridNode||this.updateHasChildren();const r=this.data;r.count="",r.addedCount="",r.removedCount="",r.countDelta="",r.addedSize="",r.removedSize="",r.sizeDelta=""}retainersDataSource(){return void 0===this.snapshotNodeIndex?null:{snapshot:this._snapshot,snapshotNodeIndex:this.snapshotNodeIndex}}createProvider(){if(void 0===this.snapshotNodeIndex)throw new Error("Cannot create a provider on a root node");return this._snapshot.createEdgesProvider(this.snapshotNodeIndex)}_findAncestorWithSameSnapshotNodeId(){let e=this._parentObjectNode;for(;e;){if(e.snapshotNodeId===this.snapshotNodeId)return e;e=e._parentObjectNode}return null}_createChildNode(e){return new St(this._dataGrid,this._snapshot,e,this)}_getHash(){return this._edgeIndex}comparator(){const e=this._dataGrid.isSortOrderAscending();switch(this._dataGrid.sortColumnId()){case"object":return new le.ComparatorConfig("!edgeName",e,"retainedSize",!1);case"count":return new le.ComparatorConfig("!edgeName",!0,"retainedSize",!1);case"shallowSize":return new le.ComparatorConfig("selfSize",e,"!edgeName",!0);case"retainedSize":return new le.ComparatorConfig("retainedSize",e,"!edgeName",!0);case"distance":return new le.ComparatorConfig("distance",e,"_name",!0);default:return new le.ComparatorConfig("!edgeName",!0,"retainedSize",!1)}}_prefixObjectCell(e){let t=this._referenceName||"(empty)",i="name";switch(this._referenceType){case"context":i="object-value-number";break;case"internal":case"hidden":case"weak":i="object-value-null";break;case"element":t=`[${t}]`}this._cycledWithAncestorGridNode&&e.classList.add("cycled-ancessor-node"),e.prepend(F.html`<span class="property-name ${i}">${t}</span>
                        <span class="grayed">${this._edgeNodeSeparator()}</span>`)}_edgeNodeSeparator(){return"::"}}class Ct extends St{constructor(e,t,i,s){super(e,t,i,s)}createProvider(){if(void 0===this.snapshotNodeIndex)throw new Error("Cannot create providers on root nodes");return this._snapshot.createRetainingEdgesProvider(this.snapshotNodeIndex)}_createChildNode(e){return new Ct(this._dataGrid,this._snapshot,e,this)}_edgeNodeSeparator(){return e`in`}expand(){this._expandRetainersChain(20)}_expandRetainersChain(e){if(!this._populated)return this.once(vt.Events.PopulateComplete).then((()=>this._expandRetainersChain(e))),void this.populate();if(super.expand(),--e>0&&this.children.length>0){const t=this.children[0];if((t._distance||0)>1)return void t._expandRetainersChain(e)}this._dataGrid.dispatchEventToListeners(Lt.ExpandRetainersComplete)}}class bt extends wt{constructor(e,t,i,s){super(e,i),this._baseSnapshotOrSnapshot=t,this._isDeletedNode=s,this.updateHasChildren();const r=this.data;r.count="",r.countDelta="",r.sizeDelta="",this._isDeletedNode?(r.addedCount="",r.addedSize="",r.removedCount="•",r.removedSize=Number.withThousandsSeparator(this._shallowSize||0)):(r.addedCount="•",r.addedSize=Number.withThousandsSeparator(this._shallowSize||0),r.removedCount="",r.removedSize="")}retainersDataSource(){return void 0===this.snapshotNodeIndex?null:{snapshot:this._baseSnapshotOrSnapshot,snapshotNodeIndex:this.snapshotNodeIndex}}createProvider(){if(void 0===this.snapshotNodeIndex)throw new Error("Cannot create providers on root nodes");return this._baseSnapshotOrSnapshot.createEdgesProvider(this.snapshotNodeIndex)}_createChildNode(e){return new St(this._dataGrid,this._baseSnapshotOrSnapshot,e,null)}_getHash(){if(void 0===this.snapshotNodeId)throw new Error("Cannot hash root nodes");return this.snapshotNodeId}comparator(){const e=this._dataGrid.isSortOrderAscending();switch(this._dataGrid.sortColumnId()){case"object":return new le.ComparatorConfig("!edgeName",e,"retainedSize",!1);case"distance":return new le.ComparatorConfig("distance",e,"retainedSize",!1);case"count":return new le.ComparatorConfig("!edgeName",!0,"retainedSize",!1);case"addedSize":case"removedSize":case"shallowSize":return new le.ComparatorConfig("selfSize",e,"!edgeName",!0);case"retainedSize":return new le.ComparatorConfig("retainedSize",e,"!edgeName",!0);default:return new le.ComparatorConfig("!edgeName",!0,"retainedSize",!1)}}}class Pt extends vt{constructor(e,t,i,s){super(e,i.count>0),this._name=t,this._nodeFilter=s,this._distance=i.distance,this._count=i.count,this._shallowSize=i.self,this._retainedSize=i.maxRet;const r=e.snapshot,o=this._retainedSize/r.totalSize*100,n=this._shallowSize/r.totalSize*100;this.data={object:t,count:Number.withThousandsSeparator(this._count),distance:this._toUIDistance(this._distance),shallowSize:Number.withThousandsSeparator(this._shallowSize),retainedSize:Number.withThousandsSeparator(this._retainedSize),"shallowSize-percent":this._toPercentString(n),"retainedSize-percent":this._toPercentString(o)}}get name(){return this._name}createProvider(){return this._dataGrid.snapshot.createNodesProviderForClass(this._name,this._nodeFilter)}async populateNodeBySnapshotObjectId(e){this._dataGrid.resetNameFilter(),await this.expandWithoutPopulate();const t=await this._provider().nodePosition(e);if(-1===t)return this.collapse(),[];await this._populateChildren(t,null);const i=this.childForPosition(t);return i?[this,i]:[]}filteredOut(e){return-1===this._name.toLowerCase().indexOf(e)}createCell(e){const t="object"===e?super.createCell(e):this._createValueCell(e);return"object"===e&&this._count>1&&t.appendChild(F.html`<span class="objects-count">×${this._count}</span>`),t}_createChildNode(e){return new bt(this._dataGrid,this._dataGrid.snapshot,e,!1)}comparator(){const e=this._dataGrid.isSortOrderAscending(),t=this._dataGrid.sortColumnId();switch(t){case"object":return new le.ComparatorConfig("name",e,"id",!0);case"distance":return new le.ComparatorConfig("distance",e,"retainedSize",!1);case"shallowSize":return new le.ComparatorConfig("selfSize",e,"id",!0);case"retainedSize":return new le.ComparatorConfig("retainedSize",e,"id",!0);default:throw new Error("Invalid sort column id "+t)}}}class Tt{constructor(e,t,i,s){this._addedNodesProvider=e,this._deletedNodesProvider=t,this._addedCount=i,this._removedCount=s}dispose(){this._addedNodesProvider.dispose(),this._deletedNodesProvider.dispose()}nodePosition(e){throw new Error("Unreachable")}isEmpty(){return Promise.resolve(!1)}async serializeItemsRange(e,t){let i,s;if(e<this._addedCount){i=await this._addedNodesProvider.serializeItemsRange(e,t);for(const e of i.items)e.isAddedNotRemoved=!0;if(i.endPosition>=t)return i.totalLength=this._addedCount+this._removedCount,i;s=i,i=await this._deletedNodesProvider.serializeItemsRange(0,t-i.endPosition)}else s=new le.ItemsRange(0,0,0,[]),i=await this._deletedNodesProvider.serializeItemsRange(e-this._addedCount,t-this._addedCount);s.items.length||(s.startPosition=this._addedCount+i.startPosition);for(const e of i.items)e.isAddedNotRemoved=!1;return s.items.push(...i.items),s.endPosition=this._addedCount+i.endPosition,s.totalLength=this._addedCount+this._removedCount,s}async sortAndRewind(e){await this._addedNodesProvider.sortAndRewind(e),await this._deletedNodesProvider.sortAndRewind(e)}}class yt extends vt{constructor(e,t,i){super(e,!0),this._name=t,this._addedCount=i.addedCount,this._removedCount=i.removedCount,this._countDelta=i.countDelta,this._addedSize=i.addedSize,this._removedSize=i.removedSize,this._sizeDelta=i.sizeDelta,this._deletedIndexes=i.deletedIndexes,this.data={object:t,addedCount:Number.withThousandsSeparator(this._addedCount),removedCount:Number.withThousandsSeparator(this._removedCount),countDelta:this._signForDelta(this._countDelta)+Number.withThousandsSeparator(Math.abs(this._countDelta)),addedSize:Number.withThousandsSeparator(this._addedSize),removedSize:Number.withThousandsSeparator(this._removedSize),sizeDelta:this._signForDelta(this._sizeDelta)+Number.withThousandsSeparator(Math.abs(this._sizeDelta))}}get name(){return this._name}createProvider(){const e=this._dataGrid;if(null===e.snapshot||void 0===e.baseSnapshot||void 0===e.baseSnapshot.uid)throw new Error("Data sources have not been set correctly");const t=e.snapshot.createAddedNodesProvider(e.baseSnapshot.uid,this._name),i=e.baseSnapshot.createDeletedNodesProvider(this._deletedIndexes);if(!t||!i)throw new Error("Failed to create node providers");return new Tt(t,i,this._addedCount,this._removedCount)}createCell(e){const t=super.createCell(e);return"object"!==e&&t.classList.add("numeric-column"),t}_createChildNode(e){const t=this._dataGrid;if(e.isAddedNotRemoved){if(null===t.snapshot)throw new Error("Data sources have not been set correctly");return new bt(this._dataGrid,t.snapshot,e,!1)}if(void 0===t.baseSnapshot)throw new Error("Data sources have not been set correctly");return new bt(this._dataGrid,t.baseSnapshot,e,!0)}comparator(){const e=this._dataGrid.isSortOrderAscending(),t=this._dataGrid.sortColumnId();switch(t){case"object":return new le.ComparatorConfig("name",e,"id",!0);case"addedCount":case"removedCount":case"countDelta":return new le.ComparatorConfig("name",!0,"id",!0);case"addedSize":case"removedSize":case"sizeDelta":return new le.ComparatorConfig("selfSize",e,"id",!0);default:throw new Error("Invalid sort column "+t)}}filteredOut(e){return-1===this._name.toLowerCase().indexOf(e)}_signForDelta(e){return 0===e?"":e>0?"+":"−"}}class xt extends vt{constructor(e,t){super(e,t.hasChildren),this._populated=!1,this._allocationNode=t,this.data={liveCount:Number.withThousandsSeparator(t.liveCount),count:Number.withThousandsSeparator(t.count),liveSize:Number.withThousandsSeparator(t.liveSize),size:Number.withThousandsSeparator(t.size),name:t.name}}populate(){this._populated||this._doPopulate()}async _doPopulate(){this._populated=!0;const e=await this._dataGrid.snapshot.allocationNodeCallers(this._allocationNode.id),t=e.nodesWithSingleCaller;let i=this;const s=this._dataGrid;for(const e of t){const t=new xt(s,e);s.appendNode(i,t),i=t,i._populated=!0,this.expanded&&i.expand()}const r=e.branchingCallers;r.sort(this._dataGrid.createComparator());for(const e of r)s.appendNode(i,new xt(s,e));s.updateVisibleNodes(!0)}expand(){super.expand(),1===this.children.length&&this.children[0].expand()}createCell(e){if("name"!==e)return this._createValueCell(e);const t=super.createCell(e),i=this._allocationNode,s=this._dataGrid.heapProfilerModel();if(i.scriptId){const e=this._dataGrid.linkifier.linkifyScriptLocation(s?s.target():null,String(i.scriptId),i.scriptName,i.line-1,{columnNumber:i.column-1,className:"profile-node-file",tabStop:void 0});e.style.maxWidth="75%",t.insertBefore(e,t.firstChild)}return t}allocationNodeId(){return this._allocationNode.id}}var It=Object.freeze({__proto__:null,HeapSnapshotGridNode:vt,HeapSnapshotGenericObjectNode:wt,HeapSnapshotObjectNode:St,HeapSnapshotRetainingObjectNode:Ct,HeapSnapshotInstanceNode:bt,HeapSnapshotConstructorNode:Pt,HeapSnapshotDiffNodesProvider:Tt,HeapSnapshotDiffNode:yt,AllocationGridNode:xt});const Et=new WeakMap;class Nt extends _.DataGridImpl{constructor(t,i,s){super(s),this.snapshot=null,this.selectedNode=null,this._heapProfilerModel=t,this._dataDisplayDelegate=i;const r=[["distance",e`Distance from window object`],["shallowSize",e`Size of the object itself in bytes`],["retainedSize",e`Size of the object plus the graph it retains in bytes`]];for(const e of r){const t=this.headerTableHeader(e[0]);t&&t.setAttribute("title",e[1])}this._recursiveSortingDepth=0,this._highlightedNode=null,this._populatedAndSorted=!1,this._nameFilter=null,this._nodeFilter=new le.NodeFilter,this.addEventListener(Rt.SortingComplete,this._sortingComplete,this),this.addEventListener(_.Events.SortingChanged,this.sortingChanged,this),this.setRowContextMenuCallback(this._populateContextMenu.bind(this))}async setDataSource(e,t){}_isFilteredOut(e){const t=this._nameFilter?this._nameFilter.value().toLowerCase():"";return!!(t&&(e instanceof yt||e instanceof Pt)&&e.filteredOut(t))}heapProfilerModel(){return this._heapProfilerModel}dataDisplayDelegate(){return this._dataDisplayDelegate}nodeFilter(){return this._nodeFilter}setNameFilter(e){this._nameFilter=e}defaultPopulateCount(){return 100}_disposeAllNodes(){const e=this.topLevelNodes();for(let t=0,i=e.length;t<i;++t)e[t].dispose()}wasShown(){this._nameFilter&&(this._nameFilter.addEventListener(I.ToolbarInput.Event.TextChanged,this._onNameFilterChanged,this),this.updateVisibleNodes(!0)),this._populatedAndSorted&&this.dispatchEventToListeners(Rt.ContentShown,this)}_sortingComplete(){this.removeEventListener(Rt.SortingComplete,this._sortingComplete,this),this._populatedAndSorted=!0,this.dispatchEventToListeners(Rt.ContentShown,this)}willHide(){this._nameFilter&&this._nameFilter.removeEventListener(I.ToolbarInput.Event.TextChanged,this._onNameFilterChanged,this),this._clearCurrentHighlight()}_populateContextMenu(e,t){const i=t;i.populateContextMenu(e,this._dataDisplayDelegate,this.heapProfilerModel()),i instanceof wt&&i.linkElement&&!e.containsTarget(i.linkElement)&&e.appendApplicableItems(i.linkElement)}resetSortingCache(){delete this._lastSortColumnId,delete this._lastSortAscending}topLevelNodes(){return this.rootNode().children}revealObjectByHeapSnapshotId(e){return Promise.resolve(null)}highlightNode(e){this._clearCurrentHighlight(),this._highlightedNode=e,g.runCSSAnimationOnce(this._highlightedNode.element(),"highlighted-row")}_clearCurrentHighlight(){this._highlightedNode&&(this._highlightedNode.element().classList.remove("highlighted-row"),this._highlightedNode=null)}resetNameFilter(){this._nameFilter&&this._nameFilter.setValue("")}_onNameFilterChanged(){this.updateVisibleNodes(!0),this._deselectFilteredNodes()}_deselectFilteredNodes(){let e=this.selectedNode;for(;e;){if(this.selectedNode&&this._isFilteredOut(e))return this.selectedNode.deselect(),void(this.selectedNode=null);e=e.parent}}_sortFields(e,t){throw new Error("Not implemented")}sortingChanged(){const e=this.isSortOrderAscending(),t=this.sortColumnId();if(this._lastSortColumnId===t&&this._lastSortAscending===e)return;this._lastSortColumnId=t,this._lastSortAscending=e;const i=this._sortFields(t||"",e);this._performSorting((function(e,t){let s=e[i.fieldName1],r=t[i.fieldName1],o=s<r?-1:s>r?1:0;return i.ascending1||(o=-o),0!==o||(s=e[i.fieldName2],r=t[i.fieldName2],o=s<r?-1:s>r?1:0,i.ascending2||(o=-o)),o}))}_performSorting(e){this.recursiveSortingEnter();const t=this.allChildren(this.rootNode());this.rootNode().removeChildren(),t.sort(e);for(let e=0,i=t.length;e<i;++e){const i=t[e];this.appendChildAfterSorting(i),i.expanded&&i.sort()}this.recursiveSortingLeave()}appendChildAfterSorting(e){const t=e.revealed;this.rootNode().appendChild(e),e.revealed=t}recursiveSortingEnter(){++this._recursiveSortingDepth}recursiveSortingLeave(){this._recursiveSortingDepth&&(--this._recursiveSortingDepth||(this.updateVisibleNodes(!0),this.dispatchEventToListeners(Rt.SortingComplete)))}updateVisibleNodes(e){}allChildren(e){return e.children}insertChild(e,t,i){e.insertChild(t,i)}removeChildByIndex(e,t){e.removeChild(e.children[t])}removeAllChildren(e){e.removeChildren()}}const Rt={ContentShown:Symbol("ContentShown"),SortingComplete:Symbol("SortingComplete")};class Dt extends Nt{constructor(e,t,i){super(e,t,i),this.scrollContainer.addEventListener("scroll",this._onScroll.bind(this),!0),this._topPaddingHeight=0,this._bottomPaddingHeight=0,this.selectedNode=null}topLevelNodes(){return this.allChildren(this.rootNode())}appendChildAfterSorting(e){}updateVisibleNodes(e){const t=this.scrollContainer.scrollHeight;let i=this.scrollContainer.scrollTop,s=t-i-this.scrollContainer.offsetHeight;i=Math.max(0,i-40),s=Math.max(0,s-40);let r=t-i-s;if(!e&&i>=this._topPaddingHeight&&s>=this._bottomPaddingHeight)return;i-=500,r+=1e3;const o=this.selectedNode;this.rootNode().removeChildren(),this._topPaddingHeight=0,this._bottomPaddingHeight=0,this._addVisibleNodes(this.rootNode(),i,i+r),this.setVerticalPadding(this._topPaddingHeight,this._bottomPaddingHeight),o&&(o.parent?o.select(!0):this.selectedNode=o)}_addVisibleNodes(e,t,i){if(!e.expanded)return 0;const s=this.allChildren(e);let r=0,o=0;for(;o<s.length;++o){const e=s[o];if(this._isFilteredOut(e))continue;const i=r+this._nodeHeight(e);if(i>t)break;r=i}let n=r;for(;o<s.length&&n<i;++o){const r=s[o];if(this._isFilteredOut(r))continue;const a=r.hasChildren();r.removeChildren(),r.setHasChildren(a),e.appendChild(r),n+=r.nodeSelfHeight(),n+=this._addVisibleNodes(r,t-n,i-n)}let a=0;for(;o<s.length;++o){const e=s[o];this._isFilteredOut(e)||(a+=this._nodeHeight(e))}return this._topPaddingHeight+=r,this._bottomPaddingHeight+=a,n+a}_nodeHeight(e){let t=e.nodeSelfHeight();if(!e.expanded)return t;const i=this.allChildren(e);for(let e=0;e<i.length;e++)t+=this._nodeHeight(i[e]);return t}revealTreeNode(e){const t=this._calculateOffset(e),i=e[e.length-1],s=this.scrollContainer.scrollTop,r=s+this.scrollContainer.offsetHeight;if(t>=s&&t<r)return Promise.resolve(i);return this.scrollContainer.scrollTop=Math.max(0,t-40),new Promise((e=>{console.assert(!this._scrollToResolveCallback),this._scrollToResolveCallback=e.bind(null,i),this.scrollContainer.window().requestAnimationFrame((()=>{this._scrollToResolveCallback&&(this._scrollToResolveCallback(),this._scrollToResolveCallback=null)}))}))}_calculateOffset(e){let t=this.rootNode(),i=0;if(0===e.length)return 0;for(let s=0;s<e.length;++s){const r=e[s],o=this.allChildren(t);for(let e=0;e<o.length;++e){const t=o[e];if(r===t){i+=r.nodeSelfHeight();break}i+=this._nodeHeight(t)}t=r}return i-e[e.length-1].nodeSelfHeight()}allChildren(e){const t=Et.get(e)||[];return Et.has(e)||Et.set(e,t),t}appendNode(e,t){this.allChildren(e).push(t)}insertChild(e,t,i){this.allChildren(e).splice(i,0,t)}removeChildByIndex(e,t){this.allChildren(e).splice(t,1)}removeAllChildren(e){Et.delete(e)}removeTopLevelNodes(){this._disposeAllNodes(),this.rootNode().removeChildren(),this.removeAllChildren(this.rootNode())}_isScrolledIntoView(e){const t=this.scrollContainer.scrollTop,i=t+this.scrollContainer.clientHeight,s=e.offsetTop;return s+e.offsetHeight<=i&&s>=t}onResize(){super.onResize(),this.updateVisibleNodes(!1)}_onScroll(e){this.updateVisibleNodes(!1),this._scrollToResolveCallback&&(this._scrollToResolveCallback(),this._scrollToResolveCallback=null)}}class Ft extends Nt{constructor(t,i,s,r){super(t,i,{displayName:s,columns:r=r||[{id:"object",title:e`Object`,disclosure:!0,sortable:!0},{id:"distance",title:e`Distance`,width:"70px",sortable:!0,fixedWidth:!0},{id:"shallowSize",title:e`Shallow Size`,width:"110px",sortable:!0,fixedWidth:!0},{id:"retainedSize",title:e`Retained Size`,width:"110px",sortable:!0,fixedWidth:!0,sort:_.Order.Descending}]})}async setDataSource(e,t){this.snapshot=e;const i=new le.Node(-1,"root",0,t||e.rootNodeIndex,0,0,"");this.setRootNode(this._createRootNode(e,i)),this.rootNode().sort()}_createRootNode(e,t){const i=new le.Edge("",t,"",-1);return new St(this,e,i,null)}sortingChanged(){const e=this.rootNode();e.hasChildren()&&e.sort()}}class kt extends Ft{constructor(t,i){const s=[{id:"object",title:e`Object`,disclosure:!0,sortable:!0},{id:"distance",title:e`Distance`,width:"70px",sortable:!0,fixedWidth:!0,sort:_.Order.Ascending},{id:"shallowSize",title:e`Shallow Size`,width:"110px",sortable:!0,fixedWidth:!0},{id:"retainedSize",title:e`Retained Size`,width:"110px",sortable:!0,fixedWidth:!0}];super(t,i,e`Heap Snapshot Retainment`,s)}_createRootNode(e,t){const i=new le.Edge("",t,"",-1);return new Ct(this,e,i,null)}_sortFields(e,t){switch(e){case"object":return new le.ComparatorConfig("_name",t,"_count",!1);case"count":return new le.ComparatorConfig("_count",t,"_name",!0);case"shallowSize":return new le.ComparatorConfig("_shallowSize",t,"_name",!0);case"retainedSize":return new le.ComparatorConfig("_retainedSize",t,"_name",!0);case"distance":return new le.ComparatorConfig("_distance",t,"_name",!0);default:throw new Error("Unknown column "+e)}}reset(){this.rootNode().removeChildren(),this.resetSortingCache()}async setDataSource(e,t){await super.setDataSource(e,t),this.rootNode().expand()}}const Lt={ExpandRetainersComplete:Symbol("ExpandRetainersComplete")};class Mt extends Dt{constructor(t,i){const s=[{id:"object",title:e`Constructor`,disclosure:!0,sortable:!0},{id:"distance",title:e`Distance`,width:"70px",sortable:!0,fixedWidth:!0},{id:"shallowSize",title:e`Shallow Size`,width:"110px",sortable:!0,fixedWidth:!0},{id:"retainedSize",title:e`Retained Size`,width:"110px",sort:_.Order.Descending,sortable:!0,fixedWidth:!0}];super(t,i,{displayName:e`Heap Snapshot Constructors`,columns:s}),this._profileIndex=-1,this._objectIdToSelect=null,this._nextRequestedFilter=null}_sortFields(e,t){switch(e){case"object":return new le.ComparatorConfig("_name",t,"_retainedSize",!1);case"distance":return new le.ComparatorConfig("_distance",t,"_retainedSize",!1);case"shallowSize":return new le.ComparatorConfig("_shallowSize",t,"_name",!0);case"retainedSize":return new le.ComparatorConfig("_retainedSize",t,"_name",!0);default:throw new Error("Unknown column "+e)}}async revealObjectByHeapSnapshotId(e){if(!this.snapshot)return this._objectIdToSelect=e,null;const t=await this.snapshot.nodeClassName(parseInt(e,10));if(!t)return null;const i=this.topLevelNodes().find((e=>e.name===t));if(!i)return null;const s=await i.populateNodeBySnapshotObjectId(parseInt(e,10));return s.length?this.revealTreeNode(s):null}clear(){this._nextRequestedFilter=null,this._lastFilter=null,this.removeTopLevelNodes()}async setDataSource(e,t){this.snapshot=e,-1===this._profileIndex&&this._populateChildren(),this._objectIdToSelect&&(this.revealObjectByHeapSnapshotId(this._objectIdToSelect),this._objectIdToSelect=null)}setSelectionRange(e,t){this._nodeFilter=new le.NodeFilter(e,t),this._populateChildren(this._nodeFilter)}setAllocationNodeId(e){this._nodeFilter=new le.NodeFilter,this._nodeFilter.allocationNodeId=e,this._populateChildren(this._nodeFilter)}_aggregatesReceived(e,t){this._filterInProgress=null,this._nextRequestedFilter&&this.snapshot&&(this.snapshot.aggregatesWithFilter(this._nextRequestedFilter).then(this._aggregatesReceived.bind(this,this._nextRequestedFilter)),this._filterInProgress=this._nextRequestedFilter,this._nextRequestedFilter=null),this.removeTopLevelNodes(),this.resetSortingCache();for(const i in t)this.appendNode(this.rootNode(),new Pt(this,i,t[i],e));this.sortingChanged(),this._lastFilter=e}async _populateChildren(e){const t=e||new le.NodeFilter;if(this._filterInProgress)this._nextRequestedFilter=this._filterInProgress.equals(t)?null:t;else if((!this._lastFilter||!this._lastFilter.equals(t))&&(this._filterInProgress=t,this.snapshot)){const e=await this.snapshot.aggregatesWithFilter(t);this._aggregatesReceived(t,e)}}filterSelectIndexChanged(e,t){if(this._profileIndex=t,this._nodeFilter=void 0,-1!==t){const i=t>0?e[t-1].maxJSObjectId:0,s=e[t].maxJSObjectId;this._nodeFilter=new le.NodeFilter(i,s)}this._populateChildren(this._nodeFilter)}}class Bt extends Dt{constructor(t,i){const s=[{id:"object",title:e`Constructor`,disclosure:!0,sortable:!0},{id:"addedCount",title:e`# New`,width:"75px",sortable:!0,fixedWidth:!0},{id:"removedCount",title:e`# Deleted`,width:"75px",sortable:!0,fixedWidth:!0},{id:"countDelta",title:e`# Delta`,width:"65px",sortable:!0,fixedWidth:!0},{id:"addedSize",title:e`Alloc. Size`,width:"75px",sortable:!0,fixedWidth:!0,sort:_.Order.Descending},{id:"removedSize",title:e`Freed Size`,width:"75px",sortable:!0,fixedWidth:!0},{id:"sizeDelta",title:e`Size Delta`,width:"75px",sortable:!0,fixedWidth:!0}];super(t,i,{displayName:e`Heap Snapshot Diff`,columns:s})}defaultPopulateCount(){return 50}_sortFields(e,t){switch(e){case"object":return new le.ComparatorConfig("_name",t,"_count",!1);case"addedCount":return new le.ComparatorConfig("_addedCount",t,"_name",!0);case"removedCount":return new le.ComparatorConfig("_removedCount",t,"_name",!0);case"countDelta":return new le.ComparatorConfig("_countDelta",t,"_name",!0);case"addedSize":return new le.ComparatorConfig("_addedSize",t,"_name",!0);case"removedSize":return new le.ComparatorConfig("_removedSize",t,"_name",!0);case"sizeDelta":return new le.ComparatorConfig("_sizeDelta",t,"_name",!0);default:throw new Error("Unknown column "+e)}}async setDataSource(e,t){this.snapshot=e}setBaseDataSource(e){this.baseSnapshot=e,this.removeTopLevelNodes(),this.resetSortingCache(),this.baseSnapshot!==this.snapshot?this._populateChildren():this.dispatchEventToListeners(Rt.SortingComplete)}async _populateChildren(){if(null===this.snapshot||void 0===this.baseSnapshot||void 0===this.baseSnapshot.uid)throw new Error("Data sources have not been set correctly");const e=await this.baseSnapshot.aggregatesForDiff(),t=await this.snapshot.calculateSnapshotDiff(this.baseSnapshot.uid,e);for(const e in t){const i=t[e];this.appendNode(this.rootNode(),new yt(this,e,i))}this.sortingChanged()}}class Ot extends Dt{constructor(t,i){const s=[{id:"liveCount",title:e`Live Count`,width:"75px",sortable:!0,fixedWidth:!0},{id:"count",title:e`Count`,width:"65px",sortable:!0,fixedWidth:!0},{id:"liveSize",title:e`Live Size`,width:"75px",sortable:!0,fixedWidth:!0},{id:"size",title:e`Size`,width:"75px",sortable:!0,fixedWidth:!0,sort:_.Order.Descending},{id:"name",title:e`Function`,disclosure:!0,sortable:!0}];super(t,i,{displayName:e`Allocation`,columns:s}),this._linkifier=new q.Linkifier}get linkifier(){return this._linkifier}dispose(){this._linkifier.reset()}async setDataSource(e,t){this.snapshot=e,this._topNodes=await this.snapshot.allocationTracesTops(),this._populateChildren()}_populateChildren(){this.removeTopLevelNodes();const e=this.rootNode(),t=this._topNodes||[];for(const i of t)this.appendNode(e,new xt(this,i));this.updateVisibleNodes(!0)}sortingChanged(){void 0!==this._topNodes&&(this._topNodes.sort(this.createComparator()),this.rootNode().removeChildren(),this._populateChildren())}createComparator(){const e=this.sortColumnId(),t=this.sortOrder()===_.Order.Ascending?1:-1;return function(i,s){return i[e]>s[e]?t:i[e]<s[e]?-t:0}}}var Gt=Object.freeze({__proto__:null,HeapSnapshotSortableDataGrid:Nt,HeapSnapshotSortableDataGridEvents:Rt,HeapSnapshotViewportDataGrid:Dt,HeapSnapshotContainmentDataGrid:Ft,HeapSnapshotRetainmentDataGrid:kt,HeapSnapshotRetainmentDataGridEvents:Lt,HeapSnapshotConstructorsDataGrid:Mt,HeapSnapshotDiffDataGrid:Bt,AllocationDataGrid:Ot});class Vt extends a.ObjectWrapper{constructor(e){super(),this._eventHandler=e,this._nextObjectId=1,this._nextCallId=1,this._callbacks=new Map,this._previousCallbacks=new Set,this._worker=p.WorkerWrapper.fromURL(new URL("../heap_snapshot_worker/heap_snapshot_worker-legacy.js",import.meta.url)),this._worker.onmessage=this._messageReceived.bind(this)}createLoader(e,t){const i=this._nextObjectId++,s=new zt(this,i,e,t);return this._postMessage({callId:this._nextCallId++,disposition:"create",objectId:i,methodName:"HeapSnapshotWorker.HeapSnapshotLoader"}),s}dispose(){this._worker.terminate(),this._interval&&clearInterval(this._interval)}disposeObject(e){this._postMessage({callId:this._nextCallId++,disposition:"dispose",objectId:e})}evaluateForTest(e,t){const i=this._nextCallId++;this._callbacks.set(i,t),this._postMessage({callId:i,disposition:"evaluateForTest",source:e})}callFactoryMethod(e,t,i,s){const r=this._nextCallId++,o=Array.prototype.slice.call(arguments,4),n=this._nextObjectId++;return e?(this._callbacks.set(r,(t=>{e(t?new s(this,n):null)})),this._postMessage({callId:r,disposition:"factory",objectId:t,methodName:i,methodArguments:o,newObjectId:n}),null):(this._postMessage({callId:r,disposition:"factory",objectId:t,methodName:i,methodArguments:o,newObjectId:n}),new s(this,n))}callMethod(e,t,i){const s=this._nextCallId++,r=Array.prototype.slice.call(arguments,3);e&&this._callbacks.set(s,e),this._postMessage({callId:s,disposition:"method",objectId:t,methodName:i,methodArguments:r})}startCheckingForLongRunningCalls(){this._interval||(this._checkLongRunningCalls(),this._interval=setInterval(this._checkLongRunningCalls.bind(this),300))}_checkLongRunningCalls(){for(const e of this._previousCallbacks)this._callbacks.has(e)||this._previousCallbacks.delete(e);const e=Boolean(this._previousCallbacks.size);this.dispatchEventToListeners(Vt.Events.Wait,e);for(const e of this._callbacks.keys())this._previousCallbacks.add(e)}_messageReceived(e){const t=e.data;if(t.eventName)return void(this._eventHandler&&this._eventHandler(t.eventName,t.data));if(t.error)return t.errorMethodName&&c.Console.instance().error(o.UIString("An error occurred when a call to method '%s' was requested",t.errorMethodName)),c.Console.instance().error(t.errorCallStack),void this._callbacks.delete(t.callId);const i=this._callbacks.get(t.callId);i&&(this._callbacks.delete(t.callId),i(t.result))}_postMessage(e){this._worker.postMessage(e)}}Vt.Events={Wait:Symbol("Wait")};class Ht{constructor(e,t){this._worker=e,this._objectId=t}_callWorker(e,t){t.splice(1,0,this._objectId);const i=this._worker[e];if(!i)throw new Error(`Could not find worker with name ${e}.`);return i.apply(this._worker,t)}dispose(){this._worker.disposeObject(this._objectId)}disposeWorker(){this._worker.dispose()}callFactoryMethod(e,t,i,...s){return this._callWorker("callFactoryMethod",Array.prototype.slice.call(arguments,0))}_callMethodPromise(e,...t){const i=Array.prototype.slice.call(arguments);return new Promise((e=>this._callWorker("callMethod",[e,...i])))}}class zt extends Ht{constructor(e,t,i,s){super(e,t),this._profileUid=i,this._snapshotReceivedCallback=s}async write(e){await this._callMethodPromise("write",e)}async close(){await this._callMethodPromise("close");const e=await new Promise((e=>this.callFactoryMethod(e,"buildSnapshot",jt)));this.dispose(),e.setProfileUid(this._profileUid),await e.updateStaticData(),this._snapshotReceivedCallback(e)}}class jt extends Ht{constructor(e,t){super(e,t),this._staticData=null}search(e,t){return this._callMethodPromise("search",e,t)}aggregatesWithFilter(e){return this._callMethodPromise("aggregatesWithFilter",e)}aggregatesForDiff(){return this._callMethodPromise("aggregatesForDiff")}calculateSnapshotDiff(e,t){return this._callMethodPromise("calculateSnapshotDiff",e,t)}nodeClassName(e){return this._callMethodPromise("nodeClassName",e)}createEdgesProvider(e){return this.callFactoryMethod(null,"createEdgesProvider",Ut,e)}createRetainingEdgesProvider(e){return this.callFactoryMethod(null,"createRetainingEdgesProvider",Ut,e)}createAddedNodesProvider(e,t){return this.callFactoryMethod(null,"createAddedNodesProvider",Ut,e,t)}createDeletedNodesProvider(e){return this.callFactoryMethod(null,"createDeletedNodesProvider",Ut,e)}createNodesProvider(e){return this.callFactoryMethod(null,"createNodesProvider",Ut,e)}createNodesProviderForClass(e,t){return this.callFactoryMethod(null,"createNodesProviderForClass",Ut,e,t)}allocationTracesTops(){return this._callMethodPromise("allocationTracesTops")}allocationNodeCallers(e){return this._callMethodPromise("allocationNodeCallers",e)}allocationStack(e){return this._callMethodPromise("allocationStack",e)}dispose(){throw new Error("Should never be called")}get nodeCount(){return this._staticData?this._staticData.nodeCount:0}get rootNodeIndex(){return this._staticData?this._staticData.rootNodeIndex:0}async updateStaticData(){this._staticData=await this._callMethodPromise("updateStaticData")}getStatistics(){return this._callMethodPromise("getStatistics")}getLocation(e){return this._callMethodPromise("getLocation",e)}getSamples(){return this._callMethodPromise("getSamples")}get totalSize(){return this._staticData?this._staticData.totalSize:0}get uid(){return this._profileUid}setProfileUid(e){this._profileUid=e}maxJSObjectId(){return this._staticData?this._staticData.maxJSObjectId:0}}class Ut extends Ht{constructor(e,t){super(e,t)}nodePosition(e){return this._callMethodPromise("nodePosition",e)}isEmpty(){return this._callMethodPromise("isEmpty")}serializeItemsRange(e,t){return this._callMethodPromise("serializeItemsRange",e,t)}async sortAndRewind(e){await this._callMethodPromise("sortAndRewind",e)}}var Wt=Object.freeze({__proto__:null,HeapSnapshotWorkerProxy:Vt,HeapSnapshotProxyObject:Ht,HeapSnapshotLoaderProxy:zt,HeapSnapshotProxy:jt,HeapSnapshotProviderProxy:Ut});class At extends y.SimpleView{constructor(t,i){super(o.UIString("Heap Snapshot")),this._searchResults=[],this.element.classList.add("heap-snapshot-view"),this._profile=i,this._linkifier=new q.Linkifier;const s=i.profileType();s.addEventListener(Yt.SnapshotReceived,this._onReceiveSnapshot,this),s.addEventListener(Ee.RemoveProfileHeader,this._onProfileHeaderRemoved,this);const r=s.id===Zt.TypeId;r&&this._createOverview(),this._parentDataDisplayDelegate=t,this._searchableView=new x.SearchableView(this,null),this._searchableView.setPlaceholder(e`Find`,e`Find`),this._searchableView.show(this.element),this._splitWidget=new k.SplitWidget(!1,!0,"heapSnapshotSplitViewState",200,200),this._splitWidget.show(this._searchableView.element);const n=i.heapProfilerModel();let a;if(this._containmentDataGrid=new Ft(n,this,e`Containment`),this._containmentDataGrid.addEventListener(_.Events.SelectedNode,this._selectionChanged,this),this._containmentWidget=this._containmentDataGrid.asWidget(),this._containmentWidget.setMinimumSize(50,25),this._statisticsView=new ti,this._constructorsDataGrid=new Mt(n,this),this._constructorsDataGrid.addEventListener(_.Events.SelectedNode,this._selectionChanged,this),this._constructorsWidget=this._constructorsDataGrid.asWidget(),this._constructorsWidget.setMinimumSize(50,25),this._diffDataGrid=new Bt(n,this),this._diffDataGrid.addEventListener(_.Events.SelectedNode,this._selectionChanged,this),this._diffWidget=this._diffDataGrid.asWidget(),this._diffWidget.setMinimumSize(50,25),this._allocationDataGrid=null,r&&(this._allocationDataGrid=new Ot(n,this),this._allocationDataGrid.addEventListener(_.Events.SelectedNode,this._onSelectAllocationNode,this),this._allocationWidget=this._allocationDataGrid.asWidget(),this._allocationWidget.setMinimumSize(50,25),this._allocationStackView=new ii(n),this._allocationStackView.setMinimumSize(50,25),this._tabbedPane=new L.TabbedPane),this._retainmentDataGrid=new kt(n,this),this._retainmentWidget=this._retainmentDataGrid.asWidget(),this._retainmentWidget.setMinimumSize(50,21),this._retainmentWidget.element.classList.add("retaining-paths-view"),this._allocationStackView)this._tabbedPane=new L.TabbedPane,this._tabbedPane.appendTab("retainers",o.UIString("Retainers"),this._retainmentWidget),this._tabbedPane.appendTab("allocation-stack",o.UIString("Allocation stack"),this._allocationStackView),a=this._tabbedPane.headerElement(),this._objectDetailsView=this._tabbedPane;else{const e=document.createElement("div");e.classList.add("heap-snapshot-view-resizer");e.createChild("div","title").createChild("span").textContent=o.UIString("Retainers"),a=e,this._objectDetailsView=new S.VBox,this._objectDetailsView.element.appendChild(e),this._retainmentWidget.show(this._objectDetailsView.element)}this._splitWidget.hideDefaultResizer(),this._splitWidget.installResizer(a),this._retainmentDataGrid.addEventListener(_.Events.SelectedNode,this._inspectedObjectChanged,this),this._retainmentDataGrid.reset(),this._perspectives=[],this._comparisonPerspective=new Jt,this._perspectives.push(new qt),i.profileType()!==ni.trackingHeapSnapshotProfileType&&this._perspectives.push(this._comparisonPerspective),this._perspectives.push(new Qt),this._allocationWidget&&this._perspectives.push(new Kt),this._perspectives.push(new Xt),this._perspectiveSelect=new I.ToolbarComboBox(this._onSelectedPerspectiveChanged.bind(this),e`Perspective`),this._updatePerspectiveOptions(),this._baseSelect=new I.ToolbarComboBox(this._changeBase.bind(this),e`Base snapshot`),this._baseSelect.setVisible(!1),this._updateBaseOptions(),this._filterSelect=new I.ToolbarComboBox(this._changeFilter.bind(this),e`Filter`),this._filterSelect.setVisible(!1),this._updateFilterOptions(),this._classNameFilter=new I.ToolbarInput(e`Class filter`),this._classNameFilter.setVisible(!1),this._constructorsDataGrid.setNameFilter(this._classNameFilter),this._diffDataGrid.setNameFilter(this._classNameFilter),this._selectedSizeText=new I.ToolbarText,this._popoverHelper=new M.PopoverHelper(this.element,this._getPopoverRequest.bind(this)),this._popoverHelper.setDisableOnClick(!0),this._popoverHelper.setHasPadding(!0),this.element.addEventListener("scroll",this._popoverHelper.hidePopover.bind(this._popoverHelper),!0),this._currentPerspectiveIndex=0,this._currentPerspective=this._perspectives[0],this._currentPerspective.activate(this),this._dataGrid=this._currentPerspective.masterGrid(this),this._populate(),this._searchThrottler=new u.Throttler(0);for(const e of this._profiles())e.addEventListener(xe.ProfileTitleChanged,this._updateControls,this);this._baseProfile}_createOverview(){const e=this._profile.profileType();this._trackingOverviewGrid=new tt,this._trackingOverviewGrid.addEventListener(it,this._onIdsRangeChanged.bind(this)),this._profile.fromFile()||e.profileBeingRecorded()!==this._profile||(e.addEventListener(Zt.HeapStatsUpdate,this._onHeapStatsUpdate,this),e.addEventListener(Zt.TrackingStopped,this._onStopTracking,this),this._trackingOverviewGrid.start())}_onStopTracking(){this._profile.profileType().removeEventListener(Zt.HeapStatsUpdate,this._onHeapStatsUpdate,this),this._profile.profileType().removeEventListener(Zt.TrackingStopped,this._onStopTracking,this),this._trackingOverviewGrid&&this._trackingOverviewGrid.stop()}_onHeapStatsUpdate(e){e.data&&this._trackingOverviewGrid&&this._trackingOverviewGrid.setSamples(e.data)}searchableView(){return this._searchableView}showProfile(e){return this._parentDataDisplayDelegate.showProfile(e)}showObject(e,t){Number(e)<=this._profile.maxJSObjectId?this.selectLiveObject(t,e):this._parentDataDisplayDelegate.showObject(e,t)}async linkifyObject(e){const t=this._profile.heapProfilerModel();if(!t)return null;const i=await this._profile.getLocation(e);if(!i)return null;const s=t.runtimeModel().debuggerModel().createRawLocationByScriptId(String(i.scriptId),i.lineNumber,i.columnNumber);if(!s)return null;const r=s.script(),o=r&&r.sourceURL;return o&&this._linkifier?this._linkifier.linkifyRawLocation(s,o):null}async _populate(){const e=await this._profile._loadPromise;if(this._retrieveStatistics(e),this._dataGrid&&this._dataGrid.setDataSource(e,0),this._profile.profileType().id===Zt.TypeId&&this._profile.fromFile()){const t=await e.getSamples();if(t){console.assert(Boolean(t.timestamps.length));const e=new rt;e.sizes=t.sizes,e.ids=t.lastAssignedIds,e.timestamps=t.timestamps,e.max=t.sizes,e.totalTime=Math.max(t.timestamps[t.timestamps.length-1]||0,1e4),this._trackingOverviewGrid&&this._trackingOverviewGrid.setSamples(e)}}const t=this._profiles().indexOf(this._profile);this._baseSelect.setSelectedIndex(Math.max(0,t-1)),this._trackingOverviewGrid&&this._trackingOverviewGrid.updateGrid()}async _retrieveStatistics(t){const i=await t.getStatistics(),s=[{value:i.code,color:"#f77",title:e`Code`},{value:i.strings,color:"#5e5",title:e`Strings`},{value:i.jsArrays,color:"#7af",title:e`JS arrays`},{value:i.native,color:"#fc5",title:e`Typed arrays`},{value:i.system,color:"#98f",title:e`System objects`}];return this._statisticsView.setTotalAndRecords(i.total,s),i}_onIdsRangeChanged(e){const t=e.data.minId,s=e.data.maxId;this._selectedSizeText.setText(o.UIString("Selected size: %s",i.bytesToString(e.data.size))),this._constructorsDataGrid.snapshot&&this._constructorsDataGrid.setSelectionRange(t,s)}async toolbarItems(){const e=[this._perspectiveSelect,this._classNameFilter];return this._profile.profileType()!==ni.trackingHeapSnapshotProfileType&&e.push(this._baseSelect,this._filterSelect),e.push(this._selectedSizeText),e}willHide(){this._currentSearchResultIndex=-1,this._popoverHelper.hidePopover()}supportsCaseSensitiveSearch(){return!0}supportsRegexSearch(){return!1}searchCanceled(){this._currentSearchResultIndex=-1,this._searchResults=[]}_selectRevealedNode(e){e&&e.select()}performSearch(e,t,i){const s=new le.SearchConfig(e.query.trim(),e.caseSensitive,e.isRegex,t,i||!1);this._searchThrottler.schedule(this._performSearch.bind(this,s))}async _performSearch(e){if(this.searchCanceled(),!this._currentPerspective.supportsSearch())return;this.currentQuery=e;const t=e.query.trim();if(!t)return;if("@"===t.charAt(0)){const e=parseInt(t.substring(1),10);if(isNaN(e))return;if(!this._dataGrid)return;const i=await this._dataGrid.revealObjectByHeapSnapshotId(String(e));return void this._selectRevealedNode(i)}if(!this._profile._snapshotProxy||!this._dataGrid)return;const i=this._dataGrid.nodeFilter();this._searchResults=i?await this._profile._snapshotProxy.search(this.currentQuery,i):[],this._searchableView.updateSearchMatchesCount(this._searchResults.length),this._searchResults.length&&(this._currentSearchResultIndex=e.jumpBackward?this._searchResults.length-1:0),await this._jumpToSearchResult(this._currentSearchResultIndex)}jumpToNextSearchResult(){this._searchResults.length&&(this._currentSearchResultIndex=(this._currentSearchResultIndex+1)%this._searchResults.length,this._searchThrottler.schedule(this._jumpToSearchResult.bind(this,this._currentSearchResultIndex)))}jumpToPreviousSearchResult(){this._searchResults.length&&(this._currentSearchResultIndex=(this._currentSearchResultIndex+this._searchResults.length-1)%this._searchResults.length,this._searchThrottler.schedule(this._jumpToSearchResult.bind(this,this._currentSearchResultIndex)))}async _jumpToSearchResult(e){if(this._searchableView.updateCurrentMatchIndex(e),-1===e)return;if(!this._dataGrid)return;const t=await this._dataGrid.revealObjectByHeapSnapshotId(String(this._searchResults[e]));this._selectRevealedNode(t)}refreshVisibleData(){if(!this._dataGrid)return;let e=this._dataGrid.rootNode().children[0];for(;e;)e.refresh(),e=e.traverseNextNode(!1,null,!0)}_changeBase(){if(this._baseProfile===this._profiles()[this._baseSelect.selectedIndex()])return;this._baseProfile=this._profiles()[this._baseSelect.selectedIndex()];const e=this._dataGrid;e.snapshot&&this._baseProfile._loadPromise.then(e.setBaseDataSource.bind(e)),this.currentQuery&&this._searchResults&&this.performSearch(this.currentQuery,!1)}_changeFilter(){const e=this._filterSelect.selectedIndex()-1;this._dataGrid&&(this._dataGrid.filterSelectIndexChanged(this._profiles(),e),this.currentQuery&&this._searchResults&&this.performSearch(this.currentQuery,!1))}_profiles(){return this._profile.profileType().getProfiles()}_selectionChanged(e){const t=e.data;this._setSelectedNodeForDetailsView(t),this._inspectedObjectChanged(e)}_onSelectAllocationNode(e){const t=e.data;this._constructorsDataGrid.setAllocationNodeId(t.allocationNodeId()),this._setSelectedNodeForDetailsView(null)}_inspectedObjectChanged(e){const t=e.data,i=this._profile.heapProfilerModel();i&&t instanceof wt&&i.addInspectedHeapObject(String(t.snapshotNodeId))}_setSelectedNodeForDetailsView(e){const t=e&&e.retainersDataSource();t?(this._retainmentDataGrid.setDataSource(t.snapshot,t.snapshotNodeIndex),this._allocationStackView&&this._allocationStackView.setAllocatedObject(t.snapshot,t.snapshotNodeIndex)):(this._allocationStackView&&this._allocationStackView.clear(),this._retainmentDataGrid.reset())}async _changePerspectiveAndWait(e){const t=this._perspectives.findIndex((t=>t.title()===e));if(-1===t||this._currentPerspectiveIndex===t)return;const i=this._perspectives[t].masterGrid(this);if(!i)return;const s=i.once(Rt.ContentShown),r=this._perspectiveSelect.options().find((e=>e.value===String(t)));return this._perspectiveSelect.select(r),this._changePerspective(t),s}async _updateDataSourceAndView(){const e=this._dataGrid;if(!e||e.snapshot)return;const t=await this._profile._loadPromise;if(this._dataGrid!==e)return;if(e.snapshot!==t&&e.setDataSource(t,0),e!==this._diffDataGrid)return;this._baseProfile||(this._baseProfile=this._profiles()[this._baseSelect.selectedIndex()]);const i=await this._baseProfile._loadPromise;this._diffDataGrid.baseSnapshot!==i&&this._diffDataGrid.setBaseDataSource(i)}_onSelectedPerspectiveChanged(e){this._changePerspective(Number(e.target.selectedOptions[0].value))}_changePerspective(e){if(e===this._currentPerspectiveIndex)return;this._currentPerspectiveIndex=e,this._currentPerspective.deactivate(this);const t=this._perspectives[e];this._currentPerspective=t,this._dataGrid=t.masterGrid(this),t.activate(this),this.refreshVisibleData(),this._dataGrid&&this._dataGrid.updateWidths(),this._updateDataSourceAndView(),this.currentQuery&&this._searchResults&&this.performSearch(this.currentQuery,!1)}async selectLiveObject(e,t){if(await this._changePerspectiveAndWait(e),!this._dataGrid)return;const i=await this._dataGrid.revealObjectByHeapSnapshotId(t);i?i.select():c.Console.instance().error("Cannot find corresponding heap snapshot node")}_getPopoverRequest(e){const t=g.enclosingNodeOrSelfWithNodeName(e.target,"span"),i=g.enclosingNodeOrSelfWithNodeName(e.target,"row");if(!i)return null;if(!this._dataGrid)return null;const s=this._dataGrid.dataGridNodeFromNode(i)||this._containmentDataGrid.dataGridNodeFromNode(i)||this._constructorsDataGrid.dataGridNodeFromNode(i)||this._diffDataGrid.dataGridNodeFromNode(i)||this._allocationDataGrid&&this._allocationDataGrid.dataGridNodeFromNode(i)||this._retainmentDataGrid.dataGridNodeFromNode(i),r=this._profile.heapProfilerModel();if(!s||!t||!r)return null;let o;return{box:t.boxInWindow(),show:async e=>{if(!r)return!1;const t=await s.queryObjectContent(r,"popover");return!!t&&(o=await de.ObjectPopoverHelper.buildObjectPopover(t,e),!!o||(r.runtimeModel().releaseObjectGroup("popover"),!1))},hide:()=>{r.runtimeModel().releaseObjectGroup("popover"),o&&o.dispose()}}}_updatePerspectiveOptions(){const e=this._profiles().length>1;this._perspectiveSelect.removeOptions(),this._perspectives.forEach(((t,i)=>{(e||t!==this._comparisonPerspective)&&this._perspectiveSelect.createOption(t.title(),String(i))}))}_updateBaseOptions(){const e=this._profiles(),t=this._baseSelect.selectedIndex();this._baseSelect.removeOptions();for(const t of e)this._baseSelect.createOption(t.title);t>-1&&this._baseSelect.setSelectedIndex(t)}_updateFilterOptions(){const e=this._profiles(),t=this._filterSelect.selectedIndex();this._filterSelect.removeOptions(),this._filterSelect.createOption(o.UIString("All objects"));for(let t=0;t<e.length;++t){let i;i=t?o.UIString("Objects allocated between %s and %s",e[t-1].title,e[t].title):o.UIString("Objects allocated before %s",e[t].title),this._filterSelect.createOption(i)}t>-1&&this._filterSelect.setSelectedIndex(t)}_updateControls(){this._updatePerspectiveOptions(),this._updateBaseOptions(),this._updateFilterOptions()}_onReceiveSnapshot(e){this._updateControls();e.data.addEventListener(xe.ProfileTitleChanged,this._updateControls,this)}_onProfileHeaderRemoved(e){const t=e.data;t.removeEventListener(xe.ProfileTitleChanged,this._updateControls,this),this._profile===t?(this.detach(),this._profile.profileType().removeEventListener(Yt.SnapshotReceived,this._onReceiveSnapshot,this),this._profile.profileType().removeEventListener(Ee.RemoveProfileHeader,this._onProfileHeaderRemoved,this),this.dispose()):this._updateControls()}dispose(){this._linkifier.dispose(),this._popoverHelper.dispose(),this._allocationStackView&&(this._allocationStackView.clear(),this._allocationDataGrid&&this._allocationDataGrid.dispose()),this._onStopTracking(),this._trackingOverviewGrid&&this._trackingOverviewGrid.removeEventListener(it,this._onIdsRangeChanged.bind(this))}}class $t{constructor(e){this._title=e}activate(e){}deactivate(e){e._baseSelect.setVisible(!1),e._filterSelect.setVisible(!1),e._classNameFilter.setVisible(!1),e._trackingOverviewGrid&&e._trackingOverviewGrid.detach(),e._allocationWidget&&e._allocationWidget.detach(),e._statisticsView&&e._statisticsView.detach(),e._splitWidget.detach(),e._splitWidget.detachChildWidgets()}masterGrid(e){return null}title(){return this._title}supportsSearch(){return!1}}class qt extends $t{constructor(){super(o.UIString("Summary"))}activate(e){e._splitWidget.setMainWidget(e._constructorsWidget),e._splitWidget.setSidebarWidget(e._objectDetailsView),e._splitWidget.show(e._searchableView.element),e._filterSelect.setVisible(!0),e._classNameFilter.setVisible(!0),e._trackingOverviewGrid&&(e._trackingOverviewGrid.show(e._searchableView.element,e._splitWidget.element),e._trackingOverviewGrid.update(),e._trackingOverviewGrid.updateGrid())}masterGrid(e){return e._constructorsDataGrid}supportsSearch(){return!0}}class Jt extends $t{constructor(){super(o.UIString("Comparison"))}activate(e){e._splitWidget.setMainWidget(e._diffWidget),e._splitWidget.setSidebarWidget(e._objectDetailsView),e._splitWidget.show(e._searchableView.element),e._baseSelect.setVisible(!0),e._classNameFilter.setVisible(!0)}masterGrid(e){return e._diffDataGrid}supportsSearch(){return!0}}class Qt extends $t{constructor(){super(o.UIString("Containment"))}activate(e){e._splitWidget.setMainWidget(e._containmentWidget),e._splitWidget.setSidebarWidget(e._objectDetailsView),e._splitWidget.show(e._searchableView.element)}masterGrid(e){return e._containmentDataGrid}}class Kt extends $t{constructor(){super(o.UIString("Allocation")),this._allocationSplitWidget=new k.SplitWidget(!1,!0,"heapSnapshotAllocationSplitViewState",200,200),this._allocationSplitWidget.setSidebarWidget(new S.VBox)}activate(e){e._allocationWidget&&this._allocationSplitWidget.setMainWidget(e._allocationWidget),e._splitWidget.setMainWidget(e._constructorsWidget),e._splitWidget.setSidebarWidget(e._objectDetailsView);const t=new S.VBox,i=document.createElement("div");i.classList.add("heap-snapshot-view-resizer");if(i.createChild("div","title").createChild("span").textContent=o.UIString("Live objects"),this._allocationSplitWidget.hideDefaultResizer(),this._allocationSplitWidget.installResizer(i),t.element.appendChild(i),e._splitWidget.show(t.element),this._allocationSplitWidget.setSidebarWidget(t),this._allocationSplitWidget.show(e._searchableView.element),e._constructorsDataGrid.clear(),e._allocationDataGrid){const t=e._allocationDataGrid.selectedNode;t&&e._constructorsDataGrid.setAllocationNodeId(t.allocationNodeId())}}deactivate(e){this._allocationSplitWidget.detach(),super.deactivate(e)}masterGrid(e){return e._allocationDataGrid}}class Xt extends $t{constructor(){super(o.UIString("Statistics"))}activate(e){e._statisticsView.show(e._searchableView.element)}masterGrid(e){return null}}class Yt extends Ie{constructor(t,i){super(t||Yt.TypeId,i||e`Heap snapshot`),J.TargetManager.instance().observeModels(Z.HeapProfilerModel,this),J.TargetManager.instance().addModelListener(Z.HeapProfilerModel,Z.Events.ResetProfiles,this._resetProfiles,this),J.TargetManager.instance().addModelListener(Z.HeapProfilerModel,Z.Events.AddHeapSnapshotChunk,this._addHeapSnapshotChunk,this),J.TargetManager.instance().addModelListener(Z.HeapProfilerModel,Z.Events.ReportHeapSnapshotProgress,this._reportHeapSnapshotProgress,this),this._treatGlobalObjectsAsRoots=l.Settings.instance().createSetting("treatGlobalObjectsAsRoots",!0),this._customContent=null}modelAdded(e){e.enable()}modelRemoved(e){}getProfiles(){return super.getProfiles()}fileExtension(){return".heapsnapshot"}get buttonTooltip(){return o.UIString("Take heap snapshot")}isInstantProfile(){return!0}buttonClicked(){return this._takeHeapSnapshot(),z.actionTaken(j.Action.ProfilesHeapProfileTaken),!1}get treeItemTitle(){return o.UIString("HEAP SNAPSHOTS")}get description(){return o.UIString("Heap snapshot profiles show memory distribution among your page's JavaScript objects and related DOM nodes.")}customContent(){const t=B.createSettingCheckbox(e`Treat global objects as roots (recommended, unchecking this exposes internal nodes and introduces excessive detail, but might help debugging cycles in retaining paths)`,this._treatGlobalObjectsAsRoots,!0);this._customContent=t;return ae.experiments.isEnabled("showOptionToNotTreatGlobalObjectsAsRoots")?t:null}setCustomContentEnabled(e){this._customContent&&(this._customContent.checkboxElement.disabled=!e)}createProfileLoadedFromFile(e){return new ei(null,this,e)}async _takeHeapSnapshot(){if(this.profileBeingRecorded())return;const e=E.Context.instance().flavor(Z.HeapProfilerModel);if(!e)return;let t=new ei(e,this);this.setProfileBeingRecorded(t),this.addProfile(t),t.updateStatus(o.UIString("Snapshotting…")),await e.takeHeapSnapshot(!0,this._treatGlobalObjectsAsRoots.get()),t=this.profileBeingRecorded(),t.title=o.UIString("Snapshot %d",t.uid),t._finishLoad(),this.setProfileBeingRecorded(null),this.dispatchEventToListeners(Ee.ProfileComplete,t)}_addHeapSnapshotChunk(e){const t=this.profileBeingRecorded();if(!t)return;const i=e.data;t.transferChunk(i)}_reportHeapSnapshotProgress(e){const t=this.profileBeingRecorded();if(!t)return;const i=e.data;t.updateStatus(o.UIString("%.0f%%",i.done/i.total*100),!0),i.finished&&t._prepareToLoad()}_resetProfiles(e){const t=e.data;for(const e of this.getProfiles())e.heapProfilerModel()===t&&this.removeProfile(e)}_snapshotReceived(e){this.profileBeingRecorded()===e&&this.setProfileBeingRecorded(null),this.dispatchEventToListeners(Yt.SnapshotReceived,e)}}Yt.TypeId="HEAP",Yt.SnapshotReceived="SnapshotReceived";class Zt extends Yt{constructor(){super(Zt.TypeId,e`Allocation instrumentation on timeline`),this._recordAllocationStacksSetting=l.Settings.instance().createSetting("recordAllocationStacks",!1),this._customContent=null,this._recording=!1}modelAdded(e){super.modelAdded(e),e.addEventListener(Z.Events.HeapStatsUpdate,this._heapStatsUpdate,this),e.addEventListener(Z.Events.LastSeenObjectId,this._lastSeenObjectId,this)}modelRemoved(e){super.modelRemoved(e),e.removeEventListener(Z.Events.HeapStatsUpdate,this._heapStatsUpdate,this),e.removeEventListener(Z.Events.LastSeenObjectId,this._lastSeenObjectId,this)}_heapStatsUpdate(e){if(!this._profileSamples)return;const t=e.data;let i;for(let e=0;e<t.length;e+=3){i=t[e];const s=t[e+2];this._profileSamples.sizes[i]=s,this._profileSamples.max[i]||(this._profileSamples.max[i]=s)}}_lastSeenObjectId(e){const t=this._profileSamples;if(!t)return;const i=e.data,s=Math.max(t.ids.length,t.max.length-1);t.ids[s]=i.lastSeenObjectId,t.max[s]||(t.max[s]=0,t.sizes[s]=0),t.timestamps[s]=i.timestamp,t.totalTime<i.timestamp-t.timestamps[0]&&(t.totalTime*=2),this.dispatchEventToListeners(Zt.HeapStatsUpdate,this._profileSamples);const r=this.profileBeingRecorded();r&&r.updateStatus(null,!0)}hasTemporaryView(){return!0}get buttonTooltip(){return this._recording?e`Stop recording heap profile`:e`Start recording heap profile`}isInstantProfile(){return!1}buttonClicked(){return this._toggleRecording()}_startRecordingProfile(){if(this.profileBeingRecorded())return;const e=this._addNewProfile();e&&e.startTrackingHeapObjects(this._recordAllocationStacksSetting.get())}customContent(){const t=B.createSettingCheckbox(e`Record allocation stacks (extra performance overhead)`,this._recordAllocationStacksSetting,!0);return this._customContent=t,t}setCustomContentEnabled(e){this._customContent&&(this._customContent.checkboxElement.disabled=!e)}_addNewProfile(){const e=E.Context.instance().flavor(Z.HeapProfilerModel);return e?(this.setProfileBeingRecorded(new ei(e,this,void 0)),this._profileSamples=new rt,this.profileBeingRecorded()._profileSamples=this._profileSamples,this._recording=!0,this.addProfile(this.profileBeingRecorded()),this.profileBeingRecorded().updateStatus(o.UIString("Recording…")),this.dispatchEventToListeners(Zt.TrackingStarted),e):null}async _stopRecordingProfile(){let e=this.profileBeingRecorded();e.updateStatus(o.UIString("Snapshotting…"));const t=e.heapProfilerModel().stopTrackingHeapObjects(!0);this._recording=!1,this.dispatchEventToListeners(Zt.TrackingStopped),await t,e=this.profileBeingRecorded(),e&&(e._finishLoad(),this._profileSamples=null,this.setProfileBeingRecorded(null),this.dispatchEventToListeners(Ee.ProfileComplete,e))}_toggleRecording(){return this._recording?this._stopRecordingProfile():this._startRecordingProfile(),this._recording}fileExtension(){return".heaptimeline"}get treeItemTitle(){return e`ALLOCATION TIMELINES`}get description(){return e`
        Allocation timelines show instrumented JavaScript memory allocations over time.
        Once profile is recorded you can select a time interval to see objects that
        were allocated within it and still alive by the end of recording.
        Use this profile type to isolate memory leaks.`}_resetProfiles(e){const t=this._recording;this.setProfileBeingRecorded(null),super._resetProfiles(e),this._profileSamples=null,t&&this._addNewProfile()}profileBeingRecordedRemoved(){this._stopRecordingProfile(),this._profileSamples=null}}Zt.TypeId="HEAP-RECORD",Zt.HeapStatsUpdate="HeapStatsUpdate",Zt.TrackingStarted="TrackingStarted",Zt.TrackingStopped="TrackingStopped";class ei extends Te{constructor(e,t,i){super(t,i||o.UIString("Snapshot %d",t.nextProfileUid())),this._heapProfilerModel=e,this.maxJSObjectId=-1,this._workerProxy=null,this._receiver=null,this._snapshotProxy=null,this._loadPromise=new Promise((e=>{this._fulfillLoad=e})),this._totalNumberOfChunks=0,this._bufferedWriter=null,this._onTempFileReady=null}heapProfilerModel(){return this._heapProfilerModel}async getLocation(e){return this._snapshotProxy?this._snapshotProxy.getLocation(e):null}createSidebarTreeElement(e){return new ke(e,this,"heap-snapshot-sidebar-tree-item")}createView(e){return new At(e,this)}_prepareToLoad(){console.assert(!this._receiver,"Already loading"),this._setupWorker(),this.updateStatus(o.UIString("Loading…"),!0)}_finishLoad(){!this._wasDisposed&&this._receiver&&this._receiver.close(),this._bufferedWriter&&this._didWriteToTempFile(this._bufferedWriter)}_didWriteToTempFile(e){this._wasDisposed?e&&e.remove():(this.tempFile=e,e||(this._failedToCreateTempFile=!0),this._onTempFileReady&&(this._onTempFileReady(),this._onTempFileReady=null))}_setupWorker(){console.assert(!this._workerProxy,"HeapSnapshotWorkerProxy already exists"),this._workerProxy=new Vt(this._handleWorkerEvent.bind(this)),this._workerProxy.addEventListener(Vt.Events.Wait,(e=>{this.updateStatus(null,e.data)}),this),this._receiver=this._workerProxy.createLoader(this.uid,this._snapshotReceived.bind(this))}_handleWorkerEvent(t,i){if(le.HeapSnapshotProgressEvent.BrokenSnapshot===t){const e=i;return void c.Console.instance().error(e)}if(le.HeapSnapshotProgressEvent.Update!==t)return;const s=i,r=o.deserializeUIString(s);this.updateStatus(e(r.messageParts,r.values))}dispose(){this._workerProxy&&this._workerProxy.dispose(),this.removeTempFile(),this._wasDisposed=!0}_didCompleteSnapshotTransfer(){this._snapshotProxy&&this.updateStatus(i.bytesToString(this._snapshotProxy.totalSize),!1)}transferChunk(e){this._bufferedWriter||(this._bufferedWriter=new ne.TempFile),this._bufferedWriter.write([e]),++this._totalNumberOfChunks,this._receiver&&this._receiver.write(e)}_snapshotReceived(e){this._wasDisposed||(this._receiver=null,this._snapshotProxy=e,this.maxJSObjectId=e.maxJSObjectId(),this._didCompleteSnapshotTransfer(),this._workerProxy&&this._workerProxy.startCheckingForLongRunningCalls(),this.notifySnapshotReceived())}notifySnapshotReceived(){this._snapshotProxy&&this._fulfillLoad(this._snapshotProxy),this.profileType()._snapshotReceived(this),this.canSaveToFile()&&this.dispatchEventToListeners(xe.ProfileReceived)}canSaveToFile(){return!this.fromFile()&&Boolean(this._snapshotProxy)}saveToFile(){const e=new oe.FileOutputStream;this._fileName=this._fileName||"Heap-"+s.toISO8601Compact(new Date)+this.profileType().fileExtension();const t=async i=>{if(i){if(this._failedToCreateTempFile)return c.Console.instance().error("Failed to open temp file with heap snapshot"),void e.close();if(this.tempFile){const t=await this.tempFile.copyToOutputStream(e,this._onChunkTransferred.bind(this));return t&&c.Console.instance().error("Failed to read heap snapshot from temp file: "+t.message),void this._didCompleteSnapshotTransfer()}this._onTempFileReady=()=>{t(i)},this._updateSaveProgress(0,1)}};e.open(this._fileName).then(t.bind(this))}_onChunkTransferred(e){this._updateSaveProgress(e.loadedSize(),e.fileSize())}_updateSaveProgress(e,t){const i=(100*(t&&e/t)).toFixed(0);this.updateStatus(o.UIString("Saving… %d%%",i))}async loadFromFile(e){this.updateStatus(o.UIString("Loading…"),!0),this._setupWorker();const t=new oe.ChunkedFileReader(e,1e7),i=await t.read(this._receiver);if(!i){const e=t.error();e&&this.updateStatus(e.message)}return i?null:t.error()}}class ti extends S.VBox{constructor(){super(),this.element.classList.add("heap-snapshot-statistics-view"),this._pieChart=new $.PieChart,this.setTotalAndRecords(0,[]),this._pieChart.classList.add("heap-snapshot-stats-pie-chart"),this.element.appendChild(this._pieChart)}static _valueFormatter(e){return o.UIString("%s kB",Number.withThousandsSeparator(Math.round(e/1e3)))}setTotalAndRecords(t,i){this._pieChart.data={chartName:e`Heap memory usage`,size:150,formatter:ti._valueFormatter,showLegend:!0,total:t,slices:i}}}class ii extends S.Widget{constructor(e){super(),this._heapProfilerModel=e,this._linkifier=new q.Linkifier,this._frameElements=[]}_onContextMenu(e,t){const i=new T.ContextMenu(t);i.containsTarget(e)||i.appendApplicableItems(e),i.show(),t.consume(!0)}_onStackViewKeydown(e){const t=e.target;if(!t)return;if("Enter"===e.key){const i=si.get(t);if(!i)return;const s=q.Linkifier.linkInfo(i);if(!s)return;return void(q.Linkifier.invokeFirstAction(s)&&e.consume(!0))}let i;const s=e;if("ArrowUp"===s.key)i=!1;else{if("ArrowDown"!==s.key)return;i=!0}const r=this._frameElements.indexOf(t);if(-1===r)return;const o=i?r+1:r-1;if(o<0||o>=this._frameElements.length)return;const n=this._frameElements[o];n.tabIndex=0,t.tabIndex=-1,n.focus(),e.consume(!0)}async setAllocatedObject(e,t){this.clear();const i=await e.allocationStack(t);if(!i){const e=this.element.createChild("div","no-heap-allocation-stack");return void g.createTextChild(e,o.UIString("Stack was not recorded for this object because it had been allocated before this profile recording started."))}const s=this.element.createChild("div","heap-allocation-stack");s.addEventListener("keydown",this._onStackViewKeydown.bind(this),!1);for(const e of i){const t=s.createChild("div","stack-frame");this._frameElements.push(t),t.tabIndex=-1;if(t.createChild("div").textContent=g.beautifyFunctionName(e.functionName),!e.scriptId)continue;const i=this._heapProfilerModel?this._heapProfilerModel.target():null,r={columnNumber:e.column-1},o=this._linkifier.linkifyScriptLocation(i,String(e.scriptId),e.scriptName,e.line-1,r);t.appendChild(o),si.set(t,o),t.addEventListener("contextmenu",this._onContextMenu.bind(this,o))}this._frameElements[0].tabIndex=0}clear(){this.element.removeChildren(),this._frameElements=[],this._linkifier.reset()}}const si=new WeakMap;var ri=Object.freeze({__proto__:null,HeapSnapshotView:At,Perspective:$t,SummaryPerspective:qt,ComparisonPerspective:Jt,ContainmentPerspective:Qt,AllocationPerspective:Kt,StatisticsPerspective:Xt,HeapSnapshotProfileType:Yt,TrackingHeapSnapshotProfileType:Zt,HeapProfileHeader:ei,HeapSnapshotStatisticsView:ti,HeapAllocationStackView:ii});class oi{constructor(){this.cpuProfileType=new We,this.heapSnapshotProfileType=new Yt,this.samplingHeapProfileType=new ct,this.trackingHeapSnapshotProfileType=new Zt}}const ni=new oi;var ai=Object.freeze({__proto__:null,ProfileTypeRegistry:oi,instance:ni});class li extends O.PanelWithSidebar{constructor(e,t,i){super(e),this._profileTypes=t,this.registerRequiredCSS("profiler/heapProfiler.css",{enableLegacyPatching:!0}),this.registerRequiredCSS("profiler/profilesPanel.css",{enableLegacyPatching:!0}),this.registerRequiredCSS("object_ui/objectValue.css",{enableLegacyPatching:!0});const s=new S.VBox;this.splitWidget().setMainWidget(s),this.profilesItemTreeElement=new pi(this),this._sidebarTree=new C.TreeOutlineInShadow,this._sidebarTree.registerRequiredCSS("profiler/profilesSidebarTree.css",{enableLegacyPatching:!0}),this._sidebarTree.element.classList.add("profiles-sidebar-tree-box"),this.panelSidebarElement().appendChild(this._sidebarTree.element),this._sidebarTree.appendChild(this.profilesItemTreeElement),this._sidebarTree.element.addEventListener("keydown",this._onKeyDown.bind(this),!1),this.profileViews=document.createElement("div"),this.profileViews.id="profile-views",this.profileViews.classList.add("vbox"),s.element.appendChild(this.profileViews),this._toolbarElement=document.createElement("div"),this._toolbarElement.classList.add("profiles-toolbar"),s.element.insertBefore(this._toolbarElement,s.element.firstChild),this.panelSidebarElement().classList.add("profiles-tree-sidebar");const r=document.createElement("div");r.classList.add("profiles-toolbar"),this.panelSidebarElement().insertBefore(r,this.panelSidebarElement().firstChild);const n=new I.Toolbar("",r);this._toggleRecordAction=G.ActionRegistry.instance().action(i),this._toggleRecordButton=I.Toolbar.createActionButton(this._toggleRecordAction),n.appendToolbarItem(this._toggleRecordButton),this.clearResultsButton=new I.ToolbarButton(o.UIString("Clear all profiles"),"largeicon-clear"),this.clearResultsButton.addEventListener(I.ToolbarButton.Events.Click,this._reset,this),n.appendToolbarItem(this.clearResultsButton),n.appendSeparator(),n.appendToolbarItem(I.Toolbar.createActionButtonForId("components.collect-garbage")),this._profileViewToolbar=new I.Toolbar("",this._toolbarElement),this._profileGroups={},this._launcherView=new Ye(this),this._launcherView.addEventListener(Ze.ProfileTypeSelected,this._onProfileTypeSelected,this),this.visibleView,this._profileToView=[],this._typeIdToSidebarSection={};const a=this._profileTypes;for(let e=0;e<a.length;e++)this._registerProfileType(a[e]);this._launcherView.restoreSelectedProfileType(),this.profilesItemTreeElement.select(),this._showLauncherView(),this._fileSelectorElement,this._createFileSelectorElement(),this.element.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!1),J.TargetManager.instance().addEventListener(J.Events.SuspendStateChanged,this._onSuspendStateChanged,this),E.Context.instance().addFlavorChangeListener(Q.CPUProfilerModel,this._updateProfileTypeSpecificUI,this),E.Context.instance().addFlavorChangeListener(Z.HeapProfilerModel,this._updateProfileTypeSpecificUI,this)}_onKeyDown(e){const t=e;let i=!1;"ArrowDown"!==t.key||t.altKey?"ArrowUp"!==t.key||t.altKey||(i=this._sidebarTree.selectPrevious()):i=this._sidebarTree.selectNext(),i&&t.consume(!0)}searchableView(){const e=this.visibleView;return e&&e.searchableView?e.searchableView():null}_createFileSelectorElement(){this._fileSelectorElement&&this.element.removeChild(this._fileSelectorElement),this._fileSelectorElement=g.createFileSelectorElement(this._loadFromFile.bind(this)),Fe(this._fileSelectorElement),this.element.appendChild(this._fileSelectorElement)}_findProfileTypeByExtension(e){return this._profileTypes.find((t=>Boolean(t.fileExtension())&&e.endsWith(t.fileExtension()||"")))||null}async _loadFromFile(e){this._createFileSelectorElement();const t=this._findProfileTypeByExtension(e.name);if(!t){const e=new Set(this._profileTypes.map((e=>e.fileExtension())).filter((e=>e)));return void c.Console.instance().error(o.UIString("Can’t load file. Supported file extensions: `%s`.",Array.from(e).join("', '")))}if(Boolean(t.profileBeingRecorded()))return void c.Console.instance().error(o.UIString("Can’t load profile while another profile is being recorded."));const i=await t.loadFromFile(e);i&&"message"in i&&g.MessageDialog.show(o.UIString("Profile loading failed: %s.",i.message))}toggleRecord(){if(!this._toggleRecordAction.enabled())return!0;const e=this.element.ownerDocument.deepActiveElement(),t=this._selectedProfileType;if(!t)return!0;const i=t.buttonClicked();return this._updateToggleRecordAction(i),i?(this._launcherView.profileStarted(),t.hasTemporaryView()&&this.showProfile(t.profileBeingRecorded())):this._launcherView.profileFinished(),e&&e.focus(),!0}_onSuspendStateChanged(){this._updateToggleRecordAction(this._toggleRecordAction.toggled())}_updateToggleRecordAction(e){const t=Boolean(E.Context.instance().flavor(Q.CPUProfilerModel)||E.Context.instance().flavor(Z.HeapProfilerModel)),i=e||!J.TargetManager.instance().allTargetsSuspended()&&t;this._toggleRecordAction.setEnabled(i),this._toggleRecordAction.setToggled(e),i?this._toggleRecordButton.setTitle(this._selectedProfileType?this._selectedProfileType.buttonTooltip:""):this._toggleRecordButton.setTitle(g.anotherProfilerActiveLabel()),this._selectedProfileType&&this._launcherView.updateProfileType(this._selectedProfileType,i)}_profileBeingRecordedRemoved(){this._updateToggleRecordAction(!1),this._launcherView.profileFinished()}_onProfileTypeSelected(e){this._selectedProfileType=e.data,this._updateProfileTypeSpecificUI()}_updateProfileTypeSpecificUI(){this._updateToggleRecordAction(this._toggleRecordAction.toggled())}_reset(){this._profileTypes.forEach((e=>e.reset())),delete this.visibleView,this._profileGroups={},this._updateToggleRecordAction(!1),this._launcherView.profileFinished(),this._sidebarTree.element.classList.remove("some-expandable"),this._launcherView.detach(),this.profileViews.removeChildren(),this._profileViewToolbar.removeToolbarItems(),this.clearResultsButton.element.classList.remove("hidden"),this.profilesItemTreeElement.select(),this._showLauncherView()}_showLauncherView(){this.closeVisibleView(),this._profileViewToolbar.removeToolbarItems(),this._launcherView.show(this.profileViews),this.visibleView=this._launcherView,this._toolbarElement.classList.add("hidden")}_registerProfileType(e){this._launcherView.addProfileType(e);const t=new di(this,e);this._typeIdToSidebarSection[e.id]=t,this._sidebarTree.appendChild(t),t.childrenListElement.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!1),e.addEventListener(Ee.ViewUpdated,this._updateProfileTypeSpecificUI,this),e.addEventListener(Ee.AddProfileHeader,(function(e){this._addProfileHeader(e.data)}),this),e.addEventListener(Ee.RemoveProfileHeader,(function(e){this._removeProfileHeader(e.data)}),this),e.addEventListener(Ee.ProfileComplete,(function(e){this.showProfile(e.data)}),this);const i=e.getProfiles();for(let e=0;e<i.length;e++)this._addProfileHeader(i[e])}_handleContextMenuEvent(e){const t=new T.ContextMenu(e);this.panelSidebarElement().isSelfOrAncestor(e.target)&&t.defaultSection().appendItem(o.UIString("Load…"),this._fileSelectorElement.click.bind(this._fileSelectorElement)),t.show()}showLoadFromFileDialog(){this._fileSelectorElement.click()}_addProfileHeader(e){const t=e.profileType().id;this._typeIdToSidebarSection[t].addProfileHeader(e),this.visibleView&&this.visibleView!==this._launcherView||this.showProfile(e)}_removeProfileHeader(e){e.profileType().profileBeingRecorded()===e&&this._profileBeingRecordedRemoved();const t=this._indexOfViewForProfile(e);-1!==t&&this._profileToView.splice(t,1);const i=e.profileType().id;this._typeIdToSidebarSection[i].removeProfileHeader(e)&&(this.profilesItemTreeElement.select(),this._showLauncherView())}showProfile(e){if(!e||e.profileType().profileBeingRecorded()===e&&!e.profileType().hasTemporaryView())return null;const t=this.viewForProfile(e);if(t===this.visibleView)return t;this.closeVisibleView(),t.show(this.profileViews),this._toolbarElement.classList.remove("hidden"),this.visibleView=t;const i=this._typeIdToSidebarSection[e.profileType().id].sidebarElementForProfile(e);return i&&i.revealAndSelect(),this._profileViewToolbar.removeToolbarItems(),t.toolbarItems().then((e=>{e.map((e=>this._profileViewToolbar.appendToolbarItem(e)))})),t}showObject(e,t){}async linkifyObject(e){return null}viewForProfile(e){const t=this._indexOfViewForProfile(e);if(-1!==t)return this._profileToView[t].view;const i=e.createView(this);return i.element.classList.add("profile-view"),this._profileToView.push({profile:e,view:i}),i}_indexOfViewForProfile(e){return this._profileToView.findIndex((t=>t.profile===e))}closeVisibleView(){this.visibleView&&this.visibleView.detach(),delete this.visibleView}focus(){this._sidebarTree.focus()}}class di extends C.TreeElement{constructor(e,t){super(t.treeItemTitle,!0),this.selectable=!1,this._dataDisplayDelegate=e,this._profileTreeElements=[],this._profileGroups={},this.expand(),this.hidden=!0,this.setCollapsible(!1)}addProfileHeader(e){this.hidden=!1;const t=e.profileType();let i=this;const s=e.createSidebarTreeElement(this._dataDisplayDelegate);if(this._profileTreeElements.push(s),!e.fromFile()&&t.profileBeingRecorded()!==e){const t=e.title;let r=this._profileGroups[t];r||(r=new hi,this._profileGroups[t]=r),r.profileSidebarTreeElements.push(s);const n=r.profileSidebarTreeElements.length;if(2===n){r.sidebarTreeElement=new ci(this._dataDisplayDelegate,e.title);const t=r.profileSidebarTreeElements[0],i=this.children().indexOf(t);this.insertChild(r.sidebarTreeElement,i);const s=t.selected;this.removeChild(t),r.sidebarTreeElement.appendChild(t),s&&t.revealAndSelect(),t.setSmall(!0),t.setMainTitle(o.UIString("Run %d",1)),this.treeOutline&&this.treeOutline.element.classList.add("some-expandable")}n>=2&&(i=r.sidebarTreeElement,s.setSmall(!0),s.setMainTitle(o.UIString("Run %d",n)))}i&&i.appendChild(s)}removeProfileHeader(e){const t=this._sidebarElementIndex(e);if(-1===t)return!1;const i=this._profileTreeElements[t];this._profileTreeElements.splice(t,1);let s=this;const r=this._profileGroups[e.title];if(r){const t=r.profileSidebarTreeElements;if(t.splice(t.indexOf(i),1),1===t.length){const i=s.children().indexOf(r.sidebarTreeElement);r.sidebarTreeElement&&r.sidebarTreeElement.removeChild(t[0]),this.insertChild(t[0],i),t[0].setSmall(!1),t[0].setMainTitle(e.title),r.sidebarTreeElement&&this.removeChild(r.sidebarTreeElement)}0!==t.length&&(s=r.sidebarTreeElement)}return s&&s.removeChild(i),i.dispose(),!this.childCount()&&(this.hidden=!0,!0)}sidebarElementForProfile(e){const t=this._sidebarElementIndex(e);return-1===t?null:this._profileTreeElements[t]}_sidebarElementIndex(e){const t=this._profileTreeElements;for(let i=0;i<t.length;i++)if(t[i].profile===e)return i;return-1}onattach(){this.listItemElement.classList.add("profiles-tree-section")}}class hi{constructor(){this.profileSidebarTreeElements=[],this.sidebarTreeElement=null}}class ci extends C.TreeElement{constructor(e,t){super("",!0),this.selectable=!1,this._dataDisplayDelegate=e,this._profileTitle=t,this.expand(),this.toggleOnClick=!0}onselect(){const e=this.childCount()>0;if(e){const e=this.lastChild();e instanceof ke&&this._dataDisplayDelegate.showProfile(e.profile)}return e}onattach(){this.listItemElement.classList.add("profile-group-sidebar-tree-item"),this.listItemElement.createChild("div","icon"),this.listItemElement.createChild("div","titles no-subtitle").createChild("span","title-container").createChild("span","title").textContent=this._profileTitle}}class pi extends C.TreeElement{constructor(e){super("",!1),this.selectable=!0,this._panel=e}onselect(){return this._panel._showLauncherView(),!0}onattach(){this.listItemElement.classList.add("profile-launcher-view-tree-item"),this.listItemElement.createChild("div","icon"),this.listItemElement.createChild("div","titles no-subtitle").createChild("span","title-container").createChild("span","title").textContent=o.UIString("Profiles")}}let ui;class _i extends li{constructor(){super("js_profiler",[ni.cpuProfileType],"profiler.js-toggle-recording")}static instance(e={forceNew:null}){const{forceNew:t}=e;return ui&&!t||(ui=new _i),ui}wasShown(){E.Context.instance().setFlavor(_i,this)}willHide(){E.Context.instance().setFlavor(_i,null)}handleAction(e,t){const i=E.Context.instance().flavor(_i);if(!(i instanceof _i))throw new Error("non-null JSProfilerPanel expected!");return i.toggleRecord(),!0}}var mi=Object.freeze({__proto__:null,ProfilesPanel:li,ProfileTypeSidebarSection:di,ProfileGroup:hi,ProfileGroupSidebarTreeElement:ci,ProfilesSidebarTreeElement:pi,JSProfilerPanel:_i});let fi;class gi extends li{constructor(){const e=ni;super("heap_profiler",[e.heapSnapshotProfileType,e.trackingHeapSnapshotProfileType,e.samplingHeapProfileType],"profiler.heap-toggle-recording")}static instance(){return fi||(fi=new gi),fi}appendApplicableItems(e,t,i){if(!(i instanceof ie.RemoteObject))return;if(!this.isShowing())return;const s=i;if(!s.objectId)return;const r=s.objectId;if(!ni.heapSnapshotProfileType.getProfiles().length)return;const n=s.runtimeModel().heapProfilerModel();n&&t.revealSection().appendItem(o.UIString("Reveal in Summary view"),function(e){n.snapshotObjectIdForObjectId(r).then((t=>{this.isShowing()&&t&&this.showObject(t,e)}))}.bind(this,"Summary"))}handleAction(e,t){const i=E.Context.instance().flavor(gi);return console.assert(Boolean(i)&&i instanceof gi),i&&i.toggleRecord(),!0}wasShown(){E.Context.instance().setFlavor(gi,this),z.panelLoaded("heap_profiler","DevTools.Launch.HeapProfiler")}willHide(){E.Context.instance().setFlavor(gi,null)}showObject(e,t){const i=ni.heapSnapshotProfileType.getProfiles();for(let s=0;s<i.length;s++){const r=i[s];if(r.maxJSObjectId>=parseInt(e,10)){this.showProfile(r);this.viewForProfile(r).selectLiveObject(t,e);break}}}}var vi=Object.freeze({__proto__:null,HeapProfilerPanel:gi});let wi,Si;class Ci extends S.VBox{constructor(){super(!0),this._gridNodeByUrl=new Map,this.registerRequiredCSS("profiler/liveHeapProfile.css",{enableLegacyPatching:!0}),this._setting=l.Settings.instance().moduleSetting("memoryLiveHeapProfile");const e=new I.Toolbar("live-heap-profile-toolbar",this.contentElement);this._toggleRecordAction=G.ActionRegistry.instance().action("live-heap-profile.toggle-recording"),this._toggleRecordButton=I.Toolbar.createActionButton(this._toggleRecordAction),this._toggleRecordButton.setToggled(this._setting.get()),e.appendToolbarItem(this._toggleRecordButton);const t=J.TargetManager.instance().mainTarget();if(t&&t.model(se.ResourceTreeModel)){const t=G.ActionRegistry.instance().action("live-heap-profile.start-with-reload");this._startWithReloadButton=I.Toolbar.createActionButton(t),e.appendToolbarItem(this._startWithReloadButton)}this._dataGrid=this._createDataGrid(),this._dataGrid.asWidget().show(this.contentElement),this._currentPollId=0}static instance(){return wi||(wi=new Ci),wi}_createDataGrid(){const t={id:"",title:e``,width:void 0,fixedWidth:!0,sortable:!0,align:_.Align.Right,sort:_.Order.Descending,titleDOMFragment:void 0,editable:void 0,nonSelectable:void 0,longText:void 0,disclosure:void 0,weight:void 0,allowInSortByEvenWhenHidden:void 0,dataType:void 0,defaultWeight:void 0},i=[{...t,id:"size",title:e`JS Heap`,width:"72px",fixedWidth:!0,sortable:!0,align:_.Align.Right,sort:_.Order.Descending,tooltip:e`Allocated JS heap size currently in use`},{...t,id:"isolates",title:e`VMs`,width:"40px",fixedWidth:!0,align:_.Align.Right,tooltip:e`Number of VMs sharing the same script source`},{...t,id:"url",title:e`Script URL`,fixedWidth:!1,sortable:!0,tooltip:e`URL of the script source`}],s=new f.SortableDataGrid({displayName:e`Heap Profile`,columns:i,editCallback:void 0,deleteCallback:void 0,refreshCallback:void 0});s.setResizeMethod(_.ResizeMethod.Last),s.element.classList.add("flex-auto"),s.element.addEventListener("keydown",this._onKeyDown.bind(this),!1),s.addEventListener(_.Events.OpenedNode,this._revealSourceForSelectedNode,this),s.addEventListener(_.Events.SortingChanged,this._sortingChanged,this);for(const e of i){const t=s.headerTableHeader(e.id);t&&t.setAttribute("title",e.tooltip)}return s}wasShown(){this._poll(),this._setting.addChangeListener(this._settingChanged,this)}willHide(){++this._currentPollId,this._setting.removeChangeListener(this._settingChanged,this)}_settingChanged(e){this._toggleRecordButton.setToggled(e.data)}async _poll(){const e=this._currentPollId;do{const t=Array.from(X.IsolateManager.instance().isolates()),i=await Promise.all(t.map((e=>{const t=e.heapProfilerModel();return t?t.getSamplingProfile():null})));if(this._currentPollId!==e)return;this._update(t,i),await new Promise((e=>setTimeout(e,3e3)))}while(this._currentPollId===e)}_update(e,t){const i=new Map;t.forEach(((t,i)=>{t&&n(e[i],"",t.head)}));const s=this._dataGrid.rootNode(),r=new Set;for(const e of i){const t=e[0],i=e[1].size,o=e[1].isolates.size;if(!t){console.info(`Node with empty URL: ${i} bytes`);continue}let n=this._gridNodeByUrl.get(t);n?n.updateNode(i,o):(n=new bi(t,i,o),this._gridNodeByUrl.set(t,n),s.appendChild(n)),r.add(n)}for(const e of s.children.slice()){r.has(e)||e.remove();const t=e;this._gridNodeByUrl.delete(t._url)}function n(e,t,s){const r=s.callFrame.url||t||function(e){const t=e.callFrame.functionName;return t.startsWith("(")&&"(root)"!==t?t:""}(s)||function(e){return Number(e.callFrame.scriptId)?o.UIString("(Anonymous Script %s)",e.callFrame.scriptId):""}(s);if(s.children.forEach(n.bind(null,e,r)),!s.selfSize)return;let a=i.get(r);a||(a={size:0,isolates:new Set},i.set(r,a)),a.size+=s.selfSize,a.isolates.add(e)}this._sortingChanged()}_onKeyDown(e){"Enter"===e.key&&(e.consume(!0),this._revealSourceForSelectedNode())}_revealSourceForSelectedNode(){const e=this._dataGrid.selectedNode;if(!e||!e._url)return;const t=he.WorkspaceImpl.instance().uiSourceCodeForURL(e._url);t&&d.reveal(t)}_sortingChanged(){const e=this._dataGrid.sortColumnId();if(!e)return;const t="url"===e?function(e,t){return t._url.localeCompare(e._url)}:function(e,t){return t._size-e._size};this._dataGrid.sortNodes(t,this._dataGrid.isSortOrderAscending())}_toggleRecording(){!this._setting.get()?this._startRecording(!1):this._stopRecording()}_startRecording(e){if(this._setting.set(!0),!e)return;const t=J.TargetManager.instance().mainTarget();if(!t)return;const i=t.model(se.ResourceTreeModel);i&&i.reloadPage()}async _stopRecording(){this._setting.set(!1)}}class bi extends f.SortableDataGridNode{constructor(e,t,i){super(),this._url=e,this._size=t,this._isolateCount=i}updateNode(e,t){this._size===e&&this._isolateCount===t||(this._size=e,this._isolateCount=t,this.refresh())}createCell(t){const i=this.createTD(t);switch(t){case"url":i.textContent=this._url;break;case"size":i.textContent=Number.withThousandsSeparator(Math.round(this._size/1e3)),i.createChild("span","size-units").textContent=e`kB`;break;case"isolates":i.textContent=""+this._isolateCount}return i}}class Pi{static instance(e={forceNew:null}){const{forceNew:t}=e;return Si&&!t||(Si=new Pi),Si}handleAction(e,t){return(async()=>{const e="live_heap_profile";await V.ViewManager.instance().showView(e);const i=V.ViewManager.instance().view(e);if(i){const e=await i.widget();this._innerHandleAction(e,t)}})(),!0}_innerHandleAction(e,t){switch(t){case"live-heap-profile.toggle-recording":e._toggleRecording();break;case"live-heap-profile.start-with-reload":e._startRecording(!0);break;default:console.assert(!1,"Unknown action: "+t)}}}var Ti=Object.freeze({__proto__:null,LiveHeapProfileView:Ci,GridNode:bi,ActionDelegate:Pi});export{fe as BottomUpProfileDataGrid,Pe as CPUProfileFlameChart,Je as CPUProfileView,ge as ChildrenProvider,gt as HeapProfileView,vi as HeapProfilerPanel,Gt as HeapSnapshotDataGrids,It as HeapSnapshotGridNodes,Wt as HeapSnapshotProxy,ri as HeapSnapshotView,nt as HeapTimelineOverview,Xe as IsolateSelector,Ti as LiveHeapProfileView,ue as ProfileDataGrid,Ne as ProfileHeader,et as ProfileLauncherView,Le as ProfileSidebarTreeElement,ai as ProfileTypeRegistry,je as ProfileView,mi as ProfilesPanel,Oe as TopDownProfileDataGrid};
