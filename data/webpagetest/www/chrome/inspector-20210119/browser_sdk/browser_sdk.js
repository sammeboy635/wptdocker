import{Revealer as e,ObjectWrapper as s,EventTarget as t}from"../common/common.js";import{DebuggerModel as i,ContentSecurityPolicyIssue as r,SDKModel as n,IssuesModel as o,FrameManager as a,Issue as d,LogModel as u,ConsoleModel as c,RuntimeModel as l,NetworkLog as h,NetworkRequest as g,Cookie as m}from"../sdk/sdk.js";import{LiveLocation as f,DebuggerWorkspaceBinding as p}from"../bindings/bindings.js";import{Marked as v}from"../third_party/marked/marked.js";import{UISourceCode as I}from"../workspace/workspace.js";import{Runtime as M}from"../root/root.js";class _{constructor(e){this.locationPool=new f.LiveLocationPool,this.issueMessages=new Array,this.issuesManager=e,this.issuesManager.addEventListener(L.IssueAdded,this.onIssueAdded,this),this.issuesManager.addEventListener(L.FullUpdateRequired,this.onFullUpdateRequired,this)}onIssueAdded(e){const{issue:s}=e.data;this.addIssue(s)}addIssue(e){if(!this.isTrustedTypeIssue(e))return;const s=e.model();if(!s)return;const t=s.target().model(i.DebuggerModel),r=e.details().sourceCodeLocation;if(r&&t){const s=t.createRawLocationByURL(r.url,r.lineNumber,r.columnNumber);s&&this.addIssueMessageToScript(e,s)}}onFullUpdateRequired(){this.resetMessages();const e=this.issuesManager.issues();for(const s of e)this.addIssue(s)}createIssueDescriptionFromMarkdown(e){const s=function(e){const s=M.cachedResources.get(e);if(!s)throw new Error(`Markdown file ${e} not found. Declare it as a resource in the module.json file`);return s}(e.file);return function(e){return 0===e.length||"heading"!==e[0].type||1!==e[0].depth?null:e[0].text}(v.lexer(s))}addIssueMessageToScript(s,t){const i=s.getDescription();if(i&&"file"in i){const r=this.createIssueDescriptionFromMarkdown(i);if(r){const i=()=>{e.reveal(s)};this.issueMessages.push(new y(r,t,this.locationPool,i))}}}isTrustedTypeIssue(e){return e instanceof r.ContentSecurityPolicyIssue&&e.code()===r.trustedTypesSinkViolationCode||e.code()===r.trustedTypesPolicyViolationCode}resetMessages(){for(const e of this.issueMessages)e.dispose();this.issueMessages=[],this.locationPool.disposeAll()}}class y{constructor(e,s,t,i){this.text=e,this.level=I.Message.Level.Issue,this.uiMessage=void 0,this.clickHandler=i,p.DebuggerWorkspaceBinding.instance().createLiveLocation(s,this.updateLocation.bind(this),t)}async updateLocation(e){this.uiMessage&&this.uiMessage.remove();const s=await e.uiLocation();s&&(this.uiMessage=s.uiSourceCode.addLineMessage(this.level,this.text,s.lineNumber,s.columnNumber,this.clickHandler))}dispose(){this.uiMessage?.remove()}getText(){return this.text}getLevel(){return this.level}}let T=null;class w extends s.ObjectWrapper{constructor(){super(),this._eventListeners=new WeakMap,n.TargetManager.instance().observeModels(o.IssuesModel,this),this._issues=new Map,this._filteredIssues=new Map,this._hasSeenTopFrameNavigated=!1,a.FrameManager.instance().addEventListener(a.Events.TopFrameNavigated,this._onTopFrameNavigated,this),a.FrameManager.instance().addEventListener(a.Events.FrameAddedToTarget,this._onFrameAddedToTarget,this),this._showThirdPartySettingsChangeListener=null,this._sourceFrameIssuesManager=new _(this)}static instance({forceNew:e}={forceNew:!1}){return T&&!e||(T=new w),T}reloadForAccurateInformationRequired(){return!this._hasSeenTopFrameNavigated}_onTopFrameNavigated(e){const{frame:s}=e.data,t=new Map;for(const[e,i]of this._issues.entries())i.isAssociatedWithRequestId(s.loaderId)&&t.set(e,i);this._issues=t,this._hasSeenTopFrameNavigated=!0,this._updateFilteredIssues()}_onFrameAddedToTarget(e){const{frame:s}=e.data;s.isTopFrame()&&this._updateFilteredIssues()}modelAdded(e){const s=e.addEventListener(o.Events.IssueAdded,this._issueAdded,this);this._eventListeners.set(e,s)}modelRemoved(e){const s=this._eventListeners.get(e);s&&t.EventTarget.removeEventListeners([s])}_issueAdded(e){const{issuesModel:s,issue:t}=e.data;if(!t.getDescription())return;const i=t.primaryKey();this._issues.has(i)||(this._issues.set(i,t),this._issueFilter(t)&&(this._filteredIssues.set(i,t),this.dispatchEventToListeners(L.IssueAdded,{issuesModel:s,issue:t})),this.dispatchEventToListeners(L.IssuesCountUpdated))}issues(){return this._filteredIssues.values()}numberOfIssues(){return this._filteredIssues.size}numberOfAllStoredIssues(){return this._issues.size}_issueFilter(e){if(!this._showThirdPartySettingsChangeListener){const e=d.getShowThirdPartyIssuesSetting();this._showThirdPartySettingsChangeListener=e.addChangeListener((()=>{this._updateFilteredIssues()}))}return d.getShowThirdPartyIssuesSetting().get()||!e.isCausedByThirdParty()}_updateFilteredIssues(){this._filteredIssues.clear();for(const[e,s]of this._issues)this._issueFilter(s)&&this._filteredIssues.set(e,s);this.dispatchEventToListeners(L.FullUpdateRequired),this.dispatchEventToListeners(L.IssuesCountUpdated)}}const L={IssuesCountUpdated:Symbol("IssuesCountUpdated"),IssueAdded:Symbol("IssueAdded"),FullUpdateRequired:Symbol("FullUpdateRequired")};var F=Object.freeze({__proto__:null,IssuesManager:w,Events:L});const A=new WeakMap;class k{constructor(){n.TargetManager.instance().observeModels(u.LogModel,this)}modelAdded(e){const s=[];s.push(e.addEventListener(u.Events.EntryAdded,this._logEntryAdded,this)),A.set(e,s)}modelRemoved(e){const s=A.get(e);s&&t.EventTarget.removeEventListeners(s)}_logEntryAdded(e){const s=e.data,t=s.logModel.target(),i=new c.ConsoleMessage(t.model(l.RuntimeModel),s.entry.source,s.entry.level,s.entry.text,void 0,s.entry.url,s.entry.lineNumber,void 0,[s.entry.text,...s.entry.args||[]],s.entry.stackTrace,s.entry.timestamp,void 0,void 0,s.entry.workerId);if(s.entry.networkRequestId&&h.NetworkLog.instance().associateConsoleMessageWithRequest(i,s.entry.networkRequestId),i.source===c.MessageSource.Worker){const e=i.workerId||"";if(n.TargetManager.instance().targetById(e))return;setTimeout((()=>{n.TargetManager.instance().targetById(e)||c.ConsoleModel.instance().addMessage(i)}),1e3)}else c.ConsoleModel.instance().addMessage(i)}}var E=Object.freeze({__proto__:null,LogManager:k});function b(e,s){if(s instanceof g.NetworkRequest)return function(e,s){return e.filter((e=>{for(const t of e.requests())if(t.requestId===s.requestId())return!0;return!1}))}(e,s);if(s instanceof m.Cookie)return function(e,s,t,i){return e.filter((e=>{for(const r of e.cookies())if(r.domain===s&&r.name===t&&r.path===i)return!0;return!1}))}(e,s.domain(),s.name(),s.path());throw new Error("issues can not be associated with "+JSON.stringify(s))}var C=Object.freeze({__proto__:null,IssuesAssociatable:undefined,issuesAssociatedWith:b,hasIssues:function(e){return b(Array.from(w.instance().issues()),e).length>0},hasIssueOfCategory:function(e,s){return b(Array.from(w.instance().issues()),e).some((e=>e.getCategory()===s))},reveal:async function(s,t){const i=b(Array.from(w.instance().issues()),s).filter((e=>!t||e.getCategory()===t));if(i.length>0)return e.reveal(i[0])}});const S=new k;w.instance();export{F as IssuesManager,E as LogManager,C as RelatedIssue,S as logManager};
