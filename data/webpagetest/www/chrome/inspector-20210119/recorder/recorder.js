import{RuntimeModel as e,ResourceTreeModel as t,DOMModel as n,AccessibilityModel as i,NetworkManager as r,DebuggerModel as s,ChildTargetManager as o,DOMDebuggerModel as a,SDKModel as c}from"../sdk/sdk.js";import{ActionRegistry as d}from"../ui/ui.js";import{Settings as g,Revealer as l,ResourceType as u}from"../common/common.js";import{DOMPath as h}from"../elements/elements.js";import{i18n as p}from"../i18n/i18n.js";import{PlatformFileSystem as m,FileSystemWorkspaceBinding as w}from"../persistence/persistence.js";import{Workspace as f}from"../workspace/workspace.js";const S=new Set(["button","link","textbox","checkbox"]);class _{constructor(r,s){this.target=s,this.session=r,this.runtimeAgent=s.runtimeAgent(),this.debuggerAgent=s.debuggerAgent(),this.runtimeModel=s.model(e.RuntimeModel),this.resourceTreeModel=s.model(t.ResourceTreeModel),this.domModel=s.model(n.DOMModel),this.axModel=s.model(i.AccessibilityModel)}async isSubmitButton(e){const{result:t}=await this.runtimeAgent.invoke_callFunctionOn({functionDeclaration:function(){return"BUTTON"===this.tagName&&"submit"===this.type&&null!==this.form}.toString(),objectId:e});return t.value}async getSelector(e){const t=await this.getAriaSelector(e);if(t)return t;const n=h.cssPath(e);return n||null}async findTargetId(e,t){const n=e.find((e=>Boolean(e&&e.value&&e.value.className&&t.includes(e.value.className))));if(!n||!n.value||!n.value.objectId)return null;const i=await this.runtimeAgent.invoke_getProperties({objectId:n.value.objectId});if(!i)return null;const r=i.result.find((e=>"target"===e.name));return r&&r.value&&r.value.objectId||null}async getAriaSelector(e){await this.axModel.requestPartialAXTree(e);let t=this.axModel.axNodeForDOMNode(e);for(;t;){const e=t.role(),n=t.name(),i=e?e.value:null,r=n?n.value:null;if(r&&S.has(i))return"aria/"+r;t=t.parentNode()}return null}async handleClickEvent(e,t){const n=await this.findTargetId(t,["MouseEvent","PointerEvent"]);if(!n)return void this.skip();const i=await this.domModel.pushNodeToFrontend(n);if(!i)throw new Error("Node should not be null.");if("BUTTON"===i.nodeName()&&"submit"===i.getAttribute("type"))return void this.skip();const r=await this.getSelector(i);if(!r)throw new Error("Could not find selector");this.session.appendStepToScript(new y(e,r)),await this.resume()}async handleSubmitEvent(e,t){const n=await this.findTargetId(t,["SubmitEvent"]);if(!n)return void this.skip();const i=await this.domModel.pushNodeToFrontend(n);if(!i)throw new Error("Node should not be null.");const r=await this.getSelector(i);if(!r)throw new Error("Could not find selector");this.session.appendStepToScript(new k(e,r)),await this.resume()}async handleChangeEvent(e,t){const n=await this.findTargetId(t,["Event"]);if(!n)return void this.skip();const i=await this.domModel.pushNodeToFrontend(n);if(!i)throw new Error("Node should not be null.");const r=await this.getSelector(i);if(!r)throw new Error("Could not find selector");const{result:s}=await this.runtimeAgent.invoke_callFunctionOn({functionDeclaration:function(){return this.value}.toString(),objectId:n});this.session.appendStepToScript(new M(e,r,s.value)),await this.resume()}getTarget(){return"main"===this.target.id()?"main":this.target.inspectedURL()}getContextForFrame(e){const t=[];let n=e;for(;n;){const e=n.parentFrame();if(!e)break;const i=e.childFrames.indexOf(n);t.unshift(i),n=e}const i=this.getTarget();return new v(i,t)}async resume(){await this.debuggerAgent.invoke_setSkipAllPauses({skip:!0}),await this.debuggerAgent.invoke_resume({terminateOnResume:!1}),await this.debuggerAgent.invoke_setSkipAllPauses({skip:!1})}async skip(){await this.debuggerAgent.invoke_resume({terminateOnResume:!1})}paused(e){if("EventListener"!==e.reason)return void this.skip();const t=e.data.eventName,n=e.callFrames[0].scopeChain[0],i=e.callFrames[0].location.scriptId,r=this.runtimeModel.executionContextIdForScriptId(i),s=this.runtimeModel.executionContext(r);if(!s)throw new Error("Could not find execution context.");if(!s.frameId)throw new Error("Execution context is not assigned to a frame.");const o=this.resourceTreeModel.frameForId(s.frameId);if(!o)throw new Error("Could not find frame.");const a=this.getContextForFrame(o);n.object.objectId&&this.runtimeAgent.invoke_getProperties({objectId:n.object.objectId}).then((async({result:e})=>{switch(t){case"listener:click":return this.handleClickEvent(a,e);case"listener:submit":return this.handleSubmitEvent(a,e);case"listener:change":return this.handleChangeEvent(a,e);default:this.skip()}}))}targetDestroyed(){this.session.appendStepToScript(new E(this.getTarget()))}breakpointResolved(){}resumed(){}scriptFailedToParse(){}scriptParsed(){}}class v{constructor(e,t=[]){this.path=t,this.target=e}toString(){let e=v.getExpressionForTarget(this.target)+"\n";e+="const frame = targetPage.mainFrame()";for(const t of this.path)e+=`.childFrames()[${t}]`;return e+=";",e}static getExpressionForTarget(e){return"main"===e?"const targetPage = page;":`const target = await browser.waitForTarget(p => p.url() === ${JSON.stringify(e)});\n        const targetPage = await target.page();`}}class b{constructor(e){this.action=e}toString(){throw new Error("Must be implemented in subclass.")}}class y extends b{constructor(e,t){super("click"),this.context=e,this.selector=t}toString(){return`{\n      ${this.context}\n      const element = await frame.waitForSelector(${JSON.stringify(this.selector)});\n      await element.click();\n    }`}}class T extends b{constructor(e){super("navigate"),this.url=e}toString(){return`await page.goto(${JSON.stringify(this.url)});`}}class k extends b{constructor(e,t){super("submit"),this.context=e,this.selector=t}toString(){return`{\n      ${this.context}\n      const element = await frame.waitForSelector(${JSON.stringify(this.selector)});\n      await element.evaluate(form => form.submit());\n    }`}}class M extends b{constructor(e,t,n){super("change"),this.context=e,this.selector=t,this.value=n}toString(){return`{\n      ${this.context}\n      const element = await frame.waitForSelector(${JSON.stringify(this.selector)});\n      await element.type(${JSON.stringify(this.value)});\n    }`}}class E extends b{constructor(e){super("close"),this.target=e}toString(){return`{\n      ${v.getExpressionForTarget(this.target)}\n      await targetPage.close();\n    }`}}class I extends b{constructor(e){super("emulateNetworkConditions"),this.conditions=e}toString(){return`{\n      // Simulated network throttling (${this.conditions.title})\n      const client = await page.target().createCDPSession();\n      await client.send('Network.enable');\n      await client.send('Network.emulateNetworkConditions', {\n        // Network connectivity is absent\n        offline: ${!this.conditions.download&&!this.conditions.upload},\n        // Download speed (bytes/s)\n        downloadThroughput: ${this.conditions.download},\n        // Upload speed (bytes/s)\n        uploadThroughput: ${this.conditions.upload},\n        // Latency (ms)\n        latency: ${this.conditions.latency},\n      });\n    }`}}const C=new Set(["Mouse:click","Control:change","Control:submit"]);class A{constructor(a,c){this._target=a,this._uiSourceCode=c,this._currentIndentation=0,this._debuggerAgent=a.debuggerAgent(),this._domDebuggerAgent=a.domdebuggerAgent(),this._runtimeAgent=a.runtimeAgent(),this._accessibilityAgent=a.accessibilityAgent(),this._pageAgent=a.pageAgent(),this._targetAgent=a.targetAgent(),this._networkManager=r.MultitargetNetworkManager.instance(),this._domModel=a.model(n.DOMModel),this._axModel=a.model(i.AccessibilityModel),this._debuggerModel=a.model(s.DebuggerModel),this._resourceTreeModel=a.model(t.ResourceTreeModel),this._runtimeModel=a.model(e.RuntimeModel),this._childTargetManager=a.model(o.ChildTargetManager),this._target=a,this._eventHandlers=new Map,this._targets=new Set,this._initialDomBreakpointState=new Map,this._interestingBreakpoints=[],this._newDocumentScriptIdentifier=null}async start(){const e=a.DOMDebuggerManager.instance().eventListenerBreakpoints();this._interestingBreakpoints=e.filter((e=>C.has(e.category()+":"+e.title())));for(const e of this._interestingBreakpoints)this._initialDomBreakpointState.set(e,e.enabled()),e.setEnabled(!0);this._networkManager.addEventListener(r.MultitargetNetworkManager.Events.ConditionsChanged,this._handleNetworkConditionsChanged,this),this.attachToTarget(this._target);const n=c.TargetManager.instance().mainTarget();if(!n)throw new Error("Could not find main target");const i=n.model(t.ResourceTreeModel);if(!i)throw new Error("Could not find resource tree model");const s=i.mainFrame;if(!s)throw new Error("Could not find main frame");await this.appendLineToScript("const puppeteer = require('puppeteer');"),await this.appendLineToScript(""),await this.appendLineToScript("(async () => {"),this._currentIndentation+=1,await this.appendLineToScript("const browser = await puppeteer.launch();"),await this.appendLineToScript("const page = await browser.newPage();"),await this.appendLineToScript("");const o=this._networkManager.networkConditions();o!==r.NoThrottlingConditions&&await this.appendStepToScript(new I(o)),await this.appendStepToScript(new T(s.url))}_handleNetworkConditionsChanged(){const e=this._networkManager.networkConditions();this.appendStepToScript(new I(e))}async stop(){for(const e of this._targets)await this.detachFromTarget(e);await this.detachFromTarget(this._target),this._networkManager.removeEventListener(r.MultitargetNetworkManager.Events.ConditionsChanged,this._handleNetworkConditionsChanged,this),await this.appendLineToScript("await browser.close();"),this._currentIndentation-=1,await this.appendLineToScript("})();"),await this.appendLineToScript(""),this._newDocumentScriptIdentifier&&await this._pageAgent.invoke_removeScriptToEvaluateOnNewDocument({identifier:this._newDocumentScriptIdentifier}),await this._debuggerModel.ignoreDebuggerPausedEvents(!1);for(const[e,t]of this._initialDomBreakpointState.entries())e.setEnabled(t)}async appendLineToScript(e){let t=this._uiSourceCode.content();t+=(g.Settings.instance().moduleSetting("textEditorIndent").get().repeat(this._currentIndentation)+e).trimRight()+"\n",await this._uiSourceCode.setContent(t,!1);const n=t.split("\n").length;l.reveal(this._uiSourceCode.uiLocation(n),!0)}async appendStepToScript(e){const t=e.toString().split("\n").map((e=>e.trim()));for(const e of t)"}"===e&&(this._currentIndentation-=1),await this.appendLineToScript(e),"{"===e&&(this._currentIndentation+=1)}async isSubmitButton(e){const{result:t}=await this._runtimeAgent.invoke_callFunctionOn({functionDeclaration:function(){return"BUTTON"===this.tagName&&"submit"===this.type&&null!==this.form}.toString(),objectId:e});return t.value}async attachToTarget(e){this._targets.add(e);const t=new _(this,e);this._eventHandlers.set(e.id(),t),e.registerDebuggerDispatcher(t);const n=e.pageAgent(),i=e.model(s.DebuggerModel),r=e.model(o.ChildTargetManager),a="\n      if (!window.__recorderEventListener) {\n        const recorderEventListener = (event) => { };\n        window.addEventListener('click', recorderEventListener, true);\n        window.addEventListener('submit', recorderEventListener, true);\n        window.addEventListener('change', recorderEventListener, true);\n        window.__recorderEventListener = recorderEventListener;\n      }\n    ";await i.resumeModel(),await i.ignoreDebuggerPausedEvents(!0);const{identifier:c}=await n.invoke_addScriptToEvaluateOnNewDocument({source:a});this._newDocumentScriptIdentifier=c,await this.evaluateInAllFrames(e,a),r?.addEventListener(o.Events.TargetCreated,this.handleWindowOpened,this),r?.addEventListener(o.Events.TargetDestroyed,this.handleWindowClosed,this)}async detachFromTarget(e){const t=this._eventHandlers.get(e.id());if(!t)return;e.unregisterDebuggerDispatcher(t);const n=e.model(s.DebuggerModel);await n.ignoreDebuggerPausedEvents(!1)}async evaluateInAllFrames(n,i){const r=n.model(t.ResourceTreeModel),s=n.model(e.RuntimeModel).executionContexts();for(const e of r.frames()){const t=s.find((t=>t.frameId===e.id));t&&await t.evaluate({expression:i,objectGroup:void 0,includeCommandLineAPI:void 0,silent:void 0,returnByValue:void 0,generatePreview:void 0,allowUnsafeEvalBlockedByCSP:void 0,throwOnSideEffect:void 0,timeout:void 0,disableBreaks:void 0,replMode:void 0},!0,!1)}}async handleWindowOpened(e){if("page"!==e.data.type)return;if(!this._runtimeModel.executionContexts().find((t=>t.frameId===e.data.openerFrameId)))throw new Error("Could not find execution context in opened frame.");await this._targetAgent.invoke_attachToTarget({targetId:e.data.targetId,flatten:!0});const t=c.TargetManager.instance().targets().find((t=>t.id()===e.data.targetId));if(!t)throw new Error("Could not find target.");this.attachToTarget(t)}async handleWindowClosed(e){const t=this._eventHandlers.get(e.data);t&&t.targetDestroyed()}}const F={Recording:Symbol("Recording"),Idle:Symbol("Idle")};class R extends c.SDKModel{constructor(e){super(e),this._debuggerAgent=e.debuggerAgent(),this._domDebuggerAgent=e.domdebuggerAgent(),this._runtimeAgent=e.runtimeAgent(),this._accessibilityAgent=e.accessibilityAgent(),this._toggleRecordAction=d.ActionRegistry.instance().action("recorder.toggle-recording"),this._state=F.Idle,this._currentRecordingSession=null}async updateState(e){this._state=e,this._toggleRecordAction.setToggled(this._state===F.Recording)}isRecording(){return this._state===F.Recording}async toggleRecording(e){this._state===F.Idle?(await this.startRecording(e),await this.updateState(F.Recording)):this._state===F.Recording&&(await this.stopRecording(),await this.updateState(F.Idle))}async startRecording(e){this._currentRecordingSession=new A(this.target(),e),await this._currentRecordingSession.start()}async stopRecording(){this._currentRecordingSession&&(this._currentRecordingSession.stop(),this._currentRecordingSession=null)}}c.SDKModel.register(R,c.Capability.None,!1);var x=Object.freeze({__proto__:null,RecorderModel:R});const N={defaultRecordingName:"Recording #{nextId}",linkedToS:"Linked to {PH1}"},D=p.registerUIStrings("recorder/RecordingFileSystem.js",N),L=p.getLocalizedString.bind(void 0,D);function j(e){return escape(e)}function P(e){return unescape(e)}class O extends m.PlatformFileSystem{constructor(){super("recording://","recordings"),this._lastRecordingIdentifierSetting=g.Settings.instance().createSetting("recorder_lastIdentifier",0),this._recordingsSetting=g.Settings.instance().createSetting("recorder_recordings",[])}initialFilePaths(){return this._recordingsSetting.get().map((e=>j(e.name)))}async createFile(e,t){const n=this._lastRecordingIdentifierSetting.get()+1;this._lastRecordingIdentifierSetting.set(n);const i=L(N.defaultRecordingName,{nextId:n}),r=this._recordingsSetting.get();return r.push({name:i,content:'{"steps": []}'}),this._recordingsSetting.set(r),j(i)}async deleteFile(e){const t=P(e.substring(1)),n=this._recordingsSetting.get(),i=n.filter((e=>e.name!==t));return n.length!==i.length&&(this._recordingsSetting.set(i),!0)}async requestFileContent(e){const t=P(e.substring(1)),n=this._recordingsSetting.get().find((e=>e.name===t));return n?{content:n.content,isEncoded:!1}:{content:null,isEncoded:!1,error:`A recording with name '${t}' was not found`}}async setFileContent(e,t,n){const i=P(e.substring(1)),r=this._recordingsSetting.get(),s=r.find((e=>e.name===i));return!!s&&(s.content=t,this._recordingsSetting.set(r),!0)}renameFile(e,t,n){const i=P(e.substring(1)),r=this._recordingsSetting.get(),s=r.find((e=>e.name===i));t=t.trim(),s&&0!==t.length&&!r.find((e=>e.name===t))?(s.name=t,this._recordingsSetting.set(r),n(!0,t)):n(!1)}async searchInPath(e,t){const n=new RegExp(e.escapeForRegExp(),"i");return this._recordingsSetting.get().filter((e=>e.content.match(n))).map((e=>"recording:///"+j(e.name)))}mimeFromPath(e){return"text/javascript"}contentType(e){return u.resourceTypes.Script}tooltipForURL(e){return L(N.linkedToS,{PH1:P(e.substring(this.path().length))})}supportsAutomapping(){return!0}}var B=Object.freeze({__proto__:null,UIStrings:N,RecordingFileSystem:O,isRecordingUISourceCode:function(e){return e.url().startsWith("recording://")},isRecordingProject:function(e){return e.type()===f.projectTypes.FileSystem&&"recordings"===w.FileSystemWorkspaceBinding.fileSystemType(e)},findRecordingsProject:function(){const e=f.WorkspaceImpl.instance().projectsForType(f.projectTypes.FileSystem).find((e=>"recordings"===w.FileSystemWorkspaceBinding.fileSystemType(e)));if(!e)throw new Error("Unable to find workspace project for the recordings file system.");return e},Recording:undefined});export{x as RecorderModel,B as RecordingFileSystem};
