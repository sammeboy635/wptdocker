import{UIString as e,Throttler as t,Revealer as i,Color as s,Linkifier as n,SimpleHistoryManager as o,Progress as r,Settings as a,ParsedURL as c,Trie as l,EventTarget as d,ResourceType as h,ObjectWrapper as u}from"../common/common.js";import{ls as p,StringUtilities as _,ArrayUtilities as m,Multimap as g,SetUtilities as b,NumberUtilities as S,MapUtilities as C}from"../platform/platform.js";import{Widget as f,UIUtils as v,Dialog as w,GlassPane as E,Toolbar as x,TextEditor as y,Tooltip as I,View as L,ListModel as k,ListControl as T,Context as P,ARIAUtils as M,Icon as F,ContextMenu as D,ViewManager as N,ShortcutRegistry as B,Geometry as U,Utils as A,InspectorView as R,TreeOutline as j,InplaceEditor as V,Panel as O,DropTarget as W,ActionRegistry as H,SplitWidget as z,SettingsUI as q,PopoverHelper as G,TabbedPane as K,SearchableView as $,XLink as J,KeyboardShortcut as Q,Infobar as X,ThrottledWidget as Y,EmptyWidget as Z,Fragment as ee}from"../ui/ui.js";import{JavaScriptAutocomplete as te,JavaScriptREPL as ie,ObjectPopoverHelper as se,RemoteObjectPreviewFormatter as ne,ObjectPropertiesSection as oe}from"../object_ui/object_ui.js";import{Runtime as re}from"../root/root.js";import{LiveLocation as ae,IgnoreListManager as ce,DebuggerWorkspaceBinding as le,CompilerScriptMapping as de,DefaultScriptMapping as he,NetworkProject as ue,BreakpointManager as pe,ResourceScriptMapping as _e}from"../bindings/bindings.js";import{InspectorFrontendHost as me,Platform as ge,userMetrics as be,UserMetrics as Se}from"../host/host.js";import{Persistence as Ce,FileSystemWorkspaceBinding as fe,NetworkPersistenceManager as ve,PersistenceUtils as we,IsolatedFileSystemManager as Ee}from"../persistence/persistence.js";import{DebuggerModel as xe,SDKModel as ye,CSSMetadata as Ie,DOMDebuggerModel as Le,RuntimeModel as ke,OverlayModel as Te,RemoteObject as Pe,ConsoleModel as Me,NetworkRequest as Fe}from"../sdk/sdk.js";import{Workspace as De,UISourceCode as Ne,FileManager as Be}from"../workspace/workspace.js";import{CoverageModel as Ue}from"../coverage/coverage.js";import{SourceFormatter as Ae,FormatterWorkerPool as Re,ScriptFormatter as je}from"../formatter/formatter.js";import{Spectrum as Ve}from"../color_picker/color_picker.js";import{SwatchPopoverHelper as Oe,ColorSwatch as We,Swatches as He,BezierEditor as ze}from"../inline_editor/inline_editor.js";import{SourcesTextEditor as qe,SourceCodeDiff as Ge,SourceFrame as Ke,ImageView as $e,FontView as Je}from"../source_frame/source_frame.js";import{TextRange as Qe,TextUtils as Xe,Text as Ye,TextCursor as Ze}from"../text_utils/text_utils.js";import{CodeMirrorUtils as et}from"../text_editor/text_editor.js";import{QuickOpen as tt,FilteredListWidget as it}from"../quick_open/quick_open.js";import{ExtensionServer as st}from"../extensions/extensions.js";import{ScriptSnippetFileSystem as nt}from"../snippets/snippets.js";import{Icon as ot}from"../ui/components/components.js";import{WorkspaceDiff as rt}from"../workspace_diff/workspace_diff.js";import{RecordingFileSystem as at,RecorderModel as ct}from"../recorder/recorder.js";import{Linkifier as lt}from"../components/components.js";import{SearchView as dt}from"../search/search.js";import{LinearMemoryInspectorController as ht}from"../linear_memory_inspector/linear_memory_inspector.js";class ut extends f.HBox{constructor(t){super(!0),this.registerRequiredCSS("sources/dialog.css",{enableLegacyPatching:!1}),this.contentElement.createChild("label").textContent=e.UIString("Source map URL: "),this._input=v.createInput("add-source-map","text"),this._input.addEventListener("keydown",this._onKeyDown.bind(this),!1),this.contentElement.appendChild(this._input);const i=v.createTextButton(p`Add`,this._apply.bind(this));this.contentElement.appendChild(i),this._dialog=new w.Dialog,this._dialog.setSizeBehavior(E.SizeBehavior.MeasureContent),this._dialog.setDefaultFocusedElement(this._input),this._callback=t}show(){super.show(this._dialog.contentElement),this._dialog.show()}_done(e){this._dialog.hide(),this._callback(e)}_apply(){this._done(this._input.value)}_onKeyDown(e){"Enter"===e.key&&(e.consume(!0),this._apply())}}var pt=Object.freeze({__proto__:null,AddSourceMapURLDialog:ut});class _t extends f.Widget{constructor(e,t,i,s){super(!0),this.registerRequiredCSS("sources/breakpointEditDialog.css",{enableLegacyPatching:!0}),this._onFinish=s,this._finished=!1,this._editor=null,this.element.tabIndex=-1;const n=mt,o=gt;this._isLogpoint=t.startsWith(n)&&t.endsWith(o),this._isLogpoint&&(t=t.substring(n.length,t.length-o.length)),this._isLogpoint=this._isLogpoint||i,this.element.classList.add("sources-edit-breakpoint-dialog");const r=new x.Toolbar("source-frame-breakpoint-toolbar",this.contentElement);r.appendText(`Line ${e+1}:`),this._typeSelector=new x.ToolbarComboBox(this._onTypeChanged.bind(this),p`Breakpoint type`),this._typeSelector.createOption(p`Breakpoint`,bt.Breakpoint);const a=this._typeSelector.createOption(p`Conditional breakpoint`,bt.Conditional),c=this._typeSelector.createOption(p`Logpoint`,bt.Logpoint);this._typeSelector.select(this._isLogpoint?c:a),r.appendToolbarItem(this._typeSelector);const l=re.Runtime.instance().extension(y.TextEditorFactory);l&&l.instance().then((e=>{const i={lineNumbers:!1,lineWrapping:!0,mimeType:"javascript",autoHeight:!0,bracketMatchingSetting:void 0,devtoolsAccessibleName:void 0,padBottom:void 0,maxHighlightLength:void 0,placeholder:void 0,lineWiseCopyCut:void 0,inputStyle:void 0};this._editor=e.createEditor(i),this._updatePlaceholder(),this._editor.widget().element.classList.add("condition-editor"),this._editor.configureAutocomplete(te.JavaScriptAutocompleteConfig.createConfigForEditor(this._editor)),t&&this._editor.setText(t),this._editor.widget().markAsExternallyManaged(),this._editor.widget().show(this.contentElement),this._editor.setSelection(this._editor.fullRange()),this._editor.widget().focus(),this._editor.widget().element.addEventListener("keydown",this._onKeyDown.bind(this),!0),this.element.addEventListener("blur",(e=>{e.relatedTarget&&!e.relatedTarget.isSelfOrDescendant(this.element)&&this._finishEditing(!0)}),!0)}))}static _conditionForLogpoint(e){return`${mt}${e}${gt}`}_onTypeChanged(){const e=this._typeSelector.selectedOption();if(!e||!this._editor)return;const t=e.value;this._isLogpoint=t===bt.Logpoint,this._updatePlaceholder(),t===bt.Breakpoint&&(this._editor.setText(""),this._finishEditing(!0))}_updatePlaceholder(){const e=this._typeSelector.selectedOption();if(!e||!this._editor)return;const t=e.value;t===bt.Conditional?(this._editor.setPlaceholder(p`Expression to check before pausing, e.g. x > 5`),I.Tooltip.install(this._typeSelector.element,p`Pause only when the condition is true`)):t===bt.Logpoint&&(this._editor.setPlaceholder(p`Log message, e.g. 'x is', x`),I.Tooltip.install(this._typeSelector.element,p`Log a message to Console, do not break`))}_finishEditing(e){if(this._finished)return;if(this._finished=!0,!this._editor)return;this._editor.widget().detach();let t=this._editor.text();this._isLogpoint&&(t=_t._conditionForLogpoint(t)),this._onFinish({committed:e,condition:t})}async _onKeyDown(e){if(e instanceof KeyboardEvent&&this._editor){if("Enter"===e.key&&!e.shiftKey){e.consume(!0);const t=this._editor.text();e.ctrlKey||await te.JavaScriptAutocomplete.isExpressionComplete(t)?this._finishEditing(!0):this._editor.newlineAndIndent()}isEscKey(e)&&(this._finishEditing(!1),e.stopImmediatePropagation())}}}const mt="/** DEVTOOLS_LOGPOINT */ console.log(",gt=")",bt={Breakpoint:"Breakpoint",Conditional:"Conditional",Logpoint:"Logpoint"};var St=Object.freeze({__proto__:null,BreakpointEditDialog:_t,LogpointPrefix:mt,LogpointSuffix:gt,BreakpointType:bt});let Ct;class ft extends L.SimpleView{constructor(){super(e.UIString("Call Stack"),!0),this.registerRequiredCSS("sources/callStackSidebarPane.css",{enableLegacyPatching:!0}),this._ignoreListMessageElement=this._createIgnoreListMessageElement(),this.contentElement.appendChild(this._ignoreListMessageElement),this._notPausedMessageElement=this.contentElement.createChild("div","gray-info-message"),this._notPausedMessageElement.textContent=e.UIString("Not paused"),this._notPausedMessageElement.tabIndex=-1,this._items=new k.ListModel,this._list=new T.ListControl(this._items,this,T.ListMode.NonViewport),this.contentElement.appendChild(this._list.element),this._list.element.addEventListener("contextmenu",this._onContextMenu.bind(this),!1),self.onInvokeElement(this._list.element,(e=>{const t=this._list.itemForNode(e.target);t&&(this._activateItem(t),e.consume(!0))})),this._showMoreMessageElement=this._createShowMoreMessageElement(),this._showMoreMessageElement.classList.add("hidden"),this.contentElement.appendChild(this._showMoreMessageElement),this._showIgnoreListed=!1,this._locationPool=new ae.LiveLocationPool,this._updateThrottler=new t.Throttler(100),this._maxAsyncStackChainDepth=Et,this._update(),this._updateItemThrottler=new t.Throttler(100),this._scheduledForUpdateItems=new Set}static instance(e={forceNew:null}){const{forceNew:t}=e;return Ct&&!t||(Ct=new ft),Ct}flavorChanged(e){this._showIgnoreListed=!1,this._maxAsyncStackChainDepth=Et,this._update()}_update(){this._updateThrottler.schedule((()=>this._doUpdate()))}async _doUpdate(){this._locationPool.disposeAll();const e=P.Context.instance().flavor(xe.DebuggerPausedDetails);if(!e)return this.setDefaultFocusedElement(this._notPausedMessageElement),this._notPausedMessageElement.classList.remove("hidden"),this._ignoreListMessageElement.classList.add("hidden"),this._showMoreMessageElement.classList.add("hidden"),this._items.replaceAll([]),void P.Context.instance().setFlavor(xe.CallFrame,null);let t=e.debuggerModel;this._notPausedMessageElement.classList.add("hidden");const i=[];for(const t of e.callFrames){const e=xt.createForDebuggerCallFrame(t,this._locationPool,this._refreshItem.bind(this)).then((e=>(vt.set(e,t),e)));i.push(e)}const s=await Promise.all(i);let n=e.asyncStackTrace;!n&&e.asyncStackTraceId&&(e.asyncStackTraceId.debuggerId&&(t=await xe.DebuggerModel.modelForDebuggerId(e.asyncStackTraceId.debuggerId)),n=t?await t.fetchAsyncStackTrace(e.asyncStackTraceId):null);let o=e.callFrames,r=this._maxAsyncStackChainDepth;for(;n&&r>0;){let e="";if("async function"===n.description&&o.length&&n.callFrames.length){const t=o[o.length-1],i=v.beautifyFunctionName(t.functionName);e=v.asyncStackTraceLabel("await in "+i)}else e=v.asyncStackTraceLabel(n.description);s.push(...await xt.createItemsForAsyncStack(e,t,n.callFrames,this._locationPool,this._refreshItem.bind(this))),--r,o=n.callFrames,n.parent?n=n.parent:n.parentId?(n.parentId.debuggerId&&(t=await xe.DebuggerModel.modelForDebuggerId(n.parentId.debuggerId)),n=t?await t.fetchAsyncStackTrace(n.parentId):null):n=null}if(this._showMoreMessageElement.classList.toggle("hidden",!n),this._items.replaceAll(s),this._maxAsyncStackChainDepth===Et){this._list.selectNextItem(!0,!1);const e=this._list.selectedItem();e&&this._activateItem(e)}this._updatedForTest()}_updatedForTest(){}_refreshItem(e){this._scheduledForUpdateItems.add(e),this._updateItemThrottler.schedule((async()=>{const e=Array.from(this._scheduledForUpdateItems);if(this._scheduledForUpdateItems.clear(),this._muteActivateItem=!0,!this._showIgnoreListed&&this._items.every((e=>e.isIgnoreListed))){this._showIgnoreListed=!0;for(let e=0;e<this._items.length;++e)this._list.refreshItemByIndex(e);this._ignoreListMessageElement.classList.toggle("hidden",!0)}else{const t=new Set(e);let i=!1;for(let e=0;e<this._items.length;++e){const s=this._items.at(e);t.has(s)&&this._list.refreshItemByIndex(e),i=i||s.isIgnoreListed}this._ignoreListMessageElement.classList.toggle("hidden",this._showIgnoreListed||!i)}delete this._muteActivateItem}))}createElementForItem(e){const t=document.createElement("div");t.classList.add("call-frame-item");const i=t.createChild("div","call-frame-item-title").createChild("div","call-frame-title-text");if(i.textContent=e.title,e.isAsyncHeader)t.classList.add("async-header");else{I.Tooltip.install(i,e.title);const s=t.createChild("div","call-frame-location");s.textContent=e.linkText.trimMiddle(30),I.Tooltip.install(s,e.linkText),t.classList.toggle("ignore-listed-call-frame",e.isIgnoreListed),e.isIgnoreListed&&M.setDescription(t,p`on ignore list`),vt.has(e)||M.setDisabled(t,!0)}const s=vt.get(e)===P.Context.instance().flavor(xe.CallFrame);return t.classList.toggle("selected",s),M.setSelected(t,s),t.classList.toggle("hidden",!this._showIgnoreListed&&e.isIgnoreListed),t.appendChild(F.Icon.create("smallicon-thick-right-arrow","selected-call-frame-icon")),t.tabIndex=e===this._list.selectedItem()?0:-1,t}heightForItem(e){return console.assert(!1),0}isItemSelectable(e){return!0}selectedItemChanged(e,t,i,s){i&&(i.tabIndex=-1),s&&(this.setDefaultFocusedElement(s),s.tabIndex=0,this.hasFocus()&&s.focus())}updateSelectedItemARIA(e,t){return!0}_createIgnoreListMessageElement(){const t=document.createElement("div");t.classList.add("ignore-listed-message"),t.createChild("span");const i=t.createChild("span","link");i.textContent=e.UIString("Show ignore-listed frames"),M.markAsLink(i),i.tabIndex=0;const s=()=>{this._showIgnoreListed=!0;for(const e of this._items)this._refreshItem(e);this._ignoreListMessageElement.classList.toggle("hidden",!0)};return i.addEventListener("click",s),i.addEventListener("keydown",(e=>"Enter"===e.key&&s())),t}_createShowMoreMessageElement(){const t=document.createElement("div");t.classList.add("show-more-message"),t.createChild("span");const i=t.createChild("span","link");return i.textContent=e.UIString("Show more"),i.addEventListener("click",(()=>{this._maxAsyncStackChainDepth+=Et,this._update()}),!1),t}_onContextMenu(t){const i=this._list.itemForNode(t.target);if(!i)return;const s=new D.ContextMenu(t),n=vt.get(i);n&&s.defaultSection().appendItem(e.UIString("Restart frame"),(()=>n.restart())),s.defaultSection().appendItem(e.UIString("Copy stack trace"),this._copyStackTrace.bind(this)),i.uiLocation&&this.appendIgnoreListURLContextMenuItems(s,i.uiLocation.uiSourceCode),s.show()}_onClick(e){const t=this._list.itemForNode(e.target);t&&this._activateItem(t)}_activateItem(e){const t=e.uiLocation;if(this._muteActivateItem||!t)return;this._list.selectItem(e);const s=vt.get(e),n=this.activeCallFrameItem();s&&n!==e?(s.debuggerModel.setSelectedCallFrame(s),P.Context.instance().setFlavor(xe.CallFrame,s),n&&this._refreshItem(n),this._refreshItem(e)):i.reveal(t)}activeCallFrameItem(){const e=P.Context.instance().flavor(xe.CallFrame);return e&&this._items.find((t=>vt.get(t)===e))||null}appendIgnoreListURLContextMenuItems(t,i){const s=Ce.PersistenceImpl.instance().binding(i);if(s&&(i=s.network),i.project().type()===De.projectTypes.FileSystem)return;const n=ce.IgnoreListManager.instance().canIgnoreListUISourceCode(i),o=ce.IgnoreListManager.instance().isIgnoreListedUISourceCode(i),r=i.project().type()===De.projectTypes.ContentScripts,a=ce.IgnoreListManager.instance();n&&(o?t.defaultSection().appendItem(e.UIString("Remove from ignore list"),a.unIgnoreListUISourceCode.bind(a,i)):t.defaultSection().appendItem(e.UIString("Add script to ignore list"),a.ignoreListUISourceCode.bind(a,i))),r&&(o?t.defaultSection().appendItem(e.UIString("Remove all content scripts from ignore list"),a.ignoreListContentScripts.bind(a)):t.defaultSection().appendItem(e.UIString("Add all content scripts to ignore list"),a.unIgnoreListContentScripts.bind(a)))}_selectNextCallFrameOnStack(){const e=this.activeCallFrameItem();for(let t=e?this._items.indexOf(e)+1:0;t<this._items.length;t++){const e=this._items.at(t);if(vt.has(e)){this._activateItem(e);break}}}_selectPreviousCallFrameOnStack(){const e=this.activeCallFrameItem();for(let t=e?this._items.indexOf(e)-1:this._items.length-1;t>=0;t--){const e=this._items.at(t);if(vt.has(e)){this._activateItem(e);break}}}_copyStackTrace(){const e=[];for(const t of this._items){let i=t.title;t.uiLocation&&(i+=" ("+t.uiLocation.linkText(!0)+")"),e.push(i)}me.InspectorFrontendHostInstance.copyText(e.join("\n"))}}const vt=new WeakMap,wt=Symbol("element"),Et=32;class xt{static async createForDebuggerCallFrame(e,t,i){const s=new xt(v.beautifyFunctionName(e.functionName),i);return await le.DebuggerWorkspaceBinding.instance().createCallFrameLiveLocation(e.location(),s._update.bind(s),t),s}static async createItemsForAsyncStack(e,t,i,s,n){const o=new WeakMap,r=new xt(e,n);o.set(r,new Set),r.isAsyncHeader=!0;const a=[],c=[];for(const e of i){const i=new xt(v.beautifyFunctionName(e.functionName),l),n=t?t.createRawLocationByScriptId(e.scriptId,e.lineNumber,e.columnNumber):null;n?c.push(le.DebuggerWorkspaceBinding.instance().createCallFrameLiveLocation(n,i._update.bind(i),s)):(i.linkText=(e.url||"<unknown>")+":"+(e.lineNumber+1),i.updateDelegate(i)),a.push(i)}return await Promise.all(c),n(r),[r,...a];function l(e){n(e);let t=!1;const i=o.get(r);i&&(e.isIgnoreListed?(i.delete(e),t=0===i.size):(t=0===i.size,i.add(e)),r.isIgnoreListed=0===i.size),t&&n(r)}}constructor(e,t){this.isIgnoreListed=!1,this.title=e,this.linkText="",this.uiLocation=null,this.isAsyncHeader=!1,this.updateDelegate=t}async _update(e){const t=await e.uiLocation();this.isIgnoreListed=await e.isIgnoreListed(),this.linkText=t?t.linkText():"",this.uiLocation=t,this.updateDelegate(this)}}var yt=Object.freeze({__proto__:null,CallStackSidebarPane:ft,elementSymbol:wt,defaultMaxAsyncStackChainDepth:Et,ActionDelegate:class{handleAction(e,t){switch(t){case"debugger.next-call-frame":return ft.instance()._selectNextCallFrameOnStack(),!0;case"debugger.previous-call-frame":return ft.instance()._selectPreviousCallFrameOnStack(),!0}return!1}},Item:xt});class It{static accepts(e){return!1}wasShown(){}willHide(){}async rightToolbarItems(){return[]}leftToolbarItems(){return[]}populateLineGutterContextMenu(e,t){return Promise.resolve()}populateTextAreaContextMenu(e,t,i){return Promise.resolve()}dispose(){}}var Lt=Object.freeze({__proto__:null,Plugin:It});class kt extends It{constructor(e,t){super(),this._textEditor=e,this._uiSourceCode=t,this._originalSourceCode=Ae.SourceFormatter.instance().getOriginalUISourceCode(this._uiSourceCode),this._text=new x.ToolbarButton(p`Click to show Coverage Panel`),this._text.setSecondary(),this._text.addEventListener(x.ToolbarButton.Events.Click,(()=>{N.ViewManager.instance().showView("coverage")}));const i=ye.TargetManager.instance().mainTarget();i&&(this._model=i.model(Ue.CoverageModel),this._model&&(this._model.addEventListener(Ue.Events.CoverageReset,this._handleReset,this),this._coverage=this._model.getCoverageForUrl(this._originalSourceCode.url()),this._coverage&&this._coverage.addEventListener(Ue.URLCoverageInfo.Events.SizesChanged,this._handleCoverageSizesChanged,this))),this._updateStats()}dispose(){this._coverage&&this._coverage.removeEventListener(Ue.URLCoverageInfo.Events.SizesChanged,this._handleCoverageSizesChanged,this),this._model&&this._model.removeEventListener(Ue.Events.CoverageReset,this._handleReset,this)}static accepts(e){return e.contentType().isDocumentOrScriptOrStyleSheet()}_handleReset(){this._coverage=null,this._updateStats()}_handleCoverageSizesChanged(){this._updateStats()}_updateStats(){this._coverage?(this._text.setTitle(p`Show Details`),this._text.setText(p`Coverage: ${this._coverage.usedPercentage().toFixed(1)} %`)):(this._text.setTitle(p`Click to show Coverage Panel`),this._text.setText(p`Coverage: n/a`))}async rightToolbarItems(){return[this._text]}}var Tt=Object.freeze({__proto__:null,CoveragePlugin:kt});class Pt extends It{constructor(e){super(),this._textEditor=e,this._swatchPopoverHelper=new Oe.SwatchPopoverHelper,this._muteSwatchProcessing=!1,this._hadSwatchChange=!1,this._bezierEditor=null,this._editedSwatchTextRange=null,this._spectrum=null,this._currentSwatch=null,this._textEditor.configureAutocomplete({suggestionsCallback:this._cssSuggestions.bind(this),isWordChar:this._isWordChar.bind(this),anchorBehavior:void 0,substituteRangeCallback:void 0,tooltipCallback:void 0}),this._textEditor.addEventListener(qe.Events.ScrollChanged,this._textEditorScrolled,this),this._textEditor.addEventListener(y.Events.TextChanged,this._onTextChanged,this),this._updateSwatches(0,this._textEditor.linesCount-1),this._boundHandleKeyDown=null,this._registerShortcuts()}static accepts(e){return e.contentType().isStyleSheet()}_registerShortcuts(){this._boundHandleKeyDown=B.ShortcutRegistry.instance().addShortcutListener(this._textEditor.element,{"sources.increment-css":this._handleUnitModification.bind(this,1),"sources.increment-css-by-ten":this._handleUnitModification.bind(this,10),"sources.decrement-css":this._handleUnitModification.bind(this,-1),"sources.decrement-css-by-ten":this._handleUnitModification.bind(this,-10)})}_textEditorScrolled(){this._swatchPopoverHelper.isShowing()&&this._swatchPopoverHelper.hide(!0)}_modifyUnit(e,t){const i=parseInt(e,10);if(isNaN(i))return null;const s=e.substring(i.toString().length);return _.sprintf("%d%s",i+t,s)}async _handleUnitModification(e){const t=this._textEditor.selection().normalize();let i=this._textEditor.tokenAtTextPosition(t.startLine,t.startColumn);if(!i&&(t.startColumn>0&&(i=this._textEditor.tokenAtTextPosition(t.startLine,t.startColumn-1)),!i))return!1;if("css-number"!==i.type)return!1;const s=new Qe.TextRange(t.startLine,i.startColumn,t.startLine,i.endColumn),n=this._textEditor.text(s),o=this._modifyUnit(n,e);return!!o&&(this._textEditor.editRange(s,o),t.startColumn=i.startColumn,t.endColumn=t.startColumn+o.length,this._textEditor.setSelection(t),!0)}_updateSwatches(e,t){const i=[],n=[],o=[Ie.VariableRegex,Ie.URLRegex,U.CubicBezier.Regex,s.Regex],r=new Map;r.set(s.Regex,this._createColorSwatch.bind(this)),r.set(U.CubicBezier.Regex,this._createBezierSwatch.bind(this));for(let s=e;s<=t;s++){const e=this._textEditor.line(s).substring(0,Mt),t=Xe.Utils.splitStringByRegexes(e,o);for(let a=0;a<t.length;a++){const c=t[a],l=r.get(o[c.regexIndex]);if(-1===c.regexIndex||!l)continue;const d=/[\s:;,(){}]/,h=c.position-1,u=c.position+c.value.length;if(h>=0&&!d.test(e.charAt(h))||u<e.length&&!d.test(e.charAt(u)))continue;const p=l(c.value);p&&(i.push(p),n.push(Qe.TextRange.createFromLocation(s,c.position)))}}this._textEditor.operation(function(){const s=new Qe.TextRange(e,0,t,this._textEditor.line(t).length);this._textEditor.bookmarks(s,Ft).forEach((e=>e.clear()));for(let e=0;e<i.length;e++){const t=i[e],s=n[e],o=this._textEditor.addBookmark(s.startLine,s.startColumn,t,Ft);Dt.set(t,o)}}.bind(this))}_createColorSwatch(t){const i=s.Color.parse(t);if(!i)return null;const n=new We.ColorSwatch;n.renderColor(i,!1,e.UIString("Open color picker."));const o=n.createChild("span");return o.textContent=t,o.setAttribute("hidden","true"),n.addEventListener("swatch-click",this._swatchIconClicked.bind(this,n),!1),n}_createBezierSwatch(t){if(!U.CubicBezier.parse(t))return null;const i=He.BezierSwatch.create();return i.setBezierText(t),I.Tooltip.install(i.iconElement(),e.UIString("Open cubic bezier editor.")),i.iconElement().addEventListener("click",this._swatchIconClicked.bind(this,i),!1),i.hideText(!0),i}_swatchIconClicked(e,t){t.consume(!0),this._hadSwatchChange=!1,this._muteSwatchProcessing=!0;const i=Dt.get(e);if(!i)return;const s=i.position();s&&(this._textEditor.setSelection(s),this._editedSwatchTextRange=s.clone(),this._editedSwatchTextRange&&(this._editedSwatchTextRange.endColumn+=(e.textContent||"").length),this._currentSwatch=e,We.ColorSwatch.isColorSwatch(e)?this._showSpectrum(e):e instanceof He.BezierSwatch&&this._showBezierEditor(e))}_showSpectrum(e){this._spectrum||(this._spectrum=new Ve.Spectrum,this._spectrum.addEventListener(Ve.Events.SizeChanged,this._spectrumResized,this),this._spectrum.addEventListener(Ve.Events.ColorChanged,this._spectrumChanged,this)),this._spectrum.setColor(e.color,e.format||""),this._swatchPopoverHelper.show(this._spectrum,e,this._swatchPopoverHidden.bind(this))}_spectrumResized(e){this._swatchPopoverHelper.reposition()}_spectrumChanged(e){const t=e.data,i=s.Color.parse(t);if(i&&this._currentSwatch){if(We.ColorSwatch.isColorSwatch(this._currentSwatch)){this._currentSwatch.renderColor(i)}this._changeSwatchText(t)}}_showBezierEditor(e){const t=U.CubicBezier.parse(e.bezierText())||U.CubicBezier.parse("linear");this._bezierEditor?this._bezierEditor.setBezier(t):(this._bezierEditor=new ze.BezierEditor(t),this._bezierEditor.addEventListener(ze.Events.BezierChanged,this._bezierChanged,this)),this._swatchPopoverHelper.show(this._bezierEditor,e.iconElement(),this._swatchPopoverHidden.bind(this))}_bezierChanged(e){const t=e.data;this._currentSwatch instanceof He.BezierSwatch&&this._currentSwatch.setBezierText(t),this._changeSwatchText(t)}_changeSwatchText(e){this._hadSwatchChange=!0;const t=this._editedSwatchTextRange;this._textEditor.editRange(t,e,"*swatch-text-changed"),t.endColumn=t.startColumn+e.length}_swatchPopoverHidden(e){this._muteSwatchProcessing=!1,!e&&this._hadSwatchChange&&this._textEditor.undo()}_onTextChanged(e){this._muteSwatchProcessing||this._updateSwatches(e.data.newRange.startLine,e.data.newRange.endLine)}_isWordChar(e){return Xe.Utils.isWordChar(e)||"."===e||"-"===e||"$"===e}_cssSuggestions(e,t){const i=this._textEditor.text(e);if(i.startsWith("$"))return null;const s=this._backtrackPropertyToken(e.startLine,e.startColumn-1);if(!s)return null;const n=this._textEditor.line(e.startLine).substring(s.startColumn,s.endColumn),o=Ie.cssMetadata().propertyValues(n);return Promise.resolve(o.filter((e=>e.startsWith(i))).map((e=>({text:e,title:void 0,subtitle:void 0,iconType:void 0,priority:void 0,isSecondary:void 0,subtitleRenderer:void 0,selectionRange:void 0,hideGhostText:void 0,iconElement:void 0}))))}_backtrackPropertyToken(e,t){let i=t;const s=this._textEditor.line(e);let n=!1;for(let t=0;t<10&&i>=0;++t){const t=this._textEditor.tokenAtTextPosition(e,i);if(!t)return null;if("css-property"===t.type)return n?t:null;if(t.type&&-1===t.type.indexOf("whitespace")&&!t.type.startsWith("css-comment"))return null;if(!t.type&&":"===s.substring(t.startColumn,t.endColumn)){if(n)return null;n=!0}i=t.startColumn-1}return null}dispose(){this._swatchPopoverHelper.isShowing()&&this._swatchPopoverHelper.hide(!0),this._textEditor.removeEventListener(qe.Events.ScrollChanged,this._textEditorScrolled,this),this._textEditor.removeEventListener(y.Events.TextChanged,this._onTextChanged,this),this._textEditor.bookmarks(this._textEditor.fullRange(),Ft).forEach((e=>e.clear())),this._textEditor.element.removeEventListener("keydown",this._boundHandleKeyDown)}}const Mt=300,Ft=Symbol("swatch"),Dt=new WeakMap;var Nt=Object.freeze({__proto__:null,CSSPlugin:Pt,maxSwatchProcessingLength:Mt,SwatchBookmark:Ft});class Bt{constructor(){this._element=document.createElement("div"),this._element.classList.add("paused-message"),this._element.classList.add("flex-none");const e=A.createShadowRootWithCoreStyles(this._element,{cssFile:"sources/debuggerPausedMessage.css",enableLegacyPatching:!0,delegatesFocus:void 0});this._contentElement=e.createChild("div"),M.markAsPoliteLiveRegion(this._element,!1)}element(){return this._element}static _descriptionWithoutStack(e){const t=/^\s+at\s/m.exec(e);return t?e.substring(0,t.index-1):e.substring(0,e.lastIndexOf("\n"))}static async _createDOMBreakpointHitMessage(e){const t=document.createElement("span"),i=e.debuggerModel.target().model(Le.DOMDebuggerModel);if(!e.auxData||!i)return t;const s=i.resolveDOMBreakpointData(e.auxData);if(!s)return t;const o=t.createChild("div","status-main");o.appendChild(F.Icon.create("smallicon-info","status-icon"));const r=Ut.get(s.type);o.appendChild(document.createTextNode(p`Paused on ${r}`));const a=t.createChild("div","status-sub monospace"),c=await n.Linkifier.linkify(s.node);if(a.appendChild(c),s.targetNode){const e=await n.Linkifier.linkify(s.targetNode);let t;t=s.insertion?s.targetNode===s.node?v.formatLocalized("Child %s added",[e]):v.formatLocalized("Descendant %s added",[e]):v.formatLocalized("Descendant %s removed",[e]),a.appendChild(document.createElement("br")),a.appendChild(t)}return t}async render(t,i,s){if(this._contentElement.removeChildren(),this._contentElement.hidden=!t,!t)return;const n=this._contentElement.createChild("div","paused-status"),o=t.reason===Protocol.Debugger.PausedEventReason.Exception||t.reason===Protocol.Debugger.PausedEventReason.PromiseRejection||t.reason===Protocol.Debugger.PausedEventReason.Assert||t.reason===Protocol.Debugger.PausedEventReason.OOM;let r;if(t.reason===Protocol.Debugger.PausedEventReason.DOM)r=await Bt._createDOMBreakpointHitMessage(t);else if(t.reason===Protocol.Debugger.PausedEventReason.EventListener){let i="";t.auxData&&(i=Le.DOMDebuggerManager.instance().resolveEventListenerBreakpointTitle(t.auxData)),r=a(e.UIString("Paused on event listener"),i)}else if(t.reason===Protocol.Debugger.PausedEventReason.XHR){const i=t.auxData;r=a(e.UIString("Paused on XHR or fetch"),i.url||"")}else if(t.reason===Protocol.Debugger.PausedEventReason.Exception){const i=t.auxData,s=i.description||i.value||"",n=Bt._descriptionWithoutStack(s);r=a(e.UIString("Paused on exception"),n,s)}else if(t.reason===Protocol.Debugger.PausedEventReason.PromiseRejection){const i=t.auxData,s=i.description||i.value||"",n=Bt._descriptionWithoutStack(s);r=a(e.UIString("Paused on promise rejection"),n,s)}else if(t.reason===Protocol.Debugger.PausedEventReason.Assert)r=a(e.UIString("Paused on assertion"));else if(t.reason===Protocol.Debugger.PausedEventReason.DebugCommand)r=a(e.UIString("Paused on debugged function"));else if(t.reason===Protocol.Debugger.PausedEventReason.OOM)r=a(e.UIString("Paused before potential out-of-memory crash"));else if(t.reason===Protocol.Debugger.PausedEventReason.CSPViolation&&t.auxData&&t.auxData.violationType){const e=t.auxData.violationType;e===Protocol.DOMDebugger.CSPViolationType.TrustedtypeSinkViolation?r=a(p`Paused on CSP violation`,p`Trusted Type Sink Violation`):e===Protocol.DOMDebugger.CSPViolationType.TrustedtypePolicyViolation&&(r=a(p`Paused on CSP violation`,p`Trusted Type Policy Violation`))}else if(t.callFrames.length){const n=await i.rawLocationToUILocation(t.callFrames[0].location());r=a((n?s.findBreakpoint(n):null)?e.UIString("Paused on breakpoint"):e.UIString("Debugger paused"))}else console.warn("ScriptsPanel paused, but callFrames.length is zero.");function a(e,t,i){const s=document.createElement("span"),n=s.createChild("div","status-main"),r=F.Icon.create(o?"smallicon-error":"smallicon-info","status-icon");if(n.appendChild(r),n.appendChild(document.createTextNode(e)),t){const e=s.createChild("div","status-sub monospace");e.textContent=t,I.Tooltip.install(e,i||t)}return s}n.classList.toggle("error-reason",o),r&&n.appendChild(r)}}const Ut=new Map([[Protocol.DOMDebugger.DOMBreakpointType.SubtreeModified,e.UIString("subtree modifications")],[Protocol.DOMDebugger.DOMBreakpointType.AttributeModified,e.UIString("attribute modifications")],[Protocol.DOMDebugger.DOMBreakpointType.NodeRemoved,e.UIString("node removal")]]);var At=Object.freeze({__proto__:null,DebuggerPausedMessage:Bt,BreakpointTypeNouns:Ut});class Rt{constructor(e,t){this._sourcesView=e,this._historyManager=new o.SimpleHistoryManager(jt),this._currentSourceFrameCallback=t}trackSourceFrameCursorJumps(e){e.textEditor.addEventListener(qe.Events.JumpHappened,this._onJumpHappened.bind(this))}_onJumpHappened(e){e.data.from&&this._updateActiveState(e.data.from),e.data.to&&this._pushActiveState(e.data.to)}rollback(){this._historyManager.rollback()}rollover(){this._historyManager.rollover()}updateCurrentState(){const e=this._currentSourceFrameCallback();e&&this._updateActiveState(e.textEditor.selection())}pushNewState(){const e=this._currentSourceFrameCallback();e&&this._pushActiveState(e.textEditor.selection())}_updateActiveState(e){const t=this._historyManager.active();if(!t)return;const i=this._currentSourceFrameCallback();if(!i)return;const s=new Vt(this._sourcesView,this,i,e);t.merge(s)}_pushActiveState(e){const t=this._currentSourceFrameCallback();if(!t)return;const i=new Vt(this._sourcesView,this,t,e);this._historyManager.push(i)}removeHistoryForSourceCode(e){this._historyManager.filterOut((t=>{const i=t;return i._projectId===e.project().id()&&i._url===e.url()}))}}const jt=20;class Vt{constructor(e,t,i,s){this._sourcesView=e,this._editingLocationManager=t;const n=i.uiSourceCode();this._projectId=n.project().id(),this._url=n.url();const o=this._positionFromSelection(s);this._positionHandle=i.textEditor.textEditorPositionHandle(o.lineNumber,o.columnNumber)}merge(e){this._projectId===e._projectId&&this._url===e._url&&(this._positionHandle=e._positionHandle)}_positionFromSelection(e){return{lineNumber:e.endLine,columnNumber:e.endColumn}}valid(){const e=this._positionHandle.resolve(),t=De.WorkspaceImpl.instance().uiSourceCode(this._projectId,this._url);return Boolean(e&&t)}reveal(){const e=this._positionHandle.resolve(),t=De.WorkspaceImpl.instance().uiSourceCode(this._projectId,this._url);e&&t&&(this._editingLocationManager.updateCurrentState(),this._sourcesView.showSourceLocation(t,e.lineNumber,e.columnNumber))}}var Ot=Object.freeze({__proto__:null,EditingLocationHistoryManager:Rt,HistoryDepth:jt,EditingLocationHistoryEntry:Vt});class Wt extends It{constructor(e,t){super(),this._textEditor=e,this._uiSourceCode=t,this._decorations=[],this._textEditor.installGutter(zt,!0),this._workspaceDiff=rt.workspaceDiff(),this._workspaceDiff.subscribeToDiffChange(this._uiSourceCode,this._update,this),this._update()}static accepts(e){return e.project().type()===De.projectTypes.Network}_updateDecorations(e,t){this._textEditor.operation((function(){for(const t of e)t.remove();for(const e of t)e.install()}))}_update(){this._uiSourceCode?this._workspaceDiff.requestDiff(this._uiSourceCode).then(this._innerUpdate.bind(this)):this._innerUpdate(null)}_innerUpdate(e){if(!e)return this._updateDecorations(this._decorations,[]),void(this._decorations=[]);const t=Ge.SourceCodeDiff.computeDiff(e),i=new Map;for(let e=0;e<t.length;++e){const s=t[e];for(let e=s.from;e<s.to;++e)i.set(e,{lineNumber:e,type:s.type})}const s=this._calculateDecorationsDiff(i),n=s.added.map((e=>new Ht(this._textEditor,e.lineNumber,e.type)));this._decorations=s.equal.concat(n),this._updateDecorations(s.removed,n),this._decorationsSetForTest(i)}_decorationsByLine(){const e=new Map;for(const t of this._decorations){const i=t.lineNumber();-1!==i&&e.set(i,t)}return e}_calculateDecorationsDiff(e){const t=this._decorationsByLine(),i=[...t.keys()],s=[...e.keys()];i.sort(((e,t)=>e-t)),s.sort(((e,t)=>e-t));const n=[],o=[],r=[];let a=0,c=0;for(;a<i.length&&c<s.length;){const l=i[a],d=s[c],h=t.get(l),u=e.get(d);if(!h)throw new Error("No decoration with key "+l);if(!u)throw new Error("No decoration with key "+d);l===d&&h.type===u.type?(r.push(h),++a,++c):l<=d?(n.push(h),++a):(o.push(u),++c)}for(;a<i.length;){const e=i[a++],s=t.get(e);if(!s)throw new Error("No decoration with key "+e);n.push(s)}for(;c<s.length;){const t=s[c++],i=e.get(t);if(!i)throw new Error("No decoration with key "+t);o.push(i)}return{added:o,removed:n,equal:r}}_decorationsSetForTest(e){}async populateLineGutterContextMenu(e,t){Wt._appendRevealDiffContextMenu(e,this._uiSourceCode)}async populateTextAreaContextMenu(e,t,i){Wt._appendRevealDiffContextMenu(e,this._uiSourceCode)}static _appendRevealDiffContextMenu(e,t){rt.workspaceDiff().isUISourceCodeModified(t)&&e.revealSection().appendItem(p`Local Modifications...`,(()=>{i.reveal(new rt.DiffUILocation(t))}))}dispose(){for(const e of this._decorations)e.remove();rt.workspaceDiff().unsubscribeFromDiffChange(this._uiSourceCode,this._update,this)}}class Ht{constructor(e,t,i){this._textEditor=e,this._position=this._textEditor.textEditorPositionHandle(t,0),this._className="",i===Ge.EditType.Insert?this._className="diff-entry-insert":i===Ge.EditType.Delete?this._className="diff-entry-delete":i===Ge.EditType.Modify&&(this._className="diff-entry-modify"),this.type=i}lineNumber(){const e=this._position.resolve();return e?e.lineNumber:-1}install(){const e=this._position.resolve();if(!e)return;const t=document.createElement("div");t.classList.add("diff-marker"),t.textContent=" ",this._textEditor.setGutterDecoration(e.lineNumber,zt,t),this._textEditor.toggleLineClass(e.lineNumber,this._className,!0)}remove(){const e=this._position.resolve();e&&(this._textEditor.setGutterDecoration(e.lineNumber,zt,null),this._textEditor.toggleLineClass(e.lineNumber,this._className,!1))}}const zt="CodeMirror-gutter-diff";var qt=Object.freeze({__proto__:null,GutterDiffPlugin:Wt,GutterDecoration:Ht,DiffGutterType:zt,ContextMenuProvider:class{appendApplicableItems(e,t,i){let s=i;const n=Ce.PersistenceImpl.instance().binding(s);n&&(s=n.network),Wt._appendRevealDiffContextMenu(t,s)}}});class Gt extends It{constructor(e,t){super(),this._textEditor=e,this._uiSourceCode=t,this._compiling=!1,this._recompileScheduled=!1,this._timeout=null,this._message=null,this._disposed=!1,this._textEditor.addEventListener(y.Events.TextChanged,this._scheduleCompile,this),(this._uiSourceCode.hasCommits()||this._uiSourceCode.isDirty())&&this._scheduleCompile()}static accepts(e){if("js"===e.extension())return!0;if(nt.isSnippetsUISourceCode(e))return!0;for(const t of ye.TargetManager.instance().models(xe.DebuggerModel))if(le.DebuggerWorkspaceBinding.instance().scriptFile(e,t))return!0;return!1}_scheduleCompile(){this._compiling?this._recompileScheduled=!0:(this._timeout&&clearTimeout(this._timeout),this._timeout=window.setTimeout(this._compile.bind(this),Kt))}_findRuntimeModel(){const e=ye.TargetManager.instance().models(xe.DebuggerModel);for(let t=0;t<e.length;++t){if(le.DebuggerWorkspaceBinding.instance().scriptFile(this._uiSourceCode,e[t]))return e[t].runtimeModel()}const t=ye.TargetManager.instance().mainTarget();return t?t.model(ke.RuntimeModel):null}async _compile(){const e=this._findRuntimeModel();if(!e)return;const t=P.Context.instance().flavor(ke.ExecutionContext);if(!t)return;const i=this._textEditor.text();if(i.length>102400)return;this._compiling=!0;const s=await e.compileScript(i,"",!1,t.id);if(this._compiling=!1,this._recompileScheduled)return this._recompileScheduled=!1,void this._scheduleCompile();if(this._message&&this._uiSourceCode.removeMessage(this._message),this._disposed||!s||!s.exceptionDetails)return;const n=s.exceptionDetails,o=ke.RuntimeModel.simpleTextFromException(n);this._message=this._uiSourceCode.addLineMessage(Ne.Message.Level.Error,o,n.lineNumber,n.columnNumber),this._compilationFinishedForTest()}_compilationFinishedForTest(){}dispose(){this._textEditor.removeEventListener(y.Events.TextChanged,this._scheduleCompile,this),this._message&&this._uiSourceCode.removeMessage(this._message),this._disposed=!0,this._timeout&&clearTimeout(this._timeout)}}const Kt=1e3;var $t=Object.freeze({__proto__:null,JavaScriptCompilerPlugin:Gt,CompileDelay:Kt});class Jt extends It{constructor(e,t){super(),this._textEditor=e,this._uiSourceCode=t}static accepts(e){return at.isRecordingUISourceCode(e)}leftToolbarItems(){const t=x.Toolbar.createActionButtonForId("recorder.toggle-recording");return t.setText(e.UIString("Record")),[t]}}var Qt=Object.freeze({__proto__:null,RecorderPlugin:Jt});class Xt extends It{constructor(e,t){super(),this._textEditor=e,this._uiSourceCode=t}static accepts(e){return e.contentType().hasScripts()||Boolean(Xt._script(e))}async rightToolbarItems(){const e=de.CompilerScriptMapping.uiSourceCodeOrigin(this._uiSourceCode);if(e){const t=v.formatLocalized("(source mapped from %s)",[lt.Linkifier.linkifyURL(e)]);return[new x.ToolbarItem(t)]}const t=le.DebuggerWorkspaceBinding.instance().pluginManager;if(t)for(const e of t.scriptsForUISourceCode(this._uiSourceCode))if(e.hasSourceURL){const t=v.formatLocalized("(provided via debug info by %s)",[lt.Linkifier.linkifyURL(e.sourceURL)]);return[new x.ToolbarItem(t)]}const i=await Xt._script(this._uiSourceCode);if(!i||!i.originStackTrace)return[];const s=Yt.linkifyStackTraceTopFrame(i.debuggerModel.target(),i.originStackTrace);return[new x.ToolbarItem(s)]}static async _script(e){const t=await le.DebuggerWorkspaceBinding.instance().uiLocationToRawLocations(e,0,0);for(const e of t){const t=e.script();if(t&&t.originStackTrace)return t}return null}}const Yt=new lt.Linkifier;var Zt=Object.freeze({__proto__:null,ScriptOriginPlugin:Xt,linkifier:Yt});class ei extends It{constructor(e,t){super(),this._textEditor=e,this._uiSourceCode=t}static accepts(e){return nt.isSnippetsUISourceCode(e)}async rightToolbarItems(){const t=x.Toolbar.createActionButtonForId("debugger.run-snippet");return t.setText(ge.isMac()?e.UIString("⌘+Enter"):e.UIString("Ctrl+Enter")),[t]}}var ti=Object.freeze({__proto__:null,SnippetsPlugin:ei});class ii{constructor(){this._searchId=0,this._searchResultCandidates=[],this._searchResultCallback=null,this._searchFinishedCallback=null,this._searchConfig=null}static _filesComparator(e,t){if(e.isDirty()&&!t.isDirty())return-1;if(!e.isDirty()&&t.isDirty())return 1;const i=e.project().type()===De.projectTypes.FileSystem&&!Ce.PersistenceImpl.instance().binding(e);if(i!==(t.project().type()===De.projectTypes.FileSystem&&!Ce.PersistenceImpl.instance().binding(t)))return i?1:-1;const s=e.url(),n=t.url();return s&&!n?-1:!s&&n?1:String.naturalOrderComparator(e.fullDisplayName(),t.fullDisplayName())}performIndexing(e){this.stopSearch();const t=this._projects(),i=new r.CompositeProgress(e);for(let e=0;e<t.length;++e){const s=t[e],n=i.createSubProgress(s.uiSourceCodes().length);s.indexContent(n)}}_projects(){const e=a.Settings.instance().moduleSetting("searchInAnonymousAndContentScripts").get();return De.WorkspaceImpl.instance().projects().filter((t=>t.type()!==De.projectTypes.Service&&(!(!e&&t.isServiceProject()&&t.type()!==De.projectTypes.Formatter)&&!(!e&&t.type()===De.projectTypes.ContentScripts))))}performSearch(e,t,i,s){this.stopSearch(),this._searchResultCandidates=[],this._searchResultCallback=i,this._searchFinishedCallback=s,this._searchConfig=e;const n=[],o=new r.CompositeProgress(t),a=o.createSubProgress(),c=new r.CompositeProgress(o.createSubProgress());for(const t of this._projects()){const i=t.uiSourceCodes().length,s=c.createSubProgress(i),o=this._projectFilesMatchingFileQuery(t,e),r=t.findFilesMatchingSearchRequest(e,o,s).then(this._processMatchingFilesForProject.bind(this,this._searchId,t,e,o));n.push(r)}Promise.all(n).then(this._processMatchingFiles.bind(this,this._searchId,a,this._searchFinishedCallback.bind(this,!0)))}_projectFilesMatchingFileQuery(e,t,i){const s=[],n=e.uiSourceCodes();for(let e=0;e<n.length;++e){const o=n[e];if(!o.contentType().isTextType())continue;const r=Ce.PersistenceImpl.instance().binding(o);r&&r.network===o||(i&&!o.isDirty()||t.filePathMatchesFileQuery(o.fullDisplayName())&&s.push(o.url()))}return s.sort(String.naturalOrderComparator),s}_processMatchingFilesForProject(e,t,i,s,n){if(e!==this._searchId&&this._searchFinishedCallback)return void this._searchFinishedCallback(!1);n.sort(String.naturalOrderComparator),n=m.intersectOrdered(n,s,String.naturalOrderComparator);const o=this._projectFilesMatchingFileQuery(t,i,!0);n=m.mergeOrdered(n,o,String.naturalOrderComparator);const r=[];for(const e of n){const i=t.uiSourceCodeForURL(e);if(!i)continue;const s=he.DefaultScriptMapping.scriptForUISourceCode(i);s&&!s.isAnonymousScript()||r.push(i)}r.sort(ii._filesComparator),this._searchResultCandidates=m.mergeOrdered(this._searchResultCandidates,r,ii._filesComparator)}_processMatchingFiles(e,t,i){if(e!==this._searchId&&this._searchFinishedCallback)return void this._searchFinishedCallback(!1);const s=this._searchResultCandidates;if(!s.length)return t.done(),void i();t.setTotalWork(s.length);let n=0;let o=0;for(let e=0;e<20&&e<s.length;++e)a.call(this);function r(e){e.isDirty()?c.call(this,e,e.workingCopy()):e.requestContent().then((t=>{c.call(this,e,t.content||"")}))}function a(){if(n>=s.length)return o?void 0:(t.done(),void i());++o;const e=s[n++];setTimeout(r.bind(this,e),0)}function c(e,i){function s(e,t){return e.lineNumber-t.lineNumber}t.worked(1);let n=[];const r=this._searchConfig,c=r.queries();if(null!==i)for(let e=0;e<c.length;++e){const t=Xe.performSearchInContent(i,c[e],!r.ignoreCase(),r.isRegex());n=m.mergeOrdered(n,t,s)}if(n&&this._searchResultCallback){const t=new si(e,n);this._searchResultCallback(t)}--o,a.call(this)}}stopSearch(){++this._searchId}}class si{constructor(e,t){this._uiSourceCode=e,this._searchMatches=t}label(){return this._uiSourceCode.displayName()}description(){return this._uiSourceCode.fullDisplayName()}matchesCount(){return this._searchMatches.length}matchLineContent(e){return this._searchMatches[e].lineContent}matchRevealable(e){const t=this._searchMatches[e];return this._uiSourceCode.uiLocation(t.lineNumber,void 0)}matchLabel(e){return this._searchMatches[e].lineNumber+1}}var ni=Object.freeze({__proto__:null,SourcesSearchScope:ii,FileBasedSearchResult:si});let oi;class ri extends dt.SearchView{constructor(){super("sources")}static instance(){return oi||(oi=new ri),oi}static async openSearch(e,t){const i=N.ViewManager.instance().view("sources.search-sources-tab");(await N.ViewManager.instance().resolveLocation("drawer-view")).appendView(i),await N.ViewManager.instance().revealView(i);const s=await i.widget();return s.toggle(e,Boolean(t)),s}createScope(){return new ii}}var ai=Object.freeze({__proto__:null,SearchSourcesView:ri,ActionDelegate:class{handleAction(e,t){return this._showSearch(),!0}_showSearch(){const e=R.InspectorView.instance().element.window().getSelection();let t="";return e&&e.rangeCount&&(t=e.toString().replace(/\r?\n.*/,"")),ri.openSearch(t)}}});const ci={Domain:"domain",File:"file",FileSystem:"fs",FileSystemFolder:"fs-folder",Frame:"frame",NetworkFolder:"nw-folder",Root:"root",SourceMapFolder:"sm-folder",Worker:"worker"},li=new Map([[ci.Root,1],[ci.Domain,10],[ci.FileSystemFolder,1],[ci.NetworkFolder,1],[ci.SourceMapFolder,2],[ci.File,10],[ci.Frame,70],[ci.Worker,90],[ci.FileSystem,100]]);class di extends f.VBox{constructor(){super(!0),this.registerRequiredCSS("sources/navigatorView.css",{enableLegacyPatching:!1}),this._placeholder=null,this._scriptsTree=new j.TreeOutlineInShadow,this._scriptsTree.registerRequiredCSS("sources/navigatorTree.css",{enableLegacyPatching:!0}),this._scriptsTree.setComparator(di._treeElementsCompare),this._scriptsTree.setFocusable(!1),this.contentElement.appendChild(this._scriptsTree.element),this.setDefaultFocusedElement(this._scriptsTree.element),this._uiSourceCodeNodes=new g,this._subfolderNodes=new Map,this._rootNode=new mi(this),this._rootNode.populate(),this._frameNodes=new Map,this.contentElement.addEventListener("contextmenu",this.handleContextMenu.bind(this),!1),B.ShortcutRegistry.instance().addShortcutListener(this.contentElement,{"sources.rename":this._renameShortcut.bind(this)}),this._navigatorGroupByFolderSetting=a.Settings.instance().moduleSetting("navigatorGroupByFolder"),this._navigatorGroupByFolderSetting.addChangeListener(this._groupingChanged.bind(this)),this._initGrouping(),Ce.PersistenceImpl.instance().addEventListener(Ce.Events.BindingCreated,this._onBindingChanged,this),Ce.PersistenceImpl.instance().addEventListener(Ce.Events.BindingRemoved,this._onBindingChanged,this),ye.TargetManager.instance().addEventListener(ye.Events.NameChanged,this._targetNameChanged,this),ye.TargetManager.instance().observeTargets(this),this._resetWorkspace(De.WorkspaceImpl.instance()),this._workspace.uiSourceCodes().forEach(this._addUISourceCode.bind(this)),ue.NetworkProjectManager.instance().addEventListener(ue.Events.FrameAttributionAdded,this._frameAttributionAdded,this),ue.NetworkProjectManager.instance().addEventListener(ue.Events.FrameAttributionRemoved,this._frameAttributionRemoved,this),this._workspace}static _treeElementOrder(e){if(hi.has(e))return 0;const t=e;let i=li.get(t._nodeType)||0;if(t._uiSourceCode){const e=t._uiSourceCode.contentType();e.isDocument()?i+=3:e.isScript()?i+=5:e.isStyleSheet()?i+=10:i+=15}return i}static appendSearchItem(t,i){let s=e.UIString("Search in folder");i&&i.trim()||(i="*",s=e.UIString("Search in all files")),t.viewSection().appendItem(s,(()=>{i&&ri.openSearch("file:"+i.trim())}))}static _treeElementsCompare(e,t){const i=di._treeElementOrder(e),s=di._treeElementOrder(t);return i>s?1:i<s?-1:_.compare(e.titleAsText(),t.titleAsText())}setPlaceholder(e){function t(){const t=this._scriptsTree.firstChild();t?e.hideWidget():e.showWidget(),this._scriptsTree.element.classList.toggle("hidden",!t)}console.assert(!this._placeholder,"A placeholder widget was already set"),this._placeholder=e,e.show(this.contentElement,this.contentElement.firstChild),t.call(this),this._scriptsTree.addEventListener(j.Events.ElementAttached,t.bind(this)),this._scriptsTree.addEventListener(j.Events.ElementsDetached,t.bind(this))}_onBindingChanged(e){const t=e.data,i=this._uiSourceCodeNodes.get(t.network);for(const e of i)e.updateTitle();const s=this._uiSourceCodeNodes.get(t.fileSystem);for(const e of s)e.updateTitle();const n=fe.FileSystemWorkspaceBinding.relativePath(t.fileSystem);let o="";for(let e=0;e<n.length-1;++e){o+=n[e];const i=this._folderNodeId(t.fileSystem.project(),null,null,t.fileSystem.origin(),o),s=this._subfolderNodes.get(i);s&&s.updateTitle(),o+="/"}const r=this._rootNode.child(t.fileSystem.project().id());r&&r.updateTitle()}focus(){this._scriptsTree.focus()}appendChild(e,t){this._scriptsTree.setFocusable(!0),e.appendChild(t)}removeChild(e,t){e.removeChild(t),0===this._scriptsTree.rootElement().childCount()&&this._scriptsTree.setFocusable(!1)}_resetWorkspace(e){this._workspace&&(this._workspace.removeEventListener(De.Events.UISourceCodeAdded,this._uiSourceCodeAdded,this),this._workspace.removeEventListener(De.Events.UISourceCodeRemoved,this._uiSourceCodeRemoved,this),this._workspace.removeEventListener(De.Events.ProjectAdded,this._projectAddedCallback,this),this._workspace.removeEventListener(De.Events.ProjectRemoved,this._projectRemovedCallback,this)),this._workspace=e,this._workspace.addEventListener(De.Events.UISourceCodeAdded,this._uiSourceCodeAdded,this),this._workspace.addEventListener(De.Events.UISourceCodeRemoved,this._uiSourceCodeRemoved,this),this._workspace.addEventListener(De.Events.ProjectAdded,this._projectAddedCallback,this),this._workspace.addEventListener(De.Events.ProjectRemoved,this._projectRemovedCallback,this),this._workspace.projects().forEach(this._projectAdded.bind(this)),this._computeUniqueFileSystemProjectNames()}_projectAddedCallback(e){const t=e.data;this._projectAdded(t),t.type()===De.projectTypes.FileSystem&&this._computeUniqueFileSystemProjectNames()}_projectRemovedCallback(e){const t=e.data;this._removeProject(t),t.type()===De.projectTypes.FileSystem&&this._computeUniqueFileSystemProjectNames()}workspace(){return this._workspace}acceptProject(e){return!e.isServiceProject()}_frameAttributionAdded(e){const t=e.data.uiSourceCode;if(!this._acceptsUISourceCode(t))return;const i=e.data.frame;this._addUISourceCodeNode(t,i)}_frameAttributionRemoved(e){const t=e.data.uiSourceCode;if(!this._acceptsUISourceCode(t))return;const i=e.data.frame,s=Array.from(this._uiSourceCodeNodes.get(t)).find((e=>e.frame()===i));this._removeUISourceCodeNode(s)}_acceptsUISourceCode(e){return this.acceptProject(e.project())}_addUISourceCode(e){if(!this._acceptsUISourceCode(e))return;const t=ue.NetworkProject.framesForUISourceCode(e);if(t.length)for(const i of t)this._addUISourceCodeNode(e,i);else this._addUISourceCodeNode(e,null);this.uiSourceCodeAdded(e)}_addUISourceCodeNode(e,t){const i=e.contentType().isFromSourceMap();let s;s=e.project().type()===De.projectTypes.FileSystem?fe.FileSystemWorkspaceBinding.relativePath(e).slice(0,-1):c.ParsedURL.extractPath(e.url()).split("/").slice(1,-1);const n=e.project(),o=ue.NetworkProject.targetForUISourceCode(e),r=this._folderNode(e,n,o,t,e.origin(),s,i),a=new gi(this,e,t);r.appendChild(a),this._uiSourceCodeNodes.set(e,a),this._selectDefaultTreeNode()}uiSourceCodeAdded(e){}_uiSourceCodeAdded(e){const t=e.data;this._addUISourceCode(t)}_uiSourceCodeRemoved(e){const t=e.data;this._removeUISourceCode(t)}tryAddProject(e){this._projectAdded(e),e.uiSourceCodes().forEach(this._addUISourceCode.bind(this))}_projectAdded(e){!this.acceptProject(e)||e.type()!==De.projectTypes.FileSystem||nt.isSnippetsProject(e)||this._rootNode.child(e.id())||(this._rootNode.appendChild(new Si(this,e,e.id(),ci.FileSystem,e.displayName())),this._selectDefaultTreeNode())}_selectDefaultTreeNode(){const e=this._rootNode.children();e.length&&!this._scriptsTree.selectedTreeElement&&e[0].treeNode().select(!0,!1)}_computeUniqueFileSystemProjectNames(){const e=this._workspace.projectsForType(De.projectTypes.FileSystem);if(!e.length)return;const t=new Ce.PathEncoder,i=e.map((e=>{const i=e;return _.reverse(t.encode(i.fileSystemPath()))})),s=new l.Trie;for(const e of i)s.add(e);for(let n=0;n<e.length;++n){const o=i[n],r=e[n];s.remove(o);const a=s.longestPrefix(o,!1);s.add(o);const c=o.substring(0,a.length+1),l=t.decode(_.reverse(c)),d=this._rootNode.child(r.id());d&&d.setTitle(l)}}_removeProject(e){const t=e.uiSourceCodes();for(let e=0;e<t.length;++e)this._removeUISourceCode(t[e]);if(e.type()!==De.projectTypes.FileSystem)return;const i=this._rootNode.child(e.id());i&&this._rootNode.removeChild(i)}_folderNodeId(e,t,i,s,n){return(t?t.id():"")+":"+(e.type()===De.projectTypes.FileSystem?e.id():"")+":"+(this._groupByFrame&&i?i.id:"")+":"+s+":"+n}_folderNode(e,t,i,s,n,o,r){if(nt.isSnippetsUISourceCode(e))return this._rootNode;if(i&&!this._groupByFolder&&!r)return this._domainNode(e,t,i,s,n);const a=o.join("/"),c=this._folderNodeId(t,i,s,n,a);let l=this._subfolderNodes.get(c);if(l)return l;if(!o.length)return i?this._domainNode(e,t,i,s,n):this._rootNode.child(t.id());const d=this._folderNode(e,t,i,s,n,o.slice(0,-1),r);let h=r?ci.SourceMapFolder:ci.NetworkFolder;t.type()===De.projectTypes.FileSystem&&(h=ci.FileSystemFolder);const u=o[o.length-1];return l=new bi(this,t,c,h,a,u),this._subfolderNodes.set(c,l),d.appendChild(l),l}_domainNode(e,t,i,s,n){const o=this._frameNode(t,i,s);if(!this._groupByDomain)return o;let r=o.child(n);return r||(r=new Si(this,t,n,ci.Domain,this._computeProjectDisplayName(i,n)),s&&n===c.ParsedURL.extractOrigin(s.url)&&hi.add(r.treeNode()),o.appendChild(r),r)}_frameNode(e,t,i){if(!this._groupByFrame||!i)return this._targetNode(e,t);let s=this._frameNodes.get(i);if(s)return s;s=new Si(this,e,t.id()+":"+i.id,ci.Frame,i.displayName()),s.setHoverCallback((function(e){if(e){const e=t.model(Te.OverlayModel);e&&i&&e.highlightFrame(i.id)}else Te.OverlayModel.hideDOMNodeHighlight()})),this._frameNodes.set(i,s);const n=i.parentFrame();return this._frameNode(e,n?n.resourceTreeModel().target():t,n).appendChild(s),n||(hi.add(s.treeNode()),s.treeNode().expand()),s}_targetNode(e,t){if(t===ye.TargetManager.instance().mainTarget())return this._rootNode;let i=this._rootNode.child("target:"+t.id());return i||(i=new Si(this,e,"target:"+t.id(),t.type()===ye.Type.Frame?ci.Frame:ci.Worker,t.name()),this._rootNode.appendChild(i)),i}_computeProjectDisplayName(t,i){const s=t.model(ke.RuntimeModel),n=s?s.executionContexts():[];for(const e of n)if(e.name&&e.origin&&i.startsWith(e.origin))return e.name;if(!i)return e.UIString("(no domain)");const o=new c.ParsedURL(i);return(o.isValid?o.host+(o.port?":"+o.port:""):"")||i}revealUISourceCode(e,t){const i=this._uiSourceCodeNodes.get(e);if(0===i.size)return null;const s=i.values().next().value;return s?(this._scriptsTree.selectedTreeElement&&this._scriptsTree.selectedTreeElement.deselect(),this._lastSelectedUISourceCode=e,s.reveal(t),s):null}_sourceSelected(e,t){this._lastSelectedUISourceCode=e,i.reveal(e,!t)}_removeUISourceCode(e){const t=this._uiSourceCodeNodes.get(e);for(const e of t)this._removeUISourceCodeNode(e)}_removeUISourceCodeNode(e){const t=e.uiSourceCode();this._uiSourceCodeNodes.delete(t,e);const i=t.project(),s=ue.NetworkProject.targetForUISourceCode(t),n=e.frame();let o=e.parent;if(!o)return;o.removeChild(e);let r=o;for(;r&&(o=r.parent,o&&r.isEmpty())&&(o!==this._rootNode||i.type()!==De.projectTypes.FileSystem)&&(r instanceof Si||r instanceof bi);){if(r._type===ci.Frame){this._discardFrame(n);break}const e=this._folderNodeId(i,s,n,t.origin(),r instanceof bi&&r._folderPath||"");this._subfolderNodes.delete(e),o.removeChild(r),r=o}}reset(){for(const e of this._uiSourceCodeNodes.valuesArray())e.dispose();this._scriptsTree.removeChildren(),this._scriptsTree.setFocusable(!1),this._uiSourceCodeNodes.clear(),this._subfolderNodes.clear(),this._frameNodes.clear(),this._rootNode.reset(),this._resetWorkspace(De.WorkspaceImpl.instance())}handleContextMenu(e){}async _renameShortcut(){const e=this._scriptsTree.selectedTreeElement,t=e&&e._node;return!!(t&&t._uiSourceCode&&t._uiSourceCode.canRename())&&(this.rename(t,!1),!0)}_handleContextMenuCreate(e,t,i){if(i){const e=fe.FileSystemWorkspaceBinding.relativePath(i);e.pop(),t=e.join("/")}this.create(e,t,i)}_handleContextMenuRename(e){this.rename(e,!1)}_handleContextMenuExclude(t,i){window.confirm(e.UIString("Are you sure you want to exclude this folder?"))&&(v.startBatchUpdate(),t.excludeFolder(fe.FileSystemWorkspaceBinding.completeURL(t,i)),v.endBatchUpdate())}_handleContextMenuDelete(t){window.confirm(e.UIString("Are you sure you want to delete this file?"))&&t.project().deleteFile(t)}handleFileContextMenu(t,i){const s=i.uiSourceCode(),n=new D.ContextMenu(t);n.appendApplicableItems(s);const o=s.project();o.type()===De.projectTypes.FileSystem&&(n.editSection().appendItem(e.UIString("Rename…"),this._handleContextMenuRename.bind(this,i)),n.editSection().appendItem(e.UIString("Make a copy…"),this._handleContextMenuCreate.bind(this,o,"",s)),n.editSection().appendItem(e.UIString("Delete"),this._handleContextMenuDelete.bind(this,s))),n.show()}_handleDeleteOverrides(e){window.confirm(p`Are you sure you want to delete all overrides contained in this folder?`)&&this._handleDeleteOverridesHelper(e)}_handleDeleteOverridesHelper(e){if(e._children.forEach((e=>{this._handleDeleteOverridesHelper(e)})),e instanceof gi){Ce.PersistenceImpl.instance().binding(e.uiSourceCode())&&e.uiSourceCode().project().deleteFile(e.uiSourceCode())}}handleFolderContextMenu(t,i){const s=i._folderPath||"",n=i._project||null,o=new D.ContextMenu(t);if(di.appendSearchItem(o,s),n){if(n.type()===De.projectTypes.FileSystem){const t=c.ParsedURL.urlToPlatformPath(fe.FileSystemWorkspaceBinding.completeURL(n,s),ge.isWin());o.revealSection().appendItem(e.UIString("Open folder"),(()=>me.InspectorFrontendHostInstance.showItemInFolder(t))),n.canCreateFile()&&o.defaultSection().appendItem(e.UIString("New file"),(()=>{this._handleContextMenuCreate(n,s,void 0)}))}n.canExcludeFolder(s)&&o.defaultSection().appendItem(e.UIString("Exclude folder"),this._handleContextMenuExclude.bind(this,n,s)),n.type()===De.projectTypes.FileSystem&&(o.defaultSection().appendAction("sources.add-folder-to-workspace",void 0,!0),i instanceof Si&&o.defaultSection().appendItem(e.UIString("Remove folder from workspace"),(()=>{window.confirm(e.UIString("Are you sure you want to remove this folder?"))&&n.remove()})),"overrides"===n.fileSystem().type()&&o.defaultSection().appendItem(p`Delete all overrides`,this._handleDeleteOverrides.bind(this,i))),o.show()}}rename(e,t){const i=e.uiSourceCode();e.rename(function(s){if(!t)return;s?e._treeElement&&e._treeElement.listItemElement.hasFocus()&&this._sourceSelected(i,!0):i.remove()}.bind(this))}async create(e,t,i){let s="";i&&(s=(await i.requestContent()).content||"");const n=await e.createFile(t,null,s);if(!n)return;this._sourceSelected(n,!1);const o=this.revealUISourceCode(n,!0);o&&this.rename(o,!0)}_groupingChanged(){this.reset(),this._initGrouping(),this._workspace.uiSourceCodes().forEach(this._addUISourceCode.bind(this))}_initGrouping(){this._groupByFrame=!0,this._groupByDomain=this._navigatorGroupByFolderSetting.get(),this._groupByFolder=this._groupByDomain}_resetForTest(){this.reset(),this._workspace.uiSourceCodes().forEach(this._addUISourceCode.bind(this))}_discardFrame(e){const t=this._frameNodes.get(e);if(t){t.parent&&t.parent.removeChild(t),this._frameNodes.delete(e);for(const t of e.childFrames)this._discardFrame(t)}}targetAdded(e){}targetRemoved(e){const t=this._rootNode.child("target:"+e.id());t&&this._rootNode.removeChild(t)}_targetNameChanged(e){const t=e.data,i=this._rootNode.child("target:"+t.id());i&&i.setTitle(t.name())}}const hi=new WeakSet;class ui extends j.TreeElement{constructor(e,t,i,s){super("",!0),this.listItemElement.classList.add("navigator-"+t+"-tree-item","navigator-folder-tree-item"),M.setAccessibleName(this.listItemElement,`${i}, ${t}`),this._nodeType=t,this.title=i,this.tooltip=i,this._navigatorView=e,this._hoverCallback=s;let n="largeicon-navigator-folder";t===ci.Domain?n="largeicon-navigator-domain":t===ci.Frame?n="largeicon-navigator-frame":t===ci.Worker&&(n="largeicon-navigator-worker"),this.setLeadingIcons([F.Icon.create(n,"icon")]),this._node}async onpopulate(){this._node.populate()}onattach(){this.collapse(),this._node.onattach(),this.listItemElement.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!1),this.listItemElement.addEventListener("mousemove",this._mouseMove.bind(this),!1),this.listItemElement.addEventListener("mouseleave",this._mouseLeave.bind(this),!1)}setNode(e){this._node=e;const t=[];let i=e;for(;i&&!i.isRoot();)t.push(i._title),i=i.parent;t.reverse(),this.tooltip=t.join("/"),M.setAccessibleName(this.listItemElement,`${this.title}, ${this._nodeType}`)}_handleContextMenuEvent(e){this._node&&(this.select(),this._navigatorView.handleFolderContextMenu(e,this._node))}_mouseMove(e){!this._hovered&&this._hoverCallback&&(this._hovered=!0,this._hoverCallback(!0))}_mouseLeave(e){this._hoverCallback&&(this._hovered=!1,this._hoverCallback(!1))}}class pi extends j.TreeElement{constructor(e,t,i,s){super("",!1),this._nodeType=ci.File,this._node=s,this.title=i,this.listItemElement.classList.add("navigator-"+t.contentType().name()+"-tree-item","navigator-file-tree-item"),this.tooltip=t.url(),M.setAccessibleName(this.listItemElement,`${t.name()}, ${this._nodeType}`),d.fireEvent("source-tree-file-added",t.fullDisplayName()),this._navigatorView=e,this._uiSourceCode=t,this.updateIcon()}updateIcon(){const e=Ce.PersistenceImpl.instance().binding(this._uiSourceCode);if(e){const t=document.createElement("span");t.classList.add("icon-stack");let i="largeicon-navigator-file-sync";nt.isSnippetsUISourceCode(e.fileSystem)&&(i="largeicon-navigator-snippet");const s=F.Icon.create(i,"icon"),n=F.Icon.create("badge-navigator-file-sync","icon-badge");ve.NetworkPersistenceManager.instance().project()===e.fileSystem.project()&&(n.style.filter="hue-rotate(160deg)"),t.appendChild(s),t.appendChild(n),I.Tooltip.install(t,we.PersistenceUtils.tooltipForUISourceCode(this._uiSourceCode)),this.setLeadingIcons([t])}else{let e="largeicon-navigator-file";nt.isSnippetsUISourceCode(this._uiSourceCode)&&(e="largeicon-navigator-snippet");const t=F.Icon.create(e,"icon");this.setLeadingIcons([t])}}get uiSourceCode(){return this._uiSourceCode}onattach(){this.listItemElement.draggable=!0,this.listItemElement.addEventListener("click",this._onclick.bind(this),!1),this.listItemElement.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!1),this.listItemElement.addEventListener("dragstart",this._ondragstart.bind(this),!1)}_shouldRenameOnMouseDown(){if(!this._uiSourceCode.canRename())return!1;if(!this.treeOutline)return!1;return this===this.treeOutline.selectedTreeElement&&this.treeOutline.element.hasFocus()&&!v.isBeingEdited(this.treeOutline.element)}selectOnMouseDown(e){1===e.which&&this._shouldRenameOnMouseDown()?setTimeout(function(){this._shouldRenameOnMouseDown()&&this._navigatorView.rename(this._node,!1)}.bind(this),300):super.selectOnMouseDown(e)}_ondragstart(e){e.dataTransfer&&(e.dataTransfer.setData("text/plain",this._uiSourceCode.url()),e.dataTransfer.effectAllowed="copy")}onspace(){return this._navigatorView._sourceSelected(this.uiSourceCode,!0),!0}_onclick(e){this._navigatorView._sourceSelected(this.uiSourceCode,!1)}ondblclick(e){const t=1===e.button;return this._navigatorView._sourceSelected(this.uiSourceCode,!t),!1}onenter(){return this._navigatorView._sourceSelected(this.uiSourceCode,!0),!0}ondelete(){return!0}_handleContextMenuEvent(e){this.select(),this._navigatorView.handleFileContextMenu(e,this._node)}}class _i{constructor(e,t,i){this.id=t,this._navigatorView=e,this._type=i,this._children=new Map,this._populated=!1,this._isMerged=!1,this.parent,this._title}treeNode(){throw"Not implemented"}dispose(){}updateTitle(){}isRoot(){return!1}hasChildren(){return!0}onattach(){}setTitle(e){throw"Not implemented"}populate(){this.isPopulated()||(this.parent&&this.parent.populate(),this._populated=!0,this.wasPopulated())}wasPopulated(){const e=this.children();for(let t=0;t<e.length;++t)this._navigatorView.appendChild(this.treeNode(),e[t].treeNode())}didAddChild(e){this.isPopulated()&&this._navigatorView.appendChild(this.treeNode(),e.treeNode())}willRemoveChild(e){this.isPopulated()&&this._navigatorView.removeChild(this.treeNode(),e.treeNode())}isPopulated(){return this._populated}isEmpty(){return!this._children.size}children(){return[...this._children.values()]}child(e){return this._children.get(e)||null}appendChild(e){this._children.set(e.id,e),e.parent=this,this.didAddChild(e)}removeChild(e){this.willRemoveChild(e),this._children.delete(e.id),e.parent=null,e.dispose()}reset(){this._children.clear()}}class mi extends _i{constructor(e){super(e,"",ci.Root)}isRoot(){return!0}treeNode(){return this._navigatorView._scriptsTree.rootElement()}}class gi extends _i{constructor(e,t,i){super(e,t.project().id()+":"+t.url(),ci.File),this._uiSourceCode=t,this._treeElement=null,this._eventListeners=[],this._frame=i}frame(){return this._frame}uiSourceCode(){return this._uiSourceCode}treeNode(){if(this._treeElement)return this._treeElement;this._treeElement=new pi(this._navigatorView,this._uiSourceCode,"",this),this.updateTitle();const e=this.updateTitle.bind(this,void 0);return this._eventListeners=[this._uiSourceCode.addEventListener(Ne.Events.TitleChanged,e),this._uiSourceCode.addEventListener(Ne.Events.WorkingCopyChanged,e),this._uiSourceCode.addEventListener(Ne.Events.WorkingCopyCommitted,e)],this._treeElement}updateTitle(t){if(!this._treeElement)return;let i=this._uiSourceCode.displayName();!t&&this._uiSourceCode.isDirty()&&(i="*"+i),this._treeElement.title=i,this._treeElement.updateIcon();let s=this._uiSourceCode.url();this._uiSourceCode.contentType().isFromSourceMap()&&(s=e.UIString("%s (from source map)",this._uiSourceCode.displayName())),this._treeElement.tooltip=s}hasChildren(){return!1}dispose(){d.EventTarget.removeEventListeners(this._eventListeners)}reveal(e){this.parent&&(this.parent.populate(),this.parent.treeNode().expand()),this._treeElement&&(this._treeElement.reveal(!0),e&&this._treeElement.select(!0))}rename(e){if(!this._treeElement)return;if(this._treeElement.listItemElement.focus(),!this._treeElement.treeOutline)return;const t=this._treeElement.treeOutline.element;function i(i){if(!i)return v.markBeingEdited(t,!1),this.updateTitle(),void this.rename(e);s.call(this,!0)}function s(i){v.markBeingEdited(t,!1),this.updateTitle(),e&&e(i)}v.markBeingEdited(t,!0),this.updateTitle(!0),this._treeElement.startEditingTitle(new V.Config(function(e,t,n){if(t!==n)return this._treeElement&&(this._treeElement.title=t),void this._uiSourceCode.rename(t).then(i.bind(this));s.call(this,!0)}.bind(this),s.bind(this,!1)))}}class bi extends _i{constructor(e,t,i,s,n,o){super(e,i,s),this._project=t,this._folderPath=n,this._title=o,this._treeElement}treeNode(){return this._treeElement||(this._treeElement=this._createTreeElement(this._title,this),this.updateTitle()),this._treeElement}updateTitle(){if(!this._treeElement||!this._project||this._project.type()!==De.projectTypes.FileSystem)return;const e=fe.FileSystemWorkspaceBinding.fileSystemPath(this._project.id())+"/"+this._folderPath,t=Ce.PersistenceImpl.instance().filePathHasBindings(e);this._treeElement.listItemElement.classList.toggle("has-mapped-files",t)}_createTreeElement(e,t){if(this._project&&this._project.type()!==De.projectTypes.FileSystem)try{e=decodeURI(e)}catch(e){}const i=new ui(this._navigatorView,this._type,e);return i.setNode(t),i}wasPopulated(){this._treeElement&&this._treeElement._node===this&&this._addChildrenRecursive()}_addChildrenRecursive(){const e=this.children();for(let t=0;t<e.length;++t){const i=e[t];this.didAddChild(i),i instanceof bi&&i._addChildrenRecursive()}}_shouldMerge(e){return this._type!==ci.Domain&&e instanceof bi}didAddChild(e){if(!this._treeElement)return;let t,i=this.children();if(1===i.length&&this._shouldMerge(e))return e._isMerged=!0,this._treeElement.title=this._treeElement.title+"/"+e._title,e._treeElement=this._treeElement,void this._treeElement.setNode(e);if(2===i.length&&(t=i[0]!==e?i[0]:i[1]),t&&t._isMerged){t._isMerged=!1;const e=[];e.push(this);let s=this;for(;s&&s._isMerged;)s=s.parent,s&&e.push(s);e.reverse();const n=e.map((e=>e._title)).join("/"),o=[];s=t;do{o.push(s),i=s.children(),s=1===i.length?i[0]:null}while(s&&s._isMerged);if(!this.isPopulated()){this._treeElement.title=n,this._treeElement.setNode(this);for(let e=0;e<o.length;++e)o[e]._treeElement=null,o[e]._isMerged=!1;return}const r=this._treeElement,a=this._createTreeElement(n,this);for(let t=0;t<e.length;++t)e[t]._treeElement=a;r.parent&&this._navigatorView.appendChild(r.parent,a),r.setNode(o[o.length-1]),r.title=o.map((e=>e._title)).join("/"),r.parent&&this._navigatorView.removeChild(r.parent,r),this._navigatorView.appendChild(this._treeElement,r),r.expanded&&a.expand()}this.isPopulated()&&this._navigatorView.appendChild(this._treeElement,e.treeNode())}willRemoveChild(e){const t=e;!t._isMerged&&this.isPopulated()&&this._treeElement&&t._treeElement&&this._navigatorView.removeChild(this._treeElement,t._treeElement)}}class Si extends _i{constructor(e,t,i,s,n){super(e,i,s),this._project=t,this._title=n,this.populate()}setHoverCallback(e){this._hoverCallback=e}treeNode(){return this._treeElement||(this._treeElement=new ui(this._navigatorView,this._type,this._title,this._hoverCallback),this._treeElement.setNode(this)),this._treeElement}onattach(){this.updateTitle()}updateTitle(){if(!this._treeElement||this._project.type()!==De.projectTypes.FileSystem)return;const e=fe.FileSystemWorkspaceBinding.fileSystemPath(this._project.id()),t=this._treeElement.listItemElement.classList.contains("has-mapped-files"),i=Ce.PersistenceImpl.instance().filePathHasBindings(e);t!==i&&(this._treeElement.listItemElement.classList.toggle("has-mapped-files",i),this._treeElement.childrenListElement.hasFocus()||(i?this._treeElement.expand():this._treeElement.collapse()))}setTitle(e){this._title=e,this._treeElement&&(this._treeElement.title=this._title)}}var Ci=Object.freeze({__proto__:null,Types:ci,NavigatorView:di,NavigatorFolderTreeElement:ui,NavigatorSourceTreeElement:pi,NavigatorTreeNode:_i,NavigatorRootTreeNode:mi,NavigatorUISourceCodeTreeNode:gi,NavigatorFolderTreeNode:bi,NavigatorGroupTreeNode:Si});let fi;class vi extends f.VBox{constructor(){super(!0),this.registerRequiredCSS("sources/threadsSidebarPane.css",{enableLegacyPatching:!0}),this._items=new k.ListModel,this._list=new T.ListControl(this._items,this,T.ListMode.NonViewport);const e=P.Context.instance().flavor(ye.Target);this._selectedModel=null!==e?e.model(xe.DebuggerModel):null,this.contentElement.appendChild(this._list.element),P.Context.instance().addFlavorChangeListener(ye.Target,this._targetFlavorChanged,this),ye.TargetManager.instance().observeModels(xe.DebuggerModel,this)}static instance(){return fi||(fi=new vi),fi}static shouldBeShown(){return ye.TargetManager.instance().models(xe.DebuggerModel).length>=2}createElementForItem(e){const t=document.createElement("div");t.classList.add("thread-item");const i=t.createChild("div","thread-item-title"),s=t.createChild("div","thread-item-paused-state");t.appendChild(F.Icon.create("smallicon-thick-right-arrow","selected-thread-icon")),t.tabIndex=-1,self.onInvokeElement(t,(t=>{P.Context.instance().setFlavor(ye.Target,e.target()),t.consume(!0)}));const n=P.Context.instance().flavor(ye.Target)===e.target();function o(){const t=e.runtimeModel().defaultExecutionContext();i.textContent=t&&t.label()?t.label():e.target().name()}function r(){s.textContent=e.isPaused()?p`paused`:""}return t.classList.toggle("selected",n),M.setSelected(t,n),e.addEventListener(xe.Events.DebuggerPaused,r),e.addEventListener(xe.Events.DebuggerResumed,r),e.runtimeModel().addEventListener(ke.Events.ExecutionContextChanged,o),ye.TargetManager.instance().addEventListener(ye.Events.NameChanged,(function(t){t.data===e.target()&&o()})),r(),o(),t}heightForItem(e){return console.assert(!1),0}isItemSelectable(e){return!0}selectedItemChanged(e,t,i,s){i&&(i.tabIndex=-1);const n=s;n&&(this.setDefaultFocusedElement(n),n.tabIndex=0,this.hasFocus()&&n.focus())}updateSelectedItemARIA(e,t){return!1}modelAdded(e){this._items.insert(this._items.length,e);P.Context.instance().flavor(ye.Target)===e.target()&&this._list.selectItem(e)}modelRemoved(e){this._items.remove(this._items.indexOf(e))}_targetFlavorChanged(e){const t=this.hasFocus(),i=e.data.model(xe.DebuggerModel);this._list.selectItem(i),i&&this._list.refreshItem(i),null!==this._selectedModel&&this._list.refreshItem(this._selectedModel),this._selectedModel=i,t&&this.focus()}}var wi=Object.freeze({__proto__:null,ThreadsSidebarPane:vi});let Ei,xi;class yi extends O.Panel{constructor(){super("sources"),this.registerRequiredCSS("sources/sourcesPanel.css",{enableLegacyPatching:!1}),new W.DropTarget(this.element,[W.Type.Folder],e.UIString("Drop workspace folder here"),this._handleDrop.bind(this)),this._workspace=De.WorkspaceImpl.instance(),this._togglePauseAction=H.ActionRegistry.instance().action("debugger.toggle-pause"),this._stepOverAction=H.ActionRegistry.instance().action("debugger.step-over"),this._stepIntoAction=H.ActionRegistry.instance().action("debugger.step-into"),this._stepOutAction=H.ActionRegistry.instance().action("debugger.step-out"),this._stepAction=H.ActionRegistry.instance().action("debugger.step"),this._toggleBreakpointsActiveAction=H.ActionRegistry.instance().action("debugger.toggle-breakpoints-active"),this._debugToolbar=this._createDebugToolbar(),this._debugToolbarDrawer=this._createDebugToolbarDrawer(),this._debuggerPausedMessage=new Bt;this._splitWidget=new z.SplitWidget(!0,!0,"sourcesPanelSplitViewState",225),this._splitWidget.enableShowModeSaving(),this._splitWidget.show(this.element);this.editorView=new z.SplitWidget(!0,!1,"sourcesPanelNavigatorSplitViewState",225),this.editorView.enableShowModeSaving(),this._splitWidget.setMainWidget(this.editorView),this._navigatorTabbedLocation=N.ViewManager.instance().createTabbedLocation(this._revealNavigatorSidebar.bind(this),"navigator-view",!0);const t=this._navigatorTabbedLocation.tabbedPane();t.setMinimumSize(100,25),t.element.classList.add("navigator-tabbed-pane");const i=new x.ToolbarMenuButton(this._populateNavigatorMenu.bind(this),!0);if(i.setTitle(e.UIString("More options")),t.rightToolbar().appendToolbarItem(i),N.ViewManager.instance().hasViewsForLocation("run-view-sidebar")){const e=new z.SplitWidget(!1,!0,"sourcePanelNavigatorSidebarSplitViewState");e.setMainWidget(t);const i=N.ViewManager.instance().createTabbedLocation(this._revealNavigatorSidebar.bind(this),"run-view-sidebar").tabbedPane();e.setSidebarWidget(i),e.installResizer(i.headerElement()),this.editorView.setSidebarWidget(e)}else this.editorView.setSidebarWidget(t);this._sourcesView=new $i,this._sourcesView.addEventListener(Ji.EditorSelected,this._editorSelected.bind(this)),this._toggleNavigatorSidebarButton=this.editorView.createShowHideSidebarButton(p`navigator`),this._toggleDebuggerSidebarButton=this._splitWidget.createShowHideSidebarButton(p`debugger`),this.editorView.setMainWidget(this._sourcesView),this._threadsSidebarPane=null,this._watchSidebarPane=N.ViewManager.instance().view("sources.watch"),this._callstackPane=ft.instance(),a.Settings.instance().moduleSetting("sidebarPosition").addChangeListener(this._updateSidebarPosition.bind(this)),this._updateSidebarPosition(),this._updateDebuggerButtonsAndStatus(),this._pauseOnExceptionEnabledChanged(),a.Settings.instance().moduleSetting("pauseOnExceptionEnabled").addChangeListener(this._pauseOnExceptionEnabledChanged,this),this._liveLocationPool=new ae.LiveLocationPool,this._setTarget(P.Context.instance().flavor(ye.Target)),a.Settings.instance().moduleSetting("breakpointsActive").addChangeListener(this._breakpointsActiveStateChanged,this),P.Context.instance().addFlavorChangeListener(ye.Target,this._onCurrentTargetChanged,this),P.Context.instance().addFlavorChangeListener(xe.CallFrame,this._callFrameChanged,this),ye.TargetManager.instance().addModelListener(xe.DebuggerModel,xe.Events.DebuggerWasEnabled,this._debuggerWasEnabled,this),ye.TargetManager.instance().addModelListener(xe.DebuggerModel,xe.Events.DebuggerPaused,this._debuggerPaused,this),ye.TargetManager.instance().addModelListener(xe.DebuggerModel,xe.Events.DebuggerResumed,(e=>this._debuggerResumed(e.data))),ye.TargetManager.instance().addModelListener(xe.DebuggerModel,xe.Events.GlobalObjectCleared,(e=>this._debuggerResumed(e.data))),st.ExtensionServer.instance().addEventListener(st.Events.SidebarPaneAdded,this._extensionSidebarPaneAdded,this),ye.TargetManager.instance().observeTargets(this),this._lastModificationTime=window.performance.now()}static instance(e={forceNew:null}){const{forceNew:t}=e;return Ei&&!t||(Ei=new yi),Ei}static updateResizerAndSidebarButtons(e){e._sourcesView.leftToolbar().removeToolbarItems(),e._sourcesView.rightToolbar().removeToolbarItems(),e._sourcesView.bottomToolbar().removeToolbarItems();const t=ki.isShowing()&&!R.InspectorView.instance().isDrawerMinimized();e._splitWidget.isVertical()||t?e._splitWidget.uninstallResizer(e._sourcesView.toolbarContainerElement()):e._splitWidget.installResizer(e._sourcesView.toolbarContainerElement()),t||(e._sourcesView.leftToolbar().appendToolbarItem(e._toggleNavigatorSidebarButton),e._splitWidget.isVertical()?e._sourcesView.rightToolbar().appendToolbarItem(e._toggleDebuggerSidebarButton):e._sourcesView.bottomToolbar().appendToolbarItem(e._toggleDebuggerSidebarButton))}targetAdded(e){this._showThreadsIfNeeded()}targetRemoved(e){}_showThreadsIfNeeded(){vi.shouldBeShown()&&!this._threadsSidebarPane&&(this._threadsSidebarPane=N.ViewManager.instance().view("sources.threads"),this._sidebarPaneStack&&this._threadsSidebarPane&&this._sidebarPaneStack.showView(this._threadsSidebarPane,this._splitWidget.isVertical()?this._watchSidebarPane:this._callstackPane))}_setTarget(e){if(!e)return;const t=e.model(xe.DebuggerModel);t&&(t.isPaused()?this._showDebuggerPausedDetails(t.debuggerPausedDetails()):(this._paused=!1,this._clearInterface(),this._toggleDebuggerSidebarButton.setEnabled(!0)))}_onCurrentTargetChanged(e){const t=e.data;this._setTarget(t)}paused(){return this._paused||!1}wasShown(){P.Context.instance().setFlavor(yi,this),super.wasShown();const e=ki.instance();e&&e.isShowing()&&(R.InspectorView.instance().setDrawerMinimized(!0),yi.updateResizerAndSidebarButtons(this)),this.editorView.setMainWidget(this._sourcesView)}willHide(){super.willHide(),P.Context.instance().setFlavor(yi,null),ki.isShowing()&&(ki.instance()._showViewInWrapper(),R.InspectorView.instance().setDrawerMinimized(!1),yi.updateResizerAndSidebarButtons(this))}resolveLocation(e){return"sources.sidebar-top"===e||"sources.sidebar-bottom"===e||"sources.sidebar-tabs"===e?this._sidebarPaneStack||null:this._navigatorTabbedLocation}_ensureSourcesViewVisible(){return!!ki.isShowing()||!!R.InspectorView.instance().canSelectPanel("sources")&&(N.ViewManager.instance().showView("sources"),!0)}onResize(){"auto"===a.Settings.instance().moduleSetting("sidebarPosition").get()&&this.element.window().requestAnimationFrame(this._updateSidebarPosition.bind(this))}searchableView(){return this._sourcesView.searchableView()}_debuggerPaused(e){const t=e.data,i=t.debuggerPausedDetails();this._paused||this._setAsCurrentPanel(),P.Context.instance().flavor(ye.Target)===t.target()?this._showDebuggerPausedDetails(i):this._paused||P.Context.instance().setFlavor(ye.Target,t.target())}_showDebuggerPausedDetails(e){this._paused=!0,this._updateDebuggerButtonsAndStatus(),P.Context.instance().setFlavor(xe.DebuggerPausedDetails,e),this._toggleDebuggerSidebarButton.setEnabled(!1),this._revealDebuggerSidebar(),window.focus(),me.InspectorFrontendHostInstance.bringToFront()}_debuggerResumed(e){const t=e.target();P.Context.instance().flavor(ye.Target)===t&&(this._paused=!1,this._clearInterface(),this._toggleDebuggerSidebarButton.setEnabled(!0),this._switchToPausedTargetTimeout=setTimeout(this._switchToPausedTarget.bind(this,e),500))}_debuggerWasEnabled(e){const t=e.data;P.Context.instance().flavor(ye.Target)===t.target()&&this._updateDebuggerButtonsAndStatus()}get visibleView(){return this._sourcesView.visibleView()}showUISourceCode(e,t,i,s){if(s){const e=ki.isShowing();if(!this.isShowing()&&!e)return}else this._showEditor();this._sourcesView.showSourceLocation(e,t,i,s)}_showEditor(){ki.isShowing()||this._setAsCurrentPanel()}showUILocation(e,t){this.showUISourceCode(e.uiSourceCode,e.lineNumber,e.columnNumber,t)}_revealInNavigator(e,t){const i=re.Runtime.instance().extensions(di);Promise.all(i.map((e=>e.instance()))).then(function(s){for(let n=0;n<s.length;++n){const o=s[n],r=i[n].descriptor().viewId;r&&o.acceptProject(e.project())&&(o.revealUISourceCode(e,!0),t?this._navigatorTabbedLocation.tabbedPane().selectTab(r):N.ViewManager.instance().showView(r))}}.bind(this))}_populateNavigatorMenu(t){const i=a.Settings.instance().moduleSetting("navigatorGroupByFolder");t.appendItemsAtLocation("navigatorMenu"),t.viewSection().appendCheckboxItem(e.UIString("Group by folder"),(()=>i.set(!i.get())),i.get())}setIgnoreExecutionLineEvents(e){this._ignoreExecutionLineEvents=e}updateLastModificationTime(){this._lastModificationTime=window.performance.now()}async _executionLineChanged(e){const t=await e.uiLocation();t&&(window.performance.now()-this._lastModificationTime<Ii||this._sourcesView.showSourceLocation(t.uiSourceCode,t.lineNumber,t.columnNumber,void 0,!0))}_lastModificationTimeoutPassedForTest(){Ii=Number.MIN_VALUE}_updateLastModificationTimeForTest(){Ii=Number.MAX_VALUE}async _callFrameChanged(){const e=P.Context.instance().flavor(xe.CallFrame);e&&(this._executionLineLocation&&this._executionLineLocation.dispose(),this._executionLineLocation=await le.DebuggerWorkspaceBinding.instance().createCallFrameLiveLocation(e.location(),this._executionLineChanged.bind(this),this._liveLocationPool))}_pauseOnExceptionEnabledChanged(){const e=a.Settings.instance().moduleSetting("pauseOnExceptionEnabled").get(),t=this._pauseOnExceptionButton;t.setToggled(e),t.setTitle(e?p`Don't pause on exceptions`:p`Pause on exceptions`),this._debugToolbarDrawer.classList.toggle("expanded",e)}async _updateDebuggerButtonsAndStatus(){const e=P.Context.instance().flavor(ye.Target),t=e?e.model(xe.DebuggerModel):null;t?this._paused?(this._togglePauseAction.setToggled(!0),this._togglePauseAction.setEnabled(!0),this._stepOverAction.setEnabled(!0),this._stepIntoAction.setEnabled(!0),this._stepOutAction.setEnabled(!0),this._stepAction.setEnabled(!0)):(this._togglePauseAction.setToggled(!1),this._togglePauseAction.setEnabled(!t.isPausing()),this._stepOverAction.setEnabled(!1),this._stepIntoAction.setEnabled(!1),this._stepOutAction.setEnabled(!1),this._stepAction.setEnabled(!1)):(this._togglePauseAction.setEnabled(!1),this._stepOverAction.setEnabled(!1),this._stepIntoAction.setEnabled(!1),this._stepOutAction.setEnabled(!1),this._stepAction.setEnabled(!1));const i=t?t.debuggerPausedDetails():null;await this._debuggerPausedMessage.render(i,le.DebuggerWorkspaceBinding.instance(),pe.BreakpointManager.instance()),i&&this._updateDebuggerButtonsAndStatusForTest()}_updateDebuggerButtonsAndStatusForTest(){}_clearInterface(){this._updateDebuggerButtonsAndStatus(),P.Context.instance().setFlavor(xe.DebuggerPausedDetails,null),this._switchToPausedTargetTimeout&&clearTimeout(this._switchToPausedTargetTimeout),this._liveLocationPool.disposeAll()}_switchToPausedTarget(e){if(delete this._switchToPausedTargetTimeout,!this._paused&&!e.isPaused())for(const e of ye.TargetManager.instance().models(xe.DebuggerModel))if(e.isPaused()){P.Context.instance().setFlavor(ye.Target,e.target());break}}_togglePauseOnExceptions(){a.Settings.instance().moduleSetting("pauseOnExceptionEnabled").set(!this._pauseOnExceptionButton.toggled())}_runSnippet(){const e=this._sourcesView.currentUISourceCode();e&&nt.evaluateScriptSnippet(e)}_toggleRecording(){const e=this._sourcesView.currentUISourceCode();if(!e)return;const t=P.Context.instance().flavor(ye.Target);if(!t)return;const i=t.model(ct.RecorderModel);i&&i.toggleRecording(e)}_editorSelected(e){const t=e.data;this.editorView.mainWidget()&&a.Settings.instance().moduleSetting("autoRevealInNavigator").get()&&this._revealInNavigator(t,!0)}_togglePause(){const e=P.Context.instance().flavor(ye.Target);if(!e)return!0;const t=e.model(xe.DebuggerModel);return!t||(this._paused?(this._paused=!1,t.resume()):t.pause(),this._clearInterface(),!0)}_prepareToResume(){if(!this._paused)return null;this._paused=!1,this._clearInterface();const e=P.Context.instance().flavor(ye.Target);return e?e.model(xe.DebuggerModel):null}_longResume(e){const t=this._prepareToResume();t&&(t.skipAllPausesUntilReloadOrTimeout(500),t.resume())}_terminateExecution(e){const t=this._prepareToResume();t&&(t.runtimeModel().terminateExecution(),t.resume())}_stepOver(){const e=this._prepareToResume();return e&&e.stepOver(),!0}_stepInto(){const e=this._prepareToResume();return e&&e.stepInto(),!0}_stepIntoAsync(){const e=this._prepareToResume();return e&&e.scheduleStepIntoAsync(),!0}_stepOut(){const e=this._prepareToResume();return e&&e.stepOut(),!0}async _continueToLocation(e){const t=P.Context.instance().flavor(ke.ExecutionContext);if(!t)return;const i=(await le.DebuggerWorkspaceBinding.instance().uiLocationToRawLocations(e.uiSourceCode,e.lineNumber,0)).find((e=>e.debuggerModel===t.debuggerModel));i&&this._prepareToResume()&&i.continueToLocation()}_toggleBreakpointsActive(){a.Settings.instance().moduleSetting("breakpointsActive").set(!a.Settings.instance().moduleSetting("breakpointsActive").get())}_breakpointsActiveStateChanged(){const e=a.Settings.instance().moduleSetting("breakpointsActive").get();this._toggleBreakpointsActiveAction.setToggled(!e),this._sourcesView.toggleBreakpointsActiveState(e)}_createDebugToolbar(){const t=new x.Toolbar("scripts-debug-toolbar"),i=new x.ToolbarButton(e.UIString("Resume with all pauses blocked for 500 ms"),"largeicon-play");i.addEventListener(x.ToolbarButton.Events.Click,this._longResume,this);const s=new x.ToolbarButton(p`Terminate current JavaScript call`,"largeicon-terminate-execution");return s.addEventListener(x.ToolbarButton.Events.Click,this._terminateExecution,this),t.appendToolbarItem(x.Toolbar.createLongPressActionButton(this._togglePauseAction,[s,i],[])),t.appendToolbarItem(x.Toolbar.createActionButton(this._stepOverAction)),t.appendToolbarItem(x.Toolbar.createActionButton(this._stepIntoAction)),t.appendToolbarItem(x.Toolbar.createActionButton(this._stepOutAction)),t.appendToolbarItem(x.Toolbar.createActionButton(this._stepAction)),t.appendSeparator(),t.appendToolbarItem(x.Toolbar.createActionButton(this._toggleBreakpointsActiveAction)),this._pauseOnExceptionButton=new x.ToolbarToggle("","largeicon-pause-on-exceptions"),this._pauseOnExceptionButton.addEventListener(x.ToolbarButton.Events.Click,this._togglePauseOnExceptions,this),t.appendToolbarItem(this._pauseOnExceptionButton),t}_createDebugToolbarDrawer(){const t=document.createElement("div");t.classList.add("scripts-debug-toolbar-drawer");const i=e.UIString("Pause on caught exceptions"),s=a.Settings.instance().moduleSetting("pauseOnCaughtException");return t.appendChild(q.createSettingCheckbox(i,s,!0)),t}appendApplicableItems(e,t,i){this._appendUISourceCodeItems(e,t,i),this._appendUISourceCodeFrameItems(e,t,i),this.appendUILocationItems(t,i),this._appendRemoteObjectItems(t,i),this._appendNetworkRequestItems(t,i)}_appendUISourceCodeItems(t,i,s){if(!(s instanceof Ne.UISourceCode&&t.target))return;const n=s,o=t.target;n.project().isServiceProject()||o.isSelfOrDescendant(this._navigatorTabbedLocation.widget().element)||i.revealSection().appendItem(e.UIString("Reveal in sidebar"),this._handleContextMenuReveal.bind(this,n))}_appendUISourceCodeFrameItems(e,t,i){i instanceof Pi&&(i.uiSourceCode().contentType().isFromSourceMap()||i.textEditor.selection().isEmpty()||t.debugSection().appendAction("debugger.evaluate-selection"))}appendUILocationItems(t,i){if(!(i instanceof Ne.UILocation))return;const s=i,n=s.uiSourceCode;if(!le.DebuggerWorkspaceBinding.instance().scriptsForUISourceCode(n).every((e=>e.isJavaScript())))return;if(n.contentType().hasScripts()){const i=P.Context.instance().flavor(ye.Target),o=i?i.model(xe.DebuggerModel):null;o&&o.isPaused()&&t.debugSection().appendItem(e.UIString("Continue to here"),this._continueToLocation.bind(this,s)),this._callstackPane.appendIgnoreListURLContextMenuItems(t,n)}}_handleContextMenuReveal(e){this.editorView.showBoth(),this._revealInNavigator(e)}_appendRemoteObjectItems(e,t){if(!(t instanceof Pe.RemoteObject))return;const i=a.Settings.instance().moduleSetting("textEditorIndent").get(),s=t,n=P.Context.instance().flavor(ke.ExecutionContext);const o="wasm"===s.type?s.subtype:"node"===s.subtype?"outerHTML":s.type;if(e.debugSection().appendItem(p`Store ${o} as global variable`,(()=>Me.ConsoleModel.instance().saveToTempVariable(n,s))),"function"!==s.type){const t=async()=>{const e=await s.callFunctionJSON(r,[{value:{subtype:s.subtype,indent:i}}]);me.InspectorFrontendHostInstance.copyText(e)};e.clipboardSection().appendItem(p`Copy ${o}`,t)}function r(e){const t=e.subtype,i=e.indent;if("node"===t)return this instanceof Element?this.outerHTML:void 0;if(t&&void 0===this)return String(t);try{return JSON.stringify(this,null,i)}catch(e){return String(this)}}"function"===s.type&&e.debugSection().appendItem(p`Show function definition`,this._showFunctionDefinition.bind(this,s))}_appendNetworkRequestItems(t,i){if(!(i instanceof Fe.NetworkRequest))return;const s=i,n=this._workspace.uiSourceCodeForURL(s.url());if(!n)return;const o=e.UIString("Open in Sources panel"),r=this.showUILocation.bind(this,n.uiLocation(0,0));t.revealSection().appendItem(o,r)}_showFunctionDefinition(e){e.debuggerModel().functionDetailsPromise(e).then(this._didGetFunctionDetails.bind(this))}async _didGetFunctionDetails(e){if(!e||!e.location)return;const t=await le.DebuggerWorkspaceBinding.instance().rawLocationToUILocation(e.location);t&&this.showUILocation(t)}_revealNavigatorSidebar(){this._setAsCurrentPanel(),this.editorView.showBoth(!0)}_revealDebuggerSidebar(){this._setAsCurrentPanel(),this._splitWidget.showBoth(!0)}_updateSidebarPosition(){let e;const t=a.Settings.instance().moduleSetting("sidebarPosition").get();if(e="right"!==t&&("bottom"===t||R.InspectorView.instance().element.offsetWidth<680),this.sidebarPaneView&&e===!this._splitWidget.isVertical())return;if(this.sidebarPaneView&&this.sidebarPaneView.shouldHideOnDetach())return;this.sidebarPaneView&&this.sidebarPaneView.detach(),this._splitWidget.setVertical(!e),this._splitWidget.element.classList.toggle("sources-split-view-vertical",e),yi.updateResizerAndSidebarButtons(this);const i=new f.VBox;i.element.appendChild(this._debugToolbar.element),i.element.appendChild(this._debugToolbarDrawer),i.setMinimumAndPreferredSizes(Li,25,Li,100),this._sidebarPaneStack=N.ViewManager.instance().createStackLocation(this._revealDebuggerSidebar.bind(this)),this._sidebarPaneStack.widget().element.classList.add("overflow-auto"),this._sidebarPaneStack.widget().show(i.element),this._sidebarPaneStack.widget().element.appendChild(this._debuggerPausedMessage.element()),this._sidebarPaneStack.appendApplicableItems("sources.sidebar-top"),this._threadsSidebarPane&&this._sidebarPaneStack.showView(this._threadsSidebarPane);const s=N.ViewManager.instance().view("sources.jsBreakpoints"),n=N.ViewManager.instance().view("sources.scopeChain");if(this._tabbedLocationHeader&&(this._splitWidget.uninstallResizer(this._tabbedLocationHeader),this._tabbedLocationHeader=null),e){const e=new z.SplitWidget(!0,!0,"sourcesPanelDebuggerSidebarSplitViewState",.5);e.setMainWidget(i),this._sidebarPaneStack.showView(s),this._sidebarPaneStack.showView(this._callstackPane);const t=N.ViewManager.instance().createTabbedLocation(this._revealDebuggerSidebar.bind(this));e.setSidebarWidget(t.tabbedPane()),this._tabbedLocationHeader=t.tabbedPane().headerElement(),this._splitWidget.installResizer(this._tabbedLocationHeader),this._splitWidget.installResizer(this._debugToolbar.gripElementForResize()),t.appendView(n),t.appendView(this._watchSidebarPane),t.appendApplicableItems("sources.sidebar-tabs"),this._extensionSidebarPanesContainer=t,this.sidebarPaneView=e}else this._sidebarPaneStack.appendView(this._watchSidebarPane),this._sidebarPaneStack.showView(s),this._sidebarPaneStack.showView(n),this._sidebarPaneStack.showView(this._callstackPane),this._extensionSidebarPanesContainer=this._sidebarPaneStack,this.sidebarPaneView=i,this._splitWidget.uninstallResizer(this._debugToolbar.gripElementForResize());this._sidebarPaneStack.appendApplicableItems("sources.sidebar-bottom");const o=st.ExtensionServer.instance().sidebarPanes();for(let e=0;e<o.length;++e)this._addExtensionSidebarPane(o[e]);this._splitWidget.setSidebarWidget(this.sidebarPaneView)}_setAsCurrentPanel(){return N.ViewManager.instance().showView("sources")}_extensionSidebarPaneAdded(e){const t=e.data;this._addExtensionSidebarPane(t)}_addExtensionSidebarPane(e){e.panelName()===this.name&&this._extensionSidebarPanesContainer.appendView(e)}sourcesView(){return this._sourcesView}_handleDrop(e){const t=e.items;if(!t.length)return;const i=t[0].webkitGetAsEntry();i.isDirectory&&me.InspectorFrontendHostInstance.upgradeDraggedFileSystemPermissions(i.filesystem)}}let Ii=200;const Li=215;class ki extends f.VBox{constructor(){super(),this.element.classList.add("sources-view-wrapper"),this._view=yi.instance()._sourcesView}static instance(){return xi||(xi=new ki),xi}static isShowing(){return Boolean(xi)&&xi.isShowing()}wasShown(){yi.instance().isShowing()?R.InspectorView.instance().setDrawerMinimized(!0):this._showViewInWrapper(),yi.updateResizerAndSidebarButtons(yi.instance())}willHide(){R.InspectorView.instance().setDrawerMinimized(!1),queueMicrotask((()=>{yi.updateResizerAndSidebarButtons(yi.instance())}))}_showViewInWrapper(){this._view.show(this.element)}}var Ti=Object.freeze({__proto__:null,SourcesPanel:yi,get lastModificationTimeout(){return Ii},minToolbarWidth:Li,UILocationRevealer:class{reveal(e,t){return e instanceof Ne.UILocation?(yi.instance().showUILocation(e,t),Promise.resolve()):Promise.reject(new Error("Internal error: not a ui location"))}},DebuggerLocationRevealer:class{async reveal(e,t){if(!(e instanceof xe.Location))throw new Error("Internal error: not a debugger location");const i=await le.DebuggerWorkspaceBinding.instance().rawLocationToUILocation(e);i&&yi.instance().showUILocation(i,t)}},UISourceCodeRevealer:class{reveal(e,t){return e instanceof Ne.UISourceCode?(yi.instance().showUISourceCode(e,void 0,void 0,t),Promise.resolve()):Promise.reject(new Error("Internal error: not a ui source code"))}},DebuggerPausedDetailsRevealer:class{reveal(e){return yi.instance()._setAsCurrentPanel()}},RevealingActionDelegate:class{handleAction(e,t){const i=yi.instance();if(!i._ensureSourcesViewVisible())return!1;switch(t){case"debugger.toggle-pause":return i._togglePause(),!0}return!1}},DebuggingActionDelegate:class{handleAction(e,t){const i=yi.instance();switch(t){case"debugger.step-over":return i._stepOver(),!0;case"debugger.step-into":return i._stepIntoAsync(),!0;case"debugger.step":return i._stepInto(),!0;case"debugger.step-out":return i._stepOut(),!0;case"debugger.run-snippet":return i._runSnippet(),!0;case"recorder.toggle-recording":return i._toggleRecording(),!0;case"debugger.toggle-breakpoints-active":return i._toggleBreakpointsActive(),!0;case"debugger.evaluate-selection":{const e=P.Context.instance().flavor(Pi);if(e){let t=e.textEditor.text(e.textEditor.selection());const i=P.Context.instance().flavor(ke.ExecutionContext);if(i){const e=Me.ConsoleModel.instance().addCommandMessage(i,t);t=ie.JavaScriptREPL.wrapObjectLiteral(t),Me.ConsoleModel.instance().evaluateCommandInConsole(i,e,t,!0)}}return!0}}return!1}},WrapperView:ki});class Pi extends Ke.SourceFrameImpl{constructor(e){super((function(){if(e.isDirty())return Promise.resolve({content:e.workingCopy(),isEncoded:!1});return e.requestContent()})),this._uiSourceCode=e,re.experiments.isEnabled("sourceDiff")&&(this._diff=new Ge.SourceCodeDiff(this.textEditor)),this._muteSourceCodeEvents=!1,this._isSettingContent=!1,this._persistenceBinding=Ce.PersistenceImpl.instance().binding(e),this._rowMessageBuckets=new Map,this._typeDecorationsPending=new Set,this._uiSourceCodeEventListeners=[],this._messageAndDecorationListeners=[],this._boundOnBindingChanged=this._onBindingChanged.bind(this),this.textEditor.addEventListener(qe.Events.EditorBlurred,(()=>P.Context.instance().setFlavor(Pi,null))),this.textEditor.addEventListener(qe.Events.EditorFocused,(()=>P.Context.instance().setFlavor(Pi,this))),a.Settings.instance().moduleSetting("persistenceNetworkOverridesEnabled").addChangeListener(this._onNetworkPersistenceChanged,this),this._errorPopoverHelper=new G.PopoverHelper(this.element,this._getErrorPopoverContent.bind(this)),this._errorPopoverHelper.setHasPadding(!0),this._errorPopoverHelper.setTimeout(100,100),this._plugins=[],this._initializeUISourceCode()}_installMessageAndDecorationListeners(){if(this._persistenceBinding){const e=this._persistenceBinding.network,t=this._persistenceBinding.fileSystem;this._messageAndDecorationListeners=[e.addEventListener(Ne.Events.MessageAdded,this._onMessageAdded,this),e.addEventListener(Ne.Events.MessageRemoved,this._onMessageRemoved,this),e.addEventListener(Ne.Events.LineDecorationAdded,this._onLineDecorationAdded,this),e.addEventListener(Ne.Events.LineDecorationRemoved,this._onLineDecorationRemoved,this),t.addEventListener(Ne.Events.MessageAdded,this._onMessageAdded,this),t.addEventListener(Ne.Events.MessageRemoved,this._onMessageRemoved,this)]}else this._messageAndDecorationListeners=[this._uiSourceCode.addEventListener(Ne.Events.MessageAdded,this._onMessageAdded,this),this._uiSourceCode.addEventListener(Ne.Events.MessageRemoved,this._onMessageRemoved,this),this._uiSourceCode.addEventListener(Ne.Events.LineDecorationAdded,this._onLineDecorationAdded,this),this._uiSourceCode.addEventListener(Ne.Events.LineDecorationRemoved,this._onLineDecorationRemoved,this)]}uiSourceCode(){return this._uiSourceCode}setUISourceCode(e){this._unloadUISourceCode(),this._uiSourceCode=e,e.contentLoaded()?e.workingCopy()!==this.textEditor.text()&&this._innerSetContent(e.workingCopy()):e.requestContent().then((()=>{this._uiSourceCode===e&&e.workingCopy()!==this.textEditor.text()&&this._innerSetContent(e.workingCopy())})),this._initializeUISourceCode()}_unloadUISourceCode(){this._disposePlugins();for(const e of this._allMessages())this._removeMessageFromSource(e);d.EventTarget.removeEventListeners(this._messageAndDecorationListeners),d.EventTarget.removeEventListeners(this._uiSourceCodeEventListeners),this._uiSourceCode.removeWorkingCopyGetter(),Ce.PersistenceImpl.instance().unsubscribeFromBindingEvent(this._uiSourceCode,this._boundOnBindingChanged)}_initializeUISourceCode(){this._uiSourceCodeEventListeners=[this._uiSourceCode.addEventListener(Ne.Events.WorkingCopyChanged,this._onWorkingCopyChanged,this),this._uiSourceCode.addEventListener(Ne.Events.WorkingCopyCommitted,this._onWorkingCopyCommitted,this),this._uiSourceCode.addEventListener(Ne.Events.TitleChanged,this._refreshHighlighterType,this)],Ce.PersistenceImpl.instance().subscribeForBindingEvent(this._uiSourceCode,this._boundOnBindingChanged);for(const e of this._allMessages())this._addMessageToSource(e);if(this._installMessageAndDecorationListeners(),this._updateStyle(),this._decorateAllTypes(),this._refreshHighlighterType(),re.experiments.isEnabled("sourcesPrettyPrint")){const e=new Set(["text/html","text/css","text/javascript"]);this.setCanPrettyPrint(e.has(this.highlighterType()),!0)}this._ensurePluginsLoaded()}wasShown(){super.wasShown(),window.setTimeout((()=>this._updateBucketDecorations()),0),this.setEditable(this._canEditSource());for(const e of this._plugins)e.wasShown()}willHide(){for(const e of this._plugins)e.willHide();super.willHide(),P.Context.instance().setFlavor(Pi,null),this._uiSourceCode.removeWorkingCopyGetter()}_refreshHighlighterType(){const e=Ce.PersistenceImpl.instance().binding(this._uiSourceCode),t=e?e.network.mimeType():this._uiSourceCode.mimeType();this.highlighterType()!==t&&(this._disposePlugins(),this.setHighlighterType(t),this._ensurePluginsLoaded())}_canEditSource(){return!this.hasLoadError()&&(!this._uiSourceCode.editDisabled()&&("application/wasm"!==this._uiSourceCode.mimeType()&&(!!Ce.PersistenceImpl.instance().binding(this._uiSourceCode)||(!!this._uiSourceCode.project().canSetFileContent()||!this._uiSourceCode.project().isServiceProject()&&(!(this._uiSourceCode.project().type()!==De.projectTypes.Network||!ve.NetworkPersistenceManager.instance().active())||(!this.pretty||!this._uiSourceCode.contentType().hasScripts())&&this._uiSourceCode.contentType()!==h.resourceTypes.Document)))))}_onNetworkPersistenceChanged(){this.setEditable(this._canEditSource())}commitEditing(){this._uiSourceCode.isDirty()&&(this._muteSourceCodeEvents=!0,this._uiSourceCode.commitWorkingCopy(),this._muteSourceCodeEvents=!1)}setContent(e,t){this._disposePlugins(),this._rowMessageBuckets.clear(),super.setContent(e,t);for(const e of this._allMessages())this._addMessageToSource(e);this._decorateAllTypes(),this._ensurePluginsLoaded()}_allMessages(){if(this._persistenceBinding){const e=this._persistenceBinding.network.messages();return b.addAll(e,this._persistenceBinding.fileSystem.messages()),e}return this._uiSourceCode.messages()}onTextChanged(e,t){const i=this.pretty;super.onTextChanged(e,t),this._errorPopoverHelper.hidePopover(),this._isSettingContent||(yi.instance().updateLastModificationTime(),this._muteSourceCodeEvents=!0,this.isClean()?this._uiSourceCode.resetWorkingCopy():this._uiSourceCode.setWorkingCopyGetter(this.textEditor.text.bind(this.textEditor)),this._muteSourceCodeEvents=!1,i!==this.pretty&&(this._updateStyle(),this._disposePlugins(),this._ensurePluginsLoaded()))}_onWorkingCopyChanged(e){this._muteSourceCodeEvents||this._innerSetContent(this._uiSourceCode.workingCopy())}_onWorkingCopyCommitted(e){this._muteSourceCodeEvents||this._innerSetContent(this._uiSourceCode.workingCopy()),this.contentCommitted(),this._updateStyle()}_ensurePluginsLoaded(){if(!this.loaded||this._plugins.length)return;const e=Ce.PersistenceImpl.instance().binding(this._uiSourceCode),t=e?e.network:this._uiSourceCode;ms.accepts(t)&&this._plugins.push(new ms(this.textEditor,t,this)),Pt.accepts(t)&&this._plugins.push(new Pt(this.textEditor)),!this.pretty&&Gt.accepts(t)&&this._plugins.push(new Gt(this.textEditor,t)),ei.accepts(t)&&this._plugins.push(new ei(this.textEditor,t)),re.experiments.isEnabled("recorder")&&Jt.accepts(t)&&this._plugins.push(new Jt(this.textEditor,t)),Xt.accepts(t)&&this._plugins.push(new Xt(this.textEditor,t)),!this.pretty&&re.experiments.isEnabled("sourceDiff")&&Wt.accepts(t)&&this._plugins.push(new Wt(this.textEditor,t)),kt.accepts(t)&&this._plugins.push(new kt(this.textEditor,t)),this.dispatchEventToListeners(Ri.ToolbarItemsChanged);for(const e of this._plugins)e.wasShown()}_disposePlugins(){this.textEditor.operation((()=>{for(const e of this._plugins)e.dispose()})),this._plugins=[]}_onBindingChanged(){const e=Ce.PersistenceImpl.instance().binding(this._uiSourceCode);e!==this._persistenceBinding&&(this._unloadUISourceCode(),this._persistenceBinding=e,this._initializeUISourceCode())}_updateStyle(){this.setEditable(this._canEditSource())}_innerSetContent(e){this._isSettingContent=!0;const t=this.textEditor.text();this._diff&&this._diff.highlightModifiedLines(t,e),t!==e&&this.setContent(e,null),this._isSettingContent=!1}async populateTextAreaContextMenu(e,t,i){await super.populateTextAreaContextMenu(e,t,i),e.appendApplicableItems(this._uiSourceCode);const s=this.editorLocationToUILocation(t,i);e.appendApplicableItems(new Ne.UILocation(this._uiSourceCode,s.lineNumber,s.columnNumber)),e.appendApplicableItems(this);for(const s of this._plugins)await s.populateTextAreaContextMenu(e,t,i)}dispose(){this._errorPopoverHelper.dispose(),this._unloadUISourceCode(),this.textEditor.dispose(),this.detach(),a.Settings.instance().moduleSetting("persistenceNetworkOverridesEnabled").removeChangeListener(this._onNetworkPersistenceChanged,this)}_onMessageAdded(e){const t=e.data;this._addMessageToSource(t)}_getClampedEditorLineNumberForMessage(e){let{lineNumber:t}=this.uiLocationToEditorLocation(e.lineNumber(),e.columnNumber());return t>=this.textEditor.linesCount&&(t=this.textEditor.linesCount-1),t<0&&(t=0),t}_addMessageToSource(e){if(!this.loaded)return;const t=this._getClampedEditorLineNumberForMessage(e);let i=this._rowMessageBuckets.get(t);i||(i=new Ui(this,this.textEditor,t),this._rowMessageBuckets.set(t,i)),i.addMessage(e)}_onMessageRemoved(e){const t=e.data;this._removeMessageFromSource(t)}_removeMessageFromSource(e){if(!this.loaded)return;const t=this._getClampedEditorLineNumberForMessage(e),i=this._rowMessageBuckets.get(t);i&&(i.removeMessage(e),i.uniqueMessagesCount()||(i.detachFromEditor(),this._rowMessageBuckets.delete(t)))}_getErrorPopoverContent(e){const t=e,i=t.target,s=Bi.get(i.enclosingNodeOrSelfWithClass("text-editor-line-decoration"));return s?s.getPopover(i,t):null}_updateBucketDecorations(){for(const e of this._rowMessageBuckets.values())e._updateDecoration()}_onLineDecorationAdded(e){const t=e.data;this._decorateTypeThrottled(t.type())}_onLineDecorationRemoved(e){const t=e.data;this._decorateTypeThrottled(t.type())}async _decorateTypeThrottled(e){if(this._typeDecorationsPending.has(e))return;this._typeDecorationsPending.add(e);const t=re.Runtime.instance().extensions(Ke.LineDecorator).find((t=>t.descriptor().decoratorType===e)),i=await t.instance();this._typeDecorationsPending.delete(e),this.textEditor.codeMirror().operation((()=>{i.decorate(this._persistenceBinding?this._persistenceBinding.network:this.uiSourceCode(),this.textEditor,e)}))}_decorateAllTypes(){if(this.loaded)for(const e of re.Runtime.instance().extensions(Ke.LineDecorator)){const t=e.descriptor().decoratorType;null!==t&&this._uiSourceCode.decorationsForType(t)&&this._decorateTypeThrottled(t)}}async toolbarItems(){const e=await super.toolbarItems(),t=[];for(const i of this._plugins)e.push(...i.leftToolbarItems()),t.push(...await i.rightToolbarItems());return t.length?[...e,new x.ToolbarSeparator(!0),...t]:e}async populateLineGutterContextMenu(e,t){await super.populateLineGutterContextMenu(e,t);for(const i of this._plugins)await i.populateLineGutterContextMenu(e,t)}}function Mi(e){return e===Ne.Message.Level.Error?{color:"",width:"11px",height:"11px",iconName:"error_icon"}:e===Ne.Message.Level.Warning?{color:"",width:"11px",height:"11px",iconName:"warning_icon"}:e===Ne.Message.Level.Issue?{color:"",width:"11px",height:"11px",iconName:"breaking_change_icon"}:{color:"",width:"11px",height:"11px",iconName:"error_icon"}}const Fi=new Map;Fi.set(Ne.Message.Level.Error,"error"),Fi.set(Ne.Message.Level.Warning,"warning"),Fi.set(Ne.Message.Level.Issue,"warning");const Di=new Map;Di.set(Ne.Message.Level.Error,"text-editor-line-with-error"),Di.set(Ne.Message.Level.Warning,"text-editor-line-with-warning"),Di.set(Ne.Message.Level.Issue,"text-editor-line-with-warning");class Ni{constructor(e){this._message=e,this._repeatCount=1,this.element=document.createElement("div"),this.element.classList.add("text-editor-row-message"),this._icon=new ot.Icon,this._icon.data=Mi(e.level()),this._icon.classList.add("text-editor-row-message-icon"),this._icon.addEventListener("click",(()=>this.callClickHandler())),this.element.append(this._icon),this._repeatCountElement=this.element.createChild("span","text-editor-row-message-repeat-count hidden","dt-small-bubble"),this._repeatCountElement.type=Fi.get(e.level());const t=this.element.createChild("div"),i=this._message.text().split("\n");for(let e=0;e<i.length;++e){t.createChild("div").textContent=i[e]}}message(){return this._message}callClickHandler(){const e=this._message.clickHandler();e&&e()}repeatCount(){return this._repeatCount}setRepeatCount(e){this._repeatCount!==e&&(this._repeatCount=e,this._updateMessageRepeatCount())}_updateMessageRepeatCount(){this._repeatCountElement.textContent=String(this._repeatCount);const e=this._repeatCount>1;this._repeatCountElement.classList.toggle("hidden",!e),this._icon.classList.toggle("hidden",e)}}const Bi=new WeakMap;class Ui{constructor(e,t,i){this._sourceFrame=e,this.textEditor=t,this._lineHandle=t.textEditorPositionHandle(i,0),this._decoration=document.createElement("div"),this._decoration.classList.add("text-editor-line-decoration"),Bi.set(this._decoration,this),this._wave=this._decoration.createChild("div","text-editor-line-decoration-wave"),this._errorIcon=new ot.Icon,this._errorIcon.data=Mi(Ne.Message.Level.Warning),this._errorIcon.classList.add("text-editor-line-decoration-icon-error","hidden"),this._issueIcon=new ot.Icon,this._issueIcon.data=Mi(Ne.Message.Level.Issue),this._issueIcon.classList.add("text-editor-line-decoration-icon-issue","hidden"),this._issueIcon.addEventListener("click",(()=>this._issueClickHandler()));const s=this._wave.createChild("span");s.append(this._errorIcon),s.append(this._issueIcon),s.classList.add("text-editor-line-decoration-icon"),this._wave.append(s),this._decorationStartColumn=null,this._messagesDescriptionElement=document.createElement("div"),this._messagesDescriptionElement.classList.add("text-editor-messages-description-container"),this._messages=[],this._level=null}_updateWavePosition(e,t){e=Math.min(e,this.textEditor.linesCount-1);const i=this.textEditor.line(e);t=Math.min(t,i.length);const s=Xe.Utils.lineIndent(i).length,n=Math.max(t-1,s);this._decorationStartColumn!==n&&(null!==this._decorationStartColumn&&this.textEditor.removeDecoration(this._decoration,e),this.textEditor.addDecoration(this._decoration,e,n),this._decorationStartColumn=n)}_messageDescription(e){this._messagesDescriptionElement.removeChildren(),A.appendStyle(this._messagesDescriptionElement,"source_frame/messagesPopover.css",{enableLegacyPatching:!1});for(const t of this._messages.filter((t=>e.has(t.message().level()))))this._messagesDescriptionElement.append(t.element);return this._messagesDescriptionElement}detachFromEditor(){const e=this._lineHandle.resolve();if(!e)return;const t=e.lineNumber;this._level&&this.textEditor.toggleLineClass(t,Di.get(this._level),!1),null!==this._decorationStartColumn&&(this.textEditor.removeDecoration(this._decoration,t),this._decorationStartColumn=null)}uniqueMessagesCount(){return this._messages.length}_issueClickHandler(){const e=this._messages.find((e=>e.message().level()===Ne.Message.Level.Issue));e&&e.callClickHandler()}addMessage(e){for(let t=0;t<this._messages.length;++t){const i=this._messages[t];if(i.message().isEqual(e))return void i.setRepeatCount(i.repeatCount()+1)}const t=new Ni(e);this._messages.push(t),this._updateDecoration()}removeMessage(e){for(let t=0;t<this._messages.length;++t){const i=this._messages[t];if(i.message().isEqual(e))return i.setRepeatCount(i.repeatCount()-1),i.repeatCount()||this._messages.splice(t,1),void this._updateDecoration()}}_updateDecoration(){if(!this._sourceFrame.isShowing())return;if(!this._messages.length)return;const e=this._lineHandle.resolve();if(!e)return;const t=e.lineNumber;let i=Number.MAX_VALUE,s=null,n=!1,o=!1;for(let e=0;e<this._messages.length;++e){const a=this._messages[e].message(),{columnNumber:c}=this._sourceFrame.uiLocationToEditorLocation(t,a.columnNumber());i=Math.min(i,c),(!s||(r=a,Ai[s.level()]-Ai[r.level()]<0))&&(s=a),n=n||a.level()===Ne.Message.Level.Issue,o=o||a.level()!==Ne.Message.Level.Issue}var r;this._updateWavePosition(t,i),s&&(this._level&&(this.textEditor.toggleLineClass(t,Di.get(this._level),!1),this._errorIcon.classList.add("hidden"),this._issueIcon.classList.add("hidden")),this._level=s.level(),this._level&&(this.textEditor.toggleLineClass(t,Di.get(this._level),!0),o&&(this._errorIcon.data=Mi(this._level),this._errorIcon.classList.remove("hidden")),n&&this._issueIcon.classList.remove("hidden")))}_getPopoverMessages(e){let t=null;return e.classList.contains("text-editor-line-decoration-icon-error")?t=this._messageDescription(new Set([Ne.Message.Level.Error,Ne.Message.Level.Warning])):e.classList.contains("text-editor-line-decoration-icon-issue")?t=this._messageDescription(new Set([Ne.Message.Level.Issue])):e.classList.contains("text-editor-line-decoration-wave")&&!e.classList.contains("text-editor-line-decoration-icon")&&(t=this._messageDescription(new Set([Ne.Message.Level.Error,Ne.Message.Level.Warning]))),t}getPopover(e,t){const i=e.enclosingNodeOrSelfWithClass("text-editor-line-decoration-icon-error")||e.enclosingNodeOrSelfWithClass("text-editor-line-decoration-icon-issue"),s=i?i.boxInWindow():new AnchorBox(t.clientX,t.clientY,1,1),n=this._getPopoverMessages(e);return n?{box:s,hide(){},show:e=>(e.contentElement.append(n),Promise.resolve(!0))}:null}}const Ai={Issue:2,Warning:3,Error:4};const Ri={ToolbarItemsChanged:Symbol("ToolbarItemsChanged")};var ji=Object.freeze({__proto__:null,UISourceCodeFrame:Pi,RowMessage:Ni,RowMessageBucket:Ui,Events:Ri});class Vi extends u.ObjectWrapper{constructor(e,t,i,s){super(),this._delegate=e,this._tabbedPane=new K.TabbedPane,this._tabbedPane.setPlaceholderElement(i,s),this._tabbedPane.setTabDelegate(new Gi(this)),this._tabbedPane.setCloseableTabs(!0),this._tabbedPane.setAllowTabReorder(!0,!0),this._tabbedPane.addEventListener(K.Events.TabClosed,this._tabClosed,this),this._tabbedPane.addEventListener(K.Events.TabSelected,this._tabSelected,this),Ce.PersistenceImpl.instance().addEventListener(Ce.Events.BindingCreated,this._onBindingCreated,this),Ce.PersistenceImpl.instance().addEventListener(Ce.Events.BindingRemoved,this._onBindingRemoved,this),this._tabIds=new Map,this._files=new Map,this._previouslyViewedFilesSetting=t,this._history=qi.fromObject(this._previouslyViewedFilesSetting.get()),this._uriToUISourceCode=new Map,this._currentFile,this._currentView}_onBindingCreated(e){const t=e.data;this._updateFileTitle(t.fileSystem);const i=this._tabIds.get(t.network);let s=this._tabIds.get(t.fileSystem);const n=this._currentFile===t.network,o=this._history.selectionRange(t.network.url()),r=this._history.scrollLineNumber(t.network.url());if(this._history.remove(t.network.url()),i){if(!s){const e=this._tabbedPane.tabView(i),n=this._tabbedPane.tabIndex(i);if(e instanceof Pi)this._delegate.recycleUISourceCodeFrame(e,t.fileSystem),s=this._appendFileTab(t.fileSystem,!1,n,e);else{s=this._appendFileTab(t.fileSystem,!1,n);const e=this._tabbedPane.tabView(s);this._restoreEditorProperties(e,o,r)}}this._closeTabs([i],!0),n&&this._tabbedPane.selectTab(s,!1),this._updateHistory()}}_onBindingRemoved(e){const t=e.data;this._updateFileTitle(t.fileSystem)}get view(){return this._tabbedPane}get visibleView(){return this._tabbedPane.visibleView}fileViews(){return this._tabbedPane.tabViews()}leftToolbar(){return this._tabbedPane.leftToolbar()}rightToolbar(){return this._tabbedPane.rightToolbar()}show(e){this._tabbedPane.show(e)}showFile(e){this._innerShowFile(this._canonicalUISourceCode(e),!0)}closeFile(e){const t=this._tabIds.get(e);t&&this._closeTabs([t])}closeAllFiles(){this._closeTabs(this._tabbedPane.tabIds())}historyUISourceCodes(){const e=[],t=this._history._urls();for(const i of t){const t=this._uriToUISourceCode.get(i);t&&e.push(t)}return e}_addViewListeners(){this._currentView&&this._currentView instanceof Ke.SourceFrameImpl&&(this._currentView.textEditor.addEventListener(qe.Events.ScrollChanged,this._scrollChanged,this),this._currentView.textEditor.addEventListener(qe.Events.SelectionChanged,this._selectionChanged,this))}_removeViewListeners(){this._currentView&&this._currentView instanceof Ke.SourceFrameImpl&&(this._currentView.textEditor.removeEventListener(qe.Events.ScrollChanged,this._scrollChanged,this),this._currentView.textEditor.removeEventListener(qe.Events.SelectionChanged,this._selectionChanged,this))}_scrollChanged(e){this._scrollTimer&&clearTimeout(this._scrollTimer);const t=e.data;this._scrollTimer=setTimeout(function(){this._history.save(this._previouslyViewedFilesSetting)}.bind(this),100),this._currentFile&&this._history.updateScrollLineNumber(this._currentFile.url(),t)}_selectionChanged(e){const t=e.data;this._currentFile&&this._history.updateSelectionRange(this._currentFile.url(),t),this._history.save(this._previouslyViewedFilesSetting),this._currentFile&&st.ExtensionServer.instance().sourceSelectionChanged(this._currentFile.url(),t)}_innerShowFile(e,t){const i=Ce.PersistenceImpl.instance().binding(e);if(e=i?i.fileSystem:e,this._currentFile===e)return;this._removeViewListeners(),this._currentFile=e;const s=this._tabIds.get(e)||this._appendFileTab(e,t);this._tabbedPane.selectTab(s,t),t&&this._editorSelectedByUserAction();const n=this._currentView;this._currentView=this.visibleView,this._addViewListeners();const o={currentFile:this._currentFile,currentView:this._currentView,previousView:n,userGesture:t};this.dispatchEventToListeners(Oi.EditorSelected,o)}_titleForFile(e){let t=e.displayName(!0).trimMiddle(30);return e.isDirty()&&(t+="*"),t}_maybeCloseTab(t,i){const s=this._files.get(t);if(!s)return!1;return!(s.isDirty()&&s.project().canSetFileContent()&&!confirm(e.UIString("Are you sure you want to close unsaved file: %s?",s.name())))&&(s.resetWorkingCopy(),i&&this._tabbedPane.selectTab(i,!0),this._tabbedPane.closeTab(t,!0),!0)}_closeTabs(e,t){const i=[],s=[];for(let n=0;n<e.length;++n){const o=e[n],r=this._files.get(o);r&&(!t&&r.isDirty()?i.push(o):s.push(o))}i.length&&this._tabbedPane.selectTab(i[0],!0),this._tabbedPane.closeTabs(s,!0);for(let e=0;e<i.length;++e){const t=e+1<i.length?i[e+1]:null;if(!this._maybeCloseTab(i[e],t))break}}_onContextMenu(e,t){const i=this._files.get(e);i&&t.appendApplicableItems(i)}_canonicalUISourceCode(e){return this._uriToUISourceCode.has(e.url())?this._uriToUISourceCode.get(e.url()):(this._uriToUISourceCode.set(e.url(),e),e)}addUISourceCode(e){const t=this._canonicalUISourceCode(e),i=t!==e,s=Ce.PersistenceImpl.instance().binding(t);if(e=s?s.fileSystem:t,i&&e.project().type()!==De.projectTypes.FileSystem&&e.disableEdit(),this._currentFile===e)return;const n=e.url(),o=this._history.index(n);if(-1===o)return;if(this._tabIds.has(e)||this._appendFileTab(e,!1),!o)return void this._innerShowFile(e,!1);if(!this._currentFile)return;const r=nt.isSnippetsUISourceCode(this._currentFile),a=nt.isSnippetsUISourceCode(e);this._history.index(this._currentFile.url())&&r&&!a&&this._innerShowFile(e,!1)}removeUISourceCode(e){this.removeUISourceCodes([e])}removeUISourceCodes(e){const t=[];for(const i of e){const e=this._tabIds.get(i);e&&t.push(e),this._uriToUISourceCode.get(i.url())===i&&this._uriToUISourceCode.delete(i.url())}this._tabbedPane.closeTabs(t)}_editorClosedByUserAction(e){this._history.remove(e.url()),this._updateHistory()}_editorSelectedByUserAction(){this._updateHistory()}_updateHistory(){const e=this._tabbedPane.lastOpenedTabIds(Hi);this._history.update(e.map(function(e){const t=this._files.get(e);return t?t.url():""}.bind(this))),this._history.save(this._previouslyViewedFilesSetting)}_tooltipForFile(e){return(e=Ce.PersistenceImpl.instance().network(e)||e).url()}_appendFileTab(e,t,i,s){const n=s||this._delegate.viewForFile(e),o=this._titleForFile(e),r=this._tooltipForFile(e),a=this._generateTabId();if(this._tabIds.set(e,a),this._files.set(a,e),!s){const t=this._history.selectionRange(e.url()),i=this._history.scrollLineNumber(e.url());this._restoreEditorProperties(n,t,i)}return this._tabbedPane.appendTab(a,o,n,r,t,void 0,i),this._updateFileTitle(e),this._addUISourceCodeListeners(e),e.loadError()?this._addLoadErrorIcon(a):e.contentLoaded()||e.requestContent().then((t=>{e.loadError()&&this._addLoadErrorIcon(a)})),a}_addLoadErrorIcon(e){const t=F.Icon.create("smallicon-error");I.Tooltip.install(t,p`Unable to load this content.`),this._tabbedPane.tabView(e)&&this._tabbedPane.setTabIcon(e,t)}_restoreEditorProperties(e,t,i){const s=e instanceof Ke.SourceFrameImpl?e:null;s&&(t&&s.setSelection(t),"number"==typeof i&&s.scrollToLine(i))}_tabClosed(e){const t=e.data.tabId,i=e.data.isUserGesture,s=this._files.get(t);this._currentFile===s&&(this._removeViewListeners(),this._currentView=null,this._currentFile=null),this._tabIds.delete(s),this._files.delete(t),s&&(this._removeUISourceCodeListeners(s),this.dispatchEventToListeners(Oi.EditorClosed,s),i&&this._editorClosedByUserAction(s))}_tabSelected(e){const t=e.data.tabId,i=e.data.isUserGesture,s=this._files.get(t);s&&this._innerShowFile(s,i)}_addUISourceCodeListeners(e){e.addEventListener(Ne.Events.TitleChanged,this._uiSourceCodeTitleChanged,this),e.addEventListener(Ne.Events.WorkingCopyChanged,this._uiSourceCodeWorkingCopyChanged,this),e.addEventListener(Ne.Events.WorkingCopyCommitted,this._uiSourceCodeWorkingCopyCommitted,this)}_removeUISourceCodeListeners(e){e.removeEventListener(Ne.Events.TitleChanged,this._uiSourceCodeTitleChanged,this),e.removeEventListener(Ne.Events.WorkingCopyChanged,this._uiSourceCodeWorkingCopyChanged,this),e.removeEventListener(Ne.Events.WorkingCopyCommitted,this._uiSourceCodeWorkingCopyCommitted,this)}_updateFileTitle(t){const i=this._tabIds.get(t);if(i){const s=this._titleForFile(t),n=this._tooltipForFile(t);this._tabbedPane.changeTabTitle(i,s,n);let o=null;t.loadError()?(o=F.Icon.create("smallicon-error"),I.Tooltip.install(o,p`Unable to load this content.`)):Ce.PersistenceImpl.instance().hasUnsavedCommittedChanges(t)?(o=F.Icon.create("smallicon-warning"),I.Tooltip.install(o,e.UIString("Changes to this file were not saved to file system."))):o=we.PersistenceUtils.iconForUISourceCode(t),this._tabbedPane.setTabIcon(i,o)}}_uiSourceCodeTitleChanged(e){const t=e.data;this._updateFileTitle(t),this._updateHistory()}_uiSourceCodeWorkingCopyChanged(e){const t=e.data;this._updateFileTitle(t)}_uiSourceCodeWorkingCopyCommitted(e){const t=e.data.uiSourceCode;this._updateFileTitle(t)}_generateTabId(){return"tab_"+Wi++}currentFile(){return this._currentFile||null}}const Oi={EditorSelected:Symbol("EditorSelected"),EditorClosed:Symbol("EditorClosed")};let Wi=0;const Hi=30;class zi{constructor(e,t,i){this.url=e,this._isSerializable=e.length<zi.serializableUrlLengthLimit,this.selectionRange=t,this.scrollLineNumber=i}static fromObject(e){const t="selectionRange"in e?Qe.TextRange.fromObject(e.selectionRange):void 0;return new zi(e.url,t,e.scrollLineNumber)}serializeToObject(){if(!this._isSerializable)return null;const e={};return e.url=this.url,e.selectionRange=this.selectionRange,e.scrollLineNumber=this.scrollLineNumber,e}}zi.serializableUrlLengthLimit=4096;class qi{constructor(e){this._items=e,this._itemsIndex=new Map,this._rebuildItemIndex()}static fromObject(e){const t=[];for(let i=0;i<e.length;++i)"url"in e[i]&&e[i].url&&t.push(zi.fromObject(e[i]));return new qi(t)}index(e){const t=this._itemsIndex.get(e);return void 0!==t?t:-1}_rebuildItemIndex(){this._itemsIndex=new Map;for(let e=0;e<this._items.length;++e)console.assert(!this._itemsIndex.has(this._items[e].url)),this._itemsIndex.set(this._items[e].url,e)}selectionRange(e){const t=this.index(e);return-1!==t?this._items[t].selectionRange:void 0}updateSelectionRange(e,t){if(!t)return;const i=this.index(e);-1!==i&&(this._items[i].selectionRange=t)}scrollLineNumber(e){const t=this.index(e);return-1!==t?this._items[t].scrollLineNumber:void 0}updateScrollLineNumber(e,t){const i=this.index(e);-1!==i&&(this._items[i].scrollLineNumber=t)}update(e){for(let t=e.length-1;t>=0;--t){const i=this.index(e[t]);let s;-1!==i?(s=this._items[i],this._items.splice(i,1)):s=new zi(e[t]),this._items.unshift(s),this._rebuildItemIndex()}}remove(e){const t=this.index(e);-1!==t&&(this._items.splice(t,1),this._rebuildItemIndex())}save(e){e.set(this._serializeToObject())}_serializeToObject(){const e=[];for(let t=0;t<this._items.length;++t){const i=this._items[t].serializeToObject();if(i&&e.push(i),e.length===Hi)break}return e}_urls(){const e=[];for(let t=0;t<this._items.length;++t)e.push(this._items[t].url);return e}}class Gi{constructor(e){this._editorContainer=e}closeTabs(e,t){this._editorContainer._closeTabs(t)}onContextMenu(e,t){this._editorContainer._onContextMenu(e,t)}}var Ki=Object.freeze({__proto__:null,TabbedEditorContainerDelegate:class{viewForFile(e){throw new Error("Not implemented yet")}recycleUISourceCodeFrame(e,t){}},TabbedEditorContainer:Vi,Events:Oi,get tabId(){return Wi},maximalPreviouslyViewedFilesCount:Hi,HistoryItem:zi,History:qi,EditorContainerTabDelegate:Gi});class $i extends f.VBox{constructor(){super(),this.registerRequiredCSS("sources/sourcesView.css",{enableLegacyPatching:!0}),this.element.id="sources-panel-sources-view",this.setMinimumAndPreferredSizes(88,52,150,100),this._placeholderOptionArray=[],this._selectedIndex=0;const e=De.WorkspaceImpl.instance();if(this._searchableView=new $.SearchableView(this,this,"sourcesViewSearchConfig"),this._searchableView.setMinimalSearchQuerySize(0),this._searchableView.show(this.element),this._sourceViewByUISourceCode=new Map,this._editorContainer=new Vi(this,a.Settings.instance().createLocalSetting("previouslyViewedFiles",[]),this._placeholderElement(),this._focusedPlaceholderElement),this._editorContainer.show(this._searchableView.element),this._editorContainer.addEventListener(Oi.EditorSelected,this._editorSelected,this),this._editorContainer.addEventListener(Oi.EditorClosed,this._editorClosed,this),this._historyManager=new Rt(this,this.currentSourceFrame.bind(this)),this._toolbarContainerElement=this.element.createChild("div","sources-toolbar"),!re.experiments.isEnabled("sourcesPrettyPrint")){const e=new x.Toolbar("",this._toolbarContainerElement);re.Runtime.instance().allInstances(Qi).then((t=>{for(const i of t)e.appendToolbarItem(i.button(this))}))}this._scriptViewToolbar=new x.Toolbar("",this._toolbarContainerElement),this._scriptViewToolbar.element.style.flex="auto",this._bottomToolbar=new x.Toolbar("",this._toolbarContainerElement),this._toolbarChangedListener=null,v.startBatchUpdate(),e.uiSourceCodes().forEach(this._addUISourceCode.bind(this)),v.endBatchUpdate(),e.addEventListener(De.Events.UISourceCodeAdded,this._uiSourceCodeAdded,this),e.addEventListener(De.Events.UISourceCodeRemoved,this._uiSourceCodeRemoved,this),e.addEventListener(De.Events.ProjectRemoved,this._projectRemoved.bind(this),this),window.opener||window.addEventListener("beforeunload",(function(e){if(e.returnValue)return;const t=[],s=De.WorkspaceImpl.instance().projectsForType(De.projectTypes.FileSystem);for(const e of s)t.push(...e.uiSourceCodes().filter((e=>e.isDirty())));if(t.length){e.returnValue=!0,N.ViewManager.instance().showView("sources");for(const e of t)i.reveal(e)}}),!0),this._shortcuts=new Map,this.element.addEventListener("keydown",this._handleKeyDown.bind(this),!1)}_placeholderElement(){this._placeholderOptionArray=[];const e=[{actionId:"quickOpen.show",description:p`Open file`},{actionId:"commandMenu.show",description:p`Run command`},{actionId:"sources.add-folder-to-workspace",description:p`Drop in a folder to add to workspace`}],t=document.createElement("div"),i=t.createChild("div","tabbed-pane-placeholder");i.addEventListener("keydown",this._placeholderOnKeyDown.bind(this),!1),M.markAsList(i),M.setAccessibleName(i,p`Source View Actions`);for(let t=0;t<e.length;t++){const s=e[t],n=B.ShortcutRegistry.instance().shortcutTitleForAction(s.actionId),o=i.createChild("div");M.markAsListitem(o);const r=o.createChild("div","tabbed-pane-placeholder-row");r.tabIndex=-1,M.markAsButton(r),n?(r.createChild("div","tabbed-pane-placeholder-key").textContent=n,r.createChild("div","tabbed-pane-placeholder-value").textContent=s.description):r.createChild("div","tabbed-pane-no-shortcut").textContent=s.description;const a=H.ActionRegistry.instance().action(s.actionId);a&&this._placeholderOptionArray.push({element:r,handler(){a.execute()}})}const s=this._placeholderOptionArray[0].element;return s.tabIndex=0,this._focusedPlaceholderElement=s,this._selectedIndex=0,t.appendChild(J.XLink.create("https://developers.google.com/web/tools/chrome-devtools/sources?utm_source=devtools&utm_campaign=2018Q1","Learn more about Workspaces")),t}_placeholderOnKeyDown(e){const t=e;if(isEnterOrSpaceKey(t))return void this._placeholderOptionArray[this._selectedIndex].handler();let i=0;"ArrowDown"===t.key?i=1:"ArrowUp"===t.key&&(i=-1);const s=Math.max(Math.min(this._placeholderOptionArray.length-1,this._selectedIndex+i),0),n=this._placeholderOptionArray[s].element,o=this._placeholderOptionArray[this._selectedIndex].element;n!==o&&(o.tabIndex=-1,n.tabIndex=0,M.setSelected(o,!1),M.setSelected(n,!0),this._selectedIndex=s,n.focus())}static defaultUISourceCodeScores(){const e=new Map,t=P.Context.instance().flavor($i);if(t){const i=t._editorContainer.historyUISourceCodes();for(let t=1;t<i.length;++t)e.set(i[t],i.length-t)}return e}leftToolbar(){return this._editorContainer.leftToolbar()}rightToolbar(){return this._editorContainer.rightToolbar()}bottomToolbar(){return this._bottomToolbar}_registerShortcuts(e,t){for(let i=0;i<e.length;++i)this._shortcuts.set(e[i].key,t)}_handleKeyDown(e){const t=Q.KeyboardShortcut.makeKeyFromEvent(e),i=this._shortcuts.get(t);i&&i()&&e.consume(!0)}wasShown(){super.wasShown(),P.Context.instance().setFlavor($i,this)}willHide(){P.Context.instance().setFlavor($i,null),super.willHide()}toolbarContainerElement(){return this._toolbarContainerElement}searchableView(){return this._searchableView}visibleView(){return this._editorContainer.visibleView}currentSourceFrame(){const e=this.visibleView();return e instanceof Pi?e:null}currentUISourceCode(){return this._editorContainer.currentFile()}_onCloseEditorTab(){const e=this._editorContainer.currentFile();return!!e&&(this._editorContainer.closeFile(e),!0)}_onJumpToPreviousLocation(){this._historyManager.rollback()}_onJumpToNextLocation(){this._historyManager.rollover()}_uiSourceCodeAdded(e){const t=e.data;this._addUISourceCode(t)}_addUISourceCode(e){e.project().isServiceProject()||e.project().type()===De.projectTypes.FileSystem&&"overrides"===fe.FileSystemWorkspaceBinding.fileSystemType(e.project())||this._editorContainer.addUISourceCode(e)}_uiSourceCodeRemoved(e){const t=e.data;this._removeUISourceCodes([t])}_removeUISourceCodes(e){this._editorContainer.removeUISourceCodes(e);for(let t=0;t<e.length;++t)this._removeSourceFrame(e[t]),this._historyManager.removeHistoryForSourceCode(e[t])}_projectRemoved(e){const t=e.data.uiSourceCodes();this._removeUISourceCodes(t)}_updateScriptViewToolbarItems(){const e=this.visibleView();e instanceof L.SimpleView&&e.toolbarItems().then((e=>{this._scriptViewToolbar.removeToolbarItems(),e.map((e=>this._scriptViewToolbar.appendToolbarItem(e)))}))}showSourceLocation(e,t,i,s,n){this._historyManager.updateCurrentState(),this._editorContainer.showFile(e);const o=this.currentSourceFrame();o&&"number"==typeof t&&o.revealPosition(t,i,!n),this._historyManager.pushNewState();const r=this.visibleView();!s&&r&&r.focus()}_createSourceView(e){let t,i;const s=e.contentType();s===h.resourceTypes.Image?i=new $e.ImageView(e.mimeType(),e):s===h.resourceTypes.Font?i=new Je.FontView(e.mimeType(),e):t=new Pi(e),t&&this._historyManager.trackSourceFrameCursorJumps(t);const n=t||i;return this._sourceViewByUISourceCode.set(e,n),n}_getOrCreateSourceView(e){return this._sourceViewByUISourceCode.get(e)||this._createSourceView(e)}recycleUISourceCodeFrame(e,t){this._sourceViewByUISourceCode.delete(e.uiSourceCode()),e.setUISourceCode(t),this._sourceViewByUISourceCode.set(t,e)}viewForFile(e){return this._getOrCreateSourceView(e)}_removeSourceFrame(e){const t=this._sourceViewByUISourceCode.get(e);this._sourceViewByUISourceCode.delete(e),t&&t instanceof Pi&&t.dispose()}_editorClosed(e){const t=e.data;this._historyManager.removeHistoryForSourceCode(t);let i=!1;this._editorContainer.currentFile()||(i=!0),this._removeToolbarChangedListener(),this._updateScriptViewToolbarItems(),this._searchableView.resetSearch();const s={};s.uiSourceCode=t,s.wasSelected=i,this.dispatchEventToListeners(Ji.EditorClosed,s)}_editorSelected(e){const t=e.data.previousView instanceof Pi?e.data.previousView:null;t&&t.setSearchableView(null);const i=e.data.currentView instanceof Pi?e.data.currentView:null;i&&i.setSearchableView(this._searchableView),this._searchableView.setReplaceable(Boolean(i)&&i.canEditSource()),this._searchableView.refreshSearch(),this._updateToolbarChangedListener(),this._updateScriptViewToolbarItems(),this.dispatchEventToListeners(Ji.EditorSelected,this._editorContainer.currentFile())}_removeToolbarChangedListener(){this._toolbarChangedListener&&d.EventTarget.removeEventListeners([this._toolbarChangedListener]),this._toolbarChangedListener=null}_updateToolbarChangedListener(){this._removeToolbarChangedListener();const e=this.currentSourceFrame();e&&(this._toolbarChangedListener=e.addEventListener(Ri.ToolbarItemsChanged,this._updateScriptViewToolbarItems,this))}searchCanceled(){this._searchView&&this._searchView.searchCanceled(),delete this._searchView,delete this._searchConfig}performSearch(e,t,i){const s=this.currentSourceFrame();s&&(this._searchView=s,this._searchConfig=e,this._searchView.performSearch(this._searchConfig,t,i))}jumpToNextSearchResult(){this._searchView&&(this._searchConfig&&this._searchView!==this.currentSourceFrame()?this.performSearch(this._searchConfig,!0):this._searchView.jumpToNextSearchResult())}jumpToPreviousSearchResult(){if(this._searchView)return this._searchConfig&&this._searchView!==this.currentSourceFrame()?(this.performSearch(this._searchConfig,!0),void(this._searchView&&this._searchView.jumpToLastSearchResult())):void this._searchView.jumpToPreviousSearchResult()}supportsCaseSensitiveSearch(){return!0}supportsRegexSearch(){return!0}replaceSelectionWith(e,t){const i=this.currentSourceFrame();i?i.replaceSelectionWith(e,t):console.assert(Boolean(i))}replaceAllWith(e,t){const i=this.currentSourceFrame();i?i.replaceAllWith(e,t):console.assert(Boolean(i))}_showOutlineQuickOpen(){tt.QuickOpenImpl.show("@")}_showGoToLineQuickOpen(){this._editorContainer.currentFile()&&tt.QuickOpenImpl.show(":")}_save(){this._saveSourceFrame(this.currentSourceFrame())}_saveAll(){this._editorContainer.fileViews().forEach(this._saveSourceFrame.bind(this))}_saveSourceFrame(e){if(!(e instanceof Pi))return;e.commitEditing()}toggleBreakpointsActiveState(e){this._editorContainer.view.element.classList.toggle("breakpoints-deactivated",!e)}}const Ji={EditorClosed:Symbol("EditorClosed"),EditorSelected:Symbol("EditorSelected")};class Qi{button(e){throw new Error("Not implemented yet")}}class Xi{static _nextFile(e){function t(e){const t=e.lastIndexOf(".");return e.substr(0,-1!==t?t:e.length).toLowerCase()}const i=e.project().uiSourceCodes(),s=[],n=e.parentURL(),o=e.name(),r=t(o);for(let e=0;e<i.length;++e){const o=i[e];n===o.parentURL()&&(t(o.name())===r&&s.push(o.name()))}s.sort(String.naturalOrderComparator);const a=S.mod(s.indexOf(o)+1,s.length),c=(n?n+"/":"")+s[a],l=e.project().uiSourceCodeForURL(c);return l!==e?l:null}handleAction(e,t){const i=P.Context.instance().flavor($i);if(!i)return!1;const s=i.currentUISourceCode();if(!s)return!1;const n=Xi._nextFile(s);return!!n&&(i.showSourceLocation(n),!0)}}var Yi=Object.freeze({__proto__:null,SourcesView:$i,Events:Ji,EditorAction:Qi,SwitchFileActionDelegate:Xi,ActionDelegate:class{handleAction(e,t){const i=P.Context.instance().flavor($i);if(!i)return!1;switch(t){case"sources.close-all":return i._editorContainer.closeAllFiles(),!0;case"sources.jump-to-previous-location":return i._onJumpToPreviousLocation(),!0;case"sources.jump-to-next-location":return i._onJumpToNextLocation(),!0;case"sources.close-editor-tab":return i._onCloseEditorTab();case"sources.go-to-line":return i._showGoToLineQuickOpen(),!0;case"sources.go-to-member":return i._showOutlineQuickOpen(),!0;case"sources.save":return i._save(),!0;case"sources.save-all":return i._saveAll(),!0}return!1}}});class Zi{constructor(){this._pathsToFormatOnLoad=new Set,this._sourcesView,this._button}_editorSelected(e){const t=e.data;this._updateButton(t),this._isFormatableScript(t)&&this._pathsToFormatOnLoad.has(t.url())&&!Ae.SourceFormatter.instance().hasFormatted(t)&&this._showFormatted(t)}async _editorClosed(e){const t=e.data.uiSourceCode;e.data.wasSelected&&this._updateButton(null);const i=await Ae.SourceFormatter.instance().discardFormattedUISourceCode(t);i&&this._pathsToFormatOnLoad.delete(i.url())}_updateButton(t){const i=this._isFormatableScript(t);this._button.element.classList.toggle("hidden",!i),t&&this._button.setTitle(e.UIString("Pretty print "+t.name()))}button(t){return this._button||(this._sourcesView=t,this._sourcesView.addEventListener(Ji.EditorSelected,(e=>{this._editorSelected(e)})),this._sourcesView.addEventListener(Ji.EditorClosed,(e=>{this._editorClosed(e)})),this._button=new x.ToolbarButton(e.UIString("Pretty print"),"largeicon-pretty-print"),this._button.addEventListener(x.ToolbarButton.Events.Click,this._onFormatScriptButtonClicked,this),this._updateButton(t.currentUISourceCode())),this._button}_isFormatableScript(e){return!!e&&(!e.project().canSetFileContent()&&(e.project().type()!==De.projectTypes.Formatter&&(!Ce.PersistenceImpl.instance().binding(e)&&("application/wasm"!==e.mimeType()&&e.contentType().hasScripts()))))}isCurrentUISourceCodeFormatable(){const e=this._sourcesView.currentUISourceCode();return this._isFormatableScript(e)}_onFormatScriptButtonClicked(e){this.toggleFormatScriptSource()}toggleFormatScriptSource(){const e=this._sourcesView.currentUISourceCode();e&&this._isFormatableScript(e)&&(this._pathsToFormatOnLoad.add(e.url()),this._showFormatted(e))}async _showFormatted(e){const t=await Ae.SourceFormatter.instance().format(e);if(e!==this._sourcesView.currentUISourceCode())return;const i=this._sourcesView.viewForFile(e);let s=[0,0];if(i instanceof Ke.SourceFrameImpl){const e=i.selection();s=t.mapping.originalToFormatted(e.startLine,e.startColumn)}this._sourcesView.showSourceLocation(t.formattedSourceCode,s[0],s[1])}}var es=Object.freeze({__proto__:null,ScriptFormatterEditorAction:Zi});const ts=new WeakMap,is=new WeakMap;class ss{constructor(e,t,i){this.name=e,this.lineNumber=t,this.columnNumber=i}}const ns=async function(e){if(e.type()===Protocol.Debugger.ScopeType.Global)return[];const t=e.startLocation(),i=e.endLocation();if(!t||!i)return[];const s=t.script();if(!s||!s.sourceMapURL||s!==i.script())return[];const{content:n}=await s.requestContent();if(!n)return[];const o=new Ye.Text(n),r=new Qe.TextRange(t.lineNumber,t.columnNumber,i.lineNumber,i.columnNumber),a=o.extract(r),c=o.toSourceRange(r).offset,l="function fui",d=await Re.formatterWorkerPool().javaScriptIdentifiers(l+a),h=[],u=new Ze.TextCursor(o.lineEndings());for(const e of d){if(e.offset<l.length)continue;const t=c+e.offset-l.length;u.resetTo(t),h.push(new ss(e.name,u.lineNumber(),u.columnNumber()))}return h},os=async function(e){if(!e)return null;const{pluginManager:t}=le.DebuggerWorkspaceBinding.instance();if(t){const i=await t.resolveScopeChain(e);if(i)return i}return e.scopeChain()},rs=async e=>{let t=ts.get(e);return t||(t=(async()=>{const t=new Map,s=e.callFrame().script,n=le.DebuggerWorkspaceBinding.instance().sourceMapForScript(s);if(n){const o=new Map,r=[];for(const a of await ns(e)){const e=n.findEntry(a.lineNumber,a.columnNumber);e&&e.name?t.set(a.name,e.name):r.push(i(s,n,a,o).then((e=>{e&&t.set(a.name,e)})))}await Promise.all(r).then(ps())}return t})(),ts.set(e,t)),await t;async function i(e,t,i,s){const n=t.findEntry(i.lineNumber,i.columnNumber),o=t.findEntry(i.lineNumber,i.columnNumber+i.name.length);if(!(n&&o&&n.sourceURL&&n.sourceURL===o.sourceURL&&n.sourceLineNumber&&n.sourceColumnNumber&&o.sourceLineNumber&&o.sourceColumnNumber))return null;const r=new Qe.TextRange(n.sourceLineNumber,n.sourceColumnNumber,o.sourceLineNumber,o.sourceColumnNumber),a=le.DebuggerWorkspaceBinding.instance().uiSourceCodeForSourceMapSourceURL(e.debuggerModel,n.sourceURL,e.isContentScript());if(!a)return null;const{content:c}=await a.requestContent();if(!c)return null;let l=s.get(c);l||(l=new Ye.Text(c),s.set(c,l));const d=l.extract(r).trim();return/[a-zA-Z0-9_$]+/.test(d)?d:null}},as=async e=>{const t=is.get(e);if(t)return t;const i=e.scopeChain(),s=await Promise.all(i.map(rs)),n=new Map;for(const e of s)for(const[t,i]of e)i&&!n.has(i)&&n.set(i,t);return is.set(e,n),n},cs=async(e,t,i,s,n,o)=>{if("application/wasm"===i.mimeType())return`memories["${t}"] ?? locals["${t}"] ?? tables["${t}"] ?? functions["${t}"] ?? globals["${t}"]`;if(!i.contentType().isFromSourceMap())return"";const r=await as(e);if(r.has(t))return r.get(t);const a=(await le.DebuggerWorkspaceBinding.instance().uiLocationToRawLocations(i,s,n)).find((t=>t.debuggerModel===e.debuggerModel));if(!a)return"";const c=a.script();if(!c)return"";const l=le.DebuggerWorkspaceBinding.instance().sourceMapForScript(c);if(!l)return"";const{content:d}=await c.requestContent();if(!d)return"";const h=new Ye.Text(d),u=l.reverseMapTextRange(i.url(),new Qe.TextRange(s,n,s,o));if(!u)return"";const p=h.extract(u);return p?await Re.formatterWorkerPool().evaluatableJavaScriptSubstring(p):""},ls=async e=>{if(!e)return null;const t=e.scopeChain();if(0===t.length)return e.thisObject();const i=await rs(t[0]),s=C.inverse(i).get("this");if(!s||1!==s.size)return e.thisObject();const[n]=s.values(),o=await e.evaluate({expression:n,objectGroup:"backtrace",includeCommandLineAPI:!1,silent:!0,returnByValue:!1,generatePreview:!0});return"exceptionDetails"in o?!o.exceptionDetails&&o.object?o.object:e.thisObject():null},ds=function(e){const t=e.startLocation(),i=e.endLocation(),s=t?t.script():null;return e.type()!==Protocol.Debugger.ScopeType.Global&&s&&i&&s.sourceMapURL&&s===i.script()?new hs(e):e.object()};class hs extends Pe.RemoteObject{constructor(e){super(),this._scope=e,this._object=e.object()}customPreview(){return this._object.customPreview()}get objectId(){return this._object.objectId}get type(){return this._object.type}get subtype(){return this._object.subtype}get value(){return this._object.value}get description(){return this._object.description}get hasChildren(){return this._object.hasChildren}get preview(){return this._object.preview}arrayLength(){return this._object.arrayLength()}getOwnProperties(e){return this._object.getOwnProperties(e)}async getAllProperties(e,t){const i=await this._object.getAllProperties(e,t),s=await rs(this._scope),n=i.properties,o=i.internalProperties,r=[];if(n)for(let e=0;e<n.length;++e){const t=n[e],i=s.get(t.name)||n[e].name;t.value&&r.push(new Pe.RemoteObjectProperty(i,t.value,t.enumerable,t.writable,t.isOwn,t.wasThrown,t.symbol,t.synthetic))}return{properties:r,internalProperties:o}}async setPropertyValue(e,t){const i=await rs(this._scope);let s;s="string"==typeof e?e:e.value;let n=s;for(const e of i.keys())if(i.get(e)===s){n=e;break}return this._object.setPropertyValue(n,t)}async deleteProperty(e){return this._object.deleteProperty(e)}callFunction(e,t){return this._object.callFunction(e,t)}callFunctionJSON(e,t){return this._object.callFunctionJSON(e,t)}release(){this._object.release()}debuggerModel(){return this._object.debuggerModel()}runtimeModel(){return this._object.runtimeModel()}isNode(){return this._object.isNode()}}let us=function(){};const ps=()=>us;var _s=Object.freeze({__proto__:null,Identifier:ss,scopeIdentifiers:ns,resolveScopeChain:os,resolveScope:rs,allVariablesInCallFrame:as,resolveExpression:cs,resolveThisObject:ls,resolveScopeInObject:ds,RemoteObject:hs,getScopeResolvedForTest:ps,setScopeResolvedForTest:e=>{us=e}});HTMLDivElement;class ms extends It{constructor(e,t,i){super(),this._textEditor=e,this._uiSourceCode=t,this._transformer=i,this._executionLocation=null,this._controlDown=!1,this._asyncStepInHoveredLine=0,this._asyncStepInHovered=!1,this._clearValueWidgetsTimer=null,this._sourceMapInfobar=null,this._controlTimeout=null,this._scriptsPanel=yi.instance(),this._breakpointManager=pe.BreakpointManager.instance(),t.project().type()===De.projectTypes.Debugger&&this._textEditor.element.classList.add("source-frame-debugger-script"),this._popoverHelper=new G.PopoverHelper(this._scriptsPanel.element,this._getPopoverRequest.bind(this)),this._popoverHelper.setDisableOnClick(!0),this._popoverHelper.setTimeout(250,250),this._popoverHelper.setHasPadding(!0),this._boundPopoverHelperHide=this._popoverHelper.hidePopover.bind(this._popoverHelper),this._scriptsPanel.element.addEventListener("scroll",this._boundPopoverHelperHide,!0);const s={"debugger.toggle-breakpoint":async()=>{const e=this._textEditor.selection();return!!e&&(await this._toggleBreakpoint(e.startLine,!1),!0)},"debugger.toggle-breakpoint-enabled":async()=>{const e=this._textEditor.selection();return!!e&&(await this._toggleBreakpoint(e.startLine,!0),!0)},"debugger.breakpoint-input-window":async()=>{const e=this._textEditor.selection();if(!e)return!1;const t=this._lineBreakpointDecorations(e.startLine).map((e=>e.breakpoint)).filter((e=>Boolean(e)));let i=null;t.length&&(i=t[0]);const s=!!i&&i.condition().includes(mt);return this._editBreakpointCondition(e.startLine,i,null,s),!0}};B.ShortcutRegistry.instance().addShortcutListener(this._textEditor.element,s),this._boundKeyDown=this._onKeyDown.bind(this),this._textEditor.element.addEventListener("keydown",this._boundKeyDown,!0),this._boundKeyUp=this._onKeyUp.bind(this),this._textEditor.element.addEventListener("keyup",this._boundKeyUp,!0),this._boundMouseMove=this._onMouseMove.bind(this),this._textEditor.element.addEventListener("mousemove",this._boundMouseMove,!1),this._boundMouseDown=this._onMouseDown.bind(this),this._textEditor.element.addEventListener("mousedown",this._boundMouseDown,!0),this._boundBlur=this._onBlur.bind(this),this._textEditor.element.addEventListener("focusout",this._boundBlur,!1),this._boundWheel=this._onWheel.bind(this),this._textEditor.element.addEventListener("wheel",this._boundWheel,!0),this._boundGutterClick=e=>{this._handleGutterClick(e)},this._textEditor.addEventListener(qe.Events.GutterClick,this._boundGutterClick,this),this._breakpointManager.addEventListener(pe.Events.BreakpointAdded,this._breakpointAdded,this),this._breakpointManager.addEventListener(pe.Events.BreakpointRemoved,this._breakpointRemoved,this),this._uiSourceCode.addEventListener(Ne.Events.WorkingCopyChanged,this._workingCopyChanged,this),this._uiSourceCode.addEventListener(Ne.Events.WorkingCopyCommitted,this._workingCopyCommitted,this),this._breakpointDecorations=new Set,this._decorationByBreakpoint=new Map,this._possibleBreakpointsRequested=new Set,this._scriptFileForDebuggerModel=new Map,a.Settings.instance().moduleSetting("skipStackFramesPattern").addChangeListener(this._showIgnoreListInfobarIfNeeded,this),a.Settings.instance().moduleSetting("skipContentScripts").addChangeListener(this._showIgnoreListInfobarIfNeeded,this),this._valueWidgets=new Map,this._continueToLocationDecorations=null,P.Context.instance().addFlavorChangeListener(xe.CallFrame,this._callFrameChanged,this),this._liveLocationPool=new ae.LiveLocationPool,this._callFrameChanged(),this._updateScriptFiles(),this._uiSourceCode.isDirty()?(this._muted=!0,this._mutedFromStart=!0):(this._muted=!1,this._mutedFromStart=!1,this._initializeBreakpoints()),this._ignoreListInfobar=null,this._showIgnoreListInfobarIfNeeded();for(const e of this._scriptFileForDebuggerModel.values())e.checkMapping();this._hasLineWithoutMapping=!1,this._updateLinesWithoutMappingHighlight(),re.experiments.isEnabled("sourcesPrettyPrint")||(this._prettyPrintInfobar=null,this._detectMinified())}static accepts(e){return e.contentType().hasScripts()}_showIgnoreListInfobarIfNeeded(){const t=this._uiSourceCode;if(!t.contentType().hasScripts())return;const i=t.project().type();if(!ce.IgnoreListManager.instance().isIgnoreListedUISourceCode(t))return void this._hideIgnoreListInfobar();this._ignoreListInfobar&&this._ignoreListInfobar.dispose();const s=new X.Infobar(X.Type.Warning,e.UIString("This script is on the debugger's ignore list"),[{text:p`Remove from ignore list`,highlight:!1,delegate:function(){ce.IgnoreListManager.instance().unIgnoreListUISourceCode(t),i===De.projectTypes.ContentScripts&&ce.IgnoreListManager.instance().unIgnoreListContentScripts()},dismiss:!0},{text:p`Configure`,highlight:!1,delegate:N.ViewManager.instance().showView.bind(N.ViewManager.instance(),"blackbox"),dismiss:!1}]);this._ignoreListInfobar=s,s.createDetailsRowMessage(e.UIString("The debugger will skip stepping through this script, and will not stop on exceptions."));const n=this._scriptFileForDebuggerModel.size?this._scriptFileForDebuggerModel.values().next().value:null;n&&n.hasSourceMapURL()&&s.createDetailsRowMessage(e.UIString("Source map found, but ignored for file on ignore list.")),this._textEditor.attachInfobar(this._ignoreListInfobar)}_hideIgnoreListInfobar(){this._ignoreListInfobar&&(this._ignoreListInfobar.dispose(),this._ignoreListInfobar=null)}wasShown(){this._executionLocation&&queueMicrotask((()=>{this._generateValuesInSource()}))}willHide(){this._popoverHelper.hidePopover()}async populateLineGutterContextMenu(t,i){const s=new Ne.UILocation(this._uiSourceCode,i,0);this._scriptsPanel.appendUILocationItems(t,s);const n=this._lineBreakpointDecorations(i).map((e=>e.breakpoint)).filter((e=>Boolean(e))),o=le.DebuggerWorkspaceBinding.instance().scriptsForUISourceCode(this._uiSourceCode).every((e=>e.isJavaScript()));if(n.length){const s=1===n.length,r=s?e.UIString("Remove breakpoint"):e.UIString("Remove all breakpoints in line");t.debugSection().appendItem(r,(()=>n.map((e=>e.remove(!1))))),s&&o&&t.debugSection().appendItem(e.UIString("Edit breakpoint…"),this._editBreakpointCondition.bind(this,i,n[0],null,!1));if(n.some((e=>e.enabled()))){const i=s?e.UIString("Disable breakpoint"):e.UIString("Disable all breakpoints in line");t.debugSection().appendItem(i,(()=>n.map((e=>e.setEnabled(!1)))))}if(n.some((e=>!e.enabled()))){const i=s?e.UIString("Enable breakpoint"):e.UIString("Enable all breakpoints in line");t.debugSection().appendItem(i,(()=>n.map((e=>e.setEnabled(!0)))))}}else this._textEditor.hasLineClass(i,"cm-non-breakable-line")||(t.debugSection().appendItem(e.UIString("Add breakpoint"),this._createNewBreakpoint.bind(this,i,"",!0)),o&&(t.debugSection().appendItem(e.UIString("Add conditional breakpoint…"),this._editBreakpointCondition.bind(this,i,null,null,!1)),t.debugSection().appendItem(p`Add logpoint…`,this._editBreakpointCondition.bind(this,i,null,null,!0)),t.debugSection().appendItem(e.UIString("Never pause here"),this._createNewBreakpoint.bind(this,i,"false",!0))))}populateTextAreaContextMenu(t,i,s){function n(e){new ut(o.bind(null,e)).show()}function o(e,t){t&&e.addSourceMapURL(t)}return super.populateTextAreaContextMenu(t,i,s).then(function(){if(this._uiSourceCode.project().type()===De.projectTypes.Network&&a.Settings.instance().moduleSetting("jsSourceMapsEnabled").get()&&!ce.IgnoreListManager.instance().isIgnoreListedUISourceCode(this._uiSourceCode)&&this._scriptFileForDebuggerModel.size){const i=this._scriptFileForDebuggerModel.values().next().value,s=e.UIString("Add source map…");t.debugSection().appendItem(s,n.bind(null,i))}}.bind(this))}_workingCopyChanged(){this._scriptFileForDebuggerModel.size||(this._uiSourceCode.isDirty()?this._muteBreakpointsWhileEditing():this._restoreBreakpointsAfterEditing())}_workingCopyCommitted(e){this._scriptsPanel.updateLastModificationTime(),this._scriptFileForDebuggerModel.size||this._restoreBreakpointsAfterEditing()}_didMergeToVM(){this._restoreBreakpointsIfConsistentScripts()}_didDivergeFromVM(){this._muteBreakpointsWhileEditing()}_muteBreakpointsWhileEditing(){if(!this._muted){for(const e of this._breakpointDecorations)this._updateBreakpointDecoration(e);this._muted=!0}}async _restoreBreakpointsIfConsistentScripts(){for(const e of this._scriptFileForDebuggerModel.values())if(e.hasDivergedFromVM()||e.isMergingToVM())return;await this._restoreBreakpointsAfterEditing()}async _restoreBreakpointsAfterEditing(){if(this._muted=!1,this._mutedFromStart)return this._mutedFromStart=!1,void this._initializeBreakpoints();const e=Array.from(this._breakpointDecorations);this._breakpointDecorations.clear(),this._textEditor.operation((()=>e.map((e=>e.hide()))));for(const t of e){if(!t.breakpoint)continue;const e=t.enabled;t.breakpoint.remove(!1);const i=t.handle.resolve();i&&await this._setBreakpoint(i.lineNumber,i.columnNumber,t.condition,e)}}_isIdentifier(e){return e.startsWith("js-variable")||e.startsWith("js-property")||"js-def"===e||"variable"===e}_getPopoverRequest(e){if(Q.KeyboardShortcut.eventHasCtrlOrMeta(e))return null;const t=P.Context.instance().flavor(ye.Target),i=t?t.model(xe.DebuggerModel):null;if(!i||!i.isPaused())return null;const s=this._textEditor.coordinatesToCursorPosition(e.x,e.y);if(!s)return null;const n=s.startLine,o=s.startColumn,r=this._textEditor.selection().normalize();let a,c=-1,l=-1,d=-1;const h=P.Context.instance().flavor(xe.CallFrame);if(!h)return null;if(r&&!r.isEmpty()){if(r.startLine!==r.endLine||r.startLine!==n||o<r.startColumn||o>r.endColumn)return null;const e=this._textEditor.cursorPositionToCoordinates(r.startLine,r.startColumn),t=this._textEditor.cursorPositionToCoordinates(r.endLine,r.endColumn);if(!e)throw new Error("Expected leftCorner to not be null.");if(!t)throw new Error("Expected rightCorner to not be null.");a=new AnchorBox(e.x,e.y,t.x-e.x,e.height),c=r.startLine,l=r.startColumn,d=r.endColumn-1}else if("application/wasm"===this._uiSourceCode.mimeType()){const e=this._textEditor.tokenAtTextPosition(s.startLine,s.startColumn);if(!e||"variable-2"!==e.type)return null;const t=this._textEditor.cursorPositionToCoordinates(s.startLine,e.startColumn),i=this._textEditor.cursorPositionToCoordinates(s.startLine,e.endColumn-1);if(!t)throw new Error("Expected leftCorner to not be null.");if(!i)throw new Error("Expected rightCorner to not be null.");a=new AnchorBox(t.x,t.y,i.x-t.x,t.height),c=s.startLine,l=e.startColumn,d=e.endColumn-1}else{const e=this._textEditor.tokenAtTextPosition(s.startLine,s.startColumn);if(!e||!e.type)return null;c=s.startLine;const t=this._textEditor.line(c),i=t.substring(e.startColumn,e.endColumn);if(!this._isIdentifier(e.type)&&("js-keyword"!==e.type||"this"!==i))return null;const n=this._textEditor.cursorPositionToCoordinates(c,e.startColumn),o=this._textEditor.cursorPositionToCoordinates(c,e.endColumn-1);if(!n)throw new Error("Expected leftCorner to not be null.");if(!o)throw new Error("Expected rightCorner to not be null.");for(a=new AnchorBox(n.x,n.y,o.x-n.x,n.height),l=e.startColumn,d=e.endColumn-1;l>1&&"."===t.charAt(l-1);){const e=this._textEditor.tokenAtTextPosition(c,l-2);if(!e||!e.type)return null;if("js-meta"===e.type)break;if("js-string-2"===e.type){if(e.endColumn<2)return null;if(l=t.lastIndexOf("`",e.endColumn-2),l<0)return null;break}l=e.startColumn}}let u,p;return{box:a,show:async e=>{const t=this._textEditor.line(c).substring(l,d+1),s=await async function(e,t){const i=await cs(h,t,e,c,l,d);return await h.evaluate({expression:i||t,objectGroup:"popover",includeCommandLineAPI:!1,silent:!0,returnByValue:!1,generatePreview:!1,throwOnSideEffect:void 0,timeout:void 0,disableBreaks:void 0,replMode:void 0,allowUnsafeEvalBlockedByCSP:void 0})}(this._uiSourceCode,t);if(!s||"error"in s||!s.object||"object"===s.object.type&&"error"===s.object.subtype)return!1;u=await se.ObjectPopoverHelper.buildObjectPopover(s.object,e);const n=P.Context.instance().flavor(xe.CallFrame);if(!u||h!==n)return i.runtimeModel().releaseObjectGroup("popover"),u&&u.dispose(),!1;const o=new Qe.TextRange(c,l,c,d);return p=this._textEditor.highlightRange(o,"source-frame-eval-expression"),!0},hide:()=>{u&&u.dispose(),i.runtimeModel().releaseObjectGroup("popover"),p&&this._textEditor.removeHighlight(p)}}}_onWheel(e){this._executionLocation&&Q.KeyboardShortcut.eventHasCtrlOrMeta(e)&&e.preventDefault()}_onKeyDown(e){(!e.ctrlKey||!e.metaKey&&ge.isMac())&&this._clearControlDown(),"Escape"!==e.key?Q.KeyboardShortcut.eventHasCtrlOrMeta(e)&&this._executionLocation&&(this._controlDown=!0,e.key===(ge.isMac()?"Meta":"Control")&&(this._controlTimeout=window.setTimeout((()=>{this._executionLocation&&this._controlDown&&this._showContinueToLocations()}),150))):this._popoverHelper.isPopoverVisible()&&(this._popoverHelper.hidePopover(),e.consume())}_onMouseMove(e){if(this._executionLocation&&this._controlDown&&Q.KeyboardShortcut.eventHasCtrlOrMeta(e)&&(this._continueToLocationDecorations||this._showContinueToLocations()),this._continueToLocationDecorations){const t=e.target,i=this._textEditor.coordinatesToCursorPosition(e.x,e.y),s=Boolean(t.enclosingNodeOrSelfWithClass("source-frame-async-step-in"));this._setAsyncStepInHoveredLine(i?i.startLine:null,s)}}_setAsyncStepInHoveredLine(e,t){this._asyncStepInHoveredLine===e&&this._asyncStepInHovered===t||(this._asyncStepInHovered&&this._asyncStepInHoveredLine&&this._textEditor.toggleLineClass(this._asyncStepInHoveredLine,"source-frame-async-step-in-hovered",!1),this._asyncStepInHoveredLine=e,this._asyncStepInHovered=t,this._asyncStepInHovered&&this._asyncStepInHoveredLine&&this._textEditor.toggleLineClass(this._asyncStepInHoveredLine,"source-frame-async-step-in-hovered",!0))}_onMouseDown(e){if(!this._executionLocation||!Q.KeyboardShortcut.eventHasCtrlOrMeta(e))return;if(!this._continueToLocationDecorations)return;e.consume();const t=this._textEditor.coordinatesToCursorPosition(e.x,e.y);if(t)for(const e of this._continueToLocationDecorations.keys()){const i=e.find();if(i.from.line===t.startLine&&i.to.line===t.startLine&&(i.from.ch<=t.startColumn&&t.startColumn<=i.to.ch)){const t=this._continueToLocationDecorations.get(e);if(!t)throw new Error("Expected a function");t();break}}}_onBlur(e){this._clearControlDown()}_onKeyUp(e){this._clearControlDown()}_clearControlDown(){this._controlDown=!1,this._clearContinueToLocations(),this._controlTimeout&&clearTimeout(this._controlTimeout)}async _editBreakpointCondition(e,t,i,s){const n=t?t.condition():"",o=document.createElement("div"),r=new _t(e,n,Boolean(s),(async s=>{r.detach(),this._textEditor.removeDecoration(o,e),s.committed&&(t?t.setCondition(s.condition):i?await this._setBreakpoint(i.lineNumber,i.columnNumber,s.condition,!0):await this._createNewBreakpoint(e,s.condition,!0))}));this._textEditor.addDecoration(o,e),r.markAsExternallyManaged(),r.show(o)}async _executionLineChanged(e){this._clearExecutionLine();const t=await e.uiLocation();if(!t||t.uiSourceCode.url()!==this._uiSourceCode.url())return void(this._executionLocation=null);this._executionLocation=t;const i=this._transformer.uiLocationToEditorLocation(t.lineNumber,t.columnNumber);this._textEditor.setExecutionLocation(i.lineNumber,i.columnNumber),this._textEditor.isShowing()&&queueMicrotask((()=>{this._controlDown?this._showContinueToLocations():this._generateValuesInSource()}))}_generateValuesInSource(){if(!a.Settings.instance().moduleSetting("inlineVariableValues").get())return;if(!P.Context.instance().flavor(ke.ExecutionContext))return;const e=P.Context.instance().flavor(xe.CallFrame);if(!e)return;const t=e.localScope(),i=e.functionLocation();t&&i&&ds(t).getAllProperties(!1,!1).then(this._prepareScopeVariables.bind(this,e))}_showContinueToLocations(){this._popoverHelper.hidePopover();if(!P.Context.instance().flavor(ke.ExecutionContext))return;const e=P.Context.instance().flavor(xe.CallFrame);if(!e)return;const t=e.functionLocation()||e.location();function i(e){this._clearContinueToLocationsNoRestore(),this._textEditor.hideExecutionLineBackground(),this._continueToLocationDecorations=new Map,e=e.reverse();let t=-1;for(const i of e){const e=this._transformer.uiLocationToEditorLocation(i.lineNumber,i.columnNumber),s=this._textEditor.tokenAtTextPosition(e.lineNumber,e.columnNumber);if(!s)continue;let n=s;const o=this._textEditor.line(e.lineNumber);let r=o.substring(n.startColumn,n.endColumn);if(!n.type&&"."===r){const t=this._textEditor.tokenAtTextPosition(e.lineNumber,n.endColumn+1);if(!t)throw new Error("nextToken should not be null.");n=t,r=o.substring(n.startColumn,n.endColumn)}if(!n.type)continue;if(!("js-keyword"===n.type&&("this"===r||"return"===r||"new"===r||"continue"===r||"break"===r))&&!this._isIdentifier(n.type))continue;if(t===e.lineNumber&&i.type!==Protocol.Debugger.BreakLocationType.Call)continue;let a=new Qe.TextRange(e.lineNumber,n.startColumn,e.lineNumber,n.endColumn-1),c=this._textEditor.highlightRange(a,"source-frame-continue-to-location");this._continueToLocationDecorations.set(c,i.continueToLocation.bind(i)),i.type===Protocol.Debugger.BreakLocationType.Call&&(t=e.lineNumber);let l="."===o[n.startColumn-1]&&"then"===r||"setTimeout"===r||"setInterval"===r||"postMessage"===r;if("new"===r){const t=this._textEditor.tokenAtTextPosition(e.lineNumber,n.endColumn+1);if(!t)throw new Error("nextToken should not be null.");n=t,r=o.substring(n.startColumn,n.endColumn),l="Worker"===r}const d=this._executionLocation&&i.lineNumber===this._executionLocation.lineNumber&&i.columnNumber===this._executionLocation.columnNumber;if(i.type===Protocol.Debugger.BreakLocationType.Call&&l){const t=this._findAsyncStepInRange(this._textEditor,e.lineNumber,o,n.endColumn);t&&(a=new Qe.TextRange(e.lineNumber,t.from,e.lineNumber,t.to-1),c=this._textEditor.highlightRange(a,"source-frame-async-step-in"),this._continueToLocationDecorations.set(c,this._asyncStepIn.bind(this,i,Boolean(d))))}}this._continueToLocationRenderedForTest()}e.debuggerModel.getPossibleBreakpoints(t,null,!0).then((e=>this._textEditor.operation(i.bind(this,e))))}_continueToLocationRenderedForTest(){}_findAsyncStepInRange(e,t,i,s){let n,o=null,r=s,a=i.length,c=i.indexOf("(",s);const l=c;if(-1===c)return null;if(c++,u(),c>=i.length)return null;if(o=h(),!o)return null;if(r=o.startColumn,"js-keyword"===o.type&&"async"===n){if(u(),c>=i.length)return{from:r,to:a};if(o=h(),!o)return{from:r,to:a}}if("js-keyword"===o.type&&"function"===n)return{from:r,to:a};if("js-string"===o.type)return{from:l,to:a};if(o.type&&this._isIdentifier(o.type))return{from:r,to:a};if("("!==n)return null;const d=i.indexOf(")",c);return-1===d||-1!==i.substring(c,d).indexOf("(")?{from:r,to:a}:{from:r,to:d+1};function h(){return o=e.tokenAtTextPosition(t,c),o&&(c=o.endColumn,a=o.endColumn,n=i.substring(o.startColumn,o.endColumn)),o}function u(){for(;c<i.length;){if(" "===i[c]){c++;continue}const s=e.tokenAtTextPosition(t,c);if(!s)throw new Error("expected token to not be null");if("js-comment"!==s.type)break;c=s.endColumn}}}_asyncStepIn(e,t){function i(){e.debuggerModel.scheduleStepIntoAsync()}t?i():e.continueToLocation(i)}async _prepareScopeVariables(e,t){const i=t.properties;if(this._clearValueWidgets(),!i||!i.length||i.length>500||!this._textEditor.isShowing())return;const s=le.DebuggerWorkspaceBinding.instance().rawLocationToUILocation(e.functionLocation()),n=le.DebuggerWorkspaceBinding.instance().rawLocationToUILocation(e.location()),[o,r]=await Promise.all([s,n]);if(!o||!r||o.uiSourceCode.url()!==this._uiSourceCode.url()||r.uiSourceCode.url()!==this._uiSourceCode.url())return;const a=this._transformer.uiLocationToEditorLocation(o.lineNumber,o.columnNumber),c=this._transformer.uiLocationToEditorLocation(r.lineNumber,r.columnNumber),l=a.lineNumber,d=a.columnNumber,h=c.lineNumber;if(l>=h||h-l>500||l<0||h>=this._textEditor.linesCount)return;const u=new Map;for(const e of i)u.set(e.name,e.value);const p=new Map;let _=!1;const m=(new et.TokenizerFactory).createTokenizer("text/javascript");m(this._textEditor.line(l).substring(d),g.bind(this,l));for(let e=l+1;e<h;++e)m(this._textEditor.line(e),g.bind(this,e));function g(e,t,i,s,n){if(!_&&i&&this._isIdentifier(i)&&u.get(t)){let i=p.get(e);i||(i=new Set,p.set(e,i)),i.add(t)}_="."===t}this._textEditor.operation(this._renderDecorations.bind(this,u,p,l,h))}_renderDecorations(e,t,i,s){const n=new ne.RemoteObjectPreviewFormatter;for(let o=i;o<s;++o){const i=t.get(o),s=this._valueWidgets.get(o);if(!i){s&&(this._valueWidgets.delete(o),this._textEditor.removeDecoration(s,o));continue}const r=document.createElement("div");r.classList.add("text-editor-value-decoration");const a=this._textEditor.cursorPositionToCoordinates(o,0);if(!a)throw new Error("base is expected to not be null");const c=this._textEditor.cursorPositionToCoordinates(o,this._textEditor.line(o).length);if(!c)throw new Error("offset is expected to not be null");const l=4,d=c.x-a.x+l;r.style.left=d+"px",r.__nameToToken=new Map;let h=0;for(const s of i){if(h>10)break;const i=t.get(o-1);if(i&&i.has(s))continue;h&&v.createTextChild(r,", ");const a=r.createChild("span");r.__nameToToken.set(s,a),v.createTextChild(a,s+" = ");const c=e.get(s);if(!c)throw new Error("value is expected to be null");const l=c.preview?c.preview.properties.length:0,d=c.preview&&c.preview.entries?c.preview.entries.length:0;if(c.preview&&l+d<10)n.appendObjectPreview(a,c.preview,!1);else{const e=oe.ObjectPropertiesSection.createPropertyValue(c,!1,!1);a.appendChild(e.element)}++h}let u=!0;if(s){u=!1;for(const e of r.__nameToToken.keys()){const t=s.__nameToToken.get(e),i=r.__nameToToken.get(e),n=t?t.textContent:"";(i?i.textContent:"")!==n&&(u=!0,v.runCSSAnimationOnce(r.__nameToToken.get(e),"source-frame-value-update-highlight"))}u&&(this._valueWidgets.delete(o),this._textEditor.removeDecoration(s,o))}u&&(this._valueWidgets.set(o,r),this._textEditor.addDecoration(r,o))}}_clearExecutionLine(){this._textEditor.operation((()=>{this._executionLocation&&this._textEditor.clearExecutionLine(),this._executionLocation=null,this._clearValueWidgetsTimer&&(clearTimeout(this._clearValueWidgetsTimer),this._clearValueWidgetsTimer=null),this._clearValueWidgetsTimer=window.setTimeout(this._clearValueWidgets.bind(this),1e3),this._clearContinueToLocationsNoRestore()}))}_clearValueWidgets(){this._clearValueWidgetsTimer&&clearTimeout(this._clearValueWidgetsTimer),this._clearValueWidgetsTimer=null,this._textEditor.operation((()=>{for(const e of this._valueWidgets.keys()){const t=this._valueWidgets.get(e);t&&this._textEditor.removeDecoration(t,e)}this._valueWidgets.clear()}))}_clearContinueToLocationsNoRestore(){const e=this._continueToLocationDecorations;e&&this._textEditor.operation((()=>{for(const t of e.keys())this._textEditor.removeHighlight(t);this._continueToLocationDecorations=null,this._setAsyncStepInHoveredLine(null,!1)}))}_clearContinueToLocations(){this._continueToLocationDecorations&&this._textEditor.operation((()=>{this._textEditor.showExecutionLineBackground(),this._generateValuesInSource(),this._clearContinueToLocationsNoRestore()}))}_lineBreakpointDecorations(e){return Array.from(this._breakpointDecorations).filter((t=>(t.handle.resolve()||{}).lineNumber===e))}_breakpointDecoration(e,t){for(const i of this._breakpointDecorations){const s=i.handle.resolve();if(s&&(s.lineNumber===e&&s.columnNumber===t))return i}return null}_updateBreakpointDecoration(e){function t(){if(!this._scheduledBreakpointDecorationUpdates)return;const e=new Set;for(const t of this._scheduledBreakpointDecorationUpdates){const i=t.handle.resolve();i&&e.add(i.lineNumber)}this._scheduledBreakpointDecorationUpdates=null;let t=!1;for(const n of e){const e=this._lineBreakpointDecorations(n);i.call(this,n,e),this._possibleBreakpointsRequested.has(n)?t=!0:s.call(this,n,e)}t||this._breakpointDecorationsUpdatedForTest()}function i(e,t){if(this._textEditor.toggleLineClass(e,"cm-breakpoint",!1),this._textEditor.toggleLineClass(e,"cm-breakpoint-disabled",!1),this._textEditor.toggleLineClass(e,"cm-breakpoint-unbound",!1),this._textEditor.toggleLineClass(e,"cm-breakpoint-conditional",!1),this._textEditor.toggleLineClass(e,"cm-breakpoint-logpoint",!1),t.length){t.sort(gs.mostSpecificFirst);const i=!t[0].enabled||this._muted,s=t[0].condition.includes(mt),n=!t[0].bound,o=Boolean(t[0].condition)&&!s;this._textEditor.toggleLineClass(e,"cm-breakpoint",!0),this._textEditor.toggleLineClass(e,"cm-breakpoint-disabled",i),this._textEditor.toggleLineClass(e,"cm-breakpoint-unbound",n&&!i),this._textEditor.toggleLineClass(e,"cm-breakpoint-logpoint",s),this._textEditor.toggleLineClass(e,"cm-breakpoint-conditional",o)}}function s(e,t){const i=new Set(t.map((e=>e.bookmark)).filter((e=>Boolean(e)))),s=this._textEditor.line(e).length,n=this._textEditor.bookmarks(new Qe.TextRange(e,0,e,s),gs.bookmarkSymbol);for(const e of n)i.has(e)||e.clear();if(t.length)if(t.length>1)for(const e of t)e.update(),this._muted?e.hide():e.show();else t[0].update(),t[0].hide()}this._scheduledBreakpointDecorationUpdates||(this._scheduledBreakpointDecorationUpdates=new Set,queueMicrotask((()=>{this._textEditor.operation(t.bind(this))}))),this._scheduledBreakpointDecorationUpdates.add(e)}_breakpointDecorationsUpdatedForTest(){}async _inlineBreakpointClick(e,t){if(t.consume(!0),e.breakpoint)t.shiftKey?e.breakpoint.setEnabled(!e.breakpoint.enabled()):e.breakpoint.remove(!1);else{const t=e.handle.resolve();if(!t)return;const i=this._transformer.editorLocationToUILocation(t.lineNumber,t.columnNumber);await this._setBreakpoint(i.lineNumber,i.columnNumber,e.condition,!0)}}_inlineBreakpointContextMenu(t,i){i.consume(!0);const s=t.handle.resolve();if(!s)return;if(this._textEditor.hasLineClass(s.lineNumber,"cm-non-breakable-line"))return;if(!le.DebuggerWorkspaceBinding.instance().scriptsForUISourceCode(this._uiSourceCode).every((e=>e.isJavaScript())))return;const n=this._transformer.editorLocationToUILocation(s.lineNumber,s.columnNumber),o=new D.ContextMenu(i);t.breakpoint?o.debugSection().appendItem(e.UIString("Edit breakpoint…"),this._editBreakpointCondition.bind(this,s.lineNumber,t.breakpoint,null,!1)):(o.debugSection().appendItem(e.UIString("Add conditional breakpoint…"),this._editBreakpointCondition.bind(this,s.lineNumber,null,s,!1)),o.debugSection().appendItem(p`Add logpoint…`,this._editBreakpointCondition.bind(this,s.lineNumber,null,s,!0)),o.debugSection().appendItem(e.UIString("Never pause here"),this._setBreakpoint.bind(this,n.lineNumber,n.columnNumber,"false",!0))),o.show()}_shouldIgnoreExternalBreakpointEvents(e){if(e.data.uiLocation.uiSourceCode!==this._uiSourceCode)return!0;if(this._muted)return!0;for(const e of this._scriptFileForDebuggerModel.values())if(e.isDivergingFromVM()||e.isMergingToVM())return!0;return!1}_breakpointAdded(e){if(this._shouldIgnoreExternalBreakpointEvents(e))return;const t=e.data.uiLocation,i=e.data.breakpoint;this._addBreakpoint(t,i)}_addBreakpoint(e,t){const i=this._transformer.uiLocationToEditorLocation(e.lineNumber,e.columnNumber),s=this._lineBreakpointDecorations(e.lineNumber);let n=this._breakpointDecoration(i.lineNumber,i.columnNumber);if(n)n.breakpoint=t,n.condition=t.condition(),n.enabled=t.enabled();else{const e=this._textEditor.textEditorPositionHandle(i.lineNumber,i.columnNumber);n=new gs(this._textEditor,e,t.condition(),t.enabled(),t.bound()||!t.hasBoundScript(),t),n.element.addEventListener("click",this._inlineBreakpointClick.bind(this,n),!0),n.element.addEventListener("contextmenu",this._inlineBreakpointContextMenu.bind(this,n),!0),this._breakpointDecorations.add(n)}if(this._decorationByBreakpoint.set(t,n),this._updateBreakpointDecoration(n),t.enabled()&&!s.length){this._possibleBreakpointsRequested.add(i.lineNumber);const e=this._transformer.editorLocationToUILocation(i.lineNumber,0),t=this._transformer.editorLocationToUILocation(i.lineNumber+1,0);this._breakpointManager.possibleBreakpoints(this._uiSourceCode,new Qe.TextRange(e.lineNumber,e.columnNumber||0,t.lineNumber,t.columnNumber||0)).then(function(e,t){this._possibleBreakpointsRequested.delete(e);const i=this._lineBreakpointDecorations(e);for(const e of i)this._updateBreakpointDecoration(e);if(!i.some((e=>Boolean(e.breakpoint))))return;const s=new Set;for(const e of i){const t=e.handle.resolve();t&&s.add(t.columnNumber)}for(const i of t.slice(0,100)){const t=this._transformer.uiLocationToEditorLocation(i.lineNumber,i.columnNumber);if(t.lineNumber!==e)continue;if(s.has(t.columnNumber))continue;const n=this._textEditor.textEditorPositionHandle(t.lineNumber,t.columnNumber),o=new gs(this._textEditor,n,"",!1,!1,null);o.element.addEventListener("click",this._inlineBreakpointClick.bind(this,o),!0),o.element.addEventListener("contextmenu",this._inlineBreakpointContextMenu.bind(this,o),!0),this._breakpointDecorations.add(o),this._updateBreakpointDecoration(o)}}.bind(this,i.lineNumber))}}_breakpointRemoved(e){if(this._shouldIgnoreExternalBreakpointEvents(e))return;const t=e.data.uiLocation,i=e.data.breakpoint,s=this._decorationByBreakpoint.get(i);if(!s)return;this._decorationByBreakpoint.delete(i);const n=this._transformer.uiLocationToEditorLocation(t.lineNumber,t.columnNumber);s.breakpoint=null,s.enabled=!1;const o=this._lineBreakpointDecorations(n.lineNumber);if(o.some((e=>Boolean(e.breakpoint))))this._updateBreakpointDecoration(s);else for(const e of o)this._breakpointDecorations.delete(e),this._updateBreakpointDecoration(e)}_initializeBreakpoints(){const e=this._breakpointManager.breakpointLocationsForUISourceCode(this._uiSourceCode);for(const t of e)this._addBreakpoint(t.uiLocation,t.breakpoint)}_updateLinesWithoutMappingHighlight(){if(Boolean(de.CompilerScriptMapping.uiSourceCodeOrigin(this._uiSourceCode))){const e=this._textEditor.linesCount;for(let t=0;t<e;++t){const e=de.CompilerScriptMapping.uiLineHasMapping(this._uiSourceCode,t);e||(this._hasLineWithoutMapping=!0),this._hasLineWithoutMapping&&this._textEditor.toggleLineClass(t,"cm-non-breakable-line",!e)}return}const{pluginManager:e}=le.DebuggerWorkspaceBinding.instance();e&&e.getMappedLines(this._uiSourceCode).then((e=>{if(void 0===e)return;const t=this._textEditor.linesCount;for(let i=0;i<t;++i){const t=e.has(i);t||(this._hasLineWithoutMapping=!0),this._hasLineWithoutMapping&&this._textEditor.toggleLineClass(i,"cm-non-breakable-line",!t)}})).catch(console.error)}_updateScriptFiles(){for(const e of ye.TargetManager.instance().models(xe.DebuggerModel)){le.DebuggerWorkspaceBinding.instance().scriptFile(this._uiSourceCode,e)&&this._updateScriptFile(e)}}_updateScriptFile(e){const t=this._scriptFileForDebuggerModel.get(e),i=le.DebuggerWorkspaceBinding.instance().scriptFile(this._uiSourceCode,e);this._scriptFileForDebuggerModel.delete(e),t&&(t.removeEventListener(_e.ResourceScriptFile.Events.DidMergeToVM,this._didMergeToVM,this),t.removeEventListener(_e.ResourceScriptFile.Events.DidDivergeFromVM,this._didDivergeFromVM,this),this._muted&&!this._uiSourceCode.isDirty()&&this._restoreBreakpointsIfConsistentScripts()),i&&(this._scriptFileForDebuggerModel.set(e,i),i.addEventListener(_e.ResourceScriptFile.Events.DidMergeToVM,this._didMergeToVM,this),i.addEventListener(_e.ResourceScriptFile.Events.DidDivergeFromVM,this._didDivergeFromVM,this),i.checkMapping(),i.hasSourceMapURL()&&this._showSourceMapInfobar())}_showSourceMapInfobar(){this._sourceMapInfobar||(this._sourceMapInfobar=X.Infobar.create(X.Type.Info,e.UIString("Source Map detected."),[],a.Settings.instance().createSetting("sourceMapInfobarDisabled",!1)),this._sourceMapInfobar&&(this._sourceMapInfobar.createDetailsRowMessage(e.UIString("Associated files should be added to the file tree. You can debug these resolved source files as regular JavaScript files.")),this._sourceMapInfobar.createDetailsRowMessage(e.UIString("Associated files are available via file tree or %s.",B.ShortcutRegistry.instance().shortcutTitleForAction("quickOpen.show"))),this._sourceMapInfobar.setCloseCallback((()=>{this._sourceMapInfobar=null})),this._textEditor.attachInfobar(this._sourceMapInfobar)))}async _detectMinified(){const t=this._uiSourceCode.content();if(!t||!Xe.isMinified(t))return;const i=await re.Runtime.instance().allInstances(Qi);let s=null;for(const e of i)if(e instanceof Zi){if(!e.isCurrentUISourceCodeFormatable())return;s=e.toggleFormatScriptSource.bind(e);break}if(this._prettyPrintInfobar=X.Infobar.create(X.Type.Info,e.UIString("Pretty-print this minified file?"),[{text:p`Pretty-print`,delegate:s,highlight:!0,dismiss:!0}],a.Settings.instance().createSetting("prettyPrintInfobarDisabled",!1)),!this._prettyPrintInfobar)return;this._prettyPrintInfobar.setCloseCallback((()=>{this._prettyPrintInfobar=null}));const n=new x.Toolbar(""),o=new x.ToolbarButton("","largeicon-pretty-print");n.appendToolbarItem(o),n.element.style.display="inline-block",n.element.style.verticalAlign="middle",n.element.style.marginBottom="3px",n.element.style.pointerEvents="none",n.element.tabIndex=-1;this._prettyPrintInfobar.createDetailsRowMessage().appendChild(v.formatLocalized("Pretty-printing will format this file in a new tab where you can continue debugging. You can also pretty-print this file by clicking the %s button on the bottom status bar.",[n.element])),this._textEditor.attachInfobar(this._prettyPrintInfobar)}async _handleGutterClick(e){if(this._muted)return;const t=e.data;if(t.gutterType!==qe.lineNumbersGutterType)return;const i=t.lineNumber,s=t.event;0!==s.button||s.altKey||s.ctrlKey||s.metaKey||(await this._toggleBreakpoint(i,s.shiftKey),s.consume(!0))}async _toggleBreakpoint(e,t){const i=this._lineBreakpointDecorations(e);if(!i.length)return void await this._createNewBreakpoint(e,"",!0);const s=this._textEditor.hasLineClass(e,"cm-breakpoint-disabled"),n=i.map((e=>e.breakpoint)).filter((e=>Boolean(e)));for(const e of n)t?e.setEnabled(s):e.remove(!1)}async _createNewBreakpoint(e,t,i){if(this._textEditor.hasLineClass(e,"cm-non-breakable-line"))return;be.actionTaken(Se.Action.ScriptsBreakpointSet);const s=this._transformer.editorLocationToUILocation(e);await this._setBreakpoint(s.lineNumber,s.columnNumber,t,i)}async _setBreakpoint(e,t,i,s){a.Settings.instance().moduleSetting("breakpointsActive").set(!0),await this._breakpointManager.setBreakpoint(this._uiSourceCode,e,t,i,s),this._breakpointWasSetForTest(e,t,i,s)}_breakpointWasSetForTest(e,t,i,s){}async _callFrameChanged(){this._liveLocationPool.disposeAll();const e=P.Context.instance().flavor(xe.CallFrame);e?await le.DebuggerWorkspaceBinding.instance().createCallFrameLiveLocation(e.location(),this._executionLineChanged.bind(this),this._liveLocationPool):this._clearExecutionLine()}dispose(){for(const e of this._breakpointDecorations)e.dispose();if(this._breakpointDecorations.clear(),this._scheduledBreakpointDecorationUpdates){for(const e of this._scheduledBreakpointDecorationUpdates)e.dispose();this._scheduledBreakpointDecorationUpdates.clear()}this._hideIgnoreListInfobar(),this._sourceMapInfobar&&this._sourceMapInfobar.dispose(),this._prettyPrintInfobar&&this._prettyPrintInfobar.dispose(),this._scriptsPanel.element.removeEventListener("scroll",this._boundPopoverHelperHide,!0);for(const e of this._scriptFileForDebuggerModel.values())e.removeEventListener(_e.ResourceScriptFile.Events.DidMergeToVM,this._didMergeToVM,this),e.removeEventListener(_e.ResourceScriptFile.Events.DidDivergeFromVM,this._didDivergeFromVM,this);this._scriptFileForDebuggerModel.clear(),this._textEditor.element.removeEventListener("keydown",this._boundKeyDown,!0),this._textEditor.element.removeEventListener("keyup",this._boundKeyUp,!0),this._textEditor.element.removeEventListener("mousemove",this._boundMouseMove,!1),this._textEditor.element.removeEventListener("mousedown",this._boundMouseDown,!0),this._textEditor.element.removeEventListener("focusout",this._boundBlur,!1),this._textEditor.element.removeEventListener("wheel",this._boundWheel,!0),this._textEditor.removeEventListener(qe.Events.GutterClick,this._boundGutterClick,this),this._popoverHelper.hidePopover(),this._popoverHelper.dispose(),this._breakpointManager.removeEventListener(pe.Events.BreakpointAdded,this._breakpointAdded,this),this._breakpointManager.removeEventListener(pe.Events.BreakpointRemoved,this._breakpointRemoved,this),this._uiSourceCode.removeEventListener(Ne.Events.WorkingCopyChanged,this._workingCopyChanged,this),this._uiSourceCode.removeEventListener(Ne.Events.WorkingCopyCommitted,this._workingCopyCommitted,this),a.Settings.instance().moduleSetting("skipStackFramesPattern").removeChangeListener(this._showIgnoreListInfobarIfNeeded,this),a.Settings.instance().moduleSetting("skipContentScripts").removeChangeListener(this._showIgnoreListInfobarIfNeeded,this),super.dispose(),this._clearExecutionLine(),P.Context.instance().removeFlavorChangeListener(xe.CallFrame,this._callFrameChanged,this),this._liveLocationPool.disposeAll()}}class gs{constructor(e,t,i,s,n,o){this._textEditor=e,this.handle=t,this.condition=i,this.enabled=s,this.bound=n,this.breakpoint=o,this.element=document.createElement("span"),this.element.classList.toggle("cm-inline-breakpoint",!0),this.bookmark=null}static mostSpecificFirst(e,t){return e.enabled!==t.enabled?e.enabled?-1:1:e.bound!==t.bound?e.bound?-1:1:Boolean(e.condition)!==Boolean(t.condition)?Boolean(e.condition)?-1:1:0}update(){const e=Boolean(this.condition)&&this.condition.includes(mt),t=Boolean(this.condition)&&!e;this.element.classList.toggle("cm-inline-logpoint",e),this.element.classList.toggle("cm-inline-breakpoint-conditional",t),this.element.classList.toggle("cm-inline-disabled",!this.enabled)}show(){if(this.bookmark)return;const e=this.handle.resolve();e&&(this.bookmark=this._textEditor.addBookmark(e.lineNumber,e.columnNumber,this.element,gs.bookmarkSymbol),this.bookmark[gs._elementSymbolForTest]=this.element)}hide(){this.bookmark&&(this.bookmark.clear(),this.bookmark=null)}dispose(){const e=this.handle.resolve();e&&(this._textEditor.toggleLineClass(e.lineNumber,"cm-breakpoint",!1),this._textEditor.toggleLineClass(e.lineNumber,"cm-breakpoint-disabled",!1),this._textEditor.toggleLineClass(e.lineNumber,"cm-breakpoint-unbound",!1),this._textEditor.toggleLineClass(e.lineNumber,"cm-breakpoint-conditional",!1),this._textEditor.toggleLineClass(e.lineNumber,"cm-breakpoint-logpoint",!1)),this.hide()}}gs.bookmarkSymbol=Symbol("bookmark"),gs._elementSymbolForTest=Symbol("element");const bs=Symbol("bookmark");var Ss=Object.freeze({__proto__:null,DebuggerPlugin:ms,BreakpointDecoration:gs,continueToLocationDecorationSymbol:bs});class Cs{constructor(e){this._query=e,this._queryUpperCase=e.toUpperCase(),this._score=new Int32Array(2e3),this._sequence=new Int32Array(2e3),this._dataUpperCase="",this._fileNameIndex=0}score(e,t){if(!e||!this._query)return 0;const i=this._query.length,s=e.length;(!this._score||this._score.length<i*s)&&(this._score=new Int32Array(i*s*2),this._sequence=new Int32Array(i*s*2));const n=this._score,o=this._sequence;this._dataUpperCase=e.toUpperCase(),this._fileNameIndex=e.lastIndexOf("/");for(let t=0;t<i;++t)for(let i=0;i<s;++i){const r=0===i?0:n[t*s+i-1],a=0===t||0===i?0:n[(t-1)*s+i-1],c=0===t||0===i?0:o[(t-1)*s+i-1],l=this._match(this._query,e,t,i,c);l&&a+l>=r?(o[t*s+i]=c+1,n[t*s+i]=a+l):(o[t*s+i]=0,n[t*s+i]=r)}t&&this._restoreMatchIndexes(o,i,s,t);return 256*n[i*s-1]+(256-e.length)}_testWordStart(e,t){if(0===t)return!0;const i=e.charAt(t-1);return"_"===i||"-"===i||"/"===i||"."===i||" "===i||e[t-1]!==this._dataUpperCase[t-1]&&e[t]===this._dataUpperCase[t]}_restoreMatchIndexes(e,t,i,s){let n=t-1,o=i-1;for(;n>=0&&o>=0;)switch(e[n*i+o]){case 0:--o;break;default:s.push(o),--n,--o}s.reverse()}_singleCharScore(e,t,i,s){const n=this._testWordStart(t,s),o=s>this._fileNameIndex;let r=10;return(0===s||"/"===t[s-1])&&(r+=4),n&&(r+=2),e[i]===t[s]&&e[i]===this._queryUpperCase[i]&&(r+=6),o&&(r+=4),s===this._fileNameIndex+1&&0===i&&(r+=5),o&&n&&(r+=3),r}_sequenceCharScore(e,t,i,s,n){let o=10;return s>this._fileNameIndex&&(o+=4),(0===s||"/"===t[s-1])&&(o+=5),o+=4*n,o}_match(e,t,i,s,n){return this._queryUpperCase[i]!==this._dataUpperCase[s]?0:n?this._sequenceCharScore(e,t,i,s-n,n):this._singleCharScore(e,t,i,s)}}var fs=Object.freeze({__proto__:null,FilePathScoreFunction:Cs});class vs extends it.Provider{constructor(){super(),this._queryLineNumberAndColumnNumber="",this._defaultScores=null,this._scorer=new Cs(""),this._uiSourceCodes=[],this._uiSourceCodeUrls=new Set,this._query}_projectRemoved(e){const t=e.data;this._populate(t),this.refresh()}_populate(e){this._uiSourceCodes=[],this._uiSourceCodeUrls.clear();for(const t of De.WorkspaceImpl.instance().projects())if(t!==e&&this.filterProject(t))for(const e of t.uiSourceCodes())this._filterUISourceCode(e)&&(this._uiSourceCodes.push(e),this._uiSourceCodeUrls.add(e.url()))}_filterUISourceCode(e){if(this._uiSourceCodeUrls.has(e.url()))return!1;const t=Ce.PersistenceImpl.instance().binding(e);return!t||t.fileSystem===e}uiSourceCodeSelected(e,t,i){}filterProject(e){return!0}itemCount(){return this._uiSourceCodes.length}itemKeyAt(e){return this._uiSourceCodes[e].url()}setDefaultScores(e){this._defaultScores=e}itemScoreAt(e,t){const i=this._uiSourceCodes[e],s=this._defaultScores&&this._defaultScores.get(i)||0;if(!t||t.length<2)return s;this._query!==t&&(this._query=t,this._scorer=new Cs(t));let n=10;i.project().type()!==De.projectTypes.FileSystem||Ce.PersistenceImpl.instance().binding(i)||(n=5);const o=i.fullDisplayName();return s+n*this._scorer.score(o,null)}renderItem(e,t,i,s){t=this.rewriteQuery(t);const n=this._uiSourceCodes[e],o=n.fullDisplayName(),r=[];new Cs(t).score(o,r);const a=o.lastIndexOf("/");i.classList.add("monospace"),s.classList.add("monospace"),i.textContent=n.displayName()+(this._queryLineNumberAndColumnNumber||""),this._renderSubtitleElement(s,o),I.Tooltip.install(s,o);const c=[];for(let e=0;e<r.length;++e)c.push({offset:r[e],length:1});if(r[0]>a){for(let e=0;e<c.length;++e)c[e].offset-=a+1;v.highlightRangesWithStyleClass(i,c,"highlight")}else v.highlightRangesWithStyleClass(s,c,"highlight")}_renderSubtitleElement(e,t){e.removeChildren();let i=t.lastIndexOf("/");t.length>55&&(i=t.length-55);e.createChild("div","first-part").textContent=t.substring(0,i);e.createChild("div","second-part").textContent=t.substring(i),I.Tooltip.install(e,t)}selectItem(e,t){const i=t.trim().match(/^([^:]*)(:\d+)?(:\d+)?$/);if(!i)return;let s,n;i[2]&&(s=parseInt(i[2].substr(1),10)-1),i[3]&&(n=parseInt(i[3].substr(1),10)-1);const o=null!==e?this._uiSourceCodes[e]:null;this.uiSourceCodeSelected(o,s,n)}rewriteQuery(e){if(!(e=e?e.trim():"")||":"===e)return"";const t=e.match(/^([^:]+)((?::[^:]*){0,2})$/);return this._queryLineNumberAndColumnNumber=t?t[2]:"",t?t[1]:e}_uiSourceCodeAdded(e){const t=e.data;this._filterUISourceCode(t)&&this.filterProject(t.project())&&(this._uiSourceCodes.push(t),this._uiSourceCodeUrls.add(t.url()),this.refresh())}notFoundText(){return e.UIString("No files found")}attach(){De.WorkspaceImpl.instance().addEventListener(De.Events.UISourceCodeAdded,this._uiSourceCodeAdded,this),De.WorkspaceImpl.instance().addEventListener(De.Events.ProjectRemoved,this._projectRemoved,this),this._populate()}detach(){De.WorkspaceImpl.instance().removeEventListener(De.Events.UISourceCodeAdded,this._uiSourceCodeAdded,this),De.WorkspaceImpl.instance().removeEventListener(De.Events.ProjectRemoved,this._projectRemoved,this),this._queryLineNumberAndColumnNumber="",this._defaultScores=null}}var ws=Object.freeze({__proto__:null,FilteredUISourceCodeListProvider:vs});class Es extends it.Provider{selectItem(e,t){const s=this._currentUISourceCode();if(!s)return;const n=this._parsePosition(t);n&&i.reveal(s.uiLocation(n.line-1,n.column-1))}notFoundText(t){if(!this._currentUISourceCode())return e.UIString("No file selected.");const i=this._parsePosition(t),s=this._currentSourceFrame();if(!i){if(!s)return p`Type a number to go to that line.`;const e=s.wasmDisassembly,t=s.textEditor.currentLineNumber();if(e){const i=e.lineNumberToBytecodeOffset(e.lineNumbers-1),s=i.toString(16).length,n=e.lineNumberToBytecodeOffset(t);return p`Current position: 0x${n.toString(16).padStart(s,"0")}. Type an offset between 0x${"0".padStart(s,"0")} and 0x${i.toString(16)} to navigate to.`}const i=s.textEditor.linesCount;return p`Current line: ${t}. Type a line number between 1 and ${i} to navigate to.`}return s&&s.wasmDisassembly?p`Go to offset 0x${(i.column-1).toString(16)}.`:i.column&&i.column>1?p`Go to line ${i.line} and column ${i.column}.`:p`Go to line ${i.line}.`}_parsePosition(e){const t=this._currentSourceFrame();if(t&&t.wasmDisassembly){const t=e.match(/0x([0-9a-fA-F]+)/);if(!t||!t[0]||t[0].length!==e.length)return null;return{line:0,column:parseInt(t[0],16)+1}}const i=e.match(/([0-9]+)(\:[0-9]*)?/);if(!i||!i[0]||i[0].length!==e.length)return null;const s=parseInt(i[1],10);let n=0;return i[2]&&(n=parseInt(i[2].substring(1),10)),{line:Math.max(0|s,1),column:Math.max(0|n,1)}}_currentUISourceCode(){const e=P.Context.instance().flavor($i);return e?e.currentUISourceCode():null}_currentSourceFrame(){const e=P.Context.instance().flavor($i);return e?e.currentSourceFrame():null}}var xs=Object.freeze({__proto__:null,GoToLineQuickOpen:Es});var ys=Object.freeze({__proto__:null,InplaceFormatterEditorAction:class{constructor(){this._button,this._sourcesView}_editorSelected(e){const t=e.data;this._updateButton(t)}_editorClosed(e){e.data.wasSelected&&this._updateButton(null)}_updateButton(t){const i=this._isFormattable(t);this._button.element.classList.toggle("hidden",!i),t&&i&&this._button.setTitle(e.UIString("Format "+t.name()))}button(t){return this._button||(this._sourcesView=t,this._sourcesView.addEventListener(Ji.EditorSelected,this._editorSelected.bind(this)),this._sourcesView.addEventListener(Ji.EditorClosed,this._editorClosed.bind(this)),this._button=new x.ToolbarButton(e.UIString("Format"),"largeicon-pretty-print"),this._button.addEventListener(x.ToolbarButton.Events.Click,this._formatSourceInPlace,this),this._updateButton(t.currentUISourceCode())),this._button}_isFormattable(e){return!!e&&(!!e.project().canSetFileContent()||(!!Ce.PersistenceImpl.instance().binding(e)||e.contentType().isStyleSheet()))}_formatSourceInPlace(e){const t=this._sourcesView.currentUISourceCode();t&&this._isFormattable(t)&&(t.isDirty()?this._contentLoaded(t,t.workingCopy()):t.requestContent().then((e=>{this._contentLoaded(t,e.content||"")})))}_contentLoaded(e,t){const i=e.mimeType();je.FormatterInterface.format(e.contentType(),i,t,(async(t,i)=>{this._formattingComplete(e,t,i)}))}_formattingComplete(e,t,i){if(e.workingCopy()===t)return;const s=this._sourcesView.viewForFile(e);let n=[0,0];if(s){const e=s.selection();n=i.originalToFormatted(e.startLine,e.startColumn)}e.setWorkingCopy(t),this._sourcesView.showSourceLocation(e,n[0],n[1])}}});let Is;class Ls extends Y.ThrottledWidget{constructor(){super(!0),this.registerRequiredCSS("sources/javaScriptBreakpointsSidebarPane.css",{enableLegacyPatching:!0}),this._breakpointManager=pe.BreakpointManager.instance(),this._breakpointManager.addEventListener(pe.Events.BreakpointAdded,this.update,this),this._breakpointManager.addEventListener(pe.Events.BreakpointRemoved,this.update,this),a.Settings.instance().moduleSetting("breakpointsActive").addChangeListener(this.update,this),this._breakpoints=new k.ListModel,this._list=new T.ListControl(this._breakpoints,this,T.ListMode.NonViewport),M.markAsList(this._list.element),this.contentElement.appendChild(this._list.element),this._emptyElement=this.contentElement.createChild("div","gray-info-message"),this._emptyElement.textContent=p`No breakpoints`,this._emptyElement.tabIndex=-1,this.update()}static instance(){return Is||(Is=new Ls),Is}_getBreakpointLocations(){const e=this._breakpointManager.allBreakpointLocations().filter((e=>e.uiLocation.uiSourceCode.project().type()!==De.projectTypes.Debugger));e.sort(((e,t)=>e.uiLocation.compareTo(t.uiLocation)));const t=[];let i=null,s=null;for(const n of e)(n.breakpoint!==i||s&&n.uiLocation.compareTo(s))&&(t.push(n),i=n.breakpoint,s=n.uiLocation);return t}_hideList(){this._list.element.classList.add("hidden"),this._emptyElement.classList.remove("hidden")}_ensureListShown(){this._list.element.classList.remove("hidden"),this._emptyElement.classList.add("hidden")}_groupBreakpointLocationsById(e){const t=new g;for(const i of e){const e=i.uiLocation;t.set(e.id(),i)}const i=[];for(const e of t.keysArray()){const s=Array.from(t.get(e));s.length&&i.push(s)}return i}_getLocationIdsByLineId(e){const t=new g;for(const i of e){const e=i.uiLocation;t.set(e.lineId(),e.id())}return t}async _getSelectedUILocation(){const e=P.Context.instance().flavor(xe.DebuggerPausedDetails);return e&&e.callFrames.length?await le.DebuggerWorkspaceBinding.instance().rawLocationToUILocation(e.callFrames[0].location()):null}_getContent(e){const t=new Map;return Promise.all(e.map((async([{uiLocation:{uiSourceCode:e}}])=>{if("application/wasm"===e.mimeType())return new Ye.Text("");const{content:i}=await e.requestContent(),s=i||"";if(t.has(s))return t.get(s);const n=new Ye.Text(s);return t.set(s,n),n})))}async doUpdate(){const e=this.hasFocus(),t=this._getBreakpointLocations();if(!t.length)return this._hideList(),this._setBreakpointItems([]),this._didUpdateForTest();this._ensureListShown();const i=this._groupBreakpointLocationsById(t),s=this._getLocationIdsByLineId(t),n=await this._getContent(i),o=await this._getSelectedUILocation(),r=[];for(let e=0;e<i.length;e++){const t=i[e],a=t[0].uiLocation,c=null!==o&&t.some((e=>e.uiLocation.id()===o.id())),l="application/wasm"!==a.uiSourceCode.mimeType()&&s.get(a.lineId()).size>1,d=n[e];r.push(new ks(t,d,c,l))}return r.some((e=>e.isSelected))&&N.ViewManager.instance().showView("sources.jsBreakpoints"),this._list.element.classList.toggle("breakpoints-list-deactivated",!a.Settings.instance().moduleSetting("breakpointsActive").get()),this._setBreakpointItems(r),e&&this.focus(),this._didUpdateForTest()}_setBreakpointItems(e){if(this._breakpoints.length===e.length)for(let t=0;t<this._breakpoints.length;t++)this._breakpoints.at(t).isSimilar(e[t])||this._breakpoints.replace(t,e[t],!0);else this._breakpoints.replaceAll(e);!this._list.selectedItem()&&this._breakpoints.at(0)&&this._list.selectItem(this._breakpoints.at(0))}createElementForItem(e){const t=document.createElement("div");t.classList.add("breakpoint-entry"),M.markAsListitem(t),t.tabIndex=this._list.selectedItem()===e?0:-1,t.addEventListener("contextmenu",this._breakpointContextMenu.bind(this),!0),t.addEventListener("click",this._revealLocation.bind(this,t),!1);const i=v.CheckboxLabel.create(""),s=e.locations[0].uiLocation,n=e.locations.some((e=>e.breakpoint.enabled())),o=e.locations.some((e=>!e.breakpoint.enabled()));i.textElement.textContent=s.linkText()+(e.showColumn&&"number"==typeof s.columnNumber?":"+(s.columnNumber+1):""),i.checkboxElement.checked=n,i.checkboxElement.indeterminate=n&&o,i.checkboxElement.tabIndex=-1,i.addEventListener("click",this._breakpointCheckboxClicked.bind(this),!1),t.appendChild(i);let r=n?p`checked`:p`unchecked`;n&&o&&(r=p`mixed`),e.isSelected?(M.setDescription(t,p`${r} breakpoint hit`),t.classList.add("breakpoint-hit"),this.setDefaultFocusedElement(t)):M.setDescription(t,r),t.addEventListener("keydown",(e=>{" "===e.key&&(i.checkboxElement.click(),e.consume(!0))}));const a=t.createChild("div","source-text monospace"),c=s.lineNumber;if(e.text&&c<e.text.lineCount()){const t=e.text.lineAt(c),i=200;a.textContent=t.substring(e.showColumn&&s.columnNumber||0).trimEndWithMaxLength(i)}return Ps.set(t,e.locations),Ts.set(t,s),t}heightForItem(e){return 0}isItemSelectable(e){return!0}selectedItemChanged(e,t,i,s){i&&(i.tabIndex=-1),s&&(s.tabIndex=0,this.setDefaultFocusedElement(s),this.hasFocus()&&s.focus())}updateSelectedItemARIA(e,t){return!0}_breakpointLocations(e){return e.target instanceof Element?this._breakpointLocationsForElement(e.target):[]}_breakpointLocationsForElement(e){const t=e.enclosingNodeOrSelfWithClass("breakpoint-entry");return t&&Ps.get(t)||[]}_breakpointCheckboxClicked(e){const t=this.hasFocus(),i=this._breakpointLocations(e).map((e=>e.breakpoint)),s=e.target.checkboxElement.checked;for(const e of i){e.setEnabled(s);const t=this._breakpoints.find((t=>t.locations.some((t=>t.breakpoint===e))));t&&this._list.refreshItem(t)}t&&this.focus(),e.consume()}_revealLocation(e){const t=this._breakpointLocationsForElement(e).map((e=>e.uiLocation));let s=null;for(const e of t)(!s||e.compareTo(s)<0)&&(s=e);s&&i.reveal(s)}_breakpointContextMenu(t){const i=this._breakpointLocations(t).map((e=>e.breakpoint)),s=new D.ContextMenu(t),n=i.length>1?e.UIString("Remove all breakpoints in line"):e.UIString("Remove breakpoint");s.defaultSection().appendItem(n,(()=>i.map((e=>e.remove(!1))))),t.target instanceof Element&&s.defaultSection().appendItem(p`Reveal location`,this._revealLocation.bind(this,t.target));const o=a.Settings.instance().moduleSetting("breakpointsActive").get(),r=o?e.UIString("Deactivate breakpoints"):e.UIString("Activate breakpoints");if(s.defaultSection().appendItem(r,(()=>a.Settings.instance().moduleSetting("breakpointsActive").set(!o))),i.some((e=>!e.enabled()))){const i=e.UIString("Enable all breakpoints");if(s.defaultSection().appendItem(i,this._toggleAllBreakpoints.bind(this,!0)),t.target instanceof Element){const i=e.UIString("Enable breakpoints in file");s.defaultSection().appendItem(i,this._toggleAllBreakpointsInFile.bind(this,t.target,!0))}}if(i.some((e=>e.enabled()))){const i=e.UIString("Disable all breakpoints");if(s.defaultSection().appendItem(i,this._toggleAllBreakpoints.bind(this,!1)),t.target instanceof Element){const i=e.UIString("Disable breakpoints in file");s.defaultSection().appendItem(i,this._toggleAllBreakpointsInFile.bind(this,t.target,!1))}}const c=e.UIString("Remove all breakpoints");s.defaultSection().appendItem(c,this._removeAllBreakpoints.bind(this));const l=e.UIString("Remove other breakpoints");s.defaultSection().appendItem(l,this._removeOtherBreakpoints.bind(this,new Set(i))),s.show()}_toggleAllBreakpointsInFile(e,t){const i=this._getBreakpointLocations(),s=this._breakpointLocationsForElement(e);i.forEach((e=>{s.some((t=>t.breakpoint.url()===e.breakpoint.url()))&&e.breakpoint.setEnabled(t)}))}_toggleAllBreakpoints(e){for(const t of this._breakpointManager.allBreakpointLocations())t.breakpoint.setEnabled(e)}_removeAllBreakpoints(){for(const e of this._breakpointManager.allBreakpointLocations())e.breakpoint.remove(!1)}_removeOtherBreakpoints(e){for(const t of this._breakpointManager.allBreakpointLocations())e.has(t.breakpoint)||t.breakpoint.remove(!1)}flavorChanged(e){this.update()}_didUpdateForTest(){}}class ks{constructor(e,t,i,s){this.locations=e,this.text=t,this.isSelected=i,this.showColumn=s}isSimilar(e){return this.locations.length===e.locations.length&&this.locations.every(((t,i)=>t.uiLocation===e.locations[i].uiLocation))&&this.locations.every(((t,i)=>t.breakpoint===e.locations[i].breakpoint))&&(this.text===e.text||this.text&&e.text&&this.text.value()===e.text.value())&&this.isSelected===e.isSelected&&this.showColumn===e.showColumn}}const Ts=new WeakMap;const Ps=new WeakMap;var Ms=Object.freeze({__proto__:null,JavaScriptBreakpointsSidebarPane:Ls,retrieveLocationForElement:function(e){return Ts.get(e)},BreakpointLocation:undefined});var Fs=Object.freeze({__proto__:null,OpenFileQuickOpen:class extends vs{attach(){this.setDefaultScores($i.defaultUISourceCodeScores()),super.attach()}uiSourceCodeSelected(e,t,s){be.actionTaken(Se.Action.SelectFileFromFilePicker),e&&("number"==typeof t?i.reveal(e.uiLocation(t,s)):i.reveal(e))}filterProject(e){return!e.isServiceProject()}renderAsTwoRows(){return!0}}});class Ds extends it.Provider{constructor(){super(),this._items=[],this._active=!1}attach(){this._items=[],this._active=!1;const e=this._currentUISourceCode();e&&(this._active=Re.formatterWorkerPool().outlineForMimetype(e.workingCopy(),e.contentType().canonicalMimeType(),this._didBuildOutlineChunk.bind(this)))}_didBuildOutlineChunk(e,t){this._items.push(...t),this.refresh()}itemCount(){return this._items.length}itemKeyAt(e){const t=this._items[e];return t.title+(t.subtitle?t.subtitle:"")}itemScoreAt(e,t){const i=this._items[e];return t.split("(")[0].toLowerCase()===i.title.toLowerCase()?1/(1+i.line):-i.line-1}renderItem(e,t,i,s){const n=this._items[e];i.textContent=n.title+(n.subtitle?n.subtitle:""),it.FilteredListWidget.highlightRanges(i,t),s.textContent=":"+(n.line+1)}selectItem(e,t){if(null===e)return;const s=this._currentUISourceCode();if(!s)return;const n=this._items[e].line;!isNaN(n)&&n>=0&&i.reveal(s.uiLocation(n,this._items[e].column))}_currentUISourceCode(){const e=P.Context.instance().flavor($i);return e?e.currentUISourceCode():null}notFoundText(){return this._currentUISourceCode()?this._active?e.UIString("No results found"):e.UIString("Open a JavaScript or CSS file to see symbols"):e.UIString("No file selected.")}}var Ns=Object.freeze({__proto__:null,OutlineQuickOpen:Ds});let Bs;class Us extends f.VBox{constructor(){super(!0),this.registerRequiredCSS("sources/scopeChainSidebarPane.css",{enableLegacyPatching:!1}),this._treeOutline=new oe.ObjectPropertiesSectionsTreeOutline,this._treeOutline.registerRequiredCSS("sources/scopeChainSidebarPane.css",{enableLegacyPatching:!1}),this._treeOutline.setShowSelectionOnKeyboardFocus(!0),this._expandController=new oe.ObjectPropertiesSectionsTreeExpandController(this._treeOutline),this._linkifier=new lt.Linkifier,this._infoElement=document.createElement("div"),this._infoElement.className="gray-info-message",this._infoElement.tabIndex=-1,this._update()}static instance(){return Bs||(Bs=new Us),Bs}flavorChanged(e){this._update()}focus(){this.hasFocus()||P.Context.instance().flavor(xe.DebuggerPausedDetails)&&this._treeOutline.forceSelect()}async _update(){this._infoElement.textContent=p`Loading...`,this.contentElement.removeChildren(),this.contentElement.appendChild(this._infoElement),this._linkifier.reset();const e=P.Context.instance().flavor(xe.CallFrame),[t,i]=await Promise.all([ls(e),os(e)]);if(e===P.Context.instance().flavor(xe.CallFrame)){const s=P.Context.instance().flavor(xe.DebuggerPausedDetails);if(this._treeOutline.removeChildren(),!s||!e||!i)return void(this._infoElement.textContent=p`Not paused`);this.contentElement.removeChildren(),this.contentElement.appendChild(this._treeOutline.element);let n=!1;for(let o=0;o<i.length;++o){const r=i[o],a=this._extraPropertiesForScope(r,s,e,t,0===o);r.type()===Protocol.Debugger.ScopeType.Local&&(n=!0);const c=this._createScopeSectionTreeElement(r,a);r.type()===Protocol.Debugger.ScopeType.Global?c.collapse():n&&r.type()!==Protocol.Debugger.ScopeType.Local||c.expand(),this._treeOutline.appendChild(c),0===o&&c.select(!0)}this._sidebarPaneUpdatedForTest()}}_createScopeSectionTreeElement(e,t){let i=null;(e.type()===Protocol.Debugger.ScopeType.Local||Protocol.Debugger.ScopeType.Closure)&&(i=p`No variables`);let s=e.typeName();if(e.type()===Protocol.Debugger.ScopeType.Closure){const t=e.name();s=t?p`Closure (${v.beautifyFunctionName(t)})`:p`Closure`}let n=e.description();s&&s!==n||(n=null);const o=e.icon(),r=document.createElement("div");if(r.classList.add("scope-chain-sidebar-pane-section-header"),r.classList.add("tree-element-title"),o){const e=document.createElement("img");e.classList.add("scope-chain-sidebar-pane-section-icon"),e.src=o,r.appendChild(e)}r.createChild("div","scope-chain-sidebar-pane-section-subtitle").textContent=n,r.createChild("div","scope-chain-sidebar-pane-section-title").textContent=s;const a=new oe.RootElement(ds(e),this._linkifier,i,!0,t);return a.title=r,a.listItemElement.classList.add("scope-chain-sidebar-pane-section"),a.listItemElement.setAttribute("aria-label",s),this._expandController.watchSection(s+(n?":"+n:""),a),a}_extraPropertiesForScope(t,i,s,n,o){if(t.type()!==Protocol.Debugger.ScopeType.Local||s.script.isWasm())return[];const r=[];if(n&&r.push(new Pe.RemoteObjectProperty("this",n)),o){const t=i.exception();t&&r.push(new Pe.RemoteObjectProperty(e.UIString("Exception"),t,void 0,void 0,void 0,void 0,void 0,!0));const n=s.returnValue();n&&r.push(new Pe.RemoteObjectProperty(e.UIString("Return value"),n,void 0,void 0,void 0,void 0,void 0,!0,s.setReturnValue.bind(s)))}return r}_sidebarPaneUpdatedForTest(){}}class As extends f.VBox{_isMemoryObjectProperty(e){return"object"===e.type&&e.subtype&&ht.ACCEPTED_MEMORY_TYPES.includes(e.subtype)}appendApplicableItems(e,t,i){i instanceof oe.ObjectPropertyTreeElement&&i.property&&i.property.value&&this._isMemoryObjectProperty(i.property.value)&&t.debugSection().appendItem(p`Inspect memory`,this._openMemoryInspector.bind(this,i.property.value))}async _openMemoryInspector(e){ht.LinearMemoryInspectorController.instance().openInspectorView(e,0)}}var Rs=Object.freeze({__proto__:null,ScopeChainSidebarPane:Us,OpenLinearMemoryInspector:As});let js,Vs,Os;class Ws extends di{constructor(){super();const e=new Z.EmptyWidget("");this.setPlaceholder(e),e.appendParagraph().appendChild(ee.html`
      <div>${p`Sync changes in DevTools with the local filesystem`}</div><br />
      ${J.XLink.create("https://developers.google.com/web/tools/chrome-devtools/workspaces/",p`Learn more about Workspaces`)}
    `);const t=new x.Toolbar("navigator-toolbar");t.appendItemsAtLocation("files-navigator-toolbar").then((()=>{t.empty()||this.contentElement.insertBefore(t.element,this.contentElement.firstChild)}))}static instance(){return js||(js=new Ws),js}acceptProject(e){return e.type()===De.projectTypes.FileSystem&&"overrides"!==fe.FileSystemWorkspaceBinding.fileSystemType(e)&&!nt.isSnippetsProject(e)&&!at.isRecordingProject(e)}handleContextMenu(e){const t=new D.ContextMenu(e);t.defaultSection().appendAction("sources.add-folder-to-workspace",void 0,!0),t.show()}}class Hs extends di{constructor(){super();const t=new Z.EmptyWidget("");this.setPlaceholder(t),t.appendParagraph().appendChild(ee.html`
      <div>${p`Create and save code snippets for later reuse`}</div><br />
      ${J.XLink.create("https://developers.google.com/web/tools/chrome-devtools/javascript/snippets",p`Learn more`)}
    `);const i=new x.Toolbar("navigator-toolbar"),s=new x.ToolbarButton(p`New snippet`,"largeicon-add",e.UIString("New snippet"));s.addEventListener(x.ToolbarButton.Events.Click,(e=>{this.create(nt.findSnippetsProject(),"")})),i.appendToolbarItem(s),this.contentElement.insertBefore(i.element,this.contentElement.firstChild)}static instance(){return Vs||(Vs=new Hs),Vs}acceptProject(e){return nt.isSnippetsProject(e)}handleContextMenu(e){const t=new D.ContextMenu(e);t.headerSection().appendItem(p`Create new snippet`,(()=>this.create(nt.findSnippetsProject(),""))),t.show()}handleFileContextMenu(t,i){const s=i.uiSourceCode(),n=new D.ContextMenu(t);n.headerSection().appendItem(e.UIString("Run"),(()=>nt.evaluateScriptSnippet(s))),n.editSection().appendItem(e.UIString("Rename…"),(()=>this.rename(i,!1))),n.editSection().appendItem(e.UIString("Remove"),(()=>s.project().deleteFile(s))),n.saveSection().appendItem(e.UIString("Save as..."),this._handleSaveAs.bind(this,s)),n.show()}async _handleSaveAs(e){e.commitWorkingCopy();const{content:t}=await e.requestContent();Be.FileManager.instance().save(e.url(),t||"",!0),Be.FileManager.instance().close(e.url())}}class zs extends di{constructor(){super();const e=new Z.EmptyWidget("");this.setPlaceholder(e);e.appendParagraph().innerText=p`Record and replay browser interactions`;const t=new x.Toolbar("navigator-toolbar"),i=new x.ToolbarButton(p`Add recording`,"largeicon-add",p`Add recording`);i.addEventListener(x.ToolbarButton.Events.Click,(e=>{this.create(at.findRecordingsProject(),'{"steps": []}')})),t.appendToolbarItem(i),this.contentElement.insertBefore(t.element,this.contentElement.firstChild)}static instance(){return Os||(Os=new zs),Os}acceptProject(e){return at.isRecordingProject(e)}handleContextMenu(e){const t=new D.ContextMenu(e);t.headerSection().appendItem(p`Add recording`,(()=>this.create(at.findRecordingsProject(),""))),t.show()}handleFileContextMenu(t,i){const s=i.uiSourceCode(),n=new D.ContextMenu(t);n.editSection().appendItem(e.UIString("Rename…"),(()=>this.rename(i,!1))),n.editSection().appendItem(e.UIString("Remove"),(()=>s.project().deleteFile(s))),n.saveSection().appendItem(e.UIString("Save as..."),this._handleSaveAs.bind(this,s)),n.show()}async _handleSaveAs(e){e.commitWorkingCopy();const{content:t}=await e.requestContent();Be.FileManager.instance().save(e.url(),t||"",!0),Be.FileManager.instance().close(e.url())}}var qs=Object.freeze({__proto__:null,NetworkNavigatorView:class extends di{constructor(){super(),ye.TargetManager.instance().addEventListener(ye.Events.InspectedURLChanged,this._inspectedURLChanged,this),be.panelLoaded("sources","DevTools.Launch.Sources")}acceptProject(e){return e.type()===De.projectTypes.Network}_inspectedURLChanged(e){const t=ye.TargetManager.instance().mainTarget();if(e.data!==t)return;const i=t&&t.inspectedURL();if(i)for(const e of this.workspace().uiSourceCodes())this.acceptProject(e.project())&&e.url()===i&&this.revealUISourceCode(e,!0)}uiSourceCodeAdded(e){const t=ye.TargetManager.instance().mainTarget(),i=t&&t.inspectedURL();i&&e.url()===i&&this.revealUISourceCode(e,!0)}},FilesNavigatorView:Ws,OverridesNavigatorView:class extends di{constructor(){super();const e=new Z.EmptyWidget("");this.setPlaceholder(e),e.appendParagraph().appendChild(ee.html`
      <div>${p`Override page assets with files from a local folder`}</div><br />
      ${J.XLink.create("https://developers.google.com/web/updates/2018/01/devtools#overrides",p`Learn more`)}
    `),this._toolbar=new x.Toolbar("navigator-toolbar"),this.contentElement.insertBefore(this._toolbar.element,this.contentElement.firstChild),ve.NetworkPersistenceManager.instance().addEventListener(ve.Events.ProjectChanged,this._updateProjectAndUI,this),this.workspace().addEventListener(De.Events.ProjectAdded,this._onProjectAddOrRemoved,this),this.workspace().addEventListener(De.Events.ProjectRemoved,this._onProjectAddOrRemoved,this),this._updateProjectAndUI()}_onProjectAddOrRemoved(e){const t=e.data;t&&t.type()===De.projectTypes.FileSystem&&"overrides"!==fe.FileSystemWorkspaceBinding.fileSystemType(t)||this._updateUI()}_updateProjectAndUI(){this.reset();const e=ve.NetworkPersistenceManager.instance().project();e&&this.tryAddProject(e),this._updateUI()}_updateUI(){this._toolbar.removeToolbarItems();const t=ve.NetworkPersistenceManager.instance().project();if(t){const i=new x.ToolbarSettingCheckbox(a.Settings.instance().moduleSetting("persistenceNetworkOverridesEnabled"));this._toolbar.appendToolbarItem(i),this._toolbar.appendToolbarItem(new x.ToolbarSeparator(!0));const s=new x.ToolbarButton(e.UIString("Clear configuration"),"largeicon-clear");return s.addEventListener(x.ToolbarButton.Events.Click,(()=>{t.remove()})),void this._toolbar.appendToolbarItem(s)}const i=e.UIString("Select folder for overrides"),s=new x.ToolbarButton(i,"largeicon-add",i);s.addEventListener(x.ToolbarButton.Events.Click,(e=>{this._setupNewWorkspace()}),this),this._toolbar.appendToolbarItem(s)}async _setupNewWorkspace(){await Ee.IsolatedFileSystemManager.instance().addFileSystem("overrides")&&a.Settings.instance().moduleSetting("persistenceNetworkOverridesEnabled").set(!0)}acceptProject(e){return e===ve.NetworkPersistenceManager.instance().project()}},ContentScriptsNavigatorView:class extends di{constructor(){super();const e=new Z.EmptyWidget("");this.setPlaceholder(e),e.appendParagraph().appendChild(ee.html`
      <div>${p`Content scripts served by extensions appear here`}</div><br />
      ${J.XLink.create("https://developer.chrome.com/extensions/content_scripts",p`Learn more`)}
    `)}acceptProject(e){return e.type()===De.projectTypes.ContentScripts}},SnippetsNavigatorView:Hs,RecordingsNavigatorView:zs,ActionDelegate:class{handleAction(e,t){switch(t){case"sources.create-snippet":return nt.findSnippetsProject().createFile("",null,"").then((e=>i.reveal(e))),!0;case"sources.add-folder-to-workspace":return Ee.IsolatedFileSystemManager.instance().addFileSystem(),!0}return!1}}});let Gs;class Ks extends Y.ThrottledWidget{constructor(){super(!0),this.registerRequiredCSS("object_ui/objectValue.css",{enableLegacyPatching:!0}),this.registerRequiredCSS("sources/watchExpressionsSidebarPane.css",{enableLegacyPatching:!0}),this._watchExpressions=[],this._emptyElement,this._watchExpressionsSetting=a.Settings.instance().createLocalSetting("watchExpressions",[]),this._addButton=new x.ToolbarButton(p`Add watch expression`,"largeicon-add"),this._addButton.addEventListener(x.ToolbarButton.Events.Click,(e=>{this._addButtonClicked()})),this._refreshButton=new x.ToolbarButton(p`Refresh watch expressions`,"largeicon-refresh"),this._refreshButton.addEventListener(x.ToolbarButton.Events.Click,this.update,this),this.contentElement.classList.add("watch-expressions"),this.contentElement.addEventListener("contextmenu",this._contextMenu.bind(this),!1),this._treeOutline=new oe.ObjectPropertiesSectionsTreeOutline,this._treeOutline.registerRequiredCSS("sources/watchExpressionsSidebarPane.css",{enableLegacyPatching:!0}),this._treeOutline.setShowSelectionOnKeyboardFocus(!0),this._expandController=new oe.ObjectPropertiesSectionsTreeExpandController(this._treeOutline),P.Context.instance().addFlavorChangeListener(ke.ExecutionContext,this.update,this),P.Context.instance().addFlavorChangeListener(xe.CallFrame,this.update,this),this._linkifier=new lt.Linkifier,this.update()}static instance(){return Gs||(Gs=new Ks),Gs}toolbarItems(){return[this._addButton,this._refreshButton]}focus(){this.hasFocus()||this._watchExpressions.length>0&&this._treeOutline.forceSelect()}hasExpressions(){return Boolean(this._watchExpressionsSetting.get().length)}_saveExpressions(){const e=[];for(let t=0;t<this._watchExpressions.length;t++)this._watchExpressions[t].expression()&&e.push(this._watchExpressions[t].expression());this._watchExpressionsSetting.set(e)}async _addButtonClicked(){await N.ViewManager.instance().showView("sources.watch"),this._emptyElement.classList.add("hidden"),this._createWatchExpression(null).startEditing()}doUpdate(){this._linkifier.reset(),this.contentElement.removeChildren(),this._treeOutline.removeChildren(),this._watchExpressions=[],this._emptyElement=this.contentElement.createChild("div","gray-info-message"),this._emptyElement.textContent=e.UIString("No watch expressions"),this._emptyElement.tabIndex=-1;const t=this._watchExpressionsSetting.get();t.length&&this._emptyElement.classList.add("hidden");for(let e=0;e<t.length;++e){const i=t[e];i&&this._createWatchExpression(i)}return Promise.resolve()}_createWatchExpression(e){this.contentElement.appendChild(this._treeOutline.element);const t=new $s(e,this._expandController,this._linkifier);return t.addEventListener($s.Events.ExpressionUpdated,this._watchExpressionUpdated,this),this._treeOutline.appendChild(t.treeElement()),this._watchExpressions.push(t),t}_watchExpressionUpdated(e){const t=e.data;t.expression()||(m.removeElement(this._watchExpressions,t),this._treeOutline.removeChild(t.treeElement()),this._emptyElement.classList.toggle("hidden",Boolean(this._watchExpressions.length)),0===this._watchExpressions.length&&this._treeOutline.element.remove()),this._saveExpressions()}_contextMenu(e){const t=new D.ContextMenu(e);this._populateContextMenu(t,e),t.show()}_populateContextMenu(t,i){let s=!1;for(const e of this._watchExpressions)s=s||e.isEditing();s||t.debugSection().appendItem(e.UIString("Add watch expression"),this._addButtonClicked.bind(this)),this._watchExpressions.length>1&&t.debugSection().appendItem(e.UIString("Delete all watch expressions"),this._deleteAllButtonClicked.bind(this));const n=this._treeOutline.treeElementFromEvent(i);if(!n)return;const o=this._watchExpressions.find((e=>n.hasAncestorOrSelf(e.treeElement())));o&&o._populateContextMenu(t,i)}_deleteAllButtonClicked(){this._watchExpressions=[],this._saveExpressions(),this.update()}_focusAndAddExpressionToWatch(e){N.ViewManager.instance().showView("sources.watch"),this.doUpdate(),this._addExpressionToWatch(e)}_addExpressionToWatch(e){this._createWatchExpression(e),this._saveExpressions(),this.update()}handleAction(e,t){const i=P.Context.instance().flavor(Pi);if(!i)return!1;const s=i.textEditor.text(i.textEditor.selection());return this._focusAndAddExpressionToWatch(s),!0}_addPropertyPathToWatch(e){this._addExpressionToWatch(e.path())}appendApplicableItems(e,t,i){i instanceof oe.ObjectPropertyTreeElement&&!i.property.synthetic&&t.debugSection().appendItem(p`Add property path to watch`,this._addPropertyPathToWatch.bind(this,i));const s=P.Context.instance().flavor(Pi);s&&!s.textEditor.selection().isEmpty()&&t.debugSection().appendAction("sources.add-to-watch")}}class $s extends u.ObjectWrapper{constructor(e,t,i){super(),this._treeElement,this._nameElement,this._valueElement,this._expression=e,this._expandController=t,this._element=document.createElement("div"),this._element.classList.add("watch-expression"),this._element.classList.add("monospace"),this._editing=!1,this._linkifier=i,this._createWatchExpression(),this.update()}treeElement(){return this._treeElement}expression(){return this._expression}update(){const e=P.Context.instance().flavor(ke.ExecutionContext);e&&this._expression&&e.evaluate({expression:this._expression,objectGroup:$s._watchObjectGroupId,includeCommandLineAPI:!1,silent:!0,returnByValue:!1,generatePreview:!1,allowUnsafeEvalBlockedByCSP:void 0,disableBreaks:void 0,replMode:void 0,throwOnSideEffect:void 0,timeout:void 0},!1,!1).then((e=>{"object"in e&&this._createWatchExpression(e.object,e.exceptionDetails)}))}startEditing(){this._editing=!0,this._element.removeChildren();const e=this._element.createChild("div");e.textContent=this._nameElement.textContent,this._textPrompt=new oe.ObjectPropertyPrompt,this._textPrompt.renderAsBlock();const t=this._textPrompt.attachAndStartEditing(e,this._finishEditing.bind(this));this._treeElement.listItemElement.classList.add("watch-expression-editing"),this._treeElement.collapse(),t.classList.add("watch-expression-text-prompt-proxy"),t.addEventListener("keydown",this._promptKeyDown.bind(this),!1);const i=this._element.getComponentSelection();i&&i.selectAllChildren(e)}isEditing(){return Boolean(this._editing)}_finishEditing(e,t){if(e&&e.consume(t),this._editing=!1,this._treeElement.listItemElement.classList.remove("watch-expression-editing"),this._textPrompt){this._textPrompt.detach();const e=t?this._expression:this._textPrompt.text();this._textPrompt=void 0,this._element.removeChildren(),this._updateExpression(e)}}_dblClickOnWatchExpression(e){e.consume(),this.isEditing()||this.startEditing()}_updateExpression(e){this._expression&&this._expandController.stopWatchSectionsWithId(this._expression),this._expression=e,this.update(),this.dispatchEventToListeners($s.Events.ExpressionUpdated,this)}_deleteWatchExpression(e){e.consume(!0),this._updateExpression(null)}_createWatchExpression(e,t){this._result=e||null,this._element.removeChildren();const i=this._treeElement;if(this._createWatchExpressionTreeElement(e,t),i&&i.parent){const e=i.parent,t=e.indexOfChild(i);e.removeChild(i),e.insertChild(this._treeElement,t)}this._treeElement.select()}_createWatchExpressionHeader(t,i){const s=this._element.createChild("div","watch-expression-header"),n=F.Icon.create("smallicon-cross","watch-expression-delete-button");I.Tooltip.install(n,p`Delete watch expression`),n.addEventListener("click",this._deleteWatchExpression.bind(this),!1);const o=s.createChild("div","watch-expression-title tree-element-title");if(o.appendChild(n),this._nameElement=oe.ObjectPropertiesSection.createNameElement(this._expression),Boolean(i)||!t)this._valueElement=document.createElement("span"),this._valueElement.classList.add("watch-expression-error"),this._valueElement.classList.add("value"),o.classList.add("dimmed"),this._valueElement.textContent=e.UIString("<not available>"),void 0!==i&&void 0!==i.exception&&void 0!==i.exception.description&&I.Tooltip.install(this._valueElement,i.exception.description);else{const e=oe.ObjectPropertiesSection.createPropertyValueWithCustomSupport(t,Boolean(i),!1,o,this._linkifier);this._valueElement=e.element}const r=document.createElement("span");return r.classList.add("watch-expressions-separator"),r.textContent=": ",o.append(this._nameElement,r,this._valueElement),s}_createWatchExpressionTreeElement(e,t){const i=this._createWatchExpressionHeader(e,t);!t&&e&&e.hasChildren&&!e.customPreview()?(i.classList.add("watch-expression-object-header"),this._treeElement=new oe.RootElement(e,this._linkifier),this._expandController.watchSection(this._expression,this._treeElement),this._treeElement.toggleOnClick=!1,this._treeElement.listItemElement.addEventListener("click",this._onSectionClick.bind(this),!1),this._treeElement.listItemElement.addEventListener("dblclick",this._dblClickOnWatchExpression.bind(this))):(i.addEventListener("dblclick",this._dblClickOnWatchExpression.bind(this)),this._treeElement=new j.TreeElement),this._treeElement.title=this._element,this._treeElement.listItemElement.classList.add("watch-expression-tree-item"),this._treeElement.listItemElement.addEventListener("keydown",(e=>{"Enter"!==e.key||this.isEditing()||(this.startEditing(),e.consume(!0))}))}_onSectionClick(e){e.consume(!0);1===e.detail?this._preventClickTimeout=setTimeout(function(){if(!this._treeElement)return;this._treeElement.expanded?this._treeElement.collapse():this._treeElement.expand()}.bind(this),333):void 0!==this._preventClickTimeout&&(window.clearTimeout(this._preventClickTimeout),this._preventClickTimeout=void 0)}_promptKeyDown(e){("Enter"===e.key||isEscKey(e))&&this._finishEditing(e,isEscKey(e))}_populateContextMenu(t,i){this.isEditing()||t.editSection().appendItem(e.UIString("Delete watch expression"),this._updateExpression.bind(this,null)),this.isEditing()||!this._result||"number"!==this._result.type&&"string"!==this._result.type||t.clipboardSection().appendItem(e.UIString("Copy value"),this._copyValueButtonClicked.bind(this));const s=v.deepElementFromEvent(i);s&&this._valueElement.isSelfOrAncestor(s)&&this._result&&t.appendApplicableItems(this._result)}_copyValueButtonClicked(){me.InspectorFrontendHostInstance.copyText(this._valueElement.textContent)}}$s._watchObjectGroupId="watch-group",$s.Events={ExpressionUpdated:Symbol("ExpressionUpdated")};var Js=Object.freeze({__proto__:null,WatchExpressionsSidebarPane:Ks,WatchExpression:$s});export{pt as AddSourceMapURLDialog,St as BreakpointEditDialog,Nt as CSSPlugin,yt as CallStackSidebarPane,Tt as CoveragePlugin,At as DebuggerPausedMessage,Ss as DebuggerPlugin,Ot as EditingLocationHistoryManager,fs as FilePathScoreFunction,ws as FilteredUISourceCodeListProvider,xs as GoToLineQuickOpen,qt as GutterDiffPlugin,ys as InplaceFormatterEditorAction,Ms as JavaScriptBreakpointsSidebarPane,$t as JavaScriptCompilerPlugin,Ci as NavigatorView,Fs as OpenFileQuickOpen,Ns as OutlineQuickOpen,Lt as Plugin,Qt as RecorderPlugin,Rs as ScopeChainSidebarPane,es as ScriptFormatterEditorAction,Zt as ScriptOriginPlugin,ai as SearchSourcesView,ti as SnippetsPlugin,_s as SourceMapNamesResolver,qs as SourcesNavigator,Ti as SourcesPanel,ni as SourcesSearchScope,Yi as SourcesView,Ki as TabbedEditorContainer,wi as ThreadsSidebarPane,ji as UISourceCodeFrame,Js as WatchExpressionsSidebarPane};
