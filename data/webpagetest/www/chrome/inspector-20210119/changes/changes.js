import{EventTarget as e,Revealer as t}from"../common/common.js";import{Diff as i}from"../diff/diff.js";import{i18n as s}from"../i18n/i18n.js";import{Widget as n,TreeOutline as o,ARIAUtils as r,Icon as a,SplitWidget as d,EmptyWidget as l,Toolbar as c,ViewManager as h}from"../ui/ui.js";import{WorkspaceDiff as u}from"../workspace_diff/workspace_diff.js";import{StringUtilities as f}from"../platform/platform.js";import{ScriptSnippetFileSystem as p}from"../snippets/snippets.js";import{UISourceCode as g}from"../workspace/workspace.js";import{CodeMirrorTextEditor as m}from"../text_editor/text_editor.js";function _(e,t){const i=t.diffRows,s=t.baselineLines,n=t.currentLines,o=CodeMirror.getMode({},t.mimeType);function r(e,t,i,s){let n=t;for(;n<i&&n<s.length;){const t=new CodeMirror.StringStream(s[n]);for(t.eol()&&o.blankLine&&o.blankLine(e);!t.eol();)o.token&&o.token(t,e),t.start=t.pos;n++}}return{startState:function(){return{rowNumber:0,diffTokenIndex:0,currentLineNumber:0,baselineLineNumber:0,currentSyntaxState:CodeMirror.startState(o),baselineSyntaxState:CodeMirror.startState(o),syntaxPosition:0,diffPosition:0,syntaxStyle:"",diffStyle:""}},token:function(e,t){const a=i[t.rowNumber];if(!a)return e.next(),"";!function(e,t,i){t>e.baselineLineNumber&&(r(e.baselineSyntaxState,e.baselineLineNumber,t,s),e.baselineLineNumber=t),i>e.currentLineNumber&&(r(e.currentSyntaxState,e.currentLineNumber,i,n),e.currentLineNumber=i)}(t,a.baselineLineNumber-1,a.currentLineNumber-1);let d="";0===e.pos&&(d+=" line-background-"+a.type+" line-"+a.type);const l=t.diffPosition>=t.syntaxPosition;return t.diffPosition<=t.syntaxPosition&&(t.diffPosition+=a.tokens[t.diffTokenIndex].text.length,t.diffStyle=a.tokens[t.diffTokenIndex].className,t.diffTokenIndex++),l&&(!o.token||"deletion"!==a.type&&"addition"!==a.type&&"equal"!==a.type?(t.syntaxStyle="",t.syntaxPosition=1/0):(t.syntaxStyle=o.token(e,"deletion"===a.type?t.baselineSyntaxState:t.currentSyntaxState)||"",t.syntaxPosition=e.pos)),e.pos=Math.min(t.syntaxPosition,t.diffPosition),d+=" "+t.syntaxStyle,d+=" "+t.diffStyle,e.eol()&&(t.rowNumber++,"deletion"===a.type?t.baselineLineNumber++:t.currentLineNumber++,t.diffPosition=0,t.syntaxPosition=0,t.diffTokenIndex=0),d},blankLine:function(e){const t=i[e.rowNumber];if(e.rowNumber++,e.syntaxPosition=0,e.diffPosition=0,e.diffTokenIndex=0,!t)return"";let s="";return o.blankLine&&("equal"===t.type||"addition"===t.type?(s=o.blankLine(e.currentSyntaxState),e.currentLineNumber++):"deletion"===t.type&&(s=o.blankLine(e.baselineSyntaxState),e.baselineLineNumber++)),s+" line-background-"+t.type+" line-"+t.type},copyState:function(e){const t=Object.assign({},e);return t.currentSyntaxState=CodeMirror.copyState(o,e.currentSyntaxState),t.baselineSyntaxState=CodeMirror.copyState(o,e.baselineSyntaxState),t}}}CodeMirror.defineMode("devtools-diff",_);var S=Object.freeze({__proto__:null,ChangesHighlighter:_});const b={sFromSourceMap:"{PH1} (from source map)"},C=s.registerUIStrings("changes/ChangesSidebar.ts",b),y=s.getLocalizedString.bind(void 0,C);class x extends n.Widget{constructor(e){super(),this._treeoutline=new o.TreeOutlineInShadow,this._treeoutline.setFocusable(!1),this._treeoutline.registerRequiredCSS("changes/changesSidebar.css",{enableLegacyPatching:!0}),this._treeoutline.setComparator(((e,t)=>f.compare(e.titleAsText(),t.titleAsText()))),this._treeoutline.addEventListener(o.Events.ElementSelected,this._selectionChanged,this),r.markAsTablist(this._treeoutline.contentElement),this.element.appendChild(this._treeoutline.element),this._treeElements=new Map,this._workspaceDiff=e,this._workspaceDiff.modifiedUISourceCodes().forEach(this._addUISourceCode.bind(this)),this._workspaceDiff.addEventListener(u.Events.ModifiedStatusChanged,this._uiSourceCodeMofiedStatusChanged,this)}selectUISourceCode(e,t){const i=this._treeElements.get(e);i&&i.select(t)}selectedUISourceCode(){return this._treeoutline.selectedTreeElement?this._treeoutline.selectedTreeElement.uiSourceCode:null}_selectionChanged(){this.dispatchEventToListeners("SelectedUISourceCodeChanged")}_uiSourceCodeMofiedStatusChanged(e){e.data.isModified?this._addUISourceCode(e.data.uiSourceCode):this._removeUISourceCode(e.data.uiSourceCode)}_removeUISourceCode(e){const t=this._treeElements.get(e);if(this._treeElements.delete(e),this._treeoutline.selectedTreeElement===t){const e=t.previousSibling||t.nextSibling;e?e.select(!0):(t.deselect(),this._selectionChanged())}t&&(this._treeoutline.removeChild(t),t.dispose()),0===this._treeoutline.rootElement().childCount()&&this._treeoutline.setFocusable(!1)}_addUISourceCode(e){const t=new w(e);this._treeElements.set(e,t),this._treeoutline.setFocusable(!0),this._treeoutline.appendChild(t),this._treeoutline.selectedTreeElement||t.select(!0)}}class w extends o.TreeElement{constructor(e){super(),this.uiSourceCode=e,this.listItemElement.classList.add("navigator-"+e.contentType().name()+"-tree-item"),r.markAsTab(this.listItemElement);let t="largeicon-navigator-file";p.isSnippetsUISourceCode(this.uiSourceCode)&&(t="largeicon-navigator-snippet");const i=a.Icon.create(t,"icon");this.setLeadingIcons([i]),this._eventListeners=[e.addEventListener(g.Events.TitleChanged,this._updateTitle,this),e.addEventListener(g.Events.WorkingCopyChanged,this._updateTitle,this),e.addEventListener(g.Events.WorkingCopyCommitted,this._updateTitle,this)],this._updateTitle()}_updateTitle(){let e=this.uiSourceCode.displayName();this.uiSourceCode.isDirty()&&(e="*"+e),this.title=e;let t=this.uiSourceCode.url();this.uiSourceCode.contentType().isFromSourceMap()&&(t=y(b.sFromSourceMap,{PH1:this.uiSourceCode.displayName()})),this.tooltip=t}dispose(){e.EventTarget.removeEventListeners(this._eventListeners)}}var v=Object.freeze({__proto__:null,UIStrings:b,ChangesSidebar:x,UISourceCodeTreeElement:w});const L={deletions:"Deletion:{PH1}",additions:"Addition:{PH1}"},I=s.registerUIStrings("changes/ChangesTextEditor.ts",L),T=s.getLocalizedString.bind(void 0,I);class k extends m.CodeMirrorTextEditor{constructor(e){e.inputStyle="devToolsAccessibleDiffTextArea",super(e),this.codeMirror().setOption("gutters",["CodeMirror-linenumbers","changes-diff-gutter"]),this.codeMirror().setOption("extraKeys",{Enter:!1,Space:!1,Left:function(e){const t=e.getScrollInfo();t.left>0&&e.scrollTo(t.left-Math.round(t.clientWidth/6),null)},Right:function(e){const t=e.getScrollInfo();e.scrollTo(t.left+Math.round(t.clientWidth/6),null)}})}updateDiffGutter(e){this.codeMirror().eachLine((t=>{const i=this.codeMirror().getLineNumber(t),s=e[i];let n;"deletion"===s.type?(n=document.createElement("div"),n.classList.add("deletion"),n.classList.add("changes-diff-gutter-marker"),n.textContent="-"):"addition"===s.type&&(n=document.createElement("div"),n.classList.add("addition"),n.classList.add("changes-diff-gutter-marker"),n.textContent="+"),n&&this.codeMirror().setGutterMarker(t,"changes-diff-gutter",n)}))}}class D extends m.DevToolsAccessibleTextArea{reset(e){super.reset(e);const t=this.cm.doc;if(this.textAreaBusy(Boolean(e))||"object"!=typeof t.modeOption)return;const i=t.modeOption.diffRows[this.cm.getCursor().line].type;"deletion"===i&&(this.textarea.value=T(L.deletions,{PH1:this.textarea.value})),"addition"===i&&(this.textarea.value=T(L.additions,{PH1:this.textarea.value})),this.prevInput=this.textarea.value}}CodeMirror.inputStyles.devToolsAccessibleDiffTextArea=D;var E=Object.freeze({__proto__:null,UIStrings:L,ChangesTextEditor:k,DevToolsAccessibleDiffTextArea:D});const M={changesDiffViewer:"Changes diff viewer",revertAllChangesToCurrentFile:"Revert all changes to current file",noChanges:"No changes",binaryData:"Binary data",sInsertion:"{PH1} insertion (+),",sInsertions:"{PH1} insertions (+),",sDeletion:"{PH1} deletion (-)",sDeletions:"{PH1} deletions (-)",SkippingDMatchingLines:"( … Skipping {PH1} matching lines … )"},U=s.registerUIStrings("changes/ChangesView.ts",M),N=s.getLocalizedString.bind(void 0,U);let P;class R extends n.VBox{constructor(){super(!0),this.registerRequiredCSS("changes/changesView.css",{enableLegacyPatching:!0});const e=new d.SplitWidget(!0,!1),t=new n.Widget;e.setMainWidget(t),e.show(this.contentElement),this._emptyWidget=new l.EmptyWidget(""),this._emptyWidget.show(t.element),this._workspaceDiff=u.workspaceDiff(),this._changesSidebar=new x(this._workspaceDiff),this._changesSidebar.addEventListener("SelectedUISourceCodeChanged",this._selectedUISourceCodeChanged,this),e.setSidebarWidget(this._changesSidebar),this._selectedUISourceCode=null,this._diffRows=[],this._maxLineDigits=1,this._editor=new k({bracketMatchingSetting:void 0,devtoolsAccessibleName:N(M.changesDiffViewer),lineNumbers:!0,lineWrapping:!1,mimeType:void 0,autoHeight:void 0,padBottom:void 0,maxHighlightLength:1/0,placeholder:void 0,lineWiseCopyCut:void 0,inputStyle:void 0}),this._editor.setReadOnly(!0);const i=t.element.createChild("div","editor-container");r.markAsTabpanel(i),this._editor.show(i),this._editor.hideWidget(),self.onInvokeElement(this._editor.element,this._click.bind(this)),this._toolbar=new c.Toolbar("changes-toolbar",t.element);const s=new c.ToolbarButton(N(M.revertAllChangesToCurrentFile),"largeicon-undo");s.addEventListener(c.ToolbarButton.Events.Click,this._revert.bind(this)),this._toolbar.appendToolbarItem(s),this._diffStats=new c.ToolbarText(""),this._toolbar.appendToolbarItem(this._diffStats),this._toolbar.setEnabled(!1),this._hideDiff(N(M.noChanges)),this._selectedUISourceCodeChanged()}static instance(e={forceNew:null}){const{forceNew:t}=e;return P&&!t||(P=new R),P}_selectedUISourceCodeChanged(){this._revealUISourceCode(this._changesSidebar.selectedUISourceCode())}_revert(){const e=this._selectedUISourceCode;e&&this._workspaceDiff.revertToOriginal(e)}_click(e){const i=this._editor.selection();if(!i.isEmpty()||!this._selectedUISourceCode)return;const s=this._diffRows[i.startLine];t.reveal(this._selectedUISourceCode.uiLocation(s.currentLineNumber-1,i.startColumn),!1),e.consume(!0)}_revealUISourceCode(e){this._selectedUISourceCode!==e&&(this._selectedUISourceCode&&this._workspaceDiff.unsubscribeFromDiffChange(this._selectedUISourceCode,this._refreshDiff,this),e&&this.isShowing()&&this._workspaceDiff.subscribeToDiffChange(e,this._refreshDiff,this),this._selectedUISourceCode=e,this._refreshDiff())}wasShown(){this._refreshDiff()}_refreshDiff(){if(!this.isShowing())return;if(!this._selectedUISourceCode)return void this._renderDiffRows(null);const e=this._selectedUISourceCode;e.contentType().isTextType()?this._workspaceDiff.requestDiff(e).then((t=>{this._selectedUISourceCode===e&&this._renderDiffRows(t)})):this._hideDiff(N(M.binaryData))}_hideDiff(e){this._diffStats.setText(""),this._toolbar.setEnabled(!1),this._editor.hideWidget(),this._emptyWidget.text=e,this._emptyWidget.showWidget()}_renderDiffRows(e){if(this._diffRows=[],!e||1===e.length&&e[0][0]===i.Operation.Equal)return void this._hideDiff(N(M.noChanges));let t=0,s=0,n=0,o=0;const r=[],a=[];for(let n=0;n<e.length;++n){const o=e[n];switch(o[0]){case i.Operation.Equal:this._diffRows.push(...c(o[1],0===n,n===e.length-1)),r.push(...o[1]),a.push(...o[1]);break;case i.Operation.Insert:for(const e of o[1])this._diffRows.push(u(e,"addition"));t+=o[1].length,a.push(...o[1]);break;case i.Operation.Delete:if(s+=o[1].length,r.push(...o[1]),e[n+1]&&e[n+1][0]===i.Operation.Insert)n++,this._diffRows.push(...h(o[1].join("\n"),e[n][1].join("\n"))),t+=e[n][1].length,a.push(...e[n][1]);else for(const e of o[1])this._diffRows.push(u(e,"deletion"))}}this._maxLineDigits=Math.ceil(Math.log10(Math.max(n,o)));let d="";d=N(1===t?M.sInsertion:M.sInsertions,{PH1:t});let l="";function c(e,t,i){const s=[];if(!t){for(let t=0;t<3&&t<e.length;t++)s.push(u(e[t],"equal"));e.length>7&&!i&&s.push(u(N(M.SkippingDMatchingLines,{PH1:e.length-6}),"spacer"))}if(!i){const i=Math.max(e.length-3-1,t?0:3);let r=e.length-3-1;t||(r-=3),r>0&&(o+=r,n+=r);for(let t=i;t<e.length;t++)s.push(u(e[t],"equal"))}return s}function h(e,t){const s=i.DiffWrapper.charDiff(e,t,!0),n=[u("","deletion")],o=[u("","addition")];for(const e of s){const t=e[1],s=e[0],r=s===i.Operation.Equal?"":"inner-diff",a=t.split("\n");for(let e=0;e<a.length;e++)e>0&&s!==i.Operation.Insert&&n.push(u("","deletion")),e>0&&s!==i.Operation.Delete&&o.push(u("","addition")),a[e]&&(s!==i.Operation.Insert&&n[n.length-1].tokens.push({text:a[e],className:r}),s!==i.Operation.Delete&&o[o.length-1].tokens.push({text:a[e],className:r}))}return n.concat(o)}function u(e,t){return"addition"===t&&n++,"deletion"===t&&o++,"equal"===t&&(o++,n++),{baselineLineNumber:o,currentLineNumber:n,tokens:e?[{text:e,className:"inner-diff"}]:[],type:t}}l=N(1===s?M.sDeletion:M.sDeletions,{PH1:s}),this._diffStats.setText(`${d} ${l}`),this._toolbar.setEnabled(!0),this._emptyWidget.hideWidget(),this._editor.operation((()=>{this._editor.showWidget(),this._editor.setHighlightMode({name:"devtools-diff",diffRows:this._diffRows,mimeType:this._selectedUISourceCode.mimeType(),baselineLines:r,currentLines:a}),this._editor.setText(this._diffRows.map((e=>e.tokens.map((e=>e.text)).join(""))).join("\n")),this._editor.setLineNumberFormatter(this._lineFormatter.bind(this)),this._editor.updateDiffGutter(this._diffRows)}))}_lineFormatter(e){const t=this._diffRows[e-1];let i="deletion"===t.type,s="addition"===t.type;"equal"===t.type&&(i=!0,s=!0);return(i?String(t.baselineLineNumber):"").padStart(this._maxLineDigits," ")+" "+(s?String(t.currentLineNumber):"").padStart(this._maxLineDigits," ")}}var W=Object.freeze({__proto__:null,UIStrings:M,ChangesView:R,DiffUILocationRevealer:class{async reveal(e,t){if(!(e instanceof u.DiffUILocation))throw new Error("Internal error: not a diff ui location");await h.ViewManager.instance().showView("changes.changes"),R.instance()._changesSidebar.selectUISourceCode(e.uiSourceCode,t)}}});export{S as ChangesHighlighter,v as ChangesSidebar,E as ChangesTextEditor,W as ChangesView};
