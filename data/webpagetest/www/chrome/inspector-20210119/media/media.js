import{DataGrid as e}from"../data_grid/data_grid.js";import{i18n as t}from"../i18n/i18n.js";import{JSONView as s}from"../source_frame/source_frame.js";import{UIUtils as i,Widget as a,Utils as r,Toolbar as n,ListModel as o,SoftDropDown as l,TabbedPane as d,TreeOutline as h,Icon as c,ContextMenu as _,Panel as m}from"../ui/ui.js";import{SDKModel as u}from"../sdk/sdk.js";import{Color as p,Settings as g,ObjectWrapper as v}from"../common/common.js";import{Platform as y}from"../host/host.js";import{FlameChart as b}from"../perf_ui/perf_ui.js";import{ThemeSupport as E}from"../theme_support/theme_support.js";const f={timestamp:"Timestamp",eventName:"Event name",value:"Value",eventDisplay:"Event display"},w=t.registerUIStrings("media/EventDisplayTable.js",f),T=t.getLocalizedString.bind(void 0,w);const P={Timestamp:"displayTimestamp",Event:"event",Value:"value"};class k extends e.DataGridNode{constructor(e){super(e,!1),this._expandableElement=null}createCell(e){const t=this.createTD(e),a=this.data[e];if(e===P.Value){const e=t.createChild("div","event-display-table-contents-json-wrapper");this._expandableElement=new s.JSONView(new s.ParsedJSON(a,"",""),!0),this._expandableElement.markAsRoot(),this._expandableElement.show(e)}else t.classList.add("event-display-table-basic-text-table-entry"),i.createTextChild(t,a);return t}}class S extends a.VBox{constructor(){super(),this.registerRequiredCSS("media/eventDisplayTable.css",{enableLegacyPatching:!1}),this.contentElement.classList.add("event-display-table-contents-table-container"),this._dataGrid=this._createDataGrid([{id:P.Timestamp,title:T(f.timestamp),weight:1,sortable:!1},{id:P.Event,title:T(f.eventName),weight:2,sortable:!1},{id:P.Value,title:T(f.value),weight:7,sortable:!1}]),this._firstEventTime=0,this._dataGrid.setStriped(!0),this._dataGrid.asWidget().show(this.contentElement)}_createDataGrid(t){const s=[];for(const e of t)s.push(S._convertToGridDescriptor(e));const i=new e.DataGridImpl({displayName:T(f.eventDisplay),columns:s,deleteCallback:void 0,editCallback:void 0,refreshCallback:void 0});return i.asWidget().contentElement.classList.add("no-border-top-datagrid"),i}onEvent(e){0===this._firstEventTime&&"number"==typeof e.timestamp&&(this._firstEventTime=e.timestamp);const t=(e=this._subtractFirstEventTime(e)).value;try{const s=JSON.parse(t);e.event=s.event,delete s.event,e.value=s;const i=new k(e),a=this._dataGrid.scrollContainer,r=a.scrollTop===a.scrollHeight-a.offsetHeight;this._dataGrid.rootNode().appendChild(i),r&&(a.scrollTop=a.scrollHeight)}catch(e){}}_subtractFirstEventTime(e){return"number"==typeof e.timestamp&&(e.displayTimestamp=(e.timestamp-this._firstEventTime).toFixed(3)),e}static _convertToGridDescriptor(t){return{id:t.id,title:t.title,sortable:t.sortable,weight:t.weight||0,sort:e.Order.Ascending}}}var D=Object.freeze({__proto__:null,UIStrings:f,EventDisplayColumnConfig:undefined,MediaEventColumnKeys:P,EventNode:k,PlayerEventsView:S});const M={PlayerPropertiesChanged:Symbol("PlayerPropertiesChanged"),PlayerEventsAdded:Symbol("PlayerEventsAdded"),PlayerMessagesLogged:Symbol("PlayerMessagesLogged"),PlayerErrorsRaised:Symbol("PlayerErrorsRaised"),PlayersCreated:Symbol("PlayersCreated")};class x extends u.SDKModel{constructor(e){super(e),this._enabled=!1,this._agent=e.mediaAgent(),e.registerMediaDispatcher(this)}async resumeModel(){if(!this._enabled)return Promise.resolve();await this._agent.invoke_enable()}ensureEnabled(){this._agent.invoke_enable(),this._enabled=!0}playerPropertiesChanged(e){this.dispatchEventToListeners(M.PlayerPropertiesChanged,e)}playerEventsAdded(e){this.dispatchEventToListeners(M.PlayerEventsAdded,e)}playerMessagesLogged(e){this.dispatchEventToListeners(M.PlayerMessagesLogged,e)}playerErrorsRaised(e){this.dispatchEventToListeners(M.PlayerErrorsRaised,e)}playersCreated({players:e}){this.dispatchEventToListeners(M.PlayersCreated,e)}}u.SDKModel.register(x,u.Capability.DOM,!1);var C=Object.freeze({__proto__:null,PlayerEvent:undefined,ProtocolTriggers:M,MediaModel:x});function L(e,t){const s=Math.pow(10,3-t),i=Math.pow(10,Math.max(0,t));return Math.round(e/s)/i+" s"}class I{constructor(e,t,s,i){this._min=e,this._max=t,this._low=this._min,this._high=this._max,this._maxRange=s,this._minRange=i}get low(){return this._low}get high(){return this._high}get min(){return this._min}get max(){return this._max}get range(){return this._high-this._low}_reassertBounds(){let e=!0;for(;e;){if(e=!1,this.range<this._minRange){e=!0;const t=(this._minRange-this.range)/2;this._high+=t,this._low-=t}this._low<this._min&&(e=!0,this._low=this._min),this._high>this._max&&(e=!0,this._high=this._max)}}zoomOut(e,t){const s=this._high-this._low,i=s*Math.pow(1.1,e)-s,a=i*t,r=i-a;this._low-=a,this._high+=r,this._reassertBounds()}zoomIn(e,t){const s=this._high-this._low;if(this.range<=this._minRange)return;const i=s-s/Math.pow(1.1,e),a=i*t,r=i-a;this._low+=a,this._high-=r,this._reassertBounds()}addMax(e){const t=this._high-this._low,s=this._high===this._max,i=this._low===this._min||t>=this._maxRange;this._max+=e,s&&i&&(this._high=this._max),this._reassertBounds()}pushMaxAtLeastTo(e){return this._max<e&&(this.addMax(e-this._max),!0)}}var V=Object.freeze({__proto__:null,FormatMillisecondsToSeconds:L,Bounds:I});const F="11px "+y.fontFamily(),N=E.instance().patchColorText("#444",E.ColorUsage.Foreground),R={height:20,padding:2,collapsible:!1,font:F,color:N,backgroundColor:"rgba(100 0 0 / 10%)",nestingLevel:0,itemsHeight:20,shareHeaderLine:!1,useFirstLineForOverview:!1,useDecoratorsForOverview:!1},B=["#ffba08","#faa307","#f48c06","#e85d04","#dc2f02","#d00000","#9d0208"],A=["#7400b8","#6930c3","#5e60ce","#5390d9","#4ea8de","#48bfe3","#56cfe1","#64dfdf"];function O(e){const t=p.Color.parse(e);return t&&t.hsla()[2]<.5?"#eee":"#444"}class z{constructor(e,t,s={color:void 0,duration:void 0,hoverData:{},level:0,name:"",startTime:0}){this._timelineData=e,this._setLive=t.setLive,this._setComplete=t.setComplete,this._updateMaxTime=t.updateMaxTime,this._selfIndex=this._timelineData.entryLevels.length,this._live=!1;const i=void 0===s.duration?0:s.duration;this._timelineData.entryLevels.push(s.level||0),this._timelineData.entryStartTimes.push(s.startTime||0),this._timelineData.entryTotalTimes.push(i),-1===i&&(this.endTime=-1),this._title=s.name||"",this._color=s.color||B[0],this._fontColor=O(this._color),this._hoverData=s.hoverData||{}}decorate(e){e.createChild("span").textContent="Name: "+this._title,e.createChild("br");const t=L(this.startTime,2);if(this._live)e.createChild("span").textContent=`Duration: ${t} - LIVE!`;else if(isNaN(this.duration))e.createChild("span").textContent="Time: "+t;else{const s=L(this.duration+this.startTime,2);e.createChild("span").textContent=`Duration: ${t} - ${s}`}}set endTime(e){if(-1===e)this._timelineData.entryTotalTimes[this._selfIndex]=this._setLive(this._selfIndex),this._live=!0;else{this._live=!1;const t=e-this._timelineData.entryStartTimes[this._selfIndex];this._timelineData.entryTotalTimes[this._selfIndex]=t,this._setComplete(this._selfIndex),this._updateMaxTime(e)}}get id(){return this._selfIndex}set level(e){this._timelineData.entryLevels[this._selfIndex]=e}set title(e){this._title=e}get title(){return this._title}set color(e){this._color=e,this._fontColor=O(this._color)}get color(){return this._color}get fontColor(){return this._fontColor}get startTime(){return this._timelineData.entryStartTimes[this._selfIndex]}get duration(){return this._timelineData.entryTotalTimes[this._selfIndex]}get live(){return this._live}}class U extends a.VBox{constructor(){super(),this._intervalTimer=0,this._lastTimestamp=0,this._canTick=!0,this._ticking=!1,this._isShown=!1,this._bounds=new I(0,1e3,3e4,1e3),this._dataProvider=new H(this._bounds,this._updateMaxTime.bind(this)),this._delegate=new j,this._chartGroupExpansionSetting=g.Settings.instance().createSetting("mediaFlameChartGroupExpansion",{}),this._chart=new b.FlameChart(this._dataProvider,this._delegate,this._chartGroupExpansionSetting),this._chart.disableRangeSelection(),this._chart.bindCanvasEvent("wheel",(e=>{this._onScroll(e)})),this._chart.show(this.contentElement)}addMarker(e){e.duration=NaN,this.startEvent(e)}startEvent(e){void 0===e.duration&&(e.duration=-1);const t=e.startTime||0,s=this._dataProvider.startEvent(e);return this._updateMaxTime(t),s}addGroup(e,t){this._dataProvider.addGroup(e,t)}_updateMaxTime(e){this._bounds.pushMaxAtLeastTo(e)&&this._updateRender()}_onScroll(e){const t=Math.round(e.deltaY/50),s=e.offsetX/e.srcElement.clientWidth;t>0?this._bounds.zoomOut(t,s):this._bounds.zoomIn(-t,s),this._updateRender()}willHide(){this._isShown=!1,this._ticking&&this._stop()}wasShown(){this._isShown=!0,this._canTick&&!this._ticking&&this._start()}set canTick(e){this._canTick=e,this._ticking&&!e&&this._stop(),!this._ticking&&this._isShown&&e&&this._start()}_start(){0===this._lastTimestamp&&(this._lastTimestamp=Date.now()),0!==this._intervalTimer||this._stoppedPermanently||(this._intervalTimer=window.setInterval(this._updateRender.bind(this),16),this._ticking=!0)}_stop(e=!1){window.clearInterval(this._intervalTimer),this._intervalTimer=0,e&&(this._stoppedPermanently=!0),this._ticking=!1}_updateRender(){if(this._ticking){const e=Date.now(),t=e-this._lastTimestamp;this._lastTimestamp=e,this._bounds.addMax(t)}this._dataProvider.updateMaxTime(this._bounds),this._chart.setWindowTimes(this._bounds.low,this._bounds.high,!0),this._chart.scheduleUpdate()}}class j{constructor(){}windowChanged(e,t,s){}updateRangeSelection(e,t){}updateSelectedGroup(e,t){}}class H{constructor(e,t){this._updateMaxTimeHandle=t,this._bounds=e,this._liveEvents=new Set,this._eventMap=new Map,this._timelineData=new b.TimelineData([],[],[],[]),this._maxLevel=0}addGroup(e,t){this._timelineData.groups&&this._timelineData.groups.push({name:e,startLevel:this._maxLevel,expanded:!0,selectable:!1,style:R,track:null}),this._maxLevel+=t}startEvent(e){if(e.level=e.level||0,e.level>this._maxLevel)throw`level ${e.level} is above the maximum allowed of ${this._maxLevel}`;const t=new z(this._timelineData,{setLive:this._setLive.bind(this),setComplete:this._setComplete.bind(this),updateMaxTime:this._updateMaxTimeHandle},e);return this._eventMap.set(t.id,t),t}_setLive(e){return this._liveEvents.add(e),this._bounds.max}_setComplete(e){this._liveEvents.delete(e)}updateMaxTime(e){this._bounds=e;for(const e of this._liveEvents.entries())this._eventMap.get(e[0]).endTime=-1}maxStackDepth(){return this._maxLevel+1}timelineData(){return this._timelineData}minimumBoundary(){return this._bounds.low}totalTime(){return this._bounds.high}entryColor(e){return this._eventMap.get(e).color}textColor(e){return this._eventMap.get(e).fontColor}entryTitle(e){return this._eventMap.get(e).title}entryFont(e){return F}decorateEntry(e,t,s,i,a,r,n,o,l){return!1}forceDecoration(e){return!1}prepareHighlightedEntryInfo(e){const t=document.createElement("div");return this._eventMap.get(e).decorate(t),t}formatValue(e,t){return e+=Math.round(this._bounds.low),this._bounds.range<2800?L(e,2):this._bounds.range<3e4?L(e,1):L(e,0)}canJumpToEntry(e){return!1}navStartTimes(){return new Map}}var G=Object.freeze({__proto__:null,HotColorScheme:B,ColdColorScheme:A,EventProperties:undefined,Event:z,TickingFlameChart:U});const $={playbackStatus:"Playback Status",bufferingStatus:"Buffering Status"},W=t.registerUIStrings("media/EventTimelineView.js",$),J=t.getLocalizedString.bind(void 0,W);class K extends U{constructor(){super(),this._normalizedTimestamp=-1.5,this.addGroup(J($.playbackStatus),2),this.addGroup(J($.bufferingStatus),2),this._playbackStatusLastEvent=null,this._audioBufferingStateEvent=null,this._videoBufferingStateEvent=null}_ensureNoPreviousPlaybackEvent(e){null!==this._playbackStatusLastEvent&&(this._playbackStatusLastEvent.endTime=e,this._playbackStatusLastEvent=null)}_onPlaybackEvent(e,t){switch(e.event){case"kPlay":this.canTick=!0,this._ensureNoPreviousPlaybackEvent(t),this._playbackStatusLastEvent=this.startEvent({level:0,startTime:t,name:"Play"});break;case"kPause":this._ensureNoPreviousPlaybackEvent(t),this._playbackStatusLastEvent=this.startEvent({level:0,startTime:t,name:"Pause",color:B[1]});break;case"kWebMediaPlayerDestroyed":this.canTick=!1,this._ensureNoPreviousPlaybackEvent(t),this.addMarker({level:1,startTime:t,name:"Destroyed",color:B[4]});break;case"kSuspended":this.canTick=!1,this._ensureNoPreviousPlaybackEvent(t),this._playbackStatusLastEvent=this.startEvent({level:1,startTime:t,name:"Suspended",color:B[3]});break;case"kEnded":this._ensureNoPreviousPlaybackEvent(t),this._playbackStatusLastEvent=this.startEvent({level:1,startTime:t,name:"Ended",color:B[2]});break;default:throw"_onPlaybackEvent cant handle "+e.event}}_bufferedEnough(e){return"BUFFERING_HAVE_ENOUGH"===e.state}_onBufferingStatus(e,t){let s=null,i=null;switch(e.event){case"kBufferingStateChanged":s=e.value.audio_buffering_state,i=e.value.video_buffering_state,s&&(null!==this._audioBufferingStateEvent&&(this._audioBufferingStateEvent.endTime=t,this._audioBufferingStateEvent=null),this._bufferedEnough(s)||(this._audioBufferingStateEvent=this.startEvent({level:3,startTime:t,name:"Audio Buffering",color:A[1]}))),i&&(null!==this._videoBufferingStateEvent&&(this._videoBufferingStateEvent.endTime=t,this._videoBufferingStateEvent=null),this._bufferedEnough(i)||(this._videoBufferingStateEvent=this.startEvent({level:2,startTime:t,name:"Video Buffering",color:A[0]})));break;default:throw"_onPlaybackEvent cant handle "+e.event}}onEvent(e){-1.5===this._normalizedTimestamp&&(this._normalizedTimestamp=Number(e.timestamp));const t=1e3*(Number(e.timestamp)-this._normalizedTimestamp);switch(e.event){case"kPlay":case"kPause":case"kWebMediaPlayerDestroyed":case"kSuspended":case"kEnded":return this._onPlaybackEvent(e,t);case"kBufferingStateChanged":return this._onBufferingStatus(e,t)}}}const q={default:"Default",custom:"Custom",all:"All",error:"Error",warning:"Warning",info:"Info",debug:"Debug",logLevel:"Log level:",filterLogMessages:"Filter log messages"},Y=t.registerUIStrings("media/PlayerMessagesView.js",q),X=t.getLocalizedString.bind(void 0,Y),Q=1,Z=2,ee=4,te=8,se=7,ie=15;class ae extends v.ObjectWrapper{constructor(e,t){super(),this._items=e,this._view=t,this._itemMap=new Map,this._hiddenLevels=[],this._bitFieldValue=se,this._savedBitFieldValue=se,this._defaultTitle=X(q.default),this._customTitle=X(q.custom),this._allTitle=X(q.all),this.elementsForItems=new WeakMap}defaultTitle(){return this._defaultTitle}setDefault(e){e.selectItem(this._items.at(0))}populate(){this._items.insert(this._items.length,{title:this._defaultTitle,overwrite:!0,stringValue:"",value:se,selectable:void 0}),this._items.insert(this._items.length,{title:this._allTitle,overwrite:!0,stringValue:"",value:ie,selectable:void 0}),this._items.insert(this._items.length,{title:X(q.error),overwrite:!1,stringValue:"error",value:Q,selectable:void 0}),this._items.insert(this._items.length,{title:X(q.warning),overwrite:!1,stringValue:"warning",value:Z,selectable:void 0}),this._items.insert(this._items.length,{title:X(q.info),overwrite:!1,stringValue:"info",value:ee,selectable:void 0}),this._items.insert(this._items.length,{title:X(q.debug),overwrite:!1,stringValue:"debug",value:te,selectable:void 0})}_updateCheckMarks(){this._hiddenLevels=[];for(const[e,t]of this._itemMap)if(!t.overwrite){const s=this.elementsForItems.get(t);s&&s.firstChild&&s.firstChild.remove(),s&&e&this._bitFieldValue?i.createTextChild(s.createChild("div"),"✓"):this._hiddenLevels.push(t.stringValue)}}titleFor(e){if(e.overwrite?this._bitFieldValue=e.value:this._bitFieldValue^=e.value,this._bitFieldValue===se)return this._defaultTitle;if(this._bitFieldValue===ie)return this._allTitle;const t=this._itemMap.get(this._bitFieldValue);return t?t.title:this._customTitle}createElementForItem(e){const t=document.createElement("div"),s=r.createShadowRootWithCoreStyles(t,{cssFile:"media/playerMessagesView.css",enableLegacyPatching:!0,delegatesFocus:void 0}).createChild("div","media-messages-level-dropdown-element"),a=s.createChild("div","media-messages-level-dropdown-checkbox"),n=s.createChild("span","media-messages-level-dropdown-text");return i.createTextChild(n,e.title),this.elementsForItems.set(e,a),this._itemMap.set(e.value,e),this._updateCheckMarks(),this._view.regenerateMessageDisplayCss(this._hiddenLevels),t}isItemSelectable(e){return!0}itemSelected(e){this._updateCheckMarks(),this._view.regenerateMessageDisplayCss(this._hiddenLevels)}highlightedItemChanged(e,t,s,i){}}class re extends a.VBox{constructor(){super(),this.registerRequiredCSS("media/playerMessagesView.css",{enableLegacyPatching:!0}),this._headerPanel=this.contentElement.createChild("div","media-messages-header"),this._bodyPanel=this.contentElement.createChild("div","media-messages-body"),this._buildToolbar()}_buildToolbar(){const e=new n.Toolbar("media-messages-toolbar",this._headerPanel);e.appendText(X(q.logLevel)),e.appendToolbarItem(this._createDropdown()),e.appendSeparator(),e.appendToolbarItem(this._createFilterInput())}_createDropdown(){const e=new o.ListModel;this._messageLevelSelector=new ae(e,this);const t=new l.SoftDropDown(e,this._messageLevelSelector);t.setRowHeight(18),this._messageLevelSelector.populate(),this._messageLevelSelector.setDefault(t);const s=new n.ToolbarItem(t.element);return s.element.classList.add("toolbar-has-dropdown"),s.setEnabled(!0),s.setTitle(this._messageLevelSelector.defaultTitle()),s}_createFilterInput(){const e=new n.ToolbarInput(X(q.filterLogMessages));return e.addEventListener(n.ToolbarInput.Event.TextChanged,(e=>{this._filterByString(e)}),this),e}regenerateMessageDisplayCss(e){const t=this._bodyPanel.getElementsByClassName("media-messages-message-container");for(const s of t)this._matchesHiddenLevels(s,e)?s.classList.add("media-messages-message-unselected"):s.classList.remove("media-messages-message-unselected")}_matchesHiddenLevels(e,t){for(const s of t)if(e.classList.contains("media-message-"+s))return!0;return!1}_filterByString(e){const t=e.data,s=this._bodyPanel.getElementsByClassName("media-messages-message-container");for(const e of s)""===t||e.textContent&&e.textContent.includes(t)?e.classList.remove("media-messages-message-filtered"):e.classList.add("media-messages-message-filtered")}addMessage(e){const t=this._bodyPanel.createChild("div","media-messages-message-container media-message-"+e.level);i.createTextChild(t,e.message)}}const ne={video:"Video",audio:"Audio",track:"Track",decoder:"Decoder",properties:"Properties",textTrack:"Text track",noTextTracks:"No text tracks",resolution:"Resolution",fileSize:"File size",bitrate:"Bitrate",duration:"Duration",startTime:"Start time",streaming:"Streaming",playbackFrameUrl:"Playback frame URL",playbackFrameTitle:"Playback frame title",singleoriginPlayback:"Single-origin playback",rangeHeaderSupport:"Range header support",frameRate:"Frame rate",videoPlaybackRoughness:"Video playback roughness",videoFreezingScore:"Video freezing score",decoderName:"Decoder name",noDecoder:"No decoder",hardwareDecoder:"Hardware decoder",decryptingDemuxer:"Decrypting demuxer",encoderName:"Encoder name",noEncoder:"No encoder",hardwareEncoder:"Hardware encoder"},oe=t.registerUIStrings("media/PlayerPropertiesView.js",ne),le=t.getLocalizedString.bind(void 0,oe),de={kResolution:"kResolution",kTotalBytes:"kTotalBytes",kBitrate:"kBitrate",kMaxDuration:"kMaxDuration",kStartTime:"kStartTime",kIsVideoEncrypted:"kIsVideoEncrypted",kIsStreaming:"kIsStreaming",kFrameUrl:"kFrameUrl",kFrameTitle:"kFrameTitle",kIsSingleOrigin:"kIsSingleOrigin",kIsRangeHeaderSupported:"kIsRangeHeaderSupported",kVideoDecoderName:"kVideoDecoderName",kAudioDecoderName:"kAudioDecoderName",kIsPlatformVideoDecoder:"kIsPlatformVideoDecoder",kIsPlatformAudioDecoder:"kIsPlatformAudioDecoder",kVideoEncoderName:"kVideoEncoderName",kIsPlatformVideoEncoder:"kIsPlatformVideoEncoder",kIsVideoDecryptingDemuxerStream:"kIsVideoDecryptingDemuxerStream",kIsAudioDecryptingDemuxerStream:"kIsAudioDecryptingDemuxerStream",kAudioTracks:"kAudioTracks",kTextTracks:"kTextTracks",kVideoTracks:"kVideoTracks",kFramerate:"kFramerate",kVideoPlaybackRoughness:"kVideoPlaybackRoughness",kVideoPlaybackFreezing:"kVideoPlaybackFreezing"};class he extends a.VBox{constructor(e){super(),this.contentElement.classList.add("media-property-renderer"),this._title=this.contentElement.createChild("span","media-property-renderer-title"),this._contents=this.contentElement.createChild("span","media-property-renderer-contents"),i.createTextChild(this._title,e),this._title=e,this._value=null,this._pseudo_color_protection_element=null,this.contentElement.classList.add("media-property-renderer-hidden")}updateData(e,t){if(""===t||null===t)return this._updateData(e,null);try{t=JSON.parse(t)}catch(e){}return this._updateData(e,t)}_updateData(e,t){if(null===t)this.changeContents(null);else{if(this._value===t)return;this._value=t,this.changeContents(t)}}changeContents(e){if(null===e)this.contentElement.classList.add("media-property-renderer-hidden"),null===this._pseudo_color_protection_element&&(this._pseudo_color_protection_element=document.createElement("div"),this._pseudo_color_protection_element.classList.add("media-property-renderer"),this._pseudo_color_protection_element.classList.add("media-property-renderer-hidden"),this.contentElement.parentNode.insertBefore(this._pseudo_color_protection_element,this.contentElement));else{null!==this._pseudo_color_protection_element&&(this._pseudo_color_protection_element.remove(),this._pseudo_color_protection_element=null),this.contentElement.classList.remove("media-property-renderer-hidden"),this._contents.removeChildren();const t=document.createElement("span");t.textContent=e,this._contents.appendChild(t)}}}class ce extends he{constructor(e,t){super(le(e)),this._formatfunction=t}_updateData(e,t){null===t?this.changeContents(null):this.changeContents(this._formatfunction(t))}}class _e extends he{constructor(e,t){super(le(e)),this.changeContents(t)}}class me extends a.VBox{constructor(e){super(),this.contentElement.classList.add("media-attributes-view");for(const t of e)t.show(this.contentElement)}}class ue{constructor(e,t){this._type=t,this._view=e}updateData(e,t){const s=this._view.GetTabs(this._type),i=JSON.parse(t);let a=1;for(const e of i)this.addNewTab(s,e,a),a++}addNewTab(e,t,s){const i=[];for(const[e,s]of Object.entries(t))i.push(new _e(e,s));const a=new me(i);e.addNewTab(s,a)}}class pe extends ue{constructor(e){super(e,"video")}}class ge extends ue{constructor(e){super(e,"text")}}class ve extends ue{constructor(e){super(e,"audio")}}const ye={Video:le(ne.video),Audio:le(ne.audio)};class be extends d.TabbedPane{constructor(e,t=le(ne.track)){super(),this._decoderName=e,this._trackName=t}addNewTab(e,t){const s=le(ne.track);this.appendTab("Track"+e,`${this._trackName} #${e}`,t,`${this._decoderName} ${s} #${e}`)}}class Ee extends be{constructor(e,t){super(e);const s=`${e} ${le(ne.decoder)}`,i=`${s} ${le(ne.properties)}`;this.appendTab("DecoderProperties",s,t,i)}}class fe extends a.VBox{constructor(e,t){super(),this._isPlaceholder=!0,this._wrapping=e,this._wrapping.appendTab("_placeholder",t,new a.VBox,t),this._wrapping.show(this.contentElement)}addNewTab(e,t){this._isPlaceholder&&(this._wrapping.closeTab("_placeholder"),this._isPlaceholder=!1),this._wrapping.addNewTab(e,t)}}class we extends a.VBox{constructor(){super(),this.contentElement.classList.add("media-properties-frame"),this.registerRequiredCSS("media/playerPropertiesView.css",{enableLegacyPatching:!0}),this._mediaElements=[],this._videoDecoderElements=[],this._audioDecoderElements=[],this._textTrackElements=[],this._attributeMap=new Map,this.populateAttributesAndElements(),this._videoProperties=new me(this._mediaElements),this._videoDecoderProperties=new me(this._videoDecoderElements),this._audioDecoderProperties=new me(this._audioDecoderElements),this._videoProperties.show(this.contentElement),this._videoDecoderTabs=new Ee(ye.Video,this._videoDecoderProperties),this._videoDecoderTabs.show(this.contentElement),this._audioDecoderTabs=new Ee(ye.Audio,this._audioDecoderProperties),this._audioDecoderTabs.show(this.contentElement),this._textTrackTabs=null}_lazyCreateTrackTabs(){let e=this._textTrackTabs;if(null===e){const t=new be(le(ne.textTrack));e=new fe(t,le(ne.noTextTracks)),e.show(this.contentElement),this._textTracksTabs=e}return e}GetTabs(e){if("audio"===e)return this._audioDecoderTabs;if("video"===e)return this._videoDecoderTabs;if("text"===e)return this._lazyCreateTrackTabs();throw new Error("Unreachable")}onProperty(e){const t=this._attributeMap.get(e.name);if(!t)throw new Error(`Player property "${e.name}" not supported.`);t.updateData(e.name,e.value)}formatKbps(e){if(""===e)return"0 kbps";return Math.floor(Number(e)/1e3)+" kbps"}formatTime(e){if(""===e)return"0:00";const t=new Date;return t.setSeconds(Number(e)),t.toISOString().substr(11,8)}formatFileSize(e){if(""===e)return"0 bytes";const t=Number(e);if(t<1e3)return e+" bytes";const s=Math.floor(Math.log10(t)/3),i=["bytes","kB","MB","GB","TB"][s];return`${(t/Math.pow(1e3,s)).toFixed(2)} ${i}`}populateAttributesAndElements(){const e=new he(le(ne.resolution));this._mediaElements.push(e),this._attributeMap.set(de.kResolution,e);const t=new ce(le(ne.fileSize),this.formatFileSize);this._mediaElements.push(t),this._attributeMap.set(de.kTotalBytes,t);const s=new ce(le(ne.bitrate),this.formatKbps);this._mediaElements.push(s),this._attributeMap.set(de.kBitrate,s);const i=new ce(le(ne.duration),this.formatTime);this._mediaElements.push(i),this._attributeMap.set(de.kMaxDuration,i);const a=new he(le(ne.startTime));this._mediaElements.push(a),this._attributeMap.set(de.kStartTime,a);const r=new he(le(ne.streaming));this._mediaElements.push(r),this._attributeMap.set(de.kIsStreaming,r);const n=new he(le(ne.playbackFrameUrl));this._mediaElements.push(n),this._attributeMap.set(de.kFrameUrl,n);const o=new he(le(ne.playbackFrameTitle));this._mediaElements.push(o),this._attributeMap.set(de.kFrameTitle,o);const l=new he(le(ne.singleoriginPlayback));this._mediaElements.push(l),this._attributeMap.set(de.kIsSingleOrigin,l);const d=new he(le(ne.rangeHeaderSupport));this._mediaElements.push(d),this._attributeMap.set(de.kIsRangeHeaderSupported,d);const h=new he(le(ne.frameRate));this._mediaElements.push(h),this._attributeMap.set(de.kFramerate,h);const c=new he(le(ne.videoPlaybackRoughness));this._mediaElements.push(c),this._attributeMap.set(de.kVideoPlaybackRoughness,c);const _=new he(le(ne.videoFreezingScore));this._mediaElements.push(_),this._attributeMap.set(de.kVideoPlaybackFreezing,_);const m=new _e(le(ne.decoderName),le(ne.noDecoder));this._videoDecoderElements.push(m),this._attributeMap.set(de.kVideoDecoderName,m);const u=new he(le(ne.hardwareDecoder));this._videoDecoderElements.push(u),this._attributeMap.set(de.kIsPlatformVideoDecoder,u);const p=new _e(le(ne.encoderName),le(ne.noEncoder));this._videoDecoderElements.push(p),this._attributeMap.set(de.kVideoEncoderName,p);const g=new he(le(ne.hardwareEncoder));this._videoDecoderElements.push(g),this._attributeMap.set(de.kIsPlatformVideoEncoder,g);const v=new he(le(ne.decryptingDemuxer));this._videoDecoderElements.push(v),this._attributeMap.set(de.kIsVideoDecryptingDemuxerStream,v);const y=new pe(this);this._attributeMap.set(de.kVideoTracks,y);const b=new _e(le(ne.decoderName),le(ne.noDecoder));this._audioDecoderElements.push(b),this._attributeMap.set(de.kAudioDecoderName,b);const E=new he(le(ne.hardwareDecoder));this._audioDecoderElements.push(E),this._attributeMap.set(de.kIsPlatformAudioDecoder,E);const f=new he(le(ne.decryptingDemuxer));this._audioDecoderElements.push(f),this._attributeMap.set(de.kIsAudioDecryptingDemuxerStream,f);const w=new ve(this);this._attributeMap.set(de.kAudioTracks,w);const T=new ge(this);this._attributeMap.set(de.kTextTracks,T)}}var Te=Object.freeze({__proto__:null,UIStrings:ne,PlayerPropertyKeys:de,PropertyRenderer:he,FormattedPropertyRenderer:ce,DefaultPropertyRenderer:_e,DimensionPropertyRenderer:class extends he{constructor(e){super(le(e)),this._width=0,this._height=0}_updateData(e,t){let s=!1;"width"===e&&Number(t)!==this._width&&(this._width=Number(t),s=!0),"height"===e&&Number(t)!==this._height&&(this._height=Number(t),s=!0),0===this._width||0===this._height?this.changeContents(null):s&&this.changeContents(`${this._width}×${this._height}`)}},AttributesView:me,TrackManager:ue,VideoTrackManager:pe,TextTrackManager:ge,AudioTrackManager:ve,PlayerPropertiesView:we});const Pe={properties:"Properties",playerProperties:"Player properties",events:"Events",playerEvents:"Player events",messages:"Messages",playerMessages:"Player messages",timeline:"Timeline",playerTimeline:"Player timeline"},ke=t.registerUIStrings("media/PlayerDetailView.js",Pe),Se=t.getLocalizedString.bind(void 0,ke),De={Events:"events",Properties:"properties",Messages:"messages",Timeline:"timeline"};class Me extends d.TabbedPane{constructor(){super(),this._eventView=new S,this._propertyView=new we,this._messageView=new re,this._timelineView=new K,this.appendTab(De.Properties,Se(Pe.properties),this._propertyView,Se(Pe.playerProperties)),this.appendTab(De.Events,Se(Pe.events),this._eventView,Se(Pe.playerEvents)),this.appendTab(De.Messages,Se(Pe.messages),this._messageView,Se(Pe.playerMessages)),this.appendTab(De.Timeline,Se(Pe.timeline),this._timelineView,Se(Pe.playerTimeline))}onProperty(e){this._propertyView.onProperty(e)}onError(e){}onMessage(e){this._messageView.addMessage(e)}onEvent(e){this._eventView.onEvent(e),this._timelineView.onEvent(e)}}var xe=Object.freeze({__proto__:null,UIStrings:Pe,PlayerDetailViewTabs:De,PlayerDetailView:Me});const Ce={hidePlayer:"Hide player",hideAllOthers:"Hide all others",savePlayerInfo:"Save player info",players:"Players"},Le=t.registerUIStrings("media/PlayerListView.js",Ce),Ie=t.getLocalizedString.bind(void 0,Le);class Ve extends h.TreeElement{constructor(e,t,s){super(e.playerTitle,!1),this.titleFromUrl=!0,this._playerStatus=e,this._displayContainer=t,this.setLeadingIcons([c.Icon.create("smallicon-videoplayer-playing","media-player")]),this.listItemElement.classList.add("player-entry-tree-element"),this.listItemElement.addEventListener("contextmenu",this._rightClickContextMenu.bind(this,s),!1)}onselect(e){return this._displayContainer.renderMainPanel(this._playerStatus.playerID),!0}_rightClickContextMenu(e,t){const s=new _.ContextMenu(t);return s.headerSection().appendItem(Ie(Ce.hidePlayer),this._hidePlayer.bind(this,e)),s.headerSection().appendItem(Ie(Ce.hideAllOthers),this._hideOthers.bind(this,e)),s.headerSection().appendItem(Ie(Ce.savePlayerInfo),this._savePlayer.bind(this,e)),s.show(),!0}_hidePlayer(e){this._displayContainer.markPlayerForDeletion(e)}_savePlayer(e){this._displayContainer.exportPlayerData(e)}_hideOthers(e){this._displayContainer.markOtherPlayersForDeletion(e)}}class Fe extends a.VBox{constructor(e){super(!0),this._playerStatuses=new Map,this._mainContainer=e,this._sidebarTree=new h.TreeOutlineInShadow,this.contentElement.appendChild(this._sidebarTree.element),this._sidebarTree.registerRequiredCSS("media/playerListView.css",{enableLegacyPatching:!0}),this._playerList=this._addListSection(Ie(Ce.players)),this._playerList.listItemElement.classList.add("player-entry-header")}deletePlayer(e){this._playerList.removeChild(this._playerStatuses.get(e)),this._playerStatuses.delete(e)}_addListSection(e){const t=new h.TreeElement(e,!0);return t.listItemElement.classList.add("storage-group-list-item"),t.setCollapsible(!1),t.selectable=!1,this._sidebarTree.appendChild(t),t}addMediaElementItem(e){const t=new Ve({playerTitle:e,playerID:e,exists:!0,playing:!1,titleEdited:!1},this._mainContainer,e);this._playerStatuses.set(e,t),this._playerList.appendChild(t)}setMediaElementPlayerTitle(e,t,s){if(this._playerStatuses.has(e)){const i=this._playerStatuses.get(e);s&&!i.titleFromUrl||(i.title=t,i.titleFromUrl=s)}}setMediaElementPlayerIcon(e,t){if(this._playerStatuses.has(e)){this._playerStatuses.get(e).setLeadingIcons([c.Icon.create("smallicon-videoplayer-"+t,"media-player")])}}onProperty(e,t){if(t.name===de.kFrameTitle&&t.value&&this.setMediaElementPlayerTitle(e,t.value,!1),t.name===de.kFrameUrl){const s=t.value.substring(t.value.lastIndexOf("/")+1);this.setMediaElementPlayerTitle(e,s,!0)}}onError(e,t){}onMessage(e,t){}onEvent(e,t){"PLAY"===t.value?this.setMediaElementPlayerIcon(e,"playing"):"PAUSE"===t.value?this.setMediaElementPlayerIcon(e,"paused"):"WEBMEDIAPLAYER_DESTROYED"===t.value&&this.setMediaElementPlayerIcon(e,"destroyed")}}var Ne=Object.freeze({__proto__:null,UIStrings:Ce,PlayerStatus:undefined,PlayerStatusMapElement:undefined,PlayerEntryTreeElement:Ve,PlayerListView:Fe});class Re{constructor(){this._properties=new Map,this._messages=[],this._events=[],this._errors=[]}onProperty(e){this._properties.set(e.name,e.value)}onError(e){this._errors.push(e)}onMessage(e){this._messages.push(e)}onEvent(e){this._events.push(e)}export(){return{properties:this._properties,messages:this._messages,events:this._events,errors:this._errors}}}class Be{constructor(){this._playerDataCollection=new Map}addPlayer(e){this._playerDataCollection.set(e,new Re)}onProperty(e,t){const s=this._playerDataCollection.get(e);s&&s.onProperty(t)}onError(e,t){const s=this._playerDataCollection.get(e);s&&s.onError(t)}onMessage(e,t){const s=this._playerDataCollection.get(e);s&&s.onMessage(t)}onEvent(e,t){const s=this._playerDataCollection.get(e);s&&s.onEvent(t)}exportPlayerData(e){const t=this._playerDataCollection.get(e);if(!t)throw new Error("Unable to find player");return t.export()}deletePlayer(e){this._playerDataCollection.delete(e)}}class Ae extends m.PanelWithSidebar{constructor(){super("Media"),this.registerRequiredCSS("media/mediaView.css",{enableLegacyPatching:!0}),this._detailPanels=new Map,this._deletedPlayers=new Set,this._downloadStore=new Be,this._sidebar=new Fe(this),this._sidebar.show(this.panelSidebarElement()),u.TargetManager.instance().observeModels(x,this)}renderMainPanel(e){if(!this._detailPanels.has(e))return;const t=this.splitWidget().mainWidget();t&&t.detachChildWidgets(),this._detailPanels.get(e).show(this.mainElement())}wasShown(){super.wasShown();for(const e of u.TargetManager.instance().models(x))this._addEventListeners(e)}willHide(){for(const e of u.TargetManager.instance().models(x))this._removeEventListeners(e)}modelAdded(e){this.isShowing()&&this._addEventListeners(e)}modelRemoved(e){this._removeEventListeners(e)}_addEventListeners(e){e.ensureEnabled(),e.addEventListener(M.PlayerPropertiesChanged,this._propertiesChanged,this),e.addEventListener(M.PlayerEventsAdded,this._eventsAdded,this),e.addEventListener(M.PlayerMessagesLogged,this._messagesLogged,this),e.addEventListener(M.PlayerErrorsRaised,this._errorsRaised,this),e.addEventListener(M.PlayersCreated,this._playersCreated,this)}_removeEventListeners(e){e.removeEventListener(M.PlayerPropertiesChanged,this._propertiesChanged,this),e.removeEventListener(M.PlayerEventsAdded,this._eventsAdded,this),e.removeEventListener(M.PlayerMessagesLogged,this._messagesLogged,this),e.removeEventListener(M.PlayerErrorsRaised,this._errorsRaised,this),e.removeEventListener(M.PlayersCreated,this._playersCreated,this)}_onPlayerCreated(e){this._sidebar.addMediaElementItem(e),this._detailPanels.set(e,new Me),this._downloadStore.addPlayer(e)}_propertiesChanged(e){for(const t of e.data.properties)this.onProperty(e.data.playerId,t)}_eventsAdded(e){for(const t of e.data.events)this.onEvent(e.data.playerId,t)}_messagesLogged(e){for(const t of e.data.messages)this.onMessage(e.data.playerId,t)}_errorsRaised(e){for(const t of e.data.errors)this.onError(e.data.playerId,t)}_shouldPropagate(e){return!this._deletedPlayers.has(e)&&this._detailPanels.has(e)}onProperty(e,t){this._shouldPropagate(e)&&(this._sidebar.onProperty(e,t),this._downloadStore.onProperty(e,t),this._detailPanels.get(e).onProperty(t))}onError(e,t){this._shouldPropagate(e)&&(this._sidebar.onError(e,t),this._downloadStore.onError(e,t),this._detailPanels.get(e).onError(t))}onMessage(e,t){this._shouldPropagate(e)&&(this._sidebar.onMessage(e,t),this._downloadStore.onMessage(e,t),this._detailPanels.get(e).onMessage(t))}onEvent(e,t){this._shouldPropagate(e)&&(this._sidebar.onEvent(e,t),this._downloadStore.onEvent(e,t),this._detailPanels.get(e).onEvent(t))}_playersCreated(e){const t=e.data;for(const e of t)this._onPlayerCreated(e)}markPlayerForDeletion(e){this._deletedPlayers.add(e),this._detailPanels.delete(e),this._sidebar.deletePlayer(e),this._downloadStore.deletePlayer(e)}markOtherPlayersForDeletion(e){for(const t of this._detailPanels.keys())t!==e&&this.markPlayerForDeletion(t)}exportPlayerData(e){const t=this._downloadStore.exportPlayerData(e),s="data:application/octet-stream,"+encodeURIComponent(JSON.stringify(t,null,2)),i=document.createElement("a");i.href=s,i.download=e+".json",i.click()}}var Oe=Object.freeze({__proto__:null,TriggerHandler:class{onProperty(e){}onError(e){}onMessage(e){}onEvent(e){}},TriggerDispatcher:class{onProperty(e,t){}onError(e,t){}onMessage(e,t){}onEvent(e,t){}},MainView:Ae});export{Oe as MainView,C as MediaModel,xe as PlayerDetailView,D as PlayerEventsView,Ne as PlayerListView,Te as PlayerPropertiesView,G as TickingFlameChart,V as TickingFlameChartHelpers};
