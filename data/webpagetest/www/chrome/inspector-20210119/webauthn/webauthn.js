import{Settings as t}from"../common/common.js";import{DataGrid as e}from"../data_grid/data_grid.js";import{userMetrics as i,UserMetrics as a}from"../host/host.js";import{i18n as o}from"../i18n/i18n.js";import{SDKModel as n,WebAuthnModel as r}from"../sdk/sdk.js";import{Tooltip as s,UIUtils as c,Widget as h,Toolbar as d,Fragment as l,XLink as u,ARIAUtils as p}from"../ui/ui.js";const b={export:"Export",remove:"Remove",noCredentialsTryCallingSFromYour:"No credentials. Try calling {PH1} from your website.",enableVirtualAuthenticator:"Enable virtual authenticator environment",id:"ID",isResident:"Is Resident",rpId:"RP ID",userHandle:"User Handle",signCount:"Sign Count",actions:"Actions",credentials:"Credentials",useWebauthnForPhishingresistant:"Use WebAuthn for phishing-resistant authentication",learnMore:"Learn more",newAuthenticator:"New authenticator",protocol:"Protocol",transport:"Transport",supportsResidentKeys:"Supports resident keys",add:"Add",addAuthenticator:"Add authenticator",active:"Active",editName:"Edit name",saveName:"Save name",authenticatorS:"Authenticator {PH1}",privateKeypem:"Private key.pem",uuid:"UUID",supportsUserVerification:"Supports user verification",yes:"Yes",no:"No",setSAsTheActiveAuthenticator:"Set {PH1} as the active authenticator"},_=o.registerUIStrings("webauthn/WebauthnPane.ts",b),C=o.getLocalizedString.bind(void 0,_);class m extends e.DataGridNode{constructor(t){super(t)}nodeSelfHeight(){return 24}createCell(t){const e=super.createCell(t);if(s.Tooltip.install(e,e.textContent||""),"actions"!==t)return e;const i=c.createTextButton(C(b.export),(()=>{this.dataGrid&&this.dataGrid.dispatchEventToListeners("ExportCredential",this.data)}));e.appendChild(i);const a=c.createTextButton(C(b.remove),(()=>{this.dataGrid&&this.dataGrid.dispatchEventToListeners("RemoveCredential",this.data)}));return e.appendChild(a),e}}class v extends e.DataGridNode{createCells(t){t.removeChildren();const i=this.createTDWithClass(e.Align.Center);this.dataGrid&&(i.colSpan=this.dataGrid.visibleColumnsArray.length);const a=document.createElement("span",{is:"source-code"});a.textContent="navigator.credentials.create()",a.classList.add("code");const n=o.getFormatLocalizedString(_,b.noCredentialsTryCallingSFromYour,{PH1:a});i.appendChild(n),t.appendChild(i)}}class A extends h.VBox{constructor(){super(!0),this.registerRequiredCSS("webauthn/webauthnPane.css",{enableLegacyPatching:!0}),this.contentElement.classList.add("webauthn-pane"),this._enabled=!1,this._activeAuthId=null,this._hasBeenEnabled=!1,this._dataGrids=new Map,this._availableAuthenticatorSetting=t.Settings.instance().createSetting("webauthnAuthenticators",[]);const e=n.TargetManager.instance().mainTarget();e&&(this._model=e.model(r.WebAuthnModel)),this._createToolbar(),this._authenticatorsView=this.contentElement.createChild("div","authenticators-view"),this._createNewAuthenticatorSection(),this._updateVisibility(!1)}async _loadInitialAuthenticators(){let t=null;const e=this._availableAuthenticatorSetting.get();for(const i of e){if(!this._model)continue;const e=await this._model.addAuthenticator(i);this._addAuthenticatorSection(e,i),i.authenticatorId=e,i.active&&(t=e)}this._availableAuthenticatorSetting.set(e),t&&this._setActiveAuthenticator(t)}async ownerViewDisposed(){this._enableCheckbox&&this._enableCheckbox.setChecked(!1),await this._setVirtualAuthEnvEnabled(!1)}_createToolbar(){this._topToolbarContainer=this.contentElement.createChild("div","webauthn-toolbar-container"),this._topToolbar=new d.Toolbar("webauthn-toolbar",this._topToolbarContainer);const t=C(b.enableVirtualAuthenticator);this._enableCheckbox=new d.ToolbarCheckbox(t,t,this._handleCheckboxToggle.bind(this)),this._topToolbar.appendToolbarItem(this._enableCheckbox)}_createCredentialsDataGrid(t){const i=[{id:"credentialId",title:C(b.id),longText:!0,weight:24},{id:"isResidentCredential",title:C(b.isResident),dataType:e.DataType.Boolean,weight:10},{id:"rpId",title:C(b.rpId)},{id:"userHandle",title:C(b.userHandle)},{id:"signCount",title:C(b.signCount)},{id:"actions",title:C(b.actions)}],a={displayName:C(b.credentials),columns:i,editCallback:void 0,deleteCallback:void 0,refreshCallback:void 0},o=new e.DataGridImpl(a);return o.renderInline(),o.setStriped(!0),o.addEventListener("ExportCredential",this._handleExportCredential,this),o.addEventListener("RemoveCredential",this._handleRemoveCredential.bind(this,t)),this._dataGrids.set(t,o),o}_handleExportCredential(t){this._exportCredential(t.data)}_handleRemoveCredential(t,e){this._removeCredential(t,e.data.credentialId)}async _updateCredentials(t){const e=this._dataGrids.get(t);if(e){if(this._model){const i=await this._model.getCredentials(t);e.rootNode().removeChildren();for(const t of i){const i=new m(t);e.rootNode().appendChild(i)}this._maybeAddEmptyNode(e)}setTimeout(this._updateCredentials.bind(this,t),1e3)}}_maybeAddEmptyNode(t){if(t.rootNode().children.length)return;const e=new v;t.rootNode().appendChild(e)}async _setVirtualAuthEnvEnabled(t){this._enableCheckbox.setEnabled(!1),t&&!this._hasBeenEnabled&&(i.actionTaken(a.Action.VirtualAuthenticatorEnvironmentEnabled),this._hasBeenEnabled=!0),this._enabled=t,this._model&&this._model.setVirtualAuthEnvEnabled(t),t?await this._loadInitialAuthenticators():this._removeAuthenticatorSections(),this._updateVisibility(t),this._enableCheckbox.setEnabled(!0)}_updateVisibility(t){this.contentElement.classList.toggle("enabled",t)}_removeAuthenticatorSections(){this._authenticatorsView.innerHTML="",this._dataGrids.clear()}_handleCheckboxToggle(){this._setVirtualAuthEnvEnabled(!this._enabled)}_updateEnabledTransportOptions(t){if(!this._transportSelect)return;const e=this._transportSelect.value;this._transportSelect.removeChildren();for(const e of t)this._transportSelect.appendChild(new Option(e,e));this._transportSelect.value=e,this._transportSelect.value||(this._transportSelect.selectedIndex=0)}_updateNewAuthenticatorSectionOptions(){this._protocolSelect&&this._residentKeyCheckbox&&this._userVerificationCheckbox&&(this._protocolSelect.value===Protocol.WebAuthn.AuthenticatorProtocol.Ctap2?(this._residentKeyCheckbox.disabled=!1,this._userVerificationCheckbox.disabled=!1,this._updateEnabledTransportOptions([Protocol.WebAuthn.AuthenticatorTransport.Usb,Protocol.WebAuthn.AuthenticatorTransport.Ble,Protocol.WebAuthn.AuthenticatorTransport.Nfc,Protocol.WebAuthn.AuthenticatorTransport.Internal])):(this._residentKeyCheckbox.checked=!1,this._residentKeyCheckbox.disabled=!0,this._userVerificationCheckbox.checked=!1,this._userVerificationCheckbox.disabled=!0,this._updateEnabledTransportOptions([Protocol.WebAuthn.AuthenticatorTransport.Usb,Protocol.WebAuthn.AuthenticatorTransport.Ble,Protocol.WebAuthn.AuthenticatorTransport.Nfc])))}_createNewAuthenticatorSection(){this._learnMoreView=this.contentElement.createChild("div","learn-more"),this._learnMoreView.appendChild(l.html`
  <div>
  ${C(b.useWebauthnForPhishingresistant)}<br /><br />
  ${u.XLink.create("https://developers.google.com/web/updates/2018/05/webauthn",C(b.learnMore))}
  </div>
  `),this._newAuthenticatorSection=this.contentElement.createChild("div","new-authenticator-container");const t=c.createLabel(C(b.newAuthenticator),"new-authenticator-title");this._newAuthenticatorSection.appendChild(t),this._newAuthenticatorForm=this._newAuthenticatorSection.createChild("div","new-authenticator-form");const e=this._newAuthenticatorForm.createChild("div","authenticator-option"),i=this._newAuthenticatorForm.createChild("div","authenticator-option"),a=this._newAuthenticatorForm.createChild("div","authenticator-option"),o=this._newAuthenticatorForm.createChild("div","authenticator-option"),n=this._newAuthenticatorForm.createChild("div","authenticator-option"),r=c.createLabel(C(b.protocol),"authenticator-option-label");e.appendChild(r),this._protocolSelect=e.createChild("select","chrome-select"),p.bindLabelToControl(r,this._protocolSelect),Object.values(Protocol.WebAuthn.AuthenticatorProtocol).sort().forEach((t=>{this._protocolSelect&&this._protocolSelect.appendChild(new Option(t,t))})),this._protocolSelect&&(this._protocolSelect.value=Protocol.WebAuthn.AuthenticatorProtocol.Ctap2);const s=c.createLabel(C(b.transport),"authenticator-option-label");i.appendChild(s),this._transportSelect=i.createChild("select","chrome-select"),p.bindLabelToControl(s,this._transportSelect),this._residentKeyCheckboxLabel=c.CheckboxLabel.create(C(b.supportsResidentKeys),!1),this._residentKeyCheckboxLabel.textElement.classList.add("authenticator-option-label"),a.appendChild(this._residentKeyCheckboxLabel.textElement),this._residentKeyCheckbox=this._residentKeyCheckboxLabel.checkboxElement,this._residentKeyCheckbox.checked=!1,this._residentKeyCheckbox.classList.add("authenticator-option-checkbox"),a.appendChild(this._residentKeyCheckboxLabel),this._userVerificationCheckboxLabel=c.CheckboxLabel.create("Supports user verification",!1),this._userVerificationCheckboxLabel.textElement.classList.add("authenticator-option-label"),o.appendChild(this._userVerificationCheckboxLabel.textElement),this._userVerificationCheckbox=this._userVerificationCheckboxLabel.checkboxElement,this._userVerificationCheckbox.checked=!1,this._userVerificationCheckbox.classList.add("authenticator-option-checkbox"),o.appendChild(this._userVerificationCheckboxLabel),this._addAuthenticatorButton=c.createTextButton(C(b.add),this._handleAddAuthenticatorButton.bind(this),""),n.createChild("div","authenticator-option-label"),n.appendChild(this._addAuthenticatorButton);const h=c.createLabel(C(b.addAuthenticator),"");p.bindLabelToControl(h,this._addAuthenticatorButton),this._updateNewAuthenticatorSectionOptions(),this._protocolSelect&&this._protocolSelect.addEventListener("change",this._updateNewAuthenticatorSectionOptions.bind(this))}async _handleAddAuthenticatorButton(){const t=this._createOptionsFromCurrentInputs();if(this._model){const e=await this._model.addAuthenticator(t),i=this._availableAuthenticatorSetting.get();i.push({authenticatorId:e,active:!0,...t}),this._availableAuthenticatorSetting.set(i.map((t=>({...t,active:t.authenticatorId===e}))));const a=await this._addAuthenticatorSection(e,t),o=window.matchMedia("(prefers-reduced-motion: reduce)").matches;a.scrollIntoView({block:"start",behavior:o?"auto":"smooth"})}}async _addAuthenticatorSection(t,e){const i=document.createElement("div");i.classList.add("authenticator-section"),i.setAttribute("data-authenticator-id",t),this._authenticatorsView.appendChild(i);const a=i.createChild("div","authenticator-section-header"),o=a.createChild("div","authenticator-section-title");p.markAsHeading(o,2),await this._clearActiveAuthenticator();const n=a.createChild("div","active-button-container"),r=c.createRadioLabel("active-authenticator-"+t,C(b.active));r.radioElement.addEventListener("click",this._setActiveAuthenticator.bind(this,t)),n.appendChild(r),r.radioElement.checked=!0,this._activeAuthId=t;const s=a.createChild("button","text-button");s.textContent=C(b.remove),s.addEventListener("click",this._removeAuthenticator.bind(this,t));const h=new d.Toolbar("edit-name-toolbar",o),l=new d.ToolbarButton(C(b.editName),"largeicon-edit"),u=new d.ToolbarButton(C(b.saveName),"largeicon-checkmark");u.setVisible(!1);const _=o.createChild("input","authenticator-name-field");_.disabled=!0;const m=t.slice(-5);_.value=C(b.authenticatorS,{PH1:m}),this._updateActiveLabelTitle(r,_.value),l.addEventListener(d.ToolbarButton.Events.Click,(()=>this._handleEditNameButton(o,_,l,u))),u.addEventListener(d.ToolbarButton.Events.Click,(()=>this._handleSaveNameButton(o,_,l,u,r))),_.addEventListener("focusout",(()=>this._handleSaveNameButton(o,_,l,u,r))),_.addEventListener("keydown",(t=>{"Enter"===t.key&&this._handleSaveNameButton(o,_,l,u,r)})),h.appendToolbarItem(l),h.appendToolbarItem(u),this._createAuthenticatorFields(i,t,e);const v=document.createElementWithClass("div","credentials-title");v.textContent=C(b.credentials),i.appendChild(v);return this._createCredentialsDataGrid(t).asWidget().show(i),this._updateCredentials(t),i}_exportCredential(t){let e="-----BEGIN PRIVATE KEY-----\n";for(let i=0;i<t.privateKey.length;i+=64)e+=t.privateKey.substring(i,i+64)+"\n";e+="-----END PRIVATE KEY-----";const i=document.createElement("a");i.download=C(b.privateKeypem),i.href="data:application/x-pem-file,"+encodeURIComponent(e),i.click()}async _removeCredential(t,e){const i=this._dataGrids.get(t);i&&(i.rootNode().children.find((t=>t.data.credentialId===e)).remove(),this._maybeAddEmptyNode(i),this._model&&await this._model.removeCredential(t,e))}_createAuthenticatorFields(t,e,i){const a=t.createChild("div","authenticator-fields"),o=a.createChild("div","authenticator-field"),n=a.createChild("div","authenticator-field"),r=a.createChild("div","authenticator-field"),s=a.createChild("div","authenticator-field"),h=a.createChild("div","authenticator-field");o.appendChild(c.createLabel(C(b.uuid),"authenticator-option-label")),n.appendChild(c.createLabel(C(b.protocol),"authenticator-option-label")),r.appendChild(c.createLabel(C(b.transport),"authenticator-option-label")),s.appendChild(c.createLabel(C(b.supportsResidentKeys),"authenticator-option-label")),h.appendChild(c.createLabel(C(b.supportsUserVerification),"authenticator-option-label")),o.createChild("div","authenticator-field-value").textContent=e,n.createChild("div","authenticator-field-value").textContent=i.protocol,r.createChild("div","authenticator-field-value").textContent=i.transport,s.createChild("div","authenticator-field-value").textContent=i.hasResidentKey?C(b.yes):C(b.no),h.createChild("div","authenticator-field-value").textContent=i.hasUserVerification?C(b.yes):C(b.no)}_handleEditNameButton(t,e,i,a){e.disabled=!1,t.classList.add("editing-name"),e.focus(),a.setVisible(!0),i.setVisible(!1)}_handleSaveNameButton(t,e,i,a,o){e.disabled=!0,t.classList.remove("editing-name"),i.setVisible(!0),a.setVisible(!1),this._updateActiveLabelTitle(o,e.value)}_updateActiveLabelTitle(t,e){s.Tooltip.install(t.radioElement,C(b.setSAsTheActiveAuthenticator,{PH1:e}))}_removeAuthenticator(t){if(this._authenticatorsView){const e=this._authenticatorsView.querySelector(`[data-authenticator-id=${CSS.escape(t)}]`);e&&e.remove()}this._dataGrids.delete(t),this._model&&this._model.removeAuthenticator(t);const e=this._availableAuthenticatorSetting.get().filter((e=>e.authenticatorId!==t));if(this._availableAuthenticatorSetting.set(e),this._activeAuthId===t){const t=Array.from(this._dataGrids.keys());t.length?this._setActiveAuthenticator(t[0]):this._activeAuthId=null}}_createOptionsFromCurrentInputs(){if(!(this._protocolSelect&&this._transportSelect&&this._residentKeyCheckbox&&this._userVerificationCheckbox))throw new Error("Unable to create options from current inputs");return{protocol:this._protocolSelect.options[this._protocolSelect.selectedIndex].value,transport:this._transportSelect.options[this._transportSelect.selectedIndex].value,hasResidentKey:this._residentKeyCheckbox.checked,hasUserVerification:this._userVerificationCheckbox.checked,automaticPresenceSimulation:!0,isUserVerified:!0}}async _setActiveAuthenticator(t){await this._clearActiveAuthenticator(),this._model&&await this._model.setAutomaticPresenceSimulation(t,!0),this._activeAuthId=t;const e=this._availableAuthenticatorSetting.get().map((e=>({...e,active:e.authenticatorId===t})));this._availableAuthenticatorSetting.set(e),this._updateActiveButtons()}_updateActiveButtons(){const t=this._authenticatorsView.getElementsByClassName("authenticator-section");Array.from(t).forEach((t=>{const e=t.querySelector("input.dt-radio-button");e&&(e.checked=t.dataset.authenticatorId===this._activeAuthId)}))}async _clearActiveAuthenticator(){this._activeAuthId&&this._model&&await this._model.setAutomaticPresenceSimulation(this._activeAuthId,!1),this._activeAuthId=null,this._updateActiveButtons()}}var S=Object.freeze({__proto__:null,UIStrings:b,WebauthnPaneImpl:A});export{S as WebauthnPane};
